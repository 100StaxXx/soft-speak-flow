# Referral Skin System - Quick Reference Guide

**Status:** âœ… FULLY IMPLEMENTED | **Date:** Nov 26, 2025

---

## ğŸ¯ What Is This?

A gamified referral system where users unlock exclusive companion skins by referring friends who reach Stage 3.

**3 Milestone Skins:**
- 1 referral â†’ Cosmic Aura (purple/blue glow)
- 3 referrals â†’ Golden Frame (golden border)
- 5 referrals â†’ Celestial Wings (wing overlay)

---

## ğŸ“ Key Files

| File | Purpose |
|------|---------|
| `supabase/migrations/20251126072322_*.sql` | Database schema |
| `src/hooks/useReferrals.ts` | Referral logic hook |
| `src/hooks/useCompanion.ts` (lines 438-558) | Stage 3 validation |
| `src/components/ReferralCodeInput.tsx` | Onboarding code entry |
| `src/components/ReferralDashboard.tsx` | Share & stats UI |
| `src/components/CompanionSkins.tsx` | Skin manager |
| `src/components/CompanionDisplay.tsx` (lines 78-103) | Skin effects |
| `src/pages/Profile.tsx` (line 204-207) | Referrals tab |

---

## ğŸ—„ï¸ Database Tables

### `profiles` (extended)
```sql
referral_code TEXT UNIQUE         -- Auto-generated REF-XXXXXXXX
referred_by UUID                   -- FK to referrer's profile.id
referral_count INTEGER DEFAULT 0   -- Number of successful referrals
```

### `companion_skins`
```sql
id UUID PRIMARY KEY
name TEXT                -- "Cosmic Aura", "Golden Frame", etc.
skin_type TEXT           -- aura, frame, overlay
unlock_type TEXT         -- referral, achievement, purchase
unlock_requirement INT   -- 1, 3, or 5 for referrals
css_effect JSONB         -- {glowColor, borderColor, etc.}
rarity TEXT              -- rare, epic, legendary
```

### `user_companion_skins`
```sql
id UUID PRIMARY KEY
user_id UUID             -- FK to profiles.id
skin_id UUID             -- FK to companion_skins.id
is_equipped BOOLEAN      -- Only one can be true at a time
acquired_via TEXT        -- "referral_milestone_1", etc.
UNIQUE(user_id, skin_id) -- No duplicate unlocks
```

---

## ğŸ”„ User Flow

### 1. Alex Shares Code
Profile â†’ Referrals â†’ "Share Your Code" â†’ iOS Share Sheet opens

### 2. Sam Applies Code
Onboarding â†’ "Got a Referral Code?" â†’ Enter `REF-ALEX-7K2X` â†’ Sam's `referred_by` = Alex.id

### 3. Sam Reaches Stage 3
Evolution triggers â†’ `validateReferralAtStage3()` â†’ Alex's `referral_count` increments â†’ Cosmic Aura unlocks for Alex â†’ Sam's `referred_by` cleared

### 4. Alex Equips Skin
Profile â†’ Referrals â†’ CompanionSkins â†’ Tap "Equip" on Cosmic Aura â†’ Tasks page â†’ Companion has glow!

---

## ğŸ› ï¸ useReferrals Hook API

```typescript
const {
  referralStats,      // { referral_code, referral_count, referred_by }
  availableSkins,     // All referral skins (ordered by requirement)
  unlockedSkins,      // User's unlocked skins with equipped status
  applyReferralCode,  // applyReferralCode.mutateAsync(code)
  equipSkin,          // equipSkin.mutate(skinId)
  unequipSkin         // unequipSkin.mutate()
} = useReferrals();
```

---

## ğŸ¨ Skin CSS Effects

### Aura (Cosmic Aura)
```typescript
{
  boxShadow: `0 0 30px ${glowColor}, 0 0 60px ${glowColor}`,
  filter: `drop-shadow(0 0 20px ${glowColor})`
}
```

### Frame (Golden Frame)
```typescript
{
  border: `3px solid ${borderColor}`,
  boxShadow: shimmer ? `0 0 20px ${borderColor}` : undefined
}
```

### Overlay (Celestial Wings)
Future enhancement - image overlay layer

---

## ğŸ§ª Testing Commands

```bash
# Check migration applied
psql -c "SELECT * FROM companion_skins;"

# Verify code generation
psql -c "SELECT referral_code FROM profiles LIMIT 5;"

# Check unlocked skins
psql -c "SELECT * FROM user_companion_skins WHERE user_id = '<uuid>';"

# TypeScript check
npx tsc --noEmit

# Build test
npm run build
```

---

## ğŸ› Common Issues

### Issue: Referral code not generated for new user
**Fix:** Check trigger exists: `SELECT * FROM information_schema.triggers WHERE trigger_name = 'set_referral_code_trigger';`

### Issue: Skin not unlocking at Stage 3
**Fix:** Check `validateReferralAtStage3()` is called in `evolveCompanion` mutation (line 556-558)

### Issue: Can't equip multiple skins
**Design:** Only one skin can be equipped at a time. This is intentional.

### Issue: Share button not working on iOS
**Fix:** Verify Capacitor Share plugin is installed: `npm list @capacitor/share`

### Issue: Self-referral allowed
**Fix:** Check validation in `applyReferralCode` mutation (should reject if `referrer.id === user.id`)

---

## ğŸ” Security Checks

âœ… RLS enabled on all tables  
âœ… Users can only view/edit their own skins  
âœ… Self-referral prevention  
âœ… Duplicate skin prevention (UNIQUE constraint)  
âœ… Double-counting prevention (clear `referred_by`)  
âœ… Referral code is read-only (generated by trigger)

---

## ğŸ“Š Key Metrics to Track

- **Viral Coefficient:** Avg referrals per user
- **Conversion Rate:** % of referred users who reach Stage 3
- **Share Rate:** % of users who tap "Share Your Code"
- **Equip Rate:** % of unlocked skins that get equipped
- **Time to Milestone:** Avg days to unlock each skin

---

## ğŸš€ Deployment Steps

1. **Apply migration:** `supabase db push` or run SQL file manually
2. **Verify tables:** Check `companion_skins`, `user_companion_skins` exist
3. **Deploy frontend:** `npm run build` â†’ deploy to hosting
4. **Test flow:** Create account â†’ share code â†’ apply code â†’ reach Stage 3 â†’ equip skin
5. **Monitor:** Check database for referral activity

---

## ğŸ“ Quick Troubleshooting

```sql
-- Check if user has referral code
SELECT referral_code FROM profiles WHERE id = '<user_id>';

-- Check if user is referred
SELECT referred_by FROM profiles WHERE id = '<user_id>';

-- Check user's referral count
SELECT referral_count FROM profiles WHERE id = '<referrer_id>';

-- Check unlocked skins
SELECT * FROM user_companion_skins WHERE user_id = '<user_id>';

-- Check equipped skin
SELECT cs.name FROM user_companion_skins ucs
JOIN companion_skins cs ON cs.id = ucs.skin_id
WHERE ucs.user_id = '<user_id>' AND ucs.is_equipped = true;
```

---

## âœ… Pre-Launch Checklist

- [ ] Migration applied to production database
- [ ] 3 referral skins seeded in `companion_skins` table
- [ ] Existing users have referral codes generated
- [ ] RLS policies active on production
- [ ] Frontend deployed with latest code
- [ ] Test account created and tested full flow
- [ ] iOS Share Sheet tested on physical device
- [ ] Analytics tracking configured (optional)
- [ ] Team trained on how system works
- [ ] Support docs updated with referral info

---

## ğŸ‰ Launch Announcement Ideas

- "Refer friends, unlock exclusive companion skins!"
- "Share R-Evolution and earn cosmic rewards"
- "Your friends' success unlocks YOUR rewards"
- Email blast with referral code + share link
- In-app tooltip highlighting Referrals tab
- Social media posts with skin previews

---

## ğŸ“š Full Documentation

For detailed information, see:
- `REFERRAL_SYSTEM_COMPLETE.md` - Status & deployment
- `REFERRAL_SYSTEM_VERIFICATION.md` - Phase-by-phase breakdown
- `REFERRAL_SYSTEM_ARCHITECTURE.md` - System diagrams

---

**Questions?** All code is implemented and ready. Just deploy the migration and go live! ğŸš€
