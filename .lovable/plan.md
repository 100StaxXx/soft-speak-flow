
# Fix Companion Name Not Appearing on Journey Begins Screen

## Problem Summary

When completing onboarding, the companion name "Aerion" was successfully generated by AI and saved to the database, but the reveal screen showed "ALEAH & HORSE (STALLION)" instead of "ALEAH & AERION".

## Root Cause Analysis

Looking at the edge function logs:

```text
08:28:33 - Card generation started (first attempt)
08:28:38 - FAILED: "AI response was not valid JSON" 
         (AI generated "Aerion" but JSON parsing failed due to newlines)
08:30:59 - Retry succeeded  
08:31:04 - Card saved with name "Aerion"
```

The `waitForCompanionDisplayName` function in StoryOnboarding polls every 1 second for up to 30 attempts. However:

1. The card generation runs in the background ("fire and forget" pattern)
2. The first AI call failed due to JSON parsing issues (newlines in multi-paragraph story text)
3. The polling finished before the successful retry completed
4. The fallback kicked in: `companionDisplayName || preferences.spiritAnimal` â†’ "Horse (Stallion)"

## Solution: Two-Part Fix

### Part 1: Improve JSON Parsing Robustness (Edge Function)

The AI response included valid JSON, but it was wrapped in markdown code blocks and had problematic line breaks:

```json
"story_text": "Born from... (long text)
even in
this fledgling form..."  // <- invalid line break!
```

Update `generate-evolution-card` to handle this more robustly:
- Clean newlines within string values before parsing
- Add better error recovery

### Part 2: Extend Polling Window and Add Early Card Generation

The current 30-second window isn't enough when the first AI call fails. We should:
- Increase max attempts from 30 to 45 (45 seconds total)
- Add a small initial delay to give card generation a head start
- Consider moving card generation to NOT be fire-and-forget (await it, with timeout)

---

## Detailed Changes

### 1. Fix JSON Parsing in Edge Function

**File:** `supabase/functions/generate-evolution-card/index.ts`

Update the JSON extraction logic:

```typescript
// Current (fragile):
const jsonMatch = content.match(/```(?:json)?\s*(\{[\s\S]*\})\s*```/) 
  || content.match(/(\{[\s\S]*\})/);
const jsonString = jsonMatch ? jsonMatch[1] : content;
cardData = JSON.parse(jsonString);

// Improved (robust):
let jsonString = content;

// Extract from code blocks
const codeBlockMatch = content.match(/```(?:json)?\s*([\s\S]*?)\s*```/);
if (codeBlockMatch) {
  jsonString = codeBlockMatch[1];
}

// Extract JSON object
const jsonObjectMatch = jsonString.match(/\{[\s\S]*\}/);
if (jsonObjectMatch) {
  jsonString = jsonObjectMatch[0];
}

// Fix common AI JSON issues: unescaped newlines in strings
jsonString = jsonString.replace(/:\s*"([^"]*(?:\\.[^"]*)*)"/g, (match, p1) => {
  const fixed = p1.replace(/(?<!\\)\n/g, '\\n');
  return `: "${fixed}"`;
});

cardData = JSON.parse(jsonString);
```

### 2. Extend Polling in Onboarding

**File:** `src/components/onboarding/StoryOnboarding.tsx`

```typescript
const waitForCompanionDisplayName = async (companionId: string) => {
  const maxAttempts = 45;      // Increased from 30
  const delayMs = 1000;
  const initialDelay = 2000;   // Wait 2s before first poll
  
  await new Promise(r => setTimeout(r, initialDelay));
  
  for (let attempt = 1; attempt <= maxAttempts; attempt++) {
    // ... existing polling logic
  }
};
```

### 3. Consider Awaiting Card Generation (Optional)

Instead of fire-and-forget, await the card generation with a timeout:

```typescript
// Instead of:
generateStageZeroCard(); // Fire and forget

// Do this:
const cardPromise = generateStageZeroCard();
const timeoutPromise = new Promise(r => setTimeout(r, 15000));
await Promise.race([cardPromise, timeoutPromise]);
```

This ensures the card is more likely to be ready when polling starts.

---

## Technical Notes

| Current | Proposed |
|---------|----------|
| 30s max polling window | 45s max polling window |
| Immediate polling start | 2s initial delay |
| Fragile JSON parsing | Robust newline handling |
| Fire-and-forget card gen | Race with 15s timeout |

## Testing

After these changes:
1. New user onboarding should show the AI-generated companion name
2. If AI generation fails completely, the fallback to spirit animal still works
3. The reveal screen should never show raw species names like "Horse (Stallion)"
