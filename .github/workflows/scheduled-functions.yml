name: Scheduled Edge Functions (Manual Fallback)

on:
  workflow_dispatch:
    inputs:
      function_name:
        description: "Function to invoke manually"
        required: false
        type: string
      payload_json:
        description: "Raw JSON payload for manual invocation"
        required: false
        type: string
      backfill_recent_transcripts:
        description: "Run transcript backfill (retry-missing-pep-talk-transcripts)"
        required: false
        default: false
        type: boolean
      backfill_lookback_days:
        description: "How many days to include in backfill mode"
        required: false
        default: 30
        type: number

jobs:
  invoke:
    runs-on: ubuntu-latest
    env:
      PROJECT_REF: ${{ secrets.SUPABASE_PROJECT_REF }}
      SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}

    steps:
      - name: Select function + payload
        id: select
        run: |
          set -euo pipefail

          fn=""
          payload='{}'
          run_backfill_loop="false"

          if [ "${{ inputs.backfill_recent_transcripts }}" = "true" ]; then
            fn="retry-missing-pep-talk-transcripts"
            payload=$(jq -cn \
              --argjson lookback "${{ inputs.backfill_lookback_days }}" \
              --argjson limit 50 \
              '{mode:"backfill", lookbackDays:$lookback, limit:$limit}')
            run_backfill_loop="true"
          else
            fn="${{ inputs.function_name }}"
            if [ -z "$fn" ]; then
              echo "workflow_dispatch requires function_name when backfill mode is disabled" >&2
              exit 1
            fi

            raw_payload='${{ inputs.payload_json }}'
            if [ -n "$raw_payload" ]; then
              echo "$raw_payload" | jq . >/dev/null
              payload="$raw_payload"
            fi
          fi

          echo "function_name=$fn" >> "$GITHUB_OUTPUT"
          echo "payload=$payload" >> "$GITHUB_OUTPUT"
          echo "run_backfill_loop=$run_backfill_loop" >> "$GITHUB_OUTPUT"

      - name: Invoke function once
        if: steps.select.outputs.run_backfill_loop != 'true'
        run: |
          set -euo pipefail
          fn="${{ steps.select.outputs.function_name }}"
          payload='${{ steps.select.outputs.payload }}'
          url="https://${PROJECT_REF}.supabase.co/functions/v1/${fn}"
          status=$(curl -sS -o /tmp/function-response.json -w "%{http_code}" \
            -X POST "$url" \
            -H "Authorization: Bearer ${SERVICE_ROLE_KEY}" \
            -H "apikey: ${SERVICE_ROLE_KEY}" \
            -H "Content-Type: application/json" \
            -d "$payload")

          echo "HTTP $status"
          cat /tmp/function-response.json || true

          if [ "$status" -ge 300 ]; then
            exit 1
          fi

      - name: Run transcript backfill batches
        if: steps.select.outputs.run_backfill_loop == 'true'
        run: |
          set -euo pipefail
          fn="${{ steps.select.outputs.function_name }}"
          lookback="${{ inputs.backfill_lookback_days }}"
          url="https://${PROJECT_REF}.supabase.co/functions/v1/${fn}"

          max_batches=50
          for batch in $(seq 1 "$max_batches"); do
            payload=$(jq -cn \
              --argjson lookback "$lookback" \
              --argjson limit 50 \
              '{mode:"backfill", lookbackDays:$lookback, limit:$limit}')

            status=$(curl -sS -o /tmp/function-response.json -w "%{http_code}" \
              -X POST "$url" \
              -H "Authorization: Bearer ${SERVICE_ROLE_KEY}" \
              -H "apikey: ${SERVICE_ROLE_KEY}" \
              -H "Content-Type: application/json" \
              -d "$payload")

            echo "Batch $batch => HTTP $status"
            cat /tmp/function-response.json || true

            if [ "$status" -ge 300 ]; then
              exit 1
            fi

            attempted=$(jq -r '.attempted // 0' /tmp/function-response.json)
            scanned=$(jq -r '.scanned // 0' /tmp/function-response.json)
            backfill_queued=$(jq -r '.backfillQueued // 0' /tmp/function-response.json)

            if [ "$attempted" -eq 0 ] && [ "$scanned" -eq 0 ] && [ "$backfill_queued" -eq 0 ]; then
              echo "Backfill complete after $batch batch(es)."
              exit 0
            fi
          done

          echo "Backfill hit max_batches=${max_batches}; rerun workflow if more work remains."
