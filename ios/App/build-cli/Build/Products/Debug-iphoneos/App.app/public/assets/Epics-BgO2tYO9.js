import{r,u as st,j as e,aS as bt,n as ve,m as S,bd as pe,aa as xe,c5 as ce,b7 as be,aT as He,am as te,cr as Ie,ad as qe,bY as de,dL as at,K as U,aj as vt,aA as q,ai as Nt,k as Oe,l as we,bG as wt,ae as he,X as rt,Q as Ct,aY as Me,aX as it,bf as $e,az as ge,dM as _t,Y as St,b4 as nt,aZ as Ye,Z as kt,dd as Tt,aW as Et,bt as At,c6 as Rt,W as Pt,co as Dt,c9 as Ht,c$ as It,ay as Mt,af as Ft,br as qt,cg as Lt,bv as zt,bp as Bt,aC as Ot,bo as $t,cm as lt}from"./vendor-FfY6MM0Z.js";import{c as Yt,az as Wt,aA as Xt,aB as Qt,aC as ot,aD as Ut,B as R,H as E,aE as ct,aF as dt,aG as mt,z as Re,A as Pe,D as De,a as me,aH as ut,aI as xt,aJ as Gt,aK as Kt,s as Q,Z as Ce,_ as _e,at as Fe,aL as We,G as K,ah as Jt,ap as Le,f as fe,aM as pt,aN as Vt,d as Zt,aO as es,aP as ts,aQ as ss,aR as as,aS as rs,O as is,R as ns,T as ls,U as os,V as cs,W as ds,X as ms,Y as us,L as V,p as xs,q as ps,r as hs,t as gs,v as fs,w as ue,aT as ys,aU as js,$ as ze,a0 as Be,aV as ht,aW as bs,aX as vs,aY as Ns,aZ as ws,ac as gt,ad as ft,ae as oe,g as Cs,ao as X,a_ as _s,e as Xe,S as Qe,ab as Ss,af as Ue,a$ as ks,ag as Ts}from"./index-sX_cJ3I4.js";import{o as Es}from"./date-vendor-Bk4KiHsJ.js";import{g as Ne}from"./habitLimits-NNrGyrB4.js";import"./three-vendor-qI8GXUTd.js";const Ge=["M","T","W","T","F","S","S"],Ke=(s,o)=>s==="daily"||!o||o.length===0||o.length===7?{type:"text",value:"Daily"}:o.length===5&&[0,1,2,3,4].every(a=>o.includes(a))?{type:"text",value:"Weekdays"}:{type:"chips",value:o},As=s=>{const a=new Date().getDay(),x=a===0?6:a-1;return s.frequency==="daily"||!s.custom_days||s.custom_days.length===0?!0:s.custom_days.includes(x)},Rs=s=>{const o=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],a=new Date,x=a.getDay()===0?6:a.getDay()-1,i=s.find(n=>n>x)??s[0];return o[i]},Ps=r.memo(function({epicId:o,habits:a,isActive:x,onAdjustPlan:i,showAdjustPlan:n,renderTrigger:g}){const{user:l}=Yt(),f=st(),[c,y]=r.useState(!1),[A,p]=r.useState(null),[h,d]=r.useState(null),[m,j]=r.useState(!1),[P,H]=r.useState(!1),[C,b]=r.useState(!1),[v,N]=r.useState(""),[L,M]=r.useState("medium"),[Y,O]=r.useState([0,1,2,3,4,5,6]),[$,W]=r.useState(!1),[k,u]=r.useState(null),z=r.useRef(null),se=Es(new Date,"yyyy-MM-dd"),{surfacedHabits:ie,surfaceHabit:ae}=Wt(),{toggleTask:re}=Xt(se),{triggerRitualComplete:ne}=Qt(),Z=()=>J.filter(_=>ee.get(_.id)?.is_completed).length===0,Se=()=>J.length===0?!1:J.filter(_=>ee.get(_.id)?.is_completed).length===J.length-1,ee=r.useMemo(()=>{const t=new Map;return ie.forEach(_=>{t.set(_.habit_id,{task_id:_.task_id,is_completed:_.is_completed})}),t},[ie]),ke=async t=>{try{await Nt.impact({style:t})}catch{}},le=async(t,_,I)=>{if(I||k)return;u(t),ke(vt.Medium),Kt();const T=Z(),D=Se();try{_?re({taskId:_,completed:!0,xpReward:25}):ae(t),ne(T,D).catch(B=>console.log("[LivingCompanion] Ritual reaction failed:",B))}finally{setTimeout(()=>u(null),300)}},ye=t=>{d({habitId:t.id,title:t.title,description:t.description,difficulty:t.difficulty,frequency:t.frequency,estimated_minutes:t.estimated_minutes,preferred_time:t.preferred_time,category:t.category,custom_days:t.custom_days})},je=async t=>{if(l?.id){H(!0);try{const{error:_}=await Q.from("habits").delete().eq("id",t).eq("user_id",l.id);if(_)throw _;const{error:I}=await Q.from("daily_tasks").delete().eq("habit_source_id",t).eq("user_id",l.id).eq("completed",!1);I&&console.error("Error deleting linked tasks:",I),f.invalidateQueries({queryKey:["habits"]}),f.invalidateQueries({queryKey:["daily-tasks"]}),f.invalidateQueries({queryKey:["epics"]}),q.success("Ritual deleted")}catch(_){console.error("Error deleting ritual:",_),q.error("Failed to delete ritual")}finally{H(!1)}d(null)}},Te=async()=>{if(!(!l?.id||!v.trim())){W(!0);try{const t=Y.length===7?"daily":"custom",{data:_,error:I}=await Q.from("habits").insert({user_id:l.id,title:v.trim(),difficulty:L,frequency:t,custom_days:Y,is_active:!0}).select("id").single();if(I)throw I;_?.id&&await Q.from("epic_habits").insert({epic_id:o,habit_id:_.id}),f.invalidateQueries({queryKey:["habits"]}),f.invalidateQueries({queryKey:["epics"]}),f.invalidateQueries({queryKey:["daily-tasks"]}),q.success("Ritual added to campaign!"),N(""),M("medium"),O([0,1,2,3,4,5,6]),b(!1)}catch(t){console.error("Error adding ritual:",t),q.error("Failed to add ritual")}finally{W(!1)}}},{todayHabits:J,upcomingHabits:w}=r.useMemo(()=>{const t=[],_=[];return a.forEach(I=>{As(I)?t.push(I):_.push(I)}),{todayHabits:t,upcomingHabits:_}},[a]);return!x||a.length===0?null:e.jsxs(ot,{open:c,onOpenChange:y,shouldScaleBackground:!1,handleOnly:!0,children:[e.jsx(Ut,{asChild:!0,children:g?g(J.length):e.jsxs(R,{variant:"outline",className:E("w-full relative overflow-hidden group","bg-gradient-to-r from-primary/10 to-accent/10","border-primary/30 hover:border-primary/60","transition-all duration-300"),children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-primary/20 via-accent/20 to-primary/20 opacity-0 group-hover:opacity-100 animate-pulse transition-opacity"}),e.jsx(bt,{className:"w-4 h-4 mr-2 text-primary"}),e.jsx("span",{className:"relative z-10 font-medium",children:"Rituals"}),e.jsxs("span",{className:"ml-2 px-2 py-0.5 text-xs bg-primary/20 text-primary rounded-full",children:[J.length," today"]}),e.jsx(ve,{className:"w-4 h-4 ml-2 text-accent"})]})}),e.jsxs(ct,{className:"bg-background border-t border-primary/20",children:[e.jsxs("div",{className:"mx-auto w-full max-w-lg p-6",children:[e.jsx(dt,{className:"px-0 pb-4",children:e.jsxs(mt,{className:"flex items-center gap-2 text-xl",children:[e.jsx(ve,{className:"w-5 h-5 text-stardust-gold fill-stardust-gold/30"}),"Today's Cosmiq Habits"]})}),e.jsxs("div",{className:"space-y-3 overflow-y-auto overscroll-contain max-h-[60vh] -mx-2 px-2","data-vaul-no-drag":!0,children:[J.map(t=>{const _=A===t.id,I=t.description||t.frequency||t.estimated_minutes||t.preferred_time;return e.jsx(Re,{open:_,onOpenChange:T=>p(T?t.id:null),children:e.jsxs("div",{className:E("rounded-xl transition-colors overflow-hidden","bg-secondary/30 border border-border/50"),children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 min-h-[60px]",style:{touchAction:"manipulation",WebkitTapHighlightColor:"transparent"},children:[(()=>{const T=ee.get(t.id),D=T?.is_completed||!1,B=k===t.id;return e.jsx("button",{"data-interactive":"true",onClick:F=>{F.stopPropagation(),!D&&!B&&le(t.id,T?.task_id||null,D)},onTouchStart:F=>{z.current={x:F.touches[0].clientX,y:F.touches[0].clientY}},onTouchEnd:F=>{if(F.preventDefault(),F.stopPropagation(),z.current&&!D&&!B){const Ee=Math.abs(F.changedTouches[0].clientX-z.current.x),Ae=Math.abs(F.changedTouches[0].clientY-z.current.y);Ee<5&&Ae<5&&le(t.id,T?.task_id||null,D)}z.current=null},disabled:D,className:E("relative flex items-center justify-center w-11 h-11 -ml-2.5 touch-manipulation transition-transform select-none",!D&&"active:scale-95"),style:{WebkitTapHighlightColor:"transparent",touchAction:"manipulation"},"aria-label":D?"Ritual completed":"Mark ritual as complete",role:"checkbox","aria-checked":D,tabIndex:0,children:e.jsx(S.div,{className:E("flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all",D?"bg-green-500 border-green-500":"border-primary/30 hover:border-primary/60",B&&"animate-pulse border-primary"),whileTap:D?{}:{scale:.85},children:D?e.jsx(S.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:25},children:e.jsx(pe,{className:"w-4 h-4 text-white"})}):B?e.jsx(xe,{className:"w-3 h-3 animate-spin text-primary"}):e.jsx("div",{className:"w-2 h-2 rounded-full bg-primary/50"})})})})(),e.jsx("span",{className:E("flex-1 text-sm font-medium transition-all",ee.get(t.id)?.is_completed&&"line-through text-muted-foreground"),children:t.title}),t.preferred_time&&e.jsxs("span",{className:"text-xs text-celestial-blue/80 flex items-center gap-1",children:[e.jsx(ce,{className:"w-3 h-3"}),t.preferred_time.slice(0,5)]}),I&&e.jsx(Pe,{asChild:!0,children:e.jsx("button",{type:"button",className:E("h-10 w-10 -mr-2 flex items-center justify-center rounded-lg","active:bg-primary/20 transition-colors","touch-manipulation","relative z-10"),onClick:T=>{T.stopPropagation()},onTouchEnd:T=>{T.stopPropagation()},children:e.jsx(be,{className:E("h-5 w-5 text-muted-foreground transition-transform duration-200",_&&"rotate-180")})})})]}),e.jsx(De,{children:e.jsxs("div",{className:"px-4 pb-4 pt-0 space-y-2 border-t border-border/30","data-vaul-no-drag":!0,children:[t.description&&e.jsx("p",{className:"text-sm text-celestial-blue/80 pt-3",children:t.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 pt-2",children:[(()=>{const T=Ke(t.frequency,t.custom_days);return e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(He,{className:"w-3.5 h-3.5 text-celestial-blue"}),T.type==="text"?e.jsx("span",{children:T.value}):e.jsx("div",{className:"flex gap-0.5",children:Ge.map((D,B)=>e.jsx("span",{className:E("w-4 h-4 rounded-full text-[9px] font-bold flex items-center justify-center",T.value.includes(B)?"bg-celestial-blue/80 text-white":"bg-muted/30 text-muted-foreground/40"),children:D},B))})]})})(),t.estimated_minutes&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(ce,{className:"w-3.5 h-3.5 text-celestial-blue"}),e.jsxs("span",{children:["~",t.estimated_minutes," min"]})]}),t.difficulty&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(te,{className:"w-3.5 h-3.5 text-celestial-blue"}),e.jsx("span",{className:"capitalize",children:t.difficulty})]}),e.jsxs(R,{variant:"ghost",size:"sm",className:"h-7 px-2 ml-auto text-xs text-muted-foreground hover:text-foreground",onClick:T=>{T.stopPropagation(),ye(t)},children:[e.jsx(Ie,{className:"w-3 h-3 mr-1"}),"Edit"]})]})]})})]})},t.id)}),w.length>0&&e.jsxs(Re,{open:m,onOpenChange:j,className:"mt-4",children:[e.jsx(Pe,{asChild:!0,children:e.jsxs("button",{className:"w-full flex items-center justify-between p-3 rounded-xl bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20 hover:border-amber-500/40 transition-all",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"w-4 h-4 text-amber-500"}),e.jsx("span",{className:"text-sm font-medium text-amber-200",children:"Early Bird Mode"}),e.jsx("span",{className:"text-xs text-amber-500/70",children:"Preview upcoming"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[w.length," upcoming"]}),e.jsx(be,{className:E("w-4 h-4 text-amber-500 transition-transform",m&&"rotate-180")})]})]})}),e.jsx(De,{children:e.jsxs("div",{className:"mt-3 space-y-2 pl-2 border-l-2 border-amber-500/20",children:[e.jsx("p",{className:"text-xs text-amber-500/80 italic px-2 pb-2",children:"These habits are scheduled for later this week"}),w.map(t=>{const _=A===t.id,I=t.description||t.frequency||t.estimated_minutes;return e.jsx(Re,{open:_,onOpenChange:T=>p(T?t.id:null),children:e.jsxs("div",{className:E("rounded-xl transition-colors overflow-hidden","bg-amber-500/5 border border-amber-500/20"),children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 min-h-[60px]",style:{touchAction:"manipulation",WebkitTapHighlightColor:"transparent"},children:[(()=>{const T=ee.get(t.id),D=T?.is_completed||!1,B=k===t.id;return e.jsx("button",{"data-interactive":"true",onClick:F=>{F.stopPropagation(),!D&&!B&&le(t.id,T?.task_id||null,D)},onTouchStart:F=>{z.current={x:F.touches[0].clientX,y:F.touches[0].clientY}},onTouchEnd:F=>{if(F.preventDefault(),F.stopPropagation(),z.current&&!D&&!B){const Ee=Math.abs(F.changedTouches[0].clientX-z.current.x),Ae=Math.abs(F.changedTouches[0].clientY-z.current.y);Ee<5&&Ae<5&&le(t.id,T?.task_id||null,D)}z.current=null},disabled:D,className:E("relative flex items-center justify-center w-11 h-11 -ml-2.5 touch-manipulation transition-transform select-none",!D&&"active:scale-95"),style:{WebkitTapHighlightColor:"transparent",touchAction:"manipulation"},"aria-label":D?"Ritual completed":"Mark ritual as complete",role:"checkbox","aria-checked":D,tabIndex:0,children:e.jsx(S.div,{className:E("flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all",D?"bg-green-500 border-green-500":"border-amber-500/30 hover:border-amber-500/60",B&&"animate-pulse border-amber-500"),whileTap:D?{}:{scale:.85},children:D?e.jsx(S.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:25},children:e.jsx(pe,{className:"w-4 h-4 text-white"})}):B?e.jsx(xe,{className:"w-3 h-3 animate-spin text-amber-500"}):e.jsx("div",{className:"w-2 h-2 rounded-full bg-amber-500/40"})})})})(),e.jsx("span",{className:E("flex-1 text-sm font-medium transition-all",ee.get(t.id)?.is_completed&&"line-through text-muted-foreground"),children:t.title}),t.custom_days&&t.custom_days.length>0&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-400 border border-amber-500/30",children:Rs(t.custom_days)}),I&&e.jsx(Pe,{asChild:!0,children:e.jsx("button",{type:"button",className:E("h-10 w-10 -mr-2 flex items-center justify-center rounded-lg","active:bg-amber-500/20 transition-colors","touch-manipulation","relative z-10"),onClick:T=>{T.stopPropagation()},onTouchEnd:T=>{T.stopPropagation()},children:e.jsx(be,{className:E("h-5 w-5 text-amber-500/70 transition-transform duration-200",_&&"rotate-180")})})})]}),e.jsx(De,{children:e.jsxs("div",{className:"px-4 pb-4 pt-0 space-y-2 border-t border-amber-500/20","data-vaul-no-drag":!0,children:[t.description&&e.jsx("p",{className:"text-sm text-amber-500/70 pt-3",children:t.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 pt-2",children:[(()=>{const T=Ke(t.frequency,t.custom_days);return e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(He,{className:"w-3.5 h-3.5 text-amber-500"}),T.type==="text"?e.jsx("span",{children:T.value}):e.jsx("div",{className:"flex gap-0.5",children:Ge.map((D,B)=>e.jsx("span",{className:E("w-4 h-4 rounded-full text-[9px] font-bold flex items-center justify-center",T.value.includes(B)?"bg-amber-500/80 text-white":"bg-muted/30 text-muted-foreground/40"),children:D},B))})]})})(),t.estimated_minutes&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(ce,{className:"w-3.5 h-3.5 text-amber-500"}),e.jsxs("span",{children:["~",t.estimated_minutes," min"]})]}),t.difficulty&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(te,{className:"w-3.5 h-3.5 text-amber-500"}),e.jsx("span",{className:"capitalize",children:t.difficulty})]}),e.jsxs(R,{variant:"ghost",size:"sm",className:"h-7 px-2 ml-auto text-xs text-amber-500/70 hover:text-amber-500",onClick:T=>{T.stopPropagation(),ye(t)},children:[e.jsx(Ie,{className:"w-3 h-3 mr-1"}),"Edit"]})]})]})})]})},t.id)})]})})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-border/30",children:C?e.jsxs("div",{className:"space-y-3 p-3 rounded-xl bg-secondary/30 border border-primary/20","data-vaul-no-drag":!0,children:[e.jsx(me,{value:v,onChange:t=>N(t.target.value),placeholder:"New ritual name...",autoFocus:!0,className:"bg-background/50"}),e.jsx(ut,{value:L,onChange:M}),e.jsx(xt,{selectedDays:Y,onDaysChange:O}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(R,{size:"sm",onClick:Te,disabled:!v.trim()||$,className:"flex-1",children:$?e.jsx(xe,{className:"w-4 h-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"w-4 h-4 mr-1"})," Add Ritual"]})}),e.jsx(R,{size:"sm",variant:"outline",onClick:()=>{b(!1),N("")},children:"Cancel"})]})]}):e.jsxs(R,{variant:"outline",size:"sm",className:"w-full border-dashed gap-2 text-muted-foreground hover:text-foreground",onClick:()=>b(!0),children:[e.jsx(de,{className:"w-4 h-4"}),"Add New Ritual"]})})]}),n&&i&&e.jsxs(R,{variant:"outline",size:"sm",onClick:()=>{y(!1),i()},className:"w-full mt-4",children:[e.jsx(at,{className:"h-4 w-4 mr-2"}),"Adjust My Plan"]}),e.jsxs("p",{className:"text-center text-xs text-muted-foreground pt-4 flex items-center justify-center gap-1.5",children:[e.jsx(U,{className:"w-3 h-3"}),"Tap circles to complete rituals"]}),J.length===0&&w.length>0&&e.jsx("p",{className:"text-center text-sm text-muted-foreground py-4",children:"No habits scheduled for today. Check the Early Bird section to preview upcoming habits!"})]}),e.jsx(Gt,{ritual:h,open:!!h,onOpenChange:t=>!t&&d(null),onDelete:je,isDeleting:P})]})]})}),G=s=>We[s]||We.common,Ds=({open:s,onOpenChange:o,rewardData:a,onClaim:x})=>{const[i,n]=r.useState("chest");r.useEffect(()=>{s&&n("chest")},[s]),r.useEffect(()=>{if(!s||!a)return;const l=[];if(i==="chest")l.push(setTimeout(()=>n("badge"),2e3));else if(i==="badge")Oe({particleCount:50,spread:60,origin:{y:.4},colors:["#FFD700","#FFA500","#FF6347"]}),l.push(setTimeout(()=>n("loot"),2500));else if(i==="loot"&&a.loot){const f=Hs(a.loot.rarity);Oe({particleCount:80,spread:100,origin:{y:.5},colors:f}),l.push(setTimeout(()=>n("complete"),2500))}else i==="loot"&&!a.loot&&l.push(setTimeout(()=>n("complete"),1500));return()=>l.forEach(clearTimeout)},[i,s,a]);const g=r.useCallback(()=>{x?.(),o(!1)},[x,o]);return a?e.jsx(Ce,{open:s,onOpenChange:o,children:e.jsx(_e,{className:"max-w-md border-0 bg-transparent shadow-none p-0 overflow-visible",children:e.jsxs("div",{className:"relative min-h-[500px] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-radial from-primary/20 via-transparent to-transparent blur-3xl"}),e.jsx("div",{className:"absolute inset-0 pointer-events-none overflow-hidden",children:[...Array(20)].map((l,f)=>e.jsx(S.div,{className:"absolute w-1 h-1 bg-primary/60 rounded-full",initial:{x:Math.random()*400-200,y:Math.random()*500-250,opacity:0,scale:0},animate:{opacity:[0,1,0],scale:[0,1,0]},transition:{duration:2,repeat:1/0,delay:Math.random()*2}},f))}),e.jsxs(we,{mode:"wait",children:[i==="chest"&&e.jsxs(S.div,{initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1},exit:{scale:1.5,opacity:0},className:"flex flex-col items-center",children:[e.jsxs(S.div,{animate:{rotateY:[0,10,-10,0],y:[0,-10,0]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"},className:"relative",children:[e.jsx("div",{className:"w-32 h-32 rounded-2xl bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center shadow-2xl shadow-yellow-500/50",children:e.jsx(wt,{className:"w-16 h-16 text-white"})}),e.jsx(S.div,{className:"absolute -inset-4 rounded-3xl border-2 border-yellow-400/50",animate:{opacity:[.3,.8,.3]},transition:{duration:1.5,repeat:1/0}})]}),e.jsx(S.p,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5},className:"mt-6 text-lg font-medium text-foreground/80",children:"Opening rewards..."})]},"chest"),i==="badge"&&e.jsxs(S.div,{initial:{scale:0,opacity:0,rotateY:-180},animate:{scale:1,opacity:1,rotateY:0},exit:{scale:.8,opacity:0,y:-50},transition:{type:"spring",damping:15},className:"flex flex-col items-center",children:[e.jsxs(S.div,{animate:{y:[0,-5,0]},transition:{duration:2,repeat:1/0},className:"relative",children:[e.jsx("div",{className:E("w-28 h-28 rounded-full flex items-center justify-center text-5xl","bg-gradient-to-br shadow-2xl",a.badge.tier==="platinum"?"from-purple-400 to-purple-600 shadow-purple-500/50":"from-yellow-400 to-yellow-600 shadow-yellow-500/50"),children:a.badge.icon}),e.jsx(S.div,{className:"absolute -inset-2 rounded-full",animate:{boxShadow:["0 0 20px hsl(45, 90%, 50%)","0 0 40px hsl(45, 90%, 50%)","0 0 20px hsl(45, 90%, 50%)"]},transition:{duration:1.5,repeat:1/0}})]}),e.jsxs(S.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"mt-6 text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground uppercase tracking-wider",children:"Badge Earned"}),e.jsx("h3",{className:"text-2xl font-bold text-foreground mt-1",children:a.badge.title}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:a.badge.description})]})]},"badge"),i==="loot"&&e.jsx(S.div,{initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.8,opacity:0},transition:{type:"spring",damping:15},className:"flex flex-col items-center",children:a.loot?e.jsxs(e.Fragment,{children:[e.jsxs(S.div,{animate:{rotate:[0,5,-5,0],y:[0,-8,0]},transition:{duration:2,repeat:1/0},className:"relative",children:[e.jsx("div",{className:E("w-32 h-32 rounded-2xl flex items-center justify-center","bg-gradient-to-br shadow-2xl",G(a.loot.rarity).bgClass,G(a.loot.rarity).glowClass),children:a.loot.reward_type==="artifact"&&a.loot.css_effect?.icon?e.jsx("span",{className:"text-5xl",children:a.loot.css_effect.icon}):e.jsx(ve,{className:"w-14 h-14",style:{color:G(a.loot.rarity).color}})}),e.jsx(S.div,{className:"absolute -inset-3 rounded-3xl",animate:{boxShadow:[`0 0 20px ${G(a.loot.rarity).color}`,`0 0 40px ${G(a.loot.rarity).color}`,`0 0 20px ${G(a.loot.rarity).color}`]},transition:{duration:1.5,repeat:1/0}})]}),e.jsxs(S.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"mt-6 text-center",children:[e.jsxs("p",{className:"text-sm font-medium uppercase tracking-wider",style:{color:G(a.loot.rarity).color},children:[G(a.loot.rarity).label," ",Fe(a.loot.reward_type)]}),e.jsx("h3",{className:"text-2xl font-bold text-foreground mt-1",children:a.loot.name}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1 max-w-xs",children:a.loot.description}),a.isDuplicate&&a.bonusXP&&e.jsxs("p",{className:"text-sm text-yellow-500 mt-2",children:["Already owned! +",a.bonusXP," XP instead"]})]})]}):e.jsx(S.p,{initial:{opacity:0},animate:{opacity:1},className:"text-muted-foreground",children:"No additional loot this time"})},"loot"),i==="complete"&&e.jsx(S.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center w-full max-w-sm",children:e.jsxs("div",{className:"w-full cosmiq-glass rounded-2xl p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(he,{className:"w-6 h-6 text-yellow-500"}),e.jsx("h3",{className:"text-xl font-bold",children:"Rewards Earned!"})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-background/50 rounded-xl",children:[e.jsx("span",{className:"text-3xl",children:a.badge.icon}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.badge.title}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Badge"})]})]}),a.loot&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-background/50 rounded-xl",children:[a.loot.reward_type==="artifact"&&a.loot.css_effect?.icon?e.jsx("span",{className:"text-3xl",children:a.loot.css_effect.icon}):e.jsx("div",{className:"w-10 h-10 rounded-lg flex items-center justify-center",style:{background:G(a.loot.rarity).color+"30"},children:e.jsx(U,{className:"w-5 h-5",style:{color:G(a.loot.rarity).color}})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:a.loot.name}),e.jsxs("p",{className:"text-xs",style:{color:G(a.loot.rarity).color},children:[G(a.loot.rarity).label," ",Fe(a.loot.reward_type)]})]})]}),a.isDuplicate&&a.bonusXP&&e.jsxs("p",{className:"text-center text-sm text-yellow-500",children:["+",a.bonusXP," XP (duplicate reward)"]}),e.jsxs(R,{onClick:g,className:"w-full bg-gradient-to-r from-primary to-accent hover:opacity-90",children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"Claim Rewards"]})]})},"complete")]})]})})}):null};function Hs(s){switch(s){case"common":return["#9CA3AF","#6B7280","#4B5563"];case"rare":return["#3B82F6","#2563EB","#1D4ED8"];case"epic":return["#A855F7","#9333EA","#7C3AED"];case"legendary":return["#F59E0B","#FBBF24","#FCD34D","#EF4444"];default:return["#9CA3AF"]}}function Is(){const[s,o]=r.useState([]),[a,x]=r.useState(null),[i,n]=r.useState(null),[g,l]=r.useState(null),[f,c]=r.useState(!1),[y,A]=r.useState(null),p=r.useCallback(async(P,H,C)=>{c(!0),A(null);try{const{data:b,error:v}=await Q.functions.invoke("adjust-epic-plan",{body:{epicId:P,adjustmentType:H,reason:C?.reason,newDeadline:C?.newDeadline,daysToAdd:C?.daysToAdd,habitsToRemove:C?.habitsToRemove,customRequest:C?.customRequest}});if(v)throw v;if(b.error)throw new Error(b.error);const N=b,L=N.suggestions.map(M=>({...M,selected:!1}));o(L),x(N.analysis),n(N.encouragement),l(N.epicStatus)}catch(b){const v=b instanceof Error?b.message:"Failed to build adjustment suggestions";A(v),q.error(v)}finally{c(!1)}},[]),h=r.useCallback(P=>{o(H=>H.map(C=>C.id===P?{...C,selected:!C.selected}:C))},[]),d=r.useCallback(()=>s.filter(P=>P.selected),[s]),m=r.useCallback(async(P,H,C)=>{const b=d();if(b.length===0)return q.error("Please select at least one adjustment to apply"),!1;c(!0);try{const{data:v,error:N}=await Q.functions.invoke("apply-epic-adjustments",{body:{epicId:P,adjustments:b,adjustmentType:H,reason:C}});if(N)throw N;if(v.error)throw new Error(v.error);return q.success(v.message||`Applied ${b.length} adjustment${b.length>1?"s":""} to your plan`),!0}catch(v){const N=v instanceof Error?v.message:"Failed to apply adjustments";return q.error(N),!1}finally{c(!1)}},[d]),j=r.useCallback(()=>{o([]),x(null),n(null),l(null),A(null),c(!1)},[]);return{suggestions:s,analysis:a,encouragement:i,epicStatus:g,isLoading:f,error:y,generateAdjustments:p,toggleSuggestion:h,getSelectedSuggestions:d,applyAdjustments:m,reset:j}}function Ms({habits:s,completionData:o=[],daysToAnalyze:a=14}){return r.useMemo(()=>{if(!s||s.length===0)return{shouldShowAdvisor:!1,insights:[],habitPatterns:[],overallCompletionRate:0,bestPerformingHabits:[],strugglingHabits:[],smartQuickActions:[],totalHabits:0};const x=new Date,i=new Date(x.getTime()-a*24*60*60*1e3),n=o.filter(d=>new Date(d.completed_at)>=i),g=s.map(d=>{const m=n.filter(v=>v.habit_id===d.id),j=Math.min(100,m.length/a*100),P=new Date(x.getTime()-a/2*24*60*60*1e3),H=m.filter(v=>new Date(v.completed_at)<P).length,C=m.filter(v=>new Date(v.completed_at)>=P).length;let b="stable";return C>H+1&&(b="improving"),C<H-1&&(b="declining"),{habitId:d.id,habitTitle:d.title,completionRate:j,trend:b}}),l=g.length>0?g.reduce((d,m)=>d+m.completionRate,0)/g.length:0,f=g.filter(d=>d.completionRate>=70).map(d=>d.habitTitle),c=g.filter(d=>d.completionRate<40).map(d=>d.habitTitle),y=g.filter(d=>d.trend==="declining"),A=[];l>=80&&A.push({id:"high-performer",type:"celebration",title:"Amazing consistency!",description:`You're completing ${Math.round(l)}% of your rituals. Keep up the stellar work!`}),c.length>0&&c.length<=2&&A.push({id:"struggling-habits",type:"warning",title:`${c.length} ritual${c.length>1?"s":""} needs attention`,description:`"${c[0]}" has low completion. Consider simplifying or removing it.`,action:{label:"Simplify",adjustmentText:`I'm struggling with "${c[0]}". Please suggest an easier alternative or remove it.`}}),y.length>=2&&A.push({id:"declining-trend",type:"warning",title:"Declining completion trend",description:"Multiple rituals are showing decreased completion. Time to adjust your plan.",action:{label:"Adjust",adjustmentText:"My ritual completion is declining. Please simplify my routine."}}),s.length>=5&&l<50&&A.push({id:"too-many-habits",type:"suggestion",title:"Consider fewer rituals",description:"With many rituals, it can be hard to stay consistent. Try focusing on 2-3 key ones.",action:{label:"Simplify",adjustmentText:"I have too many habits and struggle to complete them. Please help me reduce to 2-3 key rituals."}});const p=[];return c.length>0&&p.push({id:"simplify-routine",label:"Simplify Routine",description:"Make struggling habits easier",adjustmentText:"I'm having trouble with some habits. Please make them easier or suggest simpler alternatives.",icon:"Minus",priority:"primary"}),l>=70&&s.length<5&&p.push({id:"add-habit",label:"Level Up",description:"Add a new challenge",adjustmentText:"I'm doing well with my current habits. Please suggest one new habit to add.",icon:"Plus",priority:"secondary"}),s.some(d=>d.difficulty==="hard")&&l<60&&p.push({id:"reduce-difficulty",label:"Ease Up",description:"Lower difficulty levels",adjustmentText:"My habits are too difficult. Please suggest easier versions of my current rituals.",icon:"TrendingDown",priority:"primary"}),y.length>0&&p.push({id:"swap-habits",label:"Fresh Start",description:"Replace declining habits",adjustmentText:"Some of my habits are declining in completion. Please suggest replacements that better fit my lifestyle.",icon:"RefreshCw",priority:"primary"}),p.length===0&&p.push({id:"optimize",label:"Optimize",description:"Fine-tune your routine",adjustmentText:"Please review my habits and suggest any optimizations to improve my consistency.",icon:"Sparkles",priority:"secondary"}),{shouldShowAdvisor:A.length>0||c.length>0||l<50||y.length>0,insights:A,habitPatterns:g,overallCompletionRate:l,bestPerformingHabits:f,strugglingHabits:c,smartQuickActions:p,totalHabits:s.length}},[s,o,a])}const Fs={Minus:it,Plus:de,TrendingDown:Me,RefreshCw:Ct,Sparkles:U};function qs({habits:s,completionData:o,onSelectAdjustment:a,onDismiss:x,variant:i="inline",className:n}){const[g,l]=r.useState(!1),[f,c]=r.useState(!1),y=Ms({habits:s,completionData:o}),A=()=>{l(!0),x?.()};if(g||!y.shouldShowAdvisor)return null;const p=y.smartQuickActions.filter(m=>m.priority==="primary").slice(0,2),h=y.smartQuickActions.slice(0,4),d=m=>{switch(m){case"warning":return e.jsx(St,{className:"w-4 h-4 text-amber-500"});case"celebration":return e.jsx(_t,{className:"w-4 h-4 text-green-500"});default:return e.jsx($e,{className:"w-4 h-4 text-blue-500"})}};if(i==="banner"){const m=y.insights[0],j=p[0];return e.jsxs(S.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:E("flex items-center gap-3 p-3 rounded-xl","bg-gradient-to-r from-purple-500/10 to-violet-500/10","border border-purple-500/20",n),children:[e.jsx(U,{className:"w-5 h-5 text-purple-400 flex-shrink-0"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("p",{className:"text-sm font-medium truncate",children:m?.title||"Optimize your rituals"})}),j&&e.jsx(R,{size:"sm",variant:"secondary",className:"flex-shrink-0 bg-purple-500/20 hover:bg-purple-500/30 text-purple-200",onClick:()=>a(j.adjustmentText),children:j.label}),x&&e.jsx("button",{onClick:A,className:"p-1 rounded-full hover:bg-white/10 text-muted-foreground",children:e.jsx(rt,{className:"w-4 h-4"})})]})}return e.jsxs(S.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:E("space-y-4",n),children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Smart suggestions"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:h.map(m=>{const j=Fs[m.icon]||U;return e.jsxs("button",{onClick:()=>a(m.adjustmentText),className:E("flex flex-col items-start gap-1.5 p-3 rounded-xl text-left transition-all","bg-gradient-to-br from-purple-500/10 to-violet-500/10","border border-purple-500/20 hover:border-purple-500/40","hover:from-purple-500/15 hover:to-violet-500/15",m.priority==="primary"&&"ring-1 ring-purple-500/30"),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 rounded-lg bg-purple-500/20",children:e.jsx(j,{className:"w-4 h-4 text-purple-400"})}),e.jsx("span",{className:"text-sm font-medium",children:m.label})]}),e.jsx("span",{className:"text-xs text-muted-foreground line-clamp-1",children:m.description})]},m.id)})})]}),y.insights.length>0&&e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>c(!f),className:"flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors w-full",children:[e.jsx($e,{className:"w-4 h-4 text-purple-400"}),e.jsxs("span",{children:[y.insights.length," insight",y.insights.length!==1?"s":""," available"]}),e.jsx(ge,{className:E("w-4 h-4 ml-auto transition-transform",f&&"rotate-90")})]}),e.jsx(we,{children:f&&e.jsx(S.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden",children:e.jsx("div",{className:"space-y-2 pt-3",children:y.insights.map(m=>e.jsx("div",{className:E("p-3 rounded-xl border",m.type==="warning"&&"bg-amber-500/10 border-amber-500/20",m.type==="celebration"&&"bg-green-500/10 border-green-500/20",m.type==="suggestion"&&"bg-blue-500/10 border-blue-500/20"),children:e.jsxs("div",{className:"flex items-start gap-2",children:[d(m.type),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium",children:m.title}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:m.description}),m.action&&e.jsxs(R,{size:"sm",variant:"ghost",className:"mt-2 h-7 text-xs",onClick:()=>a(m.action.adjustmentText),children:[m.action.label,e.jsx(ge,{className:"w-3 h-3 ml-1"})]})]})]})},m.id))})})})]}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"font-medium text-foreground",children:y.totalHabits})," rituals"]}),e.jsx("span",{className:"text-muted-foreground/30",children:"•"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsxs("span",{className:E("font-medium",y.overallCompletionRate>=70&&"text-green-500",y.overallCompletionRate>=40&&y.overallCompletionRate<70&&"text-amber-500",y.overallCompletionRate<40&&"text-red-500"),children:[Math.round(y.overallCompletionRate),"%"]})," avg completion"]})]})]})}const Ls=r.memo(function({open:o,onOpenChange:a,epicId:x,epicTitle:i,habits:n=[],completionData:g=[]}){const[l,f]=r.useState("input"),[c,y]=r.useState(""),[A,p]=r.useState(!0),{suggestions:h,analysis:d,encouragement:m,epicStatus:j,isLoading:P,generateAdjustments:H,toggleSuggestion:C,getSelectedSuggestions:b,applyAdjustments:v,reset:N}=Is(),L=k=>{y(k),p(!1)},M=async()=>{c.trim()&&(await H(x,"custom",{customRequest:c}),f("preview"))},Y=async()=>{f("saving"),await v(x,"custom",c)?O():f("preview")},O=()=>{f("input"),y(""),p(!0),N(),a(!1)},$=()=>{l==="preview"&&f("input")},W=k=>{switch(k.action){case"add":return e.jsx(de,{className:"h-4 w-4 text-green-500"});case"remove":return e.jsx(it,{className:"h-4 w-4 text-red-500"});default:return e.jsx(at,{className:"h-4 w-4 text-purple-500"})}};return e.jsx(ot,{open:o,onOpenChange:O,handleOnly:!0,shouldScaleBackground:!1,children:e.jsxs(ct,{className:"max-h-[90vh]",children:[e.jsxs(dt,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(mt,{className:"flex items-center gap-2",children:[e.jsx(nt,{className:"w-5 h-5 text-purple-400"}),"Smart Adjust Plan"]}),j&&e.jsxs(K,{variant:"outline",className:E("text-xs",j.progressDelta>=0?"border-green-500/50 text-green-500":"border-amber-500/50 text-amber-500"),children:[j.progressDelta>=0?e.jsx(Ye,{className:"w-3 h-3 mr-1"}):e.jsx(Me,{className:"w-3 h-3 mr-1"}),j.progressDelta>=0?"On track":"Behind"]})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[l==="input"&&"Personalized suggestions to optimize your rituals",l==="preview"&&"Review and apply the suggested changes",l==="saving"&&"Applying changes..."]})]}),e.jsx(Jt,{className:"flex-1 px-4 max-h-[60vh]",children:e.jsxs(we,{mode:"wait",children:[l==="input"&&e.jsxs(S.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"space-y-4 pb-4",children:[A&&n.length>0&&e.jsx(qs,{habits:n,completionData:g,onSelectAdjustment:L,onDismiss:()=>p(!1),variant:"inline"}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Describe your changes"}),e.jsx(Le,{value:c,onChange:k=>y(k.target.value),placeholder:"e.g., I want to add a morning meditation habit, or make my current habits easier...",className:"min-h-[100px] resize-none"})]}),e.jsxs("div",{className:"bg-secondary/30 rounded-lg p-3 space-y-1",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Current journey"}),e.jsx("div",{className:"text-sm font-medium",children:i}),e.jsx("div",{className:"flex gap-3 text-xs text-muted-foreground",children:e.jsxs("span",{children:[n.length," rituals"]})})]})]},"input"),l==="preview"&&e.jsxs(S.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"space-y-4 pb-4",children:[j&&e.jsxs(fe,{className:"p-3 bg-secondary/30",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Progress"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"font-medium",children:[Math.round(j.actualProgress),"%"]}),j.progressDelta>=0?e.jsxs(K,{variant:"secondary",className:"text-green-600 bg-green-500/10",children:[e.jsx(Ye,{className:"h-3 w-3 mr-1"}),"On track"]}):e.jsxs(K,{variant:"secondary",className:"text-amber-600 bg-amber-500/10",children:[e.jsx(Me,{className:"h-3 w-3 mr-1"}),"Behind"]})]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:[j.daysRemaining," days remaining"]})]}),d&&e.jsx("p",{className:"text-sm text-muted-foreground",children:d}),h.length>0?e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground mb-2",children:["Suggested changes (",h.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-[200px] overflow-y-auto",children:h.map(k=>e.jsx(fe,{className:E("p-3 cursor-pointer transition-all border-2",k.selected?"border-purple-500 bg-purple-500/5":"border-transparent hover:border-purple-500/30"),onClick:()=>C(k.id),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:E("flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center",k.selected?"bg-purple-500 text-white":"bg-secondary"),children:k.selected?e.jsx(pe,{className:"h-4 w-4"}):W(k)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:k.title}),e.jsx(K,{variant:"outline",className:"text-xs",children:Fe(k.type)})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:pt(k.description)})]})]})},k.id))})]}):e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground bg-secondary/30 rounded-lg p-3",children:[e.jsx(kt,{className:"w-4 h-4"}),"No suggestions yet. Try a different request."]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-secondary/30 rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-lg font-bold",children:n.length}),e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Current rituals"})]}),e.jsxs("div",{className:"bg-purple-500/10 rounded-lg p-3 text-center border border-purple-500/20",children:[e.jsx("div",{className:"text-lg font-bold text-purple-400",children:n.length+h.filter(k=>k.action==="add"&&k.selected).length-h.filter(k=>k.action==="remove"&&k.selected).length}),e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"After changes"})]})]}),m&&e.jsxs("p",{className:"text-sm text-purple-400 italic text-center",children:['"',m,'"']})]},"preview"),l==="saving"&&e.jsxs(S.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center py-12",children:[e.jsx(xe,{className:"w-8 h-8 animate-spin text-purple-400 mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Updating your rituals..."})]},"saving")]})}),e.jsxs(Vt,{className:"border-t pt-4",children:[l==="input"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(R,{variant:"outline",className:"flex-1",onClick:O,children:"Cancel"}),e.jsx(R,{className:"flex-1 gap-2 bg-purple-600 hover:bg-purple-700",onClick:M,disabled:P||!c.trim(),children:P?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"w-4 h-4 animate-spin"}),"Analyzing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"w-4 h-4"}),"Get Suggestions"]})})]}),l==="preview"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(R,{variant:"outline",className:"flex-1",onClick:$,children:"Back"}),e.jsxs(R,{className:"flex-1 gap-2 bg-purple-600 hover:bg-purple-700",onClick:Y,disabled:b().length===0,children:["Apply ",b().length," Change",b().length!==1?"s":"",e.jsx(Tt,{className:"w-4 h-4"})]})]})]})]})})}),zs={heroic:"from-epic-heroic/20 to-purple-500/20",warrior:"from-epic-warrior/20 to-orange-500/20",mystic:"from-epic-mystic/20 to-blue-500/20",nature:"from-epic-nature/20 to-emerald-500/20",solar:"from-epic-solar/20 to-amber-500/20"},Bs={heroic:"border-epic-heroic/20 hover:border-epic-heroic/40",warrior:"border-epic-warrior/20 hover:border-epic-warrior/40",mystic:"border-epic-mystic/20 hover:border-epic-mystic/40",nature:"border-epic-nature/20 hover:border-epic-nature/40",solar:"border-epic-solar/20 hover:border-epic-solar/40"},Je=({epic:s,onComplete:o,onAbandon:a})=>{const[x,i]=r.useState(!1),[n,g]=r.useState(!1),[l,f]=r.useState(!1),[c,y]=r.useState(!1),[A,p]=r.useState(null),{companion:h}=Zt(),{health:d}=es(),{checkAndGeneratePostcard:m}=ts(),{milestones:j}=ss(s.id),{generateRewardReveal:P}=as(),H=r.useMemo(()=>{if(!(!j||j.length===0))return j.map(u=>({id:u.id,title:u.title,milestone_percent:u.milestone_percent,is_postcard_milestone:u.is_postcard_milestone,completed_at:u.completed_at}))},[j]),C=r.useRef(-1),b=r.useRef(!1),v=r.useRef(-1),N=Math.ceil((new Date(s.end_date).getTime()-new Date().getTime())/(1e3*60*60*24)),L=s.status==="completed",M=s.status==="active",Y=s.theme_color||"heroic",O=zs[Y],$=Bs[Y];r.useEffect(()=>{if(!h?.id||!M)return;const u=s.progress_percentage,z=C.current;if(!b.current){b.current=!0,u>0&&m(s.id,u,0,h.id,{spirit_animal:h.spirit_animal,favorite_color:h.favorite_color,core_element:h.core_element,eye_color:h.eye_color,fur_color:h.fur_color}),C.current=u;return}u>z&&m(s.id,u,z,h.id,{spirit_animal:h.spirit_animal,favorite_color:h.favorite_color,core_element:h.core_element,eye_color:h.eye_color,fur_color:h.fur_color}),C.current=u,v.current>=0&&u>v.current&&window.dispatchEvent(new CustomEvent("epic-progress-checkpoint",{detail:{epicId:s.id,previousProgress:v.current,currentProgress:u}})),v.current=u},[s.progress_percentage,s.id,h,M,m]);const W=async()=>{if(s.invite_code)try{await navigator.clipboard.writeText(s.invite_code),i(!0),q.success("Invite code copied!",{description:"Share this code with others to invite them to your guild"}),setTimeout(()=>i(!1),2e3)}catch{q.error("Failed to copy code")}},k=async()=>{try{const u=await P(s.story_type_slug||null,s.id);p(u),y(!0)}catch(u){console.error("Failed to generate rewards:",u),o?.()}};return e.jsxs(S.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsxs(fe,{className:E("p-6 bg-gradient-to-br border-2 transition-all",`from-background to-secondary/20 ${$}`,`bg-gradient-to-br ${O}`),children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[L?e.jsx(he,{className:"w-6 h-6 text-stardust-gold drop-shadow-[0_0_8px_hsl(45,100%,65%)]"}):e.jsx(te,{className:"w-6 h-6 text-celestial-blue"}),e.jsx("h3",{className:"text-xl font-bold",children:s.title}),s.invite_code&&e.jsx(R,{variant:"ghost",size:"sm",className:"h-7 px-2 text-primary hover:text-primary hover:bg-primary/10",onClick:W,children:x?e.jsx(pe,{className:"w-4 h-4"}):e.jsx(Et,{className:"w-4 h-4"})})]}),s.description&&e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:pt(s.description)})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-2",children:[e.jsx(K,{variant:L?"gold":M?"celestial":"secondary",children:L?"Legendary":M?"Active":"Abandoned"}),M&&e.jsx("button",{onClick:()=>g(!0),className:"h-11 w-11 -m-3 rounded-full hover:bg-destructive/10 flex items-center justify-center text-muted-foreground/40 hover:text-destructive transition-colors touch-manipulation",title:"Abandon epic",children:e.jsx(rt,{className:"h-4 w-4"})})]})]}),e.jsx(rs,{progress:s.progress_percentage,targetDays:s.target_days,className:"mb-3",companionImageUrl:d?.imageUrl||h?.current_image_url,companionMood:d?.moodState,showCompanion:!0,milestones:H,epicId:s.id}),e.jsxs("div",{className:"flex items-center justify-center gap-4 text-xs text-muted-foreground mb-3 py-2 px-3 bg-background/30 rounded-lg",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(He,{className:"w-3 h-3"}),s.target_days,"d"]}),e.jsx("span",{className:"text-muted-foreground/30",children:"•"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(At,{className:"w-3 h-3 text-orange-500"}),L?"Done":`${N}d left`]}),e.jsx("span",{className:"text-muted-foreground/30",children:"•"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(qe,{className:"w-3 h-3 text-yellow-500"}),s.xp_reward," XP"]})]}),s.epic_habits&&s.epic_habits.length>0&&e.jsx(Ps,{epicId:s.id,habits:s.epic_habits.filter(u=>u.habits).map(u=>({id:u.habit_id,title:u.habits?.title||"Untitled",difficulty:u.habits?.difficulty||"medium",description:u.habits?.description,frequency:u.habits?.frequency,estimated_minutes:u.habits?.estimated_minutes,custom_days:u.habits?.custom_days})),isActive:M,onAdjustPlan:()=>f(!0),showAdjustPlan:M&&s.progress_percentage<100}),M&&s.progress_percentage>=100&&e.jsx("div",{className:"mt-4 space-y-2",children:e.jsxs(R,{onClick:k,className:"w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600",children:[e.jsx(he,{className:"w-4 h-4 mr-2"}),"Complete Epic"]})})]}),e.jsx(is,{open:n,onOpenChange:g,children:e.jsxs(ns,{children:[e.jsxs(ls,{children:[e.jsx(os,{children:"Abandon this epic?"}),e.jsxs(cs,{children:['Are you sure you want to abandon "',s.title,`"? Your progress will be lost and you won't earn the XP reward.`]})]}),e.jsxs(ds,{children:[e.jsx(ms,{children:"Cancel"}),e.jsx(us,{onClick:a,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Abandon Epic"})]})]})}),e.jsx(Ds,{open:c,onOpenChange:y,rewardData:A,onClaim:()=>{o?.(),q.success("Campaign Complete!",{description:"Your rewards have been added to your collection."})}}),e.jsx(Ls,{open:l,onOpenChange:f,epicId:s.id,epicTitle:s.title,habits:s.epic_habits?.filter(u=>u.habits).map(u=>({id:u.habit_id,title:u.habits?.title||"Untitled",difficulty:u.habits?.difficulty,frequency:u.habits?.frequency,estimated_minutes:u.habits?.estimated_minutes}))||[]})]})},yt=r.memo(({habitTitle:s,habitDescription:o="",difficulty:a,selectedDays:x,habitCount:i,maxHabits:n=2,preferredTime:g,reminderEnabled:l,reminderMinutesBefore:f,onTitleChange:c,onDescriptionChange:y,onDifficultyChange:A,onDaysChange:p,onPreferredTimeChange:h,onReminderEnabledChange:d,onReminderMinutesChange:m,onAddHabit:j,isEditing:P=!1,onCancelEdit:H})=>{const C=n-i;return e.jsxs("div",{className:"border rounded-lg p-3 space-y-3",children:[e.jsx(me,{placeholder:"Habit name (e.g., Morning run)",value:s,onChange:b=>c(b.target.value),maxLength:60}),y&&e.jsx(Le,{placeholder:"Brief description or ritual details (optional)",value:o,onChange:b=>y(b.target.value),maxLength:200,rows:2,className:"text-sm resize-none"}),e.jsx(ut,{value:a,onChange:A}),e.jsx(xt,{selectedDays:x,onDaysChange:p}),e.jsxs("div",{className:"space-y-3 pt-2 border-t border-border/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ce,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(V,{className:"text-sm text-muted-foreground",children:"Schedule (optional)"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(me,{type:"time",value:g,onChange:b=>h(b.target.value),className:"flex-1",placeholder:"Set time"}),g&&e.jsx(R,{type:"button",variant:"ghost",size:"sm",onClick:()=>h(""),className:"text-muted-foreground",children:"Clear"})]}),g&&e.jsxs("div",{className:"space-y-2 pl-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(V,{htmlFor:"reminder-toggle",className:"text-sm",children:"Push notification reminder"}),e.jsx(xs,{id:"reminder-toggle",checked:l,onCheckedChange:d})]}),l&&e.jsxs(ps,{value:f.toString(),onValueChange:b=>m(parseInt(b)),children:[e.jsx(hs,{className:"w-full",children:e.jsx(gs,{placeholder:"Remind me..."})}),e.jsxs(fs,{children:[e.jsx(ue,{value:"5",children:"5 minutes before"}),e.jsx(ue,{value:"10",children:"10 minutes before"}),e.jsx(ue,{value:"15",children:"15 minutes before"}),e.jsx(ue,{value:"30",children:"30 minutes before"}),e.jsx(ue,{value:"60",children:"1 hour before"})]})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(R,{type:"button",variant:P?"default":"outline",size:"sm",onClick:j,disabled:!s.trim(),className:"flex-1",children:P?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Update Habit"]}):e.jsxs(e.Fragment,{children:[e.jsx(de,{className:"h-4 w-4 mr-2"}),"Add Habit ",i>0&&`(${C} remaining)`]})}),P&&H&&e.jsx(R,{type:"button",variant:"ghost",size:"sm",onClick:H,children:"Cancel"})]})]})});yt.displayName="EpicHabitForm";const Os=["M","T","W","T","F","S","S"],$s=s=>{if(!s)return"";const[o,a]=s.split(":"),x=parseInt(o),i=x>=12?"PM":"AM";return`${x%12||12}:${a} ${i}`},Ys=(s,o)=>s==="daily"||!o||o.length===0||o.length===7?{type:"text",value:"Daily"}:o.length===5&&[0,1,2,3,4].every(a=>o.includes(a))?{type:"text",value:"Weekdays"}:{type:"chips",value:o},jt=r.memo(({habits:s,onRemove:o,onEdit:a})=>s.length===0?null:e.jsx("div",{className:"space-y-2",children:s.map((x,i)=>{const n=Ys(x.frequency,x.custom_days);return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-accent/20 rounded-lg",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:x.title}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground mt-1",children:[n.type==="text"?e.jsx("span",{children:n.value}):e.jsx("div",{className:"flex gap-0.5",children:Os.map((g,l)=>e.jsx("span",{className:E("w-4 h-4 rounded-full text-[9px] font-bold flex items-center justify-center",n.value.includes(l)?"bg-primary/80 text-primary-foreground":"bg-muted/50 text-muted-foreground/50"),children:g},l))}),x.preferred_time&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(ce,{className:"h-3 w-3"}),$s(x.preferred_time)]})]}),x.reminder_enabled&&e.jsx(Rt,{className:"h-3 w-3 text-primary"})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[a&&e.jsx(R,{type:"button",variant:"ghost",size:"sm",onClick:()=>a(i),children:e.jsx(Ie,{className:"h-4 w-4"})}),e.jsx(R,{type:"button",variant:"ghost",size:"sm",onClick:()=>o(i),children:e.jsx(Pt,{className:"h-4 w-4"})})]})]},i)})}));jt.displayName="EpicHabitList";const Ve=[{slug:"treasure_hunt",name:"Treasure Hunt",description:"Follow clues to a legendary artifact hidden among the stars",icon:Dt,baseChapters:5,bossHint:"The Guardian of Lost Treasures",color:"from-amber-500 to-yellow-600"},{slug:"mystery",name:"Cosmiq Mystery",description:"Unravel secrets that threaten the fabric of reality",icon:Ht,baseChapters:6,bossHint:"The Keeper of Forgotten Truths",color:"from-purple-500 to-indigo-600"},{slug:"pilgrimage",name:"Sacred Pilgrimage",description:"Journey to sacred sites seeking enlightenment and peace",icon:It,baseChapters:4,bossHint:"The Trial of Inner Shadows",color:"from-cyan-500 to-teal-600"},{slug:"heroes_journey",name:"Hero's Journey",description:"Answer the call to adventure and become a legend",icon:Mt,baseChapters:6,bossHint:"The Dark Mirror of Destiny",color:"from-red-500 to-orange-600"},{slug:"rescue_mission",name:"Rescue Mission",description:"Race against time to save someone precious from darkness",icon:Ft,baseChapters:5,bossHint:"The Void That Consumes",color:"from-pink-500 to-rose-600"},{slug:"exploration",name:"Uncharted Realms",description:"Discover new worlds and map the unknown cosmos",icon:qt,baseChapters:5,bossHint:"The Primordial Chaos",color:"from-emerald-500 to-green-600"}],Ws=({selectedType:s,onSelect:o})=>{const[a,x]=r.useState(null),i=n=>{a===n||x(n),o(n)};return e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Choose Your Adventure Type"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Ve.map((n,g)=>{const l=n.icon,f=s===n.slug,c=a===n.slug;return e.jsx(S.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:g*.05},layout:!0,children:e.jsx(fe,{className:E("p-3 cursor-pointer transition-all border-2","hover:scale-[1.02] hover:shadow-lg",f?"border-primary bg-primary/10 shadow-glow":"border-transparent hover:border-primary/30"),onClick:()=>i(n.slug),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:E("w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0","bg-gradient-to-br",n.color),children:e.jsx(l,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold text-sm truncate",children:n.name}),f&&e.jsx(K,{variant:"default",className:"text-[10px] px-1.5 py-0",children:"Selected"})]}),e.jsx(we,{mode:"wait",children:c?e.jsx(S.p,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},className:"text-[11px] text-muted-foreground mt-0.5",children:n.description},"full"):e.jsxs(S.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"flex items-center gap-1 mt-0.5",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground line-clamp-1 flex-1",children:n.description}),e.jsx(be,{className:"w-3 h-3 text-muted-foreground flex-shrink-0"})]},"truncated")})]})]})})},n.slug)})}),s&&e.jsx(S.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},className:"mt-3 p-3 bg-primary/5 border border-primary/20 rounded-lg",children:e.jsxs("p",{className:"text-xs text-muted-foreground",children:[e.jsx("span",{className:"text-primary font-medium",children:"Final Boss Hint:"})," ",Ve.find(n=>n.slug===s)?.bossHint]})})]})},Ze={heroic:{icon:te,label:"Heroic",colors:"from-epic-heroic to-purple-500",gradient:"bg-gradient-to-r from-epic-heroic/20 to-purple-500/20 border-epic-heroic/40"},warrior:{icon:Ot,label:"Warrior",colors:"from-epic-warrior to-orange-500",gradient:"bg-gradient-to-r from-epic-warrior/20 to-orange-500/20 border-epic-warrior/40"},mystic:{icon:U,label:"Mystic",colors:"from-epic-mystic to-blue-500",gradient:"bg-gradient-to-r from-epic-mystic/20 to-blue-500/20 border-epic-mystic/40"},nature:{icon:Bt,label:"Nature",colors:"from-epic-nature to-emerald-500",gradient:"bg-gradient-to-r from-epic-nature/20 to-emerald-500/20 border-epic-nature/40"},solar:{icon:zt,label:"Solar",colors:"from-epic-solar to-amber-500",gradient:"bg-gradient-to-r from-epic-solar/20 to-amber-500/20 border-epic-solar/40"}},Xs=({open:s,onOpenChange:o,onCreateEpic:a,isCreating:x,template:i})=>{const[n,g]=r.useState("story"),[l,f]=r.useState(null),[c,y]=r.useState(""),[A,p]=r.useState(""),[h,d]=r.useState(30),[m,j]=r.useState("heroic"),[P,H]=r.useState("beginner"),[C,b]=r.useState([]),[v,N]=r.useState(""),[L,M]=r.useState(""),[Y,O]=r.useState("medium"),[$,W]=r.useState([0,1,2,3,4,5,6]),[k,u]=r.useState(""),[z,se]=r.useState(!1),[ie,ae]=r.useState(15),[re,ne]=r.useState(null),Z=r.useMemo(()=>Ne(P),[P]);r.useEffect(()=>{if(i&&s){y(i.name),p(i.description),d(i.target_days),j(i.theme_color||"heroic");const w=i.difficulty_tier||"beginner";H(w);const t=Ne(w),_=i.habits.slice(0,t).map(I=>({title:I.title,description:I.description||void 0,difficulty:I.difficulty,frequency:I.frequency||"daily",custom_days:I.frequency==="daily"?[]:[0,1,2,3,4,5,6]}));b(_),i.habits.length>t&&console.info(`Template "${i.name}" has ${i.habits.length} habits, truncated to ${t} for ${w} tier`)}},[i,s]);const Se=r.useCallback(()=>{if(!v.trim())return;const w=ys(v),t={title:v.trim(),description:L.trim()||void 0,difficulty:Y,frequency:$.length===7?"daily":"custom",custom_days:$.length===7?[]:$,preferred_time:k||void 0,reminder_enabled:z,reminder_minutes_before:ie,category:w||"soul"};re!==null?(b(_=>_.map((I,T)=>T===re?t:I)),ne(null)):C.length<Z&&b(_=>[..._,t]),N(""),M(""),O("medium"),W([0,1,2,3,4,5,6]),u(""),se(!1),ae(15)},[v,L,Y,$,k,z,ie,C.length,re,Z]),ee=r.useCallback(w=>{const t=C[w];N(t.title),M(t.description||""),O(t.difficulty),W(t.frequency==="daily"?[0,1,2,3,4,5,6]:t.custom_days),u(t.preferred_time||""),se(t.reminder_enabled||!1),ae(t.reminder_minutes_before||15),ne(w)},[C]),ke=r.useCallback(()=>{ne(null),N(""),M(""),O("medium"),W([0,1,2,3,4,5,6]),u(""),se(!1),ae(15)},[]),le=r.useCallback(w=>{b(t=>t.filter((_,I)=>I!==w))},[]),ye=r.useCallback(()=>{!c.trim()||C.length===0||(a({title:c.trim(),description:A.trim()||void 0,target_days:h,habits:C,is_public:!0,theme_color:m,story_type_slug:l||void 0}),je())},[c,A,h,C,m,l,a]),je=()=>{g("story"),f(null),y(""),p(""),d(30),j("heroic"),H("beginner"),b([]),N(""),M(""),O("medium"),W([0,1,2,3,4,5,6]),u(""),se(!1),ae(15),ne(null)},Te=w=>{w||je(),o(w)},J=r.useCallback(()=>h*js.XP_PER_DAY,[h]);return e.jsx(Ce,{open:s,onOpenChange:Te,children:e.jsxs(_e,{className:"sm:max-w-md max-h-[90vh] overflow-y-auto",style:{WebkitOverflowScrolling:"touch",overscrollBehavior:"contain"},children:[e.jsxs(ze,{children:[e.jsxs(Be,{className:"flex items-center gap-2",children:[i?.badge_icon&&e.jsx("span",{className:"text-xl",children:i.badge_icon}),e.jsx(te,{className:"w-5 h-5 text-primary"}),i?`Start: ${i.name}`:n==="story"?"Choose Your Adventure":"Create Legendary Epic"]}),e.jsx(ht,{children:i?e.jsxs("span",{className:"flex items-center gap-2",children:["Starting from template",e.jsx(K,{variant:"secondary",className:"text-xs",children:i.difficulty_tier})]}):n==="story"?"Select the type of story you want to experience":"Create an epic and add habits to track your progress."})]}),n==="story"&&!i&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(Ws,{selectedType:l,onSelect:f}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Epic Duration"}),e.jsx("div",{className:"flex gap-2",children:[14,30,45,60].map(w=>e.jsxs(R,{type:"button",variant:h===w?"default":"outline",size:"sm",onClick:()=>d(w),className:"flex-1",children:[w,"d"]},w))})]}),e.jsxs(R,{onClick:()=>g("details"),disabled:!l,className:"w-full",children:["Continue",e.jsx(ge,{className:"w-4 h-4 ml-1"})]}),e.jsx(R,{variant:"ghost",onClick:()=>{f(null),g("details")},className:"w-full text-muted-foreground",children:"Skip story selection"})]}),(n==="details"||i)&&e.jsxs("div",{className:"space-y-4",children:[!i&&e.jsxs(R,{variant:"ghost",size:"sm",onClick:()=>g("story"),className:"mb-2",children:[e.jsx(Lt,{className:"w-4 h-4 mr-1"}),"Change story type"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"epic-title",children:"Epic Name *"}),e.jsx(me,{id:"epic-title",placeholder:"e.g., Become a Morning Warrior",value:c,onChange:w=>y(w.target.value),maxLength:60,style:{touchAction:"manipulation",WebkitTapHighlightColor:"transparent"}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"epic-description",children:"Epic Quest Description"}),e.jsx(Le,{id:"epic-description",placeholder:"What legendary feat will you accomplish?",value:A,onChange:w=>p(w.target.value),rows:3,maxLength:200,style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent"}})]}),i&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"target-days",children:"Epic Duration (Days)"}),e.jsx("div",{className:"flex gap-2",children:[7,14,21,30,60].map(w=>e.jsxs(R,{type:"button",variant:h===w?"default":"outline",size:"sm",onClick:()=>d(w),className:"flex-1",children:[w,"d"]},w))}),e.jsx(me,{id:"target-days",type:"number",min:1,max:365,value:h,onChange:w=>{const t=parseInt(w.target.value);!isNaN(t)&&t>=1&&t<=365?d(t):w.target.value===""&&d(1)},className:"mt-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{children:"Epic Theme"}),e.jsx("div",{className:"grid grid-cols-5 gap-2",children:Object.keys(Ze).map(w=>{const t=Ze[w],_=t.icon;return e.jsxs(R,{type:"button",variant:"outline",size:"sm",onClick:()=>j(w),className:E("flex flex-col items-center gap-1 h-auto py-3 transition-all",m===w?`${t.gradient} border-2 shadow-lg`:"hover:bg-muted"),children:[e.jsx(_,{className:E("h-5 w-5",m===w&&`bg-gradient-to-r ${t.colors} bg-clip-text text-transparent`)}),e.jsx("span",{className:"text-xs",children:t.label})]},w)})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(V,{children:["Epic Habits ",i?"(from template)":"(Required)"]}),e.jsx(jt,{habits:C,onRemove:le,onEdit:ee}),(C.length<Z||re!==null)&&e.jsx(yt,{habitTitle:v,habitDescription:L,difficulty:Y,selectedDays:$,habitCount:C.length,maxHabits:Z,preferredTime:k,reminderEnabled:z,reminderMinutesBefore:ie,onTitleChange:N,onDescriptionChange:M,onDifficultyChange:O,onDaysChange:W,onPreferredTimeChange:u,onReminderEnabledChange:se,onReminderMinutesChange:ae,onAddHabit:Se,isEditing:re!==null,onCancelEdit:ke}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Add up to ",Z," habit",Z>1?"s":""," that contribute to this epic",P==="advanced"&&" (Advanced tier unlocks 3 habits)"]})]}),e.jsxs("div",{className:"bg-primary/10 border border-primary/20 rounded-lg p-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qe,{className:"w-5 h-5 text-yellow-500"}),e.jsx("span",{className:"text-sm font-medium",children:"Epic Completion Reward"})]}),e.jsxs("span",{className:"text-lg font-bold text-primary",children:["+",J()," XP"]})]}),e.jsx(R,{onClick:ye,disabled:!c.trim()||C.length===0||x,className:"w-full bg-gradient-to-r from-primary to-purple-600 hover:from-primary/90 hover:to-purple-600/90",children:x?"Creating Epic...":i?`Start ${i.name}! 🎯`:"Begin Epic Quest! 🎯"})]})]})})},Qs=r.memo(function({open:o,onOpenChange:a}){const[x,i]=r.useState(""),[n,g]=r.useState(!1),[l,f]=r.useState(!1),c=st(),y=2;r.useEffect(()=>{o&&(f(!1),i(""))},[o]);const A=async()=>{if(!x.trim()){q.error("Please enter an invite code");return}g(!0);try{const h=`EPIC-${x.trim().toUpperCase().replace("EPIC-","")}`,{data:d,error:m}=await Q.from("epics").select("*, epic_story_types(slug), epic_habits(habit_id, habits(id, title, difficulty, frequency, custom_days))").eq("invite_code",h).eq("is_public",!0).maybeSingle();if(m)throw m;if(!d){q.error("Epic not found. Check the code and try again."),g(!1);return}const{data:j}=await Q.auth.getUser();if(!j.user){q.error("Please sign in to join guilds"),g(!1);return}const{data:P}=await Q.from("epics").select("id").eq("user_id",j.user.id).eq("status","active"),{data:H}=await Q.from("epic_members").select("epic_id, epics!inner(user_id, status)").eq("user_id",j.user.id).neq("epics.user_id",j.user.id).eq("epics.status","active");if((P?.length||0)+(H?.length||0)>=y){f(!0),q.error(`You can only have ${y} active epics at a time`),g(!1);return}const{data:b}=await Q.from("epic_members").select("id").eq("epic_id",d.id).eq("user_id",j.user.id).maybeSingle();if(b){q.error("You're already in this guild!"),g(!1);return}const{error:v}=await Q.from("epic_members").insert({epic_id:d.id,user_id:j.user.id});if(v)throw v;if(d.epic_habits&&d.epic_habits.length>0){let N="beginner";d.target_days>=45?N="advanced":d.target_days>=21&&(N="intermediate");const L=Ne(N),Y=d.epic_habits.slice(0,L).map(u=>({user_id:j.user.id,title:u.habits.title,difficulty:u.habits.difficulty,frequency:u.habits.frequency||"daily",custom_days:u.habits.custom_days||null})),{data:O,error:$}=await Q.from("habits").insert(Y).select();if($)throw $;const W=O?.map(u=>({epic_id:d.id,habit_id:u.id}))||[],{error:k}=await Q.from("epic_habits").insert(W);if(k)throw k}q.success(`Joined "${d.title}" guild! 🎯`),a(!1),i(""),c.invalidateQueries({queryKey:["epics"]}),c.invalidateQueries({queryKey:["habits"]})}catch(p){console.error("Error joining epic:",p),q.error("Failed to join guild. Please try again.")}finally{g(!1)}};return e.jsx(Ce,{open:o,onOpenChange:a,children:e.jsxs(_e,{className:"sm:max-w-md",children:[e.jsxs(ze,{children:[e.jsx(Be,{children:"Join an Epic"}),e.jsx(ht,{children:"Enter an invite code to join a shared epic with others"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(V,{htmlFor:"invite-code",children:"Invite Code"}),e.jsx(me,{id:"invite-code",placeholder:"EPIC-WELLNESS-5K2X",value:x,onChange:p=>i(p.target.value),onKeyDown:p=>{p.key==="Enter"&&!n&&A()}}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"You can paste the full link or just the code"})]}),l?e.jsxs("p",{className:"text-sm text-amber-500 text-center py-2",children:["You can only have ",y," active epics at a time. Complete or abandon an epic to join a new one."]}):e.jsx(R,{onClick:A,disabled:n||!x.trim(),className:"w-full",children:n?"Loading...":"Join Epic"})]})]})})}),Us=()=>e.jsxs(bs,{children:[e.jsx(vs,{asChild:!0,children:e.jsx("button",{type:"button",className:"inline-flex items-center justify-center ml-2 opacity-60 hover:opacity-100 transition-opacity touch-manipulation active:scale-95","aria-label":"Learn about Star Paths",children:e.jsx($t,{className:"h-5 w-5 text-primary"})})}),e.jsx(Ns,{className:"w-80 cosmiq-glass border-primary/30 shadow-xl",side:"bottom",sideOffset:8,children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-heading font-bold text-base text-primary",children:"⭐ Star Paths"}),e.jsx("p",{className:"text-sm leading-relaxed text-foreground/90",children:"Pre-built epic journeys with curated habits to help you start your wellness adventure instantly!"}),e.jsxs("div",{className:"space-y-2 pt-2 border-t border-primary/20",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-xs font-semibold text-green-400 mt-0.5",children:"🌱"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold text-green-400",children:"Beginner"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Perfect for starting out"})]})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-xs font-semibold text-yellow-400 mt-0.5",children:"⚡"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold text-yellow-400",children:"Intermediate"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ready to level up"})]})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-xs font-semibold text-red-400 mt-0.5",children:"🔥"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold text-red-400",children:"Advanced"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"For seasoned warriors"})]})]})]})]})})]}),Gs={beginner:{label:"Beginner",color:"bg-green-500/20 text-green-400 border-green-500/30"},intermediate:{label:"Intermediate",color:"bg-yellow-500/20 text-yellow-400 border-yellow-500/30"},advanced:{label:"Advanced",color:"bg-red-500/20 text-red-400 border-red-500/30"}},et={heroic:"from-purple-500/20 to-purple-600/10 border-purple-500/30",warrior:"from-orange-500/20 to-red-600/10 border-orange-500/30",mystic:"from-blue-500/20 to-indigo-600/10 border-blue-500/30",nature:"from-green-500/20 to-emerald-600/10 border-green-500/30",solar:"from-yellow-500/20 to-amber-600/10 border-yellow-500/30"},Ks=({onSelectTemplate:s})=>{const{templates:o,featuredTemplates:a,isLoading:x,incrementPopularity:i}=ws(),[n,g]=r.useState("all"),l=n==="all"?o:o.filter(c=>c.difficulty_tier===n),f=c=>{i.mutate(c.id),s(c)};return x?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs("div",{className:"space-y-6",children:[a.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ve,{className:"h-5 w-5 text-yellow-500"}),e.jsx("h3",{className:"font-semibold",children:"Featured Star Paths"}),e.jsx(Us,{})]}),e.jsx("div",{className:"grid gap-3",children:a.slice(0,3).map(c=>e.jsx(tt,{template:c,onSelect:f,featured:!0},c.id))})]}),e.jsx(gt,{value:n,onValueChange:c=>g(c),children:e.jsxs(ft,{className:"grid w-full grid-cols-4",children:[e.jsx(oe,{value:"all",children:"All"}),e.jsx(oe,{value:"beginner",children:"Beginner"}),e.jsx(oe,{value:"intermediate",children:"Medium"}),e.jsx(oe,{value:"advanced",children:"Advanced"})]})}),e.jsx("div",{className:"grid gap-3",children:l.map((c,y)=>e.jsx(S.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:y*.05},children:e.jsx(tt,{template:c,onSelect:f})},c.id))}),l.length===0&&e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(te,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No star paths found for this difficulty"})]})]})},tt=({template:s,onSelect:o,featured:a})=>{const x=Gs[s.difficulty_tier],i=et[s.theme_color]||et.heroic,n=Ne(s.difficulty_tier),g=s.habits.slice(0,n),l=r.useRef(null),f=10,c=r.useCallback(()=>{o(s)},[o,s]),y=r.useCallback(p=>{l.current={x:p.touches[0].clientX,y:p.touches[0].clientY}},[]),A=r.useCallback(p=>{if(!l.current)return;const h=p.changedTouches[0].clientX,d=p.changedTouches[0].clientY,m=Math.abs(h-l.current.x),j=Math.abs(d-l.current.y);m<f&&j<f&&(p.preventDefault(),c()),l.current=null},[c]);return e.jsx(fe,{className:E("cursor-pointer transition-all sm:hover:scale-[1.02] hover:shadow-lg border select-none active:scale-[0.98]",`bg-gradient-to-r ${i}`,a&&"ring-2 ring-primary/50"),onClick:c,onTouchStart:y,onTouchEnd:A,role:"button",tabIndex:0,style:{WebkitTapHighlightColor:"transparent",touchAction:"manipulation"},children:e.jsx(Cs,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-2xl",children:s.badge_icon}),e.jsx("h4",{className:"font-semibold truncate",children:s.name}),a&&e.jsxs(K,{variant:"secondary",className:"text-xs bg-primary/20 text-primary",children:[e.jsx(U,{className:"h-3 w-3 mr-1"}),"Featured"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2 mb-3",children:s.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(K,{variant:"outline",className:x.color,children:x.label}),e.jsxs(K,{variant:"outline",className:"text-xs",children:[e.jsx(ce,{className:"h-3 w-3 mr-1"}),s.target_days," days"]}),s.popularity_count>0&&e.jsxs(K,{variant:"outline",className:"text-xs text-muted-foreground",children:[e.jsx(lt,{className:"h-3 w-3 mr-1"}),s.popularity_count]})]}),g.length>0&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-border/30",children:[e.jsxs("p",{className:"text-xs text-muted-foreground mb-2",children:["Habits included (",g.length,"):"]}),e.jsx("div",{className:"space-y-1.5",children:g.map((p,h)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("span",{className:E("w-1.5 h-1.5 rounded-full flex-shrink-0",p.difficulty==="easy"&&"bg-green-500",p.difficulty==="medium"&&"bg-yellow-500",p.difficulty==="hard"&&"bg-red-500",!p.difficulty&&"bg-muted-foreground")}),e.jsx("span",{className:"truncate",children:p.title}),e.jsxs("span",{className:"text-muted-foreground/70 flex-shrink-0",children:["(",p.frequency,")"]})]},h))})]})]}),e.jsx(ge,{className:"h-5 w-5 text-muted-foreground flex-shrink-0"})]})})})},Js=()=>e.jsxs(S.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"min-h-screen pb-nav-safe pt-safe px-4",children:[e.jsxs("div",{className:"mb-8 text-center space-y-3",children:[e.jsx(X,{className:"h-8 w-40 mx-auto rounded-full"}),e.jsx(X,{className:"h-10 w-48 mx-auto"}),e.jsx(X,{className:"h-5 w-64 mx-auto"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[e.jsx(X,{className:"h-12 rounded-lg"}),e.jsx(X,{className:"h-12 rounded-lg"})]}),e.jsxs("div",{className:"mb-6 space-y-3",children:[e.jsx(X,{className:"h-14 w-full rounded-lg"}),e.jsx(X,{className:"h-12 w-full rounded-lg"})]}),e.jsx(X,{className:"h-10 w-full rounded-lg mb-6"}),e.jsx("div",{className:"space-y-4",children:[1,2].map(s=>e.jsxs("div",{className:"rounded-2xl border border-border/50 p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(X,{className:"h-6 w-3/4"}),e.jsx(X,{className:"h-4 w-1/2"})]}),e.jsx(X,{className:"h-10 w-10 rounded-full"})]}),e.jsx(X,{className:"h-2 w-full rounded-full"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx(X,{className:"h-4 w-24"}),e.jsx(X,{className:"h-4 w-24"})]})]},s))})]}),aa=()=>{const[s,o]=r.useState(!1),[a,x]=r.useState(!1),[i,n]=r.useState(!1),[g,l]=r.useState(!1),[f,c]=r.useState(!1),[y,A]=r.useState(null),{activeEpics:p,completedEpics:h,isLoading:d,createEpic:m,isCreating:j,updateEpicStatus:P}=_s(),H=2,C=p.length>=H,b=N=>{m(N),o(!1),A(null)},v=N=>{A(N),l(!1),o(!0)};return d?e.jsxs(Xe,{children:[e.jsx(Qe,{}),e.jsx(Js,{})]}):e.jsxs(Xe,{children:[e.jsx(Qe,{}),e.jsxs("div",{className:"min-h-screen pb-nav-safe pt-safe px-4 relative z-10",children:[e.jsxs(S.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"mb-8 text-center relative",children:[e.jsx(Ss,{onClick:()=>c(!0),className:"absolute right-0 top-0"}),e.jsxs("div",{className:"inline-flex items-center gap-2 mb-3 bg-gradient-to-r from-primary/20 to-purple-500/20 px-4 py-2 rounded-full",children:[e.jsx(U,{className:"w-5 h-5 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"Legendary Quests"})]}),e.jsx("h1",{className:"text-4xl font-bold mb-2 bg-gradient-to-r from-primary to-purple-500 bg-clip-text text-transparent",children:"Your Epics"}),e.jsx("p",{className:"text-muted-foreground max-w-md mx-auto",children:"Embark on legendary journeys. Link your daily habits to conquer epic goals!"})]}),e.jsxs(S.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{delay:.1},className:"grid grid-cols-2 gap-3 mb-4",children:[e.jsxs(R,{onClick:()=>n(!0),variant:"outline",className:"h-12",children:[e.jsx(lt,{className:"w-4 h-4 mr-2"}),"Join Guild"]}),e.jsxs(R,{onClick:()=>l(!0),variant:"outline",className:"h-12",children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"Star Paths"]})]}),e.jsx(S.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{delay:.15},className:"mb-6 space-y-3",children:C?e.jsxs("div",{className:"w-full h-14 flex items-center justify-center bg-secondary/30 rounded-lg border border-border/50 text-muted-foreground text-sm",children:["You can only have ",H," active epics at a time"]}):e.jsxs(e.Fragment,{children:[e.jsxs(R,{onClick:()=>x(!0),className:"w-full bg-gradient-to-r from-primary to-purple-600 hover:from-primary/90 hover:to-purple-600/90 h-14 text-lg",size:"lg",children:[e.jsx(nt,{className:"w-5 h-5 mr-2"}),"Create Smart Epic"]}),e.jsxs(R,{onClick:()=>{A(null),o(!0)},variant:"outline",className:"w-full h-12",children:[e.jsx(de,{className:"w-4 h-4 mr-2"}),"Create Custom Epic"]})]})}),e.jsxs(gt,{defaultValue:"active",className:"w-full",children:[e.jsxs(ft,{className:"grid w-full grid-cols-2 mb-6",children:[e.jsxs(oe,{value:"active",className:"flex items-center gap-2",children:[e.jsx(te,{className:"w-4 h-4"}),"Active (",p.length,")"]}),e.jsxs(oe,{value:"completed",className:"flex items-center gap-2",children:[e.jsx(he,{className:"w-4 h-4"}),"Legendary (",h.length,")"]})]}),e.jsx(Ue,{value:"active",className:"space-y-4",children:p.length===0?e.jsxs(S.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center py-12 bg-secondary/20 rounded-lg border-2 border-dashed border-primary/20",children:[e.jsx(U,{className:"w-16 h-16 text-primary mx-auto mb-4 animate-pulse"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Active Epics"}),e.jsx("p",{className:"text-muted-foreground mb-6 max-w-sm mx-auto",children:"Begin your first legendary quest! Discover guided paths designed to help you build powerful habits and achieve your goals."}),e.jsxs(R,{onClick:()=>l(!0),className:"bg-gradient-to-r from-amber-500 via-purple-500 to-pink-500 hover:from-amber-600 hover:via-purple-600 hover:to-pink-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 h-12 px-8 text-base font-semibold",size:"lg",children:[e.jsx(U,{className:"w-5 h-5 mr-2"}),"Explore Star Paths",e.jsx(ge,{className:"w-5 h-5 ml-2"})]})]}):p.map(N=>e.jsx(Je,{epic:N,onComplete:()=>P({epicId:N.id,status:"completed"}),onAbandon:()=>P({epicId:N.id,status:"abandoned"})},N.id))}),e.jsx(Ue,{value:"completed",className:"space-y-4",children:h.length===0?e.jsxs(S.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center py-12 bg-secondary/20 rounded-lg border-2 border-dashed border-primary/20",children:[e.jsx(he,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4 opacity-50"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Legendary Epics Yet"}),e.jsx("p",{className:"text-muted-foreground max-w-sm mx-auto",children:"Complete your first epic to earn this legendary status and massive XP rewards!"})]}):h.map(N=>e.jsx(Je,{epic:N},N.id))})]}),e.jsx(ks,{open:a,onOpenChange:x,onCreateEpic:N=>{m(N),x(!1)},isCreating:j}),e.jsx(Xs,{open:s,onOpenChange:o,onCreateEpic:b,isCreating:j,template:y}),e.jsx(Qs,{open:i,onOpenChange:n}),e.jsx(Ce,{open:g,onOpenChange:l,children:e.jsxs(_e,{className:"sm:max-w-lg max-h-[85vh] overflow-y-auto",children:[e.jsx(ze,{children:e.jsxs(Be,{className:"flex items-center gap-2",children:[e.jsx(U,{className:"w-5 h-5 text-primary"}),"Star Paths"]})}),e.jsx(Ks,{onSelectTemplate:v})]})}),e.jsx(Ts,{open:f,onClose:()=>c(!1),title:"About Epics",icon:te,description:"Epics are long-term goals that link your daily habits together for massive growth.",features:["Create epics with target completion days","Link habits to track progress automatically","Join guilds to work toward goals with others","Compete with rivals and send shouts to motivate","Earn bonus XP for completing epic-linked habits"],tip:"Try a template like 'Detox Warrior' for a dopamine detox challenge with pre-built habits!"})]})]})};export{aa as default};
