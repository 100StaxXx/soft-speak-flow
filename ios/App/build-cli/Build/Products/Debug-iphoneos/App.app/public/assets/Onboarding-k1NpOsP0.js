import{r as m,j as e,m as r,K as W,az as ue,l as q,cp as Te,cg as Ie,n as te,as as Ae,bd as Oe,dd as De,H as ze,u as Pe,aA as $}from"./vendor-FfY6MM0Z.js";import{s as Le}from"./nativeNavigation-DLS7qEr9.js";import{a as $e,C as ae,B,P as Fe,b as qe,M as Be,c as Ye,d as Re,S as We,s as I,l as A}from"./index-sX_cJ3I4.js";import{L as ie,f as ne,C as Ge}from"./CompanionPersonalization-nKWkjw34.js";import{M as Ue}from"./MentorGrid-BGn289sO.js";import"./date-vendor-Bk4KiHsJ.js";import"./three-vendor-qI8GXUTd.js";const He=({onComplete:a})=>{const[t,n]=m.useState(""),[i,c]=m.useState(!1),[p,u]=m.useState(!1),[o,x]=m.useState(!1),[h,l]=m.useState(!1),j=m.useMemo(()=>[...Array(30)].map(()=>({left:`${Math.random()*100}%`,top:`${Math.random()*100}%`,duration:2+Math.random()*2,delay:Math.random()*2})),[]),T=t.trim().length>=2&&i&&p,O=()=>{T&&a(t.trim())};return e.jsxs("div",{className:"min-h-screen relative overflow-hidden flex flex-col items-center justify-center px-6 pt-safe pb-safe-lg",children:[e.jsx("div",{className:"absolute inset-0 overflow-hidden",children:j.map((s,v)=>e.jsx(r.div,{className:"absolute w-1 h-1 bg-white rounded-full",style:{left:s.left,top:s.top},animate:{opacity:[.2,.8,.2],scale:[.5,1,.5]},transition:{duration:s.duration,repeat:1/0,delay:s.delay}},v))}),e.jsxs(r.div,{initial:{opacity:0},animate:{opacity:1},transition:{duration:1},className:"w-full max-w-md z-10",children:[e.jsx(r.div,{initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",delay:.3,duration:.8},className:"w-24 h-24 mx-auto mb-8 rounded-full bg-primary/20 flex items-center justify-center",children:e.jsx(W,{className:"w-12 h-12 text-primary"})}),e.jsxs(r.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},className:"text-center mb-8",children:[e.jsx("h1",{className:"text-4xl font-bold text-white mb-3",children:"Welcome, Traveler"}),e.jsx("p",{className:"text-white/70 text-lg",children:"A cosmic journey awaits those who dare to begin"})]}),e.jsxs(r.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.7},className:"bg-card/50 backdrop-blur-sm rounded-2xl p-6 border border-white/10 mb-6",children:[e.jsx("label",{className:"block text-white/80 text-sm mb-2",children:"What shall we call you?"}),e.jsx($e,{value:t,onChange:s=>n(s.target.value),placeholder:"Enter your name",className:"bg-background/50 border-white/20 text-white placeholder:text-white/40 text-lg py-6",maxLength:30})]}),e.jsxs(r.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.9},className:"mb-8 space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ae,{id:"age",checked:i,onCheckedChange:s=>c(s===!0),className:"mt-1"}),e.jsx("label",{htmlFor:"age",className:"text-white/70 text-sm leading-relaxed",children:"I confirm that I am 13 years of age or older"})]}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ae,{id:"legal",checked:p,onCheckedChange:s=>u(s===!0),className:"mt-1"}),e.jsxs("label",{htmlFor:"legal",className:"text-white/70 text-sm leading-relaxed",children:["I accept the"," ",e.jsx("button",{onClick:()=>x(!0),className:"text-primary underline hover:text-primary/80",children:"Terms of Service"}),","," ",e.jsx("button",{onClick:()=>l(!0),className:"text-primary underline hover:text-primary/80",children:"Privacy Policy"}),", and"," ",e.jsx("a",{href:"https://www.apple.com/legal/internet-services/itunes/dev/stdeula/",target:"_blank",rel:"noopener noreferrer",className:"text-primary underline hover:text-primary/80",children:"Apple's EULA"})]})]})]}),e.jsx(r.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:1.1},children:e.jsxs(B,{onClick:O,disabled:!T,className:"w-full py-6 text-lg font-semibold bg-primary hover:bg-primary/90",children:["Begin My Journey",e.jsx(ue,{className:"ml-2"})]})})]}),e.jsx(ie,{open:o,onOpenChange:x,documentType:"terms"}),e.jsx(ie,{open:h,onOpenChange:l,documentType:"privacy"})]})},H=["The stars have watched countless souls wander through the cosmos...","But few possess the spark to shape their own destiny.","You are different.","The universe has been waiting for you."],Qe=({userName:a,onComplete:t})=>{const[n,i]=m.useState(0),[c,p]=m.useState(!1),[u,o]=m.useState(!1),x=m.useMemo(()=>[...Array(6)].map(()=>({x:Math.random()*400-200,y:Math.random()*400-200,left:`${20+Math.random()*60}%`,top:`${30+Math.random()*40}%`,duration:4+Math.random()*2})),[]);return m.useEffect(()=>{if(n<H.length){const h=setTimeout(()=>{i(l=>l+1)},2500);return()=>clearTimeout(h)}else{const h=setTimeout(()=>{p(!0)},800);return()=>clearTimeout(h)}},[n]),m.useEffect(()=>{if(c){const h=setTimeout(()=>{o(!0)},2e3);return()=>clearTimeout(h)}},[c]),e.jsxs("div",{className:"min-h-screen flex flex-col items-center justify-center px-6 pt-safe-top safe-area-bottom relative",children:[e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:e.jsx("div",{className:"w-[500px] h-[500px] bg-primary/10 rounded-full blur-[120px] animate-pulse"})}),e.jsxs("div",{className:"relative z-10 max-w-lg text-center space-y-8",children:[e.jsxs("div",{className:"min-h-[200px] flex flex-col items-center justify-center space-y-6",children:[e.jsx(q,{mode:"wait",children:H.map((h,l)=>l===n-1&&l<H.length&&e.jsx(r.p,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.8},className:"text-lg md:text-xl text-muted-foreground italic leading-relaxed",children:h},l))}),e.jsx(q,{children:c&&e.jsxs(r.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{duration:1,ease:"easeOut"},className:"space-y-4",children:[e.jsxs(r.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},className:"flex items-center justify-center gap-2 text-primary",children:[e.jsx(W,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm uppercase tracking-[0.3em] font-medium",children:"Your Path Awaits"}),e.jsx(W,{className:"h-5 w-5"})]}),e.jsxs(r.h1,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.6},className:"text-3xl md:text-4xl font-bold text-foreground",children:["Welcome, ",e.jsx("span",{className:"text-primary",children:a})]}),e.jsxs(r.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.9},className:"text-muted-foreground text-lg",children:["Every legend begins with a choice.",e.jsx("br",{}),e.jsx("span",{className:"text-foreground/80",children:"Choose your allegiance."})]})]})})]}),e.jsx(q,{children:u&&e.jsx(r.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},children:e.jsx(B,{onClick:t,size:"lg",className:"px-8 py-6 text-lg bg-primary hover:bg-primary/90",children:"Choose My Faction"})})})]}),x.map((h,l)=>e.jsx(r.div,{className:"absolute w-1 h-1 bg-primary/40 rounded-full",initial:{x:h.x,y:h.y,opacity:0},animate:{y:[null,-100],opacity:[0,.8,0]},transition:{duration:h.duration,repeat:1/0,delay:l*.8},style:{left:h.left,top:h.top}},l))]})},Je=({onComplete:a})=>{const[t,n]=m.useState(null),i=o=>{n(o)},c=()=>{n(null)},p=o=>{a(o)},u=t?ne.find(o=>o.id===t):null;return e.jsxs("div",{className:"min-h-screen relative overflow-hidden flex flex-col bg-background",children:[e.jsx("header",{className:"sticky top-0 z-20 bg-background pt-safe-top",children:e.jsxs(r.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"text-center px-6 py-6",children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground mb-1",children:"Choose Your Path"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Your faction shapes your cosmic journey"})]})}),e.jsx("div",{className:"flex-1 px-4 pb-6 flex flex-col gap-3",children:ne.map((o,x)=>e.jsxs(r.button,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:x*.1},onClick:()=>i(o.id),className:"relative flex-1 min-h-[140px] rounded-2xl overflow-hidden group",children:[e.jsx("img",{src:o.image,alt:o.name,className:"absolute inset-0 w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/70 via-black/20 to-transparent"}),e.jsx("div",{className:"absolute inset-0 flex items-end p-5",children:e.jsx("h2",{className:"text-2xl text-white",style:o.nameStyle,children:o.name})})]},o.id))}),e.jsx(q,{children:u&&e.jsxs(r.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.4},className:"fixed inset-0 z-50 flex flex-col",children:[e.jsxs(r.div,{initial:{scale:1.1},animate:{scale:1},exit:{scale:1.1,opacity:0},transition:{duration:.5},className:"absolute inset-0",children:[e.jsx("img",{src:u.image,alt:u.name,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/95 via-black/40 to-transparent"})]}),e.jsxs(r.button,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.2},onClick:c,className:"absolute left-4 flex items-center gap-2 px-4 py-2 rounded-full bg-black/40 backdrop-blur-sm text-white hover:bg-black/60 transition-colors z-10",style:{top:"calc(env(safe-area-inset-top, 0px) + 16px)"},children:[e.jsx(Te,{size:20}),e.jsx("span",{className:"text-sm font-medium",children:"Back"})]}),e.jsx("div",{className:"relative flex-1 overflow-y-auto pt-safe-top",children:e.jsx("div",{className:"min-h-full flex flex-col justify-end px-6 pb-safe-lg pt-20",children:e.jsxs(r.div,{initial:{y:40,opacity:0},animate:{y:0,opacity:1},transition:{delay:.15,duration:.4},className:"space-y-5",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg",style:{backgroundColor:`${u.color}30`},children:e.jsx(u.icon,{size:24,style:{color:u.color}})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl text-white",style:u.nameStyle,children:u.name}),e.jsx("p",{className:"text-white/70 text-sm",children:u.subtitle})]})]}),e.jsx(r.p,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},className:"text-white/85 text-base leading-relaxed",children:u.description}),e.jsx(r.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.25},className:"bg-black/40 backdrop-blur-sm rounded-xl p-4 border-l-2",style:{borderColor:u.color},children:e.jsxs("p",{className:"text-white italic text-lg",children:['"',u.motto,'"']})}),e.jsxs(r.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.3},children:[e.jsx("h3",{className:"text-white/60 text-xs uppercase tracking-wider mb-2",children:"Traits"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:u.traits.map((o,x)=>e.jsx("span",{className:"px-3 py-1 rounded-full text-sm text-white/90 bg-white/10 backdrop-blur-sm",children:o},x))})]}),e.jsx(r.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.5},className:"pt-2",children:e.jsxs(B,{onClick:()=>p(u.id),className:"w-full py-6 text-lg font-semibold",style:{background:`linear-gradient(135deg, ${u.color}, ${u.color}80)`},children:["Join ",u.name,e.jsx(ue,{className:"ml-2"})]})})]})})})]})})]})},Ke=(a,t)=>{const n={starfall:["Before you chart your course, the cosmos asks one question...","As flames dance in the distance, your ship awaits its next destination...","The engines hum with potential energy. Your crew looks to you for direction...","Your path grows clearer with each choice..."],void:["In the stillness, a presence awaits. What form does it take?","In the silent depths between stars, clarity emerges from stillness...","The void speaks to those who listen. A whisper guides your path...","The shadows reveal what light cannot..."],stellar:["The stars align to reveal your guide. Who do you see among them?","Nebulas paint the cosmos in infinite colors. Each holds a dream...","Your companion gazes at the stars with wonder. What do you see?","The constellations align to show your way..."]};return n[a][t]||n[a][0]},U=[{id:"mentor_energy",narrative:"",question:"What kind of mentor energy resonates with you?",options:[{text:"Feminine presence",tags:["feminine_preference"]},{text:"Masculine presence",tags:["masculine_preference"]},{text:"Either works for me",tags:[]}]},{id:"focus_area",narrative:"",question:"What do you want to work on right now?",options:[{text:"Clarity & mindset",tags:["calm","discipline"]},{text:"Emotions & healing",tags:["healing","supportive"]},{text:"Discipline & performance",tags:["discipline","momentum"]},{text:"Confidence & self-belief",tags:["confidence","supportive"]}]},{id:"guidance_tone",narrative:"",question:"How do you want guidance to feel?",options:[{text:"Gentle & compassionate",tags:["healing","calm"]},{text:"Encouraging & supportive",tags:["supportive","confidence"]},{text:"Calm & grounded",tags:["calm","discipline"]},{text:"Direct & demanding",tags:["discipline","momentum"]}]},{id:"progress_style",narrative:"",question:"What helps you make progress?",options:[{text:"Clear principles and logic",tags:["calm","discipline"]},{text:"Emotional reassurance",tags:["supportive","healing"]},{text:"Someone who believes in me",tags:["confidence","supportive"]},{text:"Pressure and high standards",tags:["discipline","momentum"]}]}],Ve=({faction:a,onComplete:t})=>{const[n,i]=m.useState(0),[c,p]=m.useState([]),u=m.useMemo(()=>[...Array(30)].map(()=>({left:`${Math.random()*100}%`,top:`${Math.random()*100}%`,duration:2+Math.random()*2,delay:Math.random()*2})),[]),o=U[n],x=(n+1)/U.length*100,l={starfall:"#FF6600",void:"#7F26D9",stellar:"#3DB8F5"}[a],j=n>0,T=s=>{const v={questionId:o.id,answer:s.text,tags:s.tags},D=[...c,v];p(D),n<U.length-1?i(n+1):t(D)},O=()=>{j&&(p(s=>s.slice(0,-1)),i(s=>Math.max(0,s-1)))};return e.jsxs("div",{className:"min-h-screen relative overflow-hidden flex flex-col px-6 pb-safe-lg pt-safe-top",children:[e.jsx("div",{className:"absolute inset-0 overflow-hidden",children:u.map((s,v)=>e.jsx(r.div,{className:"absolute w-1 h-1 bg-white rounded-full",style:{left:s.left,top:s.top},animate:{opacity:[.2,.8,.2]},transition:{duration:s.duration,repeat:1/0,delay:s.delay}},v))}),e.jsxs(r.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"mb-8 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between text-white/70 text-xs uppercase tracking-wide mb-4 gap-3",children:[e.jsxs(B,{type:"button",variant:"ghost",size:"sm",onClick:O,disabled:!j,className:"gap-2 text-white/80 hover:text-white disabled:opacity-40 disabled:hover:text-white/70 border border-white/10 rounded-full px-3 py-1 bg-black/30 backdrop-blur-sm",children:[e.jsx(Ie,{className:"h-4 w-4"}),"Back"]}),e.jsx("span",{className:"flex-1"}),e.jsxs("span",{className:"text-sm font-medium tabular-nums min-w-[72px] text-right",children:[n+1," of ",U.length]})]}),e.jsx(Fe,{value:x,className:"h-2"})]}),e.jsx("div",{className:"flex-1 flex flex-col justify-center items-center z-10",children:e.jsx(q,{mode:"wait",children:e.jsxs(r.div,{initial:{opacity:0,x:50},animate:{opacity:1,x:0},exit:{opacity:0,x:-50},transition:{duration:.3},className:"w-full max-w-2xl",children:[e.jsx(r.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.2},className:"text-white/60 text-sm italic mb-5 text-center leading-relaxed px-2",children:Ke(a,n)}),e.jsx(r.h2,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.3},className:"text-xl sm:text-2xl font-bold text-white text-center mb-8 sm:mb-10 leading-tight sm:leading-snug px-4",children:o.question}),e.jsx("div",{className:"space-y-4 w-full max-w-xl mx-auto",children:o.options.map((s,v)=>e.jsx(r.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4+v*.1},children:e.jsxs(B,{variant:"outline",onClick:()=>T(s),className:"w-full flex items-center text-left gap-4 sm:gap-5 min-h-[88px] py-5 px-5 text-white border border-white/15 rounded-2xl hover:border-white/40 bg-black/30 backdrop-blur-xl hover:bg-black/40 transition-all shadow-[0_10px_40px_rgba(0,0,0,0.35)]",style:{"--hover-bg":`${l}20`},children:[e.jsx("span",{className:"w-11 h-11 rounded-full flex items-center justify-center text-base font-bold border border-white/20 bg-white/5 text-white tracking-wide",style:{boxShadow:`0 0 15px ${l}33`,color:l},children:String.fromCharCode(65+v)}),e.jsx("span",{className:"text-sm sm:text-base leading-relaxed whitespace-normal break-words flex-1",children:s.text})]})},s.text))})]},n)})})]})},se=["Reading the stars...","Aligning your cosmic path...","Finding your perfect guide...","The universe is revealing your mentor...","Calculating your destiny..."],Xe=()=>{const[a,t]=m.useState(0);return m.useEffect(()=>{const n=setInterval(()=>{t(i=>(i+1)%se.length)},2e3);return()=>clearInterval(n)},[]),e.jsxs("div",{className:"min-h-screen flex flex-col items-center justify-center px-6 pt-safe pb-safe-lg relative",children:[e.jsxs("div",{className:"relative w-48 h-48 mb-8",children:[[...Array(8)].map((n,i)=>e.jsx(r.div,{className:"absolute w-2 h-2 rounded-full bg-primary/80",style:{top:"50%",left:"50%"},animate:{x:Math.cos(i*Math.PI*2/8)*80,y:Math.sin(i*Math.PI*2/8)*80,scale:[1,1.5,1],opacity:[.5,1,.5]},transition:{duration:3,repeat:1/0,delay:i*.2,ease:"easeInOut"}},i)),e.jsx(r.div,{className:"absolute inset-0 flex items-center justify-center",animate:{scale:[1,1.1,1]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx("div",{className:"w-20 h-20 rounded-full bg-gradient-to-br from-primary/30 to-purple-500/30 flex items-center justify-center backdrop-blur-sm",children:e.jsx(r.div,{animate:{rotate:360},transition:{duration:8,repeat:1/0,ease:"linear"},children:e.jsx(W,{className:"w-10 h-10 text-primary"})})})}),e.jsx(r.div,{className:"absolute inset-0 rounded-full border-2 border-primary/20",animate:{rotate:360},transition:{duration:20,repeat:1/0,ease:"linear"}}),e.jsx(r.div,{className:"absolute inset-4 rounded-full border border-primary/10",animate:{rotate:-360},transition:{duration:15,repeat:1/0,ease:"linear"}})]}),e.jsx(r.p,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"text-lg text-foreground/80 text-center font-medium",children:se[a]},a),e.jsx("div",{className:"flex gap-2 mt-6",children:[0,1,2].map(n=>e.jsx(r.div,{className:"w-2 h-2 rounded-full bg-primary/50",animate:{scale:[1,1.3,1],opacity:[.5,1,.5]},transition:{duration:1,repeat:1/0,delay:n*.2}},n))})]})},Ze={prologue:{ringScale:.92,ringOpacity:.18,ringSpread:.16,hazeOpacity:.52,particleDensity:12,accentStrength:.2,centerMaskOpacity:.42,vignetteOpacity:.48},destiny:{ringScale:.98,ringOpacity:.24,ringSpread:.18,hazeOpacity:.58,particleDensity:14,accentStrength:.24,centerMaskOpacity:.38,vignetteOpacity:.5},questionnaire:{ringScale:1.02,ringOpacity:.23,ringSpread:.2,hazeOpacity:.56,particleDensity:13,accentStrength:.28,centerMaskOpacity:.36,vignetteOpacity:.48},calculating:{ringScale:1.16,ringOpacity:.34,ringSpread:.26,hazeOpacity:.62,particleDensity:16,accentStrength:.3,centerMaskOpacity:.34,vignetteOpacity:.52},"journey-begins":{ringScale:1.1,ringOpacity:.3,ringSpread:.22,hazeOpacity:.6,particleDensity:15,accentStrength:.28,centerMaskOpacity:.33,vignetteOpacity:.54}},et={starfall:"20 100% 58%",void:"272 78% 60%",stellar:"198 86% 62%"},tt={subtle:.72,balanced:1,high:1.25},at=(a,t,n)=>Math.max(t,Math.min(n,a)),it=a=>Ze[a],nt=a=>a?et[a]:null,st=({stage:a,faction:t=null,motionLevel:n="balanced"})=>{const i=it(a),{capabilities:c,signals:p}=qe(),u=nt(t),o=c.allowBackgroundAnimation&&!p.prefersReducedMotion&&!p.isBackgrounded,x=!o,h=o&&n!=="subtle",l=m.useMemo(()=>{const s=Math.round(i.particleDensity*tt[n]),v=Math.max(4,Math.floor(c.maxParticles*.45)),D=x?v:c.maxParticles;return at(s,4,D)},[c.maxParticles,x,n,i.particleDensity]),j=m.useMemo(()=>Array.from({length:l},(s,v)=>({id:v,x:Math.random()*100,y:Math.random()*100,size:Math.random()*1.8+.8,opacity:Math.random()*.45+.25,delay:Math.random()*4,duration:Math.random()*9+12,driftDistance:Math.random()*32+18})),[l,a]),T=m.useMemo(()=>Array.from({length:4},(s,v)=>{const D=1+i.ringSpread*v;return{id:v,size:(56+v*16)*i.ringScale*D,opacity:Math.max(.08,i.ringOpacity-v*.04),duration:16+v*4,delay:v*1.3}}),[i.ringOpacity,i.ringScale,i.ringSpread]),O=m.useMemo(()=>{if(u)return{"--onb-faction-accent":u,opacity:i.accentStrength}},[u,i.accentStrength]);return e.jsxs("div",{className:"onb-cosmic-backdrop absolute inset-0 z-0 overflow-hidden pointer-events-none","data-testid":"onb-cosmic-backdrop","data-stage":a,"data-reduced-motion":x,children:[e.jsx("div",{className:"absolute inset-0 onb-cosmic-base"}),e.jsx("div",{className:`absolute inset-0 onb-nebula-haze ${h?"onb-animate-nebula-drift onb-animated":""}`,style:{opacity:i.hazeOpacity}}),O&&e.jsx("div",{className:"absolute inset-0 onb-faction-tint","data-testid":"onb-faction-tint",style:O}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:T.map(s=>e.jsx("div",{className:`onb-cosmic-ring ${h?"onb-animate-ring-breathe onb-animated":""}`,style:{width:`${s.size}vmax`,height:`${s.size}vmax`,opacity:s.opacity,animationDuration:`${s.duration}s`,animationDelay:`${s.delay}s`}},`ring-${s.id}`))}),e.jsx("div",{className:"absolute inset-0",children:j.map(s=>e.jsx("div",{className:`onb-cosmic-particle ${h?"onb-animate-particle-float onb-animated":""}`,style:{left:`${s.x}%`,top:`${s.y}%`,width:`${s.size}px`,height:`${s.size}px`,opacity:s.opacity,animationDuration:`${s.duration}s`,animationDelay:`${s.delay}s`,"--onb-drift-distance":`${s.driftDistance}px`}},`particle-${s.id}`))}),e.jsx("div",{className:"absolute left-1/2 top-1/2 onb-readability-mask",style:{opacity:i.centerMaskOpacity}}),e.jsx("div",{className:"absolute inset-0 onb-vignette",style:{opacity:i.vignetteOpacity}})]})},re=["A bond has been forged across the cosmos...","Your companion stirs, awakening to your presence.","Together, you will write a story the stars themselves will remember.","Every quest completed, every habit built, every moment of growth...","...will shape both your destinies."],pe=3400,rt=pe,ot=3200,lt=({userName:a,companionAnimal:t,onComplete:n})=>{const[i,c]=m.useState(0),[p,u]=m.useState(!1),[o,x]=m.useState(!1),h=m.useMemo(()=>[...Array(12)].map(()=>({left:`${10+Math.random()*80}%`,top:`${50+Math.random()*40}%`,duration:5+Math.random()*3})),[]);return m.useEffect(()=>{if(i<re.length){const l=setTimeout(()=>{c(j=>j+1)},pe);return()=>clearTimeout(l)}else{const l=setTimeout(()=>{u(!0)},rt);return()=>clearTimeout(l)}},[i]),m.useEffect(()=>{if(p){const l=setTimeout(()=>{x(!0)},ot);return()=>clearTimeout(l)}},[p]),e.jsxs("div",{className:"min-h-screen flex flex-col items-center justify-center px-6 pt-safe-top safe-area-bottom relative overflow-hidden",children:[e.jsxs("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:[e.jsx(r.div,{className:"w-[400px] h-[400px] bg-primary/15 rounded-full blur-[100px]",animate:{scale:[1,1.2,1],opacity:[.3,.5,.3]},transition:{duration:4,repeat:1/0,ease:"easeInOut"}}),e.jsx(r.div,{className:"absolute w-[300px] h-[300px] bg-accent/10 rounded-full blur-[80px]",animate:{scale:[1.2,1,1.2],opacity:[.2,.4,.2]},transition:{duration:5,repeat:1/0,ease:"easeInOut"}})]}),e.jsxs("div",{className:"relative z-10 max-w-lg text-center space-y-8",children:[e.jsxs("div",{className:"min-h-[220px] flex flex-col items-center justify-center space-y-6",children:[e.jsx(q,{mode:"wait",children:!p&&re.map((l,j)=>j===i-1&&e.jsx(r.p,{initial:{opacity:0,y:20,filter:"blur(4px)"},animate:{opacity:1,y:0,filter:"blur(0px)"},exit:{opacity:0,y:-10,filter:"blur(2px)"},transition:{duration:.9},className:"text-lg md:text-xl text-white/80 italic leading-relaxed",children:l},j))}),e.jsx(q,{children:p&&e.jsxs(r.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{duration:1.2,ease:"easeOut"},className:"space-y-5",children:[e.jsxs(r.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{delay:.2},className:"flex items-center justify-center gap-3",children:[e.jsx(te,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-xs uppercase tracking-[0.4em] font-medium text-primary/80",children:"Your Journey Awaits"}),e.jsx(te,{className:"h-4 w-4 text-primary"})]}),e.jsx(r.h1,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5},className:"text-3xl md:text-4xl font-bold",children:e.jsxs("span",{className:"bg-gradient-to-r from-white via-primary-foreground to-white bg-clip-text text-transparent",children:[a," & ",t]})}),e.jsx(r.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.8},className:"text-white/60 text-base",children:"An unbreakable bond, a shared destiny."}),e.jsxs(r.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:1.2},className:"pt-2",children:[e.jsx("p",{className:"text-white/70 text-lg",children:"The cosmos holds infinite possibilities."}),e.jsx("p",{className:"text-white/50 text-sm mt-1",children:"Your first quest awaits..."})]})]})})]}),e.jsx(q,{children:o&&e.jsx(r.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.6},children:e.jsxs(B,{onClick:n,variant:"cta",size:"lg",className:"px-10 py-6 text-lg gap-2",children:[e.jsx(Ae,{className:"h-5 w-5"}),"Begin My Journey"]})})})]}),h.map((l,j)=>e.jsx(r.div,{className:"absolute w-1 h-1 bg-white/50 rounded-full",initial:{opacity:0},animate:{y:[0,-150],opacity:[0,.8,0],scale:[.5,1,.5]},transition:{duration:l.duration,repeat:1/0,delay:j*.6,ease:"easeOut"},style:{left:l.left,top:l.top}},j)),[...Array(4)].map((l,j)=>e.jsx(r.div,{className:"absolute",style:{left:"50%",top:"50%"},animate:{rotate:360},transition:{duration:15+j*5,repeat:1/0,ease:"linear"},children:e.jsx(W,{className:"text-primary/30",size:12+j*4,style:{transform:`translate(${80+j*40}px, 0)`}})},`orbit-${j}`))]})},ct=({mentor:a,explanation:t,compatibilityScore:n,onConfirm:i,onSeeAll:c,isConfirming:p=!1,seeAllLabel:u="See All Mentors"})=>e.jsx("div",{className:"min-h-screen flex items-center justify-center px-6 pt-safe pb-safe-lg relative z-10",children:e.jsxs("div",{className:"max-w-3xl w-full space-y-12 animate-fade-in",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"h-1 w-24 bg-royal-purple mx-auto animate-scale-in"}),e.jsx("h1",{className:"text-4xl md:text-5xl font-black text-pure-white uppercase tracking-tight",children:"We've Found Your Mentor"})]}),e.jsxs("div",{className:"bg-midnight border-2 border-charcoal rounded-2xl p-8 md:p-12 space-y-8",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(Be,{mentorSlug:a.slug,mentorName:a.name,primaryColor:a.primary_color,avatarUrl:a.avatar_url,size:"lg",showGlow:!0,className:"animate-scale-in"})}),e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("h2",{className:"text-4xl md:text-5xl font-black text-pure-white uppercase",children:a.name}),e.jsx("p",{className:"text-2xl font-bold text-royal-purple",children:t.subtitle})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"text-lg text-steel leading-relaxed text-center max-w-2xl mx-auto",children:t.paragraph}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsx("h3",{className:"text-sm font-bold text-royal-purple uppercase tracking-wide text-center",children:"How they'll help you"}),e.jsx("div",{className:"space-y-3",children:t.bullets.map((o,x)=>e.jsxs("div",{className:"flex items-start gap-3 p-4 bg-charcoal/50 rounded-lg border border-steel/20",children:[e.jsx("div",{className:"w-1.5 h-1.5 rounded-full mt-2 flex-shrink-0",style:{backgroundColor:a.primary_color}}),e.jsx("p",{className:"text-base text-pure-white",children:o})]},x))})]})]}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 pt-6",children:[e.jsx(B,{onClick:i,disabled:p,className:"flex-1 h-16 font-black uppercase tracking-wider bg-transparent border-2 border-royal-purple text-pure-white hover:bg-royal-purple/10 shadow-[0_0_20px_rgba(137,81,204,0.5)] hover:shadow-[0_0_30px_rgba(137,81,204,0.7)] transition-all duration-300",children:p?e.jsx(e.Fragment,{children:"Confirming..."}):e.jsxs(e.Fragment,{children:[e.jsx(Oe,{className:"mr-2 h-5 w-5"}),"Choose ",a.name," as My Mentor"]})}),e.jsxs(B,{variant:"outline",onClick:c,className:"md:w-56 h-16 border-steel/50 text-pure-white hover:bg-charcoal/50",children:[u,e.jsx(De,{className:"ml-2 h-5 w-5"})]})]})]})]})}),dt={atlas:["Brings clarity when life gets noisy","Keeps you grounded in principles, not impulses","Unlocks clear thinking even in emotional moments"],eli:["Reminds you of the strength you already have","Celebrates your progress, not just perfection","Fuels your confidence with steady encouragement"],sienna:["Honors your journey while moving you forward","Creates emotional safety while building strength","Validates your feelings and guides you gently"],stryker:["Maximizes your focus and execution","Treats your goals like an athlete treats competition","Elevates you toward peak performance daily"],carmen:["Pushes you to meet your full potential","Holds you accountable with fierce compassion","Builds your leadership and executive presence"],reign:["Demands peak performance in body and mind","Transforms you through relentless discipline","Elevates your physical and professional standards"],solace:["Celebrates your wins with genuine warmth","Builds your confidence through steady support","Reminds you of your strength when you forget"]},Q={discipline:"building discipline",performance:"peak performance",calm:"finding calm",mindfulness:"mental clarity",healer:"emotional healing",healing:"healing and recovery",supportive:"supportive growth",uplifting:"building confidence",confidence:"confidence building",momentum:"building momentum",tough_love:"direct, no-nonsense guidance",direct:"straightforward guidance",warm:"gentle, nurturing guidance",soft:"soft, compassionate guidance",stoic:"calm, thoughtful wisdom",high_energy:"high-energy motivation",intense:"intense energy",grounded:"grounded energy",spiritual:"spiritual guidance",intuition:"intuitive guidance",feminine_preference:"feminine mentor energy",masculine_preference:"masculine mentor energy"};function oe(a,t){const n=`Your Mentor is: ${a.name}`,i=a.short_title,c=t.focus_area||t.growth_focus||"",p=t.guidance_tone||t.guidance_style||"",u=t.mentor_energy||t.energy_preference||"";let o="";const x=a.tone_description?.toLowerCase()??"supportive",h=a.target_user?.toLowerCase(),l=Q[c]||c.replace(/_/g," "),j=Q[p]||p.replace(/_/g," ");if(c&&p){if(o=`You're focused on ${l} and prefer ${j}. ${a.name} is ${x}`,h?o+=` and is ideal for ${h}.`:o+=".",a.themes&&a.themes.length>0){const v=a.themes.slice(0,2).join(" and ");o+=` They'll support your growth in ${v} in a way that fits how you like to be guided.`}const s=Q[u];s&&(o+=` You also asked for ${s}.`)}else if(o=`${a.name} is ${x}${h?` and is best for ${h}`:""}.`,a.themes&&a.themes.length>0){const s=a.themes.slice(0,2).join(" and ");o+=` They specialize in ${s}.`}const T=a.short_title||a.name||"mentor",O=dt[a.slug]||[`Guides you with ${T.toLowerCase()}`,"Matches your communication style","Helps you reach your goals"];return{title:n,subtitle:i,paragraph:o,bullets:O}}const mt={discipline:"discipline",performance:"discipline",execution:"discipline",grind:"discipline",habits:"discipline",tough_love:"discipline",direct:"discipline",intense:"discipline",elite:"discipline",focus:"discipline",resilience:"discipline",strong:"discipline",calm:"calm",clarity:"calm",mindfulness:"calm",presence:"calm",grounded:"calm",neutral:"calm",stoic:"calm",inner_peace:"calm",anxiety_relief:"calm",healing:"healing",recovery:"healing",relationships:"healing",heartbreak:"healing",self_worth:"healing",self_compassion:"healing",soft:"healing",supportive:"supportive",warm:"supportive",gentle:"supportive",encouraging:"supportive",accessible:"supportive",feminine:"supportive",compassionate:"supportive",empathy:"supportive",confidence:"confidence",self_belief:"confidence",uplifting:"confidence",momentum:"momentum",drive:"momentum",high_energy:"momentum",energetic:"momentum",action:"momentum"},he=a=>{if(!a)return null;const t=a.toLowerCase().trim();return mt[t]??null},le=a=>{const t=new Set;return a.forEach(n=>{const i=he(n);i&&t.add(i)}),Array.from(t)},ce={atlas:["discipline","calm"],stryker:["momentum","discipline"],carmen:["discipline","confidence"],reign:["momentum","discipline"],eli:["confidence","supportive"],solace:["confidence","supportive"],sienna:["healing","calm"]},ut=a=>new Promise(t=>setTimeout(t,a));async function de(a){const{task:t,intervalMs:n,deadlineMs:i,isDone:c,onPollError:p}=a,u=Date.now(),x=c??(h=>h!=null);for(;Date.now()-u<i;){try{const l=await t();if(x(l))return l}catch(l){p?.(l)}const h=i-(Date.now()-u);if(h<=0)break;await ut(Math.min(n,h))}return null}const pt=new Set(["atlas","eli","stryker"]),ht=new Set(["sienna","carmen","reign","solace"]),yt=a=>{if(!a)return null;const t=a.toLowerCase().trim();return["masculine","male","masc"].includes(t)?"masculine":["feminine","female","fem"].includes(t)?"feminine":null},ye=a=>{const t=a.find(c=>c.questionId==="mentor_energy");if(!t?.tags?.length)return"no_preference";const n=t.tags.includes("feminine_preference"),i=t.tags.includes("masculine_preference");return i&&!n?"masculine":n&&!i?"feminine":"no_preference"},gt=a=>{const t=yt(a.gender_energy);if(t)return t;const n=(a.tags??[]).map(c=>c?.toLowerCase().trim());if(n.includes("masculine")||n.includes("male"))return"masculine";if(n.includes("feminine")||n.includes("female"))return"feminine";const i=a.slug?.toLowerCase().trim();return i&&pt.has(i)?"masculine":i&&ht.has(i)?"feminine":"unknown"},xt=(a,t)=>t==="no_preference"?{candidates:a}:{candidates:a.filter(i=>gt(i)===t)},ft=a=>{if(!a)return"medium";const t=a.toLowerCase();return t.includes("direct")&&t.includes("demanding")?"high":t.includes("gentle")&&t.includes("compassionate")||t.includes("calm")&&t.includes("grounded")?"gentle":(t.includes("encouraging")&&t.includes("supportive"),"medium")},bt=a=>a==="prologue"||a==="destiny"||a==="questionnaire"||a==="calculating"||a==="journey-begins"?a:null,wt=a=>{const t=a?.toLowerCase();return t?["gentle","soft","low"].includes(t)?"gentle":["high","strong","intense"].includes(t)?"high":"medium":"medium"},vt=a=>ft(a.trim()),jt=(a,t)=>{const n=ye(t),{candidates:i}=xt(a,n);return{energyPreference:n,mentorsForSelection:i}},me=3e4,Nt=3e3,Mt=2e3,_t=2e4,St=1e3,Ct=()=>{const a=ze(),{user:t}=Ye(),n=Pe(),{createCompanion:i}=Re(),[c,p]=m.useState("prologue"),[u,o]=m.useState("");m.useEffect(()=>{window.scrollTo({top:0,behavior:"smooth"})},[c]);const[x,h]=m.useState(null),[l,j]=m.useState([]),[T,O]=m.useState([]),[s,v]=m.useState(null),[D,J]=m.useState(null),[ge,K]=m.useState(""),[V,X]=m.useState(!1),[xe,fe]=m.useState(null),Z=bt(c),be=async d=>(await new Promise(y=>setTimeout(y,Mt)),de({deadlineMs:_t,intervalMs:St,task:async()=>{const{data:y,error:M}=await I.from("companion_evolution_cards").select("creature_name").eq("companion_id",d).order("evolution_stage",{ascending:!0}).limit(1).maybeSingle();if(M)throw M;return y?.creature_name??null},onPollError:y=>{A.warn("Companion display name poll failed",{companionId:d,error:y instanceof Error?y.message:String(y)})}}));m.useEffect(()=>{(async()=>{const{data:y}=await I.from("mentors").select("*").eq("is_active",!0);if(y){const M=y.map(f=>({id:f.id,name:f.name,description:f.description,tone_description:f.tone_description,avatar_url:f.avatar_url??void 0,tags:f.tags||[],mentor_type:f.mentor_type,target_user_type:f.target_user_type??void 0,slug:f.slug||"",short_title:f.short_title||"",primary_color:f.primary_color||"#7B68EE",target_user:f.target_user||"",themes:f.themes??void 0,intensity_level:f.intensity_level??void 0,gender_energy:f.gender_energy??null}));O(M)}})()},[]);const we=async d=>{if(o(d),t){const{data:y,error:M}=await I.from("profiles").select("onboarding_data").eq("id",t.id).maybeSingle();if(M){console.error("Failed to load profile before saving onboarding name:",M),$.error("We couldn't save your name right now. Please try again.");return}const f=y?.onboarding_data||{},{error:g}=await I.from("profiles").update({onboarding_data:{...f,userName:d}}).eq("id",t.id);if(g){console.error("Failed to save onboarding name:",g),$.error("We couldn't save your name right now. Please try again.");return}}p("destiny")},ve=()=>{p("faction")},je=async d=>{h(d),t&&await I.from("profiles").update({faction:d}).eq("id",t.id),p("questionnaire")},Ne=async d=>{j(d),p("calculating");const y=[1,1.5,1.3,1.1],M={};d.forEach((b,C)=>{const w=y[C]??1;b.tags.forEach(_=>{const L=he(_);L&&(M[L]=(M[L]??0)+w)})});const f=d.find(b=>b.questionId==="guidance_tone"),g=vt(f?.answer??""),{energyPreference:k,mentorsForSelection:E}=jt(T,d);if(k!=="no_preference"&&E.length===0){console.error(`[Onboarding] No mentors matched strict energy preference "${k}".`),$.error("No mentors matched your selected preference. Please review mentor setup."),p("mentor-grid");return}const z=E.map(b=>{const C=(()=>{const Y=le([...b.tags||[],...b.themes||[]]);return Y.length>0?Y:ce[b.slug]??[]})();let w=0,_=0;C.forEach(Y=>{const R=M[Y];R&&(w+=R,_+=1)});const G=wt(b.intensity_level)===g;return G&&(w+=.8),{mentor:b,score:w,exactMatches:_,intensityMatch:G}});z.sort((b,C)=>C.score-b.score);const P=z[0]?.score??0,S=z.filter(b=>b.score===P);let N=null;if(S.length===1)N=S[0].mentor;else if(S.length>1){const b=S.filter(C=>C.intensityMatch);if(b.length===1)N=b[0].mentor;else if(b.length>1){b.sort((_,L)=>L.exactMatches-_.exactMatches);const C=b[0].exactMatches,w=b.filter(_=>_.exactMatches===C);if(w.length===1)N=w[0].mentor;else{const _=Math.floor(Math.random()*w.length);N=w[_].mentor}}else{S.sort((_,L)=>L.exactMatches-_.exactMatches);const C=S[0].exactMatches,w=S.filter(_=>_.exactMatches===C);if(w.length===1)N=w[0].mentor;else{const _=Math.floor(Math.random()*w.length);N=w[_].mentor}}}if((!N||P===0)&&(N=E.find(b=>b.slug==="atlas")||E.find(b=>b.slug==="eli")||E[0]),N){v(N);const C=z.find(F=>F.mentor.id===N.id)?.score??0,w=ce[N.slug]??le([...N.tags||[],...N.themes||[]]),_=y.reduce((F,Ee)=>F+Ee,0),L=Math.max(w.length*(_/y.length)*2,4)+.8,G=Math.round(C/L*100),Y=Math.max(65,Math.min(99,G));fe(Y);const R={};d.forEach(F=>{R[F.questionId]=F.tags[0]||""});const ke=oe(N,R);if(J(ke),t)for(const F of d)await I.from("questionnaire_responses").upsert({user_id:t.id,question_id:F.questionId,answer_tags:F.tags},{onConflict:"user_id,question_id"});p("mentor-result");return}$.error("We couldn't automatically match a mentor. Please pick one from the grid."),p("mentor-grid")},ee=async(d,y)=>{if(t){const{data:M,error:f}=await I.from("profiles").select("onboarding_data").eq("id",t.id).maybeSingle();if(f){console.error("Failed to load profile before mentor confirmation:",f),$.error("We couldn't save your mentor selection right now. Please try again.");return}const g=M?.onboarding_data||{},k=y??D,E=ye(l),{error:z}=await I.from("profiles").update({selected_mentor_id:d.id,onboarding_data:{...g,mentorId:d.id,mentorName:d.name,mentorEnergyPreference:E,explanation:k?{title:k.title,subtitle:k.subtitle,paragraph:k.paragraph,bullets:k.bullets}:null}}).eq("id",t.id);if(z){console.error("Failed to save mentor selection:",z),$.error("We couldn't save your mentor selection right now. Please try again.");return}await n.refetchQueries({queryKey:["profile",t.id]})}p("companion")},Me=()=>{p("mentor-grid")},_e=async d=>{const y=T.find(g=>g.id===d);if(!y)return;v(y);const M={};l.forEach(g=>{M[g.questionId]=g.tags[0]||""});const f=oe(y,M);J(f),await ee(y,f)},Se=async d=>{if(!t||V)return;const y=Date.now();let M=!1;X(!0);const f=async(g,k,E)=>{if(M)return;M=!0;const{data:z,error:P}=await I.from("profiles").select("onboarding_data").eq("id",t.id).maybeSingle();if(P)throw P;const S=z?.onboarding_data||{},N=new Date().toISOString(),{error:b}=await I.from("profiles").update({onboarding_completed:!0,onboarding_data:{...S,walkthrough_completed:!0,story_tone:d.storyTone,guided_tutorial:{version:2,flowVersion:2,eligible:!0,completedSteps:[],xpAwardedSteps:[],dismissed:!1,completed:!1,lastUpdatedAt:N}}}).eq("id",t.id);if(b)throw b;await n.refetchQueries({queryKey:["profile",t.id]}),await n.refetchQueries({queryKey:["companion",t.id]});const C=new Date().toISOString().split("T")[0];I.from("companion_memories").insert({user_id:t.id,companion_id:g,memory_type:"first_meeting",memory_date:C,memory_context:{title:"Our First Meeting",description:`The day we met - a ${d.spiritAnimal} appeared and our journey began.`,emotion:"wonder",details:{spiritAnimal:d.spiritAnimal,coreElement:d.coreElement}},referenced_count:0}).then(({error:w})=>{w&&A.warn("Failed to create first meeting memory",{companionId:g,error:w.message})}),K(k),p("journey-begins"),A.info("Companion onboarding finalized",{userId:t.id,companionId:g,recoveredAfterTimeout:E,durationMs:Date.now()-y}),be(g).then(w=>{if(!w){A.warn("Companion display name not ready before deadline",{userId:t.id,companionId:g});return}K(w),A.info("Companion display name hydrated",{userId:t.id,companionId:g})}).catch(w=>{A.warn("Companion display name hydration failed",{userId:t.id,companionId:g,error:w instanceof Error?w.message:String(w)})})};try{A.info("Companion creation started from onboarding",{userId:t.id,spiritAnimal:d.spiritAnimal});const g=await i.mutateAsync({favoriteColor:d.favoriteColor,spiritAnimal:d.spiritAnimal,coreElement:d.coreElement,storyTone:d.storyTone});if(!g?.id)throw new Error("Companion record missing ID after creation.");await f(g.id,d.spiritAnimal,!1)}catch(g){const k=g instanceof Error?g.message:String(g),E=k.toUpperCase();if(E.includes("GENERATION_TIMEOUT")||E.includes("AI_TIMEOUT")||E.includes("TIMED OUT")){A.warn("Companion creation timed out; starting recovery poll",{userId:t.id,reason:k,elapsedMs:Date.now()-y});const P=await de({deadlineMs:me,intervalMs:Nt,task:async()=>{const{data:S,error:N}=await I.from("user_companion").select("id, spirit_animal").eq("user_id",t.id).maybeSingle();if(N)throw N;return S?.id?{id:S.id,spirit_animal:S.spirit_animal??null}:null},onPollError:S=>{A.warn("Companion recovery poll attempt failed",{userId:t.id,error:S instanceof Error?S.message:String(S)})}});if(P?.id){A.warn("Companion recovery succeeded after timeout",{userId:t.id,companionId:P.id,elapsedMs:Date.now()-y}),$.success("Your companion finished taking shape. Continuing your journey..."),await f(P.id,P.spirit_animal||d.spiritAnimal,!0);return}A.error("Companion recovery failed after timeout",{userId:t.id,recoveryWindowMs:me,elapsedMs:Date.now()-y}),$.error("This is taking longer than expected. Tap Begin Your Journey to try again.");return}A.error("Error creating companion during onboarding",{userId:t.id,elapsedMs:Date.now()-y,error:g instanceof Error?g.message:String(g)}),$.error("Something went wrong. Please try again.")}finally{X(!1)}},Ce=()=>{$.success("Welcome to Cosmiq! Your journey begins."),Le(a,"/journeys")};return e.jsxs("div",{className:"min-h-screen relative overflow-hidden bg-background",children:[e.jsx(We,{}),Z&&e.jsx(st,{stage:Z,faction:x,motionLevel:"balanced"}),e.jsxs(q,{mode:"wait",children:[c==="prologue"&&e.jsx(r.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"relative z-10",children:e.jsx(He,{onComplete:we})},"prologue"),c==="destiny"&&e.jsx(r.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"relative z-10",children:e.jsx(Qe,{userName:u,onComplete:ve})},"destiny"),c==="faction"&&e.jsx(r.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"relative z-10",children:e.jsx(Je,{onComplete:je})},"faction"),c==="questionnaire"&&x&&e.jsx(r.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"relative z-10",children:e.jsx(Ve,{faction:x,onComplete:Ne})},"questionnaire"),c==="calculating"&&e.jsx(r.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"relative z-10",children:e.jsx(Xe,{})},"calculating"),c==="mentor-result"&&s&&D&&e.jsx(r.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"relative z-10",children:e.jsx(ct,{mentor:s,explanation:D,compatibilityScore:xe,onConfirm:()=>ee(s),onSeeAll:Me,seeAllLabel:"See All Mentors"})},"mentor-result"),c==="mentor-grid"&&e.jsxs(r.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"relative z-10 min-h-screen flex flex-col p-6 pt-safe-lg",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("h1",{className:"text-2xl font-bold text-foreground mb-2",children:"Choose Your Mentor"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Select the guide who resonates with you"})]}),e.jsx(Ue,{mentors:T.map(d=>({...d,archetype:d.mentor_type,style_description:d.tone_description,signature_line:d.description,themes:d.themes||[]})),onSelectMentor:_e,recommendedMentorId:s?.id})]},"mentor-grid"),c==="companion"&&x&&e.jsx(r.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"relative z-10 w-full",children:e.jsx(Ge,{onComplete:Se,isLoading:V})},"companion"),c==="journey-begins"&&e.jsx(r.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"relative z-10 w-full",children:e.jsx(lt,{userName:u,companionAnimal:ge,onComplete:Ce})},"journey-begins")]})]})};function zt(){return e.jsx(Ct,{})}export{zt as default};
