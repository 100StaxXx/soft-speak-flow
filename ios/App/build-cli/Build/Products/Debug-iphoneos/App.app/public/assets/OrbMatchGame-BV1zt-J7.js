import{r,j as a,l as ue,m as O}from"./vendor-FfY6MM0Z.js";import{bo as q,bp as Ut,bq as Yt,br as zt}from"./index-sX_cJ3I4.js";import{t as R}from"./gameUtils-G90wW1BE.js";import"./date-vendor-Bk4KiHsJ.js";import"./three-vendor-qI8GXUTd.js";const Qe=30,Xt=8,Y=(o,t,l)=>t<0||t>=o.length||l<0||l>=(o[0]?.length??0)?null:o[t][l],Ht=(o,t,l,n)=>{const m=Y(o,t,l-1),x=Y(o,t,l-2),g=Y(o,t,l+1),j=Y(o,t,l+2),S=Y(o,t-1,l),y=Y(o,t-2,l),$=Y(o,t+1,l),E=Y(o,t+2,l);return m===n&&x===n||m===n&&g===n||g===n&&j===n||(S===n&&y===n||S===n&&$===n||$===n&&E===n)},Je=({grid:o,row:t,col:l,availableColors:n,strategy:m,random:x=Math.random})=>{if(n.length===0)throw new Error("pickSpawnColor requires at least one available color");const g=n.filter(y=>!Ht(o,t,l,y)),j=g.length>0?g:n,S=Math.floor(x()*j.length);return j[S]},Ke=o=>{const t=new Set,l=o.length,n=o[0]?.length??0;for(let m=0;m<l;m++){let x=0;for(;x<n;){const g=o[m][x];if(!g){x++;continue}let j=1;for(;x+j<n&&o[m][x+j]===g;)j++;if(j>=3)for(let S=0;S<j;S++)t.add(`${m},${x+S}`);x+=Math.max(1,j)}}for(let m=0;m<n;m++){let x=0;for(;x<l;){const g=o[x][m];if(!g){x++;continue}let j=1;for(;x+j<l&&o[x+j][m]===g;)j++;if(j>=3)for(let S=0;S<j;S++)t.add(`${x+S},${m}`);x+=Math.max(1,j)}}return t.size},je=o=>Ke(o)>0,He=o=>o.map(t=>[...t]),Ft=o=>{const t=o.length,l=o[0]?.length??0;for(let n=0;n<t;n++)for(let m=0;m<l;m++){const x=o[n][m];if(x){if(m+1<l&&o[n][m+1]){const g=He(o),j=g[n][m+1];if(g[n][m]=j,g[n][m+1]=x,je(g))return!0}if(n+1<t&&o[n+1][m]){const g=He(o),j=g[n+1][m];if(g[n][m]=j,g[n+1][m]=x,je(g))return!0}}}return!1},Fe=(o,t,l,n)=>{const m=Array.from({length:o},()=>Array(t).fill(null));for(let x=0;x<o;x++)for(let g=0;g<t;g++)m[x][g]=Je({grid:m,row:x,col:g,availableColors:l,strategy:"initial",random:n});return m},Vt=({rows:o,cols:t,availableColors:l,maxAttempts:n=Qe,random:m=Math.random})=>{if(l.length===0)throw new Error("generateInitialColorGrid requires at least one color");let x=null,g=Number.NEGATIVE_INFINITY;for(let j=0;j<n;j++){const S=Fe(o,t,l,m),y=je(S),$=Ft(S);if(!y&&$)return S;const E=($?1e3:0)-Ke(S);E>g&&(g=E,x=S)}return x??Fe(o,t,l,m)},Ve={normal:0,line_bomb:1,cross_bomb:2,star:3,cosmic_nova:0},Wt=o=>{const t=new Map;for(const l of o){const n=`${l.row},${l.col}`,m=t.get(n);(!m||Ve[l.type]>Ve[m.type])&&t.set(n,l)}return Array.from(t.values())},qt=async({maxSteps:o,getStep:t,onStep:l})=>{let n=0,m=t();for(;m&&n<o;)n+=1,await l(n,m),m=t();return{stepsProcessed:n,hitLimit:n===o&&m!==null,pendingStep:m}},Qt={beginner:{targetMod:.5,timeMod:1.5},easy:{targetMod:.7,timeMod:1.3},medium:{targetMod:1,timeMod:1},hard:{targetMod:1.4,timeMod:.85},master:{targetMod:2,timeMod:.7}},We=(o,t)=>{const l=500+(o-1)*300,n=Math.max(30,60-(o-1)*2.5),m=Math.min(6,4+Math.floor(o/4)),x=Math.max(4,10-Math.floor(o/3)),g=Math.min(.3,o*.02);return{targetScore:Math.round(l*t.targetMod),timeLimit:Math.round(n*t.timeMod),colors:m,moveTime:x,specialSpawnBonus:g}},C=5,N=6,qe=o=>{for(let t=0;t<C;t++)for(let l=0;l<N-2;l++){const n=o[t][l],m=o[t][l+1],x=o[t][l+2];if(n&&m&&x&&n.color===m.color&&m.color===x.color)return!0}for(let t=0;t<N;t++)for(let l=0;l<C-2;l++){const n=o[l][t],m=o[l+1][t],x=o[l+2][t];if(n&&m&&x&&n.color===m.color&&m.color===x.color)return!0}return!1},Ze={fire:"â—",water:"â—†",earth:"â– ",light:"â˜…",dark:"â–²",cosmic:"âœ¦"},me={fire:{gradient:"linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #ff4757 100%)",glow:"rgba(255, 107, 107, 0.6)",inner:"rgba(255, 200, 150, 0.4)",emoji:"ðŸ”¥"},water:{gradient:"linear-gradient(135deg, #4facfe 0%, #00cec9 50%, #0984e3 100%)",glow:"rgba(79, 172, 254, 0.6)",inner:"rgba(200, 240, 255, 0.4)",emoji:"ðŸ’§"},earth:{gradient:"linear-gradient(135deg, #00b894 0%, #55a630 50%, #2d6a4f 100%)",glow:"rgba(0, 184, 148, 0.6)",inner:"rgba(200, 255, 220, 0.4)",emoji:"ðŸŒ¿"},light:{gradient:"linear-gradient(135deg, #ffd93d 0%, #ff9f1c 50%, #f9a825 100%)",glow:"rgba(255, 217, 61, 0.6)",inner:"rgba(255, 255, 220, 0.5)",emoji:"âœ¨"},dark:{gradient:"linear-gradient(135deg, #a855f7 0%, #7c3aed 50%, #6366f1 100%)",glow:"rgba(168, 85, 247, 0.6)",inner:"rgba(220, 200, 255, 0.4)",emoji:"ðŸŒ™"},cosmic:{gradient:"linear-gradient(135deg, #f472b6 0%, #ec4899 50%, #e11d48 100%)",glow:"rgba(244, 114, 182, 0.6)",inner:"rgba(255, 200, 230, 0.4)",emoji:"ðŸ’«"}},et=r.memo(({intensity:o=.7})=>a.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[a.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 via-transparent to-cyan-500/5"}),a.jsx("div",{className:"stars-layer",style:{opacity:o}})]}));et.displayName="StarBackground";const tt=r.memo(({explosion:o,onComplete:t})=>(r.useEffect(()=>{const l=setTimeout(t,400);return()=>clearTimeout(l)},[t]),a.jsxs("div",{className:"absolute pointer-events-none z-50 explosion-effect",style:{left:o.x,top:o.y,"--explosion-color":o.color},children:[a.jsx("div",{className:"explosion-ring",style:{borderColor:o.color}}),a.jsxs("div",{className:"explosion-score",style:{color:o.color},children:["+",o.score]})]})));tt.displayName="MatchExplosionEffect";const ot=r.memo(({multiplier:o})=>a.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 pointer-events-none cascade-popup",children:a.jsxs("span",{className:"text-4xl font-black text-yellow-400 drop-shadow-glow",children:["x",o,"!"]})}));ot.displayName="CascadeMultiplier";const at=r.memo(({orbs:o,cellSize:t})=>a.jsx(a.Fragment,{children:o.map((l,n)=>a.jsx("div",{className:"absolute rounded-full pointer-events-none z-40 hint-pulse",style:{width:t-12,height:t-12,left:l.col*t+6,top:l.row*t+6}},n))}));at.displayName="HintIndicator";const st=r.memo(({progress:o,isComplete:t})=>{const n=2*Math.PI*18,m=n*(1-Math.min(1,o));return a.jsxs("svg",{className:"absolute -right-1 -top-1",width:"44",height:"44",viewBox:"0 0 44 44",children:[a.jsx("circle",{cx:"22",cy:"22",r:18,fill:"none",stroke:"rgba(255,255,255,0.1)",strokeWidth:"3"}),a.jsx("circle",{cx:"22",cy:"22",r:18,fill:"none",stroke:t?"#22c55e":"#a855f7",strokeWidth:"3",strokeLinecap:"round",strokeDasharray:n,strokeDashoffset:m,className:"transition-all duration-200",style:{transform:"rotate(-90deg)",transformOrigin:"center"}})]})});st.displayName="ScoreProgressRing";const rt=r.memo(()=>a.jsx("div",{className:"absolute inset-0 pointer-events-none z-30 rounded-2xl urgency-pulse"}));rt.displayName="UrgencyOverlay";const nt=r.memo(()=>a.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-50 pointer-events-none perfect-banner",children:a.jsx("div",{className:"px-8 py-4 rounded-2xl bg-yellow-500/20 border-2 border-yellow-500/60 shadow-glow-yellow",children:a.jsx("span",{className:"text-2xl font-black text-yellow-400 drop-shadow-glow",children:"â­ PERFECT! +50 â­"})})}));nt.displayName="PerfectGameBanner";const lt=r.memo(()=>a.jsxs("div",{className:"absolute inset-0 flex items-center justify-center z-50 bg-black/50 rounded-2xl",children:[a.jsx("span",{className:"text-4xl animate-spin",children:"ðŸ”€"}),a.jsx("span",{className:"ml-3 text-lg font-bold text-white",children:"Shuffling..."})]}));lt.displayName="ShuffleOverlay";const it=r.memo(({level:o,levelScore:t,timeBonus:l,totalScore:n,onContinue:m})=>(r.useEffect(()=>{const x=setTimeout(m,2500);return()=>clearTimeout(x)},[m]),a.jsx(O.div,{className:"absolute inset-0 flex flex-col items-center justify-center z-50 bg-black/70 rounded-2xl backdrop-blur-sm",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:a.jsxs(O.div,{initial:{scale:0,rotate:-10},animate:{scale:1,rotate:0},transition:{type:"spring",damping:15},className:"text-center",children:[a.jsx("div",{className:"text-4xl mb-2",children:"ðŸŽ‰"}),a.jsxs("h2",{className:"text-2xl font-black text-yellow-400 mb-1 drop-shadow-glow",children:["LEVEL ",o," COMPLETE!"]}),a.jsxs("div",{className:"space-y-1 text-sm",children:[a.jsxs("p",{className:"text-white/80",children:["Level Score: ",a.jsxs("span",{className:"text-green-400 font-bold",children:["+",t]})]}),a.jsxs("p",{className:"text-white/80",children:["Time Bonus: ",a.jsxs("span",{className:"text-cyan-400 font-bold",children:["+",l]})]}),a.jsxs("p",{className:"text-white/60 text-xs mt-2",children:["Total: ",a.jsx("span",{className:"text-purple-400 font-bold",children:n})]})]}),a.jsx(O.div,{className:"mt-4 px-4 py-2 bg-purple-500/30 rounded-full border border-purple-400/50",initial:{opacity:0},animate:{opacity:1},transition:{delay:1},children:a.jsx("span",{className:"text-sm text-purple-200",children:"Next level starting..."})})]})})));it.displayName="LevelCompleteOverlay";const ct=r.memo(({level:o,progress:t})=>a.jsx("div",{className:"absolute left-1 top-1 z-40",children:a.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 bg-black/60 rounded-full border border-purple-500/40 backdrop-blur-sm",children:[a.jsx("span",{className:"text-[10px] font-bold text-purple-400",children:"LVL"}),a.jsx("span",{className:"text-base font-black text-white",children:o}),a.jsx("div",{className:"w-10 h-1 bg-white/10 rounded-full overflow-hidden",children:a.jsx("div",{className:"h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-200",style:{width:`${Math.min(100,t*100)}%`}})})]})}));ct.displayName="LevelIndicator";const dt=r.memo(()=>a.jsx(O.div,{className:"absolute inset-0 flex items-center justify-center z-50 pointer-events-none",initial:{opacity:0,scale:.5},animate:{opacity:[0,1,1,0],scale:[.5,1.2,1,1]},transition:{duration:1,times:[0,.3,.7,1]},children:a.jsx("div",{className:"px-8 py-4 rounded-2xl bg-gradient-to-r from-purple-500/40 to-pink-500/40 border-2 border-purple-400/60 shadow-glow-purple",children:a.jsx("span",{className:"text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-pink-400",children:"â¬†ï¸ LEVEL UP! â¬†ï¸"})})}));dt.displayName="LevelUpBanner";const ut=r.memo(({effect:o,cellSize:t,onComplete:l})=>{r.useEffect(()=>{const m=setTimeout(l,400);return()=>clearTimeout(m)},[l]);const n=o.type==="beam_horizontal";return a.jsx(O.div,{className:"absolute z-50 pointer-events-none",initial:{opacity:0,scaleX:n?0:1,scaleY:n?1:0},animate:{opacity:1,scaleX:1,scaleY:1},exit:{opacity:0},style:{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.9), transparent)",height:n?6:t*C,width:n?t*N:6,top:n?o.row*t+t/2-3:0,left:n?0:o.col*t+t/2-3,boxShadow:"0 0 20px rgba(255,255,255,0.8), 0 0 40px rgba(168,85,247,0.6)"}})});ut.displayName="BeamEffect";const mt=r.memo(({effect:o,cellSize:t,onComplete:l})=>(r.useEffect(()=>{const n=setTimeout(l,500);return()=>clearTimeout(n)},[l]),a.jsxs(a.Fragment,{children:[a.jsx(O.div,{className:"absolute z-50 pointer-events-none",initial:{opacity:0,scaleX:0},animate:{opacity:1,scaleX:1},exit:{opacity:0},style:{background:"linear-gradient(90deg, transparent, rgba(255,215,0,0.9), transparent)",height:6,width:t*N,top:o.row*t+t/2-3,left:0,boxShadow:"0 0 20px rgba(255,215,0,0.8)"}}),a.jsx(O.div,{className:"absolute z-50 pointer-events-none",initial:{opacity:0,scaleY:0},animate:{opacity:1,scaleY:1},exit:{opacity:0},style:{background:"linear-gradient(180deg, transparent, rgba(255,215,0,0.9), transparent)",height:t*C,width:6,top:0,left:o.col*t+t/2-3,boxShadow:"0 0 20px rgba(255,215,0,0.8)"}})]})));mt.displayName="CrossBeamEffect";const pt=r.memo(({effect:o,cellSize:t,onComplete:l})=>(r.useEffect(()=>{const n=setTimeout(l,600);return()=>clearTimeout(n)},[l]),a.jsx(O.div,{className:"absolute z-50 pointer-events-none",initial:{scale:0,opacity:1},animate:{scale:4,opacity:0},transition:{duration:.6},style:{width:t,height:t,left:o.col*t,top:o.row*t,background:`radial-gradient(circle, ${o.color||"rgba(255,215,0,0.8)"}, transparent)`,borderRadius:"50%"}})));pt.displayName="ColorBurstEffect";const ft=r.memo(({effect:o,cellSize:t,onComplete:l})=>(r.useEffect(()=>{const n=setTimeout(l,700);return()=>clearTimeout(n)},[l]),a.jsxs(a.Fragment,{children:[a.jsx(O.div,{className:"absolute rounded-full z-50 pointer-events-none",initial:{scale:0,opacity:1},animate:{scale:5,opacity:0},transition:{duration:.7},style:{width:t*3,height:t*3,left:o.col*t-t,top:o.row*t-t,background:"radial-gradient(circle, rgba(255,255,255,0.9), rgba(168,85,247,0.6), rgba(236,72,153,0.4), transparent)"}}),[...Array(8)].map((n,m)=>a.jsx(O.div,{className:"absolute z-50 pointer-events-none",initial:{scale:0,opacity:1,x:0,y:0},animate:{scale:[0,1,.5],opacity:[1,.8,0],x:Math.cos(m*Math.PI/4)*t*2,y:Math.sin(m*Math.PI/4)*t*2},transition:{duration:.5},style:{width:12,height:12,borderRadius:"50%",background:"white",left:o.col*t+t/2-6,top:o.row*t+t/2-6,boxShadow:"0 0 10px rgba(255,255,255,0.8)"}},m))]})));ft.displayName="CosmicNovaEffect";const ht=r.memo(({orb:o,cellSize:t,isSelected:l,isInPath:n,isReverting:m,showAccessibility:x})=>{const g=me[o.color],j=t-8,y=(()=>{switch(o.special){case"line_bomb":return{border:"3px dashed rgba(255,255,255,0.9)",animation:"special-pulse 1s infinite",icon:"âž–"};case"star":return{border:"3px solid gold",animation:"special-rainbow 1.5s infinite",icon:"â˜…"};case"cross_bomb":return{border:"3px double rgba(255,215,0,0.9)",animation:"special-rotate 2s linear infinite",icon:"âœš"};case"cosmic_nova":return{border:"4px solid magenta",animation:"special-nova 0.8s infinite",icon:"âœ¦"};default:return{border:"2px solid rgba(255,255,255,0.25)",animation:void 0,icon:null}}})(),$=o.col*t+(t-j)/2,E=o.row*t+(t-j)/2,B=o.matched?0:l?1.15:n?1.08:1;return a.jsxs("div",{className:`absolute rounded-full flex items-center justify-center orb-base ${l?"z-30":n?"z-20":"z-10"} ${o.matched?"orb-matched":""} ${o.isNew?"orb-new":""} ${m?"orb-revert":""}`,style:{width:j,height:j,background:g.gradient,border:y.border,transform:`translate(${$}px, ${E}px) scale(${B})`,boxShadow:l||n?`0 8px 20px rgba(0,0,0,0.4), 0 0 15px ${g.glow}`:o.special!=="normal"?`0 4px 15px rgba(0,0,0,0.4), 0 0 20px ${g.glow}, 0 0 30px ${o.special==="cosmic_nova"?"rgba(236,72,153,0.5)":"rgba(255,215,0,0.3)"}`:`0 4px 10px rgba(0,0,0,0.3), 0 0 10px ${g.glow}`,animation:y.animation,"--start-y":`${-t*2}px`},children:[a.jsx("div",{className:"absolute rounded-full pointer-events-none",style:{width:"60%",height:"60%",top:"10%",left:"20%",background:`radial-gradient(circle at 30% 30%, ${g.inner}, transparent 70%)`}}),a.jsx("span",{className:"text-base select-none relative z-10 drop-shadow-sm",children:x?Ze[o.color]:g.emoji}),y.icon&&a.jsx("span",{className:"absolute -top-1 -right-1 text-xs bg-black/60 rounded-full w-4 h-4 flex items-center justify-center z-20",children:y.icon}),(l||n)&&a.jsx("div",{className:"absolute inset-[-3px] rounded-full pointer-events-none selection-ring",style:{borderColor:g.glow,boxShadow:`0 0 10px ${g.glow}`}})]})});ht.displayName="OrbComponent";const oo=({companionStats:o,onComplete:t,onDamage:l,tierAttackDamage:n,difficulty:m="medium",questIntervalScale:x=0,maxTimer:g,isPractice:j=!1,compact:S=!1})=>{const[y,$]=r.useState("countdown"),[E,B]=r.useState([]),[X,Z]=r.useState(null),[pe,ee]=r.useState([]),[H,fe]=r.useState(0),[P,Q]=r.useState(0),[A,Me]=r.useState(0),[he,xt]=r.useState(0),[G,gt]=r.useState(1),[D,bt]=r.useState(0),[wt,yt]=r.useState(0),[xe,vt]=r.useState(0),[jt,Ce]=r.useState(!1),[Mt,Ne]=r.useState(0),[ge,Ct]=r.useState(0),[Se,ke]=r.useState(0),[Nt,be]=r.useState(!1),[St,Te]=r.useState([]),[Ee,te]=r.useState(null),[we,$e]=r.useState(!1),[kt,Tt]=r.useState(!1),[Et,Le]=r.useState(new Set),[oe,$t]=r.useState(!1),[Lt,_e]=r.useState([]),ye=r.useRef(null),F=r.useRef(null),J=r.useRef(null),z=r.useRef(!1),U=r.useRef(E),ae=r.useRef(null);r.useEffect(()=>{U.current=E},[E]);const Ae=o.soul/100,se=Qt[m],T=r.useMemo(()=>{const e=We(G,se);return{...e,moveTime:Math.max(3,e.moveTime-x*.5+Ae*1.5)}},[G,se,x,Ae]),ve=g??T.timeLimit,K=r.useMemo(()=>["fire","water","earth","light","dark","cosmic"].slice(0,T.colors),[T.colors]),I=r.useMemo(()=>280/N,[]),re=r.useCallback(e=>{const c=Array(C).fill(null).map(()=>Array(N).fill(null));e.forEach(s=>{c[s.row][s.col]=s});for(let s=0;s<C;s++)for(let d=0;d<N;d++){const p=c[s][d];if(p){if(d<N-1&&c[s][d+1]){const f=c.map(u=>[...u]);if(f[s][d]=c[s][d+1],f[s][d+1]=p,qe(f))return[{row:s,col:d},{row:s,col:d+1}]}if(s<C-1&&c[s+1][d]){const f=c.map(u=>[...u]);if(f[s][d]=c[s+1][d],f[s+1][d]=p,qe(f))return[{row:s,col:d},{row:s+1,col:d}]}}}return null},[]),Ie=r.useCallback(()=>{$e(!0),R("medium"),l?.({target:"player",amount:n||15,source:"no_moves"}),setTimeout(()=>{B(e=>{const c=e.map(s=>s.color);for(let s=c.length-1;s>0;s--){const d=Math.floor(Math.random()*(s+1));[c[s],c[d]]=[c[d],c[s]]}return e.map((s,d)=>({...s,color:c[d]}))}),$e(!1)},600)},[l]),ne=r.useCallback(e=>{const s=Vt({rows:C,cols:N,availableColors:e||K,maxAttempts:Qe}),d=[];for(let p=0;p<C;p++)for(let f=0;f<N;f++)d.push({id:`${p}-${f}`,color:s[p][f],row:p,col:f,special:"normal"});B(d),U.current=d},[K]),Re=r.useCallback(()=>{ne(),Q(T.moveTime),Z(null),ee([]),te(null),z.current=!1},[ne,T.moveTime]),_t=r.useCallback(()=>{$("playing"),fe(ve),Re()},[ve,Re]),V=r.useCallback(()=>{te(null),J.current&&clearTimeout(J.current),J.current=setTimeout(()=>{const e=re(U.current);e&&(te(e),R("light"))},4e3)},[re]),Oe=r.useCallback((e,c,s)=>{switch(e.special){case"line_bomb":{const d=e.col%2===0,p=[];if(d)for(let f=0;f<N;f++){const u=c[e.row][f];u&&p.push(u.id)}else for(let f=0;f<C;f++){const u=c[f][e.col];u&&p.push(u.id)}return{affectedIds:p,bonusDamage:q.orb_match.specialActivation,effectType:d?"beam_horizontal":"beam_vertical"}}case"cross_bomb":{const d=[];for(let p=0;p<N;p++){const f=c[e.row][p];f&&d.push(f.id)}for(let p=0;p<C;p++){const f=c[p][e.col];f&&!d.includes(f.id)&&d.push(f.id)}return{affectedIds:d,bonusDamage:q.orb_match.specialActivation,effectType:"cross_beam"}}case"star":return{affectedIds:s.filter(p=>p.color===e.color).map(p=>p.id),bonusDamage:q.orb_match.specialActivation,effectType:"color_burst"};case"cosmic_nova":{const d=[];for(let p=Math.max(0,e.row-1);p<=Math.min(C-1,e.row+1);p++)for(let f=Math.max(0,e.col-1);f<=Math.min(N-1,e.col+1);f++){const u=c[p][f];u&&d.push(u.id)}return{affectedIds:d,bonusDamage:q.orb_match.specialActivation,effectType:"cosmic_nova"}}default:return null}},[]),Be=r.useCallback(e=>{const c=new Set,s=[],d=[],p=[],f=Array(C).fill(null).map(()=>Array(N).fill(null));e.forEach(i=>{f[i.row][i.col]=i});const u=new Map;for(let i=0;i<C;i++){let b=0;for(;b<N;){const h=f[i][b];if(!h){b++;continue}let v=1;for(;b+v<N&&f[i][b+v]?.color===h.color;)v++;if(v>=3){const k=[];for(let L=0;L<v;L++){const _=f[i][b+L];_&&(c.add(_.id),k.push(_.id),u.set(`${i}-${b+L}`,{row:i,col:b+L,color:h.color}))}const w=b+Math.floor(v/2);s.push({ids:k,size:v,color:h.color,centerRow:i,centerCol:w,isHorizontal:!0}),v===4?d.push({row:i,col:w,type:"line_bomb",color:h.color}):v>=5&&d.push({row:i,col:w,type:"cross_bomb",color:h.color})}b+=Math.max(1,v)}}for(let i=0;i<N;i++){let b=0;for(;b<C;){const h=f[b][i];if(!h){b++;continue}let v=1;for(;b+v<C&&f[b+v][i]?.color===h.color;)v++;if(v>=3){const k=[];for(let L=0;L<v;L++){const _=f[b+L][i];_&&!c.has(_.id)&&k.push(_.id),_&&(c.add(_.id),u.set(`${b+L}-${i}`,{row:b+L,col:i,color:h.color}))}const w=b+Math.floor(v/2);k.length>0&&s.push({ids:k,size:v,color:h.color,centerRow:w,centerCol:i,isHorizontal:!1}),v===4?d.push({row:w,col:i,type:"line_bomb",color:h.color}):v>=5&&d.push({row:w,col:i,type:"cross_bomb",color:h.color})}b+=Math.max(1,v)}}for(const[,i]of u){const b=u.has(`${i.row}-${i.col-1}`)&&u.get(`${i.row}-${i.col-1}`)?.color===i.color||u.has(`${i.row}-${i.col+1}`)&&u.get(`${i.row}-${i.col+1}`)?.color===i.color,h=u.has(`${i.row-1}-${i.col}`)&&u.get(`${i.row-1}-${i.col}`)?.color===i.color||u.has(`${i.row+1}-${i.col}`)&&u.get(`${i.row+1}-${i.col}`)?.color===i.color;if(b&&h&&!d.find(k=>k.row===i.row&&k.col===i.col&&k.type==="star")){const k=d.findIndex(w=>w.row===i.row&&w.col===i.col);k>=0?d[k]={row:i.row,col:i.col,type:"star",color:i.color}:d.push({row:i.row,col:i.col,type:"star",color:i.color})}}for(const i of c){const b=e.find(h=>h.id===i);if(b&&b.special&&b.special!=="normal"){const h=Oe(b,f,e);h&&(p.push({orb:b,...h}),h.affectedIds.forEach(v=>c.add(v)))}}const M=Array.from(c).map(i=>e.find(b=>b.id===i)).filter(i=>i&&i.special&&i.special!=="normal");if(M.length>=2){const i=M[0],b=[];for(const h of M)for(let v=Math.max(0,h.row-1);v<=Math.min(C-1,h.row+1);v++)for(let k=Math.max(0,h.col-1);k<=Math.min(N-1,h.col+1);k++){const w=f[v][k];w&&b.push(w.id)}p.push({orb:i,affectedIds:b,bonusDamage:q.orb_match.specialActivation,effectType:"cosmic_nova"}),b.forEach(h=>c.add(h))}return{matched:c,matchGroups:s,specialsToCreate:d,specialsActivated:p}},[Oe]),Pe=r.useCallback((e,c=[])=>{const s=Array(C).fill(null).map(()=>Array(N).fill(null));e.forEach(u=>{u.matched||(s[u.row][u.col]=u)});const d=s.map(u=>u.map(M=>M?.color??null)),p=new Map;c.forEach(u=>{const M=p.get(u.col)||[];M.push(u),p.set(u.col,M)});for(let u=0;u<N;u++){let M=C-1;for(let h=C-1;h>=0;h--)s[h][u]&&(h!==M&&(s[M][u]=s[h][u],s[h][u]=null),M--);const i=p.get(u)||[];let b=0;for(let h=M;h>=0;h--){const v=i[b],k=!!(v&&b<i.length),w=k?v.color:Je({grid:d,row:h,col:u,availableColors:K,strategy:"refill"});s[h][u]={id:`${h}-${u}-${Date.now()}-${Math.random()}`,color:w,row:h,col:u,special:k?v.type:"normal",isNew:!0},d[h][u]=w,k&&b++}}const f=[];for(let u=0;u<C;u++)for(let M=0;M<N;M++){const i=s[u][M];i&&f.push({...i,row:u,col:M})}return f},[K]),Ge=r.useCallback(e=>{R("error"),Le(new Set([e.orb1.id,e.orb2.id])),B(c=>c.map(s=>s.id===e.orb1.id?{...s,row:e.orb1.row,col:e.orb1.col}:s.id===e.orb2.id?{...s,row:e.orb2.row,col:e.orb2.col}:s)),setTimeout(()=>Le(new Set),200)},[]),De=r.useCallback(async e=>{let c=e,s=0,d=0;return(await qt({maxSteps:Xt,getStep:()=>{const u=Be(c);return u.matched.size>=3?u:null},onStep:async(u,M)=>{const{matched:i,matchGroups:b,specialsActivated:h}=M,v=Wt(M.specialsToCreate);s=u,ke(u),u>1&&(be(!0),setTimeout(()=>be(!1),500));for(const w of h){const L={id:`effect-${Date.now()}-${Math.random()}`,type:w.effectType,row:w.orb.row,col:w.orb.col,color:me[w.orb.color].glow};_e(_=>[..._,L]),l?.({target:"adversary",amount:w.bonusDamage,source:`special_${w.orb.special}`,isCritical:!0}),d+=w.bonusDamage*5,R("heavy")}const k=b.map(w=>{const L=w.size*10,_=1+(u-1)*.5,Xe=Math.round(L*_);return d+=Xe,{id:`exp-${Date.now()}-${Math.random()}`,x:w.centerCol*I+I/2,y:w.centerRow*I+I/2,color:me[w.color].glow,size:w.size,score:Xe}});Te(w=>[...w,...k]),c=c.map(w=>i.has(w.id)?{...w,matched:!0}:w),B([...c]),U.current=[...c],i.size>=5||h.length>0?R("heavy"):R("success"),await new Promise(w=>setTimeout(w,h.length>0?350:200)),c=Pe(c,v),B([...c]),U.current=[...c],await new Promise(w=>setTimeout(w,180))}})).hitLimit&&be(!1),s>0&&(Me(u=>u+d),Ne(u=>{const M=u+s;return Ct(i=>Math.max(i,M)),M}),Q(T.moveTime),V(),setTimeout(()=>{!re(U.current)&&y==="playing"&&Ie()},200)),ke(0),s},[Be,Pe,T.moveTime,I,V,re,y,Ie,l]),le=r.useCallback((e,c)=>{if(!ye.current)return null;const s=ye.current.getBoundingClientRect(),d=Math.floor((e-s.left)/(s.width/N)),p=Math.floor((c-s.top)/(s.height/C));return p>=0&&p<C&&d>=0&&d<N?{row:p,col:d}:null},[]),Ue=r.useCallback((e,c)=>{ae.current={orb1:{id:e.id,row:e.row,col:e.col},orb2:{id:c.id,row:c.row,col:c.col}},B(s=>{const d=s.map(p=>p.id===e.id?{...p,row:c.row,col:c.col}:p.id===c.id?{...p,row:e.row,col:e.col}:p);return U.current=d,d})},[]),ie=r.useCallback((e,c)=>{if(y!=="playing"||P<=0||we)return;const s=le(e,c);if(!s)return;const d=E.find(p=>p.row===s.row&&p.col===s.col);d&&(Z(d),ee([d.id]),z.current=!0,R("light"),te(null))},[y,P,we,le,E]),ce=r.useCallback((e,c)=>{if(!z.current||!X||y!=="playing")return;const s=le(e,c);if(!s)return;const d=E.find(u=>u.id===X.id);if(!d)return;const p=Math.abs(s.row-d.row),f=Math.abs(s.col-d.col);if(p===1&&f===0||p===0&&f===1){const u=E.find(M=>M.row===s.row&&M.col===s.col);u&&u.id!==X.id&&(Ue(d,u),ee(M=>[...M,u.id]),R("light"),Z({...d,row:s.row,col:s.col}))}},[X,y,le,E,Ue]),W=r.useCallback(async()=>{z.current&&(z.current=!1,pe.length>1&&(F.current&&(clearInterval(F.current),F.current=null),await De(U.current)===0&&ae.current&&Ge(ae.current),ae.current=null),Z(null),ee([]),V())},[pe,De,Ge,V]),At=r.useCallback(e=>ie(e.clientX,e.clientY),[ie]),It=r.useCallback(e=>ce(e.clientX,e.clientY),[ce]),Ye=r.useCallback(()=>W(),[W]),Rt=r.useCallback(e=>{e.preventDefault(),ie(e.touches[0].clientX,e.touches[0].clientY)},[ie]),Ot=r.useCallback(e=>{e.preventDefault(),ce(e.touches[0].clientX,e.touches[0].clientY)},[ce]),Bt=r.useCallback(e=>{e.preventDefault(),W()},[W]);r.useEffect(()=>{if(y==="playing"){if(P<=0&&!z.current){Q(T.moveTime);return}if(!(P<=0))return F.current=setInterval(()=>{Q(e=>e<=.15?(z.current&&W(),0):e-.15)},150),()=>{F.current&&clearInterval(F.current)}}},[y,P,W,T.moveTime]),r.useEffect(()=>{if(y!=="playing")return;const e=setInterval(()=>{fe(c=>c<=1?($("complete"),0):c-1)},1e3);return()=>clearInterval(e)},[y]),r.useEffect(()=>(y==="playing"&&V(),()=>{J.current&&clearTimeout(J.current)}),[y,V]),r.useEffect(()=>{if(y==="playing"&&A>=T.targetScore){const e=H*5,c=A+e;if(yt(A),vt(e),xt(s=>s+c),bt(s=>s+1),j){$("complete");return}l?.({target:"adversary",amount:q.orb_match.scoreTarget,source:"level_complete"}),R("heavy"),$("levelComplete")}},[A,T.targetScore,y,H,l,j]);const Pt=r.useCallback(()=>{const e=G+1;gt(e),Me(0),Ne(0),Ce(!0),setTimeout(()=>Ce(!1),1e3);const c=We(e,se),d=["fire","water","earth","light","dark","cosmic"].slice(0,c.colors);fe(g??c.timeLimit),ne(d),Q(c.moveTime),$("playing")},[G,se,ne,g]);r.useEffect(()=>{if(y==="complete"){const e=he+A,c=D>=1;D>=3&&(Tt(!0),R("heavy"));const s=Math.min(ge*2,15),d=D*5,p=Math.round(c?Math.min(100,50+d+s):Math.min(50,A/T.targetScore*50)),f=D>=5?"perfect":c?"good":"fail";setTimeout(()=>t({success:c,accuracy:p,result:f,highScoreValue:e,gameStats:{score:e,level:G,levelsCompleted:D,maxCombo:ge,time:H,timeBonus:xe}}),D>=3?1200:400)}},[y,A,he,D,G,T.targetScore,ge,H,xe,t]);const Gt=r.useCallback(e=>Te(c=>c.filter(s=>s.id!==e)),[]),de=r.useCallback(e=>_e(c=>c.filter(s=>s.id!==e)),[]),ze=A/T.targetScore,Dt=H<=5&&y==="playing";return a.jsxs("div",{className:"flex flex-col items-center relative flex-1 min-h-0",children:[y==="countdown"&&a.jsx(Ut,{count:3,onComplete:_t}),a.jsx(ue,{children:y==="paused"&&a.jsx(Yt,{onResume:()=>$("playing")})}),a.jsx(ue,{children:y==="levelComplete"&&a.jsx(it,{level:G,levelScore:wt,timeBonus:xe,totalScore:he,onContinue:Pt})}),a.jsx(zt,{title:`Starburst - Level ${G}`,subtitle:`Target: ${T.targetScore} pts`,timeLeft:H,totalTime:ve,combo:Mt,showCombo:!0,primaryStat:{value:A,label:`${A}/${T.targetScore}`,color:A>=T.targetScore?"#22c55e":"#a855f7"},secondaryStat:{value:D,label:`${D} cleared`,color:"#22d3ee"},isPaused:y==="paused",onPauseToggle:()=>$(y==="paused"?"playing":"paused"),compact:S}),a.jsxs("div",{className:"relative w-full max-w-xs mb-2",children:[a.jsx(ct,{level:G,progress:ze}),a.jsx("div",{className:"absolute right-0 top-0",children:a.jsx(st,{progress:ze,isComplete:A>=T.targetScore})}),y==="playing"&&a.jsxs("div",{className:"pt-8",children:[a.jsx("div",{className:"h-2 bg-muted rounded-full overflow-hidden",children:a.jsx("div",{className:`h-full transition-all duration-150 ${P<2?"animate-pulse":""}`,style:{width:`${P/T.moveTime*100}%`,background:P<2?"linear-gradient(90deg, #ef4444, #f87171)":"linear-gradient(90deg, hsl(var(--primary)), hsl(var(--accent)))"}})}),a.jsxs("p",{className:"text-xs text-center text-muted-foreground mt-1",children:["Move: ",P.toFixed(1),"s"]})]})]}),!S&&a.jsx("button",{className:"text-xs text-muted-foreground mb-2 underline",onClick:()=>$t(!oe),children:oe?"Show Emojis":"Show Shapes"}),a.jsxs("div",{ref:ye,className:"relative w-full max-w-xs rounded-2xl overflow-hidden cursor-pointer touch-none game-container",style:{aspectRatio:`${N}/${C}`,maxWidth:300},onMouseDown:At,onMouseMove:It,onMouseUp:Ye,onMouseLeave:Ye,onTouchStart:Rt,onTouchMove:Ot,onTouchEnd:Bt,children:[a.jsx(et,{}),a.jsx("div",{className:"absolute inset-0 pointer-events-none grid-lines"}),Ee&&a.jsx(at,{orbs:Ee,cellSize:I}),E.map(e=>a.jsx(ht,{orb:e,cellSize:I,isSelected:X?.id===e.id,isInPath:pe.includes(e.id),isReverting:Et.has(e.id),showAccessibility:oe},e.id)),St.map(e=>a.jsx(tt,{explosion:e,onComplete:()=>Gt(e.id)},e.id)),a.jsx(ue,{children:Lt.map(e=>{switch(e.type){case"beam_horizontal":case"beam_vertical":return a.jsx(ut,{effect:e,cellSize:I,onComplete:()=>de(e.id)},e.id);case"cross_beam":return a.jsx(mt,{effect:e,cellSize:I,onComplete:()=>de(e.id)},e.id);case"color_burst":return a.jsx(pt,{effect:e,cellSize:I,onComplete:()=>de(e.id)},e.id);case"cosmic_nova":return a.jsx(ft,{effect:e,cellSize:I,onComplete:()=>de(e.id)},e.id);default:return null}})}),Nt&&Se>1&&a.jsx(ot,{multiplier:Se}),Dt&&a.jsx(rt,{}),we&&a.jsx(lt,{}),kt&&a.jsx(nt,{}),a.jsx(ue,{children:jt&&a.jsx(dt,{})})]}),!S&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"flex flex-wrap justify-center gap-3 mt-4 text-xs",children:K.slice(0,4).map(e=>a.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full bg-white/5 border border-white/10",children:[a.jsx("span",{className:"text-sm",children:oe?Ze[e]:me[e].emoji}),a.jsx("span",{className:"capitalize text-white/60 font-medium",children:e})]},e))}),a.jsx("p",{className:"text-xs text-white/40 mt-3 text-center font-medium",children:"Match 4+ for specials â€¢ T/L shapes = â˜… Star â€¢ Match specials for big damage!"})]}),a.jsx("style",{children:`
        .orb-base {
          transition: transform 120ms ease-out, box-shadow 100ms ease-out;
          will-change: transform;
        }
        .orb-matched {
          animation: orb-pop 180ms ease-out forwards;
        }
        .orb-new {
          animation: orb-drop 200ms ease-out;
        }
        .orb-revert {
          animation: orb-shake 150ms ease-out;
        }
        @keyframes orb-pop {
          0% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.2); opacity: 0.8; }
          100% { transform: scale(0); opacity: 0; }
        }
        @keyframes orb-drop {
          0% { transform: translateY(var(--start-y, -80px)) scale(0.8); opacity: 0; }
          100% { opacity: 1; }
        }
        @keyframes orb-shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-4px); }
          75% { transform: translateX(4px); }
        }
        .selection-ring {
          border: 2px solid;
          animation: ring-pulse 400ms ease-in-out infinite;
        }
        @keyframes ring-pulse {
          0%, 100% { opacity: 0.6; }
          50% { opacity: 1; }
        }
        .hint-pulse {
          border: 3px solid rgba(255, 215, 0, 0.8);
          box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
          animation: hint-glow 800ms ease-in-out infinite;
        }
        @keyframes hint-glow {
          0%, 100% { transform: scale(1); opacity: 0.6; }
          50% { transform: scale(1.08); opacity: 1; }
        }
        .explosion-effect {
          transform: translate(-50%, -50%);
        }
        .explosion-ring {
          position: absolute;
          width: 50px; height: 50px;
          left: -25px; top: -25px;
          border: 3px solid;
          border-radius: 50%;
          animation: ring-expand 350ms ease-out forwards;
        }
        @keyframes ring-expand {
          0% { transform: scale(0); opacity: 1; }
          100% { transform: scale(2); opacity: 0; }
        }
        .explosion-score {
          position: absolute;
          font-size: 16px; font-weight: 800;
          text-shadow: 0 0 8px currentColor, 0 2px 4px rgba(0,0,0,0.5);
          animation: score-float 400ms ease-out forwards;
        }
        @keyframes score-float {
          0% { transform: translateY(0); opacity: 1; }
          100% { transform: translateY(-40px); opacity: 0; }
        }
        .cascade-popup {
          animation: cascade-pop 500ms ease-out forwards;
        }
        @keyframes cascade-pop {
          0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
          30% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        .urgency-pulse {
          box-shadow: inset 0 0 40px rgba(239, 68, 68, 0.4);
          border: 2px solid rgba(239, 68, 68, 0.5);
          animation: urgency 400ms ease-in-out infinite;
        }
        @keyframes urgency {
          0%, 100% { box-shadow: inset 0 0 40px rgba(239, 68, 68, 0.3); }
          50% { box-shadow: inset 0 0 60px rgba(239, 68, 68, 0.5); }
        }
        .perfect-banner {
          animation: banner-pop 300ms ease-out;
        }
        @keyframes banner-pop {
          0% { transform: scale(0) rotate(-10deg); opacity: 0; }
          100% { transform: scale(1) rotate(0); opacity: 1; }
        }
        .game-container {
          background: linear-gradient(145deg, rgba(0,0,0,0.85) 0%, rgba(15,15,35,0.95) 50%, rgba(25,15,45,0.9) 100%);
          border: 1px solid rgba(255,255,255,0.08);
          box-shadow: 0 20px 40px -12px rgba(0,0,0,0.6);
        }
        .grid-lines {
          background-image: 
            linear-gradient(to right, rgba(255,255,255,0.04) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(255,255,255,0.04) 1px, transparent 1px);
          background-size: calc(100% / 6) calc(100% / 5);
        }
        .stars-layer {
          position: absolute; inset: 0;
          background-image: radial-gradient(1px 1px at 10% 20%, white, transparent),
            radial-gradient(1px 1px at 30% 60%, white, transparent),
            radial-gradient(1px 1px at 50% 30%, white, transparent),
            radial-gradient(1px 1px at 70% 80%, white, transparent),
            radial-gradient(1px 1px at 90% 40%, white, transparent);
        }
        .drop-shadow-glow { text-shadow: 0 0 20px rgba(250,204,21,0.8); }
        .shadow-glow-yellow { box-shadow: 0 0 40px rgba(250,204,21,0.4); }
        .shadow-glow-purple { box-shadow: 0 0 40px rgba(168,85,247,0.4); }
        
        /* Special orb animations */
        @keyframes special-pulse {
          0%, 100% { box-shadow: 0 0 10px rgba(255,255,255,0.5); }
          50% { box-shadow: 0 0 25px rgba(255,255,255,0.9), 0 0 35px rgba(255,255,255,0.4); }
        }
        @keyframes special-rainbow {
          0% { border-color: gold; box-shadow: 0 0 15px gold; }
          33% { border-color: #ff6b6b; box-shadow: 0 0 15px #ff6b6b; }
          66% { border-color: #4facfe; box-shadow: 0 0 15px #4facfe; }
          100% { border-color: gold; box-shadow: 0 0 15px gold; }
        }
        @keyframes special-rotate {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        @keyframes special-nova {
          0%, 100% { box-shadow: 0 0 15px rgba(236,72,153,0.6), 0 0 30px rgba(168,85,247,0.3); }
          50% { box-shadow: 0 0 30px rgba(236,72,153,0.9), 0 0 50px rgba(168,85,247,0.6); }
        }
      `})]})};export{oo as OrbMatchGame};
