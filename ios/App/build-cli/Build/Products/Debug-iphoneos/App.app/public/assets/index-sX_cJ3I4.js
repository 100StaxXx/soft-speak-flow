const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/EnergyBeamGame-BmV2dlUs.js","assets/vendor-FfY6MM0Z.js","assets/date-vendor-Bk4KiHsJ.js","assets/three-vendor-qI8GXUTd.js","assets/gameUtils-G90wW1BE.js","assets/TapSequenceGame-Co8xL4xG.js","assets/AstralFrequencyGame-8lhy12jN.js","assets/EclipseTimingGame-DV4_nD0g.js","assets/StarfallDodgeGame-CLnaBcWv.js","assets/SoulSerpentGame-D3Kq0Ubq.js","assets/OrbMatchGame-BV1zt-J7.js","assets/GalacticMatchGame-sEezCMVN.js","assets/CompanionStoryJournal-CbCcUkaX.js","assets/CompanionPostcards-CszyoJhe.js","assets/useFirstTimeModal-Dpj86Jep.js","assets/NativeCalendarWeb-BdBzToYJ.js","assets/WidgetDataWeb-12a7qG7b.js","assets/Home-L-5X-wse.js","assets/Auth-CQfbnNNe.js","assets/nativeNavigation-DLS7qEr9.js","assets/authRedirect-CIQu5qTp.js","assets/redirectUrl-BW4uFyq_.js","assets/StaticBackgroundImage-CU98gu1x.js","assets/ResetPassword-BvgYC8R-.js","assets/Onboarding-k1NpOsP0.js","assets/CompanionPersonalization-nKWkjw34.js","assets/MentorGrid-BGn289sO.js","assets/Welcome-BniXWGnV.js","assets/Preview-CYnBbUiB.js","assets/Profile-4P-wRwvt.js","assets/alert-C_DpXmPl.js","assets/Premium-1drsp01V.js","assets/PepTalkDetail-1TNhOqLa.js","assets/Admin-BnhXWjHL.js","assets/MentorSelection-BCmT8-Uf.js","assets/NotFound-BP23OId0.js","assets/Reflection-CXvFG5cM.js","assets/MentorChat-DjU0Nqr4.js","assets/Library-BRbm9ycn.js","assets/PepTalkCard-LLtaUNgr.js","assets/QuoteCard-B2SFR4YG.js","assets/Challenges-BRgf_Emy.js","assets/Search-DMX1P1zp.js","assets/PepTalks-CCWX7rYy.js","assets/TermsOfService-w_f3-aY3.js","assets/PrivacyPolicy-7Iie3xLI.js","assets/PremiumSuccess-B6FIak20.js","assets/Epics-BgO2tYO9.js","assets/habitLimits-NNrGyrB4.js","assets/SharedEpics-DGIzq_OP.js","assets/Partners-BLBukkD5.js","assets/JoinEpic-W34clMf2.js","assets/Creator-b5L_840A.js","assets/InfluencerDashboard-OzmIh1a9.js","assets/AccountDeletionHelp-Xj1B0htH.js","assets/Recaps-PXy4zS3O.js","assets/HelpCenter-BVG7X1Yt.js","assets/TestDayPlanner-D66FsT_o.js","assets/TestScroll-77Rr5Lqb.js","assets/Contacts-CH3JNG76.js","assets/IAPTest-M3iPyTWM.js"])))=>i.map(i=>d[i]);
import{S as Gp,i as Yp,c as Vp,r as n,t as Xp,a as Jp,j as e,V as jc,R as Nc,b as Hr,A as kc,C as Cc,X as Nt,T as Sc,D as Ec,P as Zp,$ as eh,d as Tc,e as th,f as sh,g as rh,h as ah,k as Ot,l as Pe,m as M,n as St,o as nt,u as Ae,p as Dr,q as Ee,s as Mc,I as nh,v as ih,N as _n,O as Dc,w as oh,x as Pc,y as Ac,z as Rc,B as Ic,E as Lc,F as lh,G as ch,H as as,J as Po,K as pe,M as Vi,L as jn,Q as ir,U as dh,W as $s,Y as Xs,Z as cr,_ as uh,a0 as qc,a1 as Is,a2 as Nn,a3 as Oc,a4 as kn,a5 as mh,a6 as Cn,a7 as Sn,a8 as Fc,a9 as ph,aa as bt,ab as Sa,ac as ha,ad as ft,ae as $c,af as Ws,ag as Xi,ah as Ss,ai as fs,aj as Wt,ak as Es,al as Ao,am as At,an as hh,ao as fh,ap as gh,aq as xh,ar as yh,as as Hc,at as En,au as ke,av as Ls,aw as la,ax as Ji,ay as bh,az as Et,aA as W,aB as le,aC as vh,aD as Bc,aE as wh,aF as _h,aG as Uc,aH as jh,aI as zc,aJ as Qc,aK as Kc,aL as fa,aM as Pr,aN as Tn,aO as Wc,aP as Gc,aQ as Yc,aR as Vc,aS as ga,aT as $t,aU as Nh,aV as kh,aW as Xc,aX as Ch,aY as ca,aZ as Ts,a_ as Jc,a$ as Sh,b0 as Zc,b1 as Eh,b2 as Th,b3 as Mh,b4 as Vs,b5 as Dh,b6 as Zi,b7 as Os,b8 as Ph,b9 as Ah,ba as Rh,bb as Ih,bc as Ro,bd as Pt,be as gs,bf as eo,bg as Ea,bh as Lh,bi as Gn,bj as Io,bk as qh,bl as ed,bm as Oh,bn as Fh,bo as td,bp as $h,bq as Hh,br as Ta,bs as Bh,bt as Gt,bu as Uh,bv as zh,bw as Lo,bx as Ar,by as sd,bz as rd,bA as ad,bB as Qh,bC as Mi,bD as Kh,bE as Wh,bF as Gh,bG as Yh,bH as Vh,bI as Xh,bJ as nd,bK as id,bL as Jh,bM as od,bN as ld,bO as Zh,bP as cd,bQ as ef,bR as dd,bS as ud,bT as tf,bU as sf,bV as md,bW as rf,bX as af,bY as xa,bZ as Ma,b_ as nf,b$ as Da,c0 as of,c1 as pd,c2 as lf,c3 as hd,c4 as cf,c5 as Ft,c6 as df,c7 as Rr,c8 as Ht,c9 as uf,ca as fd,cb as mf,cc as pf,cd as ya,ce as hf,cf as ff,cg as Cr,ch as gd,ci as gf,cj as xf,ck as xd,cl as yd,cm as bd,cn as to,co as da,cp as yf,cq as vd,cr as wd,cs as Di,ct as _d,cu as jd,cv as bf,cw as Nd,cx as kd,cy as Cd,cz as Sd,cA as Ed,cB as Td,cC as Md,cD as vf,cE as wf,cF as _f,cG as Dd,cH as jf,cI as Nf,cJ as kf,cK as Cf,cL as Sf,cM as Ef,cN as Pd,cO as Ad,cP as Tf,cQ as Mf,cR as Rd,cS as Df,cT as Pf,cU as Af,cV as Rf,cW as Mn,cX as Id,cY as If,cZ as Lf,c_ as qf,c$ as Ld,d0 as Of,d1 as Ff,d2 as $f,d3 as Hf,d4 as Ge,d5 as gr,d6 as Bf,d7 as Uf,d8 as zf}from"./vendor-FfY6MM0Z.js";import{o as te,F as ps,G as Qf,H as pn,I as qd,J as so,s as ba,e as va,B as Od,z as Fd,K as Pi,L as Kf,c as Sr,g as wa,i as Wf,v as Fs,w as an,M as qt,j as Dn,k as Gf,h as Cs,a as Yf,m as Ai,N as Yn,O as Vn,P as Xn,Q as qo,R as Oo,S as Fo,T as $o,U as Ir,V as ro,W as Vf,q as Xf}from"./date-vendor-Bk4KiHsJ.js";import"./three-vendor-qI8GXUTd.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))a(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&a(l)}).observe(document,{childList:!0,subtree:!0});function r(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(i){if(i.ep)return;i.ep=!0;const o=r(i);fetch(i.href,o)}})();const Jf=async()=>{try{console.debug("Capacitor initialized, splash screen visible")}catch(t){console.debug("Capacitor initialization error:",t)}},Zf=async()=>{try{await Gp.hide({fadeOutDuration:300}),console.debug("Splash screen hidden")}catch(t){console.debug("Splash screen not available:",t)}},Ho={debug:0,info:1,warn:2,error:3},eg="warn";function nn(t){return Ho[t]>=Ho[eg]}function tg(t){const s=t.scope?`[${t.scope}]`:"";return s?`${s} ${t.message}`:t.message}function sg(t){Yp()&&Vp(t.message,{level:"error",extra:t.context,tags:t.scope?{scope:t.scope}:void 0})}function ts(t,s,r,a){if(!nn(t))return;const i={message:s,context:r,timestamp:new Date().toISOString(),scope:a},l=[tg(i)];switch(r&&Object.keys(r).length>0&&l.push(r),t){case"debug":console.log(...l);break;case"info":console.log(...l);break;case"warn":console.warn(...l);break;case"error":console.error(...l),sg(i);break}}function rg(t){return{debug:(s,r)=>ts("debug",s,r,t),info:(s,r)=>ts("info",s,r,t),warn:(s,r)=>ts("warn",s,r,t),error:(s,r)=>{s instanceof Error?ts("error",s.message,{...r,stack:s.stack,name:s.name},t):ts("error",s,r,t)}}}function ag(t,s){const r=performance.now();return{end:a=>{const i=Math.round(performance.now()-r);return ts("debug",`${t} completed in ${i}ms`,{...a,durationMs:i},s),i},checkpoint:a=>{const i=Math.round(performance.now()-r);return ts("debug",`${t} checkpoint: ${a} at ${i}ms`,{elapsedMs:i},s),i}}}const oe={debug:(t,s)=>ts("debug",t,s),info:(t,s)=>ts("info",t,s),warn:(t,s)=>ts("warn",t,s),error:(t,s)=>{t instanceof Error?ts("error",t.message,{...s,stack:t.stack,name:t.name}):ts("error",t,s)},log:(t,...s)=>{nn("debug")&&console.log(t,...s)},scope:t=>rg(t),time:(t,s)=>ag(t,s),dev:(t,s)=>{},group:(t,s)=>{if(nn("debug")){console.group(t);try{s()}finally{console.groupEnd()}}},table:t=>{nn("debug")&&console.table(t)}},ng=1,ig=1e6;let Jn=0;function og(){return Jn=(Jn+1)%Number.MAX_SAFE_INTEGER,Jn.toString()}const Zn=new Map,Bo=t=>{if(Zn.has(t))return;const s=setTimeout(()=>{Zn.delete(t),ua({type:"REMOVE_TOAST",toastId:t})},ig);Zn.set(t,s)},lg=(t,s)=>{switch(s.type){case"ADD_TOAST":return{...t,toasts:[s.toast,...t.toasts].slice(0,ng)};case"UPDATE_TOAST":return{...t,toasts:t.toasts.map(r=>r.id===s.toast.id?{...r,...s.toast}:r)};case"DISMISS_TOAST":{const{toastId:r}=s;return r?Bo(r):t.toasts.forEach(a=>{Bo(a.id)}),{...t,toasts:t.toasts.map(a=>a.id===r||r===void 0?{...a,open:!1}:a)}}case"REMOVE_TOAST":return s.toastId===void 0?{...t,toasts:[]}:{...t,toasts:t.toasts.filter(r=>r.id!==s.toastId)}}},on=[];let ln={toasts:[]};function ua(t){ln=lg(ln,t),on.forEach(s=>{s(ln)})}function cg({...t}){const s=og(),r=i=>ua({type:"UPDATE_TOAST",toast:{...i,id:s}}),a=()=>ua({type:"DISMISS_TOAST",toastId:s});return ua({type:"ADD_TOAST",toast:{...t,id:s,open:!0,onOpenChange:i=>{i||a()}}}),{id:s,dismiss:a,update:r}}function Ms(){const[t,s]=n.useState(ln);return n.useEffect(()=>(on.push(s),()=>{const r=on.indexOf(s);r>-1&&on.splice(r,1)}),[t]),{...t,toast:cg,dismiss:r=>ua({type:"DISMISS_TOAST",toastId:r})}}function A(...t){return Xp(Jp(t))}function hs(t){return t?t.replace(/[_-]+/g," ").replace(/\s+/g," ").trim().toLowerCase().replace(/\b[a-z]/g,s=>s.toUpperCase()):""}function Ri(t){return t?t.replace(/\*\*([^*]+)\*\*/g,"$1").replace(/\*([^*]+)\*/g,"$1").replace(/__([^_]+)__/g,"$1").replace(/_([^_]+)_/g,"$1").replace(/~~([^~]+)~~/g,"$1").replace(/`([^`]+)`/g,"$1").trim():""}const dg=Zp,$d=n.forwardRef(({className:t,...s},r)=>e.jsx(jc,{ref:r,className:A("pointer-events-none fixed bottom-[calc(64px+env(safe-area-inset-bottom,0px)+12px)] right-0 z-[100] flex max-h-screen w-full flex-col p-4 sm:bottom-0 sm:max-w-[420px]",t),...s}));$d.displayName=jc.displayName;const ug=Hr("group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-y-0 data-[swipe=end]:translate-y-[var(--radix-toast-swipe-end-y)] data-[swipe=move]:translate-y-[var(--radix-toast-swipe-move-y)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-bottom-full data-[state=open]:slide-in-from-bottom-full",{variants:{variant:{default:"border bg-background text-foreground",destructive:"destructive group border-destructive bg-destructive text-destructive-foreground"}},defaultVariants:{variant:"default"}}),Hd=n.forwardRef(({className:t,variant:s,...r},a)=>e.jsx(Nc,{ref:a,className:A(ug({variant:s}),t),...r}));Hd.displayName=Nc.displayName;const Bd=n.forwardRef(({className:t,...s},r)=>e.jsx(kc,{ref:r,className:A("inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors group-[.destructive]:border-muted/40 hover:bg-secondary group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 group-[.destructive]:focus:ring-destructive disabled:pointer-events-none disabled:opacity-50",t),...s}));Bd.displayName=kc.displayName;const Ud=n.forwardRef(({className:t,...s},r)=>e.jsx(Cc,{ref:r,className:A("absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity group-hover:opacity-100 group-[.destructive]:text-red-300 hover:text-foreground group-[.destructive]:hover:text-red-50 focus:opacity-100 focus:outline-none focus:ring-2 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",t),"toast-close":"",...s,children:e.jsx(Nt,{className:"h-4 w-4"})}));Ud.displayName=Cc.displayName;const zd=n.forwardRef(({className:t,...s},r)=>e.jsx(Sc,{ref:r,className:A("text-sm font-semibold",t),...s}));zd.displayName=Sc.displayName;const Qd=n.forwardRef(({className:t,...s},r)=>e.jsx(Ec,{ref:r,className:A("text-sm opacity-90",t),...s}));Qd.displayName=Ec.displayName;function mg(){const{toasts:t}=Ms();return e.jsxs(dg,{swipeDirection:"up",children:[t.map(function({id:s,title:r,description:a,action:i,...o}){return e.jsxs(Hd,{...o,children:[e.jsxs("div",{className:"grid gap-1",children:[r&&e.jsx(zd,{children:r}),a&&e.jsx(Qd,{children:a})]}),i,e.jsx(Ud,{})]},s)}),e.jsx($d,{})]})}const pg=({...t})=>e.jsx(eh,{theme:"dark",className:"toaster group",position:"bottom-center",swipeDirections:["bottom","left","right"],toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"group-[.toast]:text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...t}),Kd=rh,Wd=th,Gd=sh,ao=n.forwardRef(({className:t,sideOffset:s=4,...r},a)=>e.jsx(Tc,{ref:a,sideOffset:s,className:A("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...r}));ao.displayName=Tc.displayName;const za=()=>{try{const t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch{return!1}},Qa=()=>{try{const t="__storage_test__";return sessionStorage.setItem(t,t),sessionStorage.removeItem(t),!0}catch{return!1}},rt={getItem:t=>{try{return za()?localStorage.getItem(t):null}catch{return null}},setItem:(t,s)=>{try{return za()?(localStorage.setItem(t,s),!0):!1}catch{return!1}},removeItem:t=>{try{return za()?(localStorage.removeItem(t),!0):!1}catch{return!1}},clear:()=>{try{return za()?(localStorage.clear(),!0):!1}catch{return!1}}},Ii={getItem:t=>{try{return Qa()?sessionStorage.getItem(t):null}catch{return null}},setItem:(t,s)=>{try{return Qa()?(sessionStorage.setItem(t,s),!0):!1}catch{return!1}},removeItem:t=>{try{return Qa()?(sessionStorage.removeItem(t),!0):!1}catch{return!1}},clear:()=>{try{return Qa()?(sessionStorage.clear(),!0):!1}catch{return!1}}},hg="https://opbfpbbqvuksuvmtmssd.supabase.co",fg="sb_publishable_JIATfg-h-gcg2TLZGmQeSw_XcHqQZvB",gg={getItem:t=>rt.getItem(t),setItem:(t,s)=>{rt.setItem(t,s)},removeItem:t=>{rt.removeItem(t)}},S=ah(hg,fg,{auth:{storage:gg,persistSession:!0,autoRefreshToken:!0}}),Yd=n.createContext({currentTheme:null,isTransitioning:!1}),xg=()=>n.useContext(Yd),yg=({children:t,mentorId:s})=>{const[r,a]=n.useState(null),[i,o]=n.useState(!1);n.useEffect(()=>{let m=!0,p;return(async()=>{if(!s){m&&(a(null),c());return}try{const{data:f}=await S.from("mentors").select("theme_config").eq("id",s).maybeSingle();if(!m)return;if(f?.theme_config){o(!0);const u=f.theme_config;a(u),l(u),p=setTimeout(()=>{m&&o(!1)},300)}else c()}catch(f){console.error("Error applying theme:",f),m&&(c(),o(!1))}})(),()=>{m=!1,p&&clearTimeout(p)}},[s]);const l=m=>{const p=document.documentElement;p.style.setProperty("--primary",m.primary),p.style.setProperty("--secondary",m.secondary),p.style.setProperty("--accent",m.accent),p.style.setProperty("--background",m.background),p.style.setProperty("--foreground",m.foreground),p.style.setProperty("--card",m.card),p.style.setProperty("--card-foreground",m.foreground),p.style.setProperty("--popover",m.card),p.style.setProperty("--popover-foreground",m.foreground),p.style.setProperty("--primary-foreground",m.foreground),p.style.setProperty("--secondary-foreground",m.foreground),p.style.setProperty("--accent-foreground",m.foreground),p.style.setProperty("--radius",m.border_radius),m.glow_effect?p.style.setProperty("--shadow-glow",`0 0 24px hsl(${m.primary} / 0.5)`):p.style.setProperty("--shadow-glow","0 0 0 transparent"),m.border_style==="sharp"?p.classList.add("sharp-borders"):p.classList.remove("sharp-borders"),m.texture&&m.texture!=="none"&&p.style.setProperty("--bg-texture",m.texture),p.classList.add("theme-transition"),setTimeout(()=>p.classList.remove("theme-transition"),300)},c=()=>{const m=document.documentElement;m.style.setProperty("--primary","270 60% 50%"),m.style.setProperty("--secondary","240 6% 20%"),m.style.setProperty("--accent","270 50% 35%"),m.style.setProperty("--background","0 0% 7%"),m.style.setProperty("--foreground","0 0% 100%"),m.style.setProperty("--card","240 6% 15%"),m.style.setProperty("--radius","1.25rem"),m.style.setProperty("--shadow-glow","0 0 24px hsl(270 60% 50% / 0.5)"),m.classList.remove("sharp-borders")},d=n.useMemo(()=>({currentTheme:r,isTransitioning:i}),[r,i]);return e.jsx(Yd.Provider,{value:d,children:t})},bg=n.createContext(void 0),Ka="cosmiq_view_mode";function vg({children:t}){const[s,r]=n.useState(()=>{const l=rt.getItem(Ka);return l==="focus"||l==="quest"?l:"quest"}),a=n.useCallback(l=>{r(l),rt.setItem(Ka,l)},[]),i=n.useCallback(()=>{r(l=>{const c=l==="focus"?"quest":"focus";return rt.setItem(Ka,c),c})},[]);n.useEffect(()=>{rt.setItem(Ka,s)},[s]);const o=n.useMemo(()=>({viewMode:s,setViewMode:a,toggleViewMode:i}),[s,a,i]);return e.jsx(bg.Provider,{value:o,children:t})}const hn={dawn:{start:5,end:8,colors:{primary:"hsl(25, 90%, 55%)",accent:"hsl(340, 75%, 60%)",nebula1:"hsl(330, 65%, 45%)",nebula2:"hsl(25, 80%, 50%)",nebula3:"hsl(45, 90%, 60%)",starTint:"warm",gradient:"from-rose-950/40 via-amber-900/30 to-slate-900/50"}},morning:{start:8,end:12,colors:{primary:"hsl(195, 85%, 50%)",accent:"hsl(170, 75%, 45%)",nebula1:"hsl(185, 70%, 45%)",nebula2:"hsl(45, 85%, 55%)",nebula3:"hsl(210, 75%, 50%)",starTint:"neutral",gradient:"from-sky-950/40 via-cyan-900/30 to-slate-900/50"}},afternoon:{start:12,end:17,colors:{primary:"hsl(35, 95%, 55%)",accent:"hsl(190, 80%, 50%)",nebula1:"hsl(40, 85%, 50%)",nebula2:"hsl(180, 70%, 45%)",nebula3:"hsl(55, 90%, 60%)",starTint:"warm",gradient:"from-amber-950/40 via-teal-900/30 to-slate-900/50"}},sunset:{start:17,end:20,colors:{primary:"hsl(330, 80%, 55%)",accent:"hsl(20, 90%, 55%)",nebula1:"hsl(340, 75%, 50%)",nebula2:"hsl(25, 85%, 55%)",nebula3:"hsl(280, 60%, 50%)",starTint:"warm",gradient:"from-pink-950/40 via-orange-900/30 to-purple-950/40"}},night:{start:20,end:5,colors:{primary:"hsl(230, 70%, 55%)",accent:"hsl(195, 90%, 55%)",nebula1:"hsl(240, 60%, 45%)",nebula2:"hsl(200, 75%, 50%)",nebula3:"hsl(270, 55%, 45%)",starTint:"cool",gradient:"from-indigo-950/50 via-slate-900/40 to-black/60"}}},wg=t=>t>=5&&t<8?"dawn":t>=8&&t<12?"morning":t>=12&&t<17?"afternoon":t>=17&&t<20?"sunset":"night",_g=(t,s,r)=>{const a=hn[r],i=t*60+s;let o=a.start*60,l=a.end*60;r==="night"&&(t>=20?l=1740:(o=0,l=300));const c=l-o,d=i-o;return Math.max(0,Math.min(1,d/c))},jg=(t,s)=>(t*60+s)*.5%360,Ng=hn.night.colors,Vd=n.createContext({period:"night",progress:0,colors:Ng,rotationHue:0}),kg=()=>n.useContext(Vd),Cg=({children:t})=>{const[s,r]=n.useState("night"),[a,i]=n.useState(0),[o,l]=n.useState(0);n.useEffect(()=>{const m=()=>{const h=new Date,f=h.getHours(),u=h.getMinutes(),g=wg(f),y=_g(f,u,g),b=jg(f,u);r(g),i(y),l(b)};m();const p=setInterval(m,6e4);return()=>clearInterval(p)},[]),n.useEffect(()=>{const m=document.documentElement,p=hn[s].colors;m.style.setProperty("--time-primary",p.primary),m.style.setProperty("--time-accent",p.accent),m.style.setProperty("--time-nebula-1",p.nebula1),m.style.setProperty("--time-nebula-2",p.nebula2),m.style.setProperty("--time-nebula-3",p.nebula3),m.style.setProperty("--time-gradient",p.gradient),m.style.setProperty("--rotation-hue",`${o}deg`),m.setAttribute("data-time-period",s)},[s,o]);const c=n.useMemo(()=>hn[s].colors,[s]),d=n.useMemo(()=>({period:s,progress:a,colors:c,rotationHue:o}),[s,a,c,o]);return e.jsx(Vd.Provider,{value:d,children:t})},Sg=typeof navigator<"u",Eg=Sg&&"vibrate"in navigator&&typeof navigator.vibrate=="function";let Uo=!1;const ea=t=>{if(!(!Eg||Uo))try{navigator.vibrate(t)}catch(s){console.warn("Haptics unavailable, disabling vibration",s),Uo=!0}},mt={light:()=>{ea(10)},medium:()=>{ea(20)},heavy:()=>{ea(30)},success:()=>{ea([10,50,10])},error:()=>{ea([50,100,50])}},Tg=({xp:t,reason:s,show:r,onComplete:a})=>(n.useEffect(()=>{if(r){mt.light(),Ot({particleCount:20,spread:50,origin:{y:.7},colors:["#A76CFF","#C084FC"],ticks:100,gravity:1.2});const i=setTimeout(a,2e3);return()=>clearTimeout(i)}},[r,a]),e.jsx(Pe,{children:r&&e.jsx(M.div,{initial:{opacity:0,y:20,scale:.9},animate:{opacity:1,y:0,scale:1,transition:{type:"spring",stiffness:400,damping:20}},exit:{opacity:0,y:-10,scale:.95,transition:{duration:.15}},className:"fixed bottom-28 left-1/2 -translate-x-1/2 z-50",children:e.jsx(M.div,{className:"bg-black/70 backdrop-blur-sm border border-white/20 px-4 py-2 rounded-full",animate:{boxShadow:["0 0 10px rgba(167, 108, 255, 0.3)","0 0 20px rgba(167, 108, 255, 0.5)","0 0 10px rgba(167, 108, 255, 0.3)"]},transition:{duration:1.5,repeat:1/0},children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(St,{className:"h-4 w-4 text-stardust-gold"}),e.jsxs("span",{className:"text-sm font-semibold text-white",children:["+",t," XP"]}),s&&e.jsx("span",{className:"text-xs text-white/70",children:s})]})})})})),ss=oe.scope("iOS Audio"),er=nt.getPlatform()==="ios"||/iPad|iPhone|iPod/.test(navigator.userAgent);let ei=null,ti=!1,cn=!1;function fn(){if(typeof window>"u")return null;if(!ei)try{const t=window.AudioContext||window.webkitAudioContext;t&&(ei=new t)}catch(t){ss.error("Failed to create AudioContext",{error:t})}return ei}async function Pa(){const t=fn();if(!t)return!1;if(t.state==="suspended")try{return await t.resume(),ti=!0,ss.debug("AudioContext resumed successfully"),!0}catch(s){return ss.error("Failed to resume AudioContext",{error:s}),!1}return ti=t.state==="running",ti}function Mg(){return fn()?.state==="running"}function no(){if(typeof document>"u"||cn)return;const t=async()=>{if(!cn){cn=!0,ss.info("User interaction detected, enabling audio..."),await Pa();try{const s=new Audio;s.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA",s.volume=.001,s.playsInline=!0;const r=s.play();r&&r.then(()=>{s.pause(),s.src="",ss.debug("Audio unlocked via silent play")}).catch(()=>{ss.debug("Silent play caught (expected on some platforms)")})}catch(s){ss.debug("Silent unlock failed (non-critical)",{error:s})}document.removeEventListener("touchstart",t,!0),document.removeEventListener("touchend",t,!0),document.removeEventListener("click",t,!0),document.removeEventListener("keydown",t,!0)}};document.addEventListener("touchstart",t,{capture:!0,passive:!0}),document.addEventListener("touchend",t,{capture:!0,passive:!0}),document.addEventListener("click",t,{capture:!0}),document.addEventListener("keydown",t,{capture:!0})}function xk(t){const s=new Audio;return s.playsInline=!0,s["webkit-playsinline"]=!0,s.preload="auto",t&&(s.src=t),s}async function Dg(t){if(!t)return!1;er&&!Mg()&&await Pa();try{const s=t.play();return s&&await s,!0}catch(s){const r=s;return r.name==="NotAllowedError"?(ss.debug("Play blocked - waiting for user interaction"),!1):(r.name==="AbortError"||ss.error("Play failed",{error:s}),!1)}}class Pg{isMuted=!1;listeners=new Set;audioElements=new Set;constructor(){typeof window<"u"&&(this.loadState(),no(),document.addEventListener("visibilitychange",this.handleVisibilityChange),nt.isNativePlatform()&&document.addEventListener("resume",()=>{this.isMuted||this.resumeAllAudio()}))}loadState(){const s=rt.getItem("global_audio_muted");this.isMuted=s==="true"}saveState(){rt.setItem("global_audio_muted",this.isMuted.toString())}handleVisibilityChange=()=>{document.hidden?ss.info("App backgrounded"):(ss.info("App foregrounded"),this.isMuted||setTimeout(()=>this.resumeAllAudio(),100))};registerAudio(s){this.audioElements.add(s),this.isMuted&&(s.muted=!0)}unregisterAudio(s){this.audioElements.delete(s)}async resumeAllAudio(){await Pa();for(const s of this.audioElements)s.paused&&!this.isMuted&&Dg(s)}getMuted(){return this.isMuted}setMuted(s){if(this.isMuted!==s){this.isMuted=s,this.saveState();for(const r of this.audioElements)r.muted=s;this.notifyListeners(),typeof window<"u"&&window.dispatchEvent(new CustomEvent("ios-audio-mute-change",{detail:s}))}}toggleMute(){return this.setMuted(!this.isMuted),this.isMuted}subscribe(s){return this.listeners.add(s),()=>this.listeners.delete(s)}notifyListeners(){for(const s of this.listeners)try{s(this.isMuted)}catch(r){ss.error("Listener error",{error:r})}}canPlay(){return!this.isMuted&&cn}}const ta=new Pg;typeof window<"u"&&no();class Ag{isMuted=!1;listeners=new Set;constructor(){typeof window<"u"&&(this.loadPreferences(),no(),er&&ta.subscribe(s=>{this.isMuted!==s&&(this.isMuted=s,this.notifyListeners())}))}loadPreferences(){try{const s=rt.getItem("global_audio_muted");s&&(this.isMuted=s==="true",er&&ta.setMuted(this.isMuted))}catch(s){console.warn("Failed to load global audio preferences:",s)}}savePreferences(){try{rt.setItem("global_audio_muted",this.isMuted.toString())}catch(s){console.warn("Failed to save global audio preferences:",s)}}notifyListeners(){this.listeners.forEach(s=>{try{s(this.isMuted)}catch(r){console.error("Error in global audio listener:",r)}}),typeof window<"u"&&window.dispatchEvent(new CustomEvent("global-audio-mute-change",{detail:this.isMuted}))}toggleMute(){return this.isMuted=!this.isMuted,this.savePreferences(),er&&ta.setMuted(this.isMuted),this.notifyListeners(),this.isMuted}setMuted(s){this.isMuted!==s&&(this.isMuted=s,this.savePreferences(),er&&ta.setMuted(s),this.notifyListeners())}getMuted(){return this.isMuted}subscribe(s){return this.listeners.add(s),()=>{this.listeners.delete(s)}}canPlayAudio(){return er?!this.isMuted&&ta.canPlay():!this.isMuted}async ensureReady(){er&&await Pa()}}const Li=new Ag;class Rg{audioContext=null;masterVolume=.5;isMuted=!1;isGloballyMuted=!1;activeIntervals=new Set;globalMuteUnsubscribe=null;constructor(){typeof window<"u"&&(this.audioContext=fn(),this.loadSoundPreferences(),this.isGloballyMuted=Li.getMuted(),this.globalMuteUnsubscribe=Li.subscribe(s=>{this.isGloballyMuted=s,s&&this.stopAllAmbientSounds()}),window.addEventListener("beforeunload",()=>{this.stopAllAmbientSounds(),this.globalMuteUnsubscribe&&this.globalMuteUnsubscribe()}))}shouldMute(){return this.isMuted||this.isGloballyMuted}async ensureAudioContext(){return this.audioContext||(this.audioContext=fn()),this.audioContext&&this.audioContext.state==="suspended"&&await Pa(),this.audioContext}loadSoundPreferences(){const s=rt.getItem("sound_volume"),r=rt.getItem("sound_muted");s&&(this.masterVolume=parseFloat(s)),r&&(this.isMuted=r==="true")}setVolume(s){this.masterVolume=Math.max(0,Math.min(1,s)),rt.setItem("sound_volume",this.masterVolume.toString())}toggleMute(){return this.isMuted=!this.isMuted,rt.setItem("sound_muted",this.isMuted.toString()),this.isMuted&&this.stopAllAmbientSounds(),this.isMuted}stopAllAmbientSounds(){this.activeIntervals.forEach(s=>clearInterval(s)),this.activeIntervals.clear()}createOscillator(s,r,a="sine"){if(!this.audioContext||this.shouldMute())return null;const i=this.audioContext.createOscillator(),o=this.audioContext.createGain();return i.type=a,i.frequency.setValueAtTime(s,this.audioContext.currentTime),o.gain.setValueAtTime(this.masterVolume*.3,this.audioContext.currentTime),o.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+r),i.connect(o),o.connect(this.audioContext.destination),i.start(this.audioContext.currentTime),i.stop(this.audioContext.currentTime+r),null}async playEvolutionStart(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[220,277,330,440,554,659,880,1108].forEach((r,a)=>{setTimeout(()=>{this.createOscillator(r,.2,"sawtooth"),this.createOscillator(r*1.5,.1,"sine")},a*80)})}async playEvolutionSuccess(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=[130.81,164.81,196],r=[[523.25,659.25,783.99],[659.25,830.61,987.77],[783.99,987.77,1174.66],[1046.5,1318.51,1567.98]];s.forEach((a,i)=>{setTimeout(()=>{this.createOscillator(a,.4,"sawtooth")},i*150)}),r.forEach((a,i)=>{setTimeout(()=>{a.forEach(o=>{this.createOscillator(o,.35,"triangle"),this.createOscillator(o*2,.15,"sine")})},i*180)})}async playSparkle(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=1500+Math.random()*1e3;this.createOscillator(s,.15,"sine")}async playHabitComplete(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(800,.1,"triangle"),setTimeout(()=>{this.createOscillator(1200,.15,"sine")},50)))}async playXPGain(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[440,554.37,659.25].forEach((r,a)=>{setTimeout(()=>{this.createOscillator(r,.1,"square")},a*40)})}async playMissionComplete(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(523.25,.15,"triangle"),setTimeout(()=>{this.createOscillator(659.25,.15,"triangle")},75),setTimeout(()=>{this.createOscillator(783.99,.2,"triangle")},150)))}async playLessonComplete(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(659.25,.2,"sine"),setTimeout(()=>{this.createOscillator(783.99,.25,"sine")},100),setTimeout(()=>{this.createOscillator(1046.5,.3,"sine")},200)))}async playAchievementUnlock(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[{freq:392,duration:.2},{freq:523.25,duration:.2},{freq:659.25,duration:.3},{freq:783.99,duration:.4}].forEach((r,a)=>{setTimeout(()=>{this.createOscillator(r.freq,r.duration,"triangle")},a*150)})}async playButtonClick(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&this.createOscillator(300,.05,"square"))}async playNotification(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(660,.15,"sine"),setTimeout(()=>{this.createOscillator(880,.2,"sine")},100)))}async playStreakMilestone(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[523.25,659.25,783.99,1046.5,1318.51].forEach((r,a)=>{setTimeout(()=>{this.createOscillator(r,.25,"triangle")},a*100)})}async playAmbientNature(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=[100,150,200,250];s.forEach(a=>{this.createOscillator(a+Math.random()*20,2,"sine")});const r=setInterval(()=>{if(this.shouldMute()){clearInterval(r),this.activeIntervals.delete(r);return}s.forEach(a=>{this.createOscillator(a+Math.random()*20,2,"sine")})},2e3);return this.activeIntervals.add(r),()=>{clearInterval(r),this.activeIntervals.delete(r)}}async playCalming(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(220,3,"sine"),setTimeout(()=>{this.createOscillator(440,3,"sine")},1500)))}async playArcadeEntrance(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=150,r=800,a=.6,i=this.audioContext.createOscillator(),o=this.audioContext.createGain();i.type="sawtooth",i.frequency.setValueAtTime(s,this.audioContext.currentTime),i.frequency.exponentialRampToValueAtTime(r,this.audioContext.currentTime+a),o.gain.setValueAtTime(this.masterVolume*.25,this.audioContext.currentTime),o.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+a),i.connect(o),o.connect(this.audioContext.destination),i.start(),i.stop(this.audioContext.currentTime+a);const l=this.audioContext.createOscillator(),c=this.audioContext.createGain();l.type="square",l.frequency.setValueAtTime(s*2,this.audioContext.currentTime),l.frequency.exponentialRampToValueAtTime(r*1.5,this.audioContext.currentTime+a),c.gain.setValueAtTime(this.masterVolume*.1,this.audioContext.currentTime),c.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+a),l.connect(c),c.connect(this.audioContext.destination),l.start(),l.stop(this.audioContext.currentTime+a),setTimeout(()=>{this.createOscillator(1200,.15,"sine"),this.createOscillator(1500,.1,"sine")},400)}async playArcadeSelect(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=this.audioContext.createOscillator(),r=this.audioContext.createGain();s.type="square",s.frequency.setValueAtTime(600,this.audioContext.currentTime),s.frequency.exponentialRampToValueAtTime(800,this.audioContext.currentTime+.08),r.gain.setValueAtTime(this.masterVolume*.2,this.audioContext.currentTime),r.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.1),s.connect(r),r.connect(this.audioContext.destination),s.start(),s.stop(this.audioContext.currentTime+.1)}async playArcadeHighScore(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[523.25,659.25,783.99,1046.5].forEach((r,a)=>{setTimeout(()=>{this.createOscillator(r,.2,"triangle"),this.createOscillator(r*2,.1,"sine")},a*100)}),setTimeout(()=>{[1046.5,1318.51,1567.98].forEach(r=>{this.createOscillator(r,.4,"triangle")})},450)}async playEncounterTrigger(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[329.63,392,493.88,659.25].forEach((r,a)=>{setTimeout(()=>{const i=this.audioContext.createOscillator(),o=this.audioContext.createGain();i.type="square",i.frequency.setValueAtTime(r,this.audioContext.currentTime),o.gain.setValueAtTime(this.masterVolume*.25,this.audioContext.currentTime),o.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.15),i.connect(o),o.connect(this.audioContext.destination),i.start(),i.stop(this.audioContext.currentTime+.15)},a*100)})}async playStrikethrough(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=this.audioContext.createOscillator(),r=this.audioContext.createGain();s.type="sine",s.frequency.setValueAtTime(1200,this.audioContext.currentTime),s.frequency.exponentialRampToValueAtTime(300,this.audioContext.currentTime+.15),r.gain.setValueAtTime(this.masterVolume*.25,this.audioContext.currentTime),r.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.18),s.connect(r),r.connect(this.audioContext.destination),s.start(),s.stop(this.audioContext.currentTime+.2),setTimeout(()=>{this.createOscillator(800,.08,"triangle")},100)}}const rs=new Rg,Ig=()=>rs.playEvolutionStart(),Lg=()=>rs.playEvolutionSuccess(),yk=()=>rs.playHabitComplete(),qg=()=>rs.playXPGain(),io=()=>rs.playMissionComplete(),Og=()=>rs.playAchievementUnlock(),Fg=()=>rs.playEncounterTrigger(),$g=()=>rs.playStrikethrough(),Hg=t=>{switch(t){case"complete":return rs.playHabitComplete();case"error":return rs.playButtonClick();case"pop":return rs.playSparkle();case"success":return rs.playMissionComplete()}},Xd=n.createContext(null),Bg=({children:t})=>{const[s,r]=n.useState({xp:0,reason:"",show:!1}),a=n.useCallback((l,c)=>{r({xp:l,reason:c,show:!0}),qg()},[]),i=n.useCallback(()=>{r(l=>({...l,show:!1}))},[]),o=n.useMemo(()=>({showXPToast:a}),[a]);return e.jsxs(Xd.Provider,{value:o,children:[t,e.jsx(Tg,{xp:s.xp,reason:s.reason,show:s.show,onComplete:i})]})},Jd=()=>{const t=n.useContext(Xd);if(!t)throw new Error("useXPToast must be used within XPProvider");return t},Zd=n.createContext(void 0),Ug=({children:t})=>{const[s,r]=n.useState(!1),[a,i]=n.useState(null),o=n.useMemo(()=>({isEvolvingLoading:s,setIsEvolvingLoading:r,onEvolutionComplete:a,setOnEvolutionComplete:i}),[s,a]);return e.jsx(Zd.Provider,{value:o,children:t})},Pn=()=>{const t=n.useContext(Zd);if(t===void 0)throw new Error("useEvolution must be used within an EvolutionProvider");return t},eu=n.createContext(void 0),zg=({children:t})=>{const[s,r]=n.useState(!1),[a,i]=n.useState([]),o=n.useCallback(m=>{i(p=>p.includes(m)?p:[...p,m])},[]),l=n.useCallback(m=>{let p=!1;return i(h=>h.includes(m)?(p=!0,h.filter(f=>f!==m)):h),p},[]),c=n.useCallback(()=>{i([])},[]),d=n.useMemo(()=>({isEvolutionInProgress:s,setEvolutionInProgress:r,pendingCelebrations:a,addPendingCelebration:o,consumePendingCelebration:l,clearAllPending:c}),[s,a,o,l,c]);return e.jsx(eu.Provider,{value:d,children:t})},Qg=()=>{const t=n.useContext(eu);if(t===void 0)throw new Error("useCelebration must be used within a CelebrationProvider");return t},tu=2;function su(t){const s=new Date,r=Intl.DateTimeFormat().resolvedOptions().timeZone;if(parseInt(new Intl.DateTimeFormat("en-US",{hour:"numeric",hour12:!1,timeZone:r}).format(s))<tu){const i=new Date(s);return i.setDate(i.getDate()-1),zo(i,r)}return zo(s,r)}function Kg(t){const s=new Date,r=Intl.DateTimeFormat().resolvedOptions().timeZone,a=parseInt(new Intl.DateTimeFormat("en-US",{hour:"numeric",hour12:!1,timeZone:r}).format(s)),i=new Intl.DateTimeFormat("en-US",{weekday:"short",timeZone:r});let o=s;a<tu&&(o=new Date(s),o.setDate(o.getDate()-1));const l=i.format(o);return{Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6}[l]??0}function zo(t,s){return new Intl.DateTimeFormat("en-CA",{year:"numeric",month:"2-digit",day:"2-digit",timeZone:s}).format(t)}function Wg(){return Intl.DateTimeFormat().resolvedOptions().timeZone}const si=[0,250,750,1500],Gg=4e3,ru=n.createContext(void 0),Yg=t=>new Promise(s=>{window.setTimeout(s,t)}),Vg=({children:t})=>{const s=Ae(),[r,a]=n.useState(null),[i,o]=n.useState(null),[l,c]=n.useState("loading"),d=n.useRef(null),m=n.useRef("loading"),p=n.useRef(null),h=n.useRef(null),f=n.useRef(0);n.useEffect(()=>{d.current=i},[i]),n.useEffect(()=>{m.current=l},[l]);const u=n.useCallback((C,_)=>{o(C),a(C?.user??null),c(_??(C?.user?"authenticated":"unauthenticated"))},[]),g=n.useCallback(async C=>{try{const _=Wg();await S.from("profiles").update({timezone:_}).eq("id",C)}catch(_){console.error("Failed to save timezone:",_)}},[]),y=n.useCallback(async()=>{await s.refetchQueries({queryKey:["profile"]}),await Promise.all([s.invalidateQueries({queryKey:["mentor-page-data"]}),s.invalidateQueries({queryKey:["mentor-personality"]}),s.invalidateQueries({queryKey:["mentor"]}),s.invalidateQueries({queryKey:["selected-mentor"]})])},[s]),b=n.useCallback(async()=>{s.clear(),Ii.removeItem("initialRouteRedirected");try{await S.removeAllChannels()}catch(C){console.error("Failed to remove realtime channels:",C)}},[s]),v=n.useCallback(async()=>{if(p.current)return p.current;const C=d.current;c(N=>N==="loading"?"loading":"recovering");const _=(async()=>{let N=null,E,k=!1;for(let P=0;P<si.length;P+=1){const T=si[P];T>0&&await Yg(T);const{data:{session:I},error:R}=await S.auth.getSession();if(R){N=R;continue}if(k=!0,E=I??null,I?.user||!C?.user||P>=si.length-1)break}if(E?.user){u(E,"authenticated"),g(E.user.id);return}if(k){u(null,"unauthenticated");return}if(console.error("Failed to refresh session:",N),C?.user){c("recovering");return}u(null,"unauthenticated")})().finally(()=>{p.current=null});return p.current=_,_},[u,g]),x=n.useCallback(async()=>{if(h.current)return h.current;const C=(async()=>{let _=null;try{await S.auth.signOut()}catch(N){_=N}if(await b(),u(null,"unauthenticated"),_)throw console.error("Sign out error:",_),_})().finally(()=>{h.current=null});return h.current=C,C},[u,b]);n.useEffect(()=>{v()},[v]),n.useEffect(()=>{const{data:{subscription:C}}=S.auth.onAuthStateChange((_,N)=>{u(N,N?.user?"authenticated":"unauthenticated"),N?.user&&(_==="SIGNED_IN"||_==="TOKEN_REFRESHED"||_==="INITIAL_SESSION")&&g(N.user.id),(_==="SIGNED_IN"||_==="TOKEN_REFRESHED")&&setTimeout(()=>{y().catch(E=>{console.error("Auth sync refresh failed:",E)})},0),_==="SIGNED_OUT"&&b()});return()=>{C.unsubscribe()}},[u,b,g,y]);const w=n.useCallback(()=>{if(m.current==="loading"||m.current==="unauthenticated")return;const C=Date.now();C-f.current<Gg||(f.current=C,v())},[v]);n.useEffect(()=>{if(!nt.isNativePlatform())return;let C=!1,_=null;return(async()=>{const E=await Dr.addListener("appStateChange",({isActive:k})=>{k&&w()});if(C){await E.remove();return}_=E})(),()=>{C=!0,_&&_.remove()}},[w]),n.useEffect(()=>{if(nt.isNativePlatform())return;const C=()=>{document.visibilityState==="visible"&&w()};return document.addEventListener("visibilitychange",C),()=>document.removeEventListener("visibilitychange",C)},[w]);const j=l==="loading"||l==="recovering",D=n.useMemo(()=>({user:r,session:i,status:l,loading:j,signOut:x,refreshSession:v}),[j,v,i,x,l,r]);return n.createElement(ru.Provider,{value:D},t)},be=()=>{const t=n.useContext(ru);if(!t)throw new Error("useAuth must be used within AuthProvider");return t},Xg=5,An=()=>{const{user:t}=be(),{data:s,isLoading:r}=Ee({queryKey:["companion-care-signals",t?.id],queryFn:async()=>{if(!t?.id)return null;const{data:i,error:o}=await S.from("user_companion").select(`
          care_consistency,
          care_responsiveness,
          care_balance,
          care_intent,
          care_recovery,
          care_pattern,
          evolution_path,
          evolution_path_locked,
          path_determination_date,
          dormant_since,
          dormancy_count,
          dormancy_recovery_days,
          inactive_days,
          bond_level,
          total_interactions,
          last_interaction_at
        `).eq("user_id",t.id).maybeSingle();if(o)throw console.error("Failed to fetch care signals:",o),o;return i},enabled:!!t?.id,staleTime:6e4});return{care:n.useMemo(()=>{const i={consistency:s?.care_consistency??.5,responsiveness:s?.care_responsiveness??.5,balance:s?.care_balance??.5,intent:s?.care_intent??.5,recovery:s?.care_recovery??.5},o=i.consistency*.3+i.responsiveness*.15+i.balance*.2+i.intent*.2+i.recovery*.15,l={path:s?.evolution_path??null,isLocked:s?.evolution_path_locked??!1,determinedAt:s?.path_determination_date??null},c=s?.dormant_since,d=!!c,m=s?.dormancy_recovery_days??0,p=s?.inactive_days??0,u=!d&&p>=5?Math.max(1,7-p):null,g={isDormant:d,dormantSince:c??null,dormancyCount:s?.dormancy_count??0,recoveryDays:m,daysUntilWake:d?Math.max(0,Xg-m):0,inactiveDays:p,daysUntilDormancy:u},y={level:s?.bond_level??0,totalInteractions:s?.total_interactions??0,lastInteractionAt:s?.last_interaction_at??null},v=s?.care_pattern?.dormancy_warning===!0;let x="content";return d?x="silent":o>.8?x="joyful":o>.6?x="content":o>.4?x="neutral":o>.2?x="reserved":x="quiet",{careSignals:i,overallCare:o,evolutionPath:l,dormancy:g,bond:y,hasDormancyWarning:v,dialogueTone:x}},[s]),isLoading:r}},Jg=t=>{switch(t){case"steady_guardian":return{name:"Steady Guardian",description:"Your consistent care has shaped a calm, protective companion.",icon:"ðŸ›¡ï¸",color:"text-amber-400",bgColor:"bg-amber-500/10",borderColor:"border-amber-500/30"};case"volatile_ascendant":return{name:"Volatile Ascendant",description:"Your intense but erratic energy has forged a powerful, passionate companion.",icon:"âš¡",color:"text-purple-400",bgColor:"bg-purple-500/10",borderColor:"border-purple-500/30"};case"neglected_wanderer":return{name:"Neglected Wanderer",description:"Time apart has made your companion independent but distant.",icon:"ðŸŒ™",color:"text-slate-400",bgColor:"bg-slate-500/10",borderColor:"border-slate-500/30"};case"balanced_architect":return{name:"Balanced Architect",description:"Perfect harmony in your care has awakened a rare, transcendent form.",icon:"âœ¨",color:"text-cyan-400",bgColor:"bg-cyan-500/10",borderColor:"border-cyan-500/30"};default:return{name:"Forming",description:"Your care patterns are still being observed...",icon:"ðŸŒ€",color:"text-muted-foreground",bgColor:"bg-muted/10",borderColor:"border-muted/30"}}},au={mood:"neutral",auraHue:45,auraOpacity:0,particleEffect:"none",particleCount:0,pulseRate:1,isPresent:!1,evolutionPath:null,needsAttention:!1,overallCare:.5},nu=n.createContext({presence:au,isLoading:!0}),Zg={steady_guardian:45,volatile_ascendant:280,neglected_wanderer:210,balanced_architect:180},ex={joyful:{particleEffect:"sparkle",particleCount:[6,8],opacity:[.04,.06]},content:{particleEffect:"gentle",particleCount:[4,6],opacity:[.03,.05]},neutral:{particleEffect:"gentle",particleCount:[3,4],opacity:[.02,.03]},reserved:{particleEffect:"minimal",particleCount:[2,3],opacity:[.01,.02]},quiet:{particleEffect:"minimal",particleCount:[1,2],opacity:[.005,.01]},dormant:{particleEffect:"none",particleCount:[0,0],opacity:[0,0]}},iu=n.memo(({children:t})=>{const{user:s}=be(),{care:r,isLoading:a}=An(),i=n.useMemo(()=>{if(!s||a)return au;const{overallCare:l,evolutionPath:c,dormancy:d,hasDormancyWarning:m,dialogueTone:p}=r,h=["joyful","content","neutral","reserved","quiet","dormant"],f=p,u=d.isDormant?"dormant":h.includes(f)?f:"neutral",g=c.path?Zg[c.path]??45:45,y=ex[u],[b,v]=y.opacity,x=b+(v-b)*l,[w,j]=y.particleCount,D=Math.round(w+(j-w)*l),C=.7+l*.6;return{mood:u,auraHue:g,auraOpacity:x,particleEffect:y.particleEffect,particleCount:D,pulseRate:C,isPresent:!d.isDormant,evolutionPath:c.path,needsAttention:m||l<.3,overallCare:l}},[s,a,r]),o=n.useMemo(()=>({presence:i,isLoading:a}),[i,a]);return e.jsx(nu.Provider,{value:o,children:t})});iu.displayName="CompanionPresenceProvider";const Rn=()=>{const t=n.useContext(nu);if(!t)throw new Error("useCompanionPresence must be used within CompanionPresenceProvider");return t},Qo=t=>{try{return t.startsWith("cosmiq://task/")?{type:"task",taskId:t.replace("cosmiq://task/","").split("?")[0],rawUrl:t}:{type:"unknown",rawUrl:t}}catch(s){return oe.error("[DeepLink] Failed to parse URL:",s),{type:"unknown",rawUrl:t}}},tx=t=>{if(!nt.isNativePlatform())return()=>{};let s=null;return Dr.getLaunchUrl().then(r=>{if(r?.url){oe.log("[DeepLink] App launched with URL:",r.url);const a=Qo(r.url);t(a)}}),Dr.addListener("appUrlOpen",r=>{oe.log("[DeepLink] App URL opened:",r.url);const a=Qo(r.url);t(a)}).then(r=>{s=r}),()=>{s?.remove()}},ou=n.createContext({pendingTaskId:null,clearPendingTask:()=>{}}),sx=()=>n.useContext(ou),rx=({children:t})=>{const[s,r]=n.useState(null),a=n.useCallback(o=>{oe.log("[DeepLinkProvider] Received deep link:",o),o.type==="task"&&o.taskId&&(r(o.taskId),window.dispatchEvent(new CustomEvent("deep-link-navigation",{detail:{path:"/journeys",taskId:o.taskId}})))},[]),i=n.useCallback(()=>{r(null)},[]);return n.useEffect(()=>tx(a),[a]),e.jsx(ou.Provider,{value:{pendingTaskId:s,clearPendingTask:i},children:t})},Yt=()=>{const{user:t}=be(),{data:s,isLoading:r,error:a,refetch:i}=Ee({queryKey:["profile",t?.id],queryFn:async()=>{if(!t)return null;const{data:o,error:l}=await S.from("profiles").select("*").eq("id",t.id).maybeSingle();if(l)throw console.error("Error fetching profile:",l),l;if(!o){const{data:c,error:d}=await S.from("profiles").upsert({id:t.id,email:t.email??null},{onConflict:"id",ignoreDuplicates:!1}).select("*").maybeSingle();if(d)throw console.error("Error creating profile:",d),d;if(!c)throw new Error("Failed to create profile");return c}return o},enabled:!!t,staleTime:120*1e3,refetchOnWindowFocus:!1});return{profile:s??null,loading:r,error:a,refetch:i}},ax=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i,lu=t=>typeof t=="object"&&t!==null&&!Array.isArray(t),cu=t=>{if(!t||!lu(t.onboarding_data))return null;const s=t.onboarding_data.mentorId;if(typeof s!="string")return null;const r=s.trim();return r&&ax.test(r)?r:null},nx=t=>{if(!lu(t))return{};const{mentorId:s,...r}=t;return r},ix=t=>{if(!t)return!1;if(t.code==="23503")return!0;const s=`${t.message??""} ${t.details??""}`.toLowerCase();return s.includes("profiles_selected_mentor_id_fkey")||s.includes("foreign key")},Br=t=>{if(!t)return null;if(t.selected_mentor_id)return t.selected_mentor_id;const s=cu(t);return!s||t.onboarding_completed===!0?null:s},ox=["active","cancelled","past_due","trialing","incomplete"],lx=["monthly","yearly"];function Ko(t){return typeof t=="string"&&ox.includes(t)}function Wo(t){return typeof t=="string"&&lx.includes(t)}function cx(){const{user:t,loading:s}=be(),{data:r,isLoading:a,error:i,refetch:o}=Ee({queryKey:["subscription",t?.id],queryFn:async()=>{if(!t)return null;const{data:f,error:u}=await S.functions.invoke("check-apple-subscription");if(u)throw u;return f},enabled:!!t,staleTime:300*1e3,refetchInterval:!1}),l=s||!!t&&a,c=n.useMemo(()=>{if(!r||!r.subscribed)return null;const f=Ko(r.status)?r.status:"incomplete",u=Wo(r.plan)?r.plan:"monthly";return Ko(r.status)||oe.warn(`Unexpected subscription status: ${r.status}`),r.plan&&!Wo(r.plan)&&oe.warn(`Unexpected subscription plan: ${r.plan}`),{status:f,plan:u,current_period_end:r.subscription_end}},[r]),d=r?.subscribed||!1,m=c?.status==="cancelled",p=n.useMemo(()=>c?.current_period_end?new Date(c.current_period_end):null,[c?.current_period_end]),h=n.useMemo(()=>c?.plan==="yearly"?"$59.99/year":"$9.99/month",[c?.plan]);return{subscription:c,isLoading:l,error:i,refetch:o,isActive:d,isCancelled:m,hasPremium:d,nextBillingDate:p,planPrice:h,plan:c?.plan}}function dx(){const{profile:t,loading:s}=Yt(),{isActive:r,isLoading:a}=cx();return n.useMemo(()=>{if(s||a||!t)return{hasAccess:!0,isSubscribed:!1,isInTrial:!1,trialExpired:!1,trialDaysRemaining:0,accessSource:"none",trialEndsAt:null,loading:!0};let o=null;return t.trial_ends_at?o=new Date(t.trial_ends_at):t.created_at&&(o=new Date(new Date(t.created_at).getTime()+10080*60*1e3)),{hasAccess:!0,isSubscribed:r,isInTrial:!1,trialExpired:!1,trialDaysRemaining:0,accessSource:r?"subscription":"none",trialEndsAt:o,loading:!1}},[t,s,r,a])}const Hs=n.forwardRef(({className:t,value:s,...r},a)=>e.jsx(Mc,{ref:a,className:A("relative h-2 w-full overflow-hidden rounded-full bg-secondary/50",t),...r,children:e.jsx(nh,{className:"h-full w-full flex-1 bg-gradient-to-r from-primary to-accent transition-all duration-500 ease-out shadow-glow",style:{transform:`translateX(-${100-(s||0)}%)`}})}));Hs.displayName=Mc.displayName;const _a=Hr("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-[14px] text-sm font-semibold ring-offset-background transition-colors duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 active:scale-[0.985]",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-[0_10px_20px_hsl(var(--primary)/0.28)] hover:bg-primary/92 active:bg-primary/88",destructive:"bg-destructive text-destructive-foreground shadow-[0_10px_20px_hsl(var(--destructive)/0.25)] hover:bg-destructive/92 active:bg-destructive/88",outline:"border border-border/70 bg-card/70 text-foreground hover:bg-card/90",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/85",ghost:"text-foreground/85 hover:bg-foreground/5 hover:text-foreground",link:"text-royal-purple underline-offset-4 hover:underline",cta:"bg-gradient-to-r from-royal-purple via-accent-purple to-nebula-pink text-pure-white shadow-[0_12px_24px_hsl(var(--royal-purple)/0.32)] hover:brightness-105",gradient:"bg-gradient-to-r from-primary to-accent text-pure-white shadow-[0_12px_24px_hsl(var(--primary)/0.25)] hover:brightness-105",accent:"bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-[0_10px_20px_hsl(28_96%_56%/0.3)] hover:brightness-105"},size:{default:"h-11 px-4",sm:"h-9 rounded-[12px] px-3 text-xs",lg:"h-12 rounded-[16px] px-6 text-base",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),U=n.forwardRef(({className:t,variant:s,size:r,asChild:a=!1,...i},o)=>{const l=a?ih:"button";return e.jsx(l,{className:A(_a({variant:s,size:r,className:t})),ref:o,...i})});U.displayName="Button";const We=n.forwardRef(({className:t,...s},r)=>e.jsx("div",{ref:r,className:A("rounded-2xl border text-card-foreground","bg-card/78 backdrop-blur-lg","border-border/60","shadow-[0_12px_28px_rgba(0,0,0,0.22)]","transition-colors duration-200",t),...s}));We.displayName="Card";const ux=n.forwardRef(({className:t,...s},r)=>e.jsx("div",{ref:r,className:A("flex flex-col space-y-1.5 p-4 sm:p-6",t),...s}));ux.displayName="CardHeader";const mx=n.forwardRef(({className:t,...s},r)=>e.jsx("h3",{ref:r,className:A("text-xl sm:text-2xl font-semibold leading-none tracking-tight",t),...s}));mx.displayName="CardTitle";const px=n.forwardRef(({className:t,...s},r)=>e.jsx("p",{ref:r,className:A("text-sm text-muted-foreground",t),...s}));px.displayName="CardDescription";const oo=n.forwardRef(({className:t,...s},r)=>e.jsx("div",{ref:r,className:A("p-4 sm:p-6 pt-0",t),...s}));oo.displayName="CardContent";const hx=n.forwardRef(({className:t,...s},r)=>e.jsx("div",{ref:r,className:A("flex items-center p-4 sm:p-6 pt-0",t),...s}));hx.displayName="CardFooter";const Qs={MONTHLY:"cosmiq_premium_monthly",YEARLY:"cosmiq_premium_yearly"},ds=()=>nt.isNativePlatform()&&nt.getPlatform()==="ios",fx=async t=>{if(!ds())throw new Error("In-App Purchases are only available on iOS");try{return await _n.purchaseProduct({productIdentifier:t})}catch(s){throw console.error("Purchase failed:",s),s}},gx=async()=>{if(!ds())throw new Error("In-App Purchases are only available on iOS");try{return(await _n.restorePurchases())?.purchases||[]}catch(t){throw console.error("Restore failed:",t),t}},xx=async t=>{if(console.log("[IAP DEBUG] getProducts called with:",t),console.log("[IAP DEBUG] isIAPAvailable:",ds()),console.log("[IAP DEBUG] Platform:",nt.getPlatform()),console.log("[IAP DEBUG] isNative:",nt.isNativePlatform()),!ds())return console.log("[IAP DEBUG] IAP not available, returning empty array"),[];try{console.log("[IAP DEBUG] Calling NativePurchases.getProducts...");const s=await _n.getProducts({productIdentifiers:t});console.log("[IAP DEBUG] Raw result from NativePurchases:",JSON.stringify(s,null,2));const r=s?.products||[];return console.log("[IAP DEBUG] Parsed products count:",r.length),console.log("[IAP DEBUG] Parsed products:",JSON.stringify(r,null,2)),r}catch(s){return console.error("[IAP DEBUG] Get products failed:",s),console.error("[IAP DEBUG] Error details:",JSON.stringify(s,Object.getOwnPropertyNames(s))),[]}},yx=async()=>{if(ds()){await _n.manageSubscriptions();return}window.open("https://apps.apple.com/account/subscriptions","_blank")},Go="Premium subscriptions are temporarily unavailable. Please try again later.";function bx(){const t=Ae(),{toast:s}=Ms(),[r,a]=n.useState(!1),[i,o]=n.useState([]),[l,c]=n.useState(!1),[d,m]=n.useState(null),[p,h]=n.useState(!1),[f,u]=n.useState(!1),g=n.useCallback(async()=>{if(console.log("[HOOK DEBUG] fetchProducts called"),console.log("[HOOK DEBUG] IAP_PRODUCTS:",JSON.stringify(Qs)),console.log("[HOOK DEBUG] isIAPAvailable:",ds()),!ds())return console.log("[HOOK DEBUG] IAP not available, setting error"),o([]),m("In-App Purchases are only available on iOS devices"),h(!0),[];c(!0),m(null);try{console.log("[HOOK DEBUG] About to call getProducts...");const w=await xx(Object.values(Qs));if(console.log("[HOOK DEBUG] getProducts returned:",w.length,"products"),console.log("[HOOK DEBUG] Products:",JSON.stringify(w)),!w.length)throw console.log("[HOOK DEBUG] No products returned, throwing error"),new Error("No App Store products were returned");return o(w),console.log("[HOOK DEBUG] Products set successfully"),w}catch(w){return console.error("[HOOK DEBUG] Product load error:",w),o([]),m(Go),[]}finally{c(!1),h(!0),console.log("[HOOK DEBUG] fetchProducts complete")}},[]);n.useEffect(()=>{g()},[g]);const y=n.useCallback(async()=>{if(console.log("[ENSURE DEBUG] ensureProductsAvailable called"),console.log("[ENSURE DEBUG] hasAttemptedProductFetch:",p),console.log("[ENSURE DEBUG] products.length:",i.length),!p||i.length===0){console.log("[ENSURE DEBUG] Condition met - calling fetchProducts()");const w=await g();console.log("[ENSURE DEBUG] fetchProducts returned:",w.length,"products");const j=w.length?w:null;return console.log("[ENSURE DEBUG] Returning:",j?"products":"NULL"),j}return console.log("[ENSURE DEBUG] Using existing products:",i.length),i},[g,p,i]);return{handlePurchase:async w=>{if(console.log("[PURCHASE DEBUG] ========== handlePurchase START =========="),console.log("[PURCHASE DEBUG] productId:",w),console.log("[PURCHASE DEBUG] isIAPAvailable():",ds()),console.log("[PURCHASE DEBUG] Current products state:",i.length),console.log("[PURCHASE DEBUG] hasAttemptedProductFetch:",p),!ds())return console.log("[PURCHASE DEBUG] IAP not available - returning false"),s({title:"Not Available",description:"In-App Purchases are only available on iOS devices",variant:"destructive"}),!1;a(!0);try{console.log("[PURCHASE DEBUG] Calling ensureProductsAvailable...");const j=await y();if(console.log("[PURCHASE DEBUG] ensureProductsAvailable returned:",j?j.length+" products":"NULL"),!j)return s({title:"Unavailable",description:Go,variant:"destructive"}),!1;console.log("[HOOK DEBUG] Checking productId:",w),console.log("[HOOK DEBUG] Available identifiers:",j.map(k=>k.identifier));const D=j.some(k=>k.identifier===w);if(console.log("[HOOK DEBUG] productExists result:",D),!D)return s({title:"Unavailable",description:"Selected premium plan is not ready yet. Please try again in a moment.",variant:"destructive"}),!1;const C=await fx(w);if(console.log("[IAP] Purchase response:",JSON.stringify(C,null,2)),!C)throw new Error("Purchase returned no data");const _=C.transactionId,N=C.receipt??C.transactionReceipt;if(console.log("[IAP] Verification payload:",{transactionId:!!_,receipt:!!N}),!_&&!N)throw new Error("No transaction ID or receipt data available");const{error:E}=await S.functions.invoke("verify-apple-receipt",{body:_?{transactionId:_}:{receipt:N}});if(E)throw E;return await t.invalidateQueries({queryKey:["subscription"]}),s({title:"Success!",description:"Your subscription is now active"}),!0}catch(j){console.error("Purchase error:",j);const D=j instanceof Error?j.message:"Please try again";return s({title:"Purchase Failed",description:D,variant:"destructive"}),!1}finally{a(!1)}},handleRestore:async()=>{if(!ds()){s({title:"Not Available",description:"In-App Purchases are only available on iOS devices",variant:"destructive"});return}a(!0);try{const w=await gx();if(!w||!Array.isArray(w)||w.length===0){s({title:"No Purchases Found",description:"No previous purchases to restore"});return}const j=k=>typeof k=="object"&&k!==null,C=[...w].filter(j).sort((k,P)=>{const T=k.transactionDate||0;return(P.transactionDate||0)-T}).find(k=>k.productId?.includes("premium"));if(!C){s({title:"No Subscription Found",description:"No active subscription to restore"});return}const _=C.transactionId,N=C.transactionReceipt??C.receipt;if(!_&&!N)throw new Error("No transaction ID or receipt data available for subscription");const{error:E}=await S.functions.invoke("verify-apple-receipt",{body:_?{transactionId:_}:{receipt:N}});if(E)throw E;await t.invalidateQueries({queryKey:["subscription"]}),s({title:"Restored!",description:"Your subscription has been restored"})}catch(w){console.error("Restore error:",w);const j=w instanceof Error?w.message:"Please try again";s({title:"Restore Failed",description:j,variant:"destructive"})}finally{a(!1)}},handleManageSubscriptions:async()=>{u(!0);try{await yx(),s({title:"Manage Subscription",description:"Opening Apple's subscription settings..."})}catch(w){console.error("Manage subscription error:",w);const j=w instanceof Error?w.message:"Please try again";s({title:"Unable to open subscriptions",description:j,variant:"destructive"})}finally{u(!1)}},loading:r,manageLoading:f,products:i,productsLoading:l,productError:d,hasLoadedProducts:p,reloadProducts:g,isAvailable:ds()}}const Aa=lh,bk=ch,vx=oh,du=n.forwardRef(({className:t,...s},r)=>e.jsx(Dc,{className:A("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...s,ref:r}));du.displayName=Dc.displayName;const Ur=n.forwardRef(({className:t,...s},r)=>e.jsxs(vx,{children:[e.jsx(du,{}),e.jsx(Pc,{ref:r,className:A("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",t),...s})]}));Ur.displayName=Pc.displayName;const zr=({className:t,...s})=>e.jsx("div",{className:A("flex flex-col space-y-2 text-center sm:text-left",t),...s});zr.displayName="AlertDialogHeader";const Qr=({className:t,...s})=>e.jsx("div",{className:A("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...s});Qr.displayName="AlertDialogFooter";const Kr=n.forwardRef(({className:t,...s},r)=>e.jsx(Ac,{ref:r,className:A("text-lg font-semibold",t),...s}));Kr.displayName=Ac.displayName;const Wr=n.forwardRef(({className:t,...s},r)=>e.jsx(Rc,{ref:r,className:A("text-sm text-muted-foreground",t),...s}));Wr.displayName=Rc.displayName;const or=n.forwardRef(({className:t,...s},r)=>e.jsx(Ic,{ref:r,className:A(_a(),t),...s}));or.displayName=Ic.displayName;const Gr=n.forwardRef(({className:t,...s},r)=>e.jsx(Lc,{ref:r,className:A(_a({variant:"outline"}),"mt-2 sm:mt-0",t),...s}));Gr.displayName=Lc.displayName;const ot=n.forwardRef(({className:t,type:s,...r},a)=>e.jsx("input",{type:s,className:A("flex h-11 sm:h-12 w-full rounded-lg border border-input bg-secondary/50 px-3 sm:px-4 py-2 text-sm sm:text-base font-medium text-foreground ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground/70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:border-primary disabled:cursor-not-allowed disabled:opacity-50 transition-all touch-manipulation",t),ref:a,...r}));ot.displayName="Input";const wx=()=>{const[t,s]=n.useState("yearly"),[r,a]=n.useState(!1),[i,o]=n.useState(""),[l,c]=n.useState(!1),[d,m]=n.useState(!1),{handlePurchase:p,handleRestore:h,loading:f,isAvailable:u,products:g,productsLoading:y,productError:b,reloadProducts:v,hasLoadedProducts:x}=bx(),{toast:w}=Ms(),{signOut:j}=be(),D=as(),C=n.useMemo(()=>g.reduce((I,R)=>(I[R.identifier]=R,I),{}),[g]),_=t==="yearly"?Qs.YEARLY:Qs.MONTHLY,N=C[_],E=async()=>{if(!N){w({title:"Almost ready",description:"We're still fetching Apple pricing details. Please try again in a moment.",variant:"destructive"});return}const I=t==="yearly"?Qs.YEARLY:Qs.MONTHLY;await p(I)},k=async()=>{m(!0);try{await j(),D("/auth")}catch{w({title:"Error",description:"Failed to sign out. Please try again.",variant:"destructive"})}finally{m(!1)}},P=async()=>{if(i!=="DELETE"){w({title:"Confirmation required",description:"Please type DELETE to confirm account deletion.",variant:"destructive"});return}c(!0);try{const{data:{session:I}}=await S.auth.getSession();if(!I?.access_token)throw new Error("No active session");const{error:R}=await S.functions.invoke("delete-user",{headers:{Authorization:`Bearer ${I.access_token}`}});if(R)throw R;await j(),D("/auth"),w({title:"Account deleted",description:"Your account has been permanently deleted."})}catch(I){console.error("Delete account error:",I),w({title:"Error",description:"Failed to delete account. Please try again.",variant:"destructive"})}finally{c(!1),a(!1),o("")}},T={monthly:{fallbackPrice:"$9.99",period:"/month",savings:null},yearly:{fallbackPrice:"$59.99",period:"/year",savings:"Save 50%"}};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-background flex flex-col items-center justify-center p-6 overflow-y-auto",children:[e.jsxs("div",{className:"w-full max-w-md space-y-6",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-primary to-accent shadow-glow",children:e.jsx(Po,{className:"h-10 w-10 text-primary-foreground"})}),e.jsx("h1",{className:"font-display text-3xl text-foreground",children:"Your Free Trial Has Ended"}),e.jsx("p",{className:"text-muted-foreground",children:"Subscribe to continue your journey with your companion"})]}),e.jsx("div",{className:"flex gap-3",children:["monthly","yearly"].map(I=>e.jsxs(We,{onClick:()=>s(I),className:A("flex-1 cursor-pointer transition-all relative overflow-hidden",t===I?"border-2 border-primary bg-primary/5 shadow-glow":"border border-border hover:border-primary/50"),children:[T[I].savings&&e.jsx("div",{className:"absolute top-0 right-0 bg-accent text-accent-foreground text-xs font-bold px-2 py-1 rounded-bl-lg",children:T[I].savings}),e.jsxs(oo,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground capitalize mb-1",children:I}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:(I==="yearly"?C[Qs.YEARLY]?.price:C[Qs.MONTHLY]?.price)??T[I].fallbackPrice}),e.jsx("p",{className:"text-xs text-muted-foreground",children:T[I].period})]})]},I))}),e.jsx("div",{className:"space-y-3 py-2",children:[{icon:pe,text:"All 21 evolution stages"},{icon:Vi,text:"Unlimited mentor chat"},{icon:jn,text:"Unlimited Quests & Epics"},{icon:Po,text:"All premium features"}].map((I,R)=>e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsx(I.icon,{className:"h-5 w-5 text-primary flex-shrink-0"}),e.jsx("span",{className:"text-foreground",children:I.text})]},R))}),!u&&e.jsx("div",{className:"bg-muted/30 rounded-lg p-4",children:e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"In-App Purchases are only available on iOS devices"})}),y&&e.jsxs("div",{className:"flex items-center gap-2 rounded-lg border border-dashed border-muted-foreground/30 px-3 py-2 text-sm text-muted-foreground",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-muted-foreground"}),"Contacting the App Store..."]}),b&&e.jsxs("div",{className:"rounded-lg border border-destructive/40 bg-destructive/5 p-3 text-sm text-destructive flex flex-col gap-2",children:[e.jsx("span",{children:b}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(U,{size:"sm",variant:"outline",onClick:()=>{v()},children:"Try Again"}),e.jsx(U,{size:"sm",variant:"ghost",onClick:()=>w({title:"Need help?",description:"Please ensure you're signed in to the App Store and retry."}),children:"Contact support"})]})]}),e.jsx(U,{onClick:E,disabled:f||!u||y||!x||!N,className:"w-full py-7 text-lg font-black uppercase tracking-wider bg-gradient-to-r from-primary to-accent hover:opacity-90 text-primary-foreground shadow-glow",size:"lg",children:f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary-foreground mr-2"}),"Processing..."]}):`Subscribe ${t==="yearly"?"Yearly":"Monthly"}`}),e.jsxs(U,{variant:"ghost",onClick:h,disabled:f,className:"w-full text-muted-foreground hover:text-foreground",children:[e.jsx(ir,{className:"h-4 w-4 mr-2"}),"Restore Purchases"]}),e.jsxs("p",{className:"text-xs text-center text-muted-foreground leading-relaxed",children:["Payment will be charged to your Apple ID account at confirmation of purchase. Subscription automatically renews unless canceled at least 24 hours before the end of the current period. Your account will be charged for renewal within 24 hours prior to the end of the current period. You can manage and cancel your subscriptions by going to Settings ",">"," [Your Name] ",">"," Subscriptions after purchase."]}),e.jsxs("div",{className:"flex justify-center gap-4 text-xs",children:[e.jsx("a",{href:"/privacy",className:"text-muted-foreground underline hover:text-foreground",children:"Privacy Policy"}),e.jsx("a",{href:"/terms",className:"text-muted-foreground underline hover:text-foreground",children:"Terms of Use"})]}),e.jsxs("div",{className:"relative flex items-center py-2",children:[e.jsx("div",{className:"flex-grow border-t border-muted"}),e.jsx("span",{className:"px-3 text-xs text-muted-foreground",children:"or"}),e.jsx("div",{className:"flex-grow border-t border-muted"})]}),e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsxs(U,{variant:"ghost",size:"sm",onClick:k,disabled:d,className:"text-muted-foreground hover:text-foreground",children:[d?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-1.5"}):e.jsx(dh,{className:"h-4 w-4 mr-1.5"}),"Sign Out"]}),e.jsxs(U,{variant:"ghost",size:"sm",onClick:()=>a(!0),className:"text-muted-foreground hover:text-destructive",children:[e.jsx($s,{className:"h-4 w-4 mr-1.5"}),"Delete Account"]})]})]}),e.jsx(Aa,{open:r,onOpenChange:a,children:e.jsxs(Ur,{children:[e.jsxs(zr,{children:[e.jsx(Kr,{children:"Delete your account?"}),e.jsxs(Wr,{className:"space-y-3",children:[e.jsx("p",{children:"This action is permanent and cannot be undone. All your data, including your companion, progress, and achievements will be permanently deleted."}),e.jsxs("p",{className:"font-medium text-foreground",children:["Type ",e.jsx("span",{className:"font-bold text-destructive",children:"DELETE"})," to confirm:"]}),e.jsx(ot,{value:i,onChange:I=>o(I.target.value),placeholder:"Type DELETE",className:"mt-2"})]})]}),e.jsxs(Qr,{children:[e.jsx(Gr,{disabled:l,children:"Cancel"}),e.jsx(or,{onClick:P,disabled:l||i!=="DELETE",className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:l?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2"}),"Deleting..."]}):"Delete Account"})]})]})})]})},jt=({children:t,requireMentor:s=!0})=>{const{user:r,loading:a,status:i}=be(),{hasAccess:o,loading:l}=dx(),c=as(),[d,m]=n.useState(0),p=i??(a?"loading":r?"authenticated":"unauthenticated"),h=a||p==="recovering"||p==="loading";return n.useEffect(()=>{!h&&p==="unauthenticated"&&c("/welcome",{replace:!0})},[p,h,c]),n.useEffect(()=>{let f;return h||l?f=setInterval(()=>{m(u=>u>=90?u:u+Math.random()*15)},300):m(100),()=>{f&&clearInterval(f)}},[l,h]),h||l?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"w-full max-w-md px-8 space-y-4",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"h-12 w-12 mx-auto rounded-full border-4 border-primary border-t-transparent animate-spin"}),e.jsx("p",{className:"text-foreground",children:"Loading..."})]}),e.jsx(Hs,{value:d,className:"w-full"})]})}):p==="unauthenticated"||!r?null:o?e.jsx(e.Fragment,{children:t}):e.jsx(wx,{})};class es extends n.Component{constructor(s){super(s),this.state={hasError:!1,error:null}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,r){console.error("ErrorBoundary caught an error:",s,r)}handleReset=()=>{this.setState({hasError:!1,error:null}),window.location.href="/"};render(){return this.state.hasError?this.props.fallback?this.props.fallback:e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-b from-background to-muted/20 p-4",children:e.jsxs(We,{className:"max-w-md w-full p-8 text-center",children:[e.jsx(Xs,{className:"h-16 w-16 text-destructive mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-heading font-bold text-foreground mb-2",children:"Something went wrong"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"We encountered an unexpected error. Don't worry, your data is safe."}),this.state.error&&e.jsxs("details",{className:"mb-6 text-left",children:[e.jsx("summary",{className:"cursor-pointer text-sm text-muted-foreground mb-2",children:"Technical details"}),e.jsx("pre",{className:"text-xs bg-muted p-3 rounded overflow-auto max-h-32",children:this.state.error.toString()})]}),e.jsx(U,{onClick:this.handleReset,className:"w-full",children:"Return to Home"})]})}):this.props.children}}const uu=({error:t,resetError:s,title:r="Something went wrong",description:a="We encountered an error loading this component."})=>e.jsx(We,{className:"p-6 border-destructive/50 bg-destructive/5",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:"rounded-full bg-destructive/10 p-3",children:e.jsx(cr,{className:"h-6 w-6 text-destructive"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:r}),e.jsx("p",{className:"text-sm text-muted-foreground max-w-md",children:a}),t&&e.jsxs("details",{className:"text-xs text-left mt-4",children:[e.jsx("summary",{className:"cursor-pointer text-muted-foreground hover:text-foreground",children:"Technical details"}),e.jsx("pre",{className:"mt-2 p-2 bg-muted rounded text-left overflow-auto max-w-md",children:t.message})]})]}),e.jsxs("div",{className:"flex gap-2",children:[s&&e.jsxs(U,{onClick:s,variant:"outline",size:"sm",children:[e.jsx(ir,{className:"h-4 w-4 mr-2"}),"Try Again"]}),e.jsx(U,{onClick:()=>window.location.reload(),variant:"default",size:"sm",children:"Reload Page"})]})]})}),_x=({error:t,resetError:s})=>e.jsx(uu,{error:t,resetError:s,title:"Missions Unavailable",description:"We couldn't load your daily missions. Don't worry, your progress is safe."}),jx=({error:t,onClose:s})=>e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-background/95 backdrop-blur-sm",children:e.jsx(We,{className:"p-8 max-w-md mx-4 border-destructive/50 bg-card",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:"rounded-full bg-destructive/10 p-4",children:e.jsx(cr,{className:"h-8 w-8 text-destructive"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-bold text-xl",children:"Evolution Error"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"We encountered an issue during evolution. Your companion's progress has been saved."}),t&&e.jsxs("details",{className:"text-xs text-left mt-4",children:[e.jsx("summary",{className:"cursor-pointer text-muted-foreground hover:text-foreground",children:"Technical details"}),e.jsx("pre",{className:"mt-2 p-2 bg-muted rounded text-left overflow-auto",children:t.message})]})]}),e.jsx(U,{onClick:s||(()=>window.location.reload()),size:"lg",className:"w-full",children:"Close"})]})})}),Nx=({error:t,resetError:s})=>e.jsx(uu,{error:t,resetError:s,title:"Check-in Unavailable",description:"We couldn't load the check-in form. Please try again in a moment."}),Yo={Fire:{name:"Inferno",glowA:"20, 100%, 55%",glowB:"35, 100%, 60%",particleStyle:"embers",confettiColors:["#FF6A3D","#FF9F1C","#FFD700","#FF4500"],confettiSpread:100,confettiGravity:.8,confettiParticleCount:150},Water:{name:"Tidal",glowA:"195, 90%, 55%",glowB:"210, 85%, 50%",particleStyle:"bubbles",confettiColors:["#4FC3F7","#29B6F6","#81D4FA","#B3E5FC"],confettiSpread:140,confettiGravity:.4,confettiParticleCount:120},Earth:{name:"Terran",glowA:"25, 40%, 45%",glowB:"100, 50%, 45%",particleStyle:"leaves",confettiColors:["#795548","#8BC34A","#4CAF50","#A1887F"],confettiSpread:90,confettiGravity:.9,confettiParticleCount:130},Air:{name:"Zephyr",glowA:"200, 80%, 80%",glowB:"190, 70%, 90%",particleStyle:"stardust",confettiColors:["#E3F2FD","#BBDEFB","#90CAF9","#E8F5E9"],confettiSpread:180,confettiGravity:.3,confettiParticleCount:100},Lightning:{name:"Storm",glowA:"50, 100%, 55%",glowB:"270, 70%, 60%",particleStyle:"sparks",confettiColors:["#FFD600","#FFFF00","#7C4DFF","#B388FF"],confettiSpread:120,confettiGravity:1,confettiParticleCount:160},Ice:{name:"Frost",glowA:"185, 70%, 70%",glowB:"190, 50%, 92%",particleStyle:"stardust",confettiColors:["#80DEEA","#B2EBF2","#E0F7FA","#FFFFFF"],confettiSpread:100,confettiGravity:.5,confettiParticleCount:130},Nature:{name:"Verdant",glowA:"120, 50%, 50%",glowB:"100, 50%, 70%",particleStyle:"leaves",confettiColors:["#66BB6A","#81C784","#A5D6A7","#DCEDC8"],confettiSpread:110,confettiGravity:.6,confettiParticleCount:140},Light:{name:"Radiant",glowA:"50, 100%, 75%",glowB:"0, 0%, 100%",particleStyle:"stardust",confettiColors:["#FFF59D","#FFEE58","#FFFFFF","#FFF9C4"],confettiSpread:150,confettiGravity:.4,confettiParticleCount:160},Shadow:{name:"Umbral",glowA:"270, 50%, 50%",glowB:"260, 60%, 25%",particleStyle:"sparks",confettiColors:["#7E57C2","#5E35B1","#9575CD","#D1C4E9"],confettiSpread:80,confettiGravity:.7,confettiParticleCount:120},Cosmic:{name:"Celestial",glowA:"285, 60%, 55%",glowB:"230, 50%, 40%",particleStyle:"stardust",confettiColors:["#AB47BC","#CE93D8","#5C6BC0","#7986CB"],confettiSpread:160,confettiGravity:.35,confettiParticleCount:180}},kx={name:"Hatch",glowA:"45, 100%, 60%",glowB:"35, 100%, 70%",particleStyle:"stardust",confettiColors:["#FFD700","#FFA500","#FFFACD","#FFE4B5","#F0E68C"],confettiSpread:140,confettiGravity:.6,confettiParticleCount:200},Cx={name:"Cosmic",glowA:"270, 70%, 55%",glowB:"280, 80%, 65%",particleStyle:"stardust",confettiColors:["#A76CFF","#C084FC","#E879F9","#FFD700"],confettiSpread:120,confettiGravity:.6,confettiParticleCount:150},Sx=(t,s)=>s?kx:t&&Yo[t]?Yo[t]:Cx,xr=oe.scope("CompanionEvolution"),Ex=({phase:t,particleStyle:s})=>{const r=n.useMemo(()=>Array.from({length:12},(a,i)=>({id:i,angle:i/12*Math.PI*2,startRadius:180})),[]);return t==="settle"?null:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:r.map(a=>e.jsx(M.div,{className:`absolute w-2 h-2 evo-particle evo-particle-${s}`,initial:{x:Math.cos(a.angle)*a.startRadius,y:Math.sin(a.angle)*a.startRadius,opacity:.3,scale:1},animate:{x:t==="impact"?0:Math.cos(a.angle)*60,y:t==="impact"?0:Math.sin(a.angle)*60,opacity:t==="impact"?0:.7,scale:t==="impact"?.2:.8},transition:{duration:t==="impact"?.6:1.2,ease:[.25,.1,.25,1]}},a.id))})},Tx=({phase:t,show:s})=>{if(!s)return null;const r=t==="anticipation"||t==="impact",a=t==="impact";return e.jsxs("div",{className:"absolute inset-0 pointer-events-none z-10 flex items-center justify-center",children:[e.jsx(M.div,{className:"absolute inset-0",initial:{opacity:.6},animate:{opacity:t==="reveal"||t==="settle"?0:.4},transition:{duration:.5},style:{background:"radial-gradient(ellipse 60% 70% at 50% 50%, transparent 40%, hsl(45, 50%, 15%) 100%)"}}),e.jsxs("svg",{className:"absolute w-full h-full",viewBox:"0 0 400 400",preserveAspectRatio:"xMidYMid slice",children:[e.jsx(M.path,{d:"M200 100 L210 150 L195 180 L205 220 L190 280",fill:"none",stroke:"hsl(50, 100%, 80%)",strokeWidth:"3",className:r?"evo-crack-path drawing":"evo-crack-path",initial:{opacity:0},animate:{opacity:r?1:0},style:{filter:"drop-shadow(0 0 8px hsl(50, 100%, 70%))"}}),e.jsx(M.path,{d:"M200 100 L185 155 L200 190 L180 240 L195 300",fill:"none",stroke:"hsl(50, 100%, 80%)",strokeWidth:"2",className:r?"evo-crack-path drawing delay-100":"evo-crack-path",initial:{opacity:0},animate:{opacity:r?1:0},style:{filter:"drop-shadow(0 0 6px hsl(50, 100%, 70%))"}}),e.jsx(M.path,{d:"M200 100 L220 140 L210 200 L230 260",fill:"none",stroke:"hsl(50, 100%, 80%)",strokeWidth:"2",className:r?"evo-crack-path drawing delay-150":"evo-crack-path",initial:{opacity:0},animate:{opacity:r?1:0},style:{filter:"drop-shadow(0 0 6px hsl(50, 100%, 70%))"}})]}),a&&e.jsx(M.div,{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-48 evo-seam-flash",style:{background:"linear-gradient(180deg, transparent 0%, hsl(50, 100%, 90%) 50%, transparent 100%)"}}),t==="impact"&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:Array.from({length:8}).map((i,o)=>e.jsx(M.div,{className:"absolute w-3 h-4 bg-gradient-to-br from-amber-100 to-amber-200 rounded-sm",initial:{x:0,y:0,rotate:0,opacity:1,scale:1},animate:{x:Math.cos(o/8*Math.PI*2)*140,y:Math.sin(o/8*Math.PI*2)*110+40,rotate:Math.random()*360,opacity:0,scale:.3},transition:{duration:1,ease:"easeOut",delay:o*.02}},o))})]})},Mx=({isEvolving:t,newStage:s,newImageUrl:r,mentorSlug:a,userId:i,element:o,onComplete:l})=>{const[c,d]=n.useState("anticipation"),[m,p]=n.useState(""),[h,f]=n.useState(!0),[u,g]=n.useState(!1),[y,b]=n.useState(!1),[v,x]=n.useState(!1),[w,j]=n.useState(!1),D=n.useRef(null),C=n.useRef(null),_=n.useRef(null),N=n.useRef([]),E=s===1,k=n.useMemo(()=>Sx(o,E),[o,E]),P=n.useMemo(()=>typeof window<"u"&&window.matchMedia("(prefers-reduced-motion: reduce)").matches,[]),T=n.useCallback(()=>{if(D.current)try{D.current.pause(),D.current.currentTime=0,D.current.src=""}catch(L){xr.error("Error cleaning up audio",{error:L})}finally{D.current=null}},[]);n.useEffect(()=>{if(!t||!r)return;x(!1);const L=new Image;L.src=r,L.onload=()=>x(!0),L.onerror=()=>x(!0);const $=setTimeout(()=>x(!0),2e3);return()=>clearTimeout($)},[t,r]),n.useEffect(()=>{if(!t||!v)return;let L=!0;return d("anticipation"),g(!1),Ig(),mt.light(),(async()=>{if(!a||!i){L&&f(!1);return}try{const{data:q,error:F}=await S.functions.invoke("generate-evolution-voice",{body:{mentorSlug:a,newStage:s,userId:i,isFirstEvolution:E}});if(F)throw F;if(!L)return;q?.voiceLine&&p(q.voiceLine),q?.audioContent&&(D.current=new Audio(`data:audio/mp3;base64,${q.audioContent}`)),f(!1)}catch(q){xr.error("Failed to generate evolution voice",{error:q}),L&&(p(E?"A new companion has hatched! Your journey together begins now.":"Your companion has evolved to a new stage!"),f(!1))}})(),_.current=window.setTimeout(()=>{L&&(xr.info("Evolution modal timeout reached, showing emergency exit"),b(!0))},15e3),N.current=[],N.current.push(setTimeout(()=>{L&&(d("impact"),mt.heavy(),C.current&&!P&&(C.current.classList.add("animate-evolution-pulse-hit"),setTimeout(()=>{C.current?.classList.remove("animate-evolution-pulse-hit")},600)))},1200)),N.current.push(setTimeout(()=>{L&&(d("reveal"),Lg(),D.current&&!h&&!Li.getMuted()&&D.current.play().catch(q=>xr.error("Audio play failed",{error:q})),P||setTimeout(()=>{Ot({particleCount:k.confettiParticleCount,spread:k.confettiSpread,origin:{y:.5},colors:k.confettiColors,ticks:400,gravity:k.confettiGravity,scalar:E?1.8:1.5}),mt.medium(),setTimeout(()=>{Ot({particleCount:50,spread:60,origin:{y:.7,x:.25},colors:k.confettiColors.slice(0,2)}),Ot({particleCount:50,spread:60,origin:{y:.7,x:.75},colors:k.confettiColors.slice(2)})},200)},100))},2200)),N.current.push(setTimeout(()=>{L&&(d("settle"),setTimeout(()=>{L&&g(!0)},800))},3600)),()=>{L=!1,N.current.forEach(clearTimeout),N.current=[],_.current&&(clearTimeout(_.current),_.current=null),T()}},[t,v,h,a,i,s,T,P,E,k]);const I=L=>{if(!u){L.preventDefault(),L.stopPropagation();return}T(),xr.debug("Dispatching evolution events and closing modal"),window.dispatchEvent(new CustomEvent("companion-evolved")),window.dispatchEvent(new CustomEvent("evolution-complete")),window.dispatchEvent(new CustomEvent("evolution-modal-closed")),l()},R=()=>{xr.info("Emergency exit triggered"),T(),_.current&&(clearTimeout(_.current),_.current=null),window.dispatchEvent(new CustomEvent("evolution-modal-closed")),l()};return t?v?e.jsx(Pe,{mode:"wait",children:t&&e.jsxs(M.div,{ref:C,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.5},role:"alertdialog","aria-labelledby":"evolution-title","aria-describedby":"evolution-description",className:`fixed inset-0 z-[9999] flex items-center justify-center overflow-hidden gpu-layer evo-card ${u?"cursor-pointer":""}`,onClick:I,onTouchStart:L=>!u&&L.preventDefault(),"data-particles":k.particleStyle,style:{pointerEvents:"auto",touchAction:u?"auto":"none",background:E?"radial-gradient(circle at center, rgba(50, 40, 0, 0.8) 0%, rgba(0, 0, 0, 0.95) 60%, black 100%)":"radial-gradient(circle at center, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0.95) 70%, black 100%)",paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)",paddingLeft:"env(safe-area-inset-left)",paddingRight:"env(safe-area-inset-right)","--evo-glow-a":k.glowA,"--evo-glow-b":k.glowB},children:[e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.6) 100%)"}}),(c==="reveal"||c==="settle")&&!P&&e.jsx(M.div,{className:"absolute inset-0 will-change-transform evo-glow",initial:{opacity:0,scale:.8},animate:{opacity:[.3,.5,.3],scale:[1,1.1,1]},transition:{duration:3,repeat:1/0,ease:"easeInOut"}}),!P&&e.jsx(Ex,{phase:c,particleStyle:k.particleStyle}),E&&e.jsx(Tx,{phase:c,show:c!=="settle"}),e.jsxs("div",{className:"flex flex-col items-center justify-center gap-6 max-w-4xl w-full px-6 relative z-10",children:[e.jsx(Pe,{mode:"wait",children:c==="anticipation"&&e.jsx(M.div,{initial:{opacity:0,scale:.9,filter:"blur(10px)"},animate:{opacity:1,scale:1,filter:"blur(0px)"},exit:{opacity:0,scale:1.05,filter:"blur(5px)"},transition:{duration:.6},className:"text-center will-change-transform",children:e.jsx("h2",{id:"evolution-title",className:"text-3xl sm:text-4xl md:text-5xl font-black text-white tracking-wider",style:{textShadow:`0 0 30px hsl(${k.glowA}), 0 0 60px hsl(${k.glowB} / 0.6)`},children:E?"Something Stirs Within...":"Evolution Awakens..."})},"prophetic-text")}),e.jsx(Pe,{children:(c==="reveal"||c==="settle")&&e.jsxs(M.div,{initial:{opacity:0,scale:.92,filter:"blur(12px)"},animate:{opacity:1,scale:1,filter:"blur(0px)"},transition:{duration:1,ease:[.22,1,.36,1]},className:"relative flex items-center justify-center will-change-transform",style:{width:"100%",maxWidth:"600px",height:"55vh",maxHeight:"450px"},children:[e.jsx(M.div,{className:"absolute inset-0 will-change-transform",animate:c==="settle"?{scale:[1,1.08,1],opacity:[.4,.6,.4]}:{},transition:{duration:3,repeat:1/0,ease:"easeInOut"},style:{background:`radial-gradient(circle, hsl(${k.glowA} / 0.35) 0%, transparent 70%)`,filter:"blur(30px)"}}),e.jsx(pe,{className:"absolute -top-4 -left-4 w-10 h-10 text-primary animate-pulse will-change-transform",style:{filter:"drop-shadow(0 0 12px currentColor)"}}),e.jsx(pe,{className:"absolute -top-4 -right-4 w-10 h-10 text-accent animate-pulse will-change-transform",style:{filter:"drop-shadow(0 0 12px currentColor)",animationDelay:"0.2s"}}),e.jsx(pe,{className:"absolute -bottom-4 -left-4 w-10 h-10 text-accent animate-pulse will-change-transform",style:{filter:"drop-shadow(0 0 12px currentColor)",animationDelay:"0.4s"}}),e.jsx(pe,{className:"absolute -bottom-4 -right-4 w-10 h-10 text-primary animate-pulse will-change-transform",style:{filter:"drop-shadow(0 0 12px currentColor)",animationDelay:"0.6s"}}),e.jsxs(M.div,{className:"relative rounded-2xl overflow-hidden will-change-transform",animate:c==="settle"?{scale:[1,1.01,1]}:{},transition:{duration:3,repeat:1/0,ease:"easeInOut"},style:{width:"100%",height:"100%",maxWidth:"520px",border:`3px solid hsl(${k.glowA} / 0.6)`,boxShadow:`0 0 40px hsl(${k.glowA} / 0.4), inset 0 0 30px hsl(${k.glowB} / 0.1)`},children:[!P&&e.jsx(M.div,{className:"absolute inset-0 pointer-events-none z-10",animate:{backgroundPosition:["200% 0%","-200% 0%"]},transition:{duration:2.5,repeat:1/0,ease:"linear"},style:{background:"linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.15) 50%, transparent 100%)",backgroundSize:"200% 100%"}}),e.jsx("img",{src:r,alt:"Evolved companion",className:"w-full h-full object-cover transition-opacity duration-300",style:{opacity:w?1:0},loading:"eager",onLoad:()=>j(!0)})]})]},"companion-wrapper")}),e.jsx(Pe,{children:(c==="reveal"||c==="settle")&&e.jsxs(M.div,{initial:{opacity:0,y:20,scale:.95},animate:{opacity:1,y:0,scale:1},transition:{type:"spring",stiffness:150,damping:18,delay:.2},className:"text-center space-y-3 will-change-transform",children:[e.jsx(M.h1,{className:"text-4xl sm:text-5xl md:text-6xl font-black uppercase tracking-tight",style:{background:E?"linear-gradient(135deg, #FFD700, #FFA500, #FFD700)":`linear-gradient(135deg, hsl(${k.glowA}), hsl(${k.glowB}), hsl(${k.glowA}))`,backgroundSize:"200% 200%",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",filter:`drop-shadow(0 0 20px hsl(${k.glowA} / 0.6))`},animate:{backgroundPosition:["0% 50%","100% 50%","0% 50%"]},transition:{duration:4,repeat:1/0,ease:"linear"},children:E?"Hatched!":"Evolved!"}),e.jsx("p",{id:"evolution-description",className:"text-lg sm:text-xl md:text-2xl font-semibold text-white/90",style:{textShadow:"0 0 15px rgba(255, 255, 255, 0.5)"},children:E?"Your companion has emerged!":"Your companion grows stronger!"}),c==="settle"&&m&&e.jsx(M.div,{initial:{opacity:0,y:15,scale:.95},animate:{opacity:1,y:0,scale:1},transition:{delay:.3,duration:.4},className:"max-w-lg mx-auto mt-5",children:e.jsx("div",{className:"relative p-5 rounded-xl bg-white/5 border border-white/20 backdrop-blur-md",style:{boxShadow:"0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.1)"},children:e.jsxs("p",{className:"text-base sm:text-lg text-white/95 font-medium italic leading-relaxed",children:['"',m,'"']})})})]},"announcement")}),e.jsx(Pe,{children:u&&!y&&e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},transition:{delay:.2},className:"absolute left-1/2 transform -translate-x-1/2",style:{bottom:"calc(1.5rem + env(safe-area-inset-bottom, 0px))"},children:e.jsx(M.p,{className:"text-white/90 text-base sm:text-lg font-medium",animate:{opacity:[.6,1,.6]},transition:{duration:2,repeat:1/0},children:"Tap anywhere to continue âœ¨"})})}),y&&e.jsx(M.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"absolute z-[10002]",style:{top:"calc(1rem + env(safe-area-inset-top, 0px))",right:"calc(1rem + env(safe-area-inset-right, 0px))"},children:e.jsx("button",{onClick:L=>{L.stopPropagation(),R()},className:"bg-destructive/90 hover:bg-destructive text-destructive-foreground font-bold px-4 py-2 rounded-lg shadow-lg transition-colors","aria-label":"Close evolution modal",children:"âœ• Close"})})]})]})}):e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/90",style:{paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)"},children:e.jsx(M.div,{animate:{scale:[1,1.1,1],opacity:[.5,1,.5]},transition:{duration:1.5,repeat:1/0},className:"text-primary text-xl font-medium",children:"Preparing evolution..."})}):null},Dx=t=>e.jsx(es,{fallback:e.jsx(jx,{onClose:t.onComplete}),children:e.jsx(Mx,{...t})}),Px=()=>{const{user:t}=be(),{profile:s}=Yt(),r=Ae(),{setIsEvolvingLoading:a,onEvolutionComplete:i}=Pn(),{setEvolutionInProgress:o}=Qg(),[l,c]=n.useState(!1),d=Br(s),[m,p]=n.useState(null),[,h]=n.useState(null);return n.useEffect(()=>{if(!t)return;const f=S.channel("companion-evolution").on("postgres_changes",{event:"UPDATE",schema:"public",table:"user_companion",filter:`user_id=eq.${t.id}`},async u=>{const g=u.new,y=u.old;if(!g||!y){oe.warn("Evolution listener: Missing payload data");return}const b=typeof g.current_stage=="number"?g.current_stage:null,v=typeof y.current_stage=="number"?y.current_stage:null;if(b===null||v===null){oe.warn("Evolution listener: Invalid stage values");return}if(b>v){const x=typeof g.id=="string"?g.id:null;if(!x){oe.warn("Evolution listener: Missing companion id");return}const[w,j]=await Promise.all([S.from("companion_evolutions").select("image_url").eq("companion_id",x).eq("stage",b).order("evolved_at",{ascending:!1}).limit(1).maybeSingle(),S.from("user_companion").select("core_element").eq("id",x).maybeSingle()]),D=typeof g.current_image_url=="string"?g.current_image_url:"",C=w.data?.image_url||D,_=j.data?.core_element||void 0;let N;if(d){const{data:P}=await S.from("mentors").select("slug").eq("id",d).maybeSingle();N=P?.slug}h(v),p({stage:b,imageUrl:C,mentorSlug:N,element:_}),c(!0),o(!0),window.dispatchEvent(new CustomEvent("evolution-loading-start"));const E=new Date().toISOString().split("T")[0],k=b===1;S.from("companion_memories").insert({user_id:t.id,companion_id:x,memory_type:k?"first_evolution":"evolution",memory_date:E,memory_context:{title:k?"First Evolution":`Evolved to Stage ${b}`,description:k?"The first transformation - proof of our growing bond.":`Another beautiful transformation, reaching stage ${b}.`,emotion:k?"pride":"joy",details:{stage:b,previousStage:v}},referenced_count:0}).then(({error:P})=>{P&&oe.error("Failed to create evolution memory:",P)}),t?.id&&r.invalidateQueries({queryKey:["companion",t.id]})}}).subscribe((u,g)=>{u==="SUBSCRIBED"||(u==="CHANNEL_ERROR"||u==="TIMED_OUT")&&oe.warn("Evolution listener subscription error",{status:u,error:g?.message})});return()=>{S.removeChannel(f)}},[t,t?.id,d,r,o]),!l||!m?null:e.jsx(Dx,{isEvolving:l,newStage:m.stage,newImageUrl:m.imageUrl,mentorSlug:m.mentorSlug,element:m.element,userId:t?.id,onComplete:()=>{c(!1),p(null),h(null),a(!1),o(!1),i&&i()}})},Ax=()=>{const{user:t}=be(),s=Ae();n.useEffect(()=>{if(!t?.id)return;const r=S.channel(`habits-sync-${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"habits",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["habits",t.id]}),s.invalidateQueries({queryKey:["habits"]}),s.invalidateQueries({queryKey:["habit-surfacing"]}),s.invalidateQueries({queryKey:["epics"]})}).on("postgres_changes",{event:"*",schema:"public",table:"habit_completions",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["habit-completions",t.id]}),s.invalidateQueries({queryKey:["habit-completions"]}),s.invalidateQueries({queryKey:["habits",t.id]}),s.invalidateQueries({queryKey:["habits"]}),s.invalidateQueries({queryKey:["quest-autocomplete-habits",t.id]})}).subscribe((a,i)=>{(a==="CHANNEL_ERROR"||a==="TIMED_OUT")&&oe.warn("Habits realtime subscription error",{status:a,error:i?.message})});return()=>{S.removeChannel(r)}},[t?.id,s])},Rx=()=>{const{user:t}=be(),s=Ae();n.useEffect(()=>{if(!t?.id)return;const r=S.channel(`epics-sync-${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"epics",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["epics",t.id]}),s.invalidateQueries({queryKey:["epics"]}),s.invalidateQueries({queryKey:["epic-progress"]}),s.invalidateQueries({queryKey:["habit-surfacing"]})}).subscribe((a,i)=>{(a==="CHANNEL_ERROR"||a==="TIMED_OUT")&&oe.warn("Epics realtime subscription error",{status:a,error:i?.message})});return()=>{S.removeChannel(r)}},[t?.id,s])},Ix=()=>{const{user:t}=be(),s=Ae();n.useEffect(()=>{if(!t?.id)return;const r=S.channel(`daily-tasks-sync-${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"daily_tasks",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["daily-tasks"]}),s.invalidateQueries({queryKey:["tasks"]}),s.invalidateQueries({queryKey:["calendar-tasks"]}),s.invalidateQueries({queryKey:["habit-surfacing"]})}).on("postgres_changes",{event:"*",schema:"public",table:"subtasks",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["daily-tasks"]})}).subscribe((a,i)=>{(a==="CHANNEL_ERROR"||a==="TIMED_OUT")&&oe.warn("Daily tasks realtime subscription error",{status:a,error:i?.message})});return()=>{S.removeChannel(r)}},[t?.id,s])},Lx=({children:t})=>(Ax(),Rx(),Ix(),e.jsx(e.Fragment,{children:t})),qx=()=>{const[t,s]=n.useState(null),[r,a]=n.useState(!1);n.useEffect(()=>{const l=c=>{c.preventDefault(),s(c),a(!0)};return window.addEventListener("beforeinstallprompt",l),()=>window.removeEventListener("beforeinstallprompt",l)},[]);const i=async()=>{if(!t)return;t.prompt();const{outcome:l}=await t.userChoice;l==="accepted"&&(s(null),a(!1))},o=()=>{a(!1),rt.setItem("pwa-install-dismissed","true")};return!r||rt.getItem("pwa-install-dismissed")?null:e.jsxs(We,{className:"fixed bottom-36 left-4 right-4 p-4 z-50 bg-card border-border shadow-lg md:left-auto md:right-4 md:max-w-sm",children:[e.jsx("button",{onClick:o,className:"absolute top-2 right-2 p-1 hover:bg-muted rounded-full transition-colors",children:e.jsx(Nt,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-lg",children:e.jsx(uh,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-sm mb-1",children:"Install Cosmiq"}),e.jsx("p",{className:"text-xs text-muted-foreground mb-3",children:"Add to your home screen for quick access and offline support"}),e.jsx(U,{onClick:i,size:"sm",className:"w-full",children:"Install App"})]})]})]})},Ox=async()=>{if(nt.isNativePlatform())try{await qc.lock({orientation:"portrait"}),console.log("Orientation locked to portrait")}catch(t){console.error("Failed to lock orientation:",t)}},vk=async()=>{if(nt.isNativePlatform())try{await qc.lock({orientation:"landscape"}),console.log("Orientation locked to landscape")}catch(t){console.error("Failed to lock to landscape:",t)}};function In(){try{const t=nt.isNativePlatform(),s=nt.getPlatform(),r=t&&s==="ios";return console.log("[NativePush] Platform check:",{isNative:t,platform:s,isSupported:r}),oe.info("[NativePush] Platform check:",{isNative:t,platform:s,isSupported:r}),r}catch(t){return console.log("[NativePush] Platform check error:",t),oe.info("Native push not available:",t),!1}}async function Fx(t){if(console.log("[NativePush] ========== INIT START =========="),console.log("[NativePush] User ID:",t),!In()){console.log("[NativePush] Not supported on this platform, aborting"),oe.info("Native push not supported on this platform");return}try{console.log("[NativePush] Step 1: Requesting permissions...");const s=await Is.requestPermissions();if(console.log("[NativePush] Permission result:",s),console.log("[NativePush] Permission receive status:",s.receive),s.receive!=="granted")throw console.log("[NativePush] Permission DENIED - user did not grant access"),oe.log("Push notification permission denied"),new Error("Push notification permission denied. Please enable in Settings.");console.log("[NativePush] Step 2: Permission granted, registering with APNs..."),await Is.register(),console.log("[NativePush] Step 3: Registration initiated, setting up listeners..."),await Is.addListener("registration",async r=>{console.log("[NativePush] âœ… REGISTRATION SUCCESS"),console.log("[NativePush] Device token received"),oe.log("Push registration success");try{await $x(t,r.value),console.log("[NativePush] Token saved to database successfully")}catch(a){console.log("[NativePush] âŒ Failed to save token:",a)}}),await Is.addListener("registrationError",r=>{console.log("[NativePush] âŒ REGISTRATION ERROR"),console.log("[NativePush] Error details:",JSON.stringify(r)),oe.error("Push registration error:",r)}),await Is.addListener("pushNotificationReceived",r=>{console.log("[NativePush] Notification received:",r),oe.log("Push notification received:",r)}),await Is.addListener("pushNotificationActionPerformed",r=>{console.log("[NativePush] Notification action performed:",r),oe.log("Push notification action performed:",r);const a=r.notification.data;a?.url&&window.dispatchEvent(new CustomEvent("native-push-navigation",{detail:a.url}))}),console.log("[NativePush] ========== INIT COMPLETE ==========")}catch(s){throw console.log("[NativePush] âŒ INIT FAILED"),console.log("[NativePush] Error:",s),oe.error("Error initializing native push:",s),s}}async function $x(t,s){console.log("[NativePush] Saving token to database..."),console.log("[NativePush] User:",t),console.log("[NativePush] Token (first 20 chars):",s.substring(0,20)+"...");try{const{error:r}=await S.from("push_device_tokens").upsert({user_id:t,device_token:s,platform:"ios",user_agent:navigator.userAgent},{onConflict:"user_id,device_token"});if(r)throw console.log("[NativePush] Database error:",r),oe.error("Error saving device token:",r),r;console.log("[NativePush] âœ… Device token saved successfully"),oe.log("Device token saved successfully")}catch(r){throw console.log("[NativePush] âŒ Error saving device token:",r),oe.error("Error saving device token:",r),r}}async function wk(t){if(console.log("[NativePush] Unregistering..."),!!In())try{await Is.removeAllListeners();const s=await Is.getDeliveredNotifications();console.log("[NativePush] Delivered notifications:",s);const{error:r}=await S.from("push_device_tokens").delete().eq("user_id",t).eq("platform","ios");r?(console.log("[NativePush] Error deleting token:",r),oe.error("Error deleting device token:",r)):console.log("[NativePush] Token deleted from database")}catch(s){throw console.log("[NativePush] Unregister error:",s),oe.error("Error unregistering from push:",s),s}}async function _k(t){try{const{data:s,error:r}=await S.from("push_device_tokens").select("id").eq("user_id",t).eq("platform","ios").limit(1);if(r)throw r;const a=(s?.length||0)>0;return console.log("[NativePush] Has active subscription:",a),a}catch(s){return console.log("[NativePush] Error checking subscription:",s),oe.error("Error checking native push subscription:",s),!1}}async function jk(t){const s=nt.getPlatform(),r=nt.isNativePlatform(),a=In();let i="unknown",o;try{a&&(i=(await Is.checkPermissions()).receive)}catch(c){o=c instanceof Error?c.message:String(c)}const l={platform:s,isNative:r,isSupported:a,permissionStatus:i,error:o};return console.log("[NativePush] Debug info:",l),l}const ns=Fc,Hx=ph,Bx=Oc,mu=n.forwardRef(({className:t,...s},r)=>e.jsx(Nn,{ref:r,className:A("fixed inset-0 z-50 bg-black/58 backdrop-blur-[2px] data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...s}));mu.displayName=Nn.displayName;const Vt=n.forwardRef(({className:t,children:s,hideCloseButton:r,...a},i)=>e.jsxs(Bx,{children:[e.jsx(mu,{}),e.jsxs(kn,{ref:i,className:A("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border border-border/70 bg-card/92 p-6 shadow-[0_20px_44px_rgba(0,0,0,0.34)] backdrop-blur-xl duration-200 overscroll-contain data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[49%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[51%] sm:rounded-2xl",t),...a,children:[s,!r&&e.jsxs(mh,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity data-[state=open]:bg-accent data-[state=open]:text-muted-foreground hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none",children:[e.jsx(Nt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));Vt.displayName=kn.displayName;const Bs=({className:t,...s})=>e.jsx("div",{className:A("flex flex-col space-y-1.5 text-center sm:text-left",t),...s});Bs.displayName="DialogHeader";const xs=n.forwardRef(({className:t,...s},r)=>e.jsx(Cn,{ref:r,className:A("text-lg font-semibold leading-none tracking-tight",t),...s}));xs.displayName=Cn.displayName;const dr=n.forwardRef(({className:t,...s},r)=>e.jsx(Sn,{ref:r,className:A("text-sm text-muted-foreground",t),...s}));dr.displayName=Sn.displayName;const Ux={common:45,uncommon:60,rare:75,epic:90,legendary:120},zx={common:{playerHP:100,adversaryHP:80,attackDamage:12},uncommon:{playerHP:100,adversaryHP:100,attackDamage:15},rare:{playerHP:100,adversaryHP:120,attackDamage:18},epic:{playerHP:100,adversaryHP:150,attackDamage:22},legendary:{playerHP:100,adversaryHP:180,attackDamage:28}},Nk={tap_sequence:{levelComplete:20,perfectLevel:30},galactic_match:{levelComplete:20,perfectLevel:30},soul_serpent:{scoreMilestone:25},starfall_dodge:{survivalMilestone:20},energy_beam:{waveComplete:25,bossKill:15},orb_match:{scoreTarget:35,specialActivation:10},eclipse_timing:{songComplete:999,tooManyMisses:999},astral_frequency:{distanceMilestone:12}},Qx={perfect:70};function Kx(t,s,r){return r?"fail":t/s*100>=Qx.perfect?"perfect":"good"}const Wx={0:"Egg",1:"Hatchling",2:"Sproutling",3:"Cub",4:"Juvenile",5:"Apprentice",6:"Scout",7:"Fledgling",8:"Warrior",9:"Guardian",10:"Champion",11:"Ascended",12:"Vanguard",13:"Titan",14:"Mythic",15:"Prime",16:"Regal",17:"Eternal",18:"Transcendent",19:"Apex",20:"Ultimate Form"},Ln=t=>Wx[t]||`Stage ${t}`,Vo={common:{primary:"hsl(220, 13%, 50%)",glow:"rgba(100, 116, 139, 0.5)",bg:"from-slate-500/20 to-slate-700/10"},uncommon:{primary:"hsl(142, 76%, 46%)",glow:"rgba(34, 197, 94, 0.5)",bg:"from-emerald-500/20 to-emerald-700/10"},rare:{primary:"hsl(217, 91%, 60%)",glow:"rgba(59, 130, 246, 0.5)",bg:"from-blue-500/20 to-blue-700/10"},epic:{primary:"hsl(271, 91%, 65%)",glow:"rgba(168, 85, 247, 0.5)",bg:"from-purple-500/20 to-purple-700/10"},legendary:{primary:"hsl(38, 92%, 50%)",glow:"rgba(245, 158, 11, 0.6)",bg:"from-amber-500/20 to-orange-600/10"}},Gx=({companionImageUrl:t,companionName:s="Companion",companionStage:r=0,adversary:a,adversaryImageUrl:i,isLoadingImage:o,onReady:l,onPass:c})=>{const d=Vo[a.tier]||Vo.common,m=n.useMemo(()=>Array.from({length:15},(h,f)=>({id:f,top:f*7+3,duration:.6+f%5*.15,delay:f%7*.1})),[]),p=n.useMemo(()=>Array.from({length:20},(h,f)=>({id:f,x:f%5*25,y:Math.floor(f/5)*25,size:2+f%3,duration:2+f%3,delay:f%5*.3})),[]);return e.jsxs("div",{className:"relative w-full h-[520px] overflow-hidden bg-gradient-to-b from-background via-background/95 to-background",children:[e.jsxs("div",{className:"absolute inset-0",children:[p.map(h=>e.jsx(M.div,{className:"absolute rounded-full bg-white/60",style:{left:`${h.x}%`,top:`${h.y}%`,width:h.size,height:h.size},animate:{opacity:[.2,.8,.2],scale:[1,1.5,1]},transition:{duration:h.duration,repeat:1/0,delay:h.delay}},h.id)),m.map(h=>e.jsx(M.div,{className:"absolute h-[1px] w-full",style:{top:`${h.top}%`,background:"linear-gradient(90deg, transparent 0%, hsl(var(--primary) / 0.4) 50%, transparent 100%)"},animate:{x:["-100%","100%"],opacity:[0,1,0]},transition:{duration:h.duration,repeat:1/0,delay:h.delay,ease:"linear"}},h.id)),e.jsxs("svg",{className:"absolute inset-0 w-full h-full",preserveAspectRatio:"none",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"dividerGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"hsl(var(--primary))",stopOpacity:"0.3"}),e.jsx("stop",{offset:"50%",stopColor:"white",stopOpacity:"0.1"}),e.jsx("stop",{offset:"100%",style:{stopColor:d.primary},stopOpacity:"0.3"})]})}),e.jsx(M.line,{x1:"50%",y1:"0",x2:"50%",y2:"100%",stroke:"url(#dividerGradient)",strokeWidth:"2",initial:{pathLength:0},animate:{pathLength:1},transition:{duration:.8,delay:.2}})]}),e.jsx("div",{className:"absolute inset-y-0 left-0 w-1/2 bg-gradient-to-r from-primary/10 via-primary/5 to-transparent"}),e.jsx("div",{className:"absolute inset-y-0 right-0 w-1/2",style:{background:`linear-gradient(to left, ${d.glow}, transparent)`}})]}),e.jsxs("div",{className:"relative z-10 h-full flex flex-col",children:[e.jsxs("div",{className:"flex-1 flex items-center relative min-h-0",children:[e.jsxs(M.div,{className:"flex-1 h-full flex flex-col items-center justify-center px-3",initial:{x:"-100%",opacity:0},animate:{x:0,opacity:1},transition:{type:"spring",stiffness:70,damping:18,delay:.1},children:[e.jsxs(M.div,{className:"relative w-36 h-36 sm:w-44 sm:h-44",animate:{y:[0,-6,0]},transition:{duration:3.5,repeat:1/0,ease:"easeInOut"},children:[e.jsx(M.div,{className:"absolute -inset-4 rounded-full",style:{background:"radial-gradient(circle, hsl(var(--primary) / 0.3) 0%, transparent 70%)"},animate:{scale:[1,1.2,1],opacity:[.4,.7,.4]},transition:{duration:2.5,repeat:1/0}}),e.jsx("div",{className:"relative w-full h-full rounded-2xl overflow-hidden border-2 border-primary/40 shadow-[0_0_30px_hsl(var(--primary)/0.3)]",children:t?e.jsx("img",{src:t,alt:s,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center",children:e.jsx(pe,{className:"w-12 h-12 text-primary"})})})]}),e.jsxs(M.div,{className:"mt-3 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5},children:[e.jsx("p",{className:"text-base font-bold text-foreground",children:s}),e.jsx("p",{className:"text-[10px] text-primary/80 font-medium uppercase tracking-wider",children:Ln(r)})]})]}),e.jsxs(M.div,{className:"absolute left-[43%] top-[35%] -translate-x-1/2 -translate-y-1/2 z-20",initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",stiffness:300,damping:20,delay:.3},children:[e.jsx(M.div,{className:"absolute inset-0 rounded-lg blur-xl",style:{background:`${d.primary}40`},animate:{scale:[1,1.3,1],opacity:[.5,.8,.5]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx("div",{className:"relative px-3 py-1.5 bg-background/95 border border-primary/50 rounded-md backdrop-blur-sm",style:{boxShadow:`0 0 20px ${d.glow}`},children:e.jsx("span",{className:"text-lg sm:text-xl font-black tracking-tight",style:{background:`linear-gradient(135deg, hsl(var(--primary)) 0%, ${d.primary} 100%)`,backgroundClip:"text",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},children:"VS"})})]}),e.jsxs(M.div,{className:"flex-1 h-full flex flex-col items-center justify-center px-3",initial:{x:"100%",opacity:0},animate:{x:0,opacity:1},transition:{type:"spring",stiffness:70,damping:18,delay:.1},children:[e.jsxs(M.div,{className:"relative w-36 h-36 sm:w-44 sm:h-44",animate:{y:[0,-6,0]},transition:{duration:3.5,repeat:1/0,ease:"easeInOut",delay:.5},children:[e.jsx(M.div,{className:"absolute -inset-4 rounded-full",style:{background:`radial-gradient(circle, ${d.glow} 0%, transparent 70%)`},animate:{scale:[1,1.2,1],opacity:[.4,.7,.4]},transition:{duration:2.5,repeat:1/0}}),e.jsx("div",{className:"relative w-full h-full rounded-2xl overflow-hidden border-2",style:{borderColor:d.primary+"60",boxShadow:`0 0 30px ${d.glow}`},children:o?e.jsxs("div",{className:"w-full h-full bg-gradient-to-br from-muted/30 to-muted/10 flex flex-col items-center justify-center gap-2",children:[e.jsx(bt,{className:"w-8 h-8 animate-spin",style:{color:d.primary}}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Materializing..."})]}):i?e.jsx("img",{src:i,alt:a.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:`w-full h-full bg-gradient-to-br ${d.bg} flex items-center justify-center`,children:e.jsx(Sa,{className:"w-12 h-12",style:{color:d.primary,filter:`drop-shadow(0 0 10px ${d.glow})`}})})}),e.jsx(M.div,{className:"absolute -top-1 -right-1 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase text-white shadow-lg",style:{backgroundColor:d.primary},initial:{scale:0},animate:{scale:1},transition:{delay:.6,type:"spring"},children:hs(a.tier)})]}),e.jsxs(M.div,{className:"mt-3 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5},children:[e.jsx("p",{className:"text-base font-bold",style:{color:d.primary},children:a.name}),e.jsxs("p",{className:"text-[10px] font-medium uppercase tracking-wider",style:{color:d.primary+"cc"},children:[hs(a.theme)," Adversary"]})]})]})]}),e.jsxs(M.div,{className:"px-5 pb-5 pt-3 bg-gradient-to-t from-background via-background/95 to-transparent",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.7},children:[e.jsx("div",{className:"flex justify-center gap-6 mb-3",children:[{label:"Phases",value:a.phases},{label:"Essence",value:a.statType},{label:"Boost",value:`+${a.statBoost}`}].map(h=>e.jsxs("div",{className:"text-center px-3 py-1.5 rounded-lg bg-muted/30 backdrop-blur-sm",children:[e.jsx("p",{className:"text-[10px] text-muted-foreground uppercase tracking-wider",children:h.label}),e.jsx("p",{className:"text-sm font-bold text-primary",children:typeof h.value=="string"?hs(h.value):h.value})]},h.label))}),e.jsxs("p",{className:"text-center text-xs text-muted-foreground italic mb-4 line-clamp-2 px-2",children:['"',a.lore,'"']}),e.jsxs("div",{className:"flex gap-3 w-full overflow-hidden",children:[c&&e.jsxs(U,{onClick:c,variant:"ghost",size:"lg",className:"h-12 px-4 text-muted-foreground hover:text-foreground",children:[e.jsx(ha,{className:"w-5 h-5 mr-1"}),"Pass"]}),e.jsxs(U,{onClick:l,size:"lg",className:"flex-1 min-w-0 h-12 text-sm sm:text-base font-bold bg-gradient-to-r from-primary via-accent to-primary bg-[length:200%_100%] hover:bg-[position:100%_0] transition-all duration-500 shadow-lg shadow-primary/30",children:[e.jsx(ft,{className:"w-5 h-5 mr-2 flex-shrink-0"}),"Begin Harmonization"]})]})]})]})]})},Xo={mind:{icon:Ss,color:"text-cyan-400",bg:"from-cyan-500/30 to-blue-500/30",glow:"shadow-cyan-500/50"},body:{icon:Xi,color:"text-amber-400",bg:"from-amber-500/30 to-orange-500/30",glow:"shadow-amber-500/50"},soul:{icon:Ws,color:"text-purple-400",bg:"from-purple-500/30 to-pink-500/30",glow:"shadow-purple-500/50"}},Yx={perfect:{title:"Perfect Victory!",icon:$c,color:"text-amber-400",textGradient:"from-amber-300 via-yellow-400 to-orange-400",confettiColors:["#fbbf24","#f59e0b","#d97706","#fcd34d"]},good:{title:"Victory!",icon:St,color:"text-primary",textGradient:"from-primary via-accent to-primary",confettiColors:["#8b5cf6","#a855f7","#c084fc","#6366f1"]},fail:{title:"Overcome by Shadow",icon:Sa,color:"text-slate-400",textGradient:"from-slate-400 via-purple-400 to-slate-500",confettiColors:[]}},Jo=["steadies their resolve beside you","refuses to give up","gathers strength for the next attempt","stands ready to try again","believes in your strength"],Vx=()=>{const t=n.useMemo(()=>Array.from({length:12},(s,r)=>({id:r,left:Math.random()*100,delay:Math.random()*3,duration:4+Math.random()*3,size:2+Math.random()*3})),[]);return e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:t.map(s=>e.jsx(M.div,{className:"absolute rounded-full",style:{left:`${s.left}%`,top:"-5%",width:s.size,height:s.size,background:"radial-gradient(circle, rgba(168, 85, 247, 0.8), rgba(100, 50, 150, 0.4))",boxShadow:"0 0 6px rgba(168, 85, 247, 0.5)"},animate:{y:["0vh","110vh"],opacity:[0,.8,.6,0],x:[0,Math.sin(s.id)*20,Math.cos(s.id)*15,0]},transition:{duration:s.duration,delay:s.delay,repeat:1/0,ease:"linear"}},s.id))})},Xx=({adversary:t,result:s,accuracy:r,xpEarned:a,onClose:i,retryAvailableAt:o,tiltBonus:l,companionImageUrl:c,companionName:d})=>{const m=Yx[s],p=m.icon,h=s!=="fail",f=Xo[t.statType]||Xo.soul,u=f.icon,g=n.useMemo(()=>Jo[Math.floor(Math.random()*Jo.length)],[]);n.useEffect(()=>{if(h){fs.impact({style:Wt.Heavy}).catch(()=>{});const v=Date.now()+2e3,x=()=>{Ot({particleCount:3,angle:60,spread:55,origin:{x:0,y:.6},colors:m.confettiColors}),Ot({particleCount:3,angle:120,spread:55,origin:{x:1,y:.6},colors:m.confettiColors}),Date.now()<v&&requestAnimationFrame(x)};x(),setTimeout(()=>{Ot({particleCount:100,spread:100,origin:{y:.5},colors:m.confettiColors})},300)}else fs.impact({style:Wt.Light}).catch(()=>{})},[h,m.confettiColors]);const y=()=>{if(!o)return"";const b=new Date(o),v=new Date;return`Retry in ${Math.ceil((b.getTime()-v.getTime())/(1e3*60*60))}h`};return e.jsxs("div",{className:"flex flex-col items-center gap-4 p-6 text-center overflow-hidden relative",children:[e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx(M.div,{className:`absolute top-1/4 left-1/2 -translate-x-1/2 w-64 h-64 rounded-full blur-3xl ${h?"bg-primary/20":"bg-purple-900/30"}`,animate:{scale:[1,1.2,1],opacity:[.3,.5,.3]},transition:{duration:3,repeat:1/0}}),!h&&e.jsx(M.div,{className:"absolute inset-0 pointer-events-none",initial:{opacity:0},animate:{opacity:1},style:{background:"radial-gradient(ellipse at center, transparent 20%, rgba(15, 10, 30, 0.6) 80%)"}})]}),!h&&e.jsx(Vx,{}),e.jsxs(M.div,{className:"relative",initial:{scale:0,rotate:h?-180:0},animate:{scale:1,rotate:0},transition:{type:"spring",duration:.8},children:[e.jsx("div",{className:`absolute inset-0 blur-xl ${h?m.color:"text-purple-500"} opacity-50`}),e.jsx(p,{className:`w-16 h-16 ${m.color} relative z-10 drop-shadow-lg`}),!h&&e.jsx(M.div,{className:"absolute inset-0 rounded-full border-2 border-purple-500/30",animate:{scale:[1,1.5,1],opacity:[.5,0,.5]},transition:{duration:2,repeat:1/0}})]}),e.jsx(M.h2,{className:`text-3xl font-black bg-gradient-to-r ${m.textGradient} bg-clip-text text-transparent`,initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},children:m.title}),c&&e.jsxs(M.div,{className:"relative my-2",initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.3,type:"spring"},children:[e.jsx(M.div,{className:`absolute inset-0 rounded-full bg-gradient-to-r ${h?f.bg:"from-slate-600/30 to-purple-900/30"} blur-xl`,animate:{scale:[1,1.3,1],opacity:h?[.5,.8,.5]:[.3,.5,.3]},transition:{duration:2,repeat:1/0}}),e.jsxs("div",{className:`relative w-28 h-28 rounded-full overflow-hidden border-2 ${h?"border-primary/50 shadow-lg shadow-primary/30":"border-slate-500/40 shadow-lg shadow-purple-900/30"}`,children:[e.jsx("img",{src:c,alt:d||"Companion",className:`w-full h-full object-cover ${h?"":"saturate-75"}`}),!h&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-purple-900/30 to-transparent"})]}),h&&e.jsx(M.div,{className:"absolute -top-1 -right-1",animate:{rotate:360},transition:{duration:4,repeat:1/0,ease:"linear"},children:e.jsx(pe,{className:`w-5 h-5 ${f.color}`})}),!h&&e.jsx(M.div,{className:"absolute -bottom-1 -right-1",initial:{scale:0},animate:{scale:1},transition:{delay:.5},children:e.jsx("div",{className:"w-8 h-8 rounded-full bg-slate-800/80 border border-purple-500/40 flex items-center justify-center",children:e.jsx(Es,{className:"w-4 h-4 text-purple-400"})})})]}),e.jsx(M.p,{className:`text-sm italic ${h?"text-muted-foreground":"text-purple-300/80"}`,initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},children:h?`${d||"Your companion"} radiates with newfound power!`:`${d||"Your companion"} ${g}`}),e.jsx(M.div,{className:"w-full",initial:{y:30,opacity:0},animate:{y:0,opacity:1},transition:{delay:.5},children:e.jsxs("div",{className:`relative p-4 rounded-xl ${h?`bg-gradient-to-br ${f.bg}`:"bg-gradient-to-br from-slate-800/50 to-purple-900/30"} border ${h?"border-white/10":"border-slate-600/30"} backdrop-blur-sm overflow-hidden`,children:[e.jsx(M.div,{className:`absolute inset-0 rounded-xl border-2 ${h?f.color.replace("text","border"):"border-slate-500/30"} opacity-50`,animate:{opacity:h?[.3,.7,.3]:[.1,.3,.1]},transition:{duration:2,repeat:1/0}}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("div",{className:"flex items-center justify-center gap-2 mb-2",children:h?e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:`w-4 h-4 ${f.color}`}),e.jsx("p",{className:`text-sm font-bold uppercase tracking-wider ${f.color}`,children:"Essence Absorbed"}),e.jsx(pe,{className:`w-4 h-4 ${f.color}`})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ao,{className:"w-4 h-4 text-slate-400"}),e.jsx("p",{className:"text-sm font-bold uppercase tracking-wider text-slate-400",children:"Essence Slipped Away"}),e.jsx(Ao,{className:"w-4 h-4 text-slate-400"})]})}),e.jsx("h3",{className:`text-xl font-bold ${h?"text-foreground":"text-slate-400"} mb-1`,children:t.essenceName}),e.jsxs("p",{className:`text-sm ${h?"text-muted-foreground":"text-slate-500"} mb-3 line-clamp-2`,children:['"',t.essenceDescription,'"']}),e.jsxs("div",{className:`inline-flex items-center gap-2 px-4 py-2 rounded-full ${h?"bg-background/50":"bg-slate-800/50"} border ${h?"border-white/10":"border-slate-600/30"}`,children:[e.jsx(u,{className:`w-5 h-5 ${h?f.color:"text-slate-500"}`}),e.jsx("span",{className:`text-sm font-medium ${h?"text-muted-foreground":"text-slate-500"} capitalize`,children:t.statType}),e.jsxs("span",{className:`text-lg font-bold ${h?f.color:"text-slate-500 line-through"}`,children:["+",t.statBoost]}),!h&&e.jsx("span",{className:"text-xs text-slate-500 ml-1",children:"(Not earned)"})]})]})]})}),h&&e.jsxs(M.div,{className:"flex flex-col items-center gap-1",initial:{scale:0},animate:{scale:1},transition:{delay:.7,type:"spring"},children:[e.jsxs("div",{className:"flex items-center gap-2 text-xl",children:[e.jsx(pe,{className:"w-5 h-5 text-primary"}),e.jsxs("span",{className:"font-bold text-primary",children:["+",a," XP"]})]}),l&&e.jsxs(M.div,{className:"flex items-center gap-1 text-xs text-cyan-400",initial:{opacity:0},animate:{opacity:1},transition:{delay:1},children:[e.jsx("span",{children:"ðŸ“±"}),e.jsx("span",{children:"+25% Tilt Bonus!"})]})]}),e.jsxs(M.div,{className:"w-full mt-2",initial:{opacity:0},animate:{opacity:1},transition:{delay:.8},children:[e.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[e.jsx("span",{className:"text-muted-foreground",children:"Accuracy"}),e.jsxs("span",{className:`font-bold ${h?"text-foreground":"text-slate-400"}`,children:[r,"%"]})]}),e.jsx("div",{className:"h-2 bg-muted/30 rounded-full overflow-hidden",children:e.jsx(M.div,{className:`h-full rounded-full ${h?"bg-gradient-to-r from-primary to-accent":"bg-gradient-to-r from-slate-600 to-purple-700/50"}`,initial:{width:0},animate:{width:`${r}%`},transition:{delay:.9,duration:.8,ease:"easeOut"}})})]}),!h&&o&&e.jsxs(M.div,{className:"flex items-center justify-center gap-2 text-sm text-purple-300/70",initial:{y:10,opacity:0},animate:{y:0,opacity:1},transition:{delay:1},children:[e.jsx(M.div,{animate:{rotate:360},transition:{duration:3,repeat:1/0,ease:"linear"},children:e.jsx(ir,{className:"w-4 h-4"})}),e.jsx("span",{children:y()})]}),e.jsx(M.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:1.1},className:"mt-2",children:e.jsx(U,{onClick:i,className:`px-8 ${h?"bg-gradient-to-r from-primary to-accent hover:opacity-90":"bg-gradient-to-r from-slate-700 to-purple-800 hover:from-slate-600 hover:to-purple-700 border border-purple-500/30"}`,variant:h?"default":"outline",size:"lg",children:h?"Continue":"Return to Safety"})})]})},Jx={energy_beam:{icon:ft,title:"Star Defender",goal:"Survive endless alien waves!",howToPlay:["Move left/right to dodge attacks","Auto-fire destroys enemies","3 lives - survive as long as possible","Waves get harder - how far can you go?"],statBonus:"body",statIcon:Ws},tap_sequence:{icon:En,title:"Memory Sequence",goal:"How far can your memory take you?",howToPlay:["Watch orbs light up in sequence","Numbers hide - tap from memory!","Wrong tap = lose a life, sequence replays","3 lives total - survive endless levels!"],statBonus:"mind",statIcon:Ss},astral_frequency:{icon:Hc,title:"Cosmiq Dash",goal:"Survive the endless cosmic tunnel!",howToPlay:["Swipe or tap â—€ â–¶ to switch lanes","ðŸ”´ RED ASTEROIDS = DANGER! Lose a life","ðŸŸ¡ GOLD CRYSTALS = Points! Collect them","ðŸ”µ CYAN SHIELDS = Protection for 1 hit","Speed increases - survive as long as you can!"],statBonus:"soul",statIcon:pe},eclipse_timing:{icon:yh,title:"Stellar Beats",goal:"Hit the notes in rhythm as they fall!",howToPlay:["Watch notes scroll down the 3 lanes","Tap the lane when notes reach the glowing line","Chain combos for multiplied points!"],statBonus:"soul",statIcon:pe},starfall_dodge:{icon:xh,title:"Starfall Dodge",goal:"Survive the endless starfall!",howToPlay:["ðŸ“± Tilt or swipe to dodge debris","3 lives - debris hits cost one!","Collect ðŸ’Ž crystals for bonus points","Speed increases - how long can you last?"],statBonus:"body",statIcon:Ws},soul_serpent:{icon:ft,title:"Soul Serpent",goal:"Guide the serpent and survive as long as possible!",howToPlay:["Swipe or use D-Pad to change direction","Collect glowing stardust to grow longer","Game ends when you hit yourself!"],statBonus:"body",statIcon:Ws},orb_match:{icon:gh,title:"Starburst",goal:"Match orbs before time runs out!",howToPlay:["Touch and drag any orb across the grid","Orbs swap positions as you pass through","Match 3+ of the same color to score","Chain combos for bonus points!"],statBonus:"soul",statIcon:pe},galactic_match:{icon:fh,title:"Galactic Match",goal:"Memorize cards, match pairs, survive endless levels!",howToPlay:["All cards revealed at start - MEMORIZE!","Cards hide - match pairs from memory","Wrong match = lose a life (3 total)","Clear level â†’ more cards next level!"],statBonus:"mind",statIcon:Ss},cosmiq_grid:{icon:hh,title:"Cosmiq Grid",goal:"Fill the grid with numbers 1-4!",howToPlay:["Each row must have 1, 2, 3, 4","Each column must have 1, 2, 3, 4","Each 2Ã—2 box must have 1, 2, 3, 4","Tap a cell, then tap a number to place"],statBonus:"mind",statIcon:Ss},stellar_flow:{icon:At,title:"Pathfinder",goal:"Connect matching orbs with flowing paths!",howToPlay:["Drag from one orb to its matching pair","Paths cannot cross each other","Fill every cell to complete the puzzle","Faster times = higher scores!"],statBonus:"soul",statIcon:pe}},Zx={mind:"hsl(217, 91%, 60%)",body:"hsl(0, 84%, 60%)",soul:"hsl(271, 91%, 65%)"},ey=({gameType:t,onReady:s})=>{const r=Jx[t],a=r.icon,i=r.statIcon,o=Zx[r.statBonus];return e.jsxs(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"p-6 flex flex-col items-center",children:[e.jsxs(M.div,{className:"relative mb-6",initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200,damping:15},children:[e.jsx(M.div,{className:"absolute inset-0 rounded-full blur-xl opacity-50",style:{backgroundColor:o},animate:{scale:[1,1.3,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx("div",{className:"relative p-5 rounded-full",style:{background:`linear-gradient(135deg, ${o}40, ${o}20)`,border:`2px solid ${o}60`},children:e.jsx(a,{className:"w-12 h-12",style:{color:o,filter:`drop-shadow(0 0 8px ${o})`}})})]}),e.jsx(M.h3,{className:"text-2xl font-bold text-foreground mb-2 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.1},children:r.title}),e.jsx(M.p,{className:"text-muted-foreground text-center mb-6",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.2},children:r.goal}),e.jsxs(M.div,{className:"w-full max-w-xs space-y-3 mb-6",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.3},children:[e.jsx("h4",{className:"text-sm font-semibold text-foreground uppercase tracking-wide text-center",children:"How to Play"}),e.jsx("div",{className:"space-y-2",children:r.howToPlay.map((l,c)=>e.jsxs(M.div,{className:"flex items-start gap-3 text-sm text-muted-foreground",initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:.4+c*.1},children:[e.jsx("span",{className:"flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold text-white",style:{backgroundColor:o},children:c+1}),e.jsx("span",{children:l})]},c))})]}),e.jsxs(M.div,{className:"flex items-center gap-2 mb-6 px-4 py-2 rounded-full",style:{backgroundColor:`${o}15`,border:`1px solid ${o}30`},initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:.5},children:[e.jsx(i,{className:"w-4 h-4",style:{color:o}}),e.jsxs("span",{className:"text-sm font-medium capitalize",style:{color:o},children:[r.statBonus," Stat Bonus"]})]}),e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.6},children:e.jsx(U,{onClick:s,size:"lg",className:"px-8 font-bold",style:{background:`linear-gradient(135deg, ${o}, ${o}cc)`,boxShadow:`0 0 20px ${o}50`},children:e.jsx(M.span,{animate:{scale:[1,1.05,1]},transition:{duration:1.5,repeat:1/0},children:"Ready!"})})})]})},Zo=n.lazy(()=>ke(()=>import("./EnergyBeamGame-BmV2dlUs.js"),__vite__mapDeps([0,1,2,3,4])).then(t=>({default:t.EnergyBeamGame}))),ty=n.lazy(()=>ke(()=>import("./TapSequenceGame-Co8xL4xG.js"),__vite__mapDeps([5,1,2,3,4])).then(t=>({default:t.TapSequenceGame}))),sy=n.lazy(()=>ke(()=>import("./AstralFrequencyGame-8lhy12jN.js"),__vite__mapDeps([6,1,2,3,4])).then(t=>({default:t.AstralFrequencyGame}))),ry=n.lazy(()=>ke(()=>import("./EclipseTimingGame-DV4_nD0g.js"),__vite__mapDeps([7,1,2,3,4])).then(t=>({default:t.EclipseTimingGame}))),ay=n.lazy(()=>ke(()=>import("./StarfallDodgeGame-CLnaBcWv.js"),__vite__mapDeps([8,1,2,3,4])).then(t=>({default:t.StarfallDodgeGame}))),ny=n.lazy(()=>ke(()=>import("./SoulSerpentGame-D3Kq0Ubq.js"),__vite__mapDeps([9,1,2,3,4])).then(t=>({default:t.SoulSerpentGame}))),iy=n.lazy(()=>ke(()=>import("./OrbMatchGame-BV1zt-J7.js"),__vite__mapDeps([10,1,2,3,4])).then(t=>({default:t.OrbMatchGame}))),oy=n.lazy(()=>ke(()=>import("./GalacticMatchGame-sEezCMVN.js"),__vite__mapDeps([11,1,2,3,4])).then(t=>({default:t.GalacticMatchGame}))),ly=["starfall_dodge","astral_frequency"],cy=12,pu=n.memo(()=>e.jsx(M.div,{className:"absolute top-0 left-0 right-0 z-50 flex justify-center pt-safe-top",initial:{y:-50,opacity:0},animate:{y:0,opacity:1},transition:{type:"spring",stiffness:300,damping:25},children:e.jsx("div",{className:"bg-gradient-to-r from-amber-500 via-yellow-500 to-amber-500 px-6 py-2 rounded-b-xl shadow-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(M.span,{animate:{scale:[1,1.2,1]},transition:{duration:1,repeat:1/0},className:"text-lg",children:"ðŸŽ¯"}),e.jsx("span",{className:"font-bold text-black text-sm uppercase tracking-wider",children:"Practice Round"}),e.jsx(M.span,{animate:{scale:[1,1.2,1]},transition:{duration:1,repeat:1/0,delay:.5},className:"text-lg",children:"ðŸŽ¯"})]})})}));pu.displayName="PracticeBanner";const hu=n.memo(({gameType:t,onStart:s,onSkip:r})=>{const a={energy_beam:"Star Defender",tap_sequence:"Tap Sequence",astral_frequency:"Cosmiq Dash",eclipse_timing:"Stellar Beats",starfall_dodge:"Starfall Dodge",soul_serpent:"Soul Serpent",orb_match:"Starburst",galactic_match:"Galactic Match"}[t];return e.jsxs(M.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},className:"flex flex-col items-center justify-center p-8 text-center min-h-[400px]",children:[e.jsx(M.div,{className:"mb-6 p-4 rounded-full bg-gradient-to-br from-amber-500/20 to-yellow-500/20 border border-amber-500/30",animate:{boxShadow:["0 0 20px rgba(245, 158, 11, 0.3)","0 0 40px rgba(245, 158, 11, 0.5)","0 0 20px rgba(245, 158, 11, 0.3)"]},transition:{duration:2,repeat:1/0},children:e.jsx("span",{className:"text-5xl",children:"ðŸŽ®"})}),e.jsx("h3",{className:"text-2xl font-bold text-foreground mb-2",children:"Practice Round"}),e.jsxs("p",{className:"text-muted-foreground mb-2",children:["Try ",e.jsx("span",{className:"text-amber-400 font-semibold",children:a})," before the real battle!"]}),e.jsx("p",{className:"text-sm text-muted-foreground/70 mb-8 max-w-xs",children:"This is a quick practice session to warm up. Your score won't count yet!"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(U,{onClick:s,size:"lg",className:"px-8 font-bold bg-gradient-to-r from-amber-500 to-yellow-500 text-black hover:from-amber-600 hover:to-yellow-600",children:[e.jsx(Ls,{className:"w-5 h-5 mr-2"}),"Start Practice"]}),e.jsxs(U,{onClick:r,variant:"ghost",size:"lg",className:"text-muted-foreground hover:text-foreground",children:[e.jsx(ha,{className:"w-4 h-4 mr-1"}),"Skip"]})]})]})});hu.displayName="PracticeIntro";const fu=n.memo(({onContinue:t})=>(n.useEffect(()=>{const s=setTimeout(t,2e3);return()=>clearTimeout(s)},[t]),e.jsxs(M.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"flex flex-col items-center justify-center p-8 text-center min-h-[400px]",children:[e.jsx(M.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200,damping:15},className:"mb-6",children:e.jsx("span",{className:"text-6xl",children:"âœ¨"})}),e.jsx(M.h3,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},className:"text-2xl font-bold text-foreground mb-2",children:"Nice Warm-Up!"}),e.jsx(M.p,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"text-muted-foreground mb-6",children:"Now let's do it for real!"}),e.jsxs(M.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},className:"flex items-center gap-2 text-sm text-muted-foreground/70",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Starting real battle..."})]})]})));fu.displayName="PracticeComplete";const gu=n.memo(()=>e.jsx("div",{className:"pt-2 min-h-[400px] flex items-center justify-center",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground/70",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Loading practice game..."})]})}));gu.displayName="PracticeLoadingFallback";const el=({gameType:t,companionStats:s,onPracticeComplete:r,onSkipPractice:a,isFullscreen:i=!1})=>{const[o,l]=n.useState("intro"),c=i||ly.includes(t),d=n.useCallback(()=>{l("playing")},[]),m=n.useCallback(h=>{l("complete")},[]),p=()=>{const h={companionStats:s,onComplete:m,difficulty:"easy",questIntervalScale:0,isPractice:!0,maxTimer:cy};switch(t){case"energy_beam":return e.jsx(Zo,{...h});case"tap_sequence":return e.jsx(ty,{...h});case"astral_frequency":return e.jsx(sy,{...h});case"eclipse_timing":return e.jsx(ry,{...h});case"starfall_dodge":return e.jsx(ay,{...h});case"soul_serpent":return e.jsx(ny,{...h});case"orb_match":return e.jsx(iy,{...h});case"galactic_match":return e.jsx(oy,{...h});default:return e.jsx(Zo,{...h})}};return e.jsx("div",{className:c?"relative h-full":"relative",children:e.jsxs(Pe,{mode:"wait",children:[o==="intro"&&e.jsx(hu,{gameType:t,onStart:d,onSkip:a},"intro"),o==="playing"&&e.jsxs(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:c?"relative h-full":"relative",children:[e.jsx(pu,{}),e.jsx(n.Suspense,{fallback:e.jsx(gu,{}),children:c?p():e.jsx("div",{className:"pt-2 min-h-[400px] max-h-[calc(100vh-120px)] overflow-y-auto",children:p()})})]},"playing"),o==="complete"&&e.jsx(fu,{onContinue:r},"complete")]})})},dy=Hr("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground",celestial:"border-celestial-blue/30 bg-celestial-blue/20 text-celestial-blue",gold:"border-stardust-gold/30 bg-stardust-gold/20 text-stardust-gold",info:"border-celestial-blue/40 bg-celestial-blue/10 text-celestial-blue",reward:"border-stardust-gold/40 bg-stardust-gold/10 text-stardust-gold"}},defaultVariants:{variant:"default"}});function Fe({className:t,variant:s,...r}){return e.jsx("div",{className:A(dy({variant:s}),t),...r})}const uy={doubt:"from-gray-600 to-slate-800",fear:"from-purple-900 to-indigo-950",chaos:"from-red-600 to-orange-800",stagnation:"from-stone-600 to-zinc-800",anxiety:"from-violet-900 to-purple-950",distraction:"from-cyan-700 to-blue-900",laziness:"from-amber-700 to-orange-900",overthinking:"from-indigo-800 to-slate-900",confusion:"from-pink-800 to-rose-950",vulnerability:"from-emerald-800 to-teal-950",imbalance:"from-rose-700 to-red-900"},my={doubt:la,fear:Sa,chaos:ft,stagnation:Es,anxiety:la,distraction:pe,laziness:Es,overthinking:la,confusion:ft,vulnerability:Es,imbalance:ft},py=({context:t,onBeginBattle:s,onCancel:r})=>{const[a,i]=n.useState("lore"),o=my[t.bossTheme]||Sa,l=uy[t.bossTheme]||"from-slate-900 to-black";return n.useEffect(()=>{const c=setTimeout(()=>i("intel"),3e3),d=setTimeout(()=>i("ready"),6e3);return()=>{clearTimeout(c),clearTimeout(d)}},[]),e.jsx(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-background/95 backdrop-blur-md",children:e.jsxs("div",{className:"max-w-lg w-full mx-4",children:[e.jsxs(Pe,{mode:"wait",children:[a==="lore"&&e.jsxs(M.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"text-center space-y-6",children:[e.jsx(M.div,{animate:{scale:[1,1.1,1]},transition:{duration:2,repeat:1/0},children:e.jsx("div",{className:A("w-24 h-24 mx-auto rounded-full flex items-center justify-center","bg-gradient-to-br shadow-2xl",l),children:e.jsx(o,{className:"w-12 h-12 text-white/80"})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{variant:"destructive",className:"text-xs",children:"Final Confrontation"}),e.jsx("h2",{className:"text-3xl font-bold",children:t.bossName}),e.jsxs("p",{className:"text-sm text-muted-foreground italic",children:['"',t.bookTitle,'"']})]}),e.jsx("p",{className:"text-sm text-foreground/80 leading-relaxed",children:t.bossLore})]},"lore"),a==="intel"&&e.jsxs(M.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs(Fe,{variant:"outline",className:"mb-2",children:[e.jsx(Ji,{className:"w-3 h-3 mr-1"}),"Intel Gathered"]}),e.jsx("h3",{className:"text-xl font-semibold",children:"Your Journey Has Revealed..."})]}),e.jsxs(We,{className:"p-4 space-y-3 bg-primary/5 border-primary/20",children:[e.jsxs("h4",{className:"font-semibold text-sm flex items-center gap-2",children:[e.jsx(pe,{className:"w-4 h-4 text-primary"}),"Weakness Hints"]}),e.jsx("ul",{className:"space-y-2",children:t.weaknessHints.map((c,d)=>e.jsxs(M.li,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:d*.3},className:"text-sm text-foreground/80 flex items-start gap-2",children:[e.jsx(St,{className:"w-4 h-4 text-yellow-500 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:c})]},d))})]}),t.prophecyLines.length>0&&e.jsxs(We,{className:"p-4 space-y-3 bg-accent/5 border-accent/20",children:[e.jsxs("h4",{className:"font-semibold text-sm flex items-center gap-2",children:[e.jsx(la,{className:"w-4 h-4 text-accent"}),"Prophecy Fragments"]}),e.jsx("div",{className:"space-y-2",children:t.prophecyLines.map((c,d)=>e.jsxs(M.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5+d*.2},className:"text-sm italic text-foreground/70",children:['"',c,'"']},d))})]})]},"intel"),a==="ready"&&e.jsxs(M.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:1.1},className:"text-center space-y-6",children:[e.jsx(M.div,{animate:{boxShadow:["0 0 20px hsl(var(--destructive) / 0.3)","0 0 40px hsl(var(--destructive) / 0.6)","0 0 20px hsl(var(--destructive) / 0.3)"]},transition:{duration:2,repeat:1/0},className:A("w-32 h-32 mx-auto rounded-full flex items-center justify-center","bg-gradient-to-br",l),children:e.jsx(bh,{className:"w-16 h-16 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Face Your Destiny"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["All your preparations have led to this moment.",e.jsx("br",{}),"Are you ready to complete your story?"]})]}),e.jsxs("div",{className:"flex gap-3 justify-center",children:[e.jsx(U,{variant:"outline",onClick:r,children:"Not Yet"}),e.jsxs(U,{onClick:s,className:"bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700",children:["Begin Battle",e.jsx(Et,{className:"w-4 h-4 ml-1"})]})]})]},"ready")]}),a!=="ready"&&e.jsx(M.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:1},className:"mt-8 text-center",children:e.jsx(U,{variant:"ghost",size:"sm",onClick:()=>i("ready"),className:"text-muted-foreground",children:"Skip to Battle â†’"})})]})})},hy=n.memo(function({currentHP:s,maxHP:r,isPlayer:a,label:i,showNumbers:o=!0}){const[l,c]=n.useState(s),[d,m]=n.useState(!1),p=Math.max(0,s/r*100),h=s<=0,f=p<25,u=p<10;n.useEffect(()=>{if(s!==l){m(!0);const b=setTimeout(()=>{c(s),m(!1)},300);return()=>clearTimeout(b)}},[s,l]);const g=()=>h?"bg-gray-500":a?u?"bg-red-600 animate-pulse":f?"bg-orange-500":"bg-green-500":u?"bg-purple-400":f?"bg-purple-500":"bg-purple-600",y=()=>h?"":a?u?"shadow-[0_0_10px_rgba(220,38,38,0.6)]":f?"shadow-[0_0_8px_rgba(249,115,22,0.5)]":"shadow-[0_0_6px_rgba(34,197,94,0.4)]":"shadow-[0_0_8px_rgba(147,51,234,0.5)]";return e.jsxs("div",{className:`flex items-center gap-2 ${a?"flex-row":"flex-row-reverse"}`,children:[e.jsx("div",{className:`flex-shrink-0 ${h?"opacity-50":""}`,children:h?e.jsx(Sa,{className:"w-4 h-4 text-gray-400"}):e.jsx(Ws,{className:`w-4 h-4 ${a?"text-green-500":"text-purple-500"} ${f&&!h?"animate-pulse":""}`,fill:a?"rgb(34,197,94)":"rgb(147,51,234)"})}),e.jsxs("div",{className:"flex-1 flex flex-col gap-0.5",children:[i&&e.jsx("span",{className:`text-[10px] font-medium ${a?"text-left":"text-right"} text-muted-foreground truncate`,children:i}),e.jsxs("div",{className:`relative h-4 rounded-full overflow-hidden bg-muted/50 border border-border/50 ${y()}`,children:[e.jsx(Pe,{children:f&&!h&&a&&e.jsx(M.div,{initial:{opacity:0},animate:{opacity:[.3,.6,.3]},exit:{opacity:0},transition:{duration:1,repeat:1/0},className:"absolute inset-0 bg-red-500/20"})}),e.jsx(M.div,{className:`absolute inset-y-0 ${a?"left-0":"right-0"} ${g()}`,initial:!1,animate:{width:`${p}%`},transition:{duration:.4,ease:[.4,0,.2,1]},children:e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-white/30 to-transparent"})}),e.jsx(Pe,{children:d&&s<l&&e.jsx(M.div,{initial:{opacity:.8},animate:{opacity:0},exit:{opacity:0},transition:{duration:.3},className:"absolute inset-0 bg-red-500/40"})})]})]}),o&&e.jsxs("div",{className:`flex-shrink-0 min-w-[50px] ${a?"text-right":"text-left"}`,children:[e.jsx(M.span,{initial:{scale:1.2,color:s<l?"#ef4444":"#22c55e"},animate:{scale:1,color:"inherit"},className:"text-xs font-mono font-bold text-foreground",children:Math.max(0,s)},s),e.jsxs("span",{className:"text-xs font-mono text-muted-foreground",children:["/",r]})]})]})});n.memo(function({event:s,position:r="adversary"}){const[a,i]=n.useState(0);if(n.useEffect(()=>{s&&i(d=>d+1)},[s]),!s)return null;const o=s.target==="player",c=typeof r=="object"?r:r==="player"||o?{x:60,y:20}:{x:240,y:20};return e.jsx(Pe,{mode:"popLayout",children:e.jsx(M.div,{initial:{opacity:1,y:0,scale:.5,x:c.x},animate:{opacity:0,y:-40,scale:1.2,x:c.x+(Math.random()-.5)*20},exit:{opacity:0},transition:{duration:.8,ease:"easeOut"},className:"absolute pointer-events-none z-50",style:{top:c.y},children:e.jsxs("span",{className:`
          text-lg font-bold font-mono
          ${o?"text-red-500":"text-yellow-400"}
          drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)]
        `,children:[o?"-":"+",s.amount]})},a)})});const tl=n.memo(function({damageEvents:s,className:r=""}){const[a,i]=n.useState([]);return n.useEffect(()=>{if(s.length===0)return;const o=s[s.length-1],l=`${Date.now()}-${Math.random()}`,d=o.target==="player"?50:250,p={id:l,event:o,x:d+(Math.random()-.5)*30,y:30+(Math.random()-.5)*20};i(f=>[...f,p]);const h=setTimeout(()=>{i(f=>f.filter(u=>u.id!==l))},1e3);return()=>clearTimeout(h)},[s.length]),e.jsx("div",{className:`absolute inset-0 pointer-events-none overflow-hidden ${r}`,children:e.jsx(Pe,{children:a.map(o=>e.jsx(M.div,{initial:{opacity:1,y:o.y,x:o.x,scale:.5},animate:{opacity:0,y:o.y-50,x:o.x+(Math.random()-.5)*20,scale:1.3},exit:{opacity:0},transition:{duration:.9,ease:"easeOut"},className:"absolute pointer-events-none",children:e.jsxs("span",{className:`
              text-xl font-black font-mono
              ${o.event.target==="player"?"text-red-500 drop-shadow-[0_0_8px_rgba(239,68,68,0.6)]":"text-yellow-400 drop-shadow-[0_0_8px_rgba(250,204,21,0.6)]"}
            `,children:[o.event.target==="player"?"-":"+",o.event.amount]})},o.id))})})});n.memo(function({imageUrl:s,name:r,hpPercent:a,isDefeated:i,size:o="md"}){const l=n.useMemo(()=>i?4:a<=25?3:a<=50?2:a<=75?1:0,[a,i]),c={sm:"w-12 h-12",md:"w-14 h-14",lg:"w-20 h-20"},d=n.useMemo(()=>{const m=[];return l>=1&&m.push("M50,0 L45,30 L55,50 L48,80 L52,100"),l>=2&&(m.push("M0,40 L25,45 L50,50 L75,48 L100,45"),m.push("M30,0 L35,25 L28,60")),l>=3&&(m.push("M70,0 L65,35 L72,70 L68,100"),m.push("M0,70 L30,65 L60,72 L100,68"),m.push("M20,100 L25,70 L18,40")),m},[l]);return e.jsxs("div",{className:`relative ${c[o]}`,children:[e.jsxs(M.div,{className:`
          relative w-full h-full rounded-lg overflow-hidden
          border-2 border-purple-500/50
          ${i?"grayscale":""}
        `,animate:i?{scale:[1,.95,1.05,0],rotate:[0,-5,5,0],opacity:[1,1,1,0]}:{},transition:{duration:.6},children:[s?e.jsx("img",{src:s,alt:r,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-purple-900 to-purple-600 flex items-center justify-center",children:e.jsx("span",{className:"text-2xl",children:"ðŸ‘¹"})}),e.jsx(M.div,{className:"absolute inset-0 bg-red-900",initial:{opacity:0},animate:{opacity:i?.8:Math.max(0,(100-a)/200)},transition:{duration:.3}}),e.jsx(Pe,{children:a<=25&&!i&&e.jsx(M.div,{initial:{opacity:0},animate:{opacity:[.2,.4,.2]},exit:{opacity:0},transition:{duration:1.5,repeat:1/0},className:"absolute inset-0 bg-red-500/30"})})]}),e.jsx(Pe,{children:l>0&&e.jsxs(M.svg,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 w-full h-full pointer-events-none",viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[d.map((m,p)=>e.jsx(M.path,{d:m,fill:"none",stroke:"rgba(0,0,0,0.8)",strokeWidth:"2",strokeLinecap:"round",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:.3,delay:p*.1,ease:"easeOut"}},p)),d.map((m,p)=>e.jsx(M.path,{d:m,fill:"none",stroke:"rgba(255,255,255,0.3)",strokeWidth:"1",strokeLinecap:"round",transform:"translate(1, 1)",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.5},transition:{duration:.3,delay:p*.1+.1,ease:"easeOut"}},`highlight-${p}`))]})}),e.jsx(Pe,{children:i&&e.jsx(e.Fragment,{children:Array.from({length:8}).map((m,p)=>e.jsx(M.div,{className:"absolute w-3 h-3 bg-purple-500/60 rounded-sm",initial:{x:"50%",y:"50%",scale:1,opacity:1},animate:{x:`${50+(Math.random()-.5)*200}%`,y:`${50+(Math.random()-.5)*200}%`,scale:0,opacity:0,rotate:Math.random()*360},transition:{duration:.8,delay:.2+p*.05,ease:"easeOut"}},p))})})]})});const fy=n.memo(function({imageUrl:s,name:r,hpPercent:a,isDefeated:i}){const o=n.useMemo(()=>i?4:a<=25?3:a<=50?2:a<=75?1:0,[a,i]),l=n.useMemo(()=>{const c=[];return o>=1&&(c.push("M50,0 L48,25 L52,50 L47,75 L50,100"),c.push("M25,0 L28,30 L22,60")),o>=2&&(c.push("M0,50 L20,48 L40,52 L60,49 L80,51 L100,50"),c.push("M75,0 L72,35 L78,70")),o>=3&&(c.push("M10,0 L15,40 L8,80 L12,100"),c.push("M90,0 L85,45 L92,90"),c.push("M0,25 L30,28 L60,24 L100,27"),c.push("M0,75 L25,72 L50,78 L75,74 L100,76")),c},[o]);return e.jsxs("div",{className:"relative w-full aspect-[2.5/1] max-h-[140px] overflow-hidden rounded-xl",children:[e.jsxs(M.div,{className:`
          relative w-full h-full
          ${i?"grayscale":""}
        `,animate:i?{scale:[1,.98,1.02,.95],opacity:[1,1,.8,0]}:{},transition:{duration:.8},children:[s?e.jsx("img",{src:s,alt:r,className:"w-full h-full object-cover object-center"}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-purple-900 via-purple-800 to-purple-600 flex items-center justify-center",children:e.jsx("span",{className:"text-5xl",children:"ðŸ‘¹"})}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-transparent to-background/40"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-background/30 via-transparent to-background/30"}),e.jsx(M.div,{className:"absolute inset-0 bg-red-900",initial:{opacity:0},animate:{opacity:i?.7:Math.max(0,(100-a)/150)},transition:{duration:.3}}),e.jsx(Pe,{children:a<=25&&!i&&e.jsx(M.div,{initial:{opacity:0},animate:{opacity:[.1,.3,.1]},exit:{opacity:0},transition:{duration:1.2,repeat:1/0},className:"absolute inset-0 bg-red-500/40"})}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"radial-gradient(ellipse at center, transparent 20%, rgba(0,0,0,0.5) 100%)"}})]}),e.jsx(Pe,{children:o>0&&e.jsxs(M.svg,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 w-full h-full pointer-events-none",viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[l.map((c,d)=>e.jsx(M.path,{d:c,fill:"none",stroke:"rgba(0,0,0,0.9)",strokeWidth:"1.5",strokeLinecap:"round",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:.4,delay:d*.08,ease:"easeOut"}},d)),l.map((c,d)=>e.jsx(M.path,{d:c,fill:"none",stroke:"rgba(255,255,255,0.25)",strokeWidth:"0.8",strokeLinecap:"round",transform:"translate(0.5, 0.5)",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.6},transition:{duration:.4,delay:d*.08+.1,ease:"easeOut"}},`highlight-${d}`))]})}),e.jsx(Pe,{children:i&&e.jsx(e.Fragment,{children:Array.from({length:12}).map((c,d)=>e.jsx(M.div,{className:"absolute w-3 h-3 bg-purple-500/50 rounded-sm",style:{left:`${d%4*25+12}%`,top:`${Math.floor(d/4)*33+16}%`},initial:{scale:1,opacity:1},animate:{x:(Math.random()-.5)*150,y:(Math.random()-.5)*100+50,scale:0,opacity:0,rotate:Math.random()*360},transition:{duration:.7,delay:.1+d*.03,ease:"easeOut"}},d))})}),e.jsx("div",{className:"absolute inset-0 rounded-xl border border-purple-500/30 pointer-events-none"}),e.jsx(M.div,{className:"absolute inset-0 rounded-xl pointer-events-none",animate:a<=25&&!i?{boxShadow:["inset 0 0 15px rgba(239,68,68,0.2)","inset 0 0 25px rgba(239,68,68,0.4)","inset 0 0 15px rgba(239,68,68,0.2)"]}:{boxShadow:"inset 0 0 15px rgba(147,51,234,0.2)"},transition:{duration:1.5,repeat:1/0}})]})}),sl=n.memo(function({battleState:s,adversaryImageUrl:r,adversaryName:a,showScreenShake:i=!1,battleTimeLeft:o,battleTimeTotal:l}){const c=s.playerHPPercent<25;return e.jsxs(M.div,{className:"relative w-full",animate:i?{x:[0,-3,3,-2,2,0],y:[0,2,-2,1,-1,0]}:{},transition:{duration:.3},children:[e.jsx(Pe,{children:c&&!s.isPlayerDefeated&&e.jsx(M.div,{initial:{opacity:0},animate:{opacity:[.3,.5,.3]},exit:{opacity:0},transition:{duration:2,repeat:1/0},className:"fixed inset-0 pointer-events-none z-40",style:{background:"radial-gradient(ellipse at center, transparent 40%, rgba(220,38,38,0.4) 100%)"}})}),e.jsx("div",{className:"w-full bg-gradient-to-b from-background via-background/95 to-transparent",style:{paddingTop:"max(env(safe-area-inset-top, 0px), 8px)",paddingLeft:"env(safe-area-inset-left, 0px)",paddingRight:"env(safe-area-inset-right, 0px)"},children:e.jsxs("div",{className:"px-2 pt-0.5 pb-1",children:[e.jsx(fy,{imageUrl:r,name:a,hpPercent:s.adversaryHPPercent,isDefeated:s.isAdversaryDefeated}),e.jsxs(M.div,{className:"flex items-center justify-center gap-1.5 mt-1 mb-0.5",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{delay:.2},children:[e.jsx("span",{className:"text-purple-400 text-xs",children:"âš”ï¸"}),e.jsx("h2",{className:"text-sm font-bold text-purple-300 tracking-wide uppercase truncate max-w-[200px]",children:a}),e.jsx("span",{className:"text-purple-400 text-xs",children:"âš”ï¸"})]}),e.jsx("div",{className:"w-full px-1",children:e.jsx(hy,{currentHP:s.adversaryHP,maxHP:s.adversaryMaxHP,isPlayer:!1,showNumbers:!0})}),o!==void 0&&l!==void 0&&e.jsx("div",{className:"w-full px-1 mt-1",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-1.5 bg-muted/30 rounded-full overflow-hidden",children:e.jsx(M.div,{className:"h-full rounded-full",style:{width:`${o/l*100}%`,background:o<=10?"linear-gradient(90deg, #ef4444, #f87171)":"linear-gradient(90deg, hsl(var(--primary)), hsl(var(--accent)))"},animate:o<=10?{opacity:[1,.6,1]}:{},transition:{duration:.5,repeat:1/0}})}),e.jsxs("span",{className:`text-xs font-mono font-bold min-w-[32px] text-right ${o<=10?"text-red-400":"text-muted-foreground"}`,children:[o,"s"]})]})})]})})]})}),qn=()=>{const{user:t}=be(),s=n.useRef(new Set),r=n.useCallback(async b=>{if(t&&!s.current.has(b.type)){s.current.add(b.type);try{const{data:v,error:x}=await S.from("achievements").upsert({user_id:t.id,achievement_type:b.type,title:b.title,description:b.description,icon:b.icon,tier:b.tier,metadata:b.metadata||{}},{onConflict:"user_id,achievement_type",ignoreDuplicates:!0}).select("id").maybeSingle();v&&!x&&(W.success("ðŸ† Achievement Unlocked!",{description:b.title}),Og())}catch(v){console.error("Error awarding achievement:",v)}}},[t]),a=async b=>{b===3?await r({type:"three_day_streak",title:"Getting Started",description:"3 days of consistency",icon:"flame",tier:"silver",metadata:{streak:b,pepTalkDuration:"2-3 min",pepTalkMessage:"You're showing effort today. Keep that energy.",pepTalkCategory:"encouragement"}}):b===7?await r({type:"week_streak",title:"Week of Discipline",description:"7 days of unwavering commitment",icon:"trophy",tier:"gold",metadata:{streak:b,pepTalkDuration:"4-5 min",pepTalkMessage:"You're not who you were last week. You're growing.",pepTalkCategory:"discipline"}}):b===14?await r({type:"two_week_streak",title:"Fortnight Fighter",description:"14 days of unwavering discipline",icon:"trophy",tier:"gold",metadata:{streak:b,pepTalkDuration:"4-5 min",pepTalkMessage:"Two weeks of showing up. That's the discipline talking.",pepTalkCategory:"discipline"}}):b===30&&await r({type:"month_streak",title:"Transformed",description:"30 days - You're not the same person anymore",icon:"crown",tier:"platinum",metadata:{streak:b,pepTalkDuration:"7-10 min",pepTalkMessage:"A month ago, you started. Today, you're different. This is transformation.",pepTalkCategory:"breakthrough"}})},i=async b=>{b===1?await r({type:"first_challenge",title:"Challenge Accepted",description:"Completed your first challenge",icon:"target",tier:"bronze"}):b===5?await r({type:"challenge_veteran",title:"Challenge Veteran",description:"Completed 5 challenges",icon:"target",tier:"silver"}):b===10&&await r({type:"challenge_master",title:"Challenge Master",description:"Completed 10 challenges",icon:"target",tier:"gold"})},o=async b=>{await r({habit:{type:"first_habit",title:"First Step",description:"Created your first habit",icon:"check",tier:"bronze",metadata:{pepTalkDuration:"1 min",pepTalkMessage:"Welcome. Every journey starts with one step.",pepTalkCategory:"welcome"}},checkin:{type:"first_checkin",title:"Good Morning",description:"Completed your first check-in",icon:"sunrise",tier:"bronze",metadata:{pepTalkDuration:"1 min",pepTalkMessage:"You showed up today. That matters.",pepTalkCategory:"welcome"}},peptalk:{type:"first_peptalk",title:"Listening",description:"Listened to your first pep talk",icon:"headphones",tier:"bronze",metadata:{pepTalkDuration:"1 min",pepTalkMessage:"You're here. You're listening. Keep going.",pepTalkCategory:"welcome"}},mission:{type:"first_mission",title:"Mission Accepted",description:"Completed your first mission",icon:"target",tier:"bronze",metadata:{pepTalkDuration:"1 min",pepTalkMessage:"One mission down. This is how change happens.",pepTalkCategory:"welcome"}}}[b])},l=async b=>{b===3?await r({type:"companion_stage_3",title:"Growing Together",description:"Your companion reached Stage 3",icon:"sparkles",tier:"silver",metadata:{stage:b,pepTalkDuration:"2-3 min",pepTalkMessage:"Watch how your companion changes as you do.",pepTalkCategory:"growth"}}):b===5?await r({type:"companion_stage_5",title:"Deep Bond",description:"Your companion reached Stage 5",icon:"sparkles",tier:"gold",metadata:{stage:b,pepTalkDuration:"4-5 min",pepTalkMessage:"Stage 5. You're both different now.",pepTalkCategory:"discipline"}}):b===10?await r({type:"companion_stage_10",title:"Evolution Master",description:"Your companion reached Stage 10",icon:"star",tier:"gold",metadata:{stage:b,pepTalkDuration:"4-5 min",pepTalkMessage:"Stage 10. This is discipline and consistency made visible.",pepTalkCategory:"discipline"}}):b===15?await r({type:"companion_stage_15",title:"Transcendent Bond",description:"Your companion reached Stage 15",icon:"crown",tier:"platinum",metadata:{stage:b,pepTalkDuration:"7-10 min",pepTalkMessage:"You've come so far together. This bond is real.",pepTalkCategory:"breakthrough"}}):b===20&&await r({type:"companion_max",title:"Legendary Bond",description:"Your companion reached maximum evolution",icon:"crown",tier:"platinum",metadata:{stage:b,pepTalkDuration:"7-10 min",pepTalkMessage:"Stage 20. You didn't just evolve your companion. You evolved yourself.",pepTalkCategory:"breakthrough"}})},c=async(b,v)=>{const x=b.charAt(0).toUpperCase()+b.slice(1);v===5?await r({type:`${b}_5`,title:`${x} Awakening`,description:`${x} attribute reached 5`,icon:"zap",tier:"silver",metadata:{attribute:b,value:v,pepTalkDuration:"2-3 min",pepTalkMessage:`Your ${b} is growing. You're feeling it, aren't you?`,pepTalkCategory:"growth"}}):v===10?await r({type:`${b}_10`,title:`${x} Mastery`,description:`${x} attribute reached 10`,icon:"zap",tier:"gold",metadata:{attribute:b,value:v,pepTalkDuration:"4-5 min",pepTalkMessage:`${x} at 10. This is what discipline looks like.`,pepTalkCategory:"discipline"}}):v===15&&await r({type:`${b}_15`,title:`${x} Transcendence`,description:`${x} attribute reached 15`,icon:"crown",tier:"platinum",metadata:{attribute:b,value:v,pepTalkDuration:"7-10 min",pepTalkMessage:`${x} at 15. You're operating at a different level now.`,pepTalkCategory:"breakthrough"}})},d=async b=>{b>=50&&await r({type:"total_attributes_50",title:"Balanced Transformation",description:"Total attributes reached 50",icon:"crown",tier:"platinum",metadata:{total:b,pepTalkDuration:"7-10 min",pepTalkMessage:"Mind, Body, Soul - all growing together. This is true transformation.",pepTalkCategory:"breakthrough"}})},m=async b=>{b===3?await r({type:"peptalk_listener_3",title:"Active Listener",description:"Listened to 3 pep talks this week",icon:"headphones",tier:"silver",metadata:{count:b,pepTalkDuration:"2-3 min",pepTalkMessage:"You're not just listening. You're absorbing.",pepTalkCategory:"encouragement"}}):b===10&&await r({type:"peptalk_listener_10",title:"Devoted Student",description:"Listened to 10 pep talks",icon:"headphones",tier:"gold",metadata:{count:b,pepTalkDuration:"4-5 min",pepTalkMessage:"Ten talks. You're committed to this growth.",pepTalkCategory:"discipline"}})},p=async()=>{await r({type:"all_tasks_complete",title:"Perfect Day",description:"Completed every task today",icon:"check-circle",tier:"silver",metadata:{pepTalkDuration:"2-3 min",pepTalkMessage:"You did it all today. Every. Single. Thing.",pepTalkCategory:"encouragement"}})},h=async b=>{await r({type:`story_chapter_${b}`,title:`Chapter ${b} Complete`,description:`Finished story chapter ${b}`,icon:"book",tier:"gold",metadata:{chapter:b,pepTalkDuration:"4-5 min",pepTalkMessage:"Another chapter. Your story is unfolding.",pepTalkCategory:"discipline"}})},f=async()=>{await r({type:"full_storyline",title:"Story Complete",description:"Completed the entire companion storyline",icon:"crown",tier:"platinum",metadata:{pepTalkDuration:"7-10 min",pepTalkMessage:"The full story. From beginning to now. Look at how far you've come.",pepTalkCategory:"breakthrough"}})},u=async()=>{await r({type:"comeback_arc",title:"The Comeback",description:"Returned stronger after a break",icon:"crown",tier:"platinum",metadata:{pepTalkDuration:"7-10 min",pepTalkMessage:"You came back. That's what matters. Welcome home.",pepTalkCategory:"breakthrough"}})},g=n.useCallback(async()=>{await r({type:"arcade_explorer",title:"Arcade Explorer",description:"Discovered the hidden Astral Arcade",icon:"gamepad-2",tier:"silver",metadata:{pepTalkMessage:"You found the secret arcade. Nice work, explorer.",pepTalkCategory:"discovery"}})},[r]),y=n.useCallback(async(b,v)=>{const x={distraction:{prefix:"Focus",icon:"target"},stagnation:{prefix:"Momentum",icon:"waves"},anxiety:{prefix:"Serenity",icon:"heart"},doubt:{prefix:"Confidence",icon:"shield"},chaos:{prefix:"Order",icon:"zap"},laziness:{prefix:"Drive",icon:"flame"},overthinking:{prefix:"Clarity",icon:"brain"},fear:{prefix:"Courage",icon:"shield"},confusion:{prefix:"Wisdom",icon:"sparkles"},vulnerability:{prefix:"Resilience",icon:"gem"},imbalance:{prefix:"Harmony",icon:"scale"}},{prefix:w,icon:j}=x[b];let D=!1,C=null;return v===3?await r({type:`astral_${b}_3`,title:`${w} Initiate`,description:`Defeated 3 ${b} adversaries`,icon:j,tier:"bronze",metadata:{theme:b,count:3}}):v===10?(await r({type:`astral_${b}_10`,title:`${w} Warrior`,description:`Defeated 10 ${b} adversaries`,icon:j,tier:"silver",metadata:{theme:b,count:10}}),D=!0,C="rare"):v===25?(await r({type:`astral_${b}_25`,title:`${w} Champion`,description:`Defeated 25 ${b} adversaries`,icon:j,tier:"gold",metadata:{theme:b,count:25}}),D=!0,C="epic"):v===50&&(await r({type:`astral_${b}_50`,title:`${w} Transcendent`,description:`Defeated 50 ${b} adversaries`,icon:j,tier:"platinum",metadata:{theme:b,count:50}}),D=!0,C="legendary"),{shouldRollLoot:D,lootTier:C}},[r]);return{awardAchievement:r,checkStreakAchievements:a,checkChallengeAchievements:i,checkFirstTimeAchievements:o,checkCompanionAchievements:l,checkAttributeAchievements:c,checkTotalAttributesAchievement:d,checkPepTalkListeningAchievements:m,checkDailyCompletionAchievement:p,checkStoryChapterAchievement:h,checkFullStorylineAchievement:f,checkComebackAchievement:u,checkArcadeDiscovery:g,checkAdversaryDefeatAchievements:y}},gy=()=>{const{data:t,isLoading:s,error:r}=Ee({queryKey:["evolution-thresholds"],queryFn:async()=>{const{data:c,error:d}=await S.from("evolution_thresholds").select("*").order("stage",{ascending:!0});if(d)throw d;return c},staleTime:1/0,gcTime:1/0}),a=t?.reduce((c,d)=>(c[d.stage]=d.xp_required,c),{}),i=c=>a?.[c]??null;return{thresholds:t,thresholdMap:a,isLoading:s,error:r,getThreshold:i,shouldEvolve:(c,d)=>{const m=i(c+1);return m!==null&&d>=m},getStageName:c=>t?.find(d=>d.stage===c)?.stage_name??`Stage ${c}`}},ri={EASY:12,MEDIUM:16,HARD:22},ai={EASY:10,MEDIUM:14,HARD:20},xy={HABIT_COMPLETE:8,ALL_HABITS_COMPLETE:20,CHALLENGE_COMPLETE:25,WEEKLY_CHALLENGE:60,PEP_TALK_LISTEN:8,CHECK_IN:4,EVENING_REFLECTION:4,WEEKLY_RECAP_VIEWED:5,STREAK_MILESTONE:15,WELCOME_BACK_BONUS:25},yy={XP_PER_DAY:10},js={SESSION_COMPLETE:20,PERFECT_FOCUS_BONUS:5,DAILY_SESSION_CAP:4,CAPPED_SESSION_XP:3},ni={SUBTASK_COMPLETE:3,ALL_SUBTASKS_BONUS:10},Wa={TOP_THREE_COMPLETE:15,ALL_TOP_THREE_BONUS:30,URGENT_IMPORTANT:10,NOT_URGENT_IMPORTANT:12},Ga={PROCESS_INBOX:2,INBOX_ZERO:10,VOICE_CAPTURE:3},sa={WEEKLY_REVIEW:25,DAILY_REVIEW:8,HIGH_PRODUCTIVITY_DAY:20,PERFECT_DAY:35},ii={ON_TIME_COMPLETION:5,CONTEXT_MATCH:3},tr={REGULAR:20,POSTCARD:35,PHASE_COMPLETE:45,EPIC_COMPLETE:120},qi=1.5;function by(t){return{easy:ri.EASY,medium:ri.MEDIUM,hard:ri.HARD}[t]}function vy(t){return t<=4?1:t===5?.75:t===6?.5:t<=8?.25:(t<=10,.1)}function rl(t,s){const r=by(t),a=vy(s);return Math.round(r*a)}async function xu(t,s={}){const{onRetry:r,onValidating:a}=s;a?.();const{data:i,error:o}=await S.functions.invoke("generate-companion-image",{body:{...t,...typeof s.maxRetries=="number"?{maxInternalRetries:s.maxRetries}:{}}});if(o){const m=o.message||String(o);throw console.error("[Validation] Image generation error:",m),m.includes("INSUFFICIENT_CREDITS")||m.includes("Insufficient AI credits")?new Error("The companion creation service is temporarily unavailable. Please contact support."):m.includes("RATE_LIMITED")||m.includes("busy")?new Error("The service is currently busy. Please wait a moment and try again."):m.includes("AI_TIMEOUT")||m.includes("GENERATION_TIMEOUT")||m.toLowerCase().includes("timed out")?new Error("GENERATION_TIMEOUT: Companion creation is taking longer than expected. Please try again."):m.includes("NO_AUTH_HEADER")||m.includes("INVALID_AUTH")?new Error("Your session has expired. Please refresh the page and try again."):new Error(m||"Failed to generate companion image. Please try again.")}if(!i?.imageUrl)throw console.error("[Validation] No image URL in result:",i),new Error("Unable to create your companion's image. Please try again.");const l=i.qualityScore,c=l?.retryCount||0;c>0&&r&&r(c);const d=l?l.overallScore>=70||!l.shouldRetry:!0;return console.log(`[Validation] Complete - Score: ${l?.overallScore||"N/A"}, Retries: ${c}, Passed: ${d}`),{imageUrl:i.imageUrl,validationPassed:d,retryCount:c}}const wy=["failed to send a request to the edge function","failed to fetch","network","timeout","timed out","econnreset","connection","fetcherror","functionsfetcherror"];function yr(t){return typeof t=="string"&&t.trim().length>0?t:void 0}function _y(){return typeof navigator<"u"?navigator.onLine===!1:!1}function yu(t){if(!t||typeof t!="object"||!("context"in t))return;const s=t.context;return s instanceof Response?s:void 0}function jy(t){const s=yu(t);if(s)return s.status;if(t&&typeof t=="object"){const r=t.status;if(typeof r=="number")return r}}function Ny(t){if(!t)return!1;const s=t.toLowerCase();return wy.some(r=>s.includes(r))}function ky(t){const{name:s,message:r,status:a,backendMessage:i,isOffline:o}=t;if(o)return"network";if(a===401||a===403)return"auth";if(a===429)return"rate_limit";const l=(s??"").toLowerCase(),c=(r??"").toLowerCase(),d=(i??"").toLowerCase(),m=`${l} ${c} ${d}`;return l.includes("functionsrelayerror")||m.includes("relay error invoking the edge function")?"relay":Ny(m)?"network":typeof a=="number"&&a>=400?"http":"unknown"}async function bu(t){const s=t&&typeof t=="object"?yr(t.name):void 0,r=t&&typeof t=="object"?yr(t.message):t instanceof Error?t.message:void 0,a=t&&typeof t=="object"?yr(t.code):void 0,i=jy(t),o=_y();let l;const c=yu(t);if(c)try{const p=await c.clone().json();if(p&&typeof p=="object"&&!Array.isArray(p)){const h=p,f=yr(h.message),u=yr(h.error),g=yr(h.code);(f||u||g)&&(l={message:f,error:u,code:g})}}catch{}const d=l?.message??l?.error,m=ky({name:s,message:r,status:i,backendMessage:d,isOffline:o});return{name:s,message:r,status:i,code:a,responsePayload:l,backendMessage:d,isOffline:o,category:m}}function Cy(t){const s=t.toLowerCase();return s.includes("edge function")||s.includes("functionsfetcherror")||s.includes("relay error")||s.includes("failed to send a request")}function vu(t,s){const r=s?.action??"complete this action";return t.isOffline||t.category==="network"?`We couldn't reach the server to ${r}. Check your connection and try again.`:t.category==="auth"?`Your session has expired. Please sign in again and try to ${r}.`:t.category==="rate_limit"?t.backendMessage??"You're making requests too quickly. Please wait a moment and try again.":t.category==="relay"||t.status===408||typeof t.status=="number"&&t.status>=500?"Our servers are temporarily unavailable. Please try again in a moment.":t.category==="http"&&t.backendMessage&&!Cy(t.backendMessage)?t.backendMessage:`Unable to ${r}. Please try again.`}const _s=xy,wu=t=>["companion",t],Sy=async t=>{const{data:s,error:r}=await S.from("user_companion").select("*").eq("user_id",t).maybeSingle();if(r)throw r;return s},Ey="XP service is temporarily unavailable. Please try again shortly.",ja=t=>{if(!t)return null;const s=t.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");return s.length>0?s:null},Ty=t=>{if(!t)return!1;if(ja(t.code)==="42883")return!0;const r=[t.message,t.details,t.hint].filter(a=>typeof a=="string"&&a.trim().length>0).join(" ").toLowerCase();return r.includes("award_xp_v2")&&(r.includes("could not find function")||r.includes("does not exist")||r.includes("schema cache")||r.includes("undefined function")||r.includes("function not found"))},_u=t=>t.includes("not_enough_xp")||t.includes("not enough xp")?{code:"not_enough_xp",message:"Your companion is not ready to evolve yet.",category:"xp"}:t.includes("max_stage_reached")||t.includes("max stage")?{code:"max_stage_reached",message:"Your companion has already reached the maximum stage.",category:"max_stage"}:t.includes("already_evolved")||t.includes("already evolved")?{code:"already_evolved",message:"Your companion already evolved to this stage.",category:"duplicate"}:t.includes("companion_not_found")||t.includes("companion not found")?{code:"companion_not_found",message:"No companion found to evolve.",category:"not_found"}:t.includes("not_authenticated")||t.includes("permission denied")||t.includes("jwt")||t.includes("unauthorized")?{code:"unauthorized",message:"Your session has expired. Please sign in again and try evolving.",category:"auth"}:t.includes("rate_limited")||t.includes("rate limit")||t.includes("too many requests")||t.includes("429")?{code:"rate_limited",message:"Evolution is on cooldown. Please try again in a little while.",category:"rate_limit"}:null,My=t=>t.includes("request_companion_evolution_job")&&(t.includes("could not find")||t.includes("schema cache"))||t.includes("companion_evolution_jobs")&&t.includes("does not exist")||t.includes("failed to fetch")||t.includes("network")||t.includes("timeout")||t.includes("timed out")||t.includes("temporarily unavailable")||t.includes("relay")||t.includes("service_unavailable"),Dy=t=>{const s=[t?.code,t?.message,t?.error].filter(Boolean).join(" ").toLowerCase();return s.includes("not enough xp")?"Your companion is not ready to evolve yet.":s.includes("max stage")?"Your companion has already reached the maximum stage.":s.includes("companion not found")?"No companion found to evolve.":s.includes("rate limit")?"Evolution is on cooldown. Please try again in a little while.":"Unable to start evolution right now. Please try again."},Py=t=>{const s=[t?.code,t?.message,t?.error].filter(Boolean).join(" ").toLowerCase(),r=_u(s);return r?{message:r.message,failureClass:"terminal",reason:r.category,code:r.code}:My(s)?{message:"Evolution service is temporarily unavailable. Please try again in a minute.",failureClass:"retryable_infrastructure",reason:"direct_payload_infrastructure",code:ja(t?.code)??"evolution_service_unavailable"}:{message:Dy(t),failureClass:"non_retryable",reason:"direct_payload_terminal",code:ja(t?.code)}},Ay=async t=>{const s=await bu(t),r=`${s.responsePayload?.code??""} ${s.backendMessage??""} ${s.message??""}`.toLowerCase(),a=_u(r);return a?{message:a.message,failureClass:"terminal",reason:a.category,code:a.code,invokeCategory:s.category,invokeStatus:s.status??null}:s.category==="auth"?{message:"Your session has expired. Please sign in again and try evolving.",failureClass:"terminal",reason:"auth",code:"unauthorized",invokeCategory:s.category,invokeStatus:s.status??null}:s.category==="rate_limit"?{message:"Evolution is on cooldown. Please try again in a little while.",failureClass:"terminal",reason:"rate_limit",code:"rate_limited",invokeCategory:s.category,invokeStatus:s.status??null}:s.category==="network"||s.category==="relay"||s.status===408||typeof s.status=="number"&&s.status>=500?{message:"Evolution service is temporarily unavailable. Please try again in a minute.",failureClass:"retryable_infrastructure",reason:"invoke_infrastructure",code:ja(s.responsePayload?.code??s.code)??"evolution_service_unavailable",invokeCategory:s.category,invokeStatus:s.status??null}:{message:vu(s,{action:"start evolution"}),failureClass:"non_retryable",reason:"invoke_unknown",code:ja(s.responsePayload?.code??s.code),invokeCategory:s.category,invokeStatus:s.status??null}},Ry=async t=>{if(t instanceof Error&&t.message.trim().length>0)return t;const s=await bu(t),r=vu(s,{action:"start evolution"});return new Error(r)},ra=2,Ya=[400,900],al=async t=>{const s=t;await new Promise(r=>setTimeout(r,s))},nl=t=>{const s=Math.max(0,Math.min(t-1,Ya.length-1));return Ya[s]??Ya[Ya.length-1]},Tt=(t={})=>{const{enabled:s=!0}=t,{user:r}=be(),a=Ae(),{checkCompanionAchievements:i}=qn(),{isEvolvingLoading:o,setIsEvolvingLoading:l}=Pn(),{getThreshold:c,shouldEvolve:d}=gy(),m=n.useRef(!1),p=n.useRef(null),h=n.useRef(!1),{data:f,isLoading:u,error:g,refetch:y}=Ee({queryKey:wu(r?.id),queryFn:async()=>r?Sy(r.id):null,enabled:s&&!!r,staleTime:6e4,gcTime:1800*1e3,placeholderData:E=>E,retry:3,retryDelay:E=>Math.min(1e3*2**E,5e3)}),b=le({mutationFn:async E=>{const k=Date.now();if(!r)throw new Error("Not authenticated");if(h.current)throw new Error("Companion creation already in progress");h.current=!0;try{oe.log("Starting companion creation process..."),oe.info("Companion creation started",{userId:r.id,spiritAnimal:E.spiritAnimal,coreElement:E.coreElement,stage:0});const P=`glowing ${E.favoriteColor}`,T=E.favoriteColor;oe.log("Generating companion image with validation...");const{imageUrl:I,validationPassed:R,retryCount:L}=await xu({favoriteColor:E.favoriteColor,spiritAnimal:E.spiritAnimal,element:E.coreElement,stage:0,eyeColor:P,furColor:T,storyTone:E.storyTone,flowType:"onboarding"},{maxRetries:0,onRetry:re=>{oe.log(`Validation failed, retrying image generation (attempt ${re})...`)},onValidating:()=>{oe.log("Validating generated image for anatomical issues...")}});L>0?oe.log(`Image generated after ${L} validation retry(ies), passed: ${R}`):oe.log(`Image generated on first attempt, validation passed: ${R}`);const $={imageUrl:I};oe.log("Image generated successfully, creating companion record...");const q=await S.rpc("create_companion_if_not_exists",{p_user_id:r.id,p_favorite_color:E.favoriteColor,p_spirit_animal:E.spiritAnimal,p_core_element:E.coreElement,p_story_tone:E.storyTone,p_current_image_url:$.imageUrl,p_initial_image_url:$.imageUrl,p_eye_color:P,p_fur_color:T});if(q.error)throw console.error("Database error creating companion:",q.error),new Error(`Failed to save companion to database: ${q.error.message}`);const F=q.data;if(oe.log("RPC call successful, result:",F),!F||F.length===0)throw oe.error("No companion data returned from function"),new Error("Failed to create companion record. Please try again.");const H=F[0],J=H.is_new;oe.log(`Companion ${J?"created":"already exists"}:`,H.id);const{data:G}=await S.from("companion_evolutions").select("id").eq("companion_id",H.id).eq("stage",0).maybeSingle();if(!G){oe.log("Creating stage 0 evolution...");const{data:re,error:ie}=await S.from("companion_evolutions").insert({companion_id:H.id,stage:0,image_url:$.imageUrl,xp_at_evolution:0}).select().maybeSingle();if(ie)throw console.error("Failed to create stage 0 evolution:",ie),new Error(`Unable to record stage 0 evolution: ${ie.message}`);if(!re)throw console.error("Stage 0 evolution insert returned no data"),new Error("Unable to record stage 0 evolution");(async()=>{try{const{data:xe}=await S.from("user_companion").select("*").eq("id",H.id).single();await S.functions.invoke("generate-evolution-card",{body:{companionId:H.id,evolutionId:re.id,stage:0,species:H.spirit_animal,element:H.core_element,color:H.favorite_color,userAttributes:{vitality:xe?.vitality||300,wisdom:xe?.wisdom||300,discipline:xe?.discipline||300,resolve:xe?.resolve||300,creativity:xe?.creativity||300,alignment:xe?.alignment||300}}}),a.invalidateQueries({queryKey:["evolution-cards"]})}catch(xe){console.error("Stage 0 card generation failed (non-critical):",xe)}})()}return J&&(async(ie=3)=>{for(let K=1;K<=ie;K++)try{const{error:xe}=await S.functions.invoke("generate-companion-story",{body:{companionId:H.id,stage:0}});if(xe)throw xe;oe.log("Stage 0 story generation started"),a.invalidateQueries({queryKey:["companion-story"]}),a.invalidateQueries({queryKey:["companion-stories-all"]});return}catch(xe){const Te=xe instanceof Error?xe.message:String(xe),Ne=Te.includes("network")||Te.includes("timeout")||Te.includes("temporarily unavailable");if(K<ie&&Ne){oe.log(`Story generation attempt ${K} failed, retrying...`),await new Promise(B=>setTimeout(B,2e3*K));continue}console.error(`Failed to auto-generate stage 0 story after ${K} attempts:`,xe);break}})().catch(ie=>{console.warn("Story generation failed (non-critical):",ie?.message||ie)}),oe.info("Companion creation completed",{userId:r.id,durationMs:Date.now()-k}),H}catch(P){throw h.current=!1,oe.error("Companion creation mutation failed",{userId:r.id,durationMs:Date.now()-k,error:P instanceof Error?P.message:String(P)}),P}},onSuccess:()=>{h.current=!1,a.invalidateQueries({queryKey:["companion"]}),oe.log("Companion creation successful!")},onError:E=>{h.current=!1,console.error("Failed to create companion:",E)}}),v=le({mutationFn:async({eventType:E,xpAmount:k,metadata:P={},idempotencyKey:T})=>{if(!r)throw new Error("No user found");let I=f;if(!I&&(oe.warn("Companion not loaded yet, fetching..."),await a.refetchQueries({queryKey:["companion",r.id]}),I=a.getQueryData(["companion",r.id]),!I))throw new Error("No companion found. Please create one first.");return await x(I,k,E,P,r,T)},onSuccess:async({shouldEvolve:E,newStage:k})=>{a.invalidateQueries({queryKey:["companion"]}),E&&(await i(k),W.success("âœ¨ Your companion is ready to evolve! Visit your companion page.",{duration:5e3}))},onError:E=>{console.error("XP award failed:",E);const k=E instanceof Error&&E.message?E.message:"Failed to award XP. Please try again.";W.error(k)}}),x=async(E,k,P,T,I,R)=>{if(!I?.id)throw new Error("Not authenticated");const L=Object.fromEntries(Object.entries(T).filter(([,ie])=>ie!==void 0)),$=R??(typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).slice(2,10)}`),{data:q,error:F}=await S.rpc("award_xp_v2",{p_event_type:P,p_xp_amount:k,p_event_metadata:L,p_idempotency_key:$});if(F)throw Ty(F)?(oe.error("award_xp_v2 unavailable during XP award",{userId:I.id,eventType:P,idempotencyKey:$,error_code:F.code??null,error_message:F.message??null,error_details:F.details??null,error_hint:F.hint??null}),new Error(Ey)):F;const H=Array.isArray(q)?q[0]:q;if(!H)throw new Error("XP award returned no data");const J=!!H.should_evolve,G=H.xp_after??E.current_xp,re=J?E.current_stage+1:E.current_stage;return oe.log("[XP Award Debug]",{eventType:P,requestedXP:k,awardedXP:H.xp_awarded,capApplied:H.cap_applied,currentStage:E.current_stage,currentXP:H.xp_before,newXP:G,nextThreshold:H.next_threshold,shouldEvolve:J,idempotencyKey:$}),{shouldEvolve:J,newStage:re,newXP:G,xpAwarded:H.xp_awarded??0,capApplied:!!H.cap_applied,nextThreshold:H.next_threshold??null}},w=le({mutationFn:async({newStage:E,currentXP:k})=>{if(m.current)return oe.log("Evolution already in progress, rejecting duplicate request"),p.current&&await p.current,null;m.current=!0;const P=(async()=>{if(!r||!f)throw m.current=!1,new Error("No companion found");l(!0);try{for(let T=1;T<=ra;T+=1){const{data:I,error:R}=await S.functions.invoke("generate-companion-evolution",{body:{}});if(R){const $=await Ay(R);if($.failureClass==="retryable_infrastructure"&&T<ra){oe.warn("Direct evolution invoke failed; retrying",{attempt:T,max_attempts:ra,reason:$.reason,status:$.invokeStatus,category:$.invokeCategory}),await al(nl(T));continue}throw new Error($.message)}const L=I??null;if(!L||L.evolved!==!0){const $=Py(L);if($.failureClass==="retryable_infrastructure"&&T<ra){oe.warn("Direct evolution returned unsuccessful payload; retrying",{attempt:T,max_attempts:ra,reason:$.reason,code:$.code}),await al(nl(T));continue}throw new Error($.message)}return{newStage:typeof L.new_stage=="number"?L.new_stage:null}}throw new Error("Evolution service is temporarily unavailable. Please try again in a minute.")}catch(T){throw oe.error("Evolution mutation failed",{error:T instanceof Error?T.message:String(T)}),m.current=!1,l(!1),await Ry(T)}})();p.current=P;try{return await P}finally{p.current=null}},onSuccess:E=>{m.current=!1,l(!1),E&&(a.invalidateQueries({queryKey:["companion"]}),a.invalidateQueries({queryKey:["companion-stories-all"]}),a.invalidateQueries({queryKey:["evolution-cards"]}),a.invalidateQueries({queryKey:["current-evolution-card"]}))},onError:E=>{m.current=!1,l(!1),console.error("Evolution failed:",{name:E.name,message:E.message});const k=E instanceof Error&&E.message?E.message:"Unable to evolve your companion right now. Please try again.";W.error(k)}}),j=n.useMemo(()=>f?c(f.current_stage+1):null,[f,c]),D=n.useMemo(()=>{if(!f||!j)return 0;const E=c(f.current_stage)??0,k=j-E;if(k<=0)return 100;const P=(f.current_xp-E)/k*100;return Math.min(100,Math.max(0,P))},[f,c,j]),C=n.useMemo(()=>f?d(f.current_stage,f.current_xp):!1,[f,d]),_=w.isPending,N=n.useCallback(()=>{if(!f||_||!C)return;const E=f.current_stage+1;l(!0),window.dispatchEvent(new CustomEvent("evolution-loading-start")),w.mutate({newStage:E,currentXP:f.current_xp})},[f,C,w,_,l]);return{companion:f,isLoading:u,error:g,refetch:y,createCompanion:b,awardXP:v,evolveCompanion:w,nextEvolutionXP:j,progressToNext:D,isEvolvingLoading:o,canEvolve:C,isEvolutionBusy:_,triggerManualEvolution:N}},Iy=({theme:t,tier:s,name:r,enabled:a=!0})=>{const[i,o]=n.useState(null),[l,c]=n.useState(!1),[d,m]=n.useState(null);return n.useEffect(()=>{if(!a||!t||!s)return;(async()=>{c(!0),m(null);try{const{data:h}=await S.from("adversary_images").select("image_url").eq("theme",t).eq("tier",s).maybeSingle();if(h?.image_url){console.log(`Using cached adversary image for ${t}/${s}`),o(h.image_url),c(!1);return}console.log(`Generating new adversary image for ${t}/${s}`);const{data:f,error:u}=await S.functions.invoke("generate-adversary-image",{body:{theme:t,tier:s,name:r}});if(u)throw new Error(u.message);if(f?.imageUrl)o(f.imageUrl);else if(f?.error)throw new Error(f.error)}catch(h){console.error("Failed to get adversary image:",h),m(h instanceof Error?h.message:"Failed to load image")}finally{c(!1)}})()},[t,s,r,a]),{imageUrl:i,isLoading:l,error:d}};function Ly({tier:t,onPlayerDefeated:s,onAdversaryDefeated:r,onDamageDealt:a}){const i=zx[t],o=n.useRef({onPlayerDefeated:s,onAdversaryDefeated:r,onDamageDealt:a});o.current={onPlayerDefeated:s,onAdversaryDefeated:r,onDamageDealt:a};const[l,c]=n.useState(i.playerHP),[d,m]=n.useState(i.adversaryHP),[p,h]=n.useState([]),f=l<=0,u=d<=0,g=n.useMemo(()=>({playerHP:Math.max(0,l),playerMaxHP:i.playerHP,adversaryHP:Math.max(0,d),adversaryMaxHP:i.adversaryHP,isPlayerDefeated:f,isAdversaryDefeated:u,playerHPPercent:Math.max(0,l/i.playerHP*100),adversaryHPPercent:Math.max(0,d/i.adversaryHP*100)}),[l,d,i,f,u]),y=n.useCallback(x=>{f||u||(h(w=>[...w,x]),o.current.onDamageDealt?.(x),x.target==="player"?c(w=>{const j=w-x.amount;return j<=0&&setTimeout(()=>o.current.onPlayerDefeated?.(),0),Math.max(0,j)}):m(w=>{const j=w-x.amount;return j<=0&&setTimeout(()=>o.current.onAdversaryDefeated?.(),0),Math.max(0,j)}))},[f,u]),b=n.useCallback(()=>{c(i.playerHP),m(i.adversaryHP),h([])},[i]),v=n.useCallback(()=>Kx(l,i.playerHP,f),[l,i.playerHP,f]);return{battleState:g,dealDamage:y,resetBattle:b,getResult:v,tierAttackDamage:i.attackDamage,damageEvents:p}}const qy={distraction:"tap_sequence",chaos:"galactic_match",stagnation:"energy_beam",laziness:"energy_beam",anxiety:"orb_match",overthinking:"galactic_match",doubt:"tap_sequence",fear:"energy_beam",confusion:"orb_match",vulnerability:"energy_beam",imbalance:"tap_sequence"},ju={distraction:"mind",chaos:"mind",stagnation:"body",laziness:"body",anxiety:"soul",overthinking:"soul",doubt:"mind",fear:"body",confusion:"soul",vulnerability:"body",imbalance:"mind"},lo={common:{phases:1,statBoost:1,xpBase:35},uncommon:{phases:1,statBoost:2,xpBase:45},rare:{phases:2,statBoost:3,xpBase:55},epic:{phases:2,statBoost:4,xpBase:75},legendary:{phases:3,statBoost:5,xpBase:100}},Oy={perfect:1.5,good:1,fail:0},Fy=[{name:"Doomscrolling",icon:"ðŸ“±",theme:"distraction"},{name:"Sugar Cravings",icon:"ðŸ¬",theme:"laziness"},{name:"Skipping Workouts",icon:"ðŸƒ",theme:"stagnation"},{name:"Stress Eating",icon:"ðŸ•",theme:"anxiety"},{name:"Procrastination",icon:"â°",theme:"stagnation"},{name:"Negative Self-Talk",icon:"ðŸ’­",theme:"doubt"},{name:"Nail Biting",icon:"ðŸ’…",theme:"anxiety"},{name:"Junk Food",icon:"ðŸ”",theme:"laziness"},{name:"Social Media",icon:"ðŸ“²",theme:"distraction"},{name:"Overthinking",icon:"ðŸ§ ",theme:"overthinking"}],Nu={distraction:["Riftling","Scatter","Flickering","Wandering"],chaos:["Vortex","Maelstrom","Turbulent","Entropic"],stagnation:["Mire","Stillborn","Frozen","Anchored"],laziness:["Slumber","Drift","Languor","Torpid"],anxiety:["Tremor","Spiral","Frantic","Restless"],overthinking:["Echo","Loop","Recursive","Tangled"],doubt:["Shadow","Whisper","Fading","Hollow"],fear:["Dread","Creeping","Lurking","Umbral"],confusion:["Maze","Veiled","Obscured","Fogbound"],vulnerability:["Exposed","Piercing","Breaching","Unshielded"],imbalance:["Tilting","Wavering","Unstable","Teetering"]},ku={common:["Wisp","Shade","Specter","Phantom"],uncommon:["Wraith","Spirit","Haunt","Revenant"],rare:["Fiend","Demon","Harbinger","Herald"],epic:["Lord","Tyrant","Sovereign","Monarch"],legendary:["Titan","Colossus","Primordial","Ancient"]},$y={distraction:["Born from scattered thoughts and fractured focus, this entity feeds on mental chaos.","A creature of fleeting moments, it thrives where attention wavers and concentration breaks."],chaos:["Manifested from the entropy of unordered days, this being revels in disorder.","Where plans crumble and routines shatter, this adversary grows stronger."],stagnation:["Formed in the depths of inaction, this entity chains the willing to the unchanging.","A manifestation of paralysis, it whispers that tomorrow is always better."],laziness:["Born from abandoned intentions and forsaken goals, it lulls the ambitious to sleep.","This creature grows fat on postponed dreams and delayed action."],anxiety:["Woven from racing heartbeats and sleepless nights, it amplifies every worry.","A storm of what-ifs given form, feeding on uncertainty and dread."],overthinking:["Created from endless mental loops and circular reasoning, it traps minds in analysis.","This entity spins thoughts into mazes with no exit."],doubt:["A shadow of self-belief, it whispers inadequacy to those who dare to dream.","Born from hesitation and second-guessing, it erodes confidence grain by grain."],fear:["Materialized from primal terrors and modern anxieties, it paralyzes the brave.","This ancient adversary has hunted dreamers since the first star was wished upon."],confusion:["A living labyrinth, this entity thrives when paths blur and direction fades.","Born from lost purpose and wandering souls, it delights in disorientation."],vulnerability:["Forged from moments of exposure and defenselessness, it strikes at unguarded hearts.","This predator hunts those who lower their shields, feeding on raw weakness."],imbalance:["Spawned from tilted scales and unstable foundations, it topples the centered.","Where equilibrium falters and harmony breaks, this adversary finds its strength."]},Hy={distraction:["Focus Essence","Clarity Core","Concentration Crystal"],chaos:["Order Essence","Harmony Shard","Balance Core"],stagnation:["Motion Essence","Momentum Crystal","Flow Core"],laziness:["Vigor Essence","Energy Shard","Drive Core"],anxiety:["Calm Essence","Serenity Crystal","Peace Core"],overthinking:["Stillness Essence","Simplicity Shard","Clarity Core"],doubt:["Confidence Essence","Belief Crystal","Courage Core"],fear:["Bravery Essence","Valor Shard","Fearless Core"],confusion:["Direction Essence","Pathfinder Shard","Clarity Star"],vulnerability:["Shield Essence","Guardian Core","Protection Crystal"],imbalance:["Equilibrium Essence","Stability Shard","Center Core"]},By={distraction:"Sharpens mental acuity and strengthens focus.",chaos:"Brings order to turbulent thoughts.",stagnation:"Ignites the spark of movement and progress.",laziness:"Fuels the body with renewed energy.",anxiety:"Soothes the spirit and calms racing thoughts.",overthinking:"Quiets the endless mental chatter.",doubt:"Reinforces self-belief and inner strength.",fear:"Transforms terror into courageous resolve.",confusion:"Illuminates the path forward with clarity.",vulnerability:"Fortifies inner defenses and builds resilience.",imbalance:"Restores harmony and centers the spirit."},Er=t=>t[Math.floor(Math.random()*t.length)],Uy=(t,s)=>t==="weekly"?"uncommon":t==="quest_milestone"?"common":t==="urge_resist"?Math.random()>.7?"uncommon":"common":t==="epic_checkpoint"&&s!==void 0?s>=100?"legendary":s>=75?"epic":s>=50?"rare":"uncommon":"common",zy=(t,s)=>{if(t==="urge_resist"&&s&&["distraction","chaos","stagnation","laziness","anxiety","overthinking","doubt","fear","confusion","vulnerability","imbalance"].includes(s))return s;if(t==="epic_checkpoint"&&s){const a={fitness:["stagnation","laziness"],health:["stagnation","laziness"],body:["stagnation","laziness"],mind:["distraction","overthinking"],learning:["distraction","overthinking"],focus:["distraction","chaos"],soul:["anxiety","fear"],spiritual:["anxiety","doubt"],wellness:["anxiety","fear"],productivity:["chaos","laziness"],creative:["doubt","fear"]},i=s.toLowerCase();for(const[o,l]of Object.entries(a))if(i.includes(o))return Er(l)}return Er(["distraction","chaos","stagnation","laziness","anxiety","overthinking","doubt","fear","confusion","vulnerability","imbalance"])},Qy=(t,s)=>{const r=Nu[t],a=ku[s];return r.flatMap(i=>a.map(o=>`${i} ${o}`))},Ky=t=>!t||t.length===0?new Set:new Set(t.map(s=>s.trim()).filter(s=>s.length>0)),Wy=(t,s,r)=>{const a=Qy(t,s);if(a.length===0)return`${Er(Nu[t])} ${Er(ku[s])}`;const i=Ky(r),o=i.size>0?a.filter(c=>!i.has(c)):a,l=o.length>0?o:a;return Er(l)},Gy=t=>{let s=0;for(let r=0;r<t.length;r+=1)s=s*31+t.charCodeAt(r)>>>0;return s},Yy=(t,s)=>{const r=$y[t];if(!r||r.length===0)return"";const a=Gy(`${t}:${s}`)%r.length;return r[a]},Vy=(t,s,r,a,i)=>{const o=Uy(t,s),l=zy(t,r),c=lo[o],d=Wy(l,o,i?.avoidNames),m=Yy(l,d),p=Er(Hy[l]),h=By[l];return{name:d,theme:l,tier:o,lore:m,miniGameType:qy[l],phases:c.phases,essenceName:p,essenceDescription:h,statType:ju[l],statBoost:c.statBoost}},Cu=(t,s,r)=>{const a=lo[t].xpBase,i=Su(s),o=Oy[i],l=r?1.25:1;return Math.round(a*o*l)},Su=t=>t>=90?"perfect":t>=50?"good":"fail";function je({className:t,...s}){return e.jsx("div",{className:A("relative overflow-hidden rounded-md bg-muted/40",t),...s,children:e.jsx("div",{className:"absolute inset-0 -translate-x-full animate-shimmer bg-gradient-to-r from-transparent via-muted/20 to-transparent"})})}const Xy=()=>e.jsxs("div",{className:"min-h-screen bg-background p-4 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between pt-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(je,{className:"h-6 w-32"}),e.jsx(je,{className:"h-4 w-48"})]}),e.jsx(je,{className:"h-10 w-10 rounded-full"})]}),e.jsxs(We,{className:"p-6 space-y-3",children:[e.jsx(je,{className:"h-4 w-full"}),e.jsx(je,{className:"h-4 w-5/6"}),e.jsx(je,{className:"h-3 w-24 ml-auto"})]}),e.jsxs(We,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(je,{className:"h-12 w-12 rounded-full"}),e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(je,{className:"h-5 w-36"}),e.jsx(je,{className:"h-4 w-24"})]})]}),e.jsx(je,{className:"h-2 w-full rounded-full"}),e.jsx(je,{className:"h-10 w-full rounded-md"})]}),e.jsxs(We,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(je,{className:"h-6 w-32"}),e.jsx(je,{className:"h-6 w-6 rounded-full"})]}),e.jsx("div",{className:"flex justify-between",children:[...Array(5)].map((t,s)=>e.jsx(je,{className:"h-10 w-10 rounded-full"},s))})]}),e.jsxs(We,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(je,{className:"h-10 w-10 rounded-full"}),e.jsx(je,{className:"h-5 w-40"})]}),e.jsx(je,{className:"h-12 w-full rounded-lg"})]}),e.jsxs(We,{className:"p-6 space-y-4",children:[e.jsx(je,{className:"h-6 w-36"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{className:"h-4 w-full"}),e.jsx(je,{className:"h-4 w-3/4"})]})]})]}),Jy=()=>e.jsxs("div",{className:"w-full max-w-md mx-auto space-y-4 p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(je,{className:"h-6 w-16 rounded-full"}),e.jsx(je,{className:"h-8 w-20"}),e.jsx(je,{className:"h-6 w-16 rounded-full"})]}),e.jsx(je,{className:"h-2 w-full rounded-full"}),e.jsxs("div",{className:"relative aspect-square rounded-2xl overflow-hidden",children:[e.jsx(je,{className:"absolute inset-0"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(je,{className:"h-24 w-24 rounded-full"})}),e.jsx(je,{className:"absolute top-4 left-4 h-10 w-10 rounded-full"}),e.jsx(je,{className:"absolute top-4 right-4 h-10 w-10 rounded-full"}),e.jsx(je,{className:"absolute bottom-4 left-4 h-10 w-10 rounded-full"}),e.jsx(je,{className:"absolute bottom-4 right-4 h-10 w-10 rounded-full"})]}),e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx(je,{className:"h-5 w-48 mx-auto"}),e.jsx(je,{className:"h-4 w-32 mx-auto"})]}),e.jsx(je,{className:"h-12 w-full rounded-lg"})]}),Zy=()=>e.jsxs(We,{className:"p-5 md:p-6 space-y-4 animate-pulse",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(je,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{className:"h-5 w-32"}),e.jsx(je,{className:"h-3 w-20"})]})]})}),e.jsx(je,{className:"h-2 w-full"}),e.jsx("div",{className:"space-y-2",children:[1,2,3].map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx(je,{className:"h-5 w-5 rounded-full"}),e.jsx(je,{className:"h-4 w-full max-w-xs"})]}),e.jsx(je,{className:"h-9 w-24"})]},t))})]}),il=n.lazy(()=>ke(()=>import("./EnergyBeamGame-BmV2dlUs.js"),__vite__mapDeps([0,1,2,3,4])).then(t=>({default:t.EnergyBeamGame}))),e0=n.lazy(()=>ke(()=>import("./TapSequenceGame-Co8xL4xG.js"),__vite__mapDeps([5,1,2,3,4])).then(t=>({default:t.TapSequenceGame}))),t0=n.lazy(()=>ke(()=>import("./AstralFrequencyGame-8lhy12jN.js"),__vite__mapDeps([6,1,2,3,4])).then(t=>({default:t.AstralFrequencyGame}))),s0=n.lazy(()=>ke(()=>import("./EclipseTimingGame-DV4_nD0g.js"),__vite__mapDeps([7,1,2,3,4])).then(t=>({default:t.EclipseTimingGame}))),r0=n.lazy(()=>ke(()=>import("./StarfallDodgeGame-CLnaBcWv.js"),__vite__mapDeps([8,1,2,3,4])).then(t=>({default:t.StarfallDodgeGame}))),a0=n.lazy(()=>ke(()=>import("./SoulSerpentGame-D3Kq0Ubq.js"),__vite__mapDeps([9,1,2,3,4])).then(t=>({default:t.SoulSerpentGame}))),n0=n.lazy(()=>ke(()=>import("./OrbMatchGame-BV1zt-J7.js"),__vite__mapDeps([10,1,2,3,4])).then(t=>({default:t.OrbMatchGame}))),i0=n.lazy(()=>ke(()=>import("./GalacticMatchGame-sEezCMVN.js"),__vite__mapDeps([11,1,2,3,4])).then(t=>({default:t.GalacticMatchGame}))),oi=new Set,o0=({open:t,onOpenChange:s,encounter:r,adversary:a,questInterval:i=3,onComplete:o,onPass:l,isBossBattle:c=!1,bossBattleContext:d,onBossBattleCancel:m})=>{const[p,h]=n.useState("reveal"),[f,u]=n.useState(0),[g,y]=n.useState([]),[b,v]=n.useState(!1),[x,w]=n.useState(null),[j,D]=n.useState(!1),[C,_]=n.useState(0),[N,E]=n.useState(0),{companion:k,refetch:P}=Tt(),T=n.useRef(!1);n.useEffect(()=>{t&&P()},[t,P]);const{data:I}=Ee({queryKey:["current-evolution-card",k?.id,k?.current_stage],queryFn:async()=>{if(!k?.id)return null;const{data:he}=await S.from("companion_evolution_cards").select("creature_name").eq("companion_id",k.id).eq("evolution_stage",k.current_stage||0).maybeSingle();return he},enabled:!!k?.id&&t}),{battleState:R,dealDamage:L,resetBattle:$,getResult:q,tierAttackDamage:F,damageEvents:H}=Ly({tier:a?.tier||"common",onPlayerDefeated:()=>{T.current||(T.current=!0,J("fail"))},onAdversaryDefeated:()=>{T.current||(T.current=!0,J("victory"))},onDamageDealt:he=>{he.target==="player"&&(D(!0),setTimeout(()=>D(!1),300))}}),J=n.useCallback(async he=>{if(!a||!r)return;const ye=he==="fail"?"fail":q(),Ue=he==="fail"?0:Math.round(R.playerHPPercent),Re=he==="fail"?0:Cu(a.tier,Ue,b);if(!await o({encounterId:r.id,accuracy:Ue,phasesCompleted:he==="fail"?f:a.phases})){s(!1);return}w({result:ye,accuracy:Ue,xpEarned:Re,tiltBonus:b}),h("result")},[a,r,q,R.playerHPPercent,o,f,b,s]);n.useEffect(()=>{if(t){h(c?"boss_intro":"reveal"),u(0),y([]),w(null),v(!1),T.current=!1,$();const he=a?.tier||"common",ye=Ux[he];_(ye),E(ye)}},[t,c,$,a?.tier]),n.useEffect(()=>{if(p!=="battle"||T.current)return;if(C<=0){if(!T.current){T.current=!0;const ye=100-R.adversaryHPPercent,Ue=100-R.playerHPPercent,Re=ye>Ue?"victory":"fail";J(Re)}return}const he=setInterval(()=>{_(ye=>Math.max(0,ye-1))},1e3);return()=>clearInterval(he)},[p,C,R.adversaryHPPercent,R.playerHPPercent,J]);const{imageUrl:G,isLoading:re}=Iy({theme:a?.theme||"",tier:a?.tier||"",name:a?.name||"",enabled:!!a&&t}),ie={mind:Math.floor(((k?.wisdom??300)+(k?.creativity??300))/12),body:Math.floor(((k?.vitality??300)+(k?.discipline??300))/12),soul:Math.floor(((k?.resolve??300)+(k?.alignment??300))/12)},K=n.useCallback(()=>{if(!a)return"energy_beam";const ye={mind:["tap_sequence","galactic_match","orb_match"],body:["energy_beam"],soul:["orb_match","galactic_match"]}[a.statType]||["energy_beam","tap_sequence"];return a.phases===1?a.miniGameType:ye[f%ye.length]},[a,f]),xe=n.useCallback(()=>{s(!1)},[s]),Te=n.useCallback(()=>{h("reveal")},[]),Ne=n.useCallback(()=>{m?.(),xe()},[m,xe]),B=n.useCallback(()=>{h("instructions"),u(0),y([]),T.current=!1,$()},[$]),z=n.useCallback(()=>{const he=K();oi.has(he)?h("battle"):h("practice")},[K]),Q=n.useCallback(()=>{const he=K();oi.add(he),h("battle")},[K]),Y=n.useCallback(()=>{const he=K();oi.add(he),h("battle")},[K]),ue=n.useCallback(he=>{T.current||L(he)},[L]),fe=n.useCallback(he=>{if(!a||!r||T.current)return;he.usedTiltControls&&v(!0);const ye=[...g,he];y(ye),!(R.isPlayerDefeated||R.isAdversaryDefeated)&&(f<a.phases-1?(u(Ue=>Ue+1),h("instructions")):(u(0),h("instructions")))},[a,r,f,g,R.isPlayerDefeated,R.isAdversaryDefeated]),De=n.useCallback(()=>{if(!a)return null;const he=K(),ye=a.tier==="legendary"||a.tier==="epic"?"hard":a.tier==="rare"?"medium":"easy",Ue=(i-3)*.15,Re={companionStats:ie,onComplete:fe,difficulty:ye,questIntervalScale:Ue,onDamage:ue,tierAttackDamage:F,compact:!0},Ie=(()=>{switch(he){case"energy_beam":return il;case"tap_sequence":return e0;case"astral_frequency":return t0;case"eclipse_timing":return s0;case"starfall_dodge":return r0;case"soul_serpent":return a0;case"orb_match":return n0;case"galactic_match":return i0;default:return il}})();return e.jsx(n.Suspense,{fallback:e.jsx(Jy,{}),children:e.jsx(Ie,{...Re})})},[a,K,ie,fe,i,ue,F]);if(!r||!a)return null;const Ce=[],Be=K(),qe=(p==="battle"||p==="practice")&&Ce.includes(Be);return e.jsxs(e.Fragment,{children:[t&&qe&&e.jsxs("div",{className:"fixed inset-0 z-[100] bg-background",children:[p==="practice"&&e.jsx(el,{gameType:Be,companionStats:ie,onPracticeComplete:Q,onSkipPractice:Y,isFullscreen:!0}),p==="battle"&&e.jsxs(e.Fragment,{children:[e.jsx(sl,{battleState:R,adversaryImageUrl:G||void 0,adversaryName:a.name,showScreenShake:j,battleTimeLeft:C,battleTimeTotal:N}),e.jsx(tl,{damageEvents:H,className:"z-50"}),a.phases>1&&e.jsx("div",{className:"fixed top-24 left-1/2 -translate-x-1/2 z-50 flex gap-2",children:Array.from({length:a.phases}).map((he,ye)=>e.jsx("div",{className:`w-3 h-3 rounded-full ${ye<f?"bg-green-500":ye===f?"bg-primary animate-pulse":"bg-muted"}`},ye))}),De()]})]}),e.jsx(ns,{open:t&&!qe,onOpenChange:xe,children:e.jsx(Vt,{className:"sm:max-w-lg p-0 overflow-hidden bg-background border-border",children:e.jsxs(M.div,{className:"relative min-h-[500px] max-h-[90dvh] overflow-hidden flex flex-col",style:{paddingBottom:"env(safe-area-inset-bottom, 24px)"},animate:j?{x:[0,-4,4,-2,2,0]}:{},transition:{duration:.3},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/5 via-background to-accent/5"}),p==="battle"&&!qe&&e.jsx(tl,{damageEvents:H,className:"z-50"}),e.jsx("div",{className:"relative z-10 flex flex-col h-full min-h-[500px]",children:e.jsxs(Pe,{mode:"wait",children:[p==="boss_intro"&&c&&d&&e.jsx(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsx(py,{context:d,onBeginBattle:Te,onCancel:Ne})},"boss_intro"),p==="reveal"&&e.jsx(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsx(Gx,{adversary:a,adversaryImageUrl:G||void 0,isLoadingImage:re,companionImageUrl:k?.current_image_url||void 0,companionName:I?.creature_name||k?.spirit_animal||"Companion",companionStage:k?.current_stage||0,onReady:B,onPass:l})},"reveal"),p==="instructions"&&e.jsx(M.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},children:e.jsx(ey,{gameType:K(),onReady:z})},`instructions-${f}`),p==="practice"&&e.jsx(M.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},children:e.jsx(el,{gameType:K(),companionStats:ie,onPracticeComplete:Q,onSkipPractice:Y})},`practice-${f}`),p==="battle"&&!qe&&e.jsxs(M.div,{initial:{opacity:0,x:50},animate:{opacity:1,x:0},exit:{opacity:0,x:-50},className:"flex flex-col flex-1 min-h-0",children:[e.jsx(sl,{battleState:R,adversaryImageUrl:G||void 0,adversaryName:a.name,battleTimeLeft:C,battleTimeTotal:N}),a.phases>1&&e.jsx("div",{className:"flex justify-center gap-2 py-2",children:Array.from({length:a.phases}).map((he,ye)=>e.jsx("div",{className:`w-3 h-3 rounded-full ${ye<f?"bg-green-500":ye===f?"bg-primary animate-pulse":"bg-muted"}`},ye))}),e.jsx("div",{className:"flex-1 min-h-0",children:De()})]},`battle-${f}`),p==="result"&&x&&e.jsx(M.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0},children:e.jsx(Xx,{adversary:a,result:x.result,accuracy:x.accuracy,xpEarned:x.xpEarned,onClose:xe,retryAvailableAt:x.result==="fail"?new Date(Date.now()+14400*1e3).toISOString():void 0,tiltBonus:x.tiltBonus,companionImageUrl:k?.current_image_url||void 0,companionName:I?.creature_name||k?.spirit_animal||"Your companion"})},"result")]})})]})})})]})},l0={common:{primary:"hsl(var(--muted))",secondary:"hsl(var(--muted-foreground))",glow:"rgba(156, 163, 175, 0.5)"},uncommon:{primary:"hsl(142, 76%, 46%)",secondary:"hsl(142, 76%, 60%)",glow:"rgba(34, 197, 94, 0.5)"},rare:{primary:"hsl(217, 91%, 60%)",secondary:"hsl(217, 91%, 75%)",glow:"rgba(59, 130, 246, 0.5)"},epic:{primary:"hsl(271, 91%, 65%)",secondary:"hsl(271, 91%, 80%)",glow:"rgba(168, 85, 247, 0.5)"},legendary:{primary:"hsl(38, 92%, 50%)",secondary:"hsl(38, 92%, 70%)",glow:"rgba(245, 158, 11, 0.5)"}},c0=({isVisible:t,tier:s="common",onComplete:r})=>{const a=l0[s],i=n.useRef(!1),o=n.useRef(null),l=n.useRef(!1);return n.useEffect(()=>{t&&!i.current&&(i.current=!0,Fg()),t||(i.current=!1,l.current=!1,o.current&&(clearTimeout(o.current),o.current=null))},[t]),n.useEffect(()=>()=>{o.current&&(clearTimeout(o.current),o.current=null)},[]),t?e.jsxs(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onAnimationComplete:()=>{l.current||(l.current=!0,o.current=setTimeout(()=>{o.current=null,r()},2500))},className:"fixed inset-0 z-[9999] flex items-center justify-center overflow-hidden",style:{background:`linear-gradient(135deg, hsl(var(--background)) 0%, ${a.primary}20 50%, hsl(var(--background)) 100%)`,pointerEvents:"auto",touchAction:"none"},children:[e.jsx(M.div,{className:"absolute inset-0",style:{background:`radial-gradient(circle at center, ${a.glow} 0%, transparent 70%)`},animate:{scale:[1,1.5,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx(M.div,{className:"absolute w-96 h-96 rounded-full border-2",style:{borderColor:a.primary},initial:{scale:0,opacity:1},animate:{scale:[0,3,3],opacity:[1,.5,0]},transition:{duration:2,repeat:1/0,ease:"easeOut"}}),e.jsx(M.div,{className:"absolute w-64 h-64 rounded-full border",style:{borderColor:a.secondary},initial:{scale:0,opacity:1},animate:{scale:[0,4,4],opacity:[1,.3,0]},transition:{duration:2.5,repeat:1/0,delay:.3,ease:"easeOut"}}),e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(40)].map((c,d)=>e.jsx(M.div,{className:"absolute w-1.5 h-1.5 rounded-full",style:{backgroundColor:d%2===0?a.primary:a.secondary,boxShadow:`0 0 8px ${a.glow}`},initial:{x:Math.random()*(typeof window<"u"?window.innerWidth:400),y:(typeof window<"u"?window.innerHeight:800)+50},animate:{y:-50,x:Math.random()*(typeof window<"u"?window.innerWidth:400),scale:[0,1.5,0],opacity:[0,1,0]},transition:{duration:1.2+Math.random()*1.3,repeat:1/0,delay:Math.random()*1.5}},d))}),e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(12)].map((c,d)=>e.jsx(M.div,{className:"absolute w-3 h-3 rounded-full",style:{backgroundColor:a.secondary,boxShadow:`0 0 12px ${a.glow}`,left:"50%",top:"50%"},animate:{x:[0,Math.cos(d*30*Math.PI/180)*150,0],y:[0,Math.sin(d*30*Math.PI/180)*150,0],scale:[0,1,0],opacity:[0,1,0]},transition:{duration:2,repeat:1/0,delay:d*.1,ease:"easeInOut"}},`swirl-${d}`))}),e.jsxs("div",{className:"flex flex-col items-center gap-6 relative z-10",children:[e.jsxs(M.div,{className:"relative",initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200,damping:15,delay:.2},children:[e.jsx(M.div,{className:"absolute inset-0 rounded-full blur-xl",style:{backgroundColor:a.glow},animate:{scale:[1,1.5,1],opacity:[.5,.8,.5]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"}}),e.jsx(M.div,{className:"relative p-6 rounded-full",style:{background:`linear-gradient(135deg, ${a.primary}, ${a.secondary})`,boxShadow:`0 0 40px ${a.glow}`},animate:{rotate:[0,5,-5,0]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx(vh,{className:"w-16 h-16 text-white",style:{filter:"drop-shadow(0 0 10px white)"}})}),e.jsx(M.div,{className:"absolute -top-4 -right-4",animate:{scale:[0,1,0],opacity:[0,1,0]},transition:{duration:.8,repeat:1/0,delay:.5},children:e.jsx(ft,{className:"w-8 h-8",style:{color:a.secondary,filter:`drop-shadow(0 0 8px ${a.glow})`}})}),e.jsx(M.div,{className:"absolute -bottom-4 -left-4",animate:{scale:[0,1,0],opacity:[0,1,0]},transition:{duration:.8,repeat:1/0,delay:.8},children:e.jsx(ft,{className:"w-8 h-8",style:{color:a.secondary,filter:`drop-shadow(0 0 8px ${a.glow})`}})})]}),e.jsxs(M.div,{className:"text-center space-y-3",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},children:[e.jsx(M.h2,{className:"text-3xl md:text-4xl font-black text-foreground",style:{textShadow:`0 0 30px ${a.glow}`},animate:{opacity:[.8,1,.8]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"},children:"Astral Entity Detected!"}),e.jsx(M.p,{className:"text-lg text-muted-foreground",animate:{opacity:[.6,1,.6]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:"Prepare for battle..."})]})]})]}):null},On=n.forwardRef(({className:t,children:s,...r},a)=>e.jsxs(Bc,{ref:a,className:A("relative overflow-hidden",t),...r,children:[e.jsx(wh,{className:"h-full w-full rounded-[inherit]",children:s}),e.jsx(Eu,{}),e.jsx(_h,{})]}));On.displayName=Bc.displayName;const Eu=n.forwardRef(({className:t,orientation:s="vertical",...r},a)=>e.jsx(Uc,{ref:a,orientation:s,className:A("flex touch-none select-none transition-colors",s==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",s==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",t),...r,children:e.jsx(jh,{className:"relative flex-1 rounded-full bg-border"})}));Eu.displayName=Uc.displayName;const ol={vitality:{icon:"ðŸ’ª",name:"Vitality",color:"text-red-400",progressColor:"bg-red-400",whatItMeans:"Your life force, energy, and physical health. The engine of transformation.",boostedBy:["Fitness quests (gym, running, yoga)","Sleep rituals and rest goals","Nutrition and hydration habits","Cold showers and morning routines","Walking and step tracking"],whenGrows:"You build raw power and endurance. Your body becomes a vessel of strength and vitality."},wisdom:{icon:"ðŸ“š",name:"Wisdom",color:"text-blue-400",progressColor:"bg-blue-400",whatItMeans:"Pattern recognition, learning, and clarity. The foundation of insight.",boostedBy:["Reading books and articles","Studying and taking courses","Learning new skills","Mentor interactions and guidance","Reflection and journaling"],whenGrows:"You gain insight and understanding. Your mind sharpens and hidden patterns become clear."},discipline:{icon:"ðŸŽ¯",name:"Discipline",color:"text-green-400",progressColor:"bg-green-400",whatItMeans:"Reliability of action and consistency. The backbone of transformation.",boostedBy:["Completing daily rituals","Maintaining streaks","Showing up on hard days","Following through on plans","Deep work and Pomodoro sessions"],whenGrows:"You become someone who follows through. Your word to yourself becomes unbreakable."},resolve:{icon:"ðŸ›¡ï¸",name:"Resolve",color:"text-purple-400",progressColor:"bg-purple-400",whatItMeans:"Your ability to withstand pressure and resist urges. Inner fortitude.",boostedBy:["Resist victories","Astral Encounter wins","Comebacks after lapses","Staying strong during temptation","Overcoming setbacks"],whenGrows:"You become unshakeable. Pressure forges you into something stronger."},creativity:{icon:"ðŸŽ¨",name:"Creativity",color:"text-orange-400",progressColor:"bg-orange-400",whatItMeans:"Your ability to imagine, create, and express. The spark of originality.",boostedBy:["Shipping and building things","Writing and journaling","Art and design projects","Music and creative hobbies","Problem-solving and brainstorming"],whenGrows:"You see possibilities others miss. Your unique voice emerges."},alignment:{icon:"âœ¨",name:"Alignment",color:"text-celestial-blue",progressColor:"bg-celestial-blue",whatItMeans:"How aligned your actions are with who you want to be. Purpose and identity.",boostedBy:["Long-term campaign progress","Identity-based quests","Weekly reflections","Purpose journaling","Living by your values"],whenGrows:"You live with intention and meaning. Your actions reflect your truest self."}},d0={vitality:["discipline","alignment"],wisdom:["creativity","alignment"],discipline:["resolve"],resolve:["discipline","alignment"],creativity:["wisdom","discipline"],alignment:["resolve"]},li=100,ll=1e3,ci=300,Tu=()=>{const{user:t}=be(),s=Ae(),r=le({mutationFn:async({companionId:u,attribute:g,amount:y,applyEchoGains:b=!0})=>{if(!t)throw new Error("Not authenticated");const{data:v,error:x}=await S.from("user_companion").select("vitality, wisdom, discipline, resolve, creativity, alignment").eq("id",u).eq("user_id",t.id).maybeSingle();if(x)throw x;if(!v)throw new Error("Companion not found");const w=v[g]??ci,j=Math.max(li,Math.min(ll,w+y)),D={[g]:j,last_energy_update:new Date().toISOString()};if(b&&y>0){const _=d0[g]||[],N=Math.min(20,Math.floor(y*.2));if(N>0)for(const E of _){const k=v[E]??ci;D[E]=Math.min(ll,Math.max(li,k+N))}}const{error:C}=await S.from("user_companion").update(D).eq("id",u).eq("user_id",t.id);if(C)throw C;return{attribute:g,newValue:j,change:y}},onSuccess:u=>{if(s.invalidateQueries({queryKey:["companion"]}),Math.abs(u.change)>=50){const g=u.change>0?"â¬†ï¸":"â¬‡ï¸",y=u.change>0?"increased":"decreased",b=u0[u.attribute];W.success(`${g} ${b?.name||u.attribute} ${y}!`,{duration:2e3})}},onError:u=>{console.error("Attribute update failed:",u)}}),a=le({mutationFn:async u=>{if(!t)throw new Error("Not authenticated");await r.mutateAsync({companionId:u,attribute:"vitality",amount:12})}}),i=le({mutationFn:async u=>{if(!t)throw new Error("Not authenticated");await r.mutateAsync({companionId:u,attribute:"wisdom",amount:8})}}),o=le({mutationFn:async u=>{if(!t)throw new Error("Not authenticated");await r.mutateAsync({companionId:u,attribute:"discipline",amount:15})}}),l=le({mutationFn:async u=>{if(!t)throw new Error("Not authenticated");await r.mutateAsync({companionId:u,attribute:"discipline",amount:10})}}),c=le({mutationFn:async u=>{if(!t)throw new Error("Not authenticated");await r.mutateAsync({companionId:u,attribute:"resolve",amount:20})}}),d=le({mutationFn:async u=>{if(!t)throw new Error("Not authenticated");await r.mutateAsync({companionId:u,attribute:"creativity",amount:10})}}),m=le({mutationFn:async u=>{if(!t)throw new Error("Not authenticated");await r.mutateAsync({companionId:u,attribute:"alignment",amount:6})}}),p=le({mutationFn:async({companionId:u,streakDays:g})=>{if(!t)throw new Error("Not authenticated");let y=0;g===7?y=15:g===14?y=25:g===30?y=40:g%7===0&&(y=5),y>0&&await r.mutateAsync({companionId:u,attribute:"discipline",amount:y})}}),h=le({mutationFn:async u=>{if(!t)throw new Error("Not authenticated");await r.mutateAsync({companionId:u,attribute:"alignment",amount:8,applyEchoGains:!0})}}),f=le({mutationFn:async u=>{if(!t)throw new Error("Not authenticated");const{data:g,error:y}=await S.from("user_companion").select("vitality, wisdom, discipline, resolve, creativity, alignment").eq("id",u).eq("user_id",t.id).maybeSingle();if(y)throw y;if(!g)throw new Error("Companion not found");const b={discipline:40,vitality:30,creativity:25,resolve:20,wisdom:15,alignment:15},v={last_energy_update:new Date().toISOString()};for(const[w,j]of Object.entries(b)){const D=g[w]??ci;v[w]=Math.max(li,D-j)}const{error:x}=await S.from("user_companion").update(v).eq("id",u).eq("user_id",t.id);if(x)throw x}});return{updateAttribute:r.mutateAsync,updateVitalityFromFitness:a.mutateAsync,updateWisdomFromLearning:i.mutateAsync,updateDisciplineFromRitual:o.mutateAsync,updateDisciplineFromWork:l.mutateAsync,updateResolveFromResist:c.mutateAsync,updateCreativityFromShipping:d.mutateAsync,updateAlignmentFromReflection:m.mutateAsync,updateFromStreakMilestone:p.mutateAsync,updateFromPerfectDay:h.mutateAsync,decayStats:f.mutateAsync}},u0={vitality:{name:"Vitality"},wisdom:{name:"Wisdom"},discipline:{name:"Discipline"},resolve:{name:"Resolve"},creativity:{name:"Creativity"},alignment:{name:"Alignment"}},co=()=>{const{profile:t}=Yt();return n.useMemo(()=>{const s=t?.current_habit_streak??0,r=t?.longest_habit_streak??0;let a=1;s>=60?a=1.75:s>=30?a=1.5:s>=7&&(a=1.25);let i;return s<7?i={days:7,multiplier:1.25,daysRemaining:7-s}:s<30?i={days:30,multiplier:1.5,daysRemaining:30-s}:s<60?i={days:60,multiplier:1.75,daysRemaining:60-s}:i={days:60,multiplier:1.75,daysRemaining:0},{currentStreak:s,longestStreak:r,multiplier:a,nextMilestone:i}},[t?.current_habit_streak,t?.longest_habit_streak])},cl={quest:1,ritual:2,resist:3,pomodoro:1,mentor:1},m0=5,p0=7,h0="momentum_gain",dl={quest:"quest_count",ritual:"ritual_count",resist:"resist_count",pomodoro:"pomodoro_count",mentor:"mentor_count"},f0=()=>{const{user:t}=be(),s=n.useCallback(()=>new Date().toISOString().split("T")[0],[]),r=n.useCallback(async o=>{if(!t?.id)return{canShow:!1,sourceCount:0,totalCount:0,sourceLimit:cl[o]};const l=s(),c=dl[o],d=cl[o],{data:m,error:p}=await S.from("user_reaction_budget").select("*").eq("user_id",t.id).eq("budget_date",l).maybeSingle();if(p)return console.error("Failed to check reaction budget:",p),{canShow:!1,sourceCount:0,totalCount:0,sourceLimit:d};if(!m)return{canShow:!0,sourceCount:0,totalCount:0,sourceLimit:d};const h=m[c]||0,f=m.total_count||0;return{canShow:h<d&&f<m0,sourceCount:h,totalCount:f,sourceLimit:d}},[t?.id,s]),a=n.useCallback(async o=>{if(!t?.id)return!1;const l=s(),c=dl[o],{data:d}=await S.from("user_reaction_budget").select("*").eq("user_id",t.id).eq("budget_date",l).maybeSingle();if(d){const m=d[c]||0,p=d.total_count||0,{error:h}=await S.from("user_reaction_budget").update({[c]:m+1,total_count:p+1,updated_at:new Date().toISOString()}).eq("id",d.id);if(h)return console.error("Failed to update reaction budget:",h),!1}else{const{error:m}=await S.from("user_reaction_budget").insert({user_id:t.id,budget_date:l,[c]:1,total_count:1,updated_at:new Date().toISOString()});if(m)return console.error("Failed to insert reaction budget:",m),!1}return!0},[t?.id,s]),i=n.useCallback(async()=>{if(!t?.id)return null;const o=s(),{data:l}=await S.from("user_reaction_budget").select("*").eq("user_id",t.id).eq("budget_date",o).maybeSingle();return l},[t?.id,s]);return{checkBudget:r,incrementBudget:a,getBudgetStatus:i}},g0=()=>{const{user:t}=be(),s=n.useCallback(async()=>{if(!t?.id)return null;const{data:l}=await S.from("user_reaction_history").select("tone_tag").eq("user_id",t.id).order("shown_at",{ascending:!1}).limit(1).maybeSingle();return l?.tone_tag||null},[t?.id]),r=n.useCallback(async()=>{if(!t?.id)return!1;const l=new Date;l.setDate(l.getDate()-p0);const{data:c}=await S.from("user_reaction_history").select("reaction_id").eq("user_id",t.id).gte("shown_at",l.toISOString());if(!c||c.length===0)return!1;const d=c.map(p=>p.reaction_id).filter(Boolean);if(d.length===0)return!1;const{data:m}=await S.from("companion_reactions").select("id").in("id",d).contains("context_tags",["rare"]);return(m?.length||0)>0},[t?.id]),a=n.useCallback(async()=>{if(!t?.id)return new Set;const l=new Date;l.setDate(l.getDate()-7);const{data:c}=await S.from("user_reaction_history").select("reaction_id, shown_at").eq("user_id",t.id).gte("shown_at",l.toISOString());if(!c)return new Set;const d=c.map(u=>u.reaction_id).filter(Boolean);if(d.length===0)return new Set;const{data:m}=await S.from("companion_reactions").select("id, cooldown_hours").in("id",d);if(!m)return new Set;const p=new Map(m.map(u=>[u.id,u.cooldown_hours])),h=Date.now(),f=new Set;for(const u of c){if(!u.reaction_id)continue;const g=p.get(u.reaction_id)||12,y=new Date(u.shown_at).getTime(),b=g*60*60*1e3;h-y<b&&f.add(u.reaction_id)}return f},[t?.id]),i=n.useCallback(async(l,c,d=[])=>{if(!t?.id)return{reaction:null,reason:"No user"};const m=S.from("companion_reactions").select("id, text, tone_tag, context_tags, cooldown_hours").eq("is_active",!0).contains("source_systems",[l]),{data:p,error:h}=await m;if(h||!p||p.length===0)return{reaction:null,reason:"No reactions available"};let f=p;const{data:u}=await S.from("companion_reactions").select("id, text, tone_tag, context_tags, cooldown_hours").eq("is_active",!0).contains("source_systems",[l]).or(`moment_types.cs.{${c}},moment_types.eq.{}`);u&&u.length>0&&(f=u);const g=await a();if(f=f.filter(x=>!g.has(x.id)),f.length===0)return{reaction:null,reason:"All reactions on cooldown"};if(await r()&&(f=f.filter(x=>!x.context_tags?.includes("rare"))),f.length===0)return{reaction:null,reason:"No non-rare reactions available"};const b=await s();if(b){const x=f.filter(w=>w.tone_tag!==b);x.length>0&&(f=x)}if(d.length>0){const x=f.filter(w=>d.some(j=>w.context_tags?.includes(j)));x.length>0&&(f=x)}return{reaction:f[Math.floor(Math.random()*f.length)]}},[t?.id,a,r,s]),o=n.useCallback(async(l,c,d)=>{t?.id&&await S.from("user_reaction_history").insert({user_id:t.id,reaction_id:l.id,source_system:c,moment_type:d,reaction_text_snapshot:l.text,tone_tag:l.tone_tag})},[t?.id]);return{selectReaction:i,recordReaction:o}},Lr=n.forwardRef(({className:t,...s},r)=>e.jsx(zc,{ref:r,className:A("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",t),...s}));Lr.displayName=zc.displayName;const qr=n.forwardRef(({className:t,...s},r)=>e.jsx(Qc,{ref:r,className:A("aspect-square h-full w-full",t),...s}));qr.displayName=Qc.displayName;const Or=n.forwardRef(({className:t,...s},r)=>e.jsx(Kc,{ref:r,className:A("flex h-full w-full items-center justify-center rounded-full bg-muted",t),...s}));Or.displayName=Kc.displayName;const x0=t=>{const s=t.length;return Math.min(5,Math.max(3.2,3+s/50))},Mu=n.memo(({isVisible:t,onDismiss:s,message:r,companionName:a,companionImageUrl:i})=>{const[o,l]=n.useState(0),c=x0(r),d=typeof window<"u"&&window.matchMedia?.("(prefers-reduced-motion: reduce)").matches;n.useEffect(()=>{if(!t){l(0);return}const p=Date.now(),h=c*1e3,f=setInterval(()=>{const u=Date.now()-p,g=Math.min(100,u/h*100);l(g),u>=h&&(clearInterval(f),s())},50);return()=>clearInterval(f)},[t,c,s]);const m=n.useCallback(()=>{s()},[s]);return n.useEffect(()=>{if(!t)return;const p=h=>{(h.key==="Escape"||h.key==="Enter"||h.key===" ")&&(h.preventDefault(),m())};return window.addEventListener("keydown",p),()=>window.removeEventListener("keydown",p)},[t,m]),e.jsx(Pe,{children:t&&e.jsx(M.div,{initial:d?{opacity:1}:{opacity:0,y:20},animate:{opacity:1,y:0},exit:d?{opacity:0}:{opacity:0,y:10},transition:{duration:.2,ease:"easeOut"},className:A("fixed left-4 right-4 z-50 cursor-pointer","max-w-[680px] mx-auto","bottom-[calc(64px+env(safe-area-inset-bottom,0px)+12px)]"),onClick:m,role:"dialog","aria-modal":"false","aria-label":`${a} says: ${r}`,children:e.jsxs("div",{className:A("relative rounded-2xl overflow-hidden","bg-card/95 backdrop-blur-lg","border border-primary/20","shadow-lg shadow-primary/10"),children:[e.jsxs("div",{className:"flex items-start gap-4 p-4",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:A("rounded-xl overflow-hidden","ring-2 ring-primary/30","shadow-md shadow-primary/20"),children:e.jsxs(Lr,{className:"h-16 w-16 rounded-xl",children:[i?e.jsx(qr,{src:i,alt:a,className:"object-cover"}):null,e.jsx(Or,{className:"rounded-xl bg-primary/20 text-primary text-lg font-bold",children:a.charAt(0)})]})}),e.jsx("div",{className:"absolute inset-0 rounded-xl bg-primary/10 blur-xl -z-10"})]}),e.jsxs("div",{className:"flex-1 min-w-0 pt-1",children:[e.jsxs("p",{className:"text-foreground text-base leading-relaxed",children:['"',r,'"']}),e.jsxs("p",{className:"mt-2 text-sm text-muted-foreground flex items-center gap-1",children:["â€” ",a," ",e.jsx("span",{className:"text-primary",children:"âœ¨"})]})]}),e.jsx("button",{onClick:p=>{p.stopPropagation(),m()},className:A("flex-shrink-0 p-1.5 rounded-full","text-muted-foreground hover:text-foreground","hover:bg-muted/50 transition-colors","focus:outline-none focus:ring-2 focus:ring-primary/50"),"aria-label":"Dismiss",children:e.jsx(Nt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"px-4 pb-3",children:e.jsx(Hs,{value:o,className:"h-1 bg-muted/30"})})]})})})});Mu.displayName="CompanionTalkPopup";const Du=n.createContext(null),y0=t=>t.replace(/\b\w/g,s=>s.toUpperCase()),Pu=n.memo(({children:t})=>{const{companion:s}=Tt(),[r,a]=n.useState(!1),[i,o]=n.useState(""),[l,c]=n.useState("Companion"),[d,m]=n.useState(null),p=n.useRef([]),h=n.useRef(!1),f=n.useCallback(async()=>{if(!s)return"Companion";const y=s.cached_creature_name;if(y)return y;try{const{data:b}=await S.from("companion_evolution_cards").select("creature_name").eq("companion_id",s.id).eq("evolution_stage",s.current_stage).maybeSingle();if(b?.creature_name)return S.from("user_companion").update({cached_creature_name:b.creature_name}).eq("id",s.id).then(()=>{}),b.creature_name}catch(b){console.error("Failed to fetch creature name:",b)}return s.spirit_animal?y0(s.spirit_animal):"Companion"},[s]),u=n.useCallback(async y=>{if(h.current){p.current.push(y);return}h.current=!0;const b=y.companionName||await f(),v=y.companionImageUrl||s?.current_image_url||null;o(y.message),c(b),m(v),a(!0)},[s,f]),g=n.useCallback(()=>{a(!1),h.current=!1;const y=p.current.shift();y&&setTimeout(()=>u(y),300)},[u]);return e.jsxs(Du.Provider,{value:{show:u,dismiss:g,isVisible:r},children:[t,e.jsx(Mu,{isVisible:r,onDismiss:g,message:i,companionName:l,companionImageUrl:d})]})});Pu.displayName="TalkPopupProvider";const b0=()=>{const t=n.useContext(Du);return t||{show:async()=>{},dismiss:()=>{},isVisible:!1}},Ra=()=>{const{user:t}=be(),s=b0(),{checkBudget:r,incrementBudget:a}=f0(),{selectReaction:i,recordReaction:o}=g0(),l=n.useCallback(async(u,g={})=>{if(!t?.id)return!1;const{momentType:y=h0,contextTags:b=[],force:v=!1}=g;if(!v&&!(await r(u)).canShow)return console.log(`[LivingCompanion] Budget exceeded for ${u}`),!1;const{reaction:x,reason:w}=await i(u,y,b);return x?(await s.show({message:x.text}),await Promise.all([o(x,u,y),a(u)]),console.log(`[LivingCompanion] Showed reaction: "${x.text}" (${x.tone_tag})`),!0):(console.log(`[LivingCompanion] No reaction available: ${w}`),!1)},[t?.id,r,i,s,o,a]),c=n.useCallback(()=>{const u=new Date().getHours();return u>=23||u<4},[]),d=n.useCallback(async()=>{const u=c()?["late_night"]:[];return l("resist",{momentType:"urge_defeated",contextTags:u})},[l,c]),m=n.useCallback(async(u=!1)=>u?l("quest",{momentType:"momentum_gain"}):!1,[l]),p=n.useCallback(async(u=!1,g=!1)=>!u&&!g?!1:l("ritual",{momentType:g?"breakthrough":"discipline_win"}),[l]),h=n.useCallback(async u=>u<15?!1:l("pomodoro",{momentType:"focus_proof"}),[l]),f=n.useCallback(async()=>l("quest",{momentType:"comeback"}),[l]);return{triggerReaction:l,triggerResistVictory:d,triggerQuestComplete:m,triggerRitualComplete:p,triggerPomodoroComplete:h,triggerComeback:f,isLateNight:c}},v0=new Set(["task_complete","habit_complete","focus_session"]),Va=async t=>{const s=new Date().toISOString().split("T")[0];await S.from("user_companion").update({last_activity_date:s,inactive_days:0,current_mood:"happy"}).eq("user_id",t)},Xt=()=>{const{user:t}=be(),{companion:s,awardXP:r}=Tt(),{showXPToast:a}=Jd(),i=Ae(),{multiplier:o}=co(),{updateDisciplineFromRitual:l,updateWisdomFromLearning:c,updateAlignmentFromReflection:d,updateFromStreakMilestone:m}=Tu(),{triggerQuestComplete:p}=Ra(),h=async()=>{if(!t?.id)return!1;const B=new Date().toISOString().split("T")[0],{count:z}=await S.from("daily_tasks").select("*",{count:"exact",head:!0}).eq("user_id",t.id).eq("task_date",B).eq("completed",!0);return(z??0)<=1},f=(B,z)=>v0.has(z)?Math.round(B*(o??1)):B,u=(B,z)=>{const Q=z?Object.entries(z).filter(([,ue])=>ue!==void 0).map(([ue,fe])=>`${ue}:${String(fe)}`).sort().join("|"):"none",Y=typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).slice(2,10)}`;return`${B}:${Q}:${Y}`},g=(B,z,Q,Y)=>{r.mutate({eventType:B,xpAmount:z,metadata:Q,idempotencyKey:u(B,Q)})},y=(B,z,Q,Y)=>r.mutateAsync({eventType:B,xpAmount:z,metadata:Q,idempotencyKey:u(B,Q)}),b=async()=>{if(!(!s||r.isPending))try{t?.id&&Va(t.id).then(()=>{i.invalidateQueries({queryKey:["companion-health"]})});const B=f(_s.HABIT_COMPLETE,"habit_complete");a(B,"Habit Completed!"),g("habit_complete",B);const z=s.id;z&&(c(z).catch(Q=>{oe.error("Wisdom update failed:",Q)}),l(z).catch(Q=>{oe.error("Discipline update failed:",Q)})),h().then(Q=>{p(Q).catch(Y=>oe.log("[LivingCompanion] Quest reaction failed:",Y))})}catch(B){oe.error("Error awarding habit completion:",B)}},v=()=>{if(!s)return;const B=_s.ALL_HABITS_COMPLETE;a(B,"All Habits Complete!"),g("all_habits_complete",B)},x=()=>{if(!s)return;t?.id&&Va(t.id).then(()=>{i.invalidateQueries({queryKey:["companion-health"]})});const B=_s.CHALLENGE_COMPLETE;a(B,"Challenge Complete!"),g("challenge_complete",B)},w=()=>{if(!s)return;t?.id&&Va(t.id).then(()=>{i.invalidateQueries({queryKey:["companion-health"]})});const B=_s.WEEKLY_CHALLENGE;a(B,"Weekly Challenge Done!"),g("weekly_challenge",B)},j=B=>{if(!s)return;const z=_s.PEP_TALK_LISTEN;a(z,"Pep Talk Listened!"),g("pep_talk_listen",z,B)},D=async()=>{if(!(!s||r.isPending))try{t?.id&&Va(t.id).then(()=>{i.invalidateQueries({queryKey:["companion-health"]})});const B=_s.CHECK_IN;a(B,"Check-In Complete!"),g("check_in",B);const z=s.id;z&&(d(z).catch(Q=>{oe.error("Alignment update failed:",Q)}),l(z).catch(Q=>{oe.error("Discipline update failed:",Q)}))}catch(B){oe.error("Error awarding check-in:",B)}};return{awardHabitCompletion:b,awardAllHabitsComplete:v,awardChallengeCompletion:x,awardWeeklyChallengeCompletion:w,awardPepTalkListened:j,awardCheckInComplete:D,awardStreakMilestone:async B=>{if(!(!s||r.isPending))try{const z=_s.STREAK_MILESTONE;a(z,`${B} Day Streak!`),g("streak_milestone",z,{milestone:B});const Q=s.id;if(Q&&(m({companionId:Q,streakDays:B}).catch(Y=>oe.error("Discipline streak update failed:",Y)),B===7||B===30||B===100)){const Y=new Date().toISOString().split("T")[0];S.from("companion_memories").insert({user_id:t?.id,companion_id:Q,memory_type:"streak",memory_date:Y,memory_context:{title:`${B}-Day Streak`,description:`${B} days of dedication and growth together.`,emotion:B>=30?"joy":"pride",details:{streakDays:B}},referenced_count:0}).then(({error:ue})=>{ue&&oe.error("Failed to create streak memory:",ue)})}}catch(z){oe.error("Error awarding streak milestone:",z)}},awardReflectionComplete:async()=>{if(!(!s||r.isPending))try{const B=_s.EVENING_REFLECTION;a(B,"Reflection Saved!"),g("evening_reflection",B);const z=s.id;z&&d(z).catch(Q=>oe.error("Alignment update failed:",Q))}catch(B){oe.error("Error awarding reflection:",B)}},awardQuoteShared:()=>{if(!s)return;const B=_s.PEP_TALK_LISTEN;a(B,"Quote Shared!"),g("quote_shared",B)},awardCustomXP:async(B,z,Q,Y)=>{if(!s){oe.warn("Cannot award XP: companion not loaded yet");return}if(r.isPending){oe.warn("Cannot award XP: previous award still in progress");return}const ue=f(B,z);Q&&ue>0&&a(ue,Q);try{return await y(z,ue,Y)}catch(fe){oe.error("Error awarding custom XP:",fe)}},awardFocusSessionComplete:(B=!1,z=!0)=>{if(!s||r.isPending)return;let Q,Y;z?(Q=js.SESSION_COMPLETE,Y="Focus Session Complete!",B&&(Q+=js.PERFECT_FOCUS_BONUS,Y="Perfect Focus! ðŸŽ¯")):(Q=js.CAPPED_SESSION_XP,Y=B?"Bonus Focus! ðŸŽ¯":"Bonus Focus Session!");const ue=f(Q,"focus_session");a(ue,Y),g("focus_session",ue,{isPerfect:B,isUnderCap:z})},awardSubtaskComplete:()=>{if(!s)return;const B=ni.SUBTASK_COMPLETE;a(B,"Subtask Done!"),g("subtask_complete",B)},awardAllSubtasksComplete:()=>{if(!s)return;const B=ni.ALL_SUBTASKS_BONUS;a(B,"All Subtasks Complete! ðŸŽ‰"),g("all_subtasks_complete",B)},awardTopThreeComplete:()=>{if(!s)return;const B=Wa.TOP_THREE_COMPLETE;a(B,"Top 3 Task Done! ðŸŽ¯"),g("top_three_complete",B)},awardAllTopThreeComplete:()=>{if(!s)return;const B=Wa.ALL_TOP_THREE_BONUS;a(B,"All Top 3 Complete! ðŸ†"),g("all_top_three_complete",B)},awardUrgentTaskComplete:()=>{if(!s)return;const B=Wa.URGENT_IMPORTANT;a(B,"Urgent Task Done!"),g("urgent_task_complete",B)},awardInboxProcessed:()=>{if(!s)return;const B=Ga.PROCESS_INBOX;g("inbox_processed",B)},awardInboxZero:()=>{if(!s)return;const B=Ga.INBOX_ZERO;a(B,"Inbox Zero! ðŸ“­"),g("inbox_zero",B)},awardVoiceCapture:()=>{if(!s)return;const B=Ga.VOICE_CAPTURE;g("voice_capture",B)},awardWeeklyReview:()=>{if(!s)return;const B=sa.WEEKLY_REVIEW;a(B,"Weekly Review Complete! ðŸ“Š"),g("weekly_review",B)},awardDailyReview:()=>{if(!s)return;const B=sa.DAILY_REVIEW;a(B,"Daily Review Done!"),g("daily_review",B)},awardHighProductivityDay:()=>{if(!s)return;const B=sa.HIGH_PRODUCTIVITY_DAY;a(B,"Productive Day! ðŸ“ˆ"),g("high_productivity_day",B)},awardPerfectDay:()=>{if(!s)return;const B=sa.PERFECT_DAY;a(B,"Perfect Day! â­"),g("perfect_day",B)},awardOnTimeCompletion:()=>{if(!s)return;const B=ii.ON_TIME_COMPLETION;g("on_time_completion",B)},awardContextMatch:()=>{if(!s)return;const B=ii.CONTEXT_MATCH;g("context_match",B)},awardMilestoneComplete:(B=!1)=>{if(!s||r.isPending)return;const Q=B?tr.POSTCARD:tr.REGULAR;a(Q,B?"Celebration Milestone!":"Milestone Complete!"),g(B?"postcard_milestone":"milestone_complete",Q)},awardPhaseComplete:B=>{if(!s||r.isPending)return;const z=tr.PHASE_COMPLETE;a(z,`Phase Complete: ${B}!`),g("phase_complete",z,{phaseName:B})},awardEpicComplete:B=>{if(!s||r.isPending)return;const z=tr.EPIC_COMPLETE;a(z,"Epic Complete! ðŸ†"),g("epic_complete",z,{epicTitle:B});const Q=s.id;if(Q&&t?.id){const Y=new Date().toISOString().split("T")[0];S.from("companion_memories").insert({user_id:t.id,companion_id:Q,memory_type:"epic_complete",memory_date:Y,memory_context:{title:"Epic Complete",description:`We conquered "${B}" together!`,emotion:"pride",details:{epicTitle:B}},referenced_count:0}).then(({error:ue})=>{ue&&oe.error("Failed to create epic memory:",ue)})}},awardCheckIn:D,awardChallengeComplete:x,awardWeeklyChallenge:w,awardPepTalkListen:j,XP_REWARDS:_s,FOCUS_XP_REWARDS:js,SUBTASK_XP_REWARDS:ni,PRIORITY_XP_REWARDS:Wa,INBOX_XP_REWARDS:Ga,PRODUCTIVITY_XP_REWARDS:sa,SCHEDULING_XP_REWARDS:ii,MILESTONE_XP_REWARDS:tr}},w0=10,_0=()=>{const{user:t}=be(),{companion:s}=Tt(),{awardCustomXP:r}=Xt(),{checkAdversaryDefeatAchievements:a}=qn(),i=Ae(),{triggerResistVictory:o}=Ra(),l=n.useCallback((T,I)=>{if(T)throw new Error(`${I}: ${T.message}`)},[]),c=n.useCallback(T=>{if(!T||typeof T!="object")return!1;const I=T,R=I.code??"",L=I.message??"";return R==="23505"||L.includes("idx_astral_encounters_one_active_per_user")},[]),[d,m]=n.useState(null),[p,h]=n.useState(!1),[f,u]=n.useState(!1),g=n.useRef(!1),{data:y,isLoading:b}=Ee({queryKey:["astral-encounters",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:T,error:I}=await S.from("astral_encounters").select("*").eq("user_id",t.id).order("created_at",{ascending:!1}).limit(50);if(I)throw I;return T},enabled:!!t?.id}),{data:v,isLoading:x}=Ee({queryKey:["adversary-essences",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:T,error:I}=await S.from("adversary_essences").select("*").eq("user_id",t.id).order("absorbed_at",{ascending:!1});if(I)throw I;return T},enabled:!!t?.id}),{data:w,isLoading:j}=Ee({queryKey:["cosmic-codex",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:T,error:I}=await S.from("cosmic_codex_entries").select("*").eq("user_id",t.id).order("times_defeated",{ascending:!1});if(I)throw I;return T},enabled:!!t?.id}),D=v?.reduce((T,I)=>{const R=I.stat_type;return T[R]=(T[R]||0)+I.stat_boost,T},{mind:0,body:0,soul:0})||{mind:0,body:0,soul:0},C=le({mutationFn:async T=>{if(!t?.id||!s?.id)throw new Error("User or companion not found");const I=Array.from(new Set((y??[]).slice(0,w0).map(q=>q.adversary_name?.trim()).filter(q=>!!q))),R=Vy(T.triggerType,T.epicProgress,T.epicCategory,void 0,{avoidNames:I}),{data:L,error:$}=await S.from("astral_encounters").insert({user_id:t.id,companion_id:s.id,adversary_name:R.name,adversary_theme:R.theme,adversary_tier:R.tier,adversary_lore:R.lore,mini_game_type:R.miniGameType,trigger_type:T.triggerType,trigger_source_id:T.triggerSourceId||null,total_phases:R.phases}).select().single();if($)throw $;return{encounter:L,adversary:R,questInterval:T.questInterval}},onSuccess:({encounter:T,adversary:I,questInterval:R})=>{m({encounter:T,adversary:I,questInterval:R}),h(!1),i.invalidateQueries({queryKey:["astral-encounters"]})},onError:T=>{console.error("Failed to start encounter:",T),c(T)||W.error("Failed to start encounter")}}),_=le({mutationFn:async T=>{if(!t?.id||!s?.id||!d)throw new Error("Missing required data");const I=Su(T.accuracy),R=Cu(d.adversary.tier,T.accuracy),{error:L}=await S.from("astral_encounters").update({result:I,accuracy_score:T.accuracy,xp_earned:R,essence_earned:I!=="fail"?d.adversary.essenceName:null,stat_boost_type:I!=="fail"?d.adversary.statType:null,stat_boost_amount:I!=="fail"?d.adversary.statBoost:0,phases_completed:T.phasesCompleted,completed_at:new Date().toISOString(),retry_available_at:I==="fail"?new Date(Date.now()+14400*1e3).toISOString():null}).eq("id",T.encounterId);if(L)throw L;if(I!=="fail"){const{error:$}=await S.from("adversary_essences").insert({user_id:t.id,companion_id:s.id,encounter_id:T.encounterId,essence_name:d.adversary.essenceName,essence_description:d.adversary.essenceDescription,stat_type:d.adversary.statType,stat_boost:d.adversary.statBoost,adversary_name:d.adversary.name,adversary_theme:d.adversary.theme,rarity:d.adversary.tier});l($,"Failed to insert adversary essence");const{data:q,error:F}=await S.from("cosmic_codex_entries").select("id, times_defeated").eq("user_id",t.id).eq("adversary_theme",d.adversary.theme).maybeSingle();l(F,"Failed to query cosmic codex entry");let H=1;if(q){H=q.times_defeated+1;const{error:Q}=await S.from("cosmic_codex_entries").update({times_defeated:H,last_defeated_at:new Date().toISOString()}).eq("id",q.id);l(Q,"Failed to update cosmic codex entry")}else{const{error:Q}=await S.from("cosmic_codex_entries").insert({user_id:t.id,adversary_theme:d.adversary.theme,adversary_name:d.adversary.name,adversary_lore:d.adversary.lore});l(Q,"Failed to insert cosmic codex entry")}const J=d.adversary.theme,{shouldRollLoot:G,lootTier:re}=await a(J,H);if(G&&re){const Q=re==="legendary"?["rare","epic","legendary"]:re==="epic"?["rare","epic"]:["rare"],{data:Y,error:ue}=await S.from("epic_rewards").select("*").eq("adversary_theme",J).in("rarity",Q);if(l(ue,"Failed to fetch theme loot"),Y&&Y.length>0){const fe=Y.reduce((he,ye)=>he+(ye.drop_weight||100),0);let De=Math.random()*fe,Ce=Y[0];for(const he of Y)if(De-=he.drop_weight||100,De<=0){Ce=he;break}const{data:Be,error:qe}=await S.from("user_epic_rewards").select("id").eq("user_id",t.id).eq("reward_id",Ce.id).maybeSingle();if(l(qe,"Failed to check existing epic reward"),!Be){const{error:he}=await S.from("user_epic_rewards").insert({user_id:t.id,reward_id:Ce.id});l(he,"Failed to award epic reward"),W.success(`ðŸŽ New Loot: ${Ce.name}!`,{description:Ce.description})}}}const ie={mind:"wisdom",body:"vitality",soul:"resolve"},K=d.adversary.statType,xe=ie[K];if(!xe)return console.error("Invalid stat type:",K),{result:I,xpEarned:R};const Ne={vitality:s?.vitality??300,wisdom:s?.wisdom??300,discipline:s?.discipline??300,resolve:s?.resolve??300,creativity:s?.creativity??300,alignment:s?.alignment??300}[xe],B=Math.min(1e3,Ne+d.adversary.statBoost*3),{error:z}=await S.from("user_companion").update({[xe]:B}).eq("id",s.id);l(z,"Failed to update companion stats"),R>0&&await r(R,"astral_encounter",`Defeated ${d.adversary.name}`)}if(d.encounter.trigger_type==="urge_resist"){const $=d.encounter.trigger_source_id;if($){const{data:q,error:F}=await S.from("user_bad_habits").select("*").eq("id",$).maybeSingle();if(l(F,"Failed to fetch bad habit"),q){const H=I!=="fail",J=H?.05:0,{error:G}=await S.from("resist_log").insert({user_id:t.id,habit_id:$,encounter_id:T.encounterId,result:I,xp_earned:R,care_boost:J});l(G,"Failed to write resist log");const re=new Date,ie=q.last_resisted_at?new Date(q.last_resisted_at):null,K=ie?.toDateString()===re.toDateString(),xe=ie?.toDateString()===new Date(Date.now()-864e5).toDateString();let Te=q.current_streak;H?Te=xe?q.current_streak+1:K?q.current_streak:1:Te=0;const{error:Ne}=await S.from("user_bad_habits").update({times_resisted:q.times_resisted+(H?1:0),current_streak:Te,longest_streak:Math.max(q.longest_streak,Te),last_resisted_at:re.toISOString()}).eq("id",$);if(l(Ne,"Failed to update bad habit stats"),H&&s){const B=s.care_recovery??0,{error:z}=await S.from("user_companion").update({care_recovery:Math.min(1,B+J)}).eq("id",s.id);l(z,"Failed to update companion care recovery")}H&&W.success("You resisted! Your companion grows stronger.",{description:`+${R} XP â€¢ Streak: ${Te}`})}}}return{result:I,xpEarned:R}},onSuccess:({result:T,xpEarned:I})=>{i.invalidateQueries({queryKey:["astral-encounters"]}),i.invalidateQueries({queryKey:["adversary-essences"]}),i.invalidateQueries({queryKey:["cosmic-codex"]}),i.invalidateQueries({queryKey:["companion"]}),i.invalidateQueries({queryKey:["bad-habits"]}),i.invalidateQueries({queryKey:["resist-log"]}),T!=="fail"&&d?.encounter.trigger_type!=="urge_resist"&&W.success(`Victory! +${I} XP`),T!=="fail"&&d?.encounter.trigger_type==="urge_resist"&&o().catch(R=>console.log("[LivingCompanion] Resist trigger failed:",R))},onError:T=>{console.error("Failed to complete encounter:",T),W.error("Failed to complete encounter")}}),N=n.useCallback(T=>{const I=T.adversary_theme,R=T.adversary_tier;return{name:T.adversary_name,theme:I,tier:R,lore:T.adversary_lore||"",miniGameType:T.mini_game_type,phases:T.total_phases||1,essenceName:`Essence of ${T.adversary_name}`,essenceDescription:`Power absorbed from defeating ${T.adversary_name}`,statType:ju[I]||"mind",statBoost:lo[R]?.statBoost||1}},[]),E=n.useCallback(async(T,I,R,L,$)=>{if(!t?.id)return{ok:!1,started:!1,resumed:!1,reason:"not_authenticated"};if(!s?.id)return console.warn("Encounter trigger skipped: companion not ready"),{ok:!1,started:!1,resumed:!1,reason:"companion_not_ready"};if(g.current)return{ok:!1,started:!1,resumed:!1,reason:"trigger_in_progress"};g.current=!0,u(!0);try{const{data:q,error:F}=await S.from("astral_encounters").select("*").eq("user_id",t.id).is("completed_at",null).order("created_at",{ascending:!1}).limit(20);if(F)return console.error("Failed to lookup pending encounters:",F),{ok:!1,started:!1,resumed:!1,reason:"pending_lookup_failed"};const H=q??[],J=H[0]??null,G=H.slice(1).map(re=>re.id);if(G.length>0){const{error:re}=await S.from("astral_encounters").update({completed_at:new Date().toISOString()}).in("id",G).is("completed_at",null);re&&console.error("Failed to close stale pending encounters:",re)}if(J){const re=N(J);return m({encounter:J,adversary:re,questInterval:$??3}),h(!1),{ok:!0,started:!1,resumed:!0}}return await C.mutateAsync({triggerType:T,triggerSourceId:I,epicProgress:R,epicCategory:L,questInterval:$}),{ok:!0,started:!0,resumed:!1}}catch(q){if(c(q)){const{data:F,error:H}=await S.from("astral_encounters").select("*").eq("user_id",t.id).is("completed_at",null).order("created_at",{ascending:!1}).limit(1);if(H)return console.error("Failed to recover pending encounter after duplicate create:",H),{ok:!1,started:!1,resumed:!1,reason:"pending_lookup_failed"};const J=F?.[0];if(J){const G=N(J);return m({encounter:J,adversary:G,questInterval:$??3}),h(!1),{ok:!0,started:!1,resumed:!0}}}return console.error("Failed to trigger encounter:",q),{ok:!1,started:!1,resumed:!1,reason:"start_failed"}}finally{g.current=!1,u(!1)}},[t?.id,s?.id,N,c,C]),k=n.useCallback(()=>{h(!1),m(null)},[]),P=n.useCallback(async()=>{if(!d)return!1;try{const{error:T}=await S.from("astral_encounters").delete().eq("id",d.encounter.id);return l(T,"Failed to delete encounter"),m(null),h(!1),i.invalidateQueries({queryKey:["astral-encounters"]}),!0}catch(T){return console.error("Failed to pass encounter:",T),W.error("Failed to pass encounter"),!1}},[d,i,l]);return{activeEncounter:d,showEncounterModal:p,encounters:y,essences:v,codexEntries:w,totalStatBoosts:D,isLoading:b||x||j,isStarting:C.isPending,isTriggeringEncounter:f,isCompleting:_.isPending,startEncounter:C.mutate,startEncounterAsync:C.mutateAsync,completeEncounter:_.mutate,completeEncounterAsync:_.mutateAsync,checkEncounterTrigger:E,closeEncounter:k,passEncounter:P,setShowEncounterModal:h}},Au=n.createContext(null),j0=({children:t})=>{const s=_0();return e.jsx(Au.Provider,{value:s,children:t})},Ru=()=>{const t=n.useContext(Au);if(!t)throw new Error("useAstralEncounterContext must be used within AstralEncounterContextProvider");return t},Iu="encounter_passes",ul=3,ml=()=>new Date().toISOString().split("T")[0],N0=()=>{const t=rt.getItem(Iu);if(!t)return null;try{return JSON.parse(t)}catch{return null}},pl=t=>{rt.setItem(Iu,JSON.stringify(t))},k0=()=>{const[t,s]=n.useState(0);n.useEffect(()=>{const i=ml(),o=N0();o&&o.date===i?s(o.count):(pl({date:i,count:0}),s(0))},[]);const r=n.useCallback(()=>{const i=ml(),o=t+1;return pl({date:i,count:o}),s(o),o},[t]),a=t>=ul;return{passCount:t,recordPass:r,shouldPromptDisable:a,promptThreshold:ul}},C0=({open:t,onDisable:s,onKeepOn:r,passCount:a})=>e.jsx(Aa,{open:t,onOpenChange:i=>!i&&r(),children:e.jsxs(Ur,{className:"sm:max-w-md",children:[e.jsxs(zr,{children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("div",{className:"p-3 rounded-full bg-primary/10",children:e.jsx(fa,{className:"w-8 h-8 text-primary"})})}),e.jsx(Kr,{className:"text-center",children:"Taking a Break from Encounters?"}),e.jsxs(Wr,{className:"text-center",children:["You've passed on ",a," encounters today. Would you like to disable Astral Encounters? You can re-enable them anytime in your Profile settings."]})]}),e.jsxs(Qr,{className:"flex-col gap-2 sm:flex-col",children:[e.jsxs(or,{onClick:s,className:"w-full",children:[e.jsx(fa,{className:"w-4 h-4 mr-2"}),"Disable Encounters"]}),e.jsxs(Gr,{onClick:r,className:"w-full mt-0",children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"Keep Them On"]})]})]})}),S0=({children:t})=>{const[s,r]=n.useState(!1),[a,i]=n.useState("common"),[o,l]=n.useState(!1),c=n.useRef(null),{user:d}=be(),{passCount:m,recordPass:p}=k0(),{activeEncounter:h,showEncounterModal:f,setShowEncounterModal:u,completeEncounterAsync:g,closeEncounter:y,passEncounter:b}=Ru();n.useEffect(()=>{const _=h?.encounter.id??null;if(!_){c.current=null,r(!1);return}c.current!==_&&(c.current=_,i(h?.adversary.tier||"common"),u(!1),r(!0))},[h?.encounter.id,h?.adversary.tier,u]);const v=n.useCallback(()=>{r(!1),u(!0)},[u]),x=n.useCallback(_=>{if(!_){y();return}u(!0)},[y,u]),w=n.useCallback(async _=>{try{return await g(_),!0}catch{return!1}},[g]),j=n.useCallback(async()=>{if(!await b())return;p()>=3&&l(!0)},[p,b]),D=n.useCallback(async()=>{if(d?.id)try{const{error:_}=await S.from("profiles").update({astral_encounters_enabled:!1}).eq("id",d.id);if(_)throw _;l(!1),W.success("Astral Encounters disabled. Re-enable in Profile settings.")}catch(_){console.error("Failed to disable encounters:",_),W.error("Failed to disable encounters")}},[d?.id]),C=n.useCallback(()=>{l(!1)},[]);return e.jsxs(e.Fragment,{children:[t,e.jsx(c0,{isVisible:s,tier:a,onComplete:v}),e.jsx(o0,{open:f,onOpenChange:x,encounter:h?.encounter||null,adversary:h?.adversary||null,questInterval:h?.questInterval,onComplete:w,onPass:j}),e.jsx(C0,{open:o,onDisable:D,onKeepOn:C,passCount:m})]})},E0=({children:t})=>e.jsx(j0,{children:e.jsx(S0,{children:t})}),jr=n.memo(({icon:t,label:s,value:r,maxValue:a,color:i,animate:o=!1,compact:l=!1})=>e.jsxs(M.div,{className:`flex items-center gap-1.5 rounded-xl stat-pill ${l?"px-2 py-1":"px-3 py-1.5"}`,animate:o?{scale:[1,1.08,1]}:{},transition:{duration:.25},children:[e.jsx("div",{className:l?"p-1 rounded-md":"p-1.5 rounded-lg",style:{backgroundColor:`${i}20`},children:t}),e.jsxs("div",{className:"flex flex-col",children:[!l&&e.jsx("span",{className:"text-[10px] uppercase tracking-wider text-white/50 font-medium",children:s}),e.jsxs("span",{className:`font-bold ${l?"text-xs":"text-sm"}`,style:{color:i},children:[r,a!==void 0&&e.jsxs("span",{className:"text-white/40 font-normal",children:["/",a]})]})]})]}));jr.displayName="StatBadge";const T0=n.memo(({score:t,maxScore:s,timeLeft:r,totalTime:a,combo:i=0,showCombo:o=!1,phase:l,totalPhases:c,isPaused:d,onPauseToggle:m,title:p,subtitle:h,primaryStat:f,secondaryStat:u,compact:g=!1})=>{const[y,b]=n.useState(t),[v,x]=n.useState(!1);n.useEffect(()=>{t!==y&&t!==void 0&&t>(y||0)&&(x(!0),setTimeout(()=>x(!1),250)),b(t)},[t,y]);const w=a&&r!==void 0?r/a*100:100,j=r!==void 0&&r<=3;return e.jsxs("div",{className:`w-full ${g?"px-2 py-1 mb-1":"px-3 py-2 mb-2"}`,children:[!g&&e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-base font-bold text-white tracking-tight",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"},children:p}),h&&e.jsx("p",{className:"text-[10px] text-white/60 font-medium tracking-wide",children:h})]}),m&&e.jsx(M.button,{onClick:m,className:"p-2.5 rounded-full transition-all",style:{background:"linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%)",border:"1px solid rgba(255,255,255,0.12)",boxShadow:"0 4px 15px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.08)"},whileHover:{scale:1.05},whileTap:{scale:.92},children:d?e.jsx(Ls,{className:"w-4 h-4 text-white"}):e.jsx(Pr,{className:"w-4 h-4 text-white"})})]}),e.jsxs("div",{className:`flex items-center justify-between gap-1.5 overflow-x-auto scrollbar-hide ${g?"mb-1":"mb-2"}`,children:[t!==void 0&&e.jsx(jr,{icon:e.jsx(St,{className:`${g?"w-3 h-3":"w-3.5 h-3.5"} text-purple-400`}),label:"Score",value:t,maxValue:s,color:"#a855f7",animate:v,compact:g}),e.jsx(Pe,{children:o&&i>1&&e.jsx(M.div,{initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},exit:{scale:0,opacity:0},children:e.jsx(jr,{icon:e.jsx(ft,{className:`${g?"w-3 h-3":"w-3.5 h-3.5"} text-yellow-400`}),label:"Combo",value:`Ã—${i}`,color:"#fbbf24",animate:!0,compact:g})})}),f&&e.jsx(jr,{icon:e.jsx("div",{className:`${g?"w-2 h-2":"w-2.5 h-2.5"} rounded-full`,style:{backgroundColor:f.color}}),label:f.label,value:f.value,color:f.color,compact:g}),u&&e.jsx(jr,{icon:e.jsx("div",{className:`${g?"w-2 h-2":"w-2.5 h-2.5"} rounded-full`,style:{backgroundColor:u.color}}),label:u.label,value:u.value,color:u.color,compact:g}),r!==void 0&&e.jsx(M.div,{animate:j?{scale:[1,1.05,1]}:{},transition:{duration:.4,repeat:j?1/0:0},children:e.jsx(jr,{icon:e.jsx(Tn,{className:`${g?"w-3 h-3":"w-3.5 h-3.5"} ${j?"text-red-400":"text-white/60"}`}),label:"Time",value:`${r}s`,color:j?"#ef4444":"#94a3b8",compact:g})}),g&&m&&e.jsx(M.button,{onClick:m,className:"p-1.5 rounded-full transition-all flex-shrink-0",style:{background:"linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%)",border:"1px solid rgba(255,255,255,0.12)"},whileHover:{scale:1.05},whileTap:{scale:.92},children:d?e.jsx(Ls,{className:"w-3 h-3 text-white"}):e.jsx(Pr,{className:"w-3 h-3 text-white"})})]}),a!==void 0&&r!==void 0&&e.jsx("div",{className:`${g?"h-1.5":"h-2.5"} rounded-full overflow-hidden`,style:{background:"linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.06))",border:"1px solid rgba(255,255,255,0.08)",boxShadow:"inset 0 2px 4px rgba(0,0,0,0.4)"},children:e.jsx(M.div,{className:"h-full rounded-full",style:{background:j?"linear-gradient(90deg, #ef4444, #f97316, #ef4444)":"linear-gradient(90deg, hsl(var(--primary)), hsl(var(--accent)), hsl(var(--primary)))",backgroundSize:"200% 100%",boxShadow:j?"0 0 20px rgba(239, 68, 68, 0.6), inset 0 1px 0 rgba(255,255,255,0.3)":"0 0 20px hsl(var(--primary) / 0.5), inset 0 1px 0 rgba(255,255,255,0.3)"},animate:{width:`${w}%`,backgroundPosition:["0% center","200% center"]},transition:{width:{duration:.3},backgroundPosition:{duration:2.5,repeat:1/0,ease:"linear"}}})}),!g&&l!==void 0&&c!==void 0&&c>1&&e.jsx("div",{className:"flex justify-center gap-1.5 mt-3",children:Array.from({length:c}).map((D,C)=>e.jsx(M.div,{className:`rounded-full transition-all duration-300 ${C<l?"bg-green-400 w-3 h-2":C===l?"bg-gradient-to-r from-primary to-accent w-5 h-2":"bg-white/10 w-2 h-2"}`,style:{boxShadow:C===l?"0 0 10px hsl(var(--primary))":"none"},animate:C===l?{opacity:[1,.7,1]}:{},transition:{duration:1,repeat:1/0}},C))}),e.jsx("style",{children:`
        .stat-pill {
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);
          border: 1px solid rgba(255, 255, 255, 0.1);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      `})]})});T0.displayName="GameHUD";const M0=n.memo(({count:t,onComplete:s})=>{const[r,a]=n.useState(t);return n.useEffect(()=>{if(r<=0){s();return}const i=setTimeout(()=>{a(o=>o-1)},1e3);return()=>clearTimeout(i)},[r,s]),e.jsx(Pe,{children:r>0&&e.jsxs(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 z-50 flex items-center justify-center",style:{background:"radial-gradient(circle at center, rgba(0,0,0,0.92) 0%, rgba(5,5,15,0.97) 100%)",backdropFilter:"blur(12px) saturate(120%)"},children:[e.jsxs(M.div,{initial:{scale:2.5,opacity:0,rotate:-15},animate:{scale:1,opacity:1,rotate:0},exit:{scale:.5,opacity:0,rotate:15},transition:{type:"spring",stiffness:350,damping:22},className:"relative",children:[[0,1,2].map(i=>e.jsx(M.div,{className:"absolute inset-0 rounded-full",style:{border:"2px solid",borderColor:`hsl(var(--primary) / ${.6-i*.2})`},initial:{scale:1,opacity:.8},animate:{scale:2+i*.5,opacity:0},transition:{duration:1,delay:i*.15}},i)),e.jsxs("div",{className:"w-36 h-36 rounded-full flex items-center justify-center relative",style:{background:"linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--accent)) 100%)",boxShadow:"0 0 60px hsl(var(--primary) / 0.6), 0 0 120px hsl(var(--primary) / 0.3), inset 0 2px 0 rgba(255,255,255,0.25), inset 0 -2px 0 rgba(0,0,0,0.15)"},children:[e.jsx("div",{className:"absolute inset-2 rounded-full bg-gradient-to-br from-white/25 to-transparent"}),e.jsx("span",{className:"text-7xl font-black text-white relative z-10",style:{textShadow:"0 4px 20px rgba(0,0,0,0.4), 0 0 40px rgba(255,255,255,0.2)"},children:r})]})]},r),e.jsx(M.p,{className:"absolute bottom-[30%] text-lg font-semibold text-white/70 tracking-wide",initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{delay:.3},children:"Get Ready"})]})})});M0.displayName="CountdownOverlay";const D0=n.memo(({value:t,x:s,y:r,type:a})=>{const o={perfect:{color:"#fbbf24",bg:"rgba(251, 191, 36, 0.15)",emoji:"âœ¨"},good:{color:"#22c55e",bg:"rgba(34, 197, 94, 0.15)",emoji:"ðŸ‘"},miss:{color:"#ef4444",bg:"rgba(239, 68, 68, 0.15)",emoji:"âŒ"},combo:{color:"#a855f7",bg:"rgba(168, 85, 247, 0.15)",emoji:"ðŸ”¥"}}[a];return e.jsxs(M.div,{className:"absolute pointer-events-none flex items-center gap-1.5 px-3 py-1.5 rounded-full font-bold text-base",style:{left:s,top:r,color:o.color,backgroundColor:o.bg,border:`1px solid ${o.color}40`,boxShadow:`0 4px 20px ${o.color}40`},initial:{opacity:1,y:0,scale:1},animate:{opacity:0,y:-50,scale:1.2},exit:{opacity:0},transition:{duration:.7,ease:"easeOut"},children:[e.jsx("span",{children:o.emoji}),e.jsx("span",{children:t>0?`+${t}`:t})]})});D0.displayName="ScorePopup";const P0=n.memo(({onResume:t})=>e.jsx(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 z-50 flex flex-col items-center justify-center",style:{background:"radial-gradient(circle at center, rgba(0,0,0,0.94) 0%, rgba(5,5,15,0.98) 100%)",backdropFilter:"blur(16px) saturate(120%)"},children:e.jsxs(M.div,{initial:{scale:.8,opacity:0,y:20},animate:{scale:1,opacity:1,y:0},transition:{type:"spring",stiffness:300,damping:25},className:"text-center",children:[e.jsx("div",{className:"w-24 h-24 rounded-full mx-auto mb-6 flex items-center justify-center",style:{background:"linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.03) 100%)",border:"1px solid rgba(255,255,255,0.15)",boxShadow:"0 12px 40px rgba(0,0,0,0.4), 0 0 60px hsl(var(--primary) / 0.1), inset 0 1px 0 rgba(255,255,255,0.1)"},children:e.jsx(Pr,{className:"w-12 h-12 text-white/85"})}),e.jsx("h3",{className:"text-2xl font-bold text-white mb-1.5 tracking-tight",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"},children:"Paused"}),e.jsx("p",{className:"text-white/50 mb-8 text-sm font-medium",children:"Take your time"}),e.jsxs(M.button,{onClick:t,className:"px-8 py-3.5 rounded-full font-bold flex items-center gap-2.5 mx-auto text-white",style:{background:"linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--accent)) 100%)",boxShadow:"0 8px 30px hsl(var(--primary) / 0.5), 0 0 60px hsl(var(--primary) / 0.2), inset 0 1px 0 rgba(255,255,255,0.25)"},whileHover:{scale:1.03,y:-2},whileTap:{scale:.97},children:[e.jsx(Ls,{className:"w-5 h-5"}),"Resume"]})]})}));P0.displayName="PauseOverlay";const A0=n.memo(({type:t})=>{const r={perfect:{text:"PERFECT!",emoji:"ðŸŒŸ",color:"#fbbf24",gradient:"from-yellow-500/20 to-amber-500/10",border:"border-yellow-400/50",glow:"rgba(251, 191, 36, 0.4)"},good:{text:"GOOD!",emoji:"ðŸ‘",color:"#22c55e",gradient:"from-green-500/20 to-emerald-500/10",border:"border-green-400/50",glow:"rgba(34, 197, 94, 0.4)"},miss:{text:"MISS",emoji:"âŒ",color:"#ef4444",gradient:"from-red-500/20 to-orange-500/10",border:"border-red-400/50",glow:"rgba(239, 68, 68, 0.4)"}}[t];return e.jsx(M.div,{initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1},exit:{scale:1.2,opacity:0},transition:{type:"spring",stiffness:400,damping:25},className:`px-8 py-4 rounded-2xl bg-gradient-to-br ${r.gradient} border-2 ${r.border}`,style:{boxShadow:`0 0 40px ${r.glow}`},children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-3xl",children:r.emoji}),e.jsx("span",{className:"text-3xl font-black tracking-tight",style:{color:r.color,textShadow:`0 0 20px ${r.glow}`},children:r.text})]})})});A0.displayName="FeedbackOverlay";const Lu=n.createContext(null),R0=({children:t})=>{const[s,r]=n.useState(!1),[a,i]=n.useState(null),o=n.useCallback(d=>{i(d),r(!0)},[]),l=n.useCallback(()=>{r(!1),i(null)},[]),c=n.useMemo(()=>({isModalOpen:s,selectedRecap:a,openRecap:o,closeRecap:l}),[s,a,o,l]);return e.jsx(Lu.Provider,{value:c,children:t})},I0=()=>{const t=n.useContext(Lu);if(!t)throw new Error("useWeeklyRecapContext must be used within a WeeklyRecapProvider");return t},qu=()=>{const{user:t}=be(),s=Ae(),{awardCustomXP:r}=Xt(),{isModalOpen:a,selectedRecap:i,openRecap:o,closeRecap:l}=I0(),c=()=>{const v=new Date,x=v.getDay(),w=x===0?6:x-1,j=new Date(v);j.setDate(v.getDate()-w);const D=new Date(j);D.setDate(j.getDate()-7);const C=new Date(D);return C.setDate(D.getDate()+6),{start:te(D,"yyyy-MM-dd"),end:te(C,"yyyy-MM-dd")}},{start:d}=c(),m=new Date().getDay()===0,{data:p,isLoading:h}=Ee({queryKey:["weekly-recap",t?.id,d],queryFn:async()=>{if(!t?.id)return null;const{data:v,error:x}=await S.from("weekly_recaps").select("*").eq("user_id",t.id).eq("week_start_date",d).maybeSingle();if(x)throw x;return v},enabled:!!t?.id}),{data:f}=Ee({queryKey:["weekly-recaps-all",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:v,error:x}=await S.from("weekly_recaps").select("*").eq("user_id",t.id).order("week_start_date",{ascending:!1});if(x)throw x;return v},enabled:!!t?.id}),u=le({mutationFn:async()=>{if(!t?.id)throw new Error("Not authenticated");const{data:v,error:x}=await S.functions.invoke("generate-weekly-recap",{body:{userId:t.id}});if(x)throw x;return v},onSuccess:()=>{s.invalidateQueries({queryKey:["weekly-recap"]}),s.invalidateQueries({queryKey:["weekly-recaps-all"]})}}),g=le({mutationFn:async v=>{const{error:x}=await S.from("weekly_recaps").update({viewed_at:new Date().toISOString()}).eq("id",v);if(x)throw x},onSuccess:()=>{s.invalidateQueries({queryKey:["weekly-recap"]}),s.invalidateQueries({queryKey:["weekly-recaps-all"]})}});return n.useEffect(()=>{if(m&&p&&!p.viewed_at&&!h){const v=`recap-dismissed-${p.week_start_date}`;rt.getItem(v)||o(p)}},[m,p,h,o]),n.useEffect(()=>{(async()=>{if(!m||p||h||!t?.id||u.isPending)return;const{count:x}=await S.from("daily_check_ins").select("id",{count:"exact",head:!0}).eq("user_id",t.id);x&&x>0&&u.mutate()})()},[m,p,h,t?.id,u.isPending]),{isSunday:m,currentRecap:p,pastRecaps:f||[],isLoading:h,isModalOpen:a,selectedRecap:i,openRecap:v=>{o(v),v.viewed_at||(r(5,"weekly_recap_viewed","Weekly Recap"),g.mutate(v.id))},closeRecap:()=>{if(i){const v=`recap-dismissed-${i.week_start_date}`;rt.setItem(v,"true"),i.viewed_at||g.mutate(i.id)}l()},isGenerating:u.isPending,generateRecap:u.mutate}},aa={tough:{buttonText:t=>`${t}. Now.`,emptyState:t=>`No excuses. Start ${t}.`,encouragement:()=>"You're tougher than this. Prove it.",nudge:()=>"Stop waiting. Act."},direct:{buttonText:t=>t,emptyState:t=>`Time to ${t}.`,encouragement:()=>"Keep pushing forward.",nudge:()=>"Get it done."},empathetic:{buttonText:t=>`${t} when you're ready`,emptyState:t=>`Take your time with ${t}. I'm here.`,encouragement:()=>"You're doing great. Keep going.",nudge:()=>"Just checking in on you."},supportive:{buttonText:t=>`Let's ${t.toLowerCase()}`,emptyState:t=>`Ready to ${t}? I believe in you.`,encouragement:()=>"You've got this!",nudge:()=>"How are you feeling today?"},wise:{buttonText:t=>`${t} mindfully`,emptyState:t=>`Consider ${t} as your next step.`,encouragement:()=>"Every step forward is progress.",nudge:()=>"Reflect on your path."}},Yr=()=>{const{profile:t}=Yt(),s=Br(t),{data:r}=Ee({queryKey:["mentor-personality",s],queryFn:async()=>{if(!s)return null;const{data:l,error:c}=await S.from("mentors").select("name, slug, tone_description, style, avatar_url, primary_color").eq("id",s).maybeSingle();if(c)throw c;return l},enabled:!!s});if(!r)return null;const i=r.tone_description?.toLowerCase()??"";let o=aa.supportive;return i.includes("tough")||i.includes("hard")?o=aa.tough:i.includes("direct")?o=aa.direct:i.includes("empathetic")?o=aa.empathetic:(i.includes("wise")||i.includes("calm"))&&(o=aa.wise),{name:r.name,slug:r.slug||"",tone:r.tone_description??"",style:r.style||"",avatar_url:r.avatar_url||void 0,primary_color:r.primary_color||"#000",buttonText:o.buttonText,emptyState:o.emptyState,encouragement:o.encouragement,nudge:o.nudge}},L0=async(t,s,r)=>{try{if(nt.isNativePlatform()){const i=await(await fetch(t)).blob(),o=await O0(i),l=await Gc.writeFile({path:s,data:o,directory:Yc.Cache});await Vc.share({title:r?.title||"Companion Card",text:r?.text||"Check out my companion!",url:l.uri,dialogTitle:r?.dialogTitle||"Share Companion Card"}),W.success("Image ready to share!")}else{const a=document.createElement("a");a.href=t,a.download=s,a.click(),W.success("Image downloaded!")}}catch(a){console.error("Error downloading image:",a),W.error("Failed to save image")}},q0=async(t,s,r)=>{try{W.loading("Capturing card...");const a=await Wc(t,{quality:1,pixelRatio:2,backgroundColor:"transparent"});if(W.dismiss(),nt.isNativePlatform()){const i=a.split(",")[1],o=await Gc.writeFile({path:s,data:i,directory:Yc.Cache});await Vc.share({title:r?.title||"Companion Card",text:r?.text||"Check out my companion!",url:o.uri,dialogTitle:r?.dialogTitle||"Share Companion Card"}),W.success("Card ready to share!")}else{const i=document.createElement("a");i.href=a,i.download=s,i.click(),W.success("Card downloaded!")}}catch(a){W.dismiss(),console.error("Error capturing card:",a),W.error("Failed to capture card")}},O0=t=>new Promise((s,r)=>{const a=new FileReader;a.onloadend=()=>{const o=a.result.split(",")[1];s(o)},a.onerror=r,a.readAsDataURL(t)}),F0=({trend:t})=>{const s={improving:{icon:Ts,label:"Rising Week",className:"text-emerald-300 bg-emerald-500/20 border-emerald-400/30"},declining:{icon:ca,label:"Reflective Week",className:"text-amber-300 bg-amber-500/20 border-amber-400/30"},stable:{icon:Ch,label:"Steady Week",className:"text-sky-300 bg-sky-500/20 border-sky-400/30"}},{icon:r,label:a,className:i}=s[t]||s.stable;return e.jsxs(M.span,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:.3},className:`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium border backdrop-blur-sm ${i}`,children:[e.jsx(r,{className:"h-3 w-3"}),a]})},Xa=({value:t,label:s,color:r})=>e.jsxs(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex flex-col items-center gap-0.5",children:[e.jsx("span",{className:`text-lg font-bold ${r}`,children:t}),e.jsx("span",{className:"text-[10px] text-muted-foreground/70 uppercase tracking-wider",children:s})]}),$0=()=>{const{isModalOpen:t,selectedRecap:s,closeRecap:r}=qu(),a=Yr(),i=n.useRef(null),[o,l]=n.useState(!1);if(!s)return null;const c=ps(s.week_start_date),d=ps(s.week_end_date),m=`${te(c,"MMMM d")} â€“ ${te(d,"d, yyyy")}`,p=s.mentor_story||s.mentor_insight,h=p?.split(`

`).filter(y=>y.trim())||[],f=async()=>{if(i.current)try{const y=await Wc(i.current,{quality:.95,backgroundColor:"#0a0a0f"});await L0(y,`cosmiq-recap-${s.week_start_date}.png`)}catch(y){console.error("Failed to share recap:",y)}},u=()=>{if(!p)return;if(o){window.speechSynthesis.cancel(),l(!1);return}const y=new SpeechSynthesisUtterance(p);y.rate=.9,y.pitch=1,y.onend=()=>l(!1),y.onerror=()=>l(!1),window.speechSynthesis.speak(y),l(!0)},g=()=>{window.speechSynthesis.cancel(),l(!1),r()};return e.jsx(Pe,{children:t&&e.jsxs(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center p-4 pb-20",onClick:g,children:[e.jsx(M.div,{className:"absolute inset-0 bg-black/90 backdrop-blur-md",initial:{opacity:0},animate:{opacity:1}}),e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx(M.div,{className:"absolute top-1/4 left-1/4 w-96 h-96 bg-amber-500/10 rounded-full blur-3xl",animate:{scale:[1,1.2,1],opacity:[.3,.5,.3]},transition:{duration:8,repeat:1/0,ease:"easeInOut"}}),e.jsx(M.div,{className:"absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl",animate:{scale:[1.2,1,1.2],opacity:[.3,.5,.3]},transition:{duration:8,repeat:1/0,ease:"easeInOut",delay:4}})]}),e.jsxs(M.div,{initial:{scale:.9,opacity:0,y:40},animate:{scale:1,opacity:1,y:0},exit:{scale:.9,opacity:0,y:40},transition:{type:"spring",damping:30,stiffness:300},onClick:y=>y.stopPropagation(),className:"relative w-full max-w-lg max-h-[75dvh] flex flex-col rounded-3xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-background/95 via-background/90 to-background/95 backdrop-blur-xl border border-white/10 rounded-3xl"}),e.jsx("div",{className:"absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-400/50 to-transparent"}),e.jsxs("div",{className:"relative flex items-center justify-between px-6 py-5",children:[e.jsxs(M.div,{className:"flex items-center gap-4",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.1},children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"h-12 w-12 rounded-2xl bg-gradient-to-br from-amber-400 via-orange-500 to-rose-500 flex items-center justify-center shadow-lg shadow-amber-500/20",children:e.jsx(ga,{className:"h-6 w-6 text-white"})}),e.jsx(M.div,{className:"absolute -top-1 -right-1 h-4 w-4 rounded-full bg-gradient-to-br from-amber-300 to-amber-500 flex items-center justify-center",animate:{scale:[1,1.2,1]},transition:{duration:2,repeat:1/0},children:e.jsx(pe,{className:"h-2.5 w-2.5 text-white"})})]}),e.jsxs("div",{children:[e.jsxs("h2",{className:"font-semibold text-lg text-foreground",children:[a?.name||"Your Mentor"," Reflects"]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx($t,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:m})]})]})]}),e.jsxs(M.div,{className:"flex items-center gap-1",initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{delay:.2},children:[p&&e.jsx(U,{variant:"ghost",size:"icon",onClick:u,className:`rounded-xl transition-colors ${o?"text-amber-400 bg-amber-400/10":"hover:bg-white/5"}`,children:o?e.jsx(Nh,{className:"h-4 w-4"}):e.jsx(kh,{className:"h-4 w-4"})}),e.jsx(U,{variant:"ghost",size:"icon",onClick:f,className:"rounded-xl hover:bg-white/5",children:e.jsx(Xc,{className:"h-4 w-4"})}),e.jsx(U,{variant:"ghost",size:"icon",onClick:g,className:"rounded-xl hover:bg-white/5",children:e.jsx(Nt,{className:"h-4 w-4"})})]})]}),e.jsx(On,{className:"relative flex-1 min-h-0",children:e.jsxs("div",{ref:i,className:"px-4 pb-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-center pt-2",children:e.jsx(F0,{trend:s.mood_data.trend})}),h.length>0?e.jsx("div",{className:"space-y-5",children:h.map((y,b)=>e.jsx(M.p,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4+b*.1,duration:.5},className:`text-[15px] leading-[1.8] text-foreground/90 ${b===0?"first-letter:text-3xl first-letter:font-serif first-letter:font-bold first-letter:text-amber-400 first-letter:mr-1 first-letter:float-left first-letter:leading-none":""}`,children:y},b))}):e.jsxs(M.div,{className:"text-center py-12",initial:{opacity:0},animate:{opacity:1},children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-muted/30 mb-4",children:e.jsx(ga,{className:"h-8 w-8 text-muted-foreground/50"})}),e.jsx("p",{className:"text-muted-foreground",children:"No story available for this week yet."})]}),e.jsxs(M.div,{className:"flex items-center justify-center gap-3 py-4",initial:{opacity:0,scaleX:0},animate:{opacity:1,scaleX:1},transition:{delay:.8},children:[e.jsx("div",{className:"h-px flex-1 bg-gradient-to-r from-transparent via-border to-transparent"}),e.jsx(pe,{className:"h-3 w-3 text-amber-400/50"}),e.jsx("div",{className:"h-px flex-1 bg-gradient-to-r from-transparent via-border to-transparent"})]}),e.jsxs(M.div,{className:"flex items-center justify-around py-4 px-2 rounded-2xl bg-white/[0.02] border border-white/5",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.9},children:[e.jsx(Xa,{value:s.stats.checkIns,label:"Check-ins",color:"text-sky-400"}),e.jsx("div",{className:"w-px h-8 bg-border/30"}),e.jsx(Xa,{value:s.stats.reflections,label:"Reflections",color:"text-violet-400"}),e.jsx("div",{className:"w-px h-8 bg-border/30"}),e.jsx(Xa,{value:s.stats.quests,label:"Quests",color:"text-emerald-400"}),e.jsx("div",{className:"w-px h-8 bg-border/30"}),e.jsx(Xa,{value:s.stats.habits,label:"Habits",color:"text-amber-400"})]}),e.jsx(M.div,{className:"text-center pt-2 pb-4",initial:{opacity:0},animate:{opacity:1},transition:{delay:1},children:e.jsx("p",{className:"text-[10px] text-muted-foreground/40 tracking-widest uppercase",children:"Cosmiq Weekly Journal"})})]})}),e.jsx("div",{className:"relative px-6 py-5 pb-6 border-t border-white/5",children:e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5},children:e.jsx(U,{onClick:g,className:"w-full h-12 rounded-xl bg-gradient-to-r from-amber-500 via-orange-500 to-rose-500 hover:from-amber-400 hover:via-orange-400 hover:to-rose-400 text-white font-medium shadow-lg shadow-orange-500/20 transition-all duration-300 hover:shadow-orange-500/30 hover:scale-[1.02]",children:"Continue Your Journey"})})})]})]})})},hl=1e4,H0=({enabled:t=!0}={})=>{const s=Ae(),r=n.useRef(0),a=n.useCallback(async i=>{t&&(oe.debug(`${i} - refreshing critical data`),await s.refetchQueries({queryKey:["profile"]}),await Promise.all([s.invalidateQueries({queryKey:["mentor-page-data"]}),s.invalidateQueries({queryKey:["mentor-personality"]}),s.invalidateQueries({queryKey:["mentor"]}),s.invalidateQueries({queryKey:["selected-mentor"]})]),await Promise.all([s.invalidateQueries({queryKey:["habits"]}),s.invalidateQueries({queryKey:["habit-surfacing"]}),s.invalidateQueries({queryKey:["epics"]}),s.invalidateQueries({queryKey:["epic-progress"]})]))},[t,s]);n.useEffect(()=>{if(!t||!nt.isNativePlatform())return;let i=!1,o=null;const l=async({isActive:d})=>{if(!d)return;const m=Date.now();if(m-r.current<hl){oe.debug("App resume refresh skipped (cooldown)");return}r.current=m;try{await a("App resumed")}catch(h){oe.warn("App resume refresh failed",{error:h instanceof Error?h.message:String(h)})}};return(async()=>{const d=await Dr.addListener("appStateChange",l);if(i){await d.remove();return}o=d})(),()=>{i=!0,o&&o.remove()}},[t,a]),n.useEffect(()=>{if(!t||nt.isNativePlatform())return;const i=async()=>{if(document.visibilityState!=="visible")return;const o=Date.now();if(!(o-r.current<hl)){r.current=o;try{await a("Tab became visible")}catch(c){oe.warn("Visibility refresh failed",{error:c instanceof Error?c.message:String(c)})}}};return document.addEventListener("visibilitychange",i),()=>document.removeEventListener("visibilitychange",i)},[t,a])},B0=()=>{if(typeof window>"u")return!1;const t=window.Capacitor;return!!(t?.isNativePlatform?.()&&t?.getPlatform?.()==="ios")},U0=()=>typeof window>"u"?!1:window.matchMedia("(prefers-reduced-motion: reduce)").matches,z0=()=>typeof navigator>"u"?!1:!!navigator.connection?.saveData,uo=()=>{const[t,s]=n.useState(U0),[r,a]=n.useState(()=>typeof document<"u"?document.visibilityState!=="visible":!1),[i,o]=n.useState(z0),l=n.useMemo(()=>B0(),[]);n.useRef(null),n.useEffect(()=>{if(typeof window>"u")return;const p=window.matchMedia("(prefers-reduced-motion: reduce)"),h=()=>s(p.matches);return p.addEventListener("change",h),()=>p.removeEventListener("change",h)},[]),n.useEffect(()=>{if(typeof document>"u")return;const p=()=>{a(document.visibilityState!=="visible")};return document.addEventListener("visibilitychange",p),()=>document.removeEventListener("visibilitychange",p)},[]),n.useEffect(()=>{if(typeof navigator>"u")return;const p=navigator.connection;if(!p||typeof p.addEventListener!="function")return;const h=()=>o(!!p.saveData);return h(),p.addEventListener("change",h),()=>p.removeEventListener("change",h)},[]);const c=n.useMemo(()=>({prefersReducedMotion:t,isLowPowerMode:i,isBackgrounded:r}),[r,i,t]),d=n.useMemo(()=>c.prefersReducedMotion||c.isBackgrounded?"reduced":c.isLowPowerMode||l?"balanced":"enhanced",[l,c.isBackgrounded,c.isLowPowerMode,c.prefersReducedMotion]),m=n.useMemo(()=>d==="reduced"?{allowParallax:!1,maxParticles:4,allowBackgroundAnimation:!1,enableTabTransitions:!1,hapticsMode:"none"}:d==="balanced"?{allowParallax:!l,maxParticles:l?8:16,allowBackgroundAnimation:!l,enableTabTransitions:!l,hapticsMode:"web"}:{allowParallax:!0,maxParticles:24,allowBackgroundAnimation:!0,enableTabTransitions:!0,hapticsMode:"web"},[l,d]);return n.useEffect(()=>{},[l,d,c.isBackgrounded,c.isLowPowerMode,c.prefersReducedMotion]),n.useMemo(()=>({profile:d,capabilities:m,signals:c}),[m,d,c])},Q0=[.25,.1,.25,1],Ia=n.memo(({children:t,mode:s="animated"})=>{const{capabilities:r,profile:a,signals:i}=uo();if(s==="instant"||i.prefersReducedMotion||i.isBackgrounded||!r.enableTabTransitions)return e.jsx("div",{style:{width:"100%",height:"100%"},children:t});const l=a==="enhanced"?.18:.14;return e.jsx(M.div,{initial:!1,animate:{opacity:1,y:0},exit:{opacity:0,y:-6},transition:{duration:l,ease:Q0},style:{width:"100%",height:"100%"},children:t})});Ia.displayName="PageTransition";const K0=n.memo(({children:t,delay:s=0})=>{const r=useReducedMotion();return e.jsx(M.div,{initial:{opacity:r?1:0},animate:{opacity:1},transition:{duration:r?0:.24,delay:r?0:s},children:t})});K0.displayName="FadeIn";const W0=n.memo(({children:t,delay:s=0})=>{const r=useReducedMotion();return e.jsx(M.div,{initial:{opacity:r?1:0,scale:r?1:.97},animate:{opacity:1,scale:1},transition:{duration:r?0:.2,delay:r?0:s},children:t})});W0.displayName="ScaleIn";const G0=n.memo(({children:t,delay:s=0})=>{const r=useReducedMotion();return e.jsx(M.div,{initial:{opacity:r?1:0,y:r?0:16},animate:{opacity:1,y:0},transition:{duration:r?0:.24,delay:r?0:s,ease:"easeOut"},children:t})});G0.displayName="SlideUp";const Y0=["What should I focus on today?","How can I stay motivated?","I need a mindset shift","Give me a pep talk","Help me overcome self-doubt","How do I build better habits?","I'm feeling stuck","What's my next step?","Help me start strong today","Keep me on track","I need encouragement","Give me the hard truth"],Ou=n.memo(()=>{const t=as(),s=Yr(),[r,a]=n.useState([]),[i,o]=n.useState("");n.useEffect(()=>{const d=[...Y0].sort(()=>Math.random()-.5);a(d.slice(0,3))},[]);const l=d=>{t("/mentor-chat",{state:{initialMessage:d}})},c=d=>{d.preventDefault(),i.trim()&&t("/mentor-chat",{state:{initialMessage:i}})};return e.jsxs(We,{className:"p-6 space-y-5 rounded-3xl bg-card/25 backdrop-blur-2xl border-white/[0.08] relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/5 via-transparent to-accent/5"}),e.jsxs("div",{className:"relative z-10 space-y-5",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Vi,{className:"h-6 w-6 text-primary"}),e.jsx("div",{className:"absolute inset-0 bg-primary/20 blur-md rounded-full animate-pulse-slow"})]}),e.jsx("h3",{className:"text-lg font-bold text-foreground",children:s?.name?`Ask ${s.name}`:"Quick Chat"})]}),e.jsx("div",{className:"space-y-3",children:r.map((d,m)=>e.jsx("button",{onClick:()=>l(d),className:"group relative w-full text-center px-6 py-4 rounded-full bg-white/[0.03] backdrop-blur-xl hover:bg-white/[0.06] border border-white/[0.08] hover:border-primary/30 transition-all text-sm font-medium text-foreground hover:scale-[1.02] active:scale-[0.98]",children:e.jsx("span",{className:"relative",children:d})},m))}),e.jsxs("form",{onSubmit:c,className:"flex gap-2",children:[e.jsx(ot,{value:i,onChange:d=>o(d.target.value),placeholder:"Or type your own...",className:"flex-1 rounded-full border-2 focus:border-primary/50 transition-all"}),e.jsx(U,{type:"submit",size:"icon",disabled:!i.trim(),className:"rounded-full h-10 w-10 shadow-soft hover:shadow-glow transition-all hover:scale-110 disabled:opacity-50","aria-label":"Send question",children:e.jsx(Jc,{className:"h-4 w-4"})})]})]})]})});Ou.displayName="MentorQuickChat";class V0 extends n.Component{constructor(s){super(s),this.state={hasError:!1,error:null}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,r){console.error("Companion Error:",s,r)}render(){return this.state.hasError?this.props.fallback||e.jsx(X0,{error:this.state.error}):this.props.children}}const X0=({error:t})=>{const s=as();return e.jsx(We,{className:"p-8 text-center bg-gradient-to-br from-destructive/5 to-destructive/10 border-destructive/30",role:"alert","aria-live":"assertive",children:e.jsxs("div",{className:"flex flex-col items-center gap-4 max-w-md mx-auto",children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-destructive/20 flex items-center justify-center","aria-hidden":"true",children:e.jsx(cr,{className:"h-8 w-8 text-destructive"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl font-heading font-bold text-foreground",children:"Companion Unavailable"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Your companion is taking a quick nap. Let's try waking them up!"})]}),e.jsxs("div",{className:"flex gap-3 mt-4",children:[e.jsxs(U,{onClick:()=>window.location.reload(),className:"gap-2","aria-label":"Reload page to retry loading companion",children:[e.jsx(ir,{className:"h-4 w-4","aria-hidden":"true"}),"Retry"]}),e.jsxs(U,{variant:"outline",onClick:()=>s("/"),className:"gap-2","aria-label":"Return to home page",children:[e.jsx(Sh,{className:"h-4 w-4","aria-hidden":"true"}),"Go Home"]})]}),t&&e.jsxs("details",{className:"mt-4 text-xs text-muted-foreground max-w-full",children:[e.jsx("summary",{className:"cursor-pointer hover:text-foreground focus:outline-none focus:ring-2 focus:ring-primary rounded",children:"More details"}),e.jsx("pre",{className:"mt-2 p-3 bg-background/50 rounded text-left overflow-auto max-h-32","aria-label":"Error details",children:t.message})]})]})})},Fu=V0,$u=n.forwardRef(({className:t,...s},r)=>e.jsxs(Zc,{ref:r,className:A("relative flex w-full touch-none select-none items-center",t),...s,children:[e.jsx(Eh,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:e.jsx(Th,{className:"absolute h-full bg-primary"})}),e.jsx(Mh,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]}));$u.displayName=Zc.displayName;function di(t,s){return s>=t.start&&s<t.end}function J0(t,s,r){if(!Number.isFinite(s)||t.length===0)return-1;if(typeof r=="number"&&Number.isInteger(r)&&r>=0&&r<t.length){const o=t[r];if(di(o,s))return r;const l=r+1;if(l<t.length&&di(t[l],s))return l;const c=r-1;if(c>=0&&di(t[c],s))return c}let a=0,i=t.length-1;for(;a<=i;){const o=Math.floor((a+i)/2),l=t[o];if(s<l.start){i=o-1;continue}if(s>=l.end){a=o+1;continue}return o}return-1}const na=oe.scope("TodaysPepTalk"),ui=3,Z0=1200,fl=600*1e3,eb=45*1e3,ma=new Map;function tb(t){if(!t||typeof t!="object")return!1;const s=t;return typeof s.word=="string"&&typeof s.start=="number"&&Number.isFinite(s.start)&&typeof s.end=="number"&&Number.isFinite(s.end)}function ia(t){return Array.isArray(t)?t.filter(tb).slice().sort((s,r)=>s.start-r.start||s.end-r.end):[]}function mo(t){return`pep_talk_transcript_sync_cooldown:${t}`}function sb(t){const s=rt.getItem(mo(t));if(!s)return 0;const r=Number(s);return Number.isFinite(r)?r:0}function rb(t){rt.removeItem(mo(t)),ma.delete(t)}function ab(t,s){rt.setItem(mo(t),String(s)),ma.set(t,s)}function nb(t){if(!t||typeof t!="object")return"";const s=t.name;return typeof s=="string"?s:""}function ib(t){if(!t||typeof t!="object"||!("context"in t))return null;const s=t.context;return s instanceof Response?s.status:null}function ob(t){return t===null?!1:t===429||t>=500&&t<600}function gl(t){return Z0*2**Math.max(0,t-1)}function xl(t){return new Promise(s=>setTimeout(s,t))}const Hu=n.memo(()=>{const{profile:t}=Yt();Yr();const s=as(),{awardPepTalkListened:r}=Xt(),[a,i]=n.useState(null),[o,l]=n.useState(!0),[c,d]=n.useState(!1),[m,p]=n.useState(!1),[h,f]=n.useState(0),[u,g]=n.useState(0),[y,b]=n.useState(!1),[v,x]=n.useState(-1),[w,j]=n.useState(!1),[D,C]=n.useState(!1),[_,N]=n.useState("idle"),[E,k]=n.useState(!1),[P,T]=n.useState(null),[I,R]=n.useState(!1),L=n.useRef(null),$=n.useRef(null),q=n.useRef(null),F=n.useRef(null);n.useEffect(()=>{R(!1)},[a?.audio_url]),n.useEffect(()=>{if(!a?.audio_url||I)return;const z=setTimeout(()=>{!I&&L.current&&(na.debug("Audio ready timeout reached, enabling play button"),R(!0))},5e3);return()=>clearTimeout(z)},[a?.audio_url,I]);const H=Br(t),J=n.useMemo(()=>ia(a?.transcript),[a?.transcript]),G=n.useCallback(async()=>{if(!H){l(!1);return}try{d(!1),k(!1);const z=new Date().toLocaleDateString("en-CA"),{data:Q,error:Y}=await S.from("mentors").select("slug, name").eq("id",H).maybeSingle();if(Y){console.error("Error fetching mentor:",Y),d(!0),l(!1);return}if(!Q){l(!1);return}T(Q.slug);const{data:ue,error:fe}=await S.from("daily_pep_talks").select("*").eq("for_date",z).eq("mentor_slug",Q.slug).maybeSingle();let De=ue;if(fe){console.error("Error fetching pep talk:",fe),d(!0),l(!1);return}if(!De){console.log("No pep talk for today, fetching most recent...");const{data:Ce,error:Be}=await S.from("daily_pep_talks").select("*").eq("mentor_slug",Q.slug).order("for_date",{ascending:!1}).limit(1).maybeSingle();Be?console.error("Error fetching fallback pep talk:",Be):Ce&&(De=Ce,k(!0),console.log("Using fallback pep talk from:",Ce.for_date))}if(De){const Ce=ia(De.transcript);i({...De,mentor_name:Q.name,transcript:Ce})}}catch(z){console.error("Unexpected error fetching pep talk:",z),d(!0)}finally{l(!1)}},[H]);n.useEffect(()=>{G()},[G]);const re=async()=>{if(!P){W.error("No mentor selected");return}C(!0),N("script");try{const{data:z,error:Q}=await S.functions.invoke("generate-single-daily-pep-talk",{body:{mentorSlug:P}});if(N("audio"),Q)throw console.error("Generation error:",Q),new Error(Q.message||"Failed to prepare pep talk");if(z?.pepTalk){N("loading");const{data:Y}=await S.from("mentors").select("name").eq("slug",P).maybeSingle(),ue=ia(z.pepTalk.transcript);i({...z.pepTalk,mentor_name:Y?.name,transcript:ue}),d(!1),k(!1),W.success("Your pep talk is ready!")}else throw new Error("No pep talk data returned")}catch(z){console.error("Error generating pep talk:",z);const Q=z instanceof Error?z.message:"Failed to prepare pep talk";W.error(Q)}finally{C(!1),N("idle")}};n.useEffect(()=>{const z=a?.id,Q=a?.audio_url;if(!z||!Q||ia(a?.transcript).length>0)return;const ue=Date.now(),fe=ma.get(z)??0,De=sb(z),Ce=Math.max(fe,De);if(Ce>ue){ma.set(z,Ce),na.debug("Skipping transcript sync during cooldown window",{pepTalkId:z,remainingMs:Ce-ue});return}ma.set(z,ue+eb);let Be=!1;return(async()=>{for(let ye=1;ye<=ui;ye+=1)try{const{data:Ue,error:Re}=await S.functions.invoke("sync-daily-pep-talk-transcript",{body:{id:z}});if(Be)return;if(Re){const ne=ib(Re),X=ob(ne),ae=nb(Re),Se=Re instanceof Error?Re.message:String(Re);if(na.info("Transcript sync returned non-blocking error",{pepTalkId:z,attempt:ye,status:ne,retryable:X,errorName:ae,errorMessage:Se}),X&&ye<ui){const ve=gl(ye);if(await xl(ve),Be)return;continue}break}const Ie=typeof Ue?.script=="string"?Ue.script:null,ee=ia(Ue?.transcript);if(!Ie&&ee.length===0)break;if(i(ne=>{if(!ne)return ne;const X=Ie??ne.script,ae=ee.length>0?ee:ne.transcript;return X!==ne.script||JSON.stringify(ae)!==JSON.stringify(ne.transcript)?{...ne,script:X,transcript:ae}:ne}),ee.length>0){rb(z);return}break}catch(Ue){if(Be)return;const Re=Ue instanceof Error?Ue.message:String(Ue);if(na.info("Transcript sync invocation failed (non-blocking)",{pepTalkId:z,attempt:ye,message:Re}),ye<ui){const Ie=gl(ye);if(await xl(Ie),Be)return;continue}}const he=Date.now()+fl;ab(z,he),na.info("Applied transcript sync cooldown after failed attempts",{pepTalkId:z,cooldownMs:fl})})(),()=>{Be=!0}},[a?.id,a?.audio_url,a?.transcript]),n.useEffect(()=>{(async()=>{if(!a?.id||!t?.id)return;const{data:Q}=await S.from("xp_events").select("id").eq("user_id",t.id).eq("event_type","pep_talk_listen").eq("event_metadata->>pep_talk_id",a.id).maybeSingle();j(!!Q)})()},[a?.id,t?.id]),n.useEffect(()=>{const z=L.current;if(!z)return;const Q=()=>{const fe=z.currentTime;f(fe);const De=z.duration;!w&&De>0&&fe>=De*.8&&a?.id&&t?.id&&(j(!0),r({pep_talk_id:a.id}))},Y=()=>g(z.duration),ue=()=>{p(!1),x(-1)};return z.addEventListener("timeupdate",Q),z.addEventListener("loadedmetadata",Y),z.addEventListener("ended",ue),()=>{z.removeEventListener("timeupdate",Q),z.removeEventListener("loadedmetadata",Y),z.removeEventListener("ended",ue)}},[w,r,a?.id,t?.id]),n.useEffect(()=>{x(z=>J0(J,h,z))},[J,h]),n.useEffect(()=>()=>{F.current&&clearTimeout(F.current)},[]),n.useEffect(()=>{if($.current&&q.current&&y){const z=q.current,Q=$.current,Y=z.getBoundingClientRect(),ue=Q.getBoundingClientRect();(ue.top<Y.top||ue.bottom>Y.bottom)&&Q.scrollIntoView({behavior:"smooth",block:"center"})}},[v,y]);const ie=async()=>{const z=L.current;if(!z){console.error("Audio element not found");return}if(m)z.pause(),p(!1);else try{console.log("Attempting to play audio from:",a?.audio_url),await z.play(),p(!0)}catch(Q){console.error("Audio play failed:",Q),z.load();try{await z.play(),p(!0)}catch(Y){console.error("Audio play retry failed:",Y)}}},K=n.useCallback(z=>{const Q=L.current;Q&&(f(z[0]),F.current&&clearTimeout(F.current),F.current=window.setTimeout(()=>{Q&&(Q.currentTime=z[0])},100))},[]),xe=z=>{const Q=L.current;if(!Q)return;const Y=Math.max(0,Math.min(Q.duration,Q.currentTime+z));Q.currentTime=Y,f(Y)},Te=z=>{if(isNaN(z))return"0:00";const Q=Math.floor(z/60),Y=Math.floor(z%60);return`${Q}:${Y.toString().padStart(2,"0")}`},Ne=()=>{if(!a?.script)return e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"No transcript available"});const Q=a.script.split(" ").slice(0,20);return e.jsxs("div",{className:"text-sm leading-relaxed text-foreground/70",children:[Q.join(" "),"..."]})},B=()=>J.length===0?a?.script?e.jsx("div",{ref:q,className:"text-sm leading-relaxed max-h-64 overflow-y-auto scroll-smooth pr-2 text-foreground/80",children:a.script}):null:e.jsx("div",{ref:q,className:"text-sm leading-relaxed max-h-64 overflow-y-auto scroll-smooth pr-2 text-foreground/80",children:J.map((z,Q)=>e.jsxs("span",{ref:Q===v?$:null,className:A("transition-colors duration-200",Q===v?"text-primary font-semibold bg-primary/10 px-1 rounded":"text-foreground/80"),children:[z.word," "]},Q))});return o?e.jsx(We,{className:"p-6 animate-pulse",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"h-4 bg-muted rounded w-1/3"}),e.jsx("div",{className:"h-20 bg-muted rounded"})]})}):c||!a?e.jsxs(We,{className:"relative overflow-hidden rounded-3xl border-2 p-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/10 via-accent/5 to-primary/5"}),e.jsxs("div",{className:"relative space-y-4 text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5 text-muted-foreground"}),e.jsx("h2",{className:"text-lg font-semibold text-muted-foreground",children:"Daily Message"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:c?"Unable to load today's pep talk":"No pep talk available today"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 justify-center",children:[e.jsx(U,{onClick:re,disabled:D||!P,className:"rounded-full min-w-[200px]",children:D?e.jsxs(e.Fragment,{children:[e.jsx(bt,{className:"h-4 w-4 mr-2 animate-spin"}),_==="script"&&"Preparing script...",_==="audio"&&"Creating audio...",_==="loading"&&"Loading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Vs,{className:"h-4 w-4 mr-2"}),"Prepare Today's Pep Talk"]})}),e.jsx(U,{variant:"outline",size:"default",className:"rounded-full",onClick:()=>s("/pep-talks"),children:"Browse Library"})]})]})]}):e.jsxs(We,{className:"relative overflow-hidden group animate-fade-in rounded-3xl border-2",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/25 via-accent/15 to-primary/10 animate-gradient-shift"}),m&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute top-1/4 left-1/4 w-1 h-1 bg-primary rounded-full animate-sparkle"}),e.jsx("div",{className:"absolute top-1/3 right-1/4 w-1.5 h-1.5 bg-accent rounded-full animate-sparkle",style:{animationDelay:"0.3s"}}),e.jsx("div",{className:"absolute bottom-1/3 left-1/3 w-1 h-1 bg-primary rounded-full animate-sparkle",style:{animationDelay:"0.6s"}}),e.jsx("div",{className:"absolute top-1/2 right-1/3 w-1.5 h-1.5 bg-accent rounded-full animate-sparkle",style:{animationDelay:"0.9s"}})]}),e.jsx("div",{className:"absolute -top-20 -right-20 w-40 h-40 bg-primary/20 blur-3xl rounded-full animate-pulse-slow"}),e.jsx("div",{className:"absolute -bottom-20 -left-20 w-40 h-40 bg-accent/20 blur-3xl rounded-full animate-pulse-slow",style:{animationDelay:"1.5s"}}),e.jsxs("div",{className:"relative p-6 md:p-8 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(pe,{className:"h-6 w-6 text-primary animate-pulse-slow"}),e.jsx("div",{className:"absolute inset-0 bg-primary/30 blur-md rounded-full"})]}),e.jsx("h2",{className:"text-xl font-bold bg-gradient-to-r from-primary via-accent to-primary bg-clip-text text-transparent animate-gradient-text",children:"Daily Message"})]}),e.jsxs("div",{className:"space-y-6 p-6 rounded-2xl bg-gradient-to-br from-card/90 to-card/70 backdrop-blur-sm border-2 border-primary/30 shadow-glow",children:[E&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-xs text-muted-foreground bg-muted/50 rounded-full px-3 py-1 mx-auto w-fit",children:[e.jsxs("span",{children:["From ",new Date(a.for_date+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})]}),e.jsx(U,{variant:"ghost",size:"sm",className:"h-auto py-0 px-2 text-xs text-primary hover:text-primary/80",onClick:re,disabled:D,children:D?e.jsxs(e.Fragment,{children:[e.jsx(bt,{className:"h-3 w-3 mr-1 animate-spin"}),_==="script"&&"Writing...",_==="audio"&&"Recording...",_==="loading"&&"Loading..."]}):"Refresh today's"})]}),e.jsxs("div",{className:"space-y-3 text-center",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-bold text-foreground",children:a.title}),e.jsx("p",{className:"text-sm text-muted-foreground leading-relaxed",children:a.summary})]}),e.jsx("audio",{ref:L,src:a.audio_url,preload:"auto",onCanPlay:()=>R(!0),onError:()=>{oe.error("Audio loading error",{audioUrl:a.audio_url,errorCode:L.current?.error?.code,errorMessage:L.current?.error?.message})},onLoadedMetadata:()=>{oe.log("Audio loaded successfully"),oe.log("Duration:",L.current?.duration),L.current?.duration&&L.current.duration>0&&R(!0)}}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(U,{size:"icon",onClick:ie,disabled:!I,className:A("h-20 w-20 rounded-full transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed",m?"bg-gradient-to-br from-accent to-primary shadow-glow-lg scale-110":"bg-gradient-to-br from-primary to-accent shadow-glow hover:scale-110"),"aria-label":I?m?"Pause pep talk":"Play pep talk":"Loading audio",children:I?m?e.jsx(Pr,{className:"h-8 w-8",fill:"currentColor"}):e.jsx(Ls,{className:"h-8 w-8 ml-1",fill:"currentColor"}):e.jsx(bt,{className:"h-8 w-8 animate-spin"})})}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(U,{variant:"ghost",size:"icon",onClick:()=>xe(-10),disabled:!1,className:"h-10 w-10 rounded-full hover:bg-primary/20 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:scale-105","aria-label":"Skip back 10 seconds",children:e.jsx(Dh,{className:"h-4 w-4"})}),e.jsxs("div",{className:"text-xs text-muted-foreground font-medium",children:[Te(h)," / ",Te(u)]}),e.jsx(U,{variant:"ghost",size:"icon",onClick:()=>xe(10),disabled:!1,className:"h-10 w-10 rounded-full hover:bg-primary/20 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:scale-105","aria-label":"Skip forward 10 seconds",children:e.jsx(ha,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"space-y-2 px-2",children:e.jsx($u,{value:[h],max:u>0?u:1,step:.1,onValueChange:K,disabled:u===0,className:"w-full"})}),e.jsxs("div",{className:"space-y-2 p-4 rounded-2xl bg-background/60 backdrop-blur-sm border border-primary/20 shadow-soft",children:[y?B():Ne(),a?.script&&e.jsxs(U,{variant:"ghost",size:"sm",onClick:()=>b(z=>!z),className:"w-full justify-between mt-2 rounded-full hover:bg-primary/10 transition-all",children:[e.jsx("span",{className:"text-xs font-medium",children:y?"Show Less":"Show Full Transcript"}),y?e.jsx(Zi,{className:"h-4 w-4"}):e.jsx(Os,{className:"h-4 w-4"})]})]})]}),e.jsx(U,{variant:"outline",size:"lg",className:"w-full rounded-full border-2 hover:bg-primary/10 hover:scale-105 transition-all shadow-soft",onClick:()=>s("/pep-talks"),children:"Browse More Pep Talks"})]})]})]})});Hu.displayName="TodaysPepTalk";const Kt=n.forwardRef(({className:t,...s},r)=>e.jsx("textarea",{className:A("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),ref:r,...s}));Kt.displayName="Textarea";const lb=({onSelect:t,selected:s})=>{const r=[{id:"unmotivated",label:"Unmotivated",icon:Ph,color:"text-red-500",borderColor:"border-red-500/50",bgColor:"bg-red-500/10"},{id:"overthinking",label:"Overthinking",icon:Ss,color:"text-purple-500",borderColor:"border-purple-500/50",bgColor:"bg-purple-500/10"},{id:"stressed",label:"Stressed",icon:ft,color:"text-orange-500",borderColor:"border-orange-500/50",bgColor:"bg-orange-500/10"},{id:"low_energy",label:"Low Energy",icon:Ah,color:"text-gray-400",borderColor:"border-gray-400/50",bgColor:"bg-gray-400/10"},{id:"content",label:"Content",icon:Rh,color:"text-blue-400",borderColor:"border-blue-400/50",bgColor:"bg-blue-400/10"},{id:"disciplined",label:"Disciplined",icon:At,color:"text-green-500",borderColor:"border-green-500/50",bgColor:"bg-green-500/10"},{id:"focused",label:"Focused",icon:Ih,color:"text-teal-500",borderColor:"border-teal-500/50",bgColor:"bg-teal-500/10"},{id:"inspired",label:"Inspired",icon:pe,color:"text-yellow-500",borderColor:"border-yellow-500/50",bgColor:"bg-yellow-500/10"}];return e.jsx("div",{className:"grid grid-cols-4 gap-2.5",children:r.map(a=>{const i=a.icon,o=s===a.id;return e.jsxs("button",{type:"button",onClick:()=>{t(a.id),window.dispatchEvent(new CustomEvent("mood-selected"))},className:A("flex flex-col items-center justify-center gap-1.5 p-3 rounded-xl border-2 transition-all duration-200 active:scale-95",o?`${a.bgColor} ${a.borderColor} shadow-md`:"bg-card/50 border-border/50 hover:border-primary/40 hover:bg-card/80"),children:[e.jsx("div",{className:A("w-9 h-9 rounded-full flex items-center justify-center transition-all duration-200",a.bgColor),children:e.jsx(i,{className:A("h-5 w-5",a.color)})}),e.jsx("span",{className:A("text-[10px] font-medium leading-none text-center",o?"text-foreground":"text-muted-foreground"),children:a.label})]},a.id)})})},mi=new Map,po=async t=>{if(mi.has(t))return mi.get(t);try{let s;switch(t.toLowerCase()){case"atlas":s=await ke(()=>import("./atlas-sage-CL7hL_Ez.js"),[]);break;case"eli":s=await ke(()=>import("./darius-sage-2XcD16mi.js"),[]);break;case"sienna":s=await ke(()=>import("./sienna-sage-CppN60cS.js"),[]);break;case"stryker":s=await ke(()=>import("./stryker-sage-B3PlAZKv.js"),[]);break;case"carmen":s=await ke(()=>import("./carmen-sage-CZySZiFo.js"),[]);break;case"reign":s=await ke(()=>import("./reign-sage-D4nrVOuM.js"),[]);break;case"solace":s=await ke(()=>import("./solace-sage-CJdBfLhM.js"),[]);break;default:s=await ke(()=>import("./atlas-sage-CL7hL_Ez.js"),[])}const r=s.default;return mi.set(t,r),r}catch(s){return console.error(`Failed to load mentor image for ${t}:`,s),""}},cb=()=>{const{user:t}=be(),{toast:s}=Ms(),r=Yr(),a=Ae(),{awardCheckInComplete:i,XP_REWARDS:o}=Xt(),{checkFirstTimeAchievements:l}=qn(),{triggerReaction:c}=Ra(),[d,m]=n.useState(""),[p,h]=n.useState(""),[f,u]=n.useState(!1),[g,y]=n.useState(""),b=n.useRef(null),v=new Date().toLocaleDateString("en-CA"),x=3e4;n.useEffect(()=>{if(!r){y("");return}const D=r.avatar_url?.trim();if(D){y(D);return}const C=(r.slug||"").trim().toLowerCase();if(!C){y("");return}let _=!1;return po(C).then(N=>{_||y(N||"")}).catch(()=>{_||y("")}),()=>{_=!0}},[r?.avatar_url,r?.slug,r?.name]);const{data:w}=Ee({queryKey:["morning-check-in",v,t?.id],queryFn:async()=>{if(!t)return null;const{data:D}=await S.from("daily_check_ins").select("*").eq("user_id",t.id).eq("check_in_type","morning").eq("check_in_date",v).maybeSingle();return D},enabled:!!t,refetchInterval:D=>{const C=D.state.data;if(C?.completed_at&&!C?.mentor_response){const _=b.current;return _&&Date.now()-_>x?(oe.warn("Mentor response polling timeout exceeded"),!1):2e3}return!1}}),j=async()=>{if(!t||!d||!p.trim()){s({title:"Please complete all fields",variant:"destructive"});return}if(w||f){s({title:"Already checked in",description:"You've already completed your check-in today",variant:"destructive"});return}u(!0);try{const{data:D}=await S.from("daily_check_ins").select("id").eq("user_id",t.id).eq("check_in_type","morning").eq("check_in_date",v).maybeSingle();if(D){s({title:"Already checked in",description:"You've already completed your check-in today",variant:"destructive"}),u(!1),a.invalidateQueries({queryKey:["morning-check-in"]});return}const{data:C,error:_}=await S.from("daily_check_ins").insert({user_id:t.id,check_in_type:"morning",check_in_date:v,mood:d,intention:p.trim(),completed_at:new Date().toISOString()}).select().maybeSingle();if(_)throw oe.error("Check-in error:",_),_;i(),c("mentor",{momentType:"discipline_win"}).catch(E=>oe.log("[LivingCompanion] Mentor reaction failed:",E));const{count:N}=await S.from("daily_check_ins").select("*",{count:"exact",head:!0}).eq("user_id",t.id);N===1&&await l("checkin"),window.dispatchEvent(new CustomEvent("quest-completed")),window.dispatchEvent(new CustomEvent("morning-checkin-completed")),b.current=Date.now();try{const{error:E}=await S.functions.invoke("generate-check-in-response",{body:{checkInId:C.id}});E&&oe.error("Edge function invocation error:",E)}catch(E){oe.error("Edge function invocation failed:",E)}a.invalidateQueries({queryKey:["morning-check-in"]})}catch(D){oe.error("Check-in save error:",D),s({title:"Error",description:D instanceof Error?D.message:"Failed to save check-in",variant:"destructive"})}finally{u(!1)}};return w?.completed_at?e.jsx(We,{"data-tour":"morning-checkin",className:"p-5 sm:p-6 bg-card/25 backdrop-blur-2xl border-celestial-blue/20",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-stardust-gold/20 flex items-center justify-center flex-shrink-0 ring-1 ring-stardust-gold/30",children:e.jsx(Ro,{className:"h-5 w-5 text-stardust-gold"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h3",{className:"font-bold text-lg",children:"Check-in Complete"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Focus: ",w.intention]})]})]}),r&&e.jsxs("div",{className:"relative overflow-hidden bg-white/[0.03] backdrop-blur-xl rounded-2xl p-4 sm:p-5 border border-white/[0.08]",children:[e.jsx("span",{"aria-hidden":"true",className:"absolute -left-1 -top-7 text-7xl leading-none font-serif text-white/[0.08] select-none",children:'"'}),e.jsxs("div",{className:"relative space-y-3",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 border border-white/10",children:[e.jsx("p",{className:"text-xs sm:text-sm font-semibold text-foreground",children:r.name}),e.jsx(pe,{className:"h-3.5 w-3.5 text-stardust-gold"})]}),e.jsxs("div",{"data-testid":"mentor-response-body",className:"flow-root",children:[g&&e.jsx("img",{"data-testid":"mentor-portrait-tile",src:g,alt:`${r.name} portrait`,className:"float-right ml-3 mb-2 h-16 w-12 sm:h-20 sm:w-14 rounded-xl object-cover border border-white/10 shadow-[0_10px_24px_rgba(0,0,0,0.28)]",style:{objectPosition:"center 25%"},loading:"lazy",decoding:"async"}),w.mentor_response?e.jsxs("p",{className:"text-base italic text-foreground/90 leading-relaxed",children:['"',w.mentor_response,'"']}):b.current&&Date.now()-b.current>x?e.jsx("p",{className:"text-base text-foreground/80 italic leading-relaxed",children:'"Great work on setting your intention today. Stay focused and crush it."'}):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"Preparing your personalized message..."})]})]})]})]})}):e.jsxs("div",{"data-tour":"morning-checkin",className:"rounded-2xl bg-card/25 backdrop-blur-2xl border border-white/[0.08] overflow-hidden animate-scale-in shadow-[0_8px_32px_rgba(0,0,0,0.12)]",children:[e.jsx("div",{className:"px-5 py-4 border-b border-white/[0.06] bg-gradient-to-r from-orange-500/5 to-amber-500/[0.02]",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-11 w-11 rounded-xl bg-gradient-to-br from-orange-500/20 to-amber-500/20 flex items-center justify-center border border-orange-500/30",children:e.jsx(Ro,{className:"h-5 w-5 text-orange-500"})}),e.jsx("h3",{className:"font-heading font-black text-2xl tracking-wide text-orange-500",children:"CHECK-IN"})]})}),e.jsxs("div",{className:"p-5 space-y-5",children:[e.jsxs("div",{"data-tour":"checkin-mood",className:"space-y-3",children:[e.jsx("label",{className:"text-sm font-bold text-foreground",children:"How are you feeling?"}),e.jsx(lb,{selected:d,onSelect:m})]}),e.jsx("div",{className:"h-px bg-border/30"}),e.jsxs("div",{"data-tour":"checkin-intention",className:"space-y-3",children:[e.jsxs("label",{className:"text-sm font-bold flex items-center gap-2 text-foreground",children:[e.jsx(At,{className:"h-4 w-4 text-primary"}),"What's your main focus today?"]}),e.jsx(Kt,{placeholder:"I will...",value:p,onChange:D=>h(D.target.value),rows:3,className:"resize-none transition-all duration-200 focus:shadow-glow bg-muted/30 border-border/50"})]}),e.jsx(U,{onClick:j,"data-tour":"checkin-submit",disabled:f||!d||!p.trim()||!!w,variant:"cta",className:"w-full h-13 text-base",size:"lg",children:f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-background border-t-transparent"}),"Setting Intention..."]}):e.jsxs(e.Fragment,{children:["Check in",e.jsxs("span",{className:"ml-1 px-2 py-0.5 rounded-full bg-white/20 text-xs",children:["+",o.CHECK_IN," XP"]})]})})]})]})},Bu=n.memo(()=>e.jsx(es,{fallback:e.jsx(Nx,{}),children:e.jsx(cb,{})}));Bu.displayName="MorningCheckIn";const db={atlas:"center 20%",eli:"center 15%",sienna:"center 30%",stryker:"center 25%",carmen:"center 20%",reign:"center 20%",solace:"center 25%"},ub={sm:"w-16 h-16",md:"w-24 h-24 md:w-32 md:h-32",lg:"w-32 h-32 md:w-40 md:h-40",xl:"w-48 h-48 md:w-56 md:h-56"},pa=n.memo(({mentorSlug:t,mentorName:s,primaryColor:r,avatarUrl:a,size:i="md",className:o="",showBorder:l=!0,showGlow:c=!1,style:d})=>{const[m,p]=n.useState(a||"");n.useEffect(()=>{if(a){p(a);return}const b=(t||"").trim().toLowerCase();b&&po(b).then(p).catch(()=>{})},[t,a]);const h=(t||"").trim().toLowerCase(),f=(s||"").trim().toLowerCase().replace(/\s+/g,"-"),g=db[h||f]||"center 25%",y=b=>b.split(" ").map(v=>v[0]).join("").toUpperCase();return e.jsx("div",{className:`relative ${ub[i]} rounded-full overflow-hidden ${o}`,style:{...d,border:l?`4px solid ${r}`:void 0,boxShadow:d?.boxShadow||(c?`0 0 40px ${r}60`:l?`0 0 20px ${r}40`:void 0)},children:m?e.jsx("img",{src:m,alt:s,className:"w-full h-full object-cover",style:{objectPosition:g},loading:"lazy",decoding:"async"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-pure-white text-4xl font-black",style:{backgroundColor:r},children:y(s)})})}),mb=()=>{const{user:t}=be(),{profile:s}=Yt(),r=Ae(),a=n.useMemo(()=>{const h=s?.timezone||"UTC";try{return new Intl.DateTimeFormat("en-CA",{timeZone:h,year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date)}catch{return new Date().toLocaleDateString("en-CA")}},[s?.timezone]),{data:i,isLoading:o,error:l,refetch:c}=Ee({queryKey:["morning-briefing",a,t?.id],queryFn:async()=>{if(!t)return null;const{data:h}=await S.from("morning_briefings").select("*").eq("user_id",t.id).eq("briefing_date",a).maybeSingle();return h},enabled:!!t,staleTime:1e3*60*5}),d=le({mutationFn:async()=>{const{data:h}=await S.from("morning_briefings").select("id").eq("user_id",t?.id).eq("briefing_date",a).maybeSingle();if(h)return await c(),null;const{data:f,error:u}=await S.functions.invoke("generate-morning-briefing");if(u)throw u;if(f.error)throw new Error(f.error);return f.briefing},onSuccess:()=>{r.invalidateQueries({queryKey:["morning-briefing"]})}}),m=le({mutationFn:async h=>{const{error:f}=await S.from("morning_briefings").update({viewed_at:new Date().toISOString()}).eq("id",h);if(f)throw f},onSuccess:()=>{r.invalidateQueries({queryKey:["morning-briefing"]})}}),p=le({mutationFn:async h=>{const{error:f}=await S.from("morning_briefings").update({dismissed_at:new Date().toISOString()}).eq("id",h);if(f)throw f},onSuccess:()=>{r.invalidateQueries({queryKey:["morning-briefing"]})}});return{briefing:i,isLoading:o,error:l,refetch:c,generateBriefing:d,markViewed:m,dismissBriefing:p,isGenerating:d.isPending}},Uu=n.memo(({onAskMore:t,className:s})=>{const r=as(),{toast:a}=Ms(),i=Yr(),{briefing:o,isLoading:l,generateBriefing:c,dismissBriefing:d,markViewed:m,isGenerating:p}=mb(),[h,f]=n.useState(!1),[u,g]=n.useState(!1);n.useEffect(()=>{o&&!o.viewed_at&&m.mutate(o.id)},[o?.id]),n.useEffect(()=>{o?.dismissed_at&&g(!0)},[o?.dismissed_at]);const y=async()=>{try{await c.mutateAsync()}catch(w){console.error("Failed to generate briefing:",w),a({title:"Couldn't prepare briefing",description:w instanceof Error?w.message:"Please try again later",variant:"destructive"})}},b=async()=>{if(o){g(!0);try{await d.mutateAsync(o.id)}catch(w){console.error("Failed to dismiss briefing:",w)}}},v=()=>{if(o){if(t){t(o.content,o.action_prompt||"");return}r("/mentor-chat",{state:{initialMessage:o.action_prompt||"Let's discuss my morning briefing",briefingContext:o.content,comprehensiveMode:!0}})}};if(u&&o)return e.jsx(We,{className:A("p-4 bg-card/25 backdrop-blur-2xl border-white/[0.08] cursor-pointer hover:border-primary/20 transition-colors",s),onClick:()=>g(!1),children:e.jsxs("div",{className:"flex items-center gap-3",children:[i&&e.jsx(pa,{mentorSlug:(i.slug||"").toLowerCase(),mentorName:i.name,primaryColor:i.primary_color||"#000",avatarUrl:i.avatar_url||void 0,size:"sm",showBorder:!0}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Morning Briefing"}),e.jsx(Pt,{className:"h-4 w-4 text-primary"})]}),o.todays_focus&&e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:["Focus: ",o.todays_focus]})]}),e.jsx(Os,{className:"h-5 w-5 text-muted-foreground flex-shrink-0"})]})});if(l)return e.jsx(We,{className:A("p-6 animate-pulse bg-card/25 backdrop-blur-2xl border-white/[0.08]",s),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-full bg-muted"}),e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx("div",{className:"h-4 bg-muted rounded w-1/3"}),e.jsx("div",{className:"h-3 bg-muted rounded w-2/3"})]})]})});if(!o)return e.jsxs("div",{className:A("rounded-2xl bg-card/25 backdrop-blur-2xl border border-white/[0.08] overflow-hidden shadow-[0_8px_32px_rgba(0,0,0,0.12)]",s),children:[e.jsx("div",{className:"px-4 py-3 sm:px-5 sm:py-4 border-b border-white/[0.06] bg-gradient-to-r from-primary/5 to-accent/[0.02]",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-9 w-9 sm:h-11 sm:w-11 rounded-xl bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center border border-primary/30",children:e.jsx(Ss,{className:"h-4 w-4 sm:h-5 sm:w-5 text-primary"})}),e.jsx("h3",{className:"font-heading font-black text-lg sm:text-2xl tracking-wide text-primary",children:"MORNING BRIEFING"})]})}),e.jsx("div",{className:"p-4 sm:p-5",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[i&&e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:"absolute -inset-1 rounded-full bg-gradient-to-br from-red-500 to-pink-500 opacity-70"}),e.jsx(pa,{mentorSlug:(i.slug||"").toLowerCase(),mentorName:i.name,primaryColor:i.primary_color||"#000",avatarUrl:i.avatar_url||void 0,size:"md",showBorder:!1,className:"relative"})]}),e.jsxs("div",{className:"w-full space-y-4 text-center",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Get personalized insights from ",i?.name||"your mentor"," based on your activity"]}),e.jsx(U,{onClick:y,disabled:p,variant:"cta",className:"w-full h-10 sm:h-12",size:"lg",children:p?e.jsxs(e.Fragment,{children:[e.jsx(bt,{className:"h-4 w-4 animate-spin"}),"Analyzing your progress..."]}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"h-5 w-5"}),"Prepare My Briefing"]})})]})]})})]});const x=Array.isArray(o.inferred_goals)?o.inferred_goals:[];return e.jsxs(We,{className:A("overflow-hidden bg-card/25 backdrop-blur-2xl border-white/[0.08]",s),children:[e.jsx("div",{className:"p-4 sm:p-6 border-b border-white/[0.06]",children:e.jsxs("div",{className:"flex items-start gap-4",children:[i&&e.jsx(pa,{mentorSlug:(i.slug||"").toLowerCase(),mentorName:i.name,primaryColor:i.primary_color||"#000",avatarUrl:i.avatar_url||void 0,size:"md",showBorder:!0,className:"flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("h3",{className:"font-bold text-base sm:text-lg truncate",children:[i?.name||"Your Mentor","'s Briefing"]}),e.jsx(pe,{className:"h-4 w-4 text-primary flex-shrink-0"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Personalized insights for today"})]})]})}),x.length>0&&e.jsxs("div",{className:"px-4 sm:px-6 py-3 bg-white/[0.02] border-b border-white/[0.06]",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ts,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wide",children:"What I see you working toward"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:x.map((w,j)=>e.jsx(Fe,{variant:"secondary",className:"bg-primary/10 text-primary border-primary/20",children:w},j))})]}),e.jsxs("div",{className:"p-4 sm:p-6 space-y-4",children:[e.jsx("div",{className:A("text-sm leading-relaxed text-foreground/90 whitespace-pre-wrap",!h&&"line-clamp-4"),children:o.content}),o.content.length>300&&e.jsx(U,{variant:"ghost",size:"sm",onClick:()=>f(!h),className:"text-primary hover:text-primary/80 -ml-2",children:h?"Show less":"Read more"}),o.todays_focus&&e.jsx("div",{className:"bg-white/[0.03] backdrop-blur-xl rounded-2xl p-4 border border-white/[0.08]",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(At,{className:"h-5 w-5 text-primary flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wide mb-1",children:"Today's Focus"}),e.jsx("p",{className:"text-sm font-medium text-foreground",children:o.todays_focus})]})]})})]}),e.jsxs("div",{className:"px-4 sm:px-6 pb-4 sm:pb-6 flex flex-col sm:flex-row gap-3",children:[e.jsxs(U,{variant:"outline",onClick:b,className:"flex-1 sm:flex-none",children:[e.jsx(Pt,{className:"h-4 w-4 mr-2"}),"Done"]}),e.jsxs(U,{onClick:v,className:"flex-1 bg-primary hover:bg-primary/90",children:[e.jsx(Vi,{className:"h-4 w-4 mr-2"}),"Ask ",i?.name||"Mentor"," More"]})]})]})});Uu.displayName="MorningBriefing";const zu=()=>{const{user:t}=be(),s=Ae(),{awardCustomXP:r,XP_REWARDS:a}=Xt(),[i,o]=n.useState(!1),l=te(new Date,"yyyy-MM-dd"),c=new Date().getHours()>=18,{data:d,isLoading:m}=Ee({queryKey:["evening-reflection",t?.id,l],queryFn:async()=>{if(!t?.id)return null;const{data:u,error:g}=await S.from("evening_reflections").select("*").eq("user_id",t.id).eq("reflection_date",l).maybeSingle();if(g)throw g;return u},enabled:!!t?.id}),p=!!d,h=c&&!p&&!m,f=le({mutationFn:async u=>{if(!t?.id)throw new Error("Not authenticated");const{data:g,error:y}=await S.from("evening_reflections").insert({user_id:t.id,reflection_date:l,mood:u.mood,wins:u.wins||null,gratitude:u.gratitude||null}).select().single();if(y)throw y;return S.functions.invoke("generate-evening-response",{body:{reflectionId:g.id}}).catch(console.error),g},onSuccess:()=>{s.invalidateQueries({queryKey:["evening-reflection"]}),r(a.EVENING_REFLECTION,"evening_reflection","Evening Reflection"),o(!1)}});return{isEvening:c,hasCompletedToday:p,shouldShowBanner:h,todaysReflection:d,isLoading:m,isDrawerOpen:i,setIsDrawerOpen:o,submitReflection:f.mutate,isSubmitting:f.isPending}},ur=({shouldScaleBackground:t=!0,repositionInputs:s,...r})=>e.jsx(gs.Root,{shouldScaleBackground:t,repositionInputs:s,...r});ur.displayName="Drawer";const ho=gs.Trigger,pb=gs.Portal,Qu=n.forwardRef(({className:t,...s},r)=>e.jsx(gs.Overlay,{ref:r,className:A("fixed inset-0 z-50 bg-black/58 backdrop-blur-[2px]",t),style:{touchAction:"none",WebkitTapHighlightColor:"transparent"},...s}));Qu.displayName=gs.Overlay.displayName;const mr=n.forwardRef(({className:t,children:s,...r},a)=>e.jsxs(pb,{children:[e.jsx(Qu,{}),e.jsxs(gs.Content,{ref:a,className:A("fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto max-h-[85dvh] flex-col rounded-t-[20px] border border-border/70 bg-card/95 backdrop-blur-xl isolate shadow-[0_-14px_34px_rgba(0,0,0,0.34)]",t),style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent",willChange:"transform"},...r,children:[e.jsx(gs.Handle,{className:"mx-auto mt-4 h-1.5 w-[88px] rounded-full bg-muted-foreground/45"}),s]})]}));mr.displayName="DrawerContent";const pr=({className:t,...s})=>e.jsx("div",{className:A("grid gap-1.5 p-4 text-center sm:text-left",t),...s});pr.displayName="DrawerHeader";const Ku=({className:t,...s})=>e.jsx("div",{className:A("mt-auto flex flex-col gap-2 p-4",t),...s});Ku.displayName="DrawerFooter";const hr=n.forwardRef(({className:t,...s},r)=>e.jsx(gs.Title,{ref:r,className:A("text-lg font-semibold leading-none tracking-tight",t),...s}));hr.displayName=gs.Title.displayName;const fo=n.forwardRef(({className:t,...s},r)=>e.jsx(gs.Description,{ref:r,className:A("text-sm text-muted-foreground",t),...s}));fo.displayName=gs.Description.displayName;const hb=()=>typeof navigator>"u"?!1:/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,fb=()=>typeof window.Capacitor<"u",gb=()=>{if(typeof document>"u")return 0;try{const t=document.createElement("div");t.style.paddingBottom="env(safe-area-inset-bottom, 0px)",document.body.appendChild(t);const s=parseInt(getComputedStyle(t).paddingBottom)||0;return document.body.removeChild(t),s}catch{return 0}};function xb(t={}){const{enabled:s=!0,offsetBuffer:r=0,animationDuration:a=200}=t,[i,o]=n.useState(0),[l,c]=n.useState(0),d=n.useRef(!1),m=n.useRef([]),p=n.useMemo(()=>hb(),[]),h=n.useMemo(()=>fb(),[]),f=i>0,u=s?i+r:0,g=n.useCallback(()=>{if(!s||!window.visualViewport||d.current)return;d.current=!0;const j=window.visualViewport.height,D=window.innerHeight,C=window.visualViewport.offsetTop,_=Math.max(0,D-j-C);o(N=>Math.abs(N-_)>10||_===0?_:N),d.current=!1},[s]),y=n.useCallback(()=>{m.current.forEach(D=>clearTimeout(D)),m.current=[],[50,150,300,500].forEach(D=>{const C=setTimeout(g,D);m.current.push(C)})},[g]);n.useEffect(()=>{c(gb())},[]),n.useEffect(()=>{if(!s||!window.visualViewport)return;window.visualViewport.addEventListener("resize",g),window.visualViewport.addEventListener("scroll",g);const j=C=>{const _=C.target;(_?.tagName==="INPUT"||_?.tagName==="TEXTAREA")&&y()},D=()=>{setTimeout(()=>{(!document.activeElement||document.activeElement.tagName!=="INPUT"&&document.activeElement.tagName!=="TEXTAREA")&&o(0)},100)};return document.addEventListener("focusin",j),document.addEventListener("focusout",D),g(),()=>{window.visualViewport?.removeEventListener("resize",g),window.visualViewport?.removeEventListener("scroll",g),document.removeEventListener("focusin",j),document.removeEventListener("focusout",D),m.current.forEach(C=>clearTimeout(C))}},[s,g,y]);const b=n.useCallback(j=>{j.current&&setTimeout(()=>{j.current?.scrollIntoView({behavior:"smooth",block:"center"})},300)},[]),v=n.useCallback(()=>{document.activeElement instanceof HTMLElement&&document.activeElement.blur()},[]),x=n.useMemo(()=>({bottom:u>0?`${u}px`:"0px",transition:`bottom ${a}ms ease-out`}),[u,a]),w=n.useMemo(()=>({touchAction:"manipulation",WebkitTapHighlightColor:"transparent"}),[]);return{keyboardHeight:i,isKeyboardVisible:f,safeAreaBottom:l,totalOffset:u,isIOS:p,isNative:h,containerStyle:x,inputStyle:w,scrollInputIntoView:b,dismissKeyboard:v}}const yb=[{emoji:"ðŸ˜Š",label:"Great",value:"great"},{emoji:"ðŸ™‚",label:"Good",value:"good"},{emoji:"ðŸ˜",label:"Okay",value:"okay"},{emoji:"ðŸ˜”",label:"Low",value:"low"},{emoji:"ðŸ˜¢",label:"Rough",value:"rough"}],bb=({open:t,onOpenChange:s})=>{const{submitReflection:r,isSubmitting:a}=zu(),[i,o]=n.useState(""),[l,c]=n.useState(""),[d,m]=n.useState(""),p=n.useRef(null),h=n.useRef(null),{containerStyle:f,inputStyle:u,scrollInputIntoView:g}=xb({offsetBuffer:10}),y=x=>{x||(o(""),c(""),m("")),s(x)},b=()=>{i&&(r({mood:i,wins:l.trim()||void 0,gratitude:d.trim()||void 0}),o(""),c(""),m(""))},v=i.length>0;return e.jsx(ur,{open:t,onOpenChange:y,shouldScaleBackground:!1,handleOnly:!0,repositionInputs:!1,children:e.jsx(mr,{className:"max-h-[85dvh]",style:f,children:e.jsxs("div",{className:"mx-auto w-full max-w-lg px-4 pb-8 overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",maxHeight:"calc(85dvh - 80px)"},"data-vaul-no-drag":!0,children:[e.jsxs(pr,{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[e.jsx(fa,{className:"h-6 w-6 text-purple-400"}),e.jsx(hr,{className:"text-xl",children:"Evening Reflection"})]}),e.jsx(fo,{children:"Take a moment to reflect on your day"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"How are you feeling tonight?"}),e.jsx("div",{className:"flex justify-center gap-2",children:yb.map(x=>e.jsxs("button",{onClick:()=>o(x.value),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all ${i===x.value?"bg-primary/20 border-2 border-primary scale-105":"bg-muted/50 border-2 border-transparent hover:bg-muted"}`,children:[e.jsx("span",{className:"text-2xl",children:x.emoji}),e.jsx("span",{className:"text-xs text-muted-foreground",children:x.label})]},x.value))})]}),e.jsxs("div",{className:"space-y-2","data-vaul-no-drag":!0,children:[e.jsxs("label",{className:"text-sm font-medium text-foreground",children:["What went well today? ",e.jsx("span",{className:"text-muted-foreground",children:"(optional)"})]}),e.jsx(Kt,{ref:p,placeholder:"A small win, a moment of joy, something you accomplished...",value:l,onChange:x=>c(x.target.value.slice(0,280)),onFocus:()=>g(p),className:"resize-none h-20 bg-muted/30 border-border/50",style:u}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[l.length,"/280"]})]}),e.jsxs("div",{className:"space-y-2","data-vaul-no-drag":!0,children:[e.jsxs("label",{className:"text-sm font-medium text-foreground",children:["What are you grateful for? ",e.jsx("span",{className:"text-muted-foreground",children:"(optional)"})]}),e.jsx(Kt,{ref:h,placeholder:"Something or someone you appreciate today...",value:d,onChange:x=>m(x.target.value.slice(0,280)),onFocus:()=>g(h),className:"resize-none h-20 bg-muted/30 border-border/50",style:u}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[d.length,"/280"]})]}),e.jsx(U,{onClick:b,disabled:!v||a,className:"w-full h-12 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500",children:a?"Saving...":e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-4 w-4"}),"Complete Reflection",e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-white/20",children:"+3 XP"})]})})]})]})})})},Wu=n.memo(()=>{const{shouldShowBanner:t,isDrawerOpen:s,setIsDrawerOpen:r}=zu();return t?e.jsxs(e.Fragment,{children:[e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mx-4",children:e.jsxs("button",{onClick:()=>r(!0),className:"relative w-full p-4 rounded-2xl bg-gradient-to-r from-indigo-600/30 via-purple-600/30 to-pink-600/30 border border-purple-500/40 backdrop-blur-sm hover:border-purple-400/60 hover:shadow-lg hover:shadow-purple-500/20 transition-all duration-300 group overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 overflow-hidden rounded-2xl",children:e.jsx("div",{className:"absolute inset-0 -translate-x-full animate-[shimmer-sweep_3s_ease-in-out_infinite] bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12"})}),e.jsxs("div",{className:"absolute inset-0 overflow-hidden rounded-2xl pointer-events-none",children:[e.jsx(M.div,{animate:{opacity:[.3,.7,.3],scale:[.8,1.1,.8]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},className:"absolute top-2 right-8",children:e.jsx(pe,{className:"h-3 w-3 text-purple-300/60"})}),e.jsx(M.div,{animate:{opacity:[.5,.9,.5],scale:[1,1.2,1]},transition:{duration:2.5,repeat:1/0,ease:"easeInOut",delay:.5},className:"absolute bottom-3 right-16",children:e.jsx(pe,{className:"h-2 w-2 text-pink-300/50"})})]}),e.jsx("div",{className:"absolute inset-0 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-gradient-to-r from-indigo-500/10 via-purple-500/10 to-pink-500/10"}),e.jsxs("div",{className:"relative flex items-center gap-3",children:[e.jsx(M.div,{className:"p-2.5 rounded-full bg-gradient-to-br from-purple-500/30 to-indigo-500/30 border border-purple-400/30 group-hover:border-purple-300/50 transition-all duration-300",animate:{boxShadow:["0 0 0 0 rgba(168, 85, 247, 0)","0 0 15px 2px rgba(168, 85, 247, 0.3)","0 0 0 0 rgba(168, 85, 247, 0)"]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx(fa,{className:"h-5 w-5 text-purple-200 group-hover:text-purple-100 transition-colors"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-semibold text-foreground group-hover:text-white transition-colors",children:"Evening Reflection"}),e.jsx("p",{className:"text-sm text-muted-foreground group-hover:text-purple-200/80 transition-colors",children:"How was your day? âœ¨"})]}),e.jsx(M.div,{className:"text-xs px-3 py-1.5 rounded-full bg-gradient-to-r from-primary/30 to-purple-500/30 text-primary font-bold border border-primary/30 group-hover:border-primary/50 transition-all",animate:{scale:[1,1.05,1]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"},children:"+3 XP"})]})]})}),e.jsx(bb,{open:s,onOpenChange:r})]}):null});Wu.displayName="EveningReflectionBanner";const Gu=n.memo(()=>{const{currentRecap:t,openRecap:s}=qu();if(!t)return null;const r=ps(t.week_start_date),a=ps(t.week_end_date),i=`${te(r,"MMM d")} - ${te(a,"MMM d")}`;return e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mx-4",children:e.jsx("button",{onClick:()=>s(t),className:"w-full p-4 rounded-2xl bg-gradient-to-r from-stardust-gold/10 via-amber-500/5 to-celestial-blue/5 border border-white/[0.08] backdrop-blur-2xl hover:border-stardust-gold/30 transition-all group shadow-[0_8px_32px_rgba(0,0,0,0.12)]",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full bg-stardust-gold/20 group-hover:bg-stardust-gold/30 transition-colors",children:e.jsx(pe,{className:"h-5 w-5 text-stardust-gold"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-medium text-foreground",children:"Your Week in Review"}),e.jsx("p",{className:"text-sm text-celestial-blue",children:i})]}),!t.viewed_at&&e.jsx("div",{className:"text-xs px-2 py-1 rounded-full bg-stardust-gold/20 text-stardust-gold font-medium",children:"+5 XP"}),e.jsx(Et,{className:"h-5 w-5 text-muted-foreground group-hover:text-stardust-gold transition-colors"})]})})})});Gu.displayName="WeeklyRecapCard";function vb(){const{user:t}=be(),s=Ae(),{data:r,isLoading:a,error:i,refetch:o}=Ee({queryKey:["daily-plan-optimization",t?.id],queryFn:async()=>{if(!t)return null;const{data:f,error:u}=await S.functions.invoke("optimize-daily-plan");if(u)throw console.error("Error fetching daily plan optimization:",u),u;return f},enabled:!!t,staleTime:300*1e3,gcTime:900*1e3,refetchOnWindowFocus:!1}),l=le({mutationFn:async f=>{const{data:u,error:g}=await S.functions.invoke("generate-daily-plan",{body:f});if(g)throw console.error("Error generating daily plan:",g),g;return u},onSuccess:()=>{s.invalidateQueries({queryKey:["daily-tasks"]}),s.invalidateQueries({queryKey:["calendar-tasks"]})}}),c=n.useCallback(async f=>{if(!t)return null;const u=f?{energyLevel:f.energyLevel,dayType:f.dayType,focusArea:f.focusArea}:{},{data:g,error:y}=await S.functions.invoke("optimize-daily-plan",{body:u});if(y)throw console.error("Error fetching daily plan optimization with answers:",y),y;return g},[t]),d=r?.insights??[],m=d.filter(f=>f.priority==="high"),p=d.some(f=>f.type==="warning"),h=d.some(f=>f.type==="encouragement");return{insights:d,highPriorityInsights:m,energyForecast:r?.energyForecast,overallReadiness:r?.overallReadiness??0,suggestedSchedule:r?.suggestedSchedule,hasWarnings:p,hasEncouragement:h,isLoading:a,error:i instanceof Error?i.message:null,refetch:o,optimizeWithAnswers:c,generatePlan:l.mutateAsync,isGenerating:l.isPending,generateError:l.error}}const wb={optimization:{icon:ft,color:"text-blue-500",bgColor:"bg-blue-500/10",borderColor:"border-blue-500/30"},warning:{icon:Xs,color:"text-amber-500",bgColor:"bg-amber-500/10",borderColor:"border-amber-500/30"},encouragement:{icon:Ts,color:"text-green-500",bgColor:"bg-green-500/10",borderColor:"border-green-500/30"},suggestion:{icon:eo,color:"text-purple-500",bgColor:"bg-purple-500/10",borderColor:"border-purple-500/30"}},_b=n.memo(function({insight:s,onAction:r,onDismiss:a}){const i=wb[s.type],o=i.icon;return e.jsx(M.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},exit:{opacity:0,x:10},children:e.jsx("div",{className:A("rounded-2xl backdrop-blur-2xl border-l-4 border-t border-r border-b bg-card/25 p-4",i.borderColor.replace("border-","border-l-"),"border-t-white/[0.08] border-r-white/[0.08] border-b-white/[0.08]"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:A("p-2 rounded-lg flex-shrink-0",i.bgColor),children:e.jsx(o,{className:A("h-4 w-4",i.color)})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1",children:[e.jsx("p",{className:"text-sm font-bold text-foreground",children:s.title}),a&&s.priority!=="high"&&e.jsx(U,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-50 hover:opacity-100",onClick:()=>a(s),children:e.jsx(Nt,{className:"h-3 w-3"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground leading-relaxed",children:s.message}),s.actionLabel&&r&&e.jsxs("button",{className:A("mt-2 text-xs font-bold uppercase tracking-wide flex items-center gap-1",i.color),onClick:()=>r(s),children:[s.actionLabel,e.jsx(Et,{className:"h-3 w-3"})]})]})]})})})}),jb=n.memo(function({compact:s=!1,maxInsights:r=3,onInsightAction:a}){const{insights:i,isLoading:o}=vb();if(o)return e.jsx("div",{className:"rounded-2xl bg-card/25 backdrop-blur-2xl border border-white/[0.08] p-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(pe,{className:"h-4 w-4 animate-pulse"}),e.jsx("span",{className:"text-sm",children:"Analyzing your day..."})]})});if(i.length===0)return null;const l=i.slice(0,r);return e.jsx("div",{className:"space-y-4",children:e.jsx(Pe,{mode:"popLayout",children:e.jsx("div",{className:"space-y-3",children:l.map((c,d)=>e.jsx(_b,{insight:c,onAction:a},`${c.type}-${c.title}-${d}`))})})})}),cs=({children:t,offset:s=20,stiffness:r=100,damping:a=30,className:i})=>{const o=n.useRef(null),l=Ea(),c=n.useMemo(()=>{if(typeof window>"u")return!1;const y=window.Capacitor;return!!(y?.isNativePlatform?.()&&y?.getPlatform?.()==="ios")},[]),d=l||c,{scrollYProgress:m}=Lh({target:o,offset:["start end","end start"]}),p=Gn(m,[0,1],[s*.65,-s*.65]),h=Io(p,{stiffness:r,damping:a}),f=Gn(m,[0,.5,1],[.992,1,.992]),u=Io(f,{stiffness:170,damping:36}),g=Gn(m,[0,.3,.7,1],[.9,1,1,.9]);return d?e.jsx("div",{className:A(i),children:t}):e.jsx(M.div,{ref:o,style:{y:h,scale:u,opacity:g,willChange:"transform, opacity"},className:A(i),children:t})},yl=.15,Nb=({enabled:t=!0}={})=>{const[s,r]=n.useState({gamma:0,beta:0,permitted:!1,available:typeof DeviceOrientationEvent<"u"}),a=n.useRef(0),i=n.useRef(0),o=n.useRef(0),l=n.useRef(0),c=n.useCallback(async()=>{if(!t)return!1;if(typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function")try{return await DeviceOrientationEvent.requestPermission()==="granted"?(r(f=>({...f,permitted:!0})),!0):!1}catch{return!1}return r(h=>({...h,permitted:!0})),!0},[t]);n.useEffect(()=>{if(!t||!s.available)return;const h=f=>{o.current=f.gamma??0,l.current=f.beta??0,a.current=a.current+yl*(o.current-a.current),i.current=i.current+yl*(l.current-i.current),r(u=>({...u,gamma:a.current,beta:i.current,permitted:!0}))};return window.addEventListener("deviceorientation",h),()=>{window.removeEventListener("deviceorientation",h)}},[t,s.available]);const d=n.useCallback((h=5,f=2.5)=>{const{gamma:u}=s,y=(Math.abs(u)<h?0:u)/30*50*f;return Math.max(8,Math.min(92,50+y))},[s]),m=n.useCallback((h=8,f=1.5)=>{const{beta:u}=s,g=u>=0?1:-1,y=Math.abs(u),v=(y<h?g*(y*y/h):g*y)/50*50*f;return Math.max(3,Math.min(97,50+v))},[s]),p=n.useCallback(()=>({gamma:o.current,beta:l.current}),[]);return{...s,requestPermission:c,getPositionFromTilt:d,getLandscapePositionFromTilt:m,getRawOrientation:p}},kb={dawn:{white:.35,blue:.1,pink:.2,gold:.25,teal:.05,orange:.05},morning:{white:.4,blue:.25,pink:.1,gold:.1,teal:.1,orange:.05},afternoon:{white:.35,blue:.15,pink:.1,gold:.2,teal:.15,orange:.05},sunset:{white:.25,blue:.05,pink:.25,gold:.2,teal:.05,orange:.2},night:{white:.4,blue:.25,pink:.15,gold:.1,teal:.1,orange:0}},Cb=()=>{const{period:t,progress:s,colors:r,rotationHue:a}=kg(),i=n.useMemo(()=>kb[t],[t]),o=n.useMemo(()=>()=>{const m=Math.random(),p=i;let h=0;return(h+=p.orange)>m&&p.orange>0?"orange":(h+=p.gold)>m?"gold":(h+=p.teal)>m?"teal":(h+=p.pink)>m?"pink":(h+=p.blue)>m?"blue":"white"},[i]),l=(m,p=0)=>{const h={white:[0,0,100],blue:[200,85,70],pink:[320,60,75],gold:[45,100,65],teal:[175,70,60],orange:[25,90,65]},[f,u,g]=h[m];return`hsl(${m==="white"?f:(f+p)%360}, ${u}%, ${g}%)`};return{period:t,progress:s,colors:r,rotationHue:a,starDistribution:i,getStarColorForPeriod:o,getStarHSL:l,getStarGlow:(m,p,h=0)=>{const f=l(m,h);return m==="white"?`0 0 6px hsla(0, 0%, 100%, ${p})`:`0 0 8px ${f.replace(")",` / ${p})`).replace("hsl","hsla")}, 0 0 16px ${f.replace(")",` / ${p*.5})`).replace("hsl","hsla")}`},getNebulaGradient:m=>{const p=`nebula${m}`;return r[p]}}},Yu=n.createContext({isTabActive:!0}),Sb=({isTabActive:t,children:s})=>e.jsx(Yu.Provider,{value:{isTabActive:t},children:s}),La=()=>n.useContext(Yu),pi=(t,s,r,a,i)=>Array.from({length:t},(o,l)=>({id:l,x:Math.random()*100,y:Math.random()*100,size:Math.random()*(r-s)+s,opacity:Math.random()*(i-a)+a,animationDelay:Math.random()*10,animationDuration:Math.random()*4+4,colorSeed:Math.random()})),Eb=t=>Array.from({length:t},(s,r)=>({id:r,x:Math.random()*100,y:Math.random()*100,size:Math.random()*.5+.5,opacity:Math.random()*.15+.1,driftDuration:Math.random()*60+60,driftDelay:Math.random()*30})),Tb=()=>[{id:1,delay:5,duration:90,startX:15,startY:10,angle:35},{id:2,delay:45,duration:120,startX:85,startY:8,angle:145},{id:3,delay:75,duration:150,startX:50,startY:5,angle:80}],Zs={deepNebulae:1,dust:2,backgroundStars:3,midNebulae:4,midStars:5,foregroundNebulae:6,brightStars:8},qa=n.memo(()=>{const{isTabActive:t}=La(),{capabilities:s,signals:r}=uo(),a=n.useRef(null),i=n.useRef(null),o=n.useRef({x:0,y:0});n.useRef(null);const l=n.useMemo(()=>{if(typeof window>"u")return!1;const F=window.Capacitor;return!!(F?.isNativePlatform?.()&&F?.getPlatform?.()==="ios")},[]),c=t&&s.allowBackgroundAnimation&&!r.isBackgrounded&&!r.prefersReducedMotion&&!l,d=t&&s.allowParallax&&!r.isBackgrounded&&!r.prefersReducedMotion&&!l,m=!c,{gamma:p,beta:h,permitted:f}=Nb({enabled:d}),{period:u,colors:g,rotationHue:y,starDistribution:b,getStarHSL:v,getStarGlow:x}=Cb(),{presence:w}=Rn();n.useEffect(()=>{},[s.maxParticles,t,c,d,m]);const j=n.useMemo(()=>{const{mood:F}=w;let H=0;switch(F){case"joyful":H=10;break;case"content":H=5;break;case"neutral":H=0;break;case"reserved":H=-5;break;case"quiet":H=-10;break;case"dormant":H=0;break}return H},[w]),D=n.useCallback((F,H)=>{o.current={x:F,y:H},i.current===null&&(i.current=requestAnimationFrame(()=>{i.current=null,a.current&&(a.current.style.setProperty("--parallax-x",String(o.current.x)),a.current.style.setProperty("--parallax-y",String(o.current.y)))}))},[]);n.useEffect(()=>{if(!d){D(0,0);return}const F=H=>{const J=(H.clientX/window.innerWidth-.5)*2,G=(H.clientY/window.innerHeight-.5)*2;D(J,G)};return window.addEventListener("mousemove",F,{passive:!0}),()=>window.removeEventListener("mousemove",F)},[D,d]),n.useEffect(()=>{if(!d||!f)return;const F=Math.max(-1,Math.min(1,p/30)),H=Math.max(-1,Math.min(1,(h-45)/30));D(F,H)},[h,p,f,D,d]),n.useEffect(()=>()=>{i.current!==null&&cancelAnimationFrame(i.current)},[]);const C=n.useCallback(F=>d?{transform:`translate(calc(var(--parallax-x, 0) * ${F}px), calc(var(--parallax-y, 0) * ${F}px))`,transition:"transform 0.22s ease-out",willChange:"transform"}:{},[d]),_=n.useCallback(F=>{const H=b;let J=0;return(J+=H.orange)>F&&H.orange>0?"orange":(J+=H.gold)>F?"gold":(J+=H.teal)>F?"teal":(J+=H.pink)>F?"pink":(J+=H.blue)>F?"blue":"white"},[b]),N=Math.max(4,s.maxParticles),E=n.useMemo(()=>t?m?{dust:2,background:6,mid:2,bright:1}:{dust:Math.max(8,Math.round(N*.55)),background:Math.max(12,Math.round(N*.6)),mid:Math.max(6,Math.round(N*.34)),bright:Math.max(3,Math.round(N*.2))}:{dust:0,background:4,mid:0,bright:0},[t,N,m]),k=n.useMemo(()=>Eb(E.dust),[E.dust]),P=n.useMemo(()=>pi(E.background,.8,1.5,.3,.5),[E.background]),T=n.useMemo(()=>pi(E.mid,1.5,2.5,.4,.7),[E.mid]),I=n.useMemo(()=>pi(E.bright,2.5,4,.7,1),[E.bright]),R=n.useMemo(()=>c?Tb():[],[c]),L=n.useMemo(()=>({dawn:"linear-gradient(to bottom, hsl(350, 30%, 12%), hsl(25, 25%, 10%), hsl(240, 15%, 8%))",morning:"linear-gradient(to bottom, hsl(200, 35%, 12%), hsl(190, 25%, 10%), hsl(240, 15%, 8%))",afternoon:"linear-gradient(to bottom, hsl(35, 30%, 12%), hsl(180, 20%, 10%), hsl(240, 15%, 8%))",sunset:"linear-gradient(to bottom, hsl(340, 35%, 15%), hsl(20, 30%, 12%), hsl(270, 25%, 10%))",night:"linear-gradient(to bottom, hsl(240, 30%, 10%), hsl(250, 20%, 8%), hsl(0, 0%, 5%))"})[u],[u]),$=y*.1+j,q=t?m?"lite":"full":"inactive";return e.jsxs("div",{ref:a,className:"fixed inset-0 overflow-hidden pointer-events-none -z-10","data-starfield-mode":q,children:[e.jsx("div",{className:"absolute inset-0 transition-all [transition-duration:3000ms]",style:{background:L}}),e.jsxs("div",{className:"absolute inset-0",style:C(Zs.deepNebulae),children:[e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:5000ms]",style:{top:m?"-8%":"-15%",right:m?"-6%":"-10%",width:m?"560px":"900px",height:m?"560px":"900px",filter:m?"blur(90px)":"blur(150px)",background:`radial-gradient(ellipse at center, ${g.nebula1.replace(")"," / 0.25)")}, transparent 70%)`,animation:c?"nebula-drift-slow 55s ease-in-out infinite":"none"}}),e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:5000ms]",style:{bottom:m?"-10%":"-20%",left:m?"-8%":"-15%",width:m?"500px":"800px",height:m?"500px":"800px",filter:m?"blur(80px)":"blur(140px)",background:`radial-gradient(ellipse at center, ${g.nebula2.replace(")"," / 0.2)")}, transparent 70%)`,animation:c?"nebula-drift-slow 65s ease-in-out infinite reverse":"none"}})]}),c&&k.length>0&&e.jsx("div",{className:"absolute inset-0",style:C(Zs.dust),children:k.map(F=>e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:3000ms]",style:{left:`${F.x}%`,top:`${F.y}%`,width:`${F.size}px`,height:`${F.size}px`,opacity:F.opacity,backgroundColor:`${g.nebula3.replace(")"," / 0.4)")}`}},`dust-${F.id}`))}),e.jsx("div",{className:"absolute inset-0",style:C(Zs.backgroundStars),children:P.map(F=>{const H=_(F.colorSeed);return e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:2000ms]",style:{left:`${F.x}%`,top:`${F.y}%`,width:`${F.size}px`,height:`${F.size}px`,opacity:F.opacity,backgroundColor:v(H,$),boxShadow:x(H,F.opacity*.5,$),animation:c?`twinkle ${F.animationDuration}s ease-in-out ${F.animationDelay}s infinite`:"none"}},`bg-star-${F.id}`)})}),c&&e.jsxs("div",{className:"absolute inset-0 opacity-30",style:C(Zs.midNebulae),children:[e.jsx("div",{className:"absolute w-[600px] h-[300px] blur-[100px] -rotate-12 transition-colors [transition-duration:5000ms]",style:{top:"10%",right:"5%",background:`linear-gradient(135deg, ${g.nebula1.replace(")"," / 0.35)")}, ${g.nebula3.replace(")"," / 0.15)")}, transparent)`}}),e.jsx("div",{className:"absolute w-[500px] h-[250px] blur-[90px] rotate-12 transition-colors [transition-duration:5000ms]",style:{bottom:"15%",left:"10%",background:`linear-gradient(135deg, ${g.nebula2.replace(")"," / 0.3)")}, ${g.accent.replace(")"," / 0.15)")}, transparent)`}})]}),c&&T.length>0&&e.jsx("div",{className:"absolute inset-0",style:C(Zs.midStars),children:T.map(F=>{const H=_(F.colorSeed);return e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:2000ms]",style:{left:`${F.x}%`,top:`${F.y}%`,width:`${F.size}px`,height:`${F.size}px`,opacity:F.opacity,backgroundColor:v(H,$),boxShadow:x(H,F.opacity,$)}},`mid-star-${F.id}`)})}),c&&e.jsxs("div",{className:"absolute inset-0 opacity-25",style:C(Zs.foregroundNebulae),children:[e.jsx("div",{className:"absolute w-[350px] h-[350px] rounded-full blur-[70px] transition-colors [transition-duration:5000ms]",style:{top:"25%",right:"20%",background:`radial-gradient(ellipse at center, ${g.primary.replace(")"," / 0.5)")}, transparent 60%)`,animation:"nebula-pulse 25s ease-in-out infinite"}}),e.jsx("div",{className:"absolute w-[300px] h-[300px] rounded-full blur-[60px] transition-colors [transition-duration:5000ms]",style:{bottom:"30%",left:"25%",background:`radial-gradient(ellipse at center, ${g.accent.replace(")"," / 0.45)")}, transparent 60%)`,animation:"nebula-pulse 30s ease-in-out 8s infinite reverse"}})]}),e.jsx("div",{className:"absolute inset-0",style:C(Zs.brightStars),children:I.map(F=>{const H=_(F.colorSeed),J=v(H,$);return e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:2000ms]",style:{left:`${F.x}%`,top:`${F.y}%`,width:`${F.size}px`,height:`${F.size}px`,backgroundColor:J,boxShadow:`${x(H,1,$)}, 0 0 20px ${J}`}},`bright-star-${F.id}`)})}),c&&R.map(F=>e.jsx("div",{className:"absolute w-[3px] h-[3px] rounded-full",style:{left:`${F.startX}%`,top:`${F.startY}%`,background:"linear-gradient(to right, transparent, white, white)",boxShadow:"0 0 6px 2px rgba(255, 255, 255, 0.9), -20px 0 15px rgba(255, 255, 255, 0.4), -40px 0 25px rgba(255, 255, 255, 0.2)",animation:`shooting-star-${F.id} ${F.duration}s ease-out ${F.delay}s infinite`}},`shooting-${F.id}`))]})});qa.displayName="StarfieldBackground";const hi=2,Mb=1500,Db=750,br=new Map,zt=oe.scope("MentorConnectionHealth"),Pb=async t=>new Promise(s=>{window.setTimeout(s,t)});function Ab(){const{user:t}=be(),{profile:s,loading:r}=Yt(),a=Ae(),i=n.useRef(!1),o=n.useMemo(()=>Br(s),[s]),l=t?.id?br.get(t.id)??null:null,[c,d]=n.useState(o??l),[m,p]=n.useState(o?"ready":r?"recovering":"missing"),h=n.useCallback(async()=>{await Promise.all([a.invalidateQueries({queryKey:["mentor-page-data"]}),a.invalidateQueries({queryKey:["mentor-personality"]}),a.invalidateQueries({queryKey:["mentor"]}),a.invalidateQueries({queryKey:["selected-mentor"]})])},[a]),f=n.useCallback(async(v,x)=>{const w=nx(x?.onboarding_data),{error:j}=await S.from("profiles").update({onboarding_data:w}).eq("id",v);if(j){zt.warn("Failed to clear stale onboarding mentor ID",{userId:v,error:j});return}zt.warn("Cleared stale onboarding mentor ID",{userId:v}),await a.refetchQueries({queryKey:["profile",v]})},[a]),u=n.useCallback(async v=>{const{data:x,error:w}=await S.from("mentors").select("id").eq("id",v).maybeSingle();if(w)throw w;return x?.id??null},[]),g=n.useCallback(async(v,x,w)=>{const{error:j}=await S.from("profiles").update({selected_mentor_id:x}).eq("id",v);if(j){if(ix(j))return zt.warn("Invalid mentor reference while backfilling, stripping onboarding mentor",{userId:v,mentorId:x,error:j}),await f(v,w),null;throw j}return await a.refetchQueries({queryKey:["profile",v]}),await h(),x},[h,a,f]),y=n.useCallback(async()=>{if(!t?.id){d(null),p("missing");return}if(i.current)return;i.current=!0,p("recovering"),d(br.get(t.id)??null);const v=performance.now();let x=null,w="profile_missing",j=0;zt.info("Starting mentor connection recovery",{userId:t.id,attempts:hi});try{for(let C=0;C<hi;C+=1){const _=C+1;if(j=_,typeof navigator<"u"&&!navigator.onLine){w="offline",zt.warn("Recovery paused while offline",{userId:t.id,attempt:_});break}await a.refetchQueries({queryKey:["profile",t.id]});const{data:N,error:E}=await S.from("profiles").select("selected_mentor_id, onboarding_completed, onboarding_data").eq("id",t.id).maybeSingle();if(E)w="profile_missing",zt.warn("Profile fetch failed during mentor recovery",{userId:t.id,attempt:_,error:E});else if(!N)w="profile_missing",zt.warn("Profile missing during mentor recovery",{userId:t.id,attempt:_});else if(N.selected_mentor_id){x=N.selected_mentor_id,w="profile_selected_mentor";break}else{const P=cu(N);if(!P)w="profile_missing",zt.warn("No onboarding mentor available during recovery",{userId:t.id,attempt:_});else{const T=await u(P);if(!T)w="mentor_lookup_empty",zt.warn("Onboarding mentor lookup returned empty result",{userId:t.id,attempt:_,mentorId:P}),await f(t.id,N),w="invalid_onboarding_mentor";else if(x=await g(t.id,T,N),w=x?"backfilled_from_onboarding":"invalid_onboarding_mentor",x)break}}if(performance.now()-v>=Mb||C>=hi-1)break;await Pb(Db)}}catch(C){w="recovery_error",zt.warn("Mentor recovery attempt failed",{userId:t.id,cause:w,error:C instanceof Error?C.message:String(C)})}finally{i.current=!1}if(x){br.set(t.id,x),d(x),p("ready"),zt.info("Mentor connection recovery completed",{userId:t.id,attemptsUsed:j,cause:w,recoveredMentorId:x});return}const D=br.get(t.id)??null;if(w==="offline"){d(D),p("recovering"),zt.warn("Mentor recovery still pending (offline)",{userId:t.id,attemptsUsed:j});return}d(D),p("missing"),zt.warn("Mentor connection recovery failed",{userId:t.id,attemptsUsed:j,cause:w})},[g,a,f,t?.id,u]),b=n.useCallback(async()=>{await y()},[y]);return n.useEffect(()=>{if(!t?.id){d(null),p("missing");return}if(o){br.set(t.id,o),d(o),p("ready");return}const v=br.get(t.id)??null;if(r){d(v),p("recovering");return}y()},[y,r,o,t?.id]),n.useEffect(()=>{if(!t?.id)return;const v=()=>{m!=="ready"&&y()};return window.addEventListener("online",v),()=>window.removeEventListener("online",v)},[y,m,t?.id]),{effectiveMentorId:c,status:m,refreshConnection:b}}const Rb=({enableOnboardingGuard:t=!1})=>{const{user:s}=be(),{isTabActive:r}=La(),{profile:a,loading:i}=Yt(),{companion:o,isLoading:l}=Tt(),{isTransitioning:c}=xg(),d=as(),m=Ae();n.useEffect(()=>{window.scrollTo(0,0)},[]);const{effectiveMentorId:p,status:h,refreshConnection:f}=Ab(),{data:u,isLoading:g,isError:y}=Ee({queryKey:["mentor-page-data",p],queryFn:async()=>{if(!p)return null;const{data:C,error:_}=await S.from("mentors").select("avatar_url, slug").eq("id",p).maybeSingle();if(_)throw _;if(!C)return null;const N=C.avatar_url||await po(C.slug||"atlas"),E=new Date().toLocaleDateString("en-CA"),{data:k,error:P}=await S.from("daily_pep_talks").select("topic_category").eq("for_date",E).eq("mentor_slug",C.slug).maybeSingle();if(P)throw P;let T=null;if(k?.topic_category){const{data:I,error:R}=await S.from("quotes").select("text, author").eq("category",k.topic_category).limit(10);if(R)throw R;let L=I;if(!L||L.length===0){const{data:$,error:q}=await S.from("quotes").select("text, author").limit(20);if(q)throw q;L=$}L&&L.length>0&&(T=L[Math.floor(Math.random()*L.length)])}return{mentorImage:N,todaysQuote:T}},enabled:r&&!!p,staleTime:300*1e3,placeholderData:C=>C}),b=u?.mentorImage||"",v=u?.todaysQuote||null,x=n.useMemo(()=>s?!i&&!l&&(!!!p||!!u||!g):!1,[s,i,l,p,u,g]),w=!t&&h==="missing",j=!t&&!!p&&!g&&!u&&y,D=n.useCallback(C=>{switch(C.actionType){default:d("/journeys")}},[d]);return n.useEffect(()=>{if(!t||!s||!x||!a||a.onboarding_completed===!0)return;const C=!p,_=a.onboarding_completed===!1;(C||_||!o&&!l)&&d("/onboarding")},[t,s,x,a,o,l,d,p]),c||!x?e.jsx(Xy,{}):!i&&!l&&!a?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background p-4",children:e.jsxs("div",{className:"text-center space-y-4 max-w-md",children:[e.jsx("div",{className:"h-12 w-12 mx-auto rounded-full bg-destructive/10 flex items-center justify-center",children:e.jsx("span",{className:"text-2xl",children:"âš ï¸"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Unable to Load Profile"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"We couldn't load your profile data. Please check your connection and try again."}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90",children:"Retry"})]})]})}):e.jsxs(Ia,{mode:t?"animated":"instant",children:[e.jsx(qa,{}),b&&e.jsxs("div",{className:"fixed inset-0 z-0 pointer-events-none",children:[e.jsx("img",{src:b,alt:"Mentor background",className:"w-full h-full object-cover object-center",loading:"eager",decoding:"async"}),e.jsx("div",{className:"absolute inset-0 bg-background/85"})]}),e.jsx("div",{className:"relative z-10 min-h-screen pb-nav-safe pt-safe",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-3 sm:px-4 pt-28 sm:pt-24 md:pt-20 space-y-4 sm:space-y-6 md:space-y-8",children:[j&&e.jsx("div",{className:"mx-4 sm:mx-6 rounded-2xl border border-destructive/45 bg-card/40 backdrop-blur-2xl p-4 sm:p-5 shadow-[0_8px_30px_rgba(0,0,0,0.18)]",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-base sm:text-lg font-bold",children:"Mentor temporarily unavailable"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"We could not refresh your mentor data right now. Try again in a moment."})]}),e.jsx(U,{onClick:()=>{f(),m.refetchQueries({queryKey:["mentor-page-data"]}),m.refetchQueries({queryKey:["mentor-personality"]})},className:"sm:self-start",variant:"outline",children:"Retry"})]})}),w&&e.jsx("div",{className:"mx-4 sm:mx-6 rounded-2xl border border-primary/35 bg-card/40 backdrop-blur-2xl p-4 sm:p-5 shadow-[0_8px_30px_rgba(0,0,0,0.18)]",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-base sm:text-lg font-bold",children:"Mentor connection lost"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Reconnect a mentor to restore personalized briefings, pep talks, and chat."})]}),e.jsx(U,{onClick:()=>d("/mentor-selection"),className:"sm:self-start",children:"Reconnect Mentor"})]})}),v&&e.jsx("div",{className:"text-right px-4 sm:px-6",children:e.jsxs("blockquote",{className:"max-w-2xl ml-auto",children:[e.jsxs("p",{className:"font-serif italic text-lg sm:text-xl md:text-2xl text-foreground/90 leading-relaxed",children:['"',v.text,'"']}),v.author&&e.jsxs("footer",{className:"mt-2 font-serif italic text-sm sm:text-base text-muted-foreground",children:["â€” ",v.author]})]})}),e.jsx(cs,{offset:14,children:e.jsx(es,{children:e.jsx(Bu,{})})}),e.jsx(cs,{offset:12,children:e.jsx(es,{children:e.jsx(Uu,{})})}),e.jsx(cs,{offset:10,children:e.jsx(es,{children:e.jsx(Wu,{})})}),e.jsx(cs,{offset:10,children:e.jsx(es,{children:e.jsx(Gu,{})})}),e.jsx(cs,{offset:9,children:e.jsx(es,{children:e.jsx(jb,{maxInsights:3,onInsightAction:D})})}),e.jsx(cs,{offset:8,children:e.jsx(es,{children:e.jsx(Hu,{})})}),e.jsx(cs,{offset:8,children:e.jsx(Fu,{children:e.jsx(es,{children:e.jsx("div",{className:"cosmiq-glass-ultra rounded-2xl",children:e.jsx(Ou,{})})})})})]})}),e.jsx(es,{})]})},Ib=()=>e.jsx(Rb,{enableOnboardingGuard:!1}),Lb=()=>{const{user:t}=be(),s=Ae(),{data:r,isLoading:a}=Ee({queryKey:["referral-stats",t?.id],staleTime:300*1e3,queryFn:async()=>{if(!t)return null;const{data:m,error:p}=await S.from("profiles").select("referral_code, referral_count, referred_by_code").eq("id",t.id).maybeSingle();if(p)throw p;return m?{referral_code:m.referral_code||null,referral_count:m.referral_count||0,referred_by:m.referred_by_code}:null},enabled:!!t}),{data:i}=Ee({queryKey:["unlocked-skins",t?.id],staleTime:300*1e3,queryFn:async()=>{if(!t)return[];const{data:m,error:p}=await S.from("user_companion_skins").select(`
          *,
          companion_skins (*)
        `).eq("user_id",t.id).order("acquired_at",{ascending:!1}).limit(100);if(p)throw p;return m},enabled:!!t}),{data:o}=Ee({queryKey:["available-skins"],staleTime:600*1e3,queryFn:async()=>{const{data:m,error:p}=await S.from("companion_skins").select("*").eq("unlock_type","referral").order("unlock_requirement",{ascending:!0}).limit(100);if(p)throw p;return m}}),l=le({mutationFn:async m=>{if(!t)throw new Error("User not authenticated");const p=m.trim().toUpperCase(),{data:h,error:f}=await S.rpc("apply_referral_code_secure",{p_user_id:t.id,p_referral_code:p});if(f)throw new Error("Unable to apply referral code. Please try again.");const u=h?.[0]||h;if(!u?.success)throw new Error(u?.message||"Failed to apply referral code");return{success:!0}},onSuccess:()=>{s.invalidateQueries({queryKey:["referral-stats"]}),W.success("Referral code applied! Your friend will earn rewards when you reach Stage 3.")},onError:m=>{W.error(m.message)}}),c=le({mutationFn:async m=>{if(!t)throw new Error("User not authenticated");const{data:p,error:h}=await S.from("user_companion_skins").select("id").eq("user_id",t.id).eq("skin_id",m).maybeSingle();if(h)throw h;if(!p)throw new Error("You don't own this skin");await S.from("user_companion_skins").update({is_equipped:!1}).eq("user_id",t.id);const{error:f}=await S.from("user_companion_skins").update({is_equipped:!0}).eq("user_id",t.id).eq("skin_id",m);if(f)throw f},onSuccess:()=>{s.invalidateQueries({queryKey:["unlocked-skins"]}),W.success("Skin equipped!")}}),d=le({mutationFn:async()=>{if(!t)throw new Error("User not authenticated");const{error:m}=await S.from("user_companion_skins").update({is_equipped:!1}).eq("user_id",t.id).eq("is_equipped",!0);if(m)throw m},onSuccess:()=>{s.invalidateQueries({queryKey:["unlocked-skins"]}),W.success("Skin unequipped")}});return{referralStats:r,unlockedSkins:i,availableSkins:o,isLoading:a,applyReferralCode:l,equipSkin:c,unequipSkin:d}},Vu=()=>{const{user:t}=be(),{companion:s}=Tt(),r=Ae(),{data:a,isLoading:i}=Ee({queryKey:["companion-health",t?.id],queryFn:async()=>{if(!t?.id)return null;const{data:u,error:g}=await S.from("user_companion").select("inactive_days, last_activity_date, neglected_image_url, current_mood, body, mind, soul, current_image_url, is_alive, hunger, happiness, care_score, recovery_progress").eq("user_id",t.id).maybeSingle();if(g)throw console.error("Failed to fetch companion health:",g),g;return u},enabled:!!t?.id,staleTime:6e4}),{data:o,isLoading:l}=Ee({queryKey:["streak-freezes",t?.id],queryFn:async()=>{if(!t?.id)return null;const{data:u,error:g}=await S.from("profiles").select("streak_freezes_available, last_streak_freeze_used, streak_freezes_reset_at").eq("id",t.id).maybeSingle();if(g)throw console.error("Failed to fetch streak freeze data:",g),g;return u},enabled:!!t?.id,staleTime:6e4}),c=u=>u===0?"happy":u===1?"neutral":u===2?"worried":u>=3&&u<5?"sad":u>=5?"sick":"happy",d=n.useMemo(()=>{const u=a?.body??100,g=a?.mind??0,y=a?.soul??0,b=a?.inactive_days??0,v=a?.is_alive??!0,x=a?.hunger??100,w=a?.happiness??100,j=a?.care_score??100,D=a?.recovery_progress??100,C=Math.round((u+g+y)/3),_=c(b),N=b>=3,E=D<100,k=b>=5,T=N&&a?.neglected_image_url?a.neglected_image_url:a?.current_image_url||s?.current_image_url||null;return{healthPercentage:C,moodState:_,isNeglected:N,daysInactive:b,imageUrl:T,neglectedImageUrl:a?.neglected_image_url||null,body:u,mind:g,soul:y,lastActivityDate:a?.last_activity_date||null,isAlive:v,hunger:x,happiness:w,careScore:j,recoveryProgress:D,isRecovering:E,isCritical:k}},[a,s]),m=n.useMemo(()=>{const u=o?.streak_freezes_reset_at;let g=7;if(u){const y=new Date(u),b=new Date,v=y.getTime()-b.getTime();g=Math.max(0,Math.ceil(v/(1e3*60*60*24)))}return{streakFreezesAvailable:o?.streak_freezes_available??1,lastStreakFreezeUsed:o?.last_streak_freeze_used||null,streakFreezesResetAt:u||null,daysUntilReset:g}},[o]),p=async()=>{if(t?.id)try{const u=new Date().toISOString().split("T")[0];await S.from("user_companion").update({last_activity_date:u,inactive_days:0,current_mood:"happy"}).eq("user_id",t.id),r.invalidateQueries({queryKey:["companion-health"]}),r.invalidateQueries({queryKey:["companion"]})}catch(u){console.error("Failed to mark user active:",u)}},h=d.daysInactive>=2;return{health:d,streakFreeze:m,isLoading:i||l,markUserActive:p,needsWelcomeBack:h,getMoodFilterStyles:u=>{switch(u){case"happy":case"content":return{};case"neutral":return{filter:"saturate(0.9) brightness(0.95)"};case"worried":return{filter:"saturate(0.7) brightness(0.9)"};case"sad":return{filter:"saturate(0.5) brightness(0.85)"};case"sick":return{filter:"saturate(0.3) brightness(0.7) sepia(0.2)"};default:return{}}}}},qb=(t,s,r,a,i)=>{const{care:o}=An(),l=n.useMemo(()=>{if(!a)return{filter:"grayscale(1) brightness(0.5)",animation:"none",animationDuration:"0s",opacity:.7,saturation:0,posture:"curled",eyeContact:"closed"};if(o.dormancy.isDormant)return{filter:"grayscale(0.5) brightness(0.6) blur(0.5px)",animation:"dormant-breathe",animationDuration:"6s",opacity:.75,saturation:.5,posture:"sleeping",eyeContact:"closed"};if(o.dormancy.recoveryDays>0&&o.dormancy.recoveryDays<5){const p=o.dormancy.recoveryDays/5;return{filter:`saturate(${.5+p*.5}) brightness(${.8+p*.2})`,animation:"pulse",animationDuration:"4s",opacity:.8+p*.2,saturation:.5+p*.5,posture:p>.5?"neutral":"withdrawn",eyeContact:p>.5?"occasional":"averted"}}if(o.dormancy.daysUntilDormancy!==null){const h=o.dormancy.daysUntilDormancy===1?.6:.3;return{filter:`saturate(${.7-h*.2}) brightness(${.85-h*.1}) sepia(${h*.15})`,animation:"droop",animationDuration:"5s",opacity:.9-h*.1,saturation:.7-h*.2,posture:"withdrawn",eyeContact:"averted"}}const m=o.overallCare;return m>.8?{filter:"saturate(1.25) brightness(1.1)",animation:"bounce",animationDuration:"2s",opacity:1,saturation:1.25,posture:"confident",eyeContact:"direct"}:m>.6?{filter:"saturate(1.1) brightness(1.05)",animation:"pulse",animationDuration:"3s",opacity:1,saturation:1.1,posture:"relaxed",eyeContact:"friendly"}:m>.4?{filter:"saturate(0.95) brightness(0.98)",animation:"pulse",animationDuration:"5s",opacity:.95,saturation:.95,posture:"neutral",eyeContact:"occasional"}:m>.2?{filter:"saturate(0.75) brightness(0.88) sepia(0.08)",animation:"droop",animationDuration:"4s",opacity:.88,saturation:.75,posture:"withdrawn",eyeContact:"averted"}:{filter:"saturate(0.5) brightness(0.75) sepia(0.15)",animation:"shiver",animationDuration:"0.4s",opacity:.75,saturation:.5,posture:"curled",eyeContact:"none"}},[o,a]),c=n.useMemo(()=>({filter:l.filter,opacity:l.opacity,transition:"filter 0.8s ease, opacity 0.8s ease"}),[l]),d=n.useMemo(()=>{if(l.animation==="none")return"";switch(l.animation){case"bounce":return"animate-companion-bounce";case"pulse":return"animate-companion-pulse";case"shiver":return"animate-companion-shiver";case"droop":return"animate-companion-droop";case"dormant-breathe":return"animate-companion-dormant";default:return""}},[l.animation]);return{visualState:l,cssStyles:c,animationClass:d,care:o,overallCare:o.overallCare,evolutionPath:o.evolutionPath,dialogueTone:o.dialogueTone,isDormant:o.dormancy.isDormant,hasDormancyWarning:o.hasDormancyWarning,bondLevel:o.bond.level}},fi=2,Ob=()=>{const{user:t}=be(),s=Ae(),[r,a]=n.useState(!1),[i,o]=n.useState("starting"),[l,c]=n.useState(0),d=le({mutationFn:async p=>{if(!t)throw new Error("Not authenticated");o("starting"),c(0);const{data:h,error:f}=await S.from("user_companion").select("image_regenerations_used").eq("id",p.id).eq("user_id",t.id).maybeSingle();if(f)throw console.error("Failed to verify regeneration count:",f),new Error("Unable to verify look refresh status. Please try again.");const u=h?.image_regenerations_used??0;if(u>=fi)throw new Error("You've used all your look refreshes");o("generating");const{imageUrl:g,validationPassed:y,retryCount:b}=await xu({favoriteColor:p.favorite_color,spiritAnimal:p.spirit_animal,element:p.core_element,stage:p.current_stage,eyeColor:p.eye_color,furColor:p.fur_color,flowType:"regenerate"},{maxRetries:1,onRetry:j=>{o("retrying"),c(j)},onValidating:()=>{o("validating")}});c(b),o("finalizing");const{data:v,error:x}=await S.from("user_companion").update({current_image_url:g,image_regenerations_used:u+1}).eq("id",p.id).eq("user_id",t.id).eq("image_regenerations_used",u).select("image_regenerations_used").single();if(x)throw x?.code==="PGRST116"?new Error("Look refresh already used. Please refresh to continue."):x;const w=v?.image_regenerations_used??u+1;return o(y?"complete":"warning"),{imageUrl:g,regenerationsRemaining:Math.max(0,fi-w),validationPassed:y,retryCount:l}},onSuccess:p=>{s.invalidateQueries({queryKey:["companion"]}),p.validationPassed?W.success(`New look unlocked! ${p.regenerationsRemaining} look refresh${p.regenerationsRemaining===1?"":"es"} remaining.`):W.success(`Companion created! ${p.regenerationsRemaining} look refresh${p.regenerationsRemaining===1?"":"es"} remaining. You can refresh the look again if needed.`),setTimeout(()=>a(!1),1500)},onError:p=>{console.error("Regeneration failed:",p),o("starting"),W.error(p instanceof Error?p.message:"Failed to refresh companion look")}}),m=()=>{o("starting"),c(0)};return{regenerate:d.mutate,isRegenerating:d.isPending,showConfirmDialog:r,setShowConfirmDialog:a,maxRegenerations:fi,generationPhase:i,retryCount:l,resetProgress:m}},Fb="companion_wake_up_seen";function $b(){const{user:t}=be(),{companion:s}=Tt(),{care:r,isLoading:a}=An(),[i,o]=n.useState(!1),l=n.useRef(null),c=n.useRef(!1),d=n.useRef(!1),m=n.useCallback(()=>s?.id?`${Fb}_${s.id}`:null,[s?.id]),p=n.useCallback(()=>{const u=m();u&&localStorage.setItem(u,Date.now().toString())},[m]),h=n.useCallback(()=>{const u=m();if(!u)return!1;const g=localStorage.getItem(u);if(!g)return!1;const y=parseInt(g,10);return(Date.now()-y)/(1e3*60*60)<24},[m]);n.useEffect(()=>{if(a||!r)return;const u=r.dormancy.isDormant;if(!c.current){l.current=u,c.current=!0;return}if(l.current===!0&&u===!1&&!h()&&(o(!0),p(),!d.current&&t?.id&&s?.id)){d.current=!0;const g=new Date().toISOString().split("T")[0];S.from("companion_memories").insert({user_id:t.id,companion_id:s.id,memory_type:"recovery",memory_date:g,memory_context:{title:"Awakening",description:"You came back and brought me out of the darkness. I will never forget.",emotion:"relief"},referenced_count:0}).then(({error:y})=>{y&&console.error("[WakeUp] Failed to create recovery memory:",y)})}l.current=u},[r,a,h,p,t?.id,s?.id]);const f=n.useCallback(()=>{o(!1),d.current=!1},[]);return{showCelebration:i,dismissCelebration:f,companionName:s?.spirit_animal||"companion",companionImageUrl:s?.current_image_url||"",dormantImageUrl:s?.dormant_image_url||null,bondLevel:r?.bond?.level||1}}const bl={treasure_hunt:{achievementType:"story_treasure_hunt_complete",title:"Fortune Seeker",description:"Completed a Treasure Hunt epic",icon:"ðŸ’Ž",tier:"gold"},mystery:{achievementType:"story_mystery_complete",title:"Truth Unveiler",description:"Completed a Mystery epic",icon:"ðŸ”®",tier:"gold"},pilgrimage:{achievementType:"story_pilgrimage_complete",title:"Soul Pilgrim",description:"Completed a Pilgrimage epic",icon:"ðŸ§˜",tier:"gold"},heroes_journey:{achievementType:"story_heroes_journey_complete",title:"Legendary Hero",description:"Completed a Heroes Journey epic",icon:"âš”ï¸",tier:"platinum"},rescue_mission:{achievementType:"story_rescue_mission_complete",title:"Cosmic Savior",description:"Completed a Rescue Mission epic",icon:"ðŸ›¡ï¸",tier:"gold"},exploration:{achievementType:"story_exploration_complete",title:"Star Cartographer",description:"Completed an Exploration epic",icon:"ðŸŒŒ",tier:"gold"}},Hb={common:{label:"Common",color:"hsl(220, 10%, 60%)",glowClass:"shadow-gray-500/30",bgClass:"from-gray-400/20 to-gray-600/20"},rare:{label:"Rare",color:"hsl(210, 80%, 60%)",glowClass:"shadow-blue-500/40",bgClass:"from-blue-400/20 to-blue-600/20"},epic:{label:"Epic",color:"hsl(280, 70%, 60%)",glowClass:"shadow-purple-500/50",bgClass:"from-purple-400/20 to-purple-600/20"},legendary:{label:"Legendary",color:"hsl(45, 90%, 55%)",glowClass:"shadow-yellow-500/60",bgClass:"from-yellow-400/30 to-orange-500/30"}},Xu=()=>{const{user:t}=be(),s=Ae(),{data:r=[]}=Ee({queryKey:["epic-rewards"],queryFn:async()=>{const{data:m,error:p}=await S.from("epic_rewards").select("*").order("rarity",{ascending:!0});if(p)throw p;return m},staleTime:1e3*60*60}),{data:a=[],isLoading:i}=Ee({queryKey:["user-epic-rewards",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:m,error:p}=await S.from("user_epic_rewards").select("*, epic_rewards(*)").eq("user_id",t.id).order("unlocked_at",{ascending:!1});if(p)throw p;return m},enabled:!!t?.id}),o={background:a.find(m=>m.is_equipped&&m.epic_rewards?.reward_type==="background")||null,frame:a.find(m=>m.is_equipped&&m.epic_rewards?.reward_type==="frame")||null,effect:a.find(m=>m.is_equipped&&m.epic_rewards?.reward_type==="effect")||null},l=le({mutationFn:async({rewardId:m,equip:p})=>{if(!t?.id)throw new Error("Not authenticated");const h=a.find(g=>g.reward_id===m);if(!h)throw new Error("Reward not found");const f=h.epic_rewards?.reward_type;p&&f&&await S.from("user_epic_rewards").update({is_equipped:!1}).eq("user_id",t.id).eq("is_equipped",!0).in("reward_id",r.filter(g=>g.reward_type===f).map(g=>g.id));const{error:u}=await S.from("user_epic_rewards").update({is_equipped:p}).eq("id",h.id);if(u)throw u},onSuccess:()=>{s.invalidateQueries({queryKey:["user-epic-rewards"]})},onError:m=>{console.error("Failed to equip reward:",m),W.error("Failed to update equipped item")}}),c=async(m,p)=>{if(!t?.id)return{reward:null,isDuplicate:!1};const h=r.filter(b=>b.story_type_slug===null||b.story_type_slug===m);if(h.length===0)return{reward:null,isDuplicate:!1};const f=new Set(a.map(b=>b.reward_id));let u=null,g=0;const y=3;for(;g<y&&(u=Bb(h),!(!u||!f.has(u.id)));)g++;if(u&&f.has(u.id)){const b=Ub(u.rarity);return{reward:u,isDuplicate:!0,bonusXP:b}}if(u){const{error:b}=await S.from("user_epic_rewards").insert({user_id:t.id,reward_id:u.id,epic_id:p});if(b)return console.error("Failed to award reward:",b),{reward:null,isDuplicate:!1};s.invalidateQueries({queryKey:["user-epic-rewards"]})}return{reward:u,isDuplicate:!1}},d=async(m,p)=>{const f=bl[m||"treasure_hunt"]||bl.treasure_hunt,{reward:u,isDuplicate:g,bonusXP:y}=await c(m,p);return{badge:{title:f.title,description:f.description,icon:f.icon,tier:f.tier},loot:u,isDuplicate:g,bonusXP:y}};return{allRewards:r,userRewards:a,equippedRewards:o,isLoading:i,equipReward:l.mutate,isEquipping:l.isPending,rollLootReward:c,generateRewardReveal:d}};function Bb(t){if(t.length===0)return null;const s=t.reduce((a,i)=>a+i.drop_weight,0);let r=Math.random()*s;for(const a of t)if(r-=a.drop_weight,r<=0)return a;return t[t.length-1]}function Ub(t){switch(t){case"common":return 25;case"rare":return 50;case"epic":return 100;case"legendary":return 200;default:return 25}}const zb=()=>e.jsxs(We,{className:"relative overflow-hidden shadow-glow-lg border-primary/40 animate-pulse bg-gradient-to-br from-card via-card to-secondary/50",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/5 via-accent/5 to-primary/10 opacity-60"}),e.jsxs("div",{className:"relative p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{className:"h-8 w-40"}),e.jsx(je,{className:"h-4 w-24"})]}),e.jsx(je,{className:"h-10 w-10 rounded-full"})]}),e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(je,{className:"h-64 w-64 rounded-2xl"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{className:"h-4 w-16"}),e.jsx(je,{className:"h-6 w-24"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{className:"h-4 w-16"}),e.jsx(je,{className:"h-6 w-24"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{className:"h-4 w-16"}),e.jsx(je,{className:"h-6 w-24"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(je,{className:"h-4 w-16"}),e.jsx(je,{className:"h-6 w-24"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(je,{className:"h-4 w-32"}),e.jsx(je,{className:"h-4 w-20"})]}),e.jsx(je,{className:"h-3 w-full rounded-full"})]})]})]}),Ds=Oh,Ps=Fh,ys=n.forwardRef(({className:t,align:s="center",sideOffset:r=4,...a},i)=>e.jsx(qh,{children:e.jsx(ed,{ref:i,align:s,sideOffset:r,className:A("z-[60] w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...a})}));ys.displayName=ed.displayName;const Qb={"Spirit Animal":"Your companion's spirit represents your inner strength and personality. It influences how your companion appears as it evolves.",Element:"The elemental force that powers your companion's growth. Each element brings unique visual themes to your companion's evolution.","Favorite Color":"The primary color that defines your companion's appearance and energy. This was chosen based on your personal preferences.",Stage:"Your companion's current evolution stage. There are 21 stages total, from Egg to Ultimate. Earn XP to unlock the next stage!","XP Progress":"Experience points earned through completing habits, missions, and challenges. Fill the bar to trigger your companion's next evolution!"},Kb=({title:t,description:s})=>{const r=Qb[t]||s;return e.jsxs(Ds,{children:[e.jsx(Ps,{asChild:!0,children:e.jsx("button",{type:"button",className:"inline-flex items-center justify-center ml-1.5 opacity-60 hover:opacity-100 transition-opacity touch-manipulation active:scale-95","aria-label":`More information about ${t}`,children:e.jsx(td,{className:"h-4 w-4"})})}),e.jsx(ys,{className:"w-80 cosmiq-glass border-primary/30 shadow-xl",side:"top",sideOffset:8,children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-semibold text-sm text-primary",children:t}),e.jsx("p",{className:"text-sm leading-relaxed text-foreground/90",children:r})]})})]})},Wb={fire:Gt,water:Bh,earth:Ta,air:Hh,light:St,nature:$h,energy:ft,spirit:pe},vl={fire:"bg-gradient-to-r from-orange-500/20 to-red-500/20 text-orange-300 border-orange-500/30",water:"bg-gradient-to-r from-blue-500/20 to-cyan-500/20 text-blue-300 border-blue-500/30",earth:"bg-gradient-to-r from-amber-600/20 to-yellow-700/20 text-amber-300 border-amber-600/30",air:"bg-gradient-to-r from-sky-400/20 to-indigo-400/20 text-sky-300 border-sky-400/30",light:"bg-gradient-to-r from-yellow-300/20 to-amber-300/20 text-yellow-200 border-yellow-300/30",nature:"bg-gradient-to-r from-green-500/20 to-emerald-500/20 text-green-300 border-green-500/30",energy:"bg-gradient-to-r from-purple-500/20 to-pink-500/20 text-purple-300 border-purple-500/30",spirit:"bg-gradient-to-r from-indigo-500/20 to-violet-500/20 text-indigo-300 border-indigo-500/30"},Gb=({element:t,stage:s=1,showStage:r=!0,className:a=""})=>{const i=Wb[t.toLowerCase()]||pe,o=vl[t.toLowerCase()]||vl.spirit,l=Ln(s),c=()=>s>=16?"bg-gradient-to-r from-stage-tier-4-start/10 via-stage-tier-4-mid/10 to-stage-tier-4-end/10":s>=11?"bg-gradient-to-r from-stage-tier-3/10":s>=6?"bg-gradient-to-r from-stage-tier-2/10":"";return e.jsxs(Fe,{variant:"outline",className:`px-3 py-1 ${o} ${c()} ${a} flex items-center gap-2`,children:[e.jsx(i,{className:"h-3 w-3"}),e.jsx("span",{className:"text-xs font-semibold",children:hs(t)}),r&&s!==void 0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-xs opacity-50",children:"â€¢"}),e.jsx("span",{className:"text-xs font-medium",children:l})]})]})},Ja=[{level:1,name:"Acquaintance",description:"A new journey begins...",icon:"ðŸŒ±"},{level:2,name:"Companion",description:"Trust is forming between you.",icon:"ðŸ¤"},{level:3,name:"Friend",description:"Your bond grows stronger each day.",icon:"ðŸ’«"},{level:4,name:"Close Friend",description:"A deep understanding develops.",icon:"âœ¨"},{level:5,name:"Soul Bond",description:"An unbreakable connection.",icon:"ðŸ’Ž"},{level:6,name:"Eternal Partner",description:"Together through all realms.",icon:"ðŸŒŸ"},{level:7,name:"Legendary Bond",description:"A bond that transcends time.",icon:"ðŸ‘‘"}],wl={joy:["That was such a happy day!","I still feel warm thinking about it.","One of our best moments!"],pride:["You worked so hard for that.","I was so proud of you!","Look how far we've come."],gratitude:["Thank you for that moment.","I treasure that memory.","You've given me so much."],wonder:["That was magical!","I still can't believe it happened.","What an adventure!"],relief:["We made it through together.","I'm so glad you came back.","Everything is okay now."]},Yb=t=>{let s=0;for(let r=0;r<t.length;r++)s=(s<<5)-s+t.charCodeAt(r),s|=0;return Math.abs(s%1e3)/1e3};function go(){const{user:t}=be(),{companion:s}=Tt(),r=Ae(),{data:a,isLoading:i}=Ee({queryKey:["companion-memories",s?.id],queryFn:async()=>{if(!s?.id)return[];const{data:v,error:x}=await S.from("companion_memories").select("*").eq("companion_id",s.id).order("memory_date",{ascending:!1}).limit(50);if(x)throw console.error("Failed to fetch memories:",x),x;return v||[]},enabled:!!s?.id,staleTime:300*1e3}),{data:o,isLoading:l}=Ee({queryKey:["companion-bond",s?.id],queryFn:async()=>{if(!s?.id||!t?.id)return null;const{data:v,error:x}=await S.from("user_companion").select("bond_level, total_interactions, last_interaction_at").eq("user_id",t.id).maybeSingle();return x?(console.error("Failed to fetch bond data:",x),null):v},enabled:!!s?.id&&!!t?.id,staleTime:60*1e3}),c=le({mutationFn:async v=>{if(!t?.id||!s?.id)throw new Error("No user or companion");const x={user_id:t.id,companion_id:s.id,memory_type:v.memoryType,memory_context:v.context||null,memory_date:new Date().toISOString().split("T")[0],referenced_count:0},{data:w,error:j}=await S.from("companion_memories").insert(x).select().single();if(j)throw j;return w},onSuccess:()=>{r.invalidateQueries({queryKey:["companion-memories",s?.id]})}}),d=le({mutationFn:async v=>{const{data:x}=await S.from("companion_memories").select("referenced_count").eq("id",v).maybeSingle(),w=(x?.referenced_count||0)+1,{error:j}=await S.from("companion_memories").update({referenced_count:w,last_referenced_at:new Date().toISOString()}).eq("id",v);if(j)throw j}}),m=n.useMemo(()=>{const v=o?.bond_level||1;return Ja.map(x=>({...x,unlockedAt:x.level<=v?x.level===v?"now":"past":null}))},[o?.bond_level]),p=n.useMemo(()=>{const v=o?.bond_level||1,x=Ja.find(j=>j.level===v)||Ja[0],w=Ja.find(j=>j.level===v+1);return{level:v,...x,nextMilestone:w,totalInteractions:o?.total_interactions||0,lastInteractionAt:o?.last_interaction_at}},[o]),h=n.useCallback(()=>{if(!a||a.length===0)return null;const v=Math.max(...a.map(D=>D.referenced_count||0),1),x=a.map(D=>({memory:D,weight:v-(D.referenced_count||0)+1})),w=x.reduce((D,C)=>D+C.weight,0);let j=Math.random()*w;for(const{memory:D,weight:C}of x)if(j-=C,j<=0)return D;return a[0]},[a]),f=n.useCallback(v=>{const x=v.memory_context;if(!x)return null;const w=x.emotion||"joy",j=wl[w]||wl.joy,D=`${v.id}-${new Date().toDateString()}`,C=Math.floor(Yb(D)*j.length),_=j[C];return x.title?`Remember when ${x.title.toLowerCase()}? ${_}`:_},[]),u=n.useCallback((v,x)=>c.mutateAsync({memoryType:v,context:x}),[c]),g=n.useCallback(v=>d.mutate(v),[d]),y=n.useMemo(()=>a?a.reduce((v,x)=>{const w=x.memory_type;return v[w]||(v[w]=[]),v[w].push(x),v},{}):{},[a]),b=n.useMemo(()=>a?a.filter(v=>["first_meeting","first_evolution","evolution","bond_milestone","recovery"].includes(v.memory_type)):[],[a]);return{memories:a||[],memoriesByType:y,specialMemories:b,isLoading:i||l,currentBond:p,bondMilestones:m,createMemory:u,referenceMemory:g,getRandomMemory:h,getMemoryDialogue:f}}const Ju=n.memo(({className:t})=>{const{currentBond:s,isLoading:r}=go();return r||!s?null:e.jsxs(Wd,{children:[e.jsx(Gd,{asChild:!0,children:e.jsxs(M.div,{className:A("flex items-center gap-2 px-3 py-1.5 rounded-full","bg-card/50 backdrop-blur-sm border border-border/30","hover:border-primary/40 transition-all cursor-default",t),initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},whileHover:{scale:1.02},children:[e.jsx("span",{className:"text-lg","aria-hidden":!0,children:s.icon}),e.jsxs("div",{className:"flex flex-col leading-tight",children:[e.jsx("span",{className:"text-xs font-medium",children:s.name}),e.jsxs("span",{className:"text-[10px] text-muted-foreground",children:["Lvl ",s.level]})]})]})}),e.jsxs(ao,{side:"bottom",children:[e.jsx("p",{className:"text-xs",children:s.description}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s.totalInteractions," interactions"]})]})]})});Ju.displayName="CompanionBondBadge";const Vb=({isOpen:t,onClose:s})=>{const{health:r,markUserActive:a}=Vu(),{companion:i}=Tt(),{awardCustomXP:o,XP_REWARDS:l}=Xt(),{triggerComeback:c}=Ra(),[d,m]=n.useState(!1),[p,h]=n.useState(!1),f=Math.min(r.daysInactive*5,50),u=y=>{switch(y){case"happy":return"ðŸ˜Š";case"content":return"ðŸ™‚";case"neutral":return"ðŸ˜";case"worried":return"ðŸ˜Ÿ";case"sad":return"ðŸ˜¢";case"sick":return"ðŸ¤’";default:return"ðŸ˜Š"}},g=async()=>{m(!0),p||(await o(l.WELCOME_BACK_BONUS,"welcome_back_bonus","Welcome Back Bonus! ðŸŽ‰",{days_inactive:r.daysInactive}),h(!0)),await a(),r.daysInactive>=3&&c().catch(y=>console.log("[LivingCompanion] Comeback reaction failed:",y)),setTimeout(()=>{s(),m(!1)},2e3)};return n.useEffect(()=>{t&&(h(!1),m(!1))},[t]),i?e.jsx(ns,{open:t,onOpenChange:s,children:e.jsxs(Vt,{className:"cosmiq-glass border-celestial-blue/40 max-w-md",children:[e.jsxs(Bs,{children:[e.jsx(xs,{className:"text-2xl font-heading text-center",children:d?"Welcome Back! ðŸŽ‰":`${u(r.moodState)} We Missed You!`}),e.jsx(dr,{className:"text-center text-muted-foreground",children:d?"Your companion is so happy to see you!":`Your companion has been waiting for you for ${r.daysInactive} day${r.daysInactive!==1?"s":""}...`})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(Pe,{mode:"wait",children:d?e.jsxs(M.div,{initial:{opacity:0,scale:.8,rotate:-10},animate:{opacity:1,scale:[1,1.1,1],rotate:[0,5,-5,0]},transition:{duration:.5},className:"relative",children:[e.jsx("img",{src:i.current_image_url||"",alt:"Your happy companion",className:"w-48 h-48 object-cover rounded-2xl ring-4 ring-primary/50"}),e.jsx(M.div,{className:"absolute -top-2 -right-2 text-4xl",animate:{scale:[1,1.3,1],rotate:[0,15,-15,0]},transition:{repeat:1/0,duration:1},children:"â¤ï¸"}),e.jsx(pe,{className:"absolute -top-4 left-1/2 -translate-x-1/2 h-8 w-8 text-stardust-gold animate-pulse"})]},"happy"):e.jsxs(M.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"relative",children:[e.jsx("img",{src:r.neglectedImageUrl||i.current_image_url||"",alt:"Your sad companion",className:"w-48 h-48 object-cover rounded-2xl",style:{filter:r.neglectedImageUrl?void 0:"saturate(0.4) brightness(0.8)"}}),e.jsx("div",{className:"absolute -bottom-2 -right-2 text-4xl",children:"ðŸ’”"})]},"sad")})}),!d&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-sm font-medium text-center text-muted-foreground",children:"While you were away..."}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"text-center p-2 rounded-lg bg-destructive/10 border border-destructive/20",children:[e.jsx(ca,{className:"h-4 w-4 mx-auto text-destructive mb-1"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Body"}),e.jsxs("p",{className:"text-sm font-bold text-destructive",children:["-",f]})]}),e.jsxs("div",{className:"text-center p-2 rounded-lg bg-destructive/10 border border-destructive/20",children:[e.jsx(ca,{className:"h-4 w-4 mx-auto text-destructive mb-1"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Mind"}),e.jsxs("p",{className:"text-sm font-bold text-destructive",children:["-",f]})]}),e.jsxs("div",{className:"text-center p-2 rounded-lg bg-destructive/10 border border-destructive/20",children:[e.jsx(ca,{className:"h-4 w-4 mx-auto text-destructive mb-1"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Soul"}),e.jsxs("p",{className:"text-sm font-bold text-destructive",children:["-",f]})]})]}),e.jsxs("div",{className:"p-3 rounded-lg bg-stardust-gold/10 border border-stardust-gold/20",children:[e.jsxs("div",{className:"flex items-center gap-2 justify-center",children:[e.jsx(Ts,{className:"h-4 w-4 text-stardust-gold"}),e.jsx("span",{className:"text-sm font-medium",children:"Come back and earn:"})]}),e.jsxs("div",{className:"flex items-center gap-4 justify-center mt-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"+10 to all stats"}),e.jsx("span",{className:"text-sm text-stardust-gold font-bold",children:"+25 XP bonus!"})]})]})]}),d&&e.jsxs(M.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"text-center space-y-2",children:[e.jsx("p",{className:"text-lg font-medium text-stardust-gold",children:"Your companion is overjoyed!"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"+10 Body, +10 Mind, +10 Soul restored"}),e.jsx("p",{className:"text-sm font-bold text-stardust-gold",children:"+25 XP Welcome Back Bonus!"})]}),!d&&e.jsxs(U,{onClick:g,className:"w-full rounded-2xl min-h-[48px] bg-gradient-to-r from-stardust-gold to-amber-500 text-black hover:from-stardust-gold/90 hover:to-amber-500/90",children:[e.jsx(Ws,{className:"h-5 w-5 mr-2"}),"Reunite with Your Companion"]})]})]})}):null},_l={starting:["Preparing to create your companion...","Gathering magical energy...","Initiating the summoning ritual..."],generating:["Creating your companion's form...","Weaving magical essence...","Bringing your companion to life...","Shaping the elemental energy..."],validating:["Perfecting the details...","Ensuring magical accuracy...","Checking the enchantment..."],retrying:["Refining the form...","Adding final touches...","Polishing the magic...","Making adjustments..."],finalizing:["Almost there...","Completing the transformation...","Your companion is nearly ready..."],complete:["Your companion is ready!"],warning:["Your companion has been created with some variations."]},jl=["This is taking a bit longer than usual...","Still working on perfecting your companion...","Quality takes time - almost there...","Your companion is being carefully crafted..."],Xb=({phase:t,retryCount:s=0,className:r,estimatedTime:a})=>{const[i,o]=n.useState(0),[l,c]=n.useState(0),[d,m]=n.useState(!1);n.useEffect(()=>{t==="starting"&&(o(0),c(0),m(!1))},[t]),n.useEffect(()=>{const y=_l[t];if(y.length<=1)return;const b=setInterval(()=>{o(v=>(v+1)%y.length)},3e3);return()=>clearInterval(b)},[t]),n.useEffect(()=>{if(t==="complete"||t==="warning")return;const y=setInterval(()=>{c(b=>b+1)},1e3);return()=>clearInterval(y)},[t]),n.useEffect(()=>{l>=15&&t!=="complete"&&t!=="warning"&&m(!0)},[l,t]);const p=_l[t],h=p[i%p.length],f=jl[Math.floor(l/10)%jl.length],u=()=>{switch(t){case"complete":return e.jsx(Uh,{className:"h-5 w-5 text-green-500"});case"warning":return e.jsx(Xs,{className:"h-5 w-5 text-yellow-500"});case"retrying":return e.jsx(ir,{className:"h-5 w-5 text-primary animate-spin"});default:return e.jsx(bt,{className:"h-5 w-5 text-primary animate-spin"})}},g=()=>{switch(t){case"starting":return"10%";case"generating":return"40%";case"validating":return"60%";case"retrying":return`${60+s*15}%`;case"finalizing":return"90%";case"complete":case"warning":return"100%";default:return"0%"}};return e.jsxs("div",{className:A("space-y-3",r),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[u(),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:d&&t!=="complete"&&t!=="warning"?f:h}),s>0&&t==="retrying"&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-0.5",children:["Attempt ",s+1," of 3 - ensuring quality"]})]})]}),t!=="complete"&&t!=="warning"&&e.jsx("div",{className:"w-full h-1.5 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-primary to-primary/70 rounded-full transition-all duration-500 ease-out",style:{width:g()}})}),a&&t!=="complete"&&t!=="warning"&&e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:s>0?`Taking a bit longer to ensure quality (${Math.max(0,a-l)}s remaining)`:`Usually takes ${a}-${a+10} seconds`}),t==="complete"&&e.jsx("div",{className:"flex justify-center",children:e.jsx(pe,{className:"h-4 w-4 text-primary animate-pulse"})})]})},Jb=({isOpen:t,onClose:s,onConfirm:r,isRegenerating:a,regenerationsRemaining:i,generationPhase:o="starting",retryCount:l=0})=>{const c=o==="complete"||o==="warning";return e.jsx(Aa,{open:t,onOpenChange:d=>!d&&!a&&s(),children:e.jsxs(Ur,{className:"cosmic-glass border-primary/30",children:[e.jsxs(zr,{children:[e.jsxs(Kr,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5 text-primary"}),a?"Creating New Look...":"Refresh Companion Look?"]}),e.jsx(Wr,{className:"space-y-3",children:a?e.jsxs("div",{className:"py-2",children:[e.jsx(Xb,{phase:o,retryCount:l,estimatedTime:15}),l>0&&e.jsx("p",{className:"text-xs text-muted-foreground mt-3 text-center",children:"We're ensuring your companion looks perfect"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This will create a new unique appearance for your companion while keeping all stats, XP, and progress intact."}),e.jsxs("p",{className:"text-sm text-muted-foreground/80",children:["You have ",e.jsx("span",{className:"font-semibold text-primary",children:i})," look refresh",i===1?"":"es"," remaining (lifetime limit)."]}),e.jsx("p",{className:"text-xs text-muted-foreground/60",children:"This usually takes 10-20 seconds. We'll ensure quality by validating the result."})]})})]}),e.jsxs(Qr,{children:[!a&&!c&&e.jsxs(e.Fragment,{children:[e.jsx(Gr,{disabled:a,children:"Cancel"}),e.jsxs(or,{onClick:d=>{d.preventDefault(),r()},disabled:a||i<=0,className:"bg-primary hover:bg-primary/90",children:[e.jsx(pe,{className:"h-4 w-4 mr-2"}),"Refresh Look"]})]}),c&&e.jsx(or,{onClick:d=>{d.preventDefault(),s()},className:"bg-primary hover:bg-primary/90",children:"Done"})]})]})})},Zb=75e3,Zu=n.memo(({onEvolve:t,isEvolving:s})=>{const{isEvolvingLoading:r}=Pn(),a=s||r,[i,o]=n.useState(!1);n.useEffect(()=>{if(!a){o(!1);return}o(!1);const c=window.setTimeout(()=>{o(!0)},Zb);return()=>{window.clearTimeout(c)}},[a]);const l=()=>{a||t()};return e.jsxs(M.div,{initial:{opacity:0,y:-10,scale:.98},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:-10,scale:.98},transition:{duration:.3,ease:"easeOut"},className:"pt-4",children:[e.jsxs("button",{onClick:l,disabled:a,"data-tour":"evolve-companion-button",className:`
          relative w-full py-5 rounded-xl
          font-heading font-black text-3xl sm:text-4xl tracking-[0.35em]
          uppercase overflow-hidden
          transition-all duration-300
          hover:scale-[1.02] active:scale-[0.98]
          disabled:cursor-not-allowed disabled:opacity-70
          border border-white/20
        `,style:{background:`linear-gradient(90deg, 
            rgba(255,0,0,0.2), 
            rgba(255,64,0,0.2),
            rgba(255,128,0,0.2), 
            rgba(255,192,0,0.2),
            rgba(255,255,0,0.2), 
            rgba(128,255,0,0.2),
            rgba(0,255,0,0.2), 
            rgba(0,255,128,0.2),
            rgba(0,255,255,0.2), 
            rgba(0,128,255,0.2), 
            rgba(0,0,255,0.2),
            rgba(128,0,255,0.2), 
            rgba(255,0,255,0.2),
            rgba(255,0,128,0.2), 
            rgba(255,0,0,0.2)
          )`,backgroundSize:"300% 100%",animation:"rainbow-slide 3s linear infinite",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)"},children:[e.jsx("div",{className:"absolute inset-0 rounded-xl pointer-events-none",style:{background:"linear-gradient(135deg, rgba(255,255,255,0.3) 0%, transparent 40%, transparent 60%, rgba(255,255,255,0.15) 100%)"}}),e.jsx("div",{className:"absolute inset-0 rounded-xl pointer-events-none overflow-hidden",children:e.jsx("div",{className:"absolute inset-0",style:{background:"linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%)",animation:"shimmer-sweep 2s ease-in-out infinite"}})}),e.jsxs("div",{className:"absolute inset-0 rounded-xl pointer-events-none overflow-hidden",children:[e.jsx("div",{className:"absolute w-3 h-3 bg-white star-sparkle-4 animate-sparkle-1",style:{top:"20%",left:"15%"}}),e.jsx("div",{className:"absolute w-4 h-4 bg-white star-sparkle-4 animate-sparkle-2",style:{top:"60%",left:"75%"}}),e.jsx("div",{className:"absolute w-3 h-3 bg-white star-sparkle-4 animate-sparkle-3",style:{top:"40%",left:"45%"}}),e.jsx("div",{className:"absolute w-2 h-2 bg-white star-sparkle-4 animate-sparkle-4",style:{top:"70%",left:"25%"}}),e.jsx("div",{className:"absolute w-3 h-3 bg-white star-sparkle-4 animate-sparkle-5",style:{top:"30%",left:"85%"}})]}),e.jsx("div",{className:"absolute inset-0 -z-10 rounded-xl opacity-60",style:{background:"linear-gradient(90deg, #ff0000, #ff4000, #ff8000, #ffc000, #ffff00, #80ff00, #00ff00, #00ff80, #00ffff, #0080ff, #0000ff, #8000ff, #ff00ff, #ff0080, #ff0000)",backgroundSize:"300% 100%",animation:"rainbow-slide 3s linear infinite",filter:"blur(8px)",transform:"scale(1.02)"}}),e.jsx("div",{className:"relative z-10 h-[1.2em]",children:a?e.jsx(M.span,{className:"absolute inset-0 flex items-center justify-center text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.3)]",style:{textShadow:"0 0 20px rgba(255,255,255,0.5), 0 0 40px rgba(255,255,255,0.3)"},animate:{opacity:[1,.5,1]},transition:{duration:1,repeat:1/0,ease:"easeInOut"},children:"EVOLVING..."}):e.jsx("span",{className:"absolute inset-0 flex items-center justify-center text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.3)]",style:{textShadow:"0 0 20px rgba(255,255,255,0.5), 0 0 40px rgba(255,255,255,0.3)"},children:"EVOLVE"})})]}),a&&e.jsxs("div",{className:"mt-2 space-y-1 text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:i?"Taking longer than usual, can take up to ~2 minutes":"About 1 minute"}),e.jsx("p",{className:"text-xs text-muted-foreground/80",children:"You can leave this screen and come back when it is ready."})]})]})});Zu.displayName="EvolveButton";const em=n.memo(({path:t,isLocked:s=!1,className:r,showDescription:a=!1})=>{const i=Jg(t),o=e.jsxs("div",{className:A("inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium transition-all",i.bgColor,i.borderColor,"border",s&&"ring-1 ring-offset-1 ring-offset-background ring-primary/30",r),children:[e.jsx("span",{className:"text-base",children:i.icon}),e.jsx("span",{className:i.color,children:i.name}),s&&e.jsx("span",{className:"text-xs opacity-60",children:"ðŸ”’"})]});return a?e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[o,e.jsx("p",{className:"text-xs text-muted-foreground text-center max-w-[200px]",children:i.description})]}):e.jsx(Kd,{children:e.jsxs(Wd,{children:[e.jsx(Gd,{asChild:!0,children:o}),e.jsxs(ao,{side:"bottom",className:"max-w-[250px]",children:[e.jsx("p",{className:"text-sm",children:i.description}),s&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"This path is now permanent."})]})]})})});em.displayName="EvolutionPathBadge";const ev=({daysUntilDormancy:t=2,show:s})=>s?e.jsx(Pe,{children:e.jsx(M.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"absolute top-2 left-2 right-2 z-20",children:e.jsxs("div",{className:"bg-orange-500/20 border border-orange-500/50 rounded-lg px-3 py-2 backdrop-blur-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-orange-300",children:[e.jsx(Xs,{className:"w-4 h-4 animate-pulse"}),e.jsx("span",{className:"text-xs font-medium",children:t===1?"Your companion feels forgotten...":`${t} days until dormancy`})]}),e.jsx("p",{className:"text-[10px] text-orange-200/70 mt-1 pl-6",children:"Complete any activity to reconnect"})]})})}):null,Nl={0:"Be active for 5 consecutive days to wake them",1:"A faint light stirs within...",2:"Dreams are beginning to form...",3:"Memories of you are returning...",4:"Almost there... keep going...",5:"Ready to wake!"},tv=({isDormant:t,recoveryDays:s,daysUntilWake:r})=>{if(!t)return null;const a=Nl[Math.min(s,5)]||Nl[0];return e.jsxs(M.div,{initial:{opacity:0},animate:{opacity:1},className:"absolute inset-0 z-10 flex flex-col items-center justify-center bg-slate-900/60 backdrop-blur-sm rounded-2xl overflow-hidden",children:[s>0&&e.jsx(M.div,{className:"absolute inset-0 pointer-events-none",animate:{background:["radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 50%)","radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.15) 0%, transparent 60%)","radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 50%)"]},transition:{duration:3,repeat:1/0,ease:"easeInOut"}}),s>0&&e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(Math.min(s*2,8))].map((i,o)=>e.jsx(M.div,{className:"absolute w-1.5 h-1.5 rounded-full bg-amber-400/50",style:{left:`${20+Math.random()*60}%`},animate:{y:["100%","-20%"],opacity:[0,.8,0],scale:[.5,1,.5]},transition:{duration:2.5+Math.random(),repeat:1/0,delay:o*.4,ease:"easeOut"}},o))}),e.jsx(M.div,{animate:s>0?{scale:[1,1.05,1],opacity:[.8,1,.8]}:void 0,transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx(fa,{className:"w-12 h-12 text-slate-400 mb-3"})}),e.jsx("span",{className:"text-slate-300 font-medium text-lg",children:"Dormant"}),e.jsx("p",{className:"text-slate-400 text-sm mt-1 text-center px-4",children:"Your companion has fallen into a deep sleep"}),s>0&&e.jsxs("div",{className:"mt-4 px-4 w-full max-w-[200px]",children:[e.jsxs("div",{className:"flex justify-between text-xs text-slate-400 mb-1",children:[e.jsx("span",{children:"Awakening..."}),e.jsxs("span",{children:[s,"/5 days"]})]}),e.jsx("div",{className:"h-2 bg-slate-700 rounded-full overflow-hidden",children:e.jsx(M.div,{initial:{width:0},animate:{width:`${s/5*100}%`},className:"h-full bg-gradient-to-r from-amber-500 to-amber-400"})}),e.jsx(M.p,{initial:{opacity:0,y:5},animate:{opacity:1,y:0},className:"text-xs text-amber-400/80 mt-2 text-center italic",children:a},s)]}),s===0&&e.jsx("p",{className:"text-xs text-amber-400/70 mt-3 text-center px-6",children:a})]})},kl=t=>{let s=0;for(let r=0;r<t.length;r++)s=(s<<5)-s+t.charCodeAt(r),s|=0;return Math.abs(s%1e3)/1e3};function sv(){const{companion:t}=Tt(),{care:s,isLoading:r}=An(),{data:a,isLoading:i}=Ee({queryKey:["companion-voice-template"],queryFn:async()=>{const{data:u,error:g}=await S.from("companion_voice_templates").select("*").eq("species","universal").maybeSingle();return g?(console.error("Failed to fetch voice template:",g),null):u?{species:u.species,voice_style:u.voice_style,personality_traits:u.personality_traits||[],greeting_templates:u.greeting_templates||[],encouragement_templates:u.encouragement_templates||[],concern_templates:u.concern_templates||[],care_high_greetings:u.care_high_greetings||[],care_medium_greetings:u.care_medium_greetings||[],care_low_greetings:u.care_low_greetings||[],care_critical_greetings:u.care_critical_greetings||[],recovery_greetings:u.recovery_greetings||[],path_greetings:u.path_greetings||{},bond_level_dialogue:u.bond_level_dialogue||{}}:null},staleTime:1e3*60*5}),o={1:"...is someone there?",2:"I can feel you... don't leave...",3:"Your warmth... it's bringing me back...",4:"I remember now... we had so many days together...",5:"I'm almost ready... thank you for not giving up on me..."},l=n.useMemo(()=>{if(!s)return"content";if(s.dormancy?.isDormant&&s.dormancy.recoveryDays>0)return"recovering";if(s.dormancy?.isDormant)return"desperate";const u=s.overallCare;return u>=.8?"thriving":u>=.5?"content":u>=.25?"concerned":"desperate"},[s]),c=n.useMemo(()=>{if(!s?.dormancy?.isDormant||s.dormancy.recoveryDays===0)return null;const u=Math.min(s.dormancy.recoveryDays,5);return o[u]||null},[s?.dormancy]),d=t?.spirit_animal||"companion",m=n.useCallback((u,g)=>{if(!u||u.length===0)return"";const y=`${new Date().toDateString()}-${g}-${d}`,b=Math.floor(kl(y)*u.length);return u[b]},[d]),p=n.useMemo(()=>{if(!a)return"Hello, friend.";if(l==="recovering"&&c)return c;if(l==="recovering"&&a.recovery_greetings?.length)return m(a.recovery_greetings,"recovery");const u=s?.evolutionPath?.path;if(u&&s?.evolutionPath?.isLocked){const g=a.path_greetings?.[u];if(g?.length&&kl(`${new Date().toDateString()}-path-chance`)<.2)return m(g,`path-${u}`)}switch(l){case"thriving":return m(a.care_high_greetings,"thriving")||m(a.greeting_templates,"default");case"content":return m(a.care_medium_greetings,"content")||m(a.greeting_templates,"default");case"concerned":return m(a.care_low_greetings,"concerned")||m(a.concern_templates,"concern");case"desperate":return m(a.care_critical_greetings,"desperate")||m(a.concern_templates,"concern");default:return m(a.greeting_templates,"default")}},[a,l,s?.evolutionPath,c,m]),h=n.useMemo(()=>{if(!a||!s?.bond)return null;const u=Math.min(5,Math.max(1,s.bond.level)),g=a.bond_level_dialogue?.[String(u)];return!g||g.length===0?null:m(g,`bond-${u}`)},[a,s?.bond,m]),f=n.useMemo(()=>a?m(a.encouragement_templates,"encouragement"):null,[a,m]);return{greeting:p,bondDialogue:h,encouragement:f,dialogueMood:l,voiceStyle:a?.voice_style||"",personalityTraits:a?.personality_traits||[],isLoading:i||r}}const rv={thriving:{color:"text-cosmiq-glow",ringColor:"ring-cosmiq-glow/50",bgColor:"bg-cosmiq-glow/10"},content:{color:"text-celestial-blue",ringColor:"ring-celestial-blue/50",bgColor:"bg-celestial-blue/10"},concerned:{color:"text-amber-400",ringColor:"ring-amber-400/50",bgColor:"bg-amber-400/10"},desperate:{color:"text-destructive",ringColor:"ring-destructive/50",bgColor:"bg-destructive/10"},recovering:{color:"text-green-400",ringColor:"ring-green-400/50",bgColor:"bg-green-400/10"}},tm=n.memo(({className:t})=>{const{greeting:s,dialogueMood:r,isLoading:a}=sv(),{companion:i}=Tt(),o=i?.current_image_url,l=i?.spirit_animal||"Companion",[c,d]=n.useState(s),[m,p]=n.useState(!1);if(n.useEffect(()=>{if(s!==c&&!m){p(!0);const f=setTimeout(()=>{d(s),p(!1)},300);return()=>clearTimeout(f)}},[s,c,m]),a)return e.jsx("div",{className:A("h-16 bg-card/30 rounded-xl animate-pulse",t)});const h=rv[r];return e.jsxs(M.div,{className:A("relative overflow-hidden rounded-xl border border-border/30",h.bgColor,t),initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent pointer-events-none"}),e.jsx("div",{className:"relative p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:A("flex-shrink-0 rounded-lg overflow-hidden","ring-2",h.ringColor),children:e.jsxs(Lr,{className:"h-10 w-10 rounded-lg",children:[o?e.jsx(qr,{src:o,alt:l,className:"object-cover"}):null,e.jsx(Or,{className:"rounded-lg bg-primary/20 text-primary",children:l.charAt(0).toUpperCase()})]})}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx(Pe,{mode:"wait",children:e.jsxs(M.p,{className:"text-sm text-foreground/90 leading-relaxed",initial:{opacity:0,y:5},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},transition:{duration:.2},children:['"',c,'"']},c)})})]})})]})});tm.displayName="CompanionDialogue";const Cl=["I... I can see you again! You came back for me...","You didn't give up on me... I'll never forget this.","The darkness is fading... because of you.","I dreamed of this moment. You're really here.","My heart feels warm again. Thank you for believing in me."],Sl={1:"A bond has been renewed.",2:"Your connection deepens through adversity.",3:"Trust restored through dedication.",4:"An unbreakable bond forged through care.",5:"A legendary bond â€” you never abandoned them."},sm=n.memo(({isOpen:t,onClose:s,companionName:r,companionImageUrl:a,dormantImageUrl:i,bondLevel:o})=>{const[l,c]=n.useState(!1),[d,m]=n.useState(0),p=Cl[Math.floor(Math.random()*Cl.length)],h=Sl[Math.min(5,o)]||Sl[1];return n.useEffect(()=>{if(!t){c(!1),m(0);return}const f=setTimeout(()=>m(1),500),u=setTimeout(()=>{c(!0),m(2);const b=Date.now()+3e3,v=["#FFD700","#FF69B4","#00CED1","#9370DB"];(function x(){Ot({particleCount:3,angle:60,spread:55,origin:{x:0},colors:v}),Ot({particleCount:3,angle:120,spread:55,origin:{x:1},colors:v}),Date.now()<b&&requestAnimationFrame(x)})()},2e3),g=setTimeout(()=>m(3),3500);return()=>{clearTimeout(f),clearTimeout(u),clearTimeout(g)}},[t]),e.jsx(ns,{open:t,onOpenChange:f=>!f&&s(),children:e.jsx(Vt,{className:"sm:max-w-md bg-gradient-to-br from-slate-900 via-purple-900/50 to-slate-900 border-amber-500/30",hideCloseButton:!0,children:e.jsxs("div",{className:"flex flex-col items-center py-6 space-y-6",children:[e.jsx(M.div,{className:"absolute inset-0 overflow-hidden rounded-lg",initial:{opacity:0},animate:{opacity:d>=1?1:0},children:e.jsx(M.div,{className:"absolute inset-0 bg-gradient-radial from-amber-500/20 via-transparent to-transparent",animate:{scale:[1,1.2,1],opacity:[.3,.6,.3]},transition:{duration:3,repeat:1/0,ease:"easeInOut"}})}),e.jsxs(M.div,{className:"text-center z-10",initial:{opacity:0,y:-20},animate:{opacity:d>=1?1:0,y:0},transition:{delay:.3},children:[e.jsx(zh,{className:"w-8 h-8 text-amber-400 mx-auto mb-2 animate-pulse"}),e.jsx("h2",{className:"text-2xl font-heading font-bold bg-gradient-to-r from-amber-300 via-yellow-200 to-amber-300 bg-clip-text text-transparent",children:"Awakening"})]}),e.jsxs("div",{className:"relative w-48 h-48 z-10",children:[e.jsx(Pe,{children:!l&&i&&e.jsx(M.img,{src:i,alt:`Sleeping ${r}`,className:"absolute inset-0 w-full h-full object-cover rounded-2xl",style:{filter:"grayscale(0.5) brightness(0.6)"},initial:{opacity:1,scale:.95},exit:{opacity:0,scale:.8,filter:"grayscale(0) brightness(1.5)"},transition:{duration:1}})}),e.jsxs(M.div,{className:"absolute inset-0",initial:{opacity:0,scale:.8},animate:{opacity:l?1:0,scale:l?1:.8},transition:{duration:1,delay:.5},children:[e.jsx(M.div,{className:"absolute inset-0 rounded-2xl",animate:{boxShadow:["0 0 20px rgba(255, 215, 0, 0.3)","0 0 40px rgba(255, 215, 0, 0.5)","0 0 20px rgba(255, 215, 0, 0.3)"]},transition:{duration:2,repeat:1/0}}),e.jsx("img",{src:a,alt:`Awakened ${r}`,className:"w-full h-full object-cover rounded-2xl ring-4 ring-amber-400/50"}),[...Array(6)].map((f,u)=>e.jsx(M.div,{className:"absolute",style:{top:`${20+Math.random()*60}%`,left:`${10+Math.random()*80}%`},animate:{opacity:[0,1,0],scale:[.5,1,.5],y:[0,-10,0]},transition:{duration:1.5,repeat:1/0,delay:u*.3},children:e.jsx(St,{className:"w-4 h-4 text-amber-300"})},u))]})]}),e.jsx(Pe,{children:d>=3&&e.jsxs(M.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"text-center space-y-4 z-10 px-4",children:[e.jsx("div",{className:"p-4 rounded-xl bg-muted/20 border border-amber-500/20",children:e.jsxs("p",{className:"text-foreground/90 italic",children:['"',p,'"']})}),e.jsxs(M.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},className:"flex items-center justify-center gap-2 text-amber-400",children:[e.jsx(Ws,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:h})]}),e.jsxs(M.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:1},className:"flex items-center justify-center gap-2 text-purple-400 text-sm",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsx("span",{children:"Your companion will remember this moment"})]})]})}),e.jsx(Pe,{children:d>=3&&e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:1.5},children:e.jsx(U,{onClick:s,className:"bg-gradient-to-r from-amber-500 to-yellow-500 hover:from-amber-600 hover:to-yellow-600 text-slate-900 font-bold px-8",children:"Welcome Back"})})})]})})})});sm.displayName="WakeUpCelebration";const av=["vitality","wisdom","discipline","resolve","creativity","alignment"],El=100,Tl=1e3,nv=300,iv=({companion:t})=>{const[s,r]=n.useState(null),a=l=>t[l]??nv,i=l=>(l-El)/(Tl-El)*100,o=s?ol[s]:null;return e.jsxs(e.Fragment,{children:[e.jsx(We,{className:"p-3 bg-gradient-to-br from-secondary/30 to-secondary/10 border-primary/20",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-xs font-bold text-center text-muted-foreground uppercase tracking-wide",children:"Companion Stats"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:av.map(l=>{const c=ol[l],d=a(l),m=i(d);return e.jsxs("button",{onClick:()=>r(l),className:"p-2 rounded-lg bg-background/50 hover:bg-background/80 transition-all text-left space-y-1.5 border border-transparent hover:border-primary/20",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-sm",children:c.icon}),e.jsx("span",{className:A("text-xs font-medium",c.color),children:c.name})]}),e.jsx("span",{className:"text-[10px] text-muted-foreground font-mono",children:d})]}),e.jsx("div",{className:"relative h-1.5 bg-secondary/50 rounded-full overflow-hidden",children:e.jsx("div",{className:A("absolute inset-y-0 left-0 rounded-full transition-all duration-500",c.progressColor),style:{width:`${m}%`}})})]},l)})}),e.jsx("p",{className:"text-[10px] text-center text-muted-foreground/70 italic",children:"Tap a stat to learn more"})]})}),e.jsx(ns,{open:!!s,onOpenChange:l=>!l&&r(null),children:e.jsxs(Vt,{className:"max-w-md",children:[e.jsxs(Bs,{children:[e.jsxs(xs,{className:"flex items-center gap-2 text-xl",children:[o?.icon," ",o?.name]}),e.jsxs(dr,{className:"sr-only",children:["Learn about the ",o?.name," attribute"]})]}),o&&s&&e.jsxs("div",{className:"space-y-4 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Current Level:"}),e.jsxs("span",{className:"font-mono font-semibold",children:[a(s)," / ",Tl]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-foreground mb-1",children:"What it means:"}),e.jsx("p",{className:"text-muted-foreground",children:o.whatItMeans})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-foreground mb-2",children:"Boosted by:"}),e.jsx("ul",{className:"space-y-1.5 text-muted-foreground",children:o.boostedBy.map((l,c)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-0.5",children:"â€¢"}),e.jsx("span",{children:l})]},c))})]}),e.jsxs("div",{className:"pt-2 border-t border-border/50",children:[e.jsx("h4",{className:"font-semibold text-foreground mb-1",children:"When it grows:"}),e.jsx("p",{className:"text-muted-foreground italic",children:o.whenGrows})]})]})]})})]})},ov=800,Ml=12,lv="/placeholder-companion.svg",cv=t=>{const s={"#FF0000":"Red","#FF4500":"Orange Red","#FF6347":"Tomato","#FFA500":"Orange","#FFD700":"Gold","#FFFF00":"Yellow","#00FF00":"Lime","#00FA9A":"Spring Green","#008000":"Green","#00FFFF":"Cyan","#00CED1":"Turquoise","#4169E1":"Royal Blue","#0000FF":"Blue","#000080":"Navy","#4B0082":"Indigo","#9370DB":"Purple","#8B008B":"Dark Magenta","#FF00FF":"Magenta","#FF1493":"Deep Pink","#FF69B4":"Hot Pink","#FFC0CB":"Pink","#FFFFFF":"White","#C0C0C0":"Silver","#808080":"Gray","#000000":"Black","#A52A2A":"Brown","#D2691E":"Chocolate"},r=t.toUpperCase();if(s[r])return s[r];const a=t.replace("#",""),i=parseInt(a.substring(0,2),16),o=parseInt(a.substring(2,4),16),l=parseInt(a.substring(4,6),16),c=Math.max(i,o,l),d=Math.min(i,o,l);return c-d<30?c>200?"White":c>150?"Light Gray":c>100?"Gray":c>50?"Dark Gray":"Black":i===c?o>l?o>150?"Yellow":"Orange":i>150?"Red":"Dark Red":o===c?i>l?"Yellow Green":o>150?"Green":"Dark Green":i>o?l>150?"Purple":"Dark Purple":l>150?"Blue":"Dark Blue"},rm=n.memo(()=>{const{companion:t,nextEvolutionXP:s,progressToNext:r,isLoading:a,canEvolve:i,triggerManualEvolution:o,isEvolutionBusy:l}=Tt(),{unlockedSkins:c}=Lb(),{health:d,needsWelcomeBack:m}=Vu(),{regenerate:p,isRegenerating:h,maxRegenerations:f,generationPhase:u,retryCount:g}=Ob(),{equippedRewards:y}=Xu();Pn();const{showCelebration:b,dismissCelebration:v,companionName:x,companionImageUrl:w,dormantImageUrl:j,bondLevel:D}=$b(),{cssStyles:C,animationClass:_,care:N,evolutionPath:E,isDormant:k,hasDormancyWarning:P}=qb(d.moodState,d.hunger,d.happiness,d.isAlive,d.recoveryProgress),[T,I]=n.useState(!1),[R,L]=n.useState(!1),[$,q]=n.useState(0),[F,H]=n.useState(!1),[J,G]=n.useState(!1),[re,ie]=n.useState(!1),[K,xe]=n.useState(!1),[Te,Ne]=n.useState(null),B=n.useRef(null),z=n.useRef(!1),Q=n.useRef(null),Y=n.useRef(null),ue=t?.image_regenerations_used??0,fe=Math.max(0,f-ue),De=n.useCallback(_e=>{if(!(!t||h||fe<=0)){if("touches"in _e&&_e.touches[0]){const Me=_e.touches[0];Q.current={x:Me.clientX,y:Me.clientY}}else Q.current=null;z.current=!1,B.current=setTimeout(()=>{z.current=!0,xe(!0)},ov)}},[t,h,fe]),Ce=n.useCallback(()=>{B.current&&(clearTimeout(B.current),B.current=null),Q.current=null},[]),Be=n.useCallback(_e=>{if(!Q.current||!B.current)return;const Me=_e.touches[0];if(!Me)return;const et=Math.abs(Me.clientX-Q.current.x),Je=Math.abs(Me.clientY-Q.current.y);(et>Ml||Je>Ml)&&Ce()},[Ce]),qe=n.useCallback(_e=>{_e.key!=="Enter"&&_e.key!==" "||(_e.preventDefault(),!(!t||h||fe<=0)&&xe(!0))},[t,h,fe]),he=n.useCallback(()=>{t&&(p({id:t.id,spirit_animal:t.spirit_animal,core_element:t.core_element,favorite_color:t.favorite_color,current_stage:t.current_stage,eye_color:t.eye_color,fur_color:t.fur_color}),xe(!1))},[t,p]),ye=n.useMemo(()=>c?.find(_e=>_e.is_equipped)?.companion_skins,[c]),Ue=n.useMemo(()=>{if(!ye?.css_effect)return{};try{const _e=ye.css_effect;if(ye.skin_type==="aura"&&_e.glowColor&&typeof _e.glowColor=="string")return{boxShadow:`0 0 30px ${_e.glowColor}, 0 0 60px ${_e.glowColor}`,filter:`drop-shadow(0 0 20px ${_e.glowColor})`};if(ye.skin_type==="frame"&&_e.borderColor&&typeof _e.borderColor=="string")return{border:`${_e.borderWidth||"3px"} solid ${_e.borderColor}`,boxShadow:_e.shimmer?`0 0 20px ${_e.borderColor}`:void 0}}catch(_e){return console.error("Failed to parse skin effects:",_e),{}}return{}},[ye]),Re=n.useMemo(()=>{const _e={};if(y.frame?.epic_rewards?.css_effect){const Me=y.frame.epic_rewards.css_effect;Me.borderColor&&(_e.borderColor=Me.borderColor,_e.borderWidth=Me.borderWidth||"4px",_e.borderStyle="solid")}if(y.effect?.epic_rewards?.css_effect){const Me=y.effect.epic_rewards.css_effect;Me.glowColor&&(_e.boxShadow=`0 0 30px ${Me.glowColor}, 0 0 60px ${Me.glowColor}`)}return _e},[y]),Ie=n.useMemo(()=>y.background?.epic_rewards?.css_effect&&y.background.epic_rewards.css_effect.gradient||null,[y]);n.useEffect(()=>{const _e=window.matchMedia("(prefers-reduced-motion: reduce)");H(_e.matches);const Me=et=>H(et.matches);return _e.addEventListener("change",Me),()=>_e.removeEventListener("change",Me)},[]),n.useEffect(()=>{m&&!re&&t&&G(!0)},[m,re,t]);const ne=n.useMemo(()=>k&&t?.dormant_image_url?t.dormant_image_url:d.isNeglected&&d.neglectedImageUrl?d.neglectedImageUrl:t?.current_image_url,[k,t?.dormant_image_url,d.isNeglected,d.neglectedImageUrl,t?.current_image_url])||lv;if(n.useEffect(()=>{Y.current!==ne&&(Y.current=ne,I(!1),L(!1))},[ne]),n.useEffect(()=>()=>{B.current&&clearTimeout(B.current)},[]),n.useEffect(()=>{(async()=>{if(!t)return;if(t.cached_creature_name){Ne(t.cached_creature_name);return}const{data:Me}=await S.from("companion_evolution_cards").select("creature_name").eq("companion_id",t.id).eq("evolution_stage",t.current_stage).maybeSingle();Me?.creature_name?(Ne(Me.creature_name),S.from("user_companion").update({cached_creature_name:Me.creature_name}).eq("id",t.id)):Ne(t.spirit_animal.charAt(0).toUpperCase()+t.spirit_animal.slice(1))})()},[t?.id,t?.current_stage,t?.cached_creature_name]),a)return e.jsx(zb,{});if(!t)return null;const X=Ln(t.current_stage),ae=cv(t.favorite_color),Se=s??t.current_xp,ve=t.current_stage>=20;return e.jsxs(e.Fragment,{children:[e.jsxs(We,{className:"relative overflow-hidden bg-card/25 backdrop-blur-2xl border-celestial-blue/20 hover:border-nebula-pink/40 transition-all duration-500 animate-scale-in",children:[Ie?e.jsx("div",{className:"absolute inset-0 opacity-70 transition-opacity duration-500",style:{background:Ie}}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-nebula-pink/10 via-celestial-blue/10 to-cosmiq-glow/10 opacity-60 animate-nebula-shift"}),e.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(circle_at_top_right,hsl(var(--celestial-blue)/0.2),transparent_50%)]"}),e.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(circle_at_bottom_left,hsl(var(--nebula-pink)/0.2),transparent_50%)]"})]}),e.jsxs("div",{className:"relative p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("h2",{className:`text-3xl font-heading font-black bg-gradient-to-r from-primary via-accent to-primary bg-clip-text text-transparent ${F?"":"animate-gradient"}`,children:X}),e.jsx(Kb,{title:"Stage",description:"Your companion's evolution stage"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground font-medium",children:["Stage ",t.current_stage]})]}),e.jsx("div",{className:`h-14 w-14 rounded-full bg-gradient-to-br from-primary/30 to-accent/30 flex items-center justify-center shadow-glow ${F?"":"animate-pulse"}`,"aria-hidden":"true",children:e.jsx(pe,{className:"h-7 w-7 text-primary"})})]}),e.jsx("p",{className:"text-center text-2xl font-semibold text-primary/90 tracking-wide -mt-1",children:Te||"Companion"}),e.jsxs("div",{className:"flex justify-center py-2 relative group",role:"img","aria-label":`Your companion at stage ${t.current_stage}: ${X}`,children:[e.jsx("div",{className:`absolute inset-0 blur-3xl opacity-50 group-hover:opacity-70 transition-opacity duration-500 ${F?"animate-none":"animate-orbit"}`,style:{background:`radial-gradient(circle, hsl(var(--celestial-blue) / ${(t.vitality??300)/600}), hsl(var(--nebula-pink) / ${(t.vitality??300)/600}), transparent)`},"aria-hidden":"true"}),e.jsx("div",{className:`absolute inset-0 bg-gradient-to-r from-celestial-blue/20 via-nebula-pink/20 to-cosmiq-glow/20 blur-3xl opacity-50 group-hover:opacity-70 transition-opacity duration-500 ${F?"animate-none":""}`,"aria-hidden":"true"}),e.jsxs("div",{className:"relative select-none focus-visible:ring-2 focus-visible:ring-primary/70 rounded-2xl outline-none",role:"button",tabIndex:0,"aria-label":`Press and hold to refresh your companion's look. ${fe} look refresh${fe===1?"":"es"} remaining.`,onMouseDown:De,onMouseUp:Ce,onMouseLeave:Ce,onTouchStart:De,onTouchMove:Be,onTouchEnd:Ce,onTouchCancel:Ce,onKeyDown:qe,children:[e.jsx("div",{className:`absolute inset-0 rounded-2xl ${F?"":"star-shimmer"}`,"aria-hidden":"true"}),e.jsx("div",{className:`absolute inset-0 bg-gradient-to-br from-nebula-pink/30 to-celestial-blue/30 rounded-2xl blur-xl ${F?"":"animate-pulse"}`,"aria-hidden":"true"}),!T&&!R&&e.jsxs("div",{className:"relative w-64 h-64 rounded-2xl bg-gradient-to-br from-primary/20 to-accent/20 animate-pulse flex items-center justify-center",role:"status","aria-live":"polite","aria-label":"Loading companion image",children:[e.jsx(pe,{className:"h-12 w-12 text-primary/50 animate-spin","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Loading companion image"})]}),R&&e.jsx("div",{className:"relative w-64 h-64 rounded-2xl bg-gradient-to-br from-destructive/20 to-destructive/10 flex items-center justify-center border-2 border-destructive/30",role:"alert","aria-live":"assertive",children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",id:"image-error-message",children:"Image unavailable"}),e.jsx("button",{onClick:()=>{L(!1),I(!1),q(_e=>_e+1)},className:"text-xs text-primary hover:underline focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 rounded px-2 py-1","aria-label":"Retry loading companion image","aria-describedby":"image-error-message",children:"Try again"})]})}),e.jsx("img",{src:ne,alt:`${X} companion at stage ${t.current_stage}`,className:`relative w-64 h-64 object-cover rounded-2xl shadow-2xl ring-4 transition-all duration-500 group-hover:scale-105 ${T?"opacity-100":"opacity-0 absolute"} ${d.isNeglected?"ring-destructive/50":"ring-primary/30"} ${h?"animate-pulse":""} ${_}`,style:{...Ue,...C,...Re},onLoad:()=>{I(!0),L(!1)},onError:()=>{L(!0),I(!1)},loading:"lazy",decoding:"async",draggable:!1},$),e.jsx(ev,{show:P&&!k,daysUntilDormancy:N.dormancy.daysUntilDormancy??void 0}),e.jsx(tv,{isDormant:N.dormancy.isDormant,recoveryDays:N.dormancy.recoveryDays,daysUntilWake:N.dormancy.daysUntilWake})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-center items-center gap-3 mb-3 flex-wrap",children:[e.jsx(Gb,{element:t.core_element,stage:t.current_stage,showStage:!0}),e.jsx(Ju,{})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground mb-2",id:"xp-progress-label",children:ve?`Stage ${t.current_stage} maxed`:`${t.current_xp} / ${Se} XP to next evolution`}),e.jsx(Hs,{value:r,className:"h-3 rounded-full shadow-inner","aria-labelledby":"xp-progress-label","aria-valuenow":t.current_xp,"aria-valuemin":0,"aria-valuemax":Se})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 pt-2",children:[e.jsxs("div",{className:"text-center p-3 rounded-xl bg-gradient-to-br from-primary/5 to-accent/5 border border-primary/10 hover:border-primary/30 transition-all",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Color"}),e.jsx("p",{className:"font-medium text-sm",children:ae})]}),e.jsxs("div",{className:"text-center p-3 rounded-xl bg-gradient-to-br from-accent/5 to-primary/5 border border-accent/10 hover:border-accent/30 transition-all",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Spirit"}),e.jsx("p",{className:"font-medium text-sm",children:hs(t.spirit_animal)})]}),e.jsxs("div",{className:"text-center p-3 rounded-xl bg-gradient-to-br from-primary/5 to-accent/5 border border-primary/10 hover:border-primary/30 transition-all",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Element"}),e.jsx("p",{className:"font-medium text-sm",children:hs(t.core_element)})]})]}),e.jsx(iv,{companion:t})]}),e.jsx("div",{className:"flex items-center justify-center gap-3",children:E.path&&e.jsx(em,{path:E.path,isLocked:E.isLocked})}),e.jsx(tm,{className:"mt-2"}),e.jsx(Pe,{children:i&&e.jsx(Zu,{onEvolve:o,isEvolving:l})})]})]}),e.jsx(Vb,{isOpen:J,onClose:()=>{G(!1),ie(!0)}}),e.jsx(sm,{isOpen:b,onClose:v,companionName:x,companionImageUrl:w,dormantImageUrl:j,bondLevel:D}),e.jsx(Jb,{isOpen:K,onClose:()=>xe(!1),onConfirm:he,isRegenerating:h,regenerationsRemaining:fe,generationPhase:u,retryCount:g})]})});rm.displayName="CompanionDisplay";const dv=[{action:"Complete a habit",xp:"7-24 XP",icon:"âœ“"},{action:"Finish all daily habits",xp:"+15 XP bonus",icon:"ðŸŽ¯"},{action:"Complete daily missions",xp:"8-28 XP (Main Quest 1.5x)",icon:"âš¡"},{action:"Challenge day bonus",xp:"25 XP",icon:"ðŸ’ª"},{action:"Streak milestones",xp:"15 XP",icon:"ðŸ”¥"},{action:"Weekly challenge complete",xp:"60 XP",icon:"ðŸ†"}],am=n.memo(({currentStage:t,currentXP:s,nextEvolutionXP:r,progressPercent:a,showBondProgress:i=!0})=>{const o=Math.min(t+1,20),l=Ln(o),c=r-s,d=t>=20,{currentBond:m,isLoading:p}=go(),h=n.useMemo(()=>{if(!m?.nextMilestone)return 100;const f=v=>Math.round(25*Math.pow(1.8,v-2)),u=m.level===1?0:f(m.level),y=f(m.level+1)-u,b=m.totalInteractions-u;return Math.min(100,Math.max(0,b/y*100))},[m]);return d?e.jsx(We,{className:"p-5 bg-card/25 backdrop-blur-2xl border-accent/20",children:e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-accent/20 flex items-center justify-center",children:e.jsx(pe,{className:"h-5 w-5 text-accent"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-heading font-bold text-sm",children:"Maximum Evolution!"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Your companion has reached its final form"})]})]})}):e.jsx(We,{className:"p-5 bg-card/25 backdrop-blur-2xl border-primary/20 hover:border-primary/40 transition-all duration-300",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-primary/20 flex items-center justify-center",children:e.jsx(Ts,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-heading font-bold text-sm",children:"Next Evolution"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:l})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Progress"}),e.jsx("span",{className:"font-medium text-primary",children:c>0?`${c} XP needed`:"Ready!"})]}),e.jsx(Hs,{value:a,className:"h-2"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s," / ",r," XP"]})]}),i&&m&&!p&&e.jsx("div",{className:"space-y-2 pt-3 border-t border-border/30",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:m.icon}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Bond: ",m.name]}),m.nextMilestone&&e.jsxs("span",{className:"font-medium text-primary/80",children:["â†’ ",m.nextMilestone.name]})]}),e.jsx(Hs,{value:h,className:"h-1.5 mt-1"})]})]})}),e.jsxs("div",{className:"space-y-2 pt-2 border-t border-border/50",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"Quick XP Tips:"}),e.jsx("div",{className:"space-y-1.5",children:dv.slice(0,3).map((f,u)=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"text-muted-foreground flex items-center gap-1.5",children:[e.jsx("span",{children:f.icon}),f.action]}),e.jsx("span",{className:"font-medium text-primary",children:f.xp})]},u))})]})]})})});am.displayName="NextEvolutionPreview";const nm=n.memo(()=>{const{user:t}=be(),{currentStreak:s=0,multiplier:r=1,nextMilestone:a}=co(),i=new Date,o=i.toLocaleDateString("en-CA"),l=new Date(i.getFullYear(),i.getMonth(),i.getDate()).toISOString(),{data:c}=Ee({queryKey:["xp-breakdown",o,t?.id],queryFn:async()=>{if(!t)return null;const{data:m}=await S.from("xp_events").select("*").eq("user_id",t.id).gte("created_at",l).order("created_at",{ascending:!1});if(!m)return{total:0,byType:{}};const p=m.reduce((f,u)=>(f[u.event_type]=(f[u.event_type]||0)+u.xp_earned,f),{});return{total:m.reduce((f,u)=>f+u.xp_earned,0),byType:p,events:m}},enabled:!!t,staleTime:60*1e3}),d={habit_complete:"Habits",task_complete:"Quests",check_in:"Check-in",evening_reflection:"Evening Reflection",pep_talk:"Pep Talk",pep_talk_listen:"Pep Talk Listen",all_habits_complete:"All Habits Bonus",mission_check_in:"Mission",mission_pep_talk:"Mission",mission_habits_3:"Mission",mission_all_habits:"Mission",mission_profile_update:"Profile Update"};return e.jsx(We,{className:"p-5 md:p-6 bg-card/25 backdrop-blur-2xl border-primary/20 select-none",children:e.jsxs("div",{className:"space-y-4",onContextMenu:m=>m.preventDefault(),children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(pe,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-heading font-black text-lg",children:"Today's XP"}),e.jsxs("p",{className:"text-2xl font-bold text-primary",children:[c?.total||0," XP"]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-accent/10 border border-accent/20",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Gt,{className:"h-5 w-5 text-orange-500"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-bold",children:[s," Day Streak"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[r,"x XP Multiplier"]})]})]}),a.daysRemaining>0&&e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Next milestone"}),e.jsxs("p",{className:"text-sm font-bold",children:[a.daysRemaining," days"]})]})]}),c&&Object.keys(c.byType).length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-bold text-muted-foreground",children:"XP Sources"}),Object.entries(c.byType).map(([m,p])=>e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:d[m]||hs(m)}),e.jsxs("span",{className:"font-bold text-primary",children:["+",p," XP"]})]},m))]}),c&&c.total>0&&e.jsxs("div",{className:"flex items-center gap-2 p-3 rounded-lg bg-primary/5 border border-primary/10",children:[e.jsx(Ts,{className:"h-4 w-4 text-primary"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Keep this up for 7 days = ",(c.total*7).toFixed(0)," XP"]})]})]})})});nm.displayName="XPBreakdown";const uv=()=>{const{user:t}=be(),{toast:s}=Ms(),r=Ae(),{awardCustomXP:a}=Xt(),{checkFirstTimeAchievements:i}=qn(),o=su(),[l,c]=n.useState(null),[d,m]=n.useState(null),{data:p,isLoading:h,error:f}=Ee({queryKey:["daily-missions",o,t?.id],queryFn:async()=>{if(!t)return[];c(null);const{data:v,error:x}=await S.from("daily_missions").select("*").eq("user_id",t.id).eq("mission_date",o);if(x)throw x;if(!v||v.length===0){const{data:w,error:j}=await S.functions.invoke("generate-daily-missions",{body:{userId:t.id}});if(j){console.error("Mission generation failed:",j);const C=j.message||"Unable to refresh missions right now.";throw c(C),new Error(C)}const D=w?.missions||[];if(D.length===0){const C="No missions available right now. Please try again soon.";throw c(C),new Error(C)}return w?.theme&&m(w.theme),D}return c(null),v},enabled:!!t,staleTime:300*1e3,refetchOnWindowFocus:!1});n.useEffect(()=>{f&&s({title:l?"Mission refresh failed":"Unable to load daily missions",description:l||f.message,variant:"destructive"})},[f,l,s]);const u=le({mutationFn:async()=>{if(!t)throw new Error("Not authenticated");c(null);const{data:v,error:x}=await S.functions.invoke("generate-daily-missions",{body:{userId:t.id,forceRegenerate:!0}});if(x){const j=x.message||"Unable to refresh missions right now.";throw c(j),new Error(j)}const w=v?.missions||[];if(w.length===0){const j="No missions were ready. Please try again soon.";throw c(j),new Error(j)}return w},onSuccess:()=>{r.invalidateQueries({queryKey:["daily-missions"]}),s({title:"Daily missions refreshed",description:"Fresh challenges are ready for you!"}),c(null)},onError:v=>{s({title:"Mission refresh failed",description:v.message,variant:"destructive"})}}),g=le({mutationFn:async v=>{if(!t?.id)throw new Error("User not authenticated");const x=p?.find(C=>C.id===v);if(!x)throw new Error("Mission not found");if(x.completed)throw new Error("Mission already completed");const{data:w,error:j}=await S.from("daily_missions").update({completed:!0,completed_at:new Date().toISOString()}).eq("id",v).eq("user_id",t.id).eq("completed",!1).select().maybeSingle();if(j)throw j;if(!w)throw new Error("Mission already completed");await a(x.xp_reward,`mission_${x.mission_type}`,"Mission Complete!",{mission_id:x.id});const{count:D}=await S.from("daily_missions").select("*",{count:"exact",head:!0}).eq("user_id",t.id).eq("completed",!0);return D===1&&await i("mission"),w},onSuccess:()=>{r.invalidateQueries({queryKey:["daily-missions"]}),s({title:"Mission Complete!",description:"XP awarded!"}),io(),window.dispatchEvent(new CustomEvent("quest-completed"))},onError:v=>{s({title:"Mission not completed",description:v.message,variant:"destructive"})}}),y=p?.filter(v=>v.completed).length||0,b=p?.length||0;return{missions:p||[],isLoading:h,completeMission:g.mutateAsync,isCompleting:g.isPending,completedCount:y,totalCount:b,allComplete:y===b&&b>0,regenerateMissions:u.mutateAsync,isRegenerating:u.isPending,generationErrorMessage:l,missionTheme:d}},mv=()=>{const{user:t}=be(),s=Ae(),{data:r,isLoading:a}=Ee({queryKey:["activity-feed",t?.id],queryFn:async()=>{if(!t)return[];const{data:l,error:c}=await S.from("activity_feed").select("*").eq("user_id",t.id).order("created_at",{ascending:!1}).limit(50);if(c)throw c;return l},enabled:!!t}),i=le({mutationFn:async({type:l,data:c})=>{if(!t)throw new Error("Not authenticated");const{data:d,error:m}=await S.from("activity_feed").insert([{user_id:t.id,activity_type:l,activity_data:c}]).select().maybeSingle();if(m)throw m;if(!d)throw new Error("Failed to create activity");return S.functions.invoke("generate-activity-comment",{body:{activityId:d.id}}).then(({error:p})=>{p&&console.error("Failed to generate activity comment:",p)}).catch(p=>{console.error("Activity comment generation failed:",p)}),d},onSuccess:()=>{s.invalidateQueries({queryKey:["activity-feed"]})}}),o=le({mutationFn:async l=>{if(!t)throw new Error("Not authenticated");const{error:c}=await S.from("activity_feed").update({is_read:!0}).eq("id",l).eq("user_id",t.id);if(c)throw c},onSuccess:()=>{s.invalidateQueries({queryKey:["activity-feed"]})}});return{activities:r||[],isLoading:a,logActivity:i.mutate,markAsRead:o.mutate}},pv={0:{name:"Reset Sunday",emoji:"ðŸŒ…",categories:["identity","wellness","growth"]},1:{name:"Momentum Monday",emoji:"ðŸš€",categories:["quick_win","growth","identity"]},2:{name:"Connection Tuesday",emoji:"ðŸ’œ",categories:["connection","gratitude","wellness"]},3:{name:"Wellness Wednesday",emoji:"ðŸ§˜",categories:["wellness","gratitude","quick_win"]},4:{name:"Gratitude Thursday",emoji:"âœ¨",categories:["gratitude","connection","identity"]},5:{name:"Future Friday",emoji:"ðŸ”®",categories:["identity","growth","quick_win"]},6:{name:"Soul Saturday",emoji:"ðŸŒŸ",categories:["wellness","gratitude","connection"]}},hv={identity_complete_all_quests:{activityType:"all_quests_completed"},identity_complete_all_habits:{activityType:"all_habits_completed"},habit_complete_1:{activityType:"habit_completed",validator:(t,s,r)=>s>=r},habit_complete_3:{activityType:"habit_completed",validator:(t,s,r)=>s>=r},habit_complete_5:{activityType:"habit_completed",validator:(t,s,r)=>s>=r},all_habits:{activityType:"all_habits_completed"},habit_early_bird:{activityType:"habit_completed",validator:t=>new Date(t.completedAt||t.timestamp).getHours()<9},habit_night_owl:{activityType:"habit_completed",validator:t=>new Date(t.completedAt||t.timestamp).getHours()>=20},check_in_morning:{activityType:"check_in_completed"},mood_log:{activityType:"mood_logged",validator:(t,s,r)=>s>=r},reflection_write:{activityType:"reflection_created"},reflection_detailed:{activityType:"reflection_created",validator:t=>(t.note||"").split(/\s+/).length>=100},pep_talk_listen:{activityType:"pep_talk_listened"},pep_talk_full:{activityType:"pep_talk_listened",validator:t=>(t.completion||0)>=100},mentor_chat_start:{activityType:"mentor_message_sent"},mentor_chat_deep:{activityType:"mentor_message_sent",validator:(t,s,r)=>s>=r},library_explore:{activityType:"library_visited"},quote_favorite:{activityType:"quote_favorited"},quote_share:{activityType:"quote_shared"},pep_talk_share:{activityType:"pep_talk_shared"},companion_visit:{activityType:"companion_visited"},companion_interact:{activityType:["companion_visited","companion_evolved"],validator:(t,s,r)=>s>=r},challenge_join:{activityType:"challenge_started"},challenge_complete_day:{activityType:"challenge_day_completed"},streak_maintain:{activityType:"habit_completed",validator:t=>(t.currentStreak||0)>0},bonus_habit_streak:{activityType:"habit_completed",validator:t=>(t.currentStreak||0)>=3},bonus_perfect_day:{activityType:"all_habits_completed"},bonus_triple_threat:{activityType:"mission_completed",validator:t=>new Set(t.completedCategories||[]).size>=3}},fv=()=>{const t=new Date().getDay();return pv[t]},gv=()=>{const{user:t}=be(),{activities:s}=mv(),{awardCustomXP:r}=Xt(),{toast:a}=Ms(),i=Ae(),o=new Date,l=o.toLocaleDateString("en-CA"),c=new Date(o.getFullYear(),o.getMonth(),o.getDate()).getTime();n.useEffect(()=>{if(!t||!s||s.length===0)return;let d=!0;return(async()=>{try{const{data:p,error:h}=await S.from("daily_missions").select("*").eq("user_id",t.id).eq("mission_date",l).eq("completed",!1).eq("auto_complete",!0);if(h){console.error("Error fetching missions:",h);return}if(!p||p.length===0||!d)return;const f=s.filter(u=>new Date(u.created_at).getTime()>=c);for(const u of p){if(!d)break;const g=hv[u.mission_type];if(!g)continue;const y=Array.isArray(g.activityType)?g.activityType:[g.activityType],b=f.filter(w=>y.includes(w.activity_type));let v=!1,x=u.progress_current;if(g.validator){for(const w of b)if(g.validator(w.activity_data,x,u.progress_target)&&(x++,x>=u.progress_target)){v=!0;break}}else x=b.length,v=x>=u.progress_target;if(x!==u.progress_current&&d){const{error:w}=await S.from("daily_missions").update({progress_current:x}).eq("id",u.id).eq("user_id",t.id);w||i.invalidateQueries({queryKey:["daily-missions"]})}if(v&&!u.completed&&d){const{data:w,error:j}=await S.from("daily_missions").update({completed:!0,completed_at:new Date().toISOString(),progress_current:u.progress_target}).eq("id",u.id).eq("user_id",t.id).eq("completed",!1).select();!j&&w&&w.length>0&&d&&(await r(u.xp_reward,`mission_${u.mission_type}`,`Mission Complete! ${u.mission_text}`,{mission_id:u.id,source:"auto_complete"}),a({title:"Mission Auto-Completed! ðŸŽ¯",description:`${u.mission_text} (+${u.xp_reward} XP)`}),io(),Ot({particleCount:50,spread:60,origin:{y:.7},colors:["#A76CFF","#C084FC","#E879F9"]}),i.invalidateQueries({queryKey:["daily-missions"]}))}}}catch(p){console.error("Error in mission auto-complete:",p)}})(),()=>{d=!1}},[s,t,l,c,r,a,i])},xv=({onRetry:t,isRetrying:s,errorMessage:r})=>{const a=()=>{!t||s||t()};return e.jsx(We,{className:"p-8 text-center bg-gradient-to-br from-accent/5 to-primary/5 border-dashed border-2 border-muted-foreground/20",children:e.jsxs("div",{className:"flex flex-col items-center gap-4 max-w-md mx-auto",children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-accent/10 flex items-center justify-center animate-pulse",children:e.jsx(At,{className:"h-8 w-8 text-accent"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl font-heading font-bold text-foreground",children:"Missions Refresh Daily"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Complete daily missions to earn bonus XP and help your companion evolve faster! Check back tomorrow for new challenges."})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(pe,{className:"h-3 w-3"}),e.jsx("span",{children:"New missions arrive at midnight"})]}),r&&e.jsx("p",{className:"text-xs text-destructive mt-2",children:r}),t&&e.jsx(U,{variant:"outline",size:"sm",onClick:a,disabled:s,className:"mt-2 gap-2",children:s?e.jsxs(e.Fragment,{children:[e.jsx(Lo,{className:"h-3 w-3 animate-spin"}),"Retrying..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Lo,{className:"h-3 w-3"}),"Try Refresh Again"]})})]})})},im=n.memo(()=>{const{missions:t,isLoading:s,completeMission:r,isCompleting:a,completedCount:i,totalCount:o,allComplete:l,regenerateMissions:c,isRegenerating:d,generationErrorMessage:m,missionTheme:p}=uv();gv();const h=p||fv();if(s)return e.jsx(Zy,{});if(t.length===0)return e.jsx(xv,{onRetry:c,isRetrying:d,errorMessage:m});const f=i/o*100,u=t.filter(v=>!v.is_bonus),g=t.filter(v=>v.is_bonus),y=async v=>{mt.medium();try{await r(v),t.map(j=>j.id===v?{...j,completed:!0}:j).every(j=>j.completed)&&setTimeout(()=>{Ot({particleCount:150,spread:120,origin:{y:.6},colors:["#A76CFF","#C084FC","#E879F9","#FFD700","#FFA500"],ticks:400,gravity:.6,scalar:1.5})},500)}catch(x){console.error("Failed to complete mission:",x),mt.light()}},b=v=>{const x=v.progress_target>1,w=x?v.progress_current/v.progress_target*100:0,j=v.auto_complete;return e.jsxs("div",{onContextMenu:D=>D.preventDefault(),className:`flex items-center justify-between p-2.5 sm:p-3 rounded-lg border transition-all select-none ${v.completed?"bg-accent/5 border-accent/20 opacity-60":"bg-background border-border hover:border-accent/40"} ${v.is_bonus?"border-yellow-500/30 bg-gradient-to-r from-yellow-500/5 to-orange-500/5":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 flex-1 min-w-0",children:[v.completed&&e.jsx(Ar,{className:"h-4 w-4 sm:h-5 sm:w-5 text-accent flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1 flex-wrap",children:[e.jsx("p",{className:`text-sm font-medium ${v.completed?"line-through":""}`,children:v.mission_text}),j&&!v.completed&&e.jsxs(Fe,{variant:"outline",className:"text-xs px-1.5 py-0",children:[e.jsx(ft,{className:"h-2.5 w-2.5 mr-1"}),"Auto"]}),v.is_bonus&&e.jsxs(Fe,{variant:"gold",className:"text-xs px-1.5 py-0",children:[e.jsx(pe,{className:"h-2.5 w-2.5 mr-1"}),"Bonus"]}),v.difficulty==="hard"&&!v.completed&&e.jsxs(Fe,{variant:"outline",className:"text-xs px-1.5 py-0 border-red-500/50 text-red-600",children:[e.jsx(Ts,{className:"h-2.5 w-2.5 mr-1"}),"Hard"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["+",v.xp_reward," XP"]}),x&&!v.completed&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["â€¢ ",v.progress_current,"/",v.progress_target]})]}),x&&!v.completed&&e.jsx(Hs,{value:w,className:"h-1 mt-1.5"})]})]}),!v.completed&&!j&&e.jsx(U,{size:"sm",variant:"outline",onClick:()=>y(v.id),disabled:a,className:"transition-transform hover:scale-105 active:scale-95 hover:bg-accent/10 hover:border-accent/60 min-w-[90px]",children:a?e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-accent border-t-transparent"}):"Complete"})]},v.id)};return e.jsxs(We,{className:"p-4 sm:p-5 md:p-6 bg-card/25 backdrop-blur-2xl border-accent/20 hover:border-accent/40 transition-all duration-500 hover:shadow-[0_0_40px_hsl(var(--accent)/0.15)] relative overflow-hidden group",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-accent/10 to-primary/10 pointer-events-none"}),e.jsxs("div",{className:"relative space-y-3 sm:space-y-4 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("div",{className:"h-9 w-9 sm:h-10 sm:w-10 rounded-full bg-accent/20 flex items-center justify-center flex-shrink-0",children:e.jsx(At,{className:"h-4 w-4 sm:h-5 sm:w-5 text-accent"})}),e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("h3",{className:"font-heading font-black text-base sm:text-lg",children:"Daily Missions"})}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-0.5",children:[e.jsx("span",{className:"text-sm",children:h.emoji}),e.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:h.name})]})]}),e.jsxs("p",{className:"text-[10px] sm:text-xs text-muted-foreground ml-auto",children:[i,"/",o," complete"]})]}),l&&e.jsx("div",{className:"text-[10px] sm:text-xs font-bold text-stardust-gold animate-pulse",children:"All Done! ðŸŽ‰"})]}),e.jsx(Hs,{value:f,className:"h-2"}),e.jsx("div",{className:"space-y-2",children:u.map(b)}),g.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsx(pe,{className:"h-3.5 w-3.5 text-stardust-gold"}),e.jsx("span",{className:"text-xs font-semibold text-stardust-gold",children:"Streak Bonus"})]}),g.map(b)]})]})]})});im.displayName="DailyMissionsContent";const om=n.memo(()=>e.jsx(es,{fallback:e.jsx(_x,{}),children:e.jsx(im,{})}));om.displayName="DailyMissions";const xo=Qh,Fn=n.forwardRef(({className:t,...s},r)=>e.jsx(sd,{ref:r,className:A("inline-flex h-11 items-center justify-center rounded-xl border border-border/50 bg-muted/45 p-1 text-muted-foreground backdrop-blur-sm",t),...s}));Fn.displayName=sd.displayName;const Ns=n.forwardRef(({className:t,...s},r)=>e.jsx(rd,{ref:r,className:A("inline-flex items-center justify-center whitespace-nowrap rounded-[10px] px-3 py-1.5 text-sm font-medium ring-offset-background transition-colors data-[state=active]:bg-card data-[state=active]:text-foreground data-[state=active]:shadow-[0_4px_12px_rgba(0,0,0,0.18)] data-[state=active]:border data-[state=active]:border-border/60 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",t),...s}));Ns.displayName=rd.displayName;const ks=n.forwardRef(({className:t,...s},r)=>e.jsx(ad,{ref:r,className:A("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...s}));ks.displayName=ad.displayName;const Za=[{id:"three_day_streak",achievementType:"streak_3_day",title:"Getting Started",description:"Maintained a 3-day streak",icon:"ðŸ”¥",tier:"bronze",category:"streaks",unlockHint:"Maintain a 3-day streak"},{id:"week_streak",achievementType:"streak_7_day",title:"Week of Discipline",description:"Maintained a 7-day streak",icon:"ðŸ†",tier:"silver",category:"streaks",unlockHint:"Maintain a 7-day streak"},{id:"two_week_streak",achievementType:"streak_14_day",title:"Fortnight Force",description:"Maintained a 14-day streak",icon:"âš¡",tier:"gold",category:"streaks",unlockHint:"Maintain a 14-day streak"},{id:"month_streak",achievementType:"streak_30_day",title:"Monthly Master",description:"Maintained a 30-day streak",icon:"ðŸ‘‘",tier:"platinum",category:"streaks",unlockHint:"Maintain a 30-day streak"},{id:"companion_stage_3",achievementType:"companion_stage_3",title:"First Evolution",description:"Reached companion stage 3",icon:"âœ¨",tier:"bronze",category:"companion",unlockHint:"Evolve your companion to Stage 3 (Cub)"},{id:"companion_stage_5",achievementType:"companion_stage_5",title:"Rising Star",description:"Reached companion stage 5",icon:"ðŸŒŸ",tier:"silver",category:"companion",unlockHint:"Evolve your companion to Stage 5 (Apprentice)"},{id:"companion_stage_10",achievementType:"companion_stage_10",title:"Champion Bond",description:"Reached companion stage 10",icon:"ðŸ…",tier:"gold",category:"companion",unlockHint:"Evolve your companion to Stage 10 (Champion)"},{id:"companion_stage_15",achievementType:"companion_stage_15",title:"Prime Evolution",description:"Reached companion stage 15",icon:"ðŸ’Ž",tier:"platinum",category:"companion",unlockHint:"Evolve your companion to Stage 15 (Prime)"},{id:"companion_stage_20",achievementType:"companion_stage_20",title:"Ultimate Form",description:"Reached companion stage 20",icon:"ðŸŒŒ",tier:"platinum",category:"companion",unlockHint:"Evolve your companion to Stage 20 (Ultimate)"},{id:"first_habit",achievementType:"first_habit",title:"Habit Starter",description:"Completed your first habit",icon:"âœ…",tier:"bronze",category:"firsts",unlockHint:"Complete your first habit"},{id:"first_quest",achievementType:"first_quest",title:"Quest Beginner",description:"Completed your first quest",icon:"âš”ï¸",tier:"bronze",category:"firsts",unlockHint:"Complete your first quest"},{id:"first_pep_talk",achievementType:"first_pep_talk",title:"First Listen",description:"Listened to your first pep talk",icon:"ðŸŽ§",tier:"bronze",category:"firsts",unlockHint:"Listen to a pep talk"},{id:"first_check_in",achievementType:"first_check_in",title:"Self Aware",description:"Completed your first check-in",icon:"ðŸªž",tier:"bronze",category:"firsts",unlockHint:"Complete a daily check-in"},{id:"first_epic",achievementType:"first_epic",title:"Epic Starter",description:"Created your first epic",icon:"ðŸš€",tier:"bronze",category:"firsts",unlockHint:"Create your first epic"},{id:"starpath_detox_warrior",achievementType:"starpath_detox_warrior",title:"Detox Warrior",description:"Completed the Detox Warrior star path",icon:"âš”ï¸",tier:"silver",category:"starpaths",unlockHint:"Complete the Detox Warrior star path"},{id:"starpath_dawn_champion",achievementType:"starpath_dawn_champion",title:"Dawn Champion",description:"Completed the Dawn Champion star path",icon:"ðŸŒ…",tier:"silver",category:"starpaths",unlockHint:"Complete the Dawn Champion star path"},{id:"starpath_mindful_master",achievementType:"starpath_mindful_master",title:"Mindful Master",description:"Completed the Mindful Master star path",icon:"ðŸ§˜",tier:"silver",category:"starpaths",unlockHint:"Complete the Mindful Master star path"},{id:"starpath_iron_mind",achievementType:"starpath_iron_mind",title:"Iron Mind",description:"Completed the Iron Mind star path",icon:"ðŸ§ ",tier:"gold",category:"starpaths",unlockHint:"Complete the Iron Mind star path"},{id:"starpath_body_forge",achievementType:"starpath_body_forge",title:"Body Forge",description:"Completed the Body Forge star path",icon:"ðŸ’ª",tier:"gold",category:"starpaths",unlockHint:"Complete the Body Forge star path"},{id:"starpath_clean_machine",achievementType:"starpath_clean_machine",title:"Clean Machine",description:"Completed the Clean Machine star path",icon:"ðŸ¥—",tier:"gold",category:"starpaths",unlockHint:"Complete the Clean Machine star path"},{id:"starpath_digital_minimalist",achievementType:"starpath_digital_minimalist",title:"Digital Minimalist",description:"Completed the Digital Minimalist star path",icon:"ðŸ“µ",tier:"gold",category:"starpaths",unlockHint:"Complete the Digital Minimalist star path"},{id:"starpath_scholars_path",achievementType:"starpath_scholars_path",title:"Scholar's Path",description:"Completed the Scholar's Path star path",icon:"ðŸ“š",tier:"platinum",category:"starpaths",unlockHint:"Complete the Scholar's Path star path"},{id:"starpath_sleep_sovereign",achievementType:"starpath_sleep_sovereign",title:"Sleep Sovereign",description:"Completed the Sleep Sovereign star path",icon:"ðŸ˜´",tier:"platinum",category:"starpaths",unlockHint:"Complete the Sleep Sovereign star path"},{id:"starpath_social_butterfly",achievementType:"starpath_social_butterfly",title:"Social Butterfly",description:"Completed the Social Butterfly star path",icon:"ðŸ¦‹",tier:"platinum",category:"starpaths",unlockHint:"Complete the Social Butterfly star path"},{id:"story_treasure_hunt",achievementType:"story_treasure_hunt_complete",title:"Fortune Seeker",description:"Completed a Treasure Hunt epic and defeated the boss",icon:"ðŸ’Ž",tier:"gold",category:"starpaths",unlockHint:"Complete a Treasure Hunt star path and defeat the final boss"},{id:"story_mystery",achievementType:"story_mystery_complete",title:"Truth Unveiler",description:"Completed a Mystery epic and defeated the boss",icon:"ðŸ”®",tier:"gold",category:"starpaths",unlockHint:"Complete a Mystery star path and defeat the final boss"},{id:"story_pilgrimage",achievementType:"story_pilgrimage_complete",title:"Soul Pilgrim",description:"Completed a Pilgrimage epic and defeated the boss",icon:"ðŸ§˜",tier:"gold",category:"starpaths",unlockHint:"Complete a Pilgrimage star path and defeat the final boss"},{id:"story_heroes_journey",achievementType:"story_heroes_journey_complete",title:"Legendary Hero",description:"Completed a Heroes Journey epic and defeated the boss",icon:"âš”ï¸",tier:"platinum",category:"starpaths",unlockHint:"Complete a Heroes Journey star path and defeat the final boss"},{id:"story_rescue_mission",achievementType:"story_rescue_mission_complete",title:"Cosmic Savior",description:"Completed a Rescue Mission epic and defeated the boss",icon:"ðŸ›¡ï¸",tier:"gold",category:"starpaths",unlockHint:"Complete a Rescue Mission star path and defeat the final boss"},{id:"story_exploration",achievementType:"story_exploration_complete",title:"Star Cartographer",description:"Completed an Exploration epic and defeated the boss",icon:"ðŸŒŒ",tier:"gold",category:"starpaths",unlockHint:"Complete an Exploration star path and defeat the final boss"},{id:"challenge_complete",achievementType:"challenge_complete",title:"Challenge Accepted",description:"Completed a challenge",icon:"ðŸŽ¯",tier:"silver",category:"challenges",unlockHint:"Complete any challenge"},{id:"challenge_5",achievementType:"challenge_5_complete",title:"Challenge Seeker",description:"Completed 5 challenges",icon:"ðŸ¹",tier:"gold",category:"challenges",unlockHint:"Complete 5 challenges"},{id:"perfect_day",achievementType:"perfect_day",title:"Perfect Day",description:"Completed all daily activities",icon:"ðŸŒˆ",tier:"gold",category:"special",unlockHint:"Complete all quests, habits, and check-in in one day"},{id:"comeback",achievementType:"comeback",title:"Comeback King",description:"Returned after a break",icon:"ðŸ¦‹",tier:"silver",category:"special",unlockHint:"Return to the app after 7+ days away"},{id:"story_reader",achievementType:"story_chapter",title:"Story Lover",description:"Read a companion story chapter",icon:"ðŸ“–",tier:"bronze",category:"special",unlockHint:"Read a companion story chapter"},{id:"full_storyline",achievementType:"full_storyline",title:"Lore Master",description:"Read all available story chapters",icon:"ðŸ“š",tier:"platinum",category:"special",unlockHint:"Read all companion story chapters"},{id:"attribute_master_mind",achievementType:"attribute_master_mind",title:"Mind Master",description:"Reached 100 Mind attribute",icon:"ðŸ§ ",tier:"gold",category:"special",unlockHint:"Reach 100 Mind attribute"},{id:"attribute_master_body",achievementType:"attribute_master_body",title:"Body Master",description:"Reached 100 Body attribute",icon:"ðŸ’ª",tier:"gold",category:"special",unlockHint:"Reach 100 Body attribute"},{id:"attribute_master_soul",achievementType:"attribute_master_soul",title:"Soul Master",description:"Reached 100 Soul attribute",icon:"âœ¨",tier:"gold",category:"special",unlockHint:"Reach 100 Soul attribute"},{id:"total_attributes",achievementType:"total_attributes_250",title:"Well Rounded",description:"Reached 250 total attributes",icon:"â­",tier:"platinum",category:"special",unlockHint:"Reach 250 combined Mind/Body/Soul"},{id:"pep_talk_listener_10",achievementType:"pep_talk_listener_10",title:"Avid Listener",description:"Listened to 10 pep talks",icon:"ðŸŽµ",tier:"silver",category:"special",unlockHint:"Listen to 10 pep talks"},{id:"pep_talk_listener_50",achievementType:"pep_talk_listener_50",title:"Wisdom Seeker",description:"Listened to 50 pep talks",icon:"ðŸŽ¶",tier:"gold",category:"special",unlockHint:"Listen to 50 pep talks"},{id:"arcade_explorer",achievementType:"arcade_explorer",title:"Arcade Explorer",description:"Discovered the hidden Astral Arcade",icon:"ðŸ•¹ï¸",tier:"silver",category:"special",unlockHint:"???"},{id:"astral_distraction_3",achievementType:"astral_distraction_3",title:"Focus Initiate",description:"Defeated 3 Distraction adversaries",icon:"ðŸŽ¯",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Distraction-themed adversaries"},{id:"astral_distraction_10",achievementType:"astral_distraction_10",title:"Focus Warrior",description:"Defeated 10 Distraction adversaries",icon:"ðŸŽ¯",tier:"silver",category:"astral",unlockHint:"Defeat 10 Distraction-themed adversaries"},{id:"astral_distraction_25",achievementType:"astral_distraction_25",title:"Focus Champion",description:"Defeated 25 Distraction adversaries",icon:"ðŸŽ¯",tier:"gold",category:"astral",unlockHint:"Defeat 25 Distraction-themed adversaries"},{id:"astral_distraction_50",achievementType:"astral_distraction_50",title:"Focus Transcendent",description:"Defeated 50 Distraction adversaries",icon:"ðŸŽ¯",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Distraction-themed adversaries"},{id:"astral_stagnation_3",achievementType:"astral_stagnation_3",title:"Momentum Starter",description:"Defeated 3 Stagnation adversaries",icon:"ðŸŒŠ",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Stagnation-themed adversaries"},{id:"astral_stagnation_10",achievementType:"astral_stagnation_10",title:"Momentum Warrior",description:"Defeated 10 Stagnation adversaries",icon:"ðŸŒŠ",tier:"silver",category:"astral",unlockHint:"Defeat 10 Stagnation-themed adversaries"},{id:"astral_stagnation_25",achievementType:"astral_stagnation_25",title:"Momentum Champion",description:"Defeated 25 Stagnation adversaries",icon:"ðŸŒŠ",tier:"gold",category:"astral",unlockHint:"Defeat 25 Stagnation-themed adversaries"},{id:"astral_stagnation_50",achievementType:"astral_stagnation_50",title:"Momentum Transcendent",description:"Defeated 50 Stagnation adversaries",icon:"ðŸŒŠ",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Stagnation-themed adversaries"},{id:"astral_anxiety_3",achievementType:"astral_anxiety_3",title:"Serenity Seeker",description:"Defeated 3 Anxiety adversaries",icon:"ðŸ§˜",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Anxiety-themed adversaries"},{id:"astral_anxiety_10",achievementType:"astral_anxiety_10",title:"Serenity Warrior",description:"Defeated 10 Anxiety adversaries",icon:"ðŸ§˜",tier:"silver",category:"astral",unlockHint:"Defeat 10 Anxiety-themed adversaries"},{id:"astral_anxiety_25",achievementType:"astral_anxiety_25",title:"Serenity Champion",description:"Defeated 25 Anxiety adversaries",icon:"ðŸ§˜",tier:"gold",category:"astral",unlockHint:"Defeat 25 Anxiety-themed adversaries"},{id:"astral_anxiety_50",achievementType:"astral_anxiety_50",title:"Serenity Transcendent",description:"Defeated 50 Anxiety adversaries",icon:"ðŸ§˜",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Anxiety-themed adversaries"},{id:"astral_doubt_3",achievementType:"astral_doubt_3",title:"Confidence Seeker",description:"Defeated 3 Doubt adversaries",icon:"ðŸ’ª",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Doubt-themed adversaries"},{id:"astral_doubt_10",achievementType:"astral_doubt_10",title:"Confidence Warrior",description:"Defeated 10 Doubt adversaries",icon:"ðŸ’ª",tier:"silver",category:"astral",unlockHint:"Defeat 10 Doubt-themed adversaries"},{id:"astral_doubt_25",achievementType:"astral_doubt_25",title:"Confidence Champion",description:"Defeated 25 Doubt adversaries",icon:"ðŸ’ª",tier:"gold",category:"astral",unlockHint:"Defeat 25 Doubt-themed adversaries"},{id:"astral_doubt_50",achievementType:"astral_doubt_50",title:"Confidence Transcendent",description:"Defeated 50 Doubt adversaries",icon:"ðŸ’ª",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Doubt-themed adversaries"},{id:"astral_chaos_3",achievementType:"astral_chaos_3",title:"Order Initiate",description:"Defeated 3 Chaos adversaries",icon:"âš¡",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Chaos-themed adversaries"},{id:"astral_chaos_10",achievementType:"astral_chaos_10",title:"Order Warrior",description:"Defeated 10 Chaos adversaries",icon:"âš¡",tier:"silver",category:"astral",unlockHint:"Defeat 10 Chaos-themed adversaries"},{id:"astral_chaos_25",achievementType:"astral_chaos_25",title:"Order Champion",description:"Defeated 25 Chaos adversaries",icon:"âš¡",tier:"gold",category:"astral",unlockHint:"Defeat 25 Chaos-themed adversaries"},{id:"astral_chaos_50",achievementType:"astral_chaos_50",title:"Order Transcendent",description:"Defeated 50 Chaos adversaries",icon:"âš¡",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Chaos-themed adversaries"},{id:"astral_laziness_3",achievementType:"astral_laziness_3",title:"Drive Initiate",description:"Defeated 3 Laziness adversaries",icon:"ðŸ”¥",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Laziness-themed adversaries"},{id:"astral_laziness_10",achievementType:"astral_laziness_10",title:"Drive Warrior",description:"Defeated 10 Laziness adversaries",icon:"ðŸ”¥",tier:"silver",category:"astral",unlockHint:"Defeat 10 Laziness-themed adversaries"},{id:"astral_laziness_25",achievementType:"astral_laziness_25",title:"Drive Champion",description:"Defeated 25 Laziness adversaries",icon:"ðŸ”¥",tier:"gold",category:"astral",unlockHint:"Defeat 25 Laziness-themed adversaries"},{id:"astral_laziness_50",achievementType:"astral_laziness_50",title:"Drive Transcendent",description:"Defeated 50 Laziness adversaries",icon:"ðŸ”¥",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Laziness-themed adversaries"},{id:"astral_overthinking_3",achievementType:"astral_overthinking_3",title:"Clarity Seeker",description:"Defeated 3 Overthinking adversaries",icon:"ðŸ§ ",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Overthinking-themed adversaries"},{id:"astral_overthinking_10",achievementType:"astral_overthinking_10",title:"Clarity Warrior",description:"Defeated 10 Overthinking adversaries",icon:"ðŸ§ ",tier:"silver",category:"astral",unlockHint:"Defeat 10 Overthinking-themed adversaries"},{id:"astral_overthinking_25",achievementType:"astral_overthinking_25",title:"Clarity Champion",description:"Defeated 25 Overthinking adversaries",icon:"ðŸ§ ",tier:"gold",category:"astral",unlockHint:"Defeat 25 Overthinking-themed adversaries"},{id:"astral_overthinking_50",achievementType:"astral_overthinking_50",title:"Clarity Transcendent",description:"Defeated 50 Overthinking adversaries",icon:"ðŸ§ ",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Overthinking-themed adversaries"},{id:"astral_fear_3",achievementType:"astral_fear_3",title:"Courage Initiate",description:"Defeated 3 Fear adversaries",icon:"ðŸ›¡ï¸",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Fear-themed adversaries"},{id:"astral_fear_10",achievementType:"astral_fear_10",title:"Courage Warrior",description:"Defeated 10 Fear adversaries",icon:"ðŸ›¡ï¸",tier:"silver",category:"astral",unlockHint:"Defeat 10 Fear-themed adversaries"},{id:"astral_fear_25",achievementType:"astral_fear_25",title:"Courage Champion",description:"Defeated 25 Fear adversaries",icon:"ðŸ›¡ï¸",tier:"gold",category:"astral",unlockHint:"Defeat 25 Fear-themed adversaries"},{id:"astral_fear_50",achievementType:"astral_fear_50",title:"Courage Transcendent",description:"Defeated 50 Fear adversaries",icon:"ðŸ›¡ï¸",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Fear-themed adversaries"},{id:"astral_confusion_3",achievementType:"astral_confusion_3",title:"Wisdom Initiate",description:"Defeated 3 Confusion adversaries",icon:"âœ¨",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Confusion-themed adversaries"},{id:"astral_confusion_10",achievementType:"astral_confusion_10",title:"Wisdom Warrior",description:"Defeated 10 Confusion adversaries",icon:"âœ¨",tier:"silver",category:"astral",unlockHint:"Defeat 10 Confusion-themed adversaries"},{id:"astral_confusion_25",achievementType:"astral_confusion_25",title:"Wisdom Champion",description:"Defeated 25 Confusion adversaries",icon:"âœ¨",tier:"gold",category:"astral",unlockHint:"Defeat 25 Confusion-themed adversaries"},{id:"astral_confusion_50",achievementType:"astral_confusion_50",title:"Wisdom Transcendent",description:"Defeated 50 Confusion adversaries",icon:"âœ¨",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Confusion-themed adversaries"},{id:"astral_vulnerability_3",achievementType:"astral_vulnerability_3",title:"Resilience Initiate",description:"Defeated 3 Vulnerability adversaries",icon:"ðŸ’Ž",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Vulnerability-themed adversaries"},{id:"astral_vulnerability_10",achievementType:"astral_vulnerability_10",title:"Resilience Warrior",description:"Defeated 10 Vulnerability adversaries",icon:"ðŸ’Ž",tier:"silver",category:"astral",unlockHint:"Defeat 10 Vulnerability-themed adversaries"},{id:"astral_vulnerability_25",achievementType:"astral_vulnerability_25",title:"Resilience Champion",description:"Defeated 25 Vulnerability adversaries",icon:"ðŸ’Ž",tier:"gold",category:"astral",unlockHint:"Defeat 25 Vulnerability-themed adversaries"},{id:"astral_vulnerability_50",achievementType:"astral_vulnerability_50",title:"Resilience Transcendent",description:"Defeated 50 Vulnerability adversaries",icon:"ðŸ’Ž",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Vulnerability-themed adversaries"},{id:"astral_imbalance_3",achievementType:"astral_imbalance_3",title:"Harmony Initiate",description:"Defeated 3 Imbalance adversaries",icon:"â˜¯ï¸",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Imbalance-themed adversaries"},{id:"astral_imbalance_10",achievementType:"astral_imbalance_10",title:"Harmony Warrior",description:"Defeated 10 Imbalance adversaries",icon:"â˜¯ï¸",tier:"silver",category:"astral",unlockHint:"Defeat 10 Imbalance-themed adversaries"},{id:"astral_imbalance_25",achievementType:"astral_imbalance_25",title:"Harmony Champion",description:"Defeated 25 Imbalance adversaries",icon:"â˜¯ï¸",tier:"gold",category:"astral",unlockHint:"Defeat 25 Imbalance-themed adversaries"},{id:"astral_imbalance_50",achievementType:"astral_imbalance_50",title:"Harmony Transcendent",description:"Defeated 50 Imbalance adversaries",icon:"â˜¯ï¸",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Imbalance-themed adversaries"}],yv={streaks:"Streaks",companion:"Companion",starpaths:"Star Paths",challenges:"Challenges",firsts:"First Steps",special:"Special",astral:"Astral Hunters"},lm={bronze:"from-orange-500 to-orange-700",silver:"from-gray-300 to-gray-500",gold:"from-yellow-400 to-yellow-600",platinum:"from-purple-400 to-purple-600"},bv=()=>{const{user:t}=be(),[s,r]=n.useState("all"),[a,i]=n.useState(null),{data:o,isLoading:l}=Ee({queryKey:["achievements",t?.id],enabled:!!t,queryFn:async()=>{if(!t?.id)return[];const{data:g,error:y}=await S.from("achievements").select("achievement_type, earned_at").eq("user_id",t.id);if(y)throw y;return g||[]}}),c=n.useMemo(()=>new Set(o?.map(g=>g.achievement_type)||[]),[o]),d=n.useMemo(()=>s==="all"?Za:Za.filter(g=>g.category===s),[s]),m=n.useMemo(()=>d.filter(g=>c.has(g.achievementType)),[d,c]),p=n.useMemo(()=>d.filter(g=>!c.has(g.achievementType)),[d,c]),h=Za.filter(g=>c.has(g.achievementType)).length,f=Za.length,u=["all","streaks","companion","starpaths","firsts","special"];return l?e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsx(je,{className:"h-24 w-full"}),e.jsx(je,{className:"h-12 w-full"}),e.jsx(je,{className:"h-48 w-full"})]}):e.jsxs("div",{className:"space-y-6 mt-6",children:[e.jsxs(We,{className:"p-6 bg-gradient-to-br from-primary/10 to-accent/10 border-primary/20",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(Mi,{className:"h-6 w-6 text-primary"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Your Badges"})]}),e.jsxs("p",{className:"text-2xl font-bold",children:[e.jsx("span",{className:"text-primary",children:h}),e.jsxs("span",{className:"text-muted-foreground text-lg font-normal",children:[" / ",f," collected"]})]})]}),e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 scrollbar-hide",children:u.map(g=>e.jsx("button",{onClick:()=>r(g),className:`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${s===g?"bg-primary text-primary-foreground":"bg-secondary/50 text-muted-foreground hover:bg-secondary"}`,children:g==="all"?"All":yv[g]},g))}),m.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"text-sm font-semibold text-muted-foreground flex items-center gap-2",children:[e.jsx("span",{className:"text-primary",children:"âœ¨"})," EARNED (",m.length,")"]}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 gap-3",children:m.map(g=>e.jsx(Dl,{badge:g,earned:!0,onSelect:y=>i({badge:y,earned:!0})},g.id))})]}),p.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"text-sm font-semibold text-muted-foreground flex items-center gap-2",children:[e.jsx(jn,{className:"h-4 w-4"})," LOCKED (",p.length,")"]}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 gap-3",children:p.map(g=>e.jsx(Dl,{badge:g,earned:!1,onSelect:y=>i({badge:y,earned:!1})},g.id))})]}),d.length===0&&e.jsxs(We,{className:"p-8 text-center",children:[e.jsx(Mi,{className:"h-12 w-12 mx-auto mb-3 text-muted-foreground/50"}),e.jsx("p",{className:"text-muted-foreground",children:"No badges in this category yet"})]}),e.jsx(ns,{open:!!a,onOpenChange:()=>i(null),children:e.jsxs(Vt,{className:"max-w-[300px] rounded-xl",children:[e.jsx(Bs,{children:e.jsx(xs,{className:"text-center",children:a?.earned?a.badge.title:"Locked Badge"})}),a&&e.jsxs("div",{className:"text-center space-y-4 py-2",children:[e.jsx("div",{className:`text-6xl ${a.earned?"":"grayscale"}`,children:a.earned?a.badge.icon:"ðŸ”’"}),a.earned?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-muted-foreground",children:a.badge.description}),e.jsx(Fe,{className:`capitalize bg-gradient-to-br ${lm[a.badge.tier]} text-white border-0`,children:a.badge.tier})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"How to unlock:"}),e.jsx("p",{className:"text-muted-foreground",children:a.badge.unlockHint})]})]})]})})]})},Dl=({badge:t,earned:s,onSelect:r})=>{const a=lm[t.tier];return e.jsxs(We,{onClick:()=>r(t),className:`relative p-3 text-center transition-all cursor-pointer active:scale-95 ${s?"bg-gradient-to-br from-primary/10 to-accent/10 border-primary/30 hover:border-primary/50":"bg-secondary/30 border-border/50 opacity-60 hover:opacity-80"}`,children:[e.jsx("div",{className:`text-3xl mb-2 ${s?"":"grayscale"}`,children:s?t.icon:"ðŸ”’"}),e.jsx("p",{className:`text-xs font-medium line-clamp-2 ${s?"text-foreground":"text-muted-foreground"}`,children:s?t.title:"???"}),s&&e.jsx("div",{className:`absolute top-1 right-1 w-2 h-2 rounded-full bg-gradient-to-br ${a}`})]})},cm=()=>{const t=n.useCallback(()=>{mt.light()},[]),s=n.useCallback(()=>{mt.medium()},[]),r=n.useCallback(()=>{mt.heavy()},[]),a=n.useCallback(()=>{mt.success()},[]),i=n.useCallback(()=>{mt.error()},[]),o=n.useCallback(()=>{mt.light()},[]),l=n.useCallback(()=>{mt.medium()},[]),c=n.useCallback(()=>{mt.success()},[]),d=n.useCallback(()=>{mt.error()},[]),m=n.useCallback(p=>{p?mt.light():mt.medium()},[]);return{light:t,medium:s,heavy:r,success:a,error:i,tap:o,press:l,complete:c,fail:d,toggle:m}},vv=({cssEffect:t,className:s})=>{const{cornerStyle:r,glowColor:a,glowAnimation:i}=t;if(!r)return null;const o=i==="pulse"?"animate-frame-pulse":i==="breathe"?"animate-frame-breathe":i==="flicker"?"animate-frame-flicker":"";return e.jsxs("div",{className:A("absolute inset-0 pointer-events-none z-30",s),children:[e.jsx(en,{position:"top-left",cornerStyle:r,glowColor:a,glowClass:o}),e.jsx(en,{position:"top-right",cornerStyle:r,glowColor:a,glowClass:o}),e.jsx(en,{position:"bottom-left",cornerStyle:r,glowColor:a,glowClass:o}),e.jsx(en,{position:"bottom-right",cornerStyle:r,glowColor:a,glowClass:o})]})},en=({position:t,cornerStyle:s,glowColor:r,glowClass:a})=>{const i={"top-left":"top-0 left-0","top-right":"top-0 right-0","bottom-left":"bottom-0 left-0","bottom-right":"bottom-0 right-0"},o={"top-left":"rotate-0","top-right":"rotate-90","bottom-left":"-rotate-90","bottom-right":"rotate-180"},l=wv(s,r);return e.jsx("div",{className:A("absolute w-14 h-14",i[t],o[t],a),style:{filter:r?`drop-shadow(0 0 6px ${r})`:void 0},children:l})},wv=(t,s)=>{const r=s||"hsl(var(--primary))";switch(t){case"ornate":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 4 L20 4 Q28 4 28 12 L28 20 Q28 28 20 28 L12 28 Q4 28 4 20 Z",fill:"none",stroke:r,strokeWidth:"2",className:"animate-frame-shimmer"}),e.jsx("circle",{cx:"8",cy:"8",r:"3",fill:r}),e.jsx("path",{d:"M12 4 Q16 8 12 12 Q8 8 12 4",fill:r,opacity:"0.6"})]});case"crystal":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("polygon",{points:"4,4 20,4 4,20",fill:r,opacity:"0.3"}),e.jsx("polygon",{points:"4,4 16,4 4,16",fill:r,opacity:"0.5"}),e.jsx("polygon",{points:"4,4 12,4 4,12",fill:r,opacity:"0.7"}),e.jsx("line",{x1:"4",y1:"4",x2:"24",y2:"24",stroke:r,strokeWidth:"1",opacity:"0.4"})]});case"flame":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M8 28 Q8 16 16 8 Q12 16 16 20 Q16 12 24 8 Q20 16 20 24 Q28 16 28 8",fill:"none",stroke:r,strokeWidth:"2",className:"animate-frame-flicker"}),e.jsx("circle",{cx:"12",cy:"20",r:"2",fill:r,opacity:"0.8"}),e.jsx("circle",{cx:"20",cy:"12",r:"1.5",fill:r,opacity:"0.6"})]});case"circuit":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 24 L4 8 L8 4 L24 4",fill:"none",stroke:r,strokeWidth:"2"}),e.jsx("circle",{cx:"8",cy:"8",r:"3",fill:r}),e.jsx("path",{d:"M8 16 L16 16 L16 8",fill:"none",stroke:r,strokeWidth:"1.5",opacity:"0.6"}),e.jsx("circle",{cx:"16",cy:"16",r:"2",fill:r,opacity:"0.6"})]});case"scale":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("ellipse",{cx:"8",cy:"8",rx:"6",ry:"4",fill:r,opacity:"0.3",transform:"rotate(-45 8 8)"}),e.jsx("ellipse",{cx:"16",cy:"8",rx:"6",ry:"4",fill:r,opacity:"0.4",transform:"rotate(-45 16 8)"}),e.jsx("ellipse",{cx:"8",cy:"16",rx:"6",ry:"4",fill:r,opacity:"0.4",transform:"rotate(-45 8 16)"}),e.jsx("ellipse",{cx:"16",cy:"16",rx:"6",ry:"4",fill:r,opacity:"0.5",transform:"rotate(-45 16 16)"})]});case"deity":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 4 C12 4 16 8 20 4 C16 12 20 16 16 24 L8 28 L4 20 Z",fill:r,opacity:"0.4"}),e.jsx("circle",{cx:"12",cy:"12",r:"4",fill:r,opacity:"0.7"}),e.jsx("path",{d:"M4 8 L8 4 M8 8 L12 4 M12 8 L16 4",stroke:r,strokeWidth:"1",opacity:"0.5"})]});case"dimensional":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"dimGrad",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"hsl(300, 80%, 55%)"}),e.jsx("stop",{offset:"50%",stopColor:"hsl(180, 80%, 55%)"}),e.jsx("stop",{offset:"100%",stopColor:"hsl(60, 80%, 55%)"})]})}),e.jsx("path",{d:"M4 4 L24 4 M4 4 L4 24",stroke:"url(#dimGrad)",strokeWidth:"3",className:"animate-frame-shift"}),e.jsx("polygon",{points:"4,4 12,8 8,12",fill:"url(#dimGrad)",opacity:"0.6"}),e.jsx("circle",{cx:"16",cy:"16",r:"3",fill:"url(#dimGrad)",opacity:"0.4"})]});case"treasure":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 16 L4 4 L16 4",fill:"none",stroke:r,strokeWidth:"3"}),e.jsx("polygon",{points:"8,8 12,4 16,8 12,12",fill:r}),e.jsx("circle",{cx:"12",cy:"8",r:"2",fill:"hsl(45, 100%, 80%)"})]});case"mystery":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("circle",{cx:"16",cy:"16",r:"10",fill:"none",stroke:r,strokeWidth:"2",opacity:"0.4"}),e.jsx("circle",{cx:"16",cy:"16",r:"6",fill:"none",stroke:r,strokeWidth:"2",opacity:"0.6"}),e.jsx("line",{x1:"4",y1:"4",x2:"10",y2:"10",stroke:r,strokeWidth:"3"}),e.jsx("circle",{cx:"6",cy:"6",r:"3",fill:r})]});case"lotus":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("ellipse",{cx:"12",cy:"16",rx:"6",ry:"10",fill:r,opacity:"0.3",transform:"rotate(-30 12 16)"}),e.jsx("ellipse",{cx:"16",cy:"12",rx:"6",ry:"10",fill:r,opacity:"0.4",transform:"rotate(-60 16 12)"}),e.jsx("circle",{cx:"10",cy:"10",r:"4",fill:r,opacity:"0.6"})]});case"heroic":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 4 L4 20 L8 24 L12 20 L12 8 L20 4 L4 4",fill:r,opacity:"0.4"}),e.jsx("path",{d:"M8 8 L8 16 L12 12 L12 8 Z",fill:r,opacity:"0.6"}),e.jsx("line",{x1:"8",y1:"4",x2:"8",y2:"12",stroke:r,strokeWidth:"2"})]});case"shield":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M12 4 L4 8 L4 20 L12 28 L20 20 L20 8 L12 4",fill:r,opacity:"0.3"}),e.jsx("path",{d:"M12 8 L8 10 L8 18 L12 22 L16 18 L16 10 Z",fill:r,opacity:"0.5"})]});case"compass":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("circle",{cx:"16",cy:"16",r:"12",fill:"none",stroke:r,strokeWidth:"1",opacity:"0.3"}),e.jsx("line",{x1:"16",y1:"4",x2:"16",y2:"28",stroke:r,strokeWidth:"1",opacity:"0.4"}),e.jsx("line",{x1:"4",y1:"16",x2:"28",y2:"16",stroke:r,strokeWidth:"1",opacity:"0.4"}),e.jsx("polygon",{points:"16,8 14,16 16,14 18,16",fill:r}),e.jsx("circle",{cx:"16",cy:"16",r:"2",fill:r})]});default:return e.jsx("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:e.jsx("path",{d:"M4 20 L4 4 L20 4",fill:"none",stroke:r,strokeWidth:"2"})})}},gi={Common:"from-gray-400 to-gray-600",Rare:"from-blue-400 to-blue-600",Epic:"from-purple-400 to-purple-600",Legendary:"from-amber-400 to-amber-600",Mythic:"from-pink-500 to-rose-600",Celestial:"from-cyan-400 to-blue-500",Primal:"from-emerald-400 to-teal-600",Origin:"from-violet-500 to-fuchsia-600"},Pl={fire:"ðŸ”¥",water:"ðŸ’§",earth:"ðŸª¨",air:"ðŸ’¨",lightning:"âš¡",ice:"â„ï¸",nature:"ðŸŒ¿",shadow:"ðŸŒ‘",light:"âœ¨"},_v=t=>t<=9?1:t<=14?2:3;function jv({card:t,equippedFrame:s}){const[r,a]=n.useState(!1),[i,o]=n.useState(!1),{tap:l}=cm(),c=n.useRef(null),d=t.stats,m=t.energy_cost??_v(t.evolution_stage),p=t.bond_level??null,h=()=>{l(),a(!0),o(!1)},f=v=>{v.stopPropagation(),l(),o(!i)},u=async v=>{v.stopPropagation(),c.current&&await q0(c.current,`cosmiq-${t.creature_name.toLowerCase().replace(/\s+/g,"-")}-stage-${t.evolution_stage}.png`,{title:`${t.creature_name} - Cosmiq`,text:`Check out my ${t.creature_name}! âœ¨ #Cosmiq`,dialogTitle:"Share Companion Card"})},g=s&&s.cornerStyle,y=s?.glowAnimation==="pulse"?"animate-frame-pulse":s?.glowAnimation==="breathe"?"animate-frame-breathe":s?.glowAnimation==="flicker"?"animate-frame-flicker":s?.glowAnimation==="shift"?"animate-frame-shift":"",b=s?{borderColor:s.gradientBorder?"transparent":s.borderColor,borderWidth:s.borderWidth||"8px",borderStyle:s.borderStyle||"solid",boxShadow:s.glowColor?`0 0 20px ${s.glowColor}, 0 0 40px ${s.glowColor}40`:void 0}:{};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"relative h-[280px] cursor-pointer rounded-xl overflow-hidden",onClick:h,children:e.jsx("div",{className:`h-full rounded-xl border-2 bg-gradient-to-br ${gi[t.rarity]} p-[2px] shadow-lg`,children:e.jsxs("div",{className:"h-full rounded-lg bg-card relative overflow-hidden",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.creature_name,className:"absolute inset-0 w-full h-full object-cover",loading:"lazy",decoding:"async"}):e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-muted/50 to-muted flex items-center justify-center text-muted-foreground text-xs",children:"No Image"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"}),e.jsx(Fe,{className:"absolute top-2 left-2 bg-background/90 backdrop-blur-sm text-xs",children:Pl[t.element.toLowerCase()]||"âœ¨"}),e.jsxs(Fe,{className:"absolute top-2 right-2 bg-background/90 backdrop-blur-sm text-xs",children:["Stage ",t.evolution_stage]}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-3 space-y-2",children:[e.jsx("h3",{className:"font-bold text-sm text-white drop-shadow-lg",children:t.creature_name}),e.jsxs("div",{className:"flex items-center justify-between text-[10px] text-white/80 bg-black/30 rounded-md px-2 py-1",children:[e.jsxs("span",{className:"flex items-center gap-1",children:["âš¡",e.jsx("span",{className:"font-semibold",children:m})]}),p!==null&&e.jsxs("span",{className:"flex items-center gap-1",children:["ðŸ¤ ",e.jsx("span",{className:"font-semibold",children:p})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-1 text-xs bg-black/40 backdrop-blur-sm rounded-lg p-2",children:[e.jsxs("div",{className:"flex flex-col items-center text-white/90",children:[e.jsx("span",{children:"ðŸ§ "}),e.jsx("span",{className:"font-semibold",children:d.mind||0})]}),e.jsxs("div",{className:"flex flex-col items-center text-white/90",children:[e.jsx("span",{children:"ðŸ’ª"}),e.jsx("span",{className:"font-semibold",children:d.body||0})]}),e.jsxs("div",{className:"flex flex-col items-center text-white/90",children:[e.jsx("span",{children:"ðŸ”¥"}),e.jsx("span",{className:"font-semibold",children:d.soul||0})]})]})]})]})})}),e.jsx(ns,{open:r,onOpenChange:v=>{a(v),v||o(!1)},children:e.jsxs(Vt,{className:"max-w-[95vw] max-h-[95vh] p-0 bg-transparent border-0 overflow-hidden","aria-describedby":"evolution-card-description",children:[e.jsxs(xs,{className:"sr-only",children:[t.creature_name," - Evolution Card"]}),e.jsxs("span",{id:"evolution-card-description",className:"sr-only",children:["Detailed view of ",t.creature_name,", a ",t.rarity," ",t.element," ",t.species," at evolution stage ",t.evolution_stage]}),e.jsx("div",{className:"absolute inset-0 z-40",onClick:()=>a(!1)}),e.jsxs("div",{className:"relative w-full h-[80vh] flex items-center justify-center",children:[e.jsx("button",{onClick:u,className:"absolute top-4 right-20 z-50 p-3 rounded-full bg-black/70 backdrop-blur-sm text-white hover:bg-black/90 active:bg-black transition-colors touch-manipulation",children:e.jsx(Xc,{className:"w-6 h-6"})}),e.jsx("button",{onClick:v=>{v.stopPropagation(),a(!1)},className:"absolute top-4 right-4 z-50 p-3 rounded-full bg-black/70 backdrop-blur-sm text-white hover:bg-black/90 active:bg-black transition-colors touch-manipulation",children:e.jsx(Nt,{className:"w-6 h-6"})}),e.jsx("div",{className:"relative w-full max-w-[320px] aspect-[2.5/3.5] cursor-pointer perspective-1000",onClick:f,children:e.jsxs(M.div,{className:"relative w-full h-full preserve-3d",animate:{rotateY:i?180:0},transition:{duration:.6,type:"spring"},children:[e.jsx("div",{className:"absolute w-full h-full backface-hidden",style:{transform:"rotateY(0deg)"},children:e.jsxs("div",{ref:c,className:A("h-full rounded-2xl p-0 shadow-2xl overflow-hidden relative",g?y:`border-[8px] bg-gradient-to-br ${gi[t.rarity]}`,s?.shimmer&&"animate-frame-shimmer",s?.animatedGradient&&"animate-gradient-border"),style:g?b:{},children:[s?.gradientBorder&&e.jsx("div",{className:A("absolute inset-0 rounded-2xl -z-10",s.animatedGradient&&"animate-gradient-border"),style:{background:s.gradientBorder,backgroundSize:"200% 200%"}}),g&&s?e.jsx(vv,{cssEffect:s}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"absolute top-0 left-0 w-12 h-12 z-30 pointer-events-none backface-hidden",children:[e.jsx("div",{className:"absolute inset-0 border-t-2 border-l-2 border-white/40 rounded-tl-xl"}),e.jsx("div",{className:"absolute top-1 left-1 w-8 h-8 border-t border-l border-white/20 rounded-tl-lg"})]}),e.jsxs("div",{className:"absolute top-0 right-0 w-12 h-12 z-30 pointer-events-none backface-hidden",children:[e.jsx("div",{className:"absolute inset-0 border-t-2 border-r-2 border-white/40 rounded-tr-xl"}),e.jsx("div",{className:"absolute top-1 right-1 w-8 h-8 border-t border-r border-white/20 rounded-tr-lg"})]}),e.jsxs("div",{className:"absolute bottom-0 left-0 w-12 h-12 z-30 pointer-events-none backface-hidden",children:[e.jsx("div",{className:"absolute inset-0 border-b-2 border-l-2 border-white/40 rounded-bl-xl"}),e.jsx("div",{className:"absolute bottom-1 left-1 w-8 h-8 border-b border-l border-white/20 rounded-bl-lg"})]}),e.jsxs("div",{className:"absolute bottom-0 right-0 w-12 h-12 z-30 pointer-events-none backface-hidden",children:[e.jsx("div",{className:"absolute inset-0 border-b-2 border-r-2 border-white/40 rounded-br-xl"}),e.jsx("div",{className:"absolute bottom-1 right-1 w-8 h-8 border-b border-r border-white/20 rounded-br-lg"})]})]}),s?.shimmer&&e.jsx("div",{className:"absolute inset-0 pointer-events-none z-20 overflow-hidden rounded-2xl",children:e.jsx("div",{className:"absolute inset-0 animate-frame-shimmer bg-gradient-to-r from-transparent via-white/20 to-transparent",style:{transform:"skewX(-20deg)",width:"200%",marginLeft:"-50%"}})}),e.jsx("div",{className:"absolute inset-2 border border-white/20 rounded-lg z-20 pointer-events-none backface-hidden"}),e.jsxs("div",{className:"h-full rounded-xl relative overflow-hidden",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.creature_name,className:"absolute inset-0 w-full h-full object-cover",loading:"lazy",decoding:"async"}):e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-muted/50 to-muted flex items-center justify-center",children:"No Image"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-black/60"}),e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center justify-between p-3",children:[e.jsxs(Fe,{className:"bg-black/70 backdrop-blur-sm text-white text-sm px-3 py-1 border border-white/20",children:[Pl[t.element.toLowerCase()]||"âœ¨"," ",t.element]}),e.jsxs(Fe,{className:"bg-black/70 backdrop-blur-sm text-white text-sm px-3 py-1 border border-white/20",children:["Stage ",t.evolution_stage]})]}),e.jsxs("div",{className:"absolute top-14 left-2 z-10 flex gap-1.5",children:[e.jsxs("div",{className:"bg-black/40 backdrop-blur-sm rounded-full px-1.5 py-0.5 flex items-center gap-0.5 text-white/80 text-[10px] border border-white/10",children:[e.jsx("span",{className:"text-[10px]",children:"ðŸ§ "}),e.jsx("span",{className:"font-medium",children:d.mind||0})]}),e.jsxs("div",{className:"bg-black/40 backdrop-blur-sm rounded-full px-1.5 py-0.5 flex items-center gap-0.5 text-white/80 text-[10px] border border-white/10",children:[e.jsx("span",{className:"text-[10px]",children:"ðŸ’ª"}),e.jsx("span",{className:"font-medium",children:d.body||0})]}),e.jsxs("div",{className:"bg-black/40 backdrop-blur-sm rounded-full px-1.5 py-0.5 flex items-center gap-0.5 text-white/80 text-[10px] border border-white/10",children:[e.jsx("span",{className:"text-[10px]",children:"ðŸ”¥"}),e.jsx("span",{className:"font-medium",children:d.soul||0})]})]}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 z-10 p-4 space-y-2 pb-12 backface-hidden",children:[e.jsxs("h3",{className:"font-bold text-2xl text-center text-white drop-shadow-[0_2px_8px_rgba(0,0,0,0.8)] tracking-wide",children:["â˜… ",t.creature_name.toUpperCase()," â˜…"]}),e.jsxs("div",{className:"text-sm text-center text-white/90 drop-shadow-lg",children:["Stage ",t.evolution_stage," â€¢ ",t.rarity]})]})]}),e.jsx("div",{className:"absolute bottom-0 left-1/2 -translate-x-1/2 z-30 flex items-center justify-center backface-hidden",children:e.jsxs("div",{className:"relative px-6 py-2",children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 w-4 h-[2px] bg-gradient-to-r from-transparent to-white/60"}),e.jsx("div",{className:"absolute right-0 top-1/2 -translate-y-1/2 w-4 h-[2px] bg-gradient-to-l from-transparent to-white/60"}),e.jsx("span",{className:"text-[11px] font-bold tracking-[0.3em] text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] relative z-10",children:"âœ¦ COSMIQ âœ¦"})]})})]})}),e.jsx("div",{className:"absolute w-full h-full backface-hidden rotate-y-180",children:e.jsx("div",{className:`h-full rounded-2xl border-4 bg-gradient-to-br ${gi[t.rarity]} p-1 shadow-2xl`,children:e.jsx("div",{className:"h-full rounded-xl bg-card p-6 flex flex-col overflow-hidden",children:e.jsxs("div",{className:"space-y-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"text-center pb-4 border-b border-border",children:[e.jsx("h3",{className:"font-bold text-xl",children:t.creature_name}),e.jsxs("p",{className:"text-sm text-muted-foreground capitalize mt-1",children:[t.species," of ",t.element]})]}),t.traits&&t.traits.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold mb-2 text-primary",children:"Traits"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.traits.map((v,x)=>e.jsx(Fe,{variant:"secondary",className:"text-xs",children:v},x))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold mb-2 text-primary",children:"Lore"}),e.jsx("p",{className:"text-sm text-muted-foreground leading-relaxed",children:t.story_text})]})]})})})})]})})]})]})})]})}const dm=n.memo(()=>{const{user:t}=be(),{data:s,isLoading:r}=Ee({queryKey:["evolution-cards",t?.id],queryFn:async()=>{if(!t)return[];const{data:a,error:i}=await S.from("companion_evolution_cards").select("*").eq("user_id",t.id).order("evolution_stage",{ascending:!0});if(i)throw i;const o=(a||[]).map(p=>p.evolution_id).filter(p=>!!p);let l={};if(o.length>0){const{data:p,error:h}=await S.from("companion_evolutions").select("id, image_url").in("id",o);if(h)throw h;l=(p||[]).reduce((f,u)=>(f[u.id]=u.image_url??null,f),{})}const c=(a||[]).map(p=>{const h=p.image_url,f=p.evolution_id?l[p.evolution_id]:null;return{...p,image_url:h||f}}),d=new Map;return c.forEach(p=>{d.has(p.card_id)||d.set(p.card_id,p)}),Array.from(d.values())},enabled:!!t,staleTime:300*1e3});return r?e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[1,2,3].map(a=>e.jsx(je,{className:"h-[280px] rounded-xl"},a))}):!s||s.length===0?e.jsxs(We,{className:"p-8 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx(pe,{className:"h-12 w-12 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Evolution Cards Yet"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Cards are created when your companion evolves. Keep growing to unlock your first card!"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:"Your Collection"}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:s.map(a=>e.jsx(jv,{card:a},a.id))})]})});dm.displayName="EvolutionCardGallery";const Nv={background:Gh,frame:Wh,effect:Vs,artifact:Kh},tn={background:"Backgrounds",frame:"Frames",effect:"Effects",artifact:"Artifacts"},um=n.memo(({className:t})=>{const{allRewards:s,userRewards:r,equipReward:a,isEquipping:i,isLoading:o}=Xu(),[l,c]=n.useState("background"),d=r.reduce((h,f)=>{const u=f.epic_rewards?.reward_type;return u&&(h[u]||(h[u]=[]),h[u].push(f)),h},{}),m=s.reduce((h,f)=>(h[f.reward_type]||(h[f.reward_type]=[]),h[f.reward_type].push(f),h),{}),p=h=>{a({rewardId:h.reward_id,equip:!h.is_equipped})};return o?e.jsx(We,{className:A("p-6 cosmiq-glass",t),children:e.jsx("div",{className:"flex items-center justify-center h-40",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})}):e.jsxs(We,{className:A("cosmiq-glass overflow-hidden",t),children:[e.jsxs("div",{className:"p-4 border-b border-border/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-bold text-lg",children:"Reward Collection"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[r.length," / ",s.length," rewards collected"]})]}),e.jsxs(xo,{value:l,onValueChange:h=>c(h),children:[e.jsx(Fn,{className:"w-full justify-start rounded-none border-b border-border/50 bg-transparent p-0",children:Object.keys(tn).map(h=>{const f=Nv[h],u=d[h]?.length||0;return e.jsxs(Ns,{value:h,className:"flex-1 rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent py-3",children:[e.jsx(f,{className:"w-4 h-4 mr-1.5"}),e.jsx("span",{className:"hidden sm:inline",children:tn[h]}),u>0&&e.jsx(Fe,{variant:"secondary",className:"ml-1.5 h-5 px-1.5 text-xs",children:u})]},h)})}),Object.keys(tn).map(h=>e.jsxs(ks,{value:h,className:"p-4 mt-0",children:[e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-3",children:e.jsxs(Pe,{mode:"popLayout",children:[d[h]?.map(f=>e.jsx(kv,{userReward:f,isEquipped:f.is_equipped,onToggleEquip:()=>p(f),isEquipping:i},f.id)),m[h]?.filter(f=>!r.some(u=>u.reward_id===f.id)).map(f=>e.jsx(Cv,{reward:f},f.id))]})}),!d[h]?.length&&!m[h]?.length&&e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:e.jsxs("p",{children:["No ",tn[h].toLowerCase()," available yet"]})})]},h))]})]})});um.displayName="RewardInventory";const kv=({userReward:t,isEquipped:s,onToggleEquip:r,isEquipping:a})=>{const i=t.epic_rewards;if(!i)return null;const o=Hb[i.rarity];return e.jsx(M.div,{layout:!0,initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},children:e.jsxs(We,{className:A("relative p-3 cursor-pointer transition-all hover:scale-105","border-2",s?"border-primary bg-primary/10":"border-border/50 hover:border-primary/50"),onClick:r,children:[s&&e.jsx("div",{className:"absolute -top-2 -right-2 w-6 h-6 rounded-full bg-primary flex items-center justify-center",children:e.jsx(Pt,{className:"w-4 h-4 text-primary-foreground"})}),e.jsx("div",{className:A("aspect-square rounded-lg mb-2 flex items-center justify-center","bg-gradient-to-br",o.bgClass),style:{boxShadow:s?`0 0 20px ${o.color}40`:void 0},children:i.reward_type==="artifact"&&i.css_effect?.icon?e.jsx("span",{className:"text-4xl",children:i.css_effect.icon}):e.jsx(pe,{className:"w-8 h-8",style:{color:o.color}})}),e.jsx("p",{className:"font-medium text-sm truncate",children:i.name}),e.jsx("p",{className:"text-xs truncate",style:{color:o.color},children:o.label}),a&&e.jsx("div",{className:"absolute inset-0 bg-background/50 flex items-center justify-center rounded-lg",children:e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary"})})]})})},Cv=({reward:t})=>e.jsx(M.div,{layout:!0,initial:{opacity:0},animate:{opacity:1},children:e.jsxs(We,{className:"relative p-3 border-2 border-dashed border-border/30 bg-muted/20",children:[e.jsx("div",{className:"absolute -top-2 -right-2 w-6 h-6 rounded-full bg-muted flex items-center justify-center",children:e.jsx(jn,{className:"w-3 h-3 text-muted-foreground"})}),e.jsx("div",{className:"aspect-square rounded-lg mb-2 flex items-center justify-center bg-muted/50",children:e.jsx(pe,{className:"w-8 h-8 text-muted-foreground/30"})}),e.jsx("p",{className:"font-medium text-sm truncate text-muted-foreground",children:"???"}),e.jsx("p",{className:"text-xs text-muted-foreground/50",children:"Complete epics to unlock"})]})}),Sv=["badges","cards","loot"],Ev={badges:!0,cards:!1,loot:!1},Tv=t=>Sv.includes(t),mm=n.memo(()=>{const[t,s]=n.useState("badges"),[r,a]=n.useState(()=>Ev),i=n.useRef(!1),o=n.useCallback(c=>{a(d=>d[c]?d:{...d,[c]:!0})},[]),l=n.useCallback(c=>{Tv(c)&&(s(c),o(c))},[o]);return n.useEffect(()=>{if(i.current)return;i.current=!0;const c=window;let d=null,m=null;return c.requestIdleCallback?m=c.requestIdleCallback(()=>{a({badges:!0,cards:!0,loot:!0})},{timeout:1200}):d=window.setTimeout(()=>{a({badges:!0,cards:!0,loot:!0})},400),()=>{d!==null&&window.clearTimeout(d),m!==null&&c.cancelIdleCallback&&c.cancelIdleCallback(m)}},[]),e.jsx("div",{className:"space-y-4 mt-4",children:e.jsxs(xo,{value:t,onValueChange:l,children:[e.jsxs(Fn,{className:"grid w-full grid-cols-3 h-10",children:[e.jsxs(Ns,{value:"badges",className:"flex items-center gap-2",children:[e.jsx(Mi,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Badges"})]}),e.jsxs(Ns,{value:"cards",className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Cards"})]}),e.jsxs(Ns,{value:"loot",className:"flex items-center gap-2",children:[e.jsx(Yh,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Loot"})]})]}),e.jsx(ks,{value:"badges",forceMount:!0,className:"mt-4 data-[state=inactive]:hidden",children:r.badges&&e.jsx(bv,{})}),e.jsx(ks,{value:"cards",forceMount:!0,className:"mt-4 data-[state=inactive]:hidden",children:r.cards&&e.jsx(dm,{})}),e.jsx(ks,{value:"loot",forceMount:!0,className:"mt-4 data-[state=inactive]:hidden",children:r.loot&&e.jsx(um,{})})]})})});mm.displayName="CollectionTab";const ls={pomodoro:25,short_break:5,long_break:15,custom:30},Mv=300;function Dv(){const{user:t}=be(),{toast:s}=Ms(),r=Ae(),{awardFocusSessionComplete:a}=Xt(),i=n.useRef(null),o=n.useRef(null),{triggerPomodoroComplete:l}=Ra(),[c,d]=n.useState({isRunning:!1,isPaused:!1,timeRemaining:ls.pomodoro*60,totalTime:ls.pomodoro*60,sessionType:"pomodoro",currentSessionId:null,distractionsCount:0,isCooldown:!1,cooldownTimeRemaining:0}),{data:m=[],isLoading:p}=Ee({queryKey:["focus-sessions",t?.id,"today"],queryFn:async()=>{if(!t?.id)return[];const R=new Date().toISOString().split("T")[0],{data:L,error:$}=await S.from("focus_sessions").select("*").eq("user_id",t.id).gte("started_at",`${R}T00:00:00`).order("started_at",{ascending:!1});if($)throw $;return L},enabled:!!t?.id}),h=le({mutationFn:async({taskId:R,durationType:L,customDuration:$})=>{if(!t?.id)throw new Error("Not authenticated");const q=$||ls[L],{data:F,error:H}=await S.from("focus_sessions").insert({user_id:t.id,task_id:R||null,duration_type:L,planned_duration:q,started_at:new Date().toISOString(),status:"active",distractions_count:0}).select().single();if(H)throw H;return F},onSuccess:R=>{r.invalidateQueries({queryKey:["focus-sessions"]}),d(L=>({...L,isRunning:!0,isPaused:!1,timeRemaining:R.planned_duration*60,totalTime:R.planned_duration*60,sessionType:R.duration_type,currentSessionId:R.id,distractionsCount:0,isCooldown:!1,cooldownTimeRemaining:0}))},onError:R=>{console.error("Failed to start session:",R),s({title:"Failed to start focus session",variant:"destructive"})}}),f=m.filter(R=>R.status==="completed").length,u=f<js.DAILY_SESSION_CAP,g=Math.max(0,js.DAILY_SESSION_CAP-f),y=le({mutationFn:async({sessionId:R,actualDuration:L,distractionsCount:$,isPerfect:q,underCap:F})=>{let H;F?(H=js.SESSION_COMPLETE,q&&(H+=js.PERFECT_FOCUS_BONUS)):H=js.CAPPED_SESSION_XP;const{data:J,error:G}=await S.from("focus_sessions").update({status:"completed",completed_at:new Date().toISOString(),actual_duration:L,distractions_count:$,xp_earned:H}).eq("id",R).select().single();if(G)throw G;return{session:J,isPerfect:q,underCap:F}},onSuccess:({session:R,isPerfect:L,underCap:$})=>{r.invalidateQueries({queryKey:["focus-sessions"]}),a(L,$),R.planned_duration>=15&&l(R.planned_duration).catch(q=>console.log("[LivingCompanion] Pomodoro trigger failed:",q)),w()}}),b=le({mutationFn:async R=>{const{data:L,error:$}=await S.from("focus_sessions").update({status:"paused",paused_at:new Date().toISOString()}).eq("id",R).select().single();if($)throw $;return L},onSuccess:()=>{r.invalidateQueries({queryKey:["focus-sessions"]})}}),v=le({mutationFn:async R=>{const{data:L,error:$}=await S.from("focus_sessions").update({status:"active",paused_at:null}).eq("id",R).select().single();if($)throw $;return L},onSuccess:()=>{r.invalidateQueries({queryKey:["focus-sessions"]})}}),x=le({mutationFn:async R=>{const{data:L,error:$}=await S.from("focus_sessions").update({status:"cancelled",completed_at:new Date().toISOString()}).eq("id",R).select().single();if($)throw $;return L},onSuccess:()=>{r.invalidateQueries({queryKey:["focus-sessions"]}),k()}}),w=n.useCallback(()=>{i.current&&clearInterval(i.current),d(R=>({...R,isRunning:!1,isPaused:!1,isCooldown:!0,cooldownTimeRemaining:Mv,currentSessionId:null,distractionsCount:0}))},[]),j=n.useCallback(()=>{o.current&&clearInterval(o.current),d(R=>({...R,isCooldown:!1,cooldownTimeRemaining:0,timeRemaining:ls.pomodoro*60,totalTime:ls.pomodoro*60}))},[]),D=n.useCallback(()=>{d(R=>({...R,distractionsCount:R.distractionsCount+1}))},[]);n.useEffect(()=>(c.isCooldown&&c.cooldownTimeRemaining>0&&(o.current=setInterval(()=>{d(R=>R.cooldownTimeRemaining<=1?{...R,isCooldown:!1,cooldownTimeRemaining:0,timeRemaining:ls.pomodoro*60,totalTime:ls.pomodoro*60}:{...R,cooldownTimeRemaining:R.cooldownTimeRemaining-1})},1e3)),()=>{o.current&&clearInterval(o.current)}),[c.isCooldown,c.cooldownTimeRemaining>0]),n.useEffect(()=>(c.isRunning&&!c.isPaused&&(i.current=setInterval(()=>{d(R=>{if(R.timeRemaining<=1){if(R.currentSessionId){const L=Math.round((R.totalTime-R.timeRemaining)/60),$=R.distractionsCount===0;y.mutate({sessionId:R.currentSessionId,actualDuration:L,distractionsCount:R.distractionsCount,isPerfect:$,underCap:u})}return{...R,isRunning:!1,timeRemaining:0}}return{...R,timeRemaining:R.timeRemaining-1}})},1e3)),()=>{i.current&&clearInterval(i.current)}),[c.isRunning,c.isPaused,u]);const C=n.useCallback((R,L="pomodoro",$)=>{h.mutate({taskId:R,durationType:L,customDuration:$})},[]),_=n.useCallback(()=>{c.currentSessionId&&(b.mutate(c.currentSessionId),d(R=>({...R,isPaused:!0})))},[c.currentSessionId]),N=n.useCallback(()=>{c.currentSessionId&&(v.mutate(c.currentSessionId),d(R=>({...R,isPaused:!1})))},[c.currentSessionId]),E=n.useCallback(()=>{c.currentSessionId&&x.mutate(c.currentSessionId)},[c.currentSessionId]),k=n.useCallback(()=>{i.current&&clearInterval(i.current),o.current&&clearInterval(o.current),d({isRunning:!1,isPaused:!1,timeRemaining:ls.pomodoro*60,totalTime:ls.pomodoro*60,sessionType:"pomodoro",currentSessionId:null,distractionsCount:0,isCooldown:!1,cooldownTimeRemaining:0})},[]),P=n.useCallback((R,L)=>{const $=L||ls[R];d(q=>({...q,sessionType:R,timeRemaining:$*60,totalTime:$*60}))},[]),T=m.filter(R=>R.status==="completed"&&R.duration_type==="pomodoro").reduce((R,L)=>R+(L.actual_duration||0),0),I=m.filter(R=>R.status==="completed").reduce((R,L)=>R+(L.xp_earned||0),0);return{timerState:c,todaySessions:m,isLoading:p,startSession:C,pauseSession:_,resumeSession:N,cancelSession:E,resetTimer:k,setSessionType:P,logDistraction:D,skipCooldown:j,stats:{completedToday:f,totalFocusMinutes:T,totalXPToday:I,sessionsUntilCap:g,dailyCap:js.DAILY_SESSION_CAP},DURATION_PRESETS:ls}}function Pv({taskId:t,taskName:s,compact:r=!1,onComplete:a}){const{timerState:i,startSession:o,pauseSession:l,resumeSession:c,cancelSession:d,logDistraction:m,skipCooldown:p,stats:h}=Dv(),f=v=>{const x=Math.floor(v/60),w=v%60;return`${x.toString().padStart(2,"0")}:${w.toString().padStart(2,"0")}`},u=i.isCooldown?(300-i.cooldownTimeRemaining)/300*100:i.totalTime>0?(i.totalTime-i.timeRemaining)/i.totalTime*100:0,g=i.isCooldown?i.cooldownTimeRemaining:i.timeRemaining,y=()=>{o(t,"pomodoro")},b=()=>{i.isPaused?c():l()};return r?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-lg font-mono font-bold text-foreground",children:f(g)}),!i.isRunning&&!i.isCooldown?e.jsx(U,{size:"sm",variant:"ghost",onClick:y,children:e.jsx(Ls,{className:"w-4 h-4"})}):i.isCooldown?e.jsx(U,{size:"sm",variant:"ghost",onClick:p,children:e.jsx(ha,{className:"w-4 h-4"})}):e.jsx(U,{size:"sm",variant:"ghost",onClick:b,children:i.isPaused?e.jsx(Ls,{className:"w-4 h-4"}):e.jsx(Pr,{className:"w-4 h-4"})})]}):e.jsx(We,{className:"overflow-hidden",children:e.jsxs(oo,{className:"p-6",children:[!i.isRunning&&!i.isCooldown&&e.jsxs("div",{className:"flex items-start gap-3 mb-6 p-3 rounded-lg bg-muted/50",children:[e.jsx(Ss,{className:"w-5 h-5 text-primary shrink-0 mt-0.5"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Pomodoro Technique:"})," ","Focus for 25 minutes, then take a 5-minute break. This helps maintain concentration and avoid burnout."]})]}),i.isCooldown&&e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-6 p-3 rounded-lg bg-green-500/10",children:[e.jsx(Vh,{className:"w-5 h-5 text-green-500"}),e.jsx("p",{className:"text-sm font-medium text-green-600 dark:text-green-400",children:"Take a break! Stretch, hydrate, rest your eyes."})]}),e.jsx("div",{className:"relative flex justify-center mb-6",children:e.jsxs("div",{className:"relative w-48 h-48",children:[e.jsxs("svg",{className:"w-full h-full transform -rotate-90",children:[e.jsx("circle",{cx:"96",cy:"96",r:"88",fill:"none",stroke:"currentColor",strokeWidth:"8",className:"text-muted/20"}),e.jsx(M.circle,{cx:"96",cy:"96",r:"88",fill:"none",stroke:"currentColor",strokeWidth:"8",strokeLinecap:"round",className:A(i.isCooldown?"text-green-500":"text-primary"),strokeDasharray:553,strokeDashoffset:553-553*u/100,initial:!1,animate:{strokeDashoffset:553-553*u/100},transition:{duration:.5}})]}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:[e.jsx(Pe,{mode:"wait",children:e.jsx(M.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"text-4xl font-mono font-bold text-foreground",children:f(g)},g)}),e.jsx("span",{className:A("text-sm mt-1",i.isCooldown?"text-green-500 font-medium":"text-muted-foreground"),children:i.isCooldown?"Cooldown":"Focus Time"})]})]})}),s&&!i.isCooldown&&e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Working on:"}),e.jsx("p",{className:"font-medium text-foreground truncate",children:s})]}),e.jsx("div",{className:"flex justify-center gap-3",children:i.isCooldown?e.jsxs(U,{onClick:p,variant:"outline",size:"lg",className:"gap-2",children:[e.jsx(ha,{className:"w-5 h-5"}),"Skip Break"]}):i.isRunning?e.jsxs(e.Fragment,{children:[e.jsx(U,{variant:"outline",size:"icon",onClick:d,className:"h-12 w-12",children:e.jsx(Xh,{className:"w-5 h-5"})}),e.jsx(U,{size:"lg",onClick:b,className:"gap-2 px-8",children:i.isPaused?e.jsxs(e.Fragment,{children:[e.jsx(Ls,{className:"w-5 h-5"}),"Resume"]}):e.jsxs(e.Fragment,{children:[e.jsx(Pr,{className:"w-5 h-5"}),"Pause"]})}),e.jsx(U,{variant:"outline",size:"icon",onClick:m,className:"h-12 w-12",title:"Log distraction",children:e.jsx(ft,{className:"w-5 h-5"})})]}):e.jsxs(U,{onClick:y,size:"lg",className:"gap-2",children:[e.jsx(Ls,{className:"w-5 h-5"}),"Start Focus"]})}),i.isRunning&&i.distractionsCount>0&&e.jsx("div",{className:"text-center mt-4",children:e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Distractions: ",i.distractionsCount]})}),h.sessionsUntilCap>0?e.jsxs("div",{className:"text-center mt-4 text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-primary",children:h.sessionsUntilCap})," full XP session",h.sessionsUntilCap!==1?"s":""," remaining today"]}):e.jsxs("div",{className:"text-center mt-4 text-sm text-muted-foreground",children:["Daily cap reached â€” sessions now award ",e.jsx("span",{className:"font-medium",children:"3 XP"})]}),e.jsxs("div",{className:"flex justify-center gap-6 mt-6 pt-4 border-t border-border",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-foreground",children:h.completedToday}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Sessions"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-foreground",children:h.totalFocusMinutes}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Minutes"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:h.totalXPToday}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"XP"})]})]})]})})}const Av=Hr("rounded-2xl border transition-all duration-300",{variants:{variant:{default:["bg-card/78 backdrop-blur-lg","border-border/60","shadow-[0_10px_24px_rgba(0,0,0,0.22)]"],elevated:["bg-card/86 backdrop-blur-2xl","border-border/70","shadow-[0_14px_34px_rgba(0,0,0,0.28),0_2px_8px_rgba(0,0,0,0.12)]"],inset:["bg-background/60 backdrop-blur-lg","border-border/45","shadow-inner"],hero:["bg-gradient-to-br from-primary/[0.12] to-accent/[0.07] backdrop-blur-2xl","border-border/60","shadow-[0_16px_38px_rgba(0,0,0,0.24)]"],subtle:["bg-card/62 backdrop-blur-md","border-border/45","shadow-[0_6px_16px_rgba(0,0,0,0.16)]"],ultra:["bg-card/70 backdrop-blur-2xl","border-border/55","shadow-[0_10px_28px_rgba(0,0,0,0.24)]"]},glow:{none:"",soft:"shadow-[0_0_30px_rgba(255,255,255,0.05)]",accent:"shadow-[0_0_40px_hsl(var(--accent)/0.15)]",primary:"shadow-[0_0_40px_hsl(var(--primary)/0.2)]"}},defaultVariants:{variant:"default",glow:"none"}}),Ks=n.forwardRef(({className:t,variant:s,glow:r,...a},i)=>e.jsx("div",{ref:i,className:A(Av({variant:s,glow:r}),t),...a}));Ks.displayName="GlassCard";const pm=n.memo(({habit:t,onResist:s,onRemove:r,isLoading:a})=>e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:e.jsx(Ks,{variant:"subtle",className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"text-2xl flex-shrink-0",children:t.icon}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h4",{className:"font-medium text-sm text-foreground truncate",children:t.name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["Resisted ",t.times_resisted,"Ã—"]}),t.current_streak>0&&e.jsxs("span",{className:"flex items-center gap-1 text-orange-400",children:[e.jsx(Gt,{className:"h-3 w-3"}),t.current_streak," streak"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx(U,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:r,disabled:a,children:e.jsx($s,{className:"h-4 w-4"})}),e.jsxs(U,{size:"sm",onClick:s,disabled:a,className:"gap-1.5",children:[e.jsx(Es,{className:"h-4 w-4"}),"Resist"]})]})]})})}));pm.displayName="HabitResistCard";const Rv=Hr("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),at=n.forwardRef(({className:t,...s},r)=>e.jsx(nd,{ref:r,className:A(Rv(),t),...s}));at.displayName=nd.displayName;const Na=rf,ka=af,Fr=n.forwardRef(({className:t,children:s,...r},a)=>e.jsxs(id,{ref:a,className:A("flex h-11 w-full items-center justify-between rounded-lg border border-input bg-secondary/50 px-4 py-2 text-sm font-medium text-foreground ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:border-primary disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1 transition-all",t),...r,children:[s,e.jsx(Jh,{asChild:!0,children:e.jsx(Os,{className:"h-4 w-4 opacity-50"})})]}));Fr.displayName=id.displayName;const hm=n.forwardRef(({className:t,...s},r)=>e.jsx(od,{ref:r,className:A("flex cursor-default items-center justify-center py-1",t),...s,children:e.jsx(Zi,{className:"h-4 w-4"})}));hm.displayName=od.displayName;const fm=n.forwardRef(({className:t,...s},r)=>e.jsx(ld,{ref:r,className:A("flex cursor-default items-center justify-center py-1",t),...s,children:e.jsx(Os,{className:"h-4 w-4"})}));fm.displayName=ld.displayName;const $r=n.forwardRef(({className:t,children:s,position:r="popper",...a},i)=>e.jsx(Zh,{children:e.jsxs(cd,{ref:i,className:A("relative z-[100] max-h-96 min-w-[8rem] overflow-hidden rounded-lg border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",r==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",t),position:r,...a,children:[e.jsx(hm,{}),e.jsx(ef,{className:A("p-1",r==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:s}),e.jsx(fm,{})]})}));$r.displayName=cd.displayName;const Iv=n.forwardRef(({className:t,...s},r)=>e.jsx(dd,{ref:r,className:A("py-1.5 pl-8 pr-2 text-sm font-semibold",t),...s}));Iv.displayName=dd.displayName;const Gs=n.forwardRef(({className:t,children:s,...r},a)=>e.jsxs(ud,{ref:a,className:A("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",t),...r,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(tf,{children:e.jsx(Pt,{className:"h-4 w-4"})})}),e.jsx(sf,{children:s})]}));Gs.displayName=ud.displayName;const Lv=n.forwardRef(({className:t,...s},r)=>e.jsx(md,{ref:r,className:A("-mx-1 my-1 h-px bg-muted",t),...s}));Lv.displayName=md.displayName;const qv=[{value:"distraction",label:"Distraction"},{value:"laziness",label:"Laziness"},{value:"stagnation",label:"Stagnation"},{value:"anxiety",label:"Anxiety"},{value:"overthinking",label:"Overthinking"},{value:"doubt",label:"Self-Doubt"},{value:"fear",label:"Fear"}],gm=n.memo(({onAdd:t,isLoading:s})=>{const[r,a]=n.useState(!1),[i,o]=n.useState("preset"),[l,c]=n.useState(""),[d,m]=n.useState("ðŸš«"),[p,h]=n.useState("distraction"),f=g=>{t({name:g.name,icon:g.icon,theme:g.theme}),a(!1)},u=()=>{l.trim()&&(t({name:l.trim(),icon:d,theme:p}),c(""),m("ðŸš«"),h("distraction"),a(!1))};return e.jsxs(ns,{open:r,onOpenChange:a,children:[e.jsx(Hx,{asChild:!0,children:e.jsxs(U,{variant:"outline",className:"w-full gap-2",children:[e.jsx(xa,{className:"h-4 w-4"}),"Add Bad Habit"]})}),e.jsxs(Vt,{className:"sm:max-w-md",children:[e.jsx(Bs,{children:e.jsxs(xs,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-5 w-5 text-primary"}),"Track a Bad Habit"]})}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsx(U,{variant:i==="preset"?"default":"outline",size:"sm",onClick:()=>o("preset"),className:"flex-1",children:"Quick Select"}),e.jsx(U,{variant:i==="custom"?"default":"outline",size:"sm",onClick:()=>o("custom"),className:"flex-1",children:"Custom"})]}),i==="preset"?e.jsx("div",{className:"grid grid-cols-2 gap-2 max-h-[300px] overflow-y-auto",children:Fy.map(g=>e.jsx(Ks,{variant:"subtle",className:"p-3 cursor-pointer hover:bg-primary/10 transition-colors",onClick:()=>f(g),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:g.icon}),e.jsx("span",{className:"text-sm font-medium",children:g.name})]})},g.name))}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(at,{htmlFor:"habit-name",children:"Habit Name"}),e.jsx(ot,{id:"habit-name",placeholder:"e.g., Late night snacking",value:l,onChange:g=>c(g.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(at,{htmlFor:"habit-icon",children:"Icon"}),e.jsx(ot,{id:"habit-icon",placeholder:"ðŸš«",value:d,onChange:g=>m(g.target.value),maxLength:2,className:"text-center text-xl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(at,{htmlFor:"habit-theme",children:"Category"}),e.jsxs(Na,{value:p,onValueChange:g=>h(g),children:[e.jsx(Fr,{id:"habit-theme",children:e.jsx(ka,{})}),e.jsx($r,{children:qv.map(g=>e.jsx(Gs,{value:g.value,children:g.label},g.value))})]})]})]}),e.jsx(U,{className:"w-full",onClick:u,disabled:!l.trim()||s,children:"Add Habit"})]})]})]})});gm.displayName="AddBadHabitDialog";const Ov=()=>{const{user:t}=be(),s=Ae(),{data:r,isLoading:a}=Ee({queryKey:["bad-habits",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:p,error:h}=await S.from("user_bad_habits").select("*").eq("user_id",t.id).eq("is_active",!0).order("created_at",{ascending:!1});if(h)throw h;return p},enabled:!!t?.id}),{data:i,isLoading:o}=Ee({queryKey:["resist-log",t?.id],queryFn:async()=>{if(!t?.id)return[];const p=new Date;p.setDate(p.getDate()-30);const{data:h,error:f}=await S.from("resist_log").select("*").eq("user_id",t.id).gte("created_at",p.toISOString()).order("created_at",{ascending:!1});if(f)throw f;return h},enabled:!!t?.id}),l=le({mutationFn:async p=>{if(!t?.id)throw new Error("User not found");const{data:h,error:f}=await S.from("user_bad_habits").insert({user_id:t.id,name:p.name,icon:p.icon,habit_theme:p.theme}).select().single();if(f)throw f;return h},onSuccess:p=>{s.setQueryData(["bad-habits",t?.id],h=>[p,...h??[]]),s.invalidateQueries({queryKey:["bad-habits"]}),W.success("Bad habit added! Ready to resist.")},onError:p=>{console.error("Failed to add habit:",p),W.error("Failed to add habit")}}),c=le({mutationFn:async p=>{if(!t?.id)throw new Error("User not found");const{error:h}=await S.from("user_bad_habits").update({is_active:!1}).eq("id",p).eq("user_id",t.id);if(h)throw h},onSuccess:(p,h)=>{s.setQueryData(["bad-habits",t?.id],f=>(f??[]).filter(u=>u.id!==h)),s.invalidateQueries({queryKey:["bad-habits"]}),W.success("Habit removed")},onError:p=>{console.error("Failed to remove habit:",p),W.error("Failed to remove habit")}}),d=n.useCallback(p=>r?.find(h=>h.id===p),[r]),m=n.useMemo(()=>{const p=r?.reduce((g,y)=>g+y.times_resisted,0)??0,h=i?.filter(g=>g.result!=="fail").length??0,f=i?.filter(g=>new Date(g.created_at).toDateString()===new Date().toDateString()&&g.result!=="fail").length??0,u=Math.max(...r?.map(g=>g.longest_streak)??[0]);return{totalResisted:p,successfulResists:h,todayResists:f,bestStreak:u}},[r,i]);return{habits:r,resistHistory:i,stats:m,isLoading:a||o,isAddingHabit:l.isPending,isRemovingHabit:c.isPending,addHabit:l.mutate,removeHabit:c.mutate,getHabit:d}},xm=n.memo(()=>{const{habits:t,stats:s,isLoading:r,addHabit:a,removeHabit:i,isAddingHabit:o}=Ov(),{checkEncounterTrigger:l,isTriggeringEncounter:c}=Ru(),[d,m]=n.useState(null),[p,h]=n.useState(!1),f=n.useCallback(async y=>{if(!(p||c)){m(y.id),h(!0);try{await l("urge_resist",y.id,void 0,y.habit_theme)}finally{m(null),h(!1)}}},[l,p,c]),u=n.useCallback(y=>{a(y)},[a]),g=n.useCallback(y=>{i(y)},[i]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(Ks,{variant:"subtle",className:"p-4 text-center space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-primary",children:[e.jsx(Es,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium",children:"Resist urges to grow stronger"}),e.jsx(Es,{className:"h-5 w-5"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Beat a quick game instead of giving in to bad habits"})]}),(s.totalResisted>0||s.bestStreak>0)&&e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs(Ks,{variant:"inset",className:"p-3 text-center",children:[e.jsx("div",{className:"flex items-center justify-center gap-1 text-primary mb-1",children:e.jsx(At,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"text-lg font-bold",children:s.totalResisted}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Total"})]}),e.jsxs(Ks,{variant:"inset",className:"p-3 text-center",children:[e.jsx("div",{className:"flex items-center justify-center gap-1 text-orange-400 mb-1",children:e.jsx(Gt,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"text-lg font-bold",children:s.bestStreak}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Best Streak"})]}),e.jsxs(Ks,{variant:"inset",className:"p-3 text-center",children:[e.jsx("div",{className:"flex items-center justify-center gap-1 text-green-400 mb-1",children:e.jsx(ft,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"text-lg font-bold",children:s.todayResists}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Today"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Pe,{mode:"popLayout",children:t?.map(y=>e.jsx(pm,{habit:y,onResist:()=>f(y),onRemove:()=>g(y.id),isLoading:p||c||d===y.id},y.id))}),!r&&(!t||t.length===0)&&e.jsxs(M.div,{initial:{opacity:0},animate:{opacity:1},className:"py-8 text-center",children:[e.jsx(Es,{className:"h-12 w-12 mx-auto text-muted-foreground/50 mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"No habits tracked yet"}),e.jsx("p",{className:"text-xs text-muted-foreground/70",children:"Add a bad habit to start building resistance"})]})]}),e.jsx(gm,{onAdd:u,isLoading:o})]})});xm.displayName="ResistModePanel";const ym=n.memo(()=>{const[t,s]=n.useState("focus");return e.jsxs("div",{className:"space-y-6 mt-6",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(U,{variant:t==="focus"?"default":"outline",size:"sm",onClick:()=>s("focus"),className:"flex-1 gap-2",children:[e.jsx(Tn,{className:"h-4 w-4"}),"Focus"]}),e.jsxs(U,{variant:t==="resist"?"default":"outline",size:"sm",onClick:()=>s("resist"),className:"flex-1 gap-2",children:[e.jsx(Es,{className:"h-4 w-4"}),"Resist"]})]}),t==="focus"?e.jsxs(e.Fragment,{children:[e.jsxs(Ks,{variant:"subtle",className:"p-4 text-center space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-primary",children:[e.jsx(pe,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium",children:"Focus to grow your companion"}),e.jsx(pe,{className:"h-5 w-5"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"XP earned from focus sessions helps your companion evolve"})]}),e.jsx(Pv,{})]}):e.jsx(xm,{})]})});ym.displayName="FocusTab";const Fv={joyful:{saturation:80,lightness:65,glowIntensity:.4},content:{saturation:60,lightness:55,glowIntensity:.3},neutral:{saturation:40,lightness:50,glowIntensity:.2},reserved:{saturation:25,lightness:45,glowIntensity:.15},quiet:{saturation:15,lightness:40,glowIntensity:.1},dormant:{saturation:5,lightness:30,glowIntensity:0}},bm=()=>{const{presence:t}=Rn();return n.useMemo(()=>{const{auraHue:s,mood:r,auraOpacity:a}=t,i=Fv[r],o=`hsl(${s}, ${i.saturation}%, ${i.lightness}%)`,l=`hsl(${(s+30)%360}, ${i.saturation*.8}%, ${i.lightness}%)`,c=i.glowIntensity>0?`0 0 20px hsla(${s}, ${i.saturation}%, ${i.lightness}%, ${i.glowIntensity}), 
         0 0 40px hsla(${s}, ${i.saturation}%, ${i.lightness}%, ${i.glowIntensity*.5})`:"none",d=`radial-gradient(
      ellipse at 50% 30%,
      hsla(${s}, ${i.saturation}%, ${i.lightness}%, ${a}),
      transparent 70%
    )`,m=`hsla(${s}, ${i.saturation}%, ${i.lightness+15}%, 0.8)`,p=i.glowIntensity>0?`0 0 12px hsla(${s}, ${i.saturation}%, ${i.lightness}%, ${i.glowIntensity*.8})`:"none";return{primaryAura:o,secondaryAura:l,glowShadow:c,gradientOverlay:d,particleColor:m,navGlow:p}},[t])},vm=n.memo(({className:t,chance:s=.15})=>{const{getRandomMemory:r,getMemoryDialogue:a,referenceMemory:i,memories:o}=go(),{presence:l}=Rn(),{primaryAura:c}=bm(),[d,m]=n.useState(null),[p,h]=n.useState(!1),f=n.useRef(!1);return n.useEffect(()=>{if(!l.isPresent||l.mood==="dormant"||o.length===0||f.current||Math.random()>s)return;const u=setTimeout(()=>{const g=r();if(g){const y=a(g);y&&(m(y),h(!0),i(g.id),f.current=!0)}},2e3);return()=>clearTimeout(u)},[o.length,l.isPresent,l.mood,s]),!d||!p?null:e.jsx(Pe,{children:e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},transition:{duration:.3},className:A("mt-2 p-2 rounded-lg","bg-primary/5 border border-primary/10",t),style:{boxShadow:`inset 0 0 20px ${c}15`},children:e.jsxs("p",{className:"text-xs text-muted-foreground italic",children:['ðŸ’­ "',d,'"']})})})});vm.displayName="MemoryWhisper";const wm=t=>["companion-stories-all",t],_m=async t=>{const{data:s,error:r}=await S.from("companion_stories").select("*").eq("companion_id",t).order("stage",{ascending:!0});if(r)throw r;return s},kk=(t,s)=>{const{user:r}=be(),a=Ae(),{data:i,isLoading:o}=Ee({queryKey:["companion-story",t,s],queryFn:async()=>{if(!t||s===void 0)return null;const{data:d,error:m}=await S.from("companion_stories").select("*").eq("companion_id",t).eq("stage",s).maybeSingle();if(m)throw console.error("Failed to fetch companion story:",m),m;return d},enabled:!!t&&s!==void 0,placeholderData:d=>d,staleTime:120*1e3}),{data:l}=Ee({queryKey:wm(t),queryFn:async()=>t?_m(t):[],enabled:!!t}),c=le({mutationFn:async d=>{if(!r)throw new Error("Not authenticated");W.loading("Your story is being written...",{id:"story-gen"});const{data:m,error:p}=await S.functions.invoke("generate-companion-story",{body:{companionId:d.companionId,stage:d.stage}});if(p)throw console.error("Story generation error:",p),new Error("Unable to write your story right now. Please try again.");return m},onSuccess:()=>{W.dismiss("story-gen"),W.success("ðŸ“– New chapter unlocked!"),a.invalidateQueries({queryKey:["companion-story"]}),a.invalidateQueries({queryKey:["companion-stories-all"]})},onError:d=>{W.dismiss("story-gen"),console.error("Story generation failed:",d),W.error(d instanceof Error?d.message:"Something went wrong. Please try again.")}});return{story:i,allStories:l,isLoading:o,generateStory:c}},Oi=t=>["companion-postcards",t],jm=async t=>{const{data:s,error:r}=await S.from("companion_postcards").select("*").eq("user_id",t).order("generated_at",{ascending:!1});if(r)throw r;return s},$v=()=>{const{user:t}=be(),s=Ae(),[r,a]=n.useState(null),i=n.useCallback(()=>{a(null)},[]),{data:o,isLoading:l,error:c}=Ee({queryKey:Oi(t?.id),queryFn:async()=>t?.id?jm(t.id):[],enabled:!!t?.id}),d=le({mutationFn:async({companionId:h,epicId:f,milestonePercent:u,companionData:g,milestoneTitle:y})=>{if(!t?.id)throw new Error("Not authenticated");const{data:b,error:v}=await S.functions.invoke("generate-cosmic-postcard",{body:{userId:t.id,companionId:h,epicId:f,milestonePercent:u,companionData:g}});if(v)throw v;if(b?.error)throw new Error(b.error);return{...b,milestoneTitle:y}},onSuccess:async h=>{if(!h?.existing&&(s.invalidateQueries({queryKey:Oi(t?.id)}),a({milestoneTitle:h?.milestoneTitle,chapterNumber:h?.postcard?.chapter_number,locationName:h?.postcard?.location_name}),W.success("ðŸ“¸ New cosmic postcard unlocked!",{description:`Your companion visited ${h?.postcard?.location_name}!`}),h?.postcard?.chapter_number&&h?.postcard?.epic_id&&t?.id))try{await S.functions.invoke("generate-journey-path",{body:{epicId:h.postcard.epic_id,milestoneIndex:h.postcard.chapter_number,userId:t.id}}),s.invalidateQueries({queryKey:["journey-path",h.postcard.epic_id]})}catch(f){console.error("Failed to regenerate journey path:",f)}},onError:h=>{console.error("Failed to generate postcard:",h)}}),m=n.useCallback(async(h,f,u,g,y)=>{const b=[25,50,75,100];for(const v of b)if(u<v&&f>=v&&!o?.find(w=>w.epic_id===h&&w.milestone_percent===v)){d.mutate({companionId:g,epicId:h,milestonePercent:v,companionData:y});break}},[o,d]),p=n.useCallback(async(h,f,u,g)=>{if(!t?.id)return;const{data:y,error:b}=await S.from("epic_milestones").select("id, title, milestone_percent, is_postcard_milestone").eq("id",h).maybeSingle();if(b){console.error("Failed to fetch milestone:",b);return}if(!y){console.log("Milestone not found");return}if(!y.is_postcard_milestone){console.log("Milestone is not marked for postcard generation");return}if(o?.find(x=>x.epic_id===f&&x.milestone_percent===y.milestone_percent)){console.log("Postcard already exists for this milestone");return}d.mutate({companionId:u,epicId:f,milestonePercent:y.milestone_percent,companionData:g,milestoneTitle:y.title})},[t?.id,o,d]);return{postcards:o||[],isLoading:l,error:c,generatePostcard:d,checkAndGeneratePostcard:m,checkMilestoneForPostcard:p,isGenerating:d.isPending,postcardJustUnlocked:r,clearPostcardUnlocked:i}},Hv=["overview","focus","stories","postcards","collection"],Bv={overview:!0,focus:!1,stories:!1,postcards:!1,collection:!1},Uv=t=>Hv.includes(t),Nm=n.memo(({companion:t,nextEvolutionXP:s,progressToNext:r})=>e.jsxs("div",{className:"space-y-6 mt-6",children:[e.jsx(vm,{chance:.2,className:"px-2"}),e.jsx(cs,{offset:30,children:e.jsx(rm,{})}),e.jsx(cs,{offset:22,children:e.jsx("div",{"data-tour":"companion-progress-area",children:e.jsx(am,{currentXP:t?.current_xp||0,nextEvolutionXP:s||0,currentStage:t?.current_stage||0,progressPercent:r})})}),e.jsx(cs,{offset:16,children:e.jsx(om,{})}),e.jsx(cs,{offset:12,children:e.jsx(nm,{})})]}));Nm.displayName="OverviewTab";const km=()=>ke(()=>import("./CompanionStoryJournal-CbCcUkaX.js"),__vite__mapDeps([12,1,2,3])).then(t=>({default:t.CompanionStoryJournal})),Cm=()=>ke(()=>import("./CompanionPostcards-CszyoJhe.js"),__vite__mapDeps([13,1,2,3,14])).then(t=>({default:t.CompanionPostcards})),zv=n.lazy(km),Qv=n.lazy(Cm),Al=()=>e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsx(je,{className:"h-48 w-full rounded-xl"}),e.jsx(je,{className:"h-32 w-full rounded-xl"})]}),Kv=()=>e.jsxs("div",{className:"space-y-6 mt-6",children:[e.jsxs("div",{className:"rounded-xl border border-cosmiq-glow/10 p-6",children:[e.jsx(je,{className:"h-48 w-48 rounded-full mx-auto"}),e.jsx(je,{className:"h-6 w-32 mx-auto mt-4"})]}),e.jsx(je,{className:"h-32 w-full rounded-xl"}),e.jsx(je,{className:"h-40 w-full rounded-xl"}),e.jsx(je,{className:"h-24 w-full rounded-xl"})]}),Wv=()=>{const t=Ea(),{isTabActive:s}=La(),{companion:r,nextEvolutionXP:a,progressToNext:i,isLoading:o,error:l,refetch:c}=Tt({enabled:s}),{user:d}=be(),m=Ae(),[p,h]=n.useState("overview"),[f,u]=n.useState(()=>Bv),g=n.useRef(null),y=Ma(),b=n.useRef(y.pathname),v=as(),x=n.useCallback(k=>{u(P=>P[k]?P:{...P,[k]:!0})},[]),w=n.useCallback(()=>{if(!s)return Promise.resolve([]);const k=[km()];return r?.id&&k.push(m.prefetchQuery({queryKey:wm(r.id),queryFn:()=>_m(r.id)})),Promise.allSettled(k)},[r?.id,s,m]),j=n.useCallback(()=>{if(!s)return Promise.resolve([]);const k=[Cm()];return d?.id&&k.push(m.prefetchQuery({queryKey:Oi(d.id),queryFn:()=>jm(d.id)})),Promise.allSettled(k)},[s,m,d?.id]),D=n.useCallback(()=>{w(),j()},[j,w]),C=n.useCallback(()=>{s&&w()},[s,w]),_=n.useCallback(()=>{s&&j()},[s,j]),N=n.useCallback(k=>{Uv(k)&&(h(k),x(k),s&&(k==="stories"?w():k==="postcards"&&j()))},[s,x,j,w]);n.useEffect(()=>{y.pathname==="/companion"&&b.current!=="/companion"&&h("overview"),b.current=y.pathname},[y.pathname]),n.useEffect(()=>{if(!s||!r?.id||!d?.id)return;const k=`${d.id}:${r.id}`;if(g.current===k)return;g.current=k;const P=window;let T=null,I=null;return P.requestIdleCallback?I=P.requestIdleCallback(()=>{D()},{timeout:1500}):T=window.setTimeout(()=>{D()},500),()=>{T!==null&&window.clearTimeout(T),I!==null&&P.cancelIdleCallback&&P.cancelIdleCallback(I)}},[r?.id,s,D,d?.id]);const E=()=>l?e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs("div",{className:"text-center space-y-4 p-6",children:[e.jsx(pe,{className:"h-16 w-16 mx-auto text-destructive"}),e.jsx("h2",{className:"text-2xl font-bold",children:"Error Loading Companion"}),e.jsx("p",{className:"text-muted-foreground max-w-md",children:l instanceof Error?l.message:"Unable to load your companion data. Please try refreshing the page."}),e.jsx(U,{variant:"default",onClick:()=>{c()},className:"mt-4 h-11 px-6",children:"Retry"})]})}):!o&&!r?e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs("div",{className:"text-center space-y-4 p-6",children:[e.jsx(pe,{className:"h-16 w-16 mx-auto text-primary"}),e.jsx("h2",{className:"text-2xl font-bold",children:"No Companion Found"}),e.jsx("p",{className:"text-muted-foreground max-w-md",children:"It looks like you haven't created your companion yet. Please complete the onboarding process to get started."}),e.jsx(U,{variant:"default",onClick:()=>v("/onboarding"),className:"mt-4 h-11 px-6",children:"Start Onboarding"})]})}):e.jsxs(xo,{value:p,onValueChange:N,className:"container pb-6",children:[e.jsxs(Fn,{className:"grid w-full grid-cols-5 bg-card/80 backdrop-blur-md border border-border/60",children:[e.jsxs(Ns,{value:"overview",className:"flex items-center gap-2",children:[e.jsx(Ts,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Overview"})]}),e.jsxs(Ns,{value:"focus",className:"flex items-center gap-2",children:[e.jsx(Tn,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Focus"})]}),e.jsxs(Ns,{value:"stories",className:"flex items-center gap-2",onPointerDown:C,onFocus:C,children:[e.jsx(ga,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Stories"})]}),e.jsxs(Ns,{value:"postcards",className:"flex items-center gap-2",onPointerDown:_,onFocus:_,children:[e.jsx(Da,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Postcards"})]}),e.jsxs(Ns,{value:"collection",className:"flex items-center gap-2",children:[e.jsx(of,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Collection"})]})]}),e.jsx(Pe,{mode:"wait",children:o?e.jsx(M.div,{initial:{opacity:1},exit:{opacity:0},transition:{duration:t?0:.15},children:e.jsx(Kv,{})},"skeleton"):e.jsxs(M.div,{initial:t?!1:{opacity:0},animate:{opacity:1},transition:{duration:t?0:.2},children:[e.jsx(ks,{value:"overview",forceMount:!0,className:"data-[state=inactive]:hidden",children:f.overview&&e.jsx(Nm,{companion:r,nextEvolutionXP:a,progressToNext:i})}),e.jsx(ks,{value:"focus",forceMount:!0,className:"data-[state=inactive]:hidden",children:f.focus&&e.jsx(ym,{})}),e.jsx(ks,{value:"stories",forceMount:!0,className:"data-[state=inactive]:hidden",children:f.stories&&e.jsx(n.Suspense,{fallback:e.jsx(Al,{}),children:e.jsx(zv,{})})}),e.jsx(ks,{value:"postcards",forceMount:!0,className:"data-[state=inactive]:hidden",children:f.postcards&&e.jsx(n.Suspense,{fallback:e.jsx(Al,{}),children:e.jsx(Qv,{})})}),e.jsx(ks,{value:"collection",forceMount:!0,className:"data-[state=inactive]:hidden",children:f.collection&&e.jsx(mm,{})})]},"content")})]});return e.jsx(Ia,{mode:"instant",children:e.jsxs(Fu,{children:[e.jsx(qa,{}),e.jsxs("div",{className:"min-h-screen pb-nav-safe relative z-10","data-tour":"companion-page",children:[e.jsx("header",{className:"fixed top-0 left-0 right-0 z-40 w-full cosmiq-glass-header safe-area-top",children:e.jsxs("div",{className:"container flex items-center justify-between py-4",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight",children:"Companion"}),e.jsx(U,{variant:"ghost",size:"icon",onClick:()=>v("/profile"),className:"h-8 w-8 rounded-full bg-muted/50 hover:bg-muted text-muted-foreground hover:text-foreground transition-colors","aria-label":"Settings",children:e.jsx(nf,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"pt-safe",style:{height:"calc(env(safe-area-inset-top, 0px) + 72px)"}}),E()]})]})})},Gv=({icon:t,title:s,description:r,actionLabel:a,onAction:i})=>e.jsxs("div",{className:"flex flex-col items-center justify-center text-center space-y-6 py-20",children:[e.jsx("div",{className:"mx-auto w-20 h-20 rounded-full bg-celestial-blue/10 flex items-center justify-center",children:e.jsx(t,{className:"h-10 w-10 text-celestial-blue"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl font-bold text-foreground",children:s}),e.jsx("p",{className:"text-muted-foreground max-w-md mx-auto",children:r})]}),a&&i&&e.jsx(U,{onClick:i,size:"lg",className:"mt-4",children:a})]}),Yv=/^([01]?\d|2[0-3]):([0-5]\d)$/,Vv=/^([01]?\d|2[0-3]):([0-5]\d):([0-5]\d)$/,$n=t=>{if(!t)return null;const s=t.trim();if(!s)return null;const r=s.match(Yv);if(r){const l=Number(r[1]),c=Number(r[2]);return{hour:l,minute:c,normalized:`${String(l).padStart(2,"0")}:${String(c).padStart(2,"0")}`}}const a=s.match(Vv);if(a){const l=Number(a[1]),c=Number(a[2]);return{hour:l,minute:c,normalized:`${String(l).padStart(2,"0")}:${String(c).padStart(2,"0")}`}}const i=Qf(s,"h:mm a",new Date);if(pn(i)){const l=i.getHours(),c=i.getMinutes();return{hour:l,minute:c,normalized:`${String(l).padStart(2,"0")}:${String(c).padStart(2,"0")}`}}const o=new Date(s);if(pn(o)){const l=o.getHours(),c=o.getMinutes();return{hour:l,minute:c,normalized:te(o,"HH:mm")}}return null},Fi=t=>$n(t)?.normalized??null,Ca=(t,s=new Date)=>{const r=$n(t);if(!r)return null;const a=new Date(s);return a.setHours(r.hour,r.minute,0,0),Number.isNaN(a.getTime())?null:a},Xv=t=>!t,Tr=t=>{let s=t.task_date??null,r=Fi(t.scheduled_time),a=t.source??null,i=!1,o=!1;return s===null&&r!==null&&(r=null,o=!0),Xv(t.habit_source_id)&&s!==null&&r===null&&(s=null,a="inbox",i=!0),s===null&&r!==null&&(r=null,o=!0),{task_date:s,scheduled_time:r,habit_source_id:t.habit_source_id??null,source:a,normalizedToInbox:i,strippedScheduledTime:o}},dn=(t,s)=>Tr({task_date:s.task_date!==void 0?s.task_date:t.task_date,scheduled_time:s.scheduled_time!==void 0?s.scheduled_time:t.scheduled_time,habit_source_id:s.habit_source_id!==void 0?s.habit_source_id:t.habit_source_id,source:s.source!==void 0?s.source:t.source}),Sm="inbox-tasks",Em="inbox-count",Jv=t=>[Sm,t],Zv=t=>[Em,t],ew=async t=>{const{data:s,error:r}=await S.from("daily_tasks").select("*").eq("user_id",t).is("task_date",null).eq("completed",!1).order("created_at",{ascending:!1});if(r)throw r;return s||[]},tw=async t=>{const{count:s,error:r}=await S.from("daily_tasks").select("id",{count:"exact",head:!0}).eq("user_id",t).is("task_date",null).eq("completed",!1);if(r)throw r;return s??0},sw=(t={})=>{const{user:s}=be(),r=Ae(),{enabled:a=!0}=t,i=n.useCallback(()=>{r.invalidateQueries({queryKey:[Sm]}),r.invalidateQueries({queryKey:[Em]})},[r]),{data:o=[],isLoading:l}=Ee({queryKey:Jv(s?.id),queryFn:async()=>s?.id?ew(s.id):[],enabled:a&&!!s?.id,staleTime:30*1e3,gcTime:1800*1e3,placeholderData:p=>p,refetchOnWindowFocus:!1}),c=le({mutationFn:async({taskId:p,targetDate:h})=>{const{data:f,error:u}=await S.from("daily_tasks").select("task_date, scheduled_time, habit_source_id, source").eq("id",p).maybeSingle();if(u)throw u;if(!f)throw new Error("Task not found");const g=Tr({task_date:h,scheduled_time:f.scheduled_time,habit_source_id:f.habit_source_id,source:f.source}),y={task_date:g.task_date,scheduled_time:g.scheduled_time};g.source!==f.source&&(y.source=g.source);const{error:b}=await S.from("daily_tasks").update(y).eq("id",p);if(b)throw b;return g},onSuccess:p=>{i(),r.invalidateQueries({queryKey:["daily-tasks"]}),p?.normalizedToInbox&&W("Regular quests without time stay in Inbox.")}}),d=le({mutationFn:async({taskId:p,completed:h})=>{const{error:f}=await S.from("daily_tasks").update({completed:h,completed_at:h?new Date().toISOString():null}).eq("id",p);if(f)throw f},onSuccess:()=>{i()}}),m=le({mutationFn:async p=>{const{error:h}=await S.from("daily_tasks").delete().eq("id",p);if(h)throw h},onSuccess:()=>{i()}});return{inboxTasks:o,inboxCount:o.length,isLoading:l,scheduleTask:c.mutate,toggleInboxTask:d.mutate,deleteInboxTask:m.mutate}},rw=()=>{const{user:t}=be(),{data:s=0}=Ee({queryKey:Zv(t?.id),queryFn:async()=>t?.id?tw(t.id):0,enabled:!!t?.id,staleTime:30*1e3,gcTime:1800*1e3,placeholderData:r=>r,refetchOnWindowFocus:!1});return{inboxCount:s}},Rl="add-quest-fab-position",aw=500,nw={"top-left":{top:"calc(env(safe-area-inset-top, 0px) + 80px)",left:"16px",bottom:"auto",right:"auto"},"top-right":{top:"calc(env(safe-area-inset-top, 0px) + 80px)",right:"16px",bottom:"auto",left:"auto"},"bottom-left":{bottom:"144px",left:"16px",top:"auto",right:"auto"},"bottom-right":{bottom:"144px",right:"16px",top:"auto",left:"auto"}},Il=async(t=Wt.Medium)=>{if(nt.isNativePlatform())try{await fs.impact({style:t})}catch{}},iw=(t,s)=>{const r=window.innerWidth/2,a=window.innerHeight/2;return s<a&&t<r?"top-left":s<a?"top-right":t<r?"bottom-left":"bottom-right"},ow=({defaultPosition:t="bottom-right",onDragStart:s,onDragEnd:r}={})=>{const[a,i]=n.useState(()=>{const C=rt.getItem(Rl);return C&&["top-left","top-right","bottom-left","bottom-right"].includes(C)?C:t}),[o,l]=n.useState(!1),[c,d]=n.useState(!1),[m,p]=n.useState({x:0,y:0}),h=n.useRef(null),f=n.useRef(null);n.useEffect(()=>()=>{h.current&&clearTimeout(h.current)},[]),n.useEffect(()=>{rt.setItem(Rl,a)},[a]);const u=n.useCallback(()=>{h.current&&(clearTimeout(h.current),h.current=null)},[]),g=n.useCallback(C=>{C.preventDefault();const _=C.target.getBoundingClientRect();f.current={x:_.left+_.width/2,y:_.top+_.height/2},h.current=setTimeout(()=>{d(!0),Il(Wt.Medium)},aw)},[]),y=n.useCallback(()=>{u(),o||d(!1)},[u,o]),b=n.useCallback(()=>{u(),d(!1)},[u]),v=n.useCallback(()=>{c&&(l(!0),s?.())},[c,s]),x=n.useCallback((C,_)=>{if(!o){d(!1);return}const N=(f.current?.x||window.innerWidth/2)+_.offset.x,E=(f.current?.y||window.innerHeight/2)+_.offset.y,k=iw(N,E);i(k),l(!1),d(!1),p({x:0,y:0}),Il(Wt.Light),r?.(k)},[o,r]),w=n.useMemo(()=>nw[a],[a]),j=n.useMemo(()=>({drag:c,dragConstraints:{top:-500,left:-500,right:500,bottom:500},dragElastic:.1,dragMomentum:!1,onDragStart:v,onDragEnd:x}),[c,v,x]),D=n.useMemo(()=>({onPointerDown:g,onPointerUp:y,onPointerCancel:b}),[g,y,b]);return{position:a,isDragging:o,isLongPressing:c,dragControls:j,longPressHandlers:D,positionStyles:w,dragOffset:m}},Tm=({onTap:t})=>{const{isDragging:s,isLongPressing:r,dragControls:a,longPressHandlers:i,positionStyles:o}=ow(),l=()=>{!s&&!r&&t()},c=d=>{d.preventDefault()};return e.jsx(M.button,{"data-tour":"add-quest-fab",initial:{scale:0,opacity:0},animate:{scale:s?1.15:1,opacity:1,boxShadow:s?"0 8px 30px rgba(0,0,0,0.3)":"0 2px 8px rgba(0,0,0,0.1)"},whileTap:r?void 0:{scale:.9},onClick:l,onTouchStart:c,style:{position:"fixed",zIndex:50,WebkitTouchCallout:"none",WebkitUserSelect:"none",userSelect:"none",...o},className:"w-11 h-11 rounded-full bg-muted/60 backdrop-blur-sm border border-border/50 flex items-center justify-center hover:bg-muted/80 transition-colors touch-none select-none",...a,...i,children:e.jsx(xa,{className:"w-5 h-5 text-muted-foreground"})})},lr=n.forwardRef(({className:t,...s},r)=>e.jsx(pd,{ref:r,className:A("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...s,children:e.jsx(lf,{className:A("flex items-center justify-center text-current"),children:e.jsx(Pt,{className:"h-4 w-4"})})}));lr.displayName=pd.displayName;const gn=n.forwardRef(({className:t,onCheckedChange:s,...r},a)=>e.jsx(hd,{className:A("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50",t),onCheckedChange:i=>{mt.light(),s?.(i)},...r,ref:a,children:e.jsx(cf,{className:A("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})}));gn.displayName=hd.displayName;const lw=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],cw=({selectedDays:t,onDaysChange:s})=>{const r=i=>{t.includes(i)?s(t.filter(o=>o!==i)):s([...t,i].sort())},a=()=>{s([0,1,2,3,4,5,6])};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h4",{className:"text-sm font-medium text-foreground",children:["Select days (",t.length,"/7)"]}),e.jsx("button",{onClick:a,className:"text-xs text-primary hover:text-primary/80 font-medium",children:"Select all"})]}),e.jsx("div",{className:"grid grid-cols-7 gap-2",children:lw.map((i,o)=>e.jsx("button",{onClick:()=>r(o),className:A("aspect-square rounded-full flex items-center justify-center text-xs font-bold transition-all border-2",t.includes(o)?"bg-primary border-primary text-primary-foreground shadow-glow":"border-border bg-card text-muted-foreground hover:border-primary/50"),children:i.charAt(0)},i))})]})};function dw(){const[t,s]=n.useState([]),[r,a]=n.useState(!1),[i,o]=n.useState(null),l=n.useCallback(async(d,m=30,p="medium")=>{a(!0),o(null);try{const{data:h,error:f}=await S.functions.invoke("suggest-task-times",{body:{task_date:te(d,"yyyy-MM-dd"),estimated_duration:m,difficulty:p}});if(f)throw new Error(f.message);s(h?.suggestedSlots||[])}catch(h){console.error("[useSmartScheduling] Error fetching suggestions:",h),o(h instanceof Error?h.message:"Failed to get suggestions"),s([])}finally{a(!1)}},[]),c=n.useCallback(()=>{s([]),o(null)},[]);return{suggestedSlots:t,isLoading:r,error:i,getSuggestedSlots:l,clearSuggestions:c}}function uw(t){const[s,r]=t.split(":").map(Number),a=s>=12?"PM":"AM";return`${s%12||12}:${r.toString().padStart(2,"0")} ${a}`}const yo=t=>{const{suggestedSlots:s,getSuggestedSlots:r,isLoading:a}=dw(),[i,o]=n.useState(!1),l=[{value:15,label:"15 min"},{value:30,label:"30 min"},{value:45,label:"45 min"},{value:60,label:"1 hr"},{value:90,label:"1.5 hrs"},{value:120,label:"2 hrs"}],c=[{value:5,label:"5 minutes before"},{value:10,label:"10 minutes before"},{value:15,label:"15 minutes before"},{value:30,label:"30 minutes before"},{value:60,label:"1 hour before"},{value:120,label:"2 hours before"},{value:1440,label:"1 day before"},{value:10080,label:"1 week before"}],d=[{value:"none",label:"None"},{value:"daily",label:"Daily"},{value:"weekly",label:"Weekly"},{value:"custom",label:"Custom Days"}],[m,p]=n.useState(!1),[h,f]=n.useState(!1),[u,g]=n.useState(!1),y=async()=>{t.selectedDate&&(await r(t.selectedDate,t.estimatedDuration||30,t.taskDifficulty),o(!0))},b=s.slice(0,3),v=x=>{t.onScheduledTimeChange(x),o(!1)};return e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[!t.hideScheduledTime&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ft,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(at,{className:"text-sm font-medium",children:"Scheduled Time"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ot,{type:"time",step:300,value:t.scheduledTime||"",onChange:x=>t.onScheduledTimeChange(x.target.value||null),className:"flex-1"}),t.selectedDate&&e.jsxs(Ds,{open:i,onOpenChange:o,children:[e.jsx(Ps,{asChild:!0,children:e.jsx(U,{type:"button",variant:"outline",size:"icon",onClick:y,disabled:a,className:"shrink-0",children:a?e.jsx(bt,{className:"h-4 w-4 animate-spin"}):e.jsx(pe,{className:"h-4 w-4 text-primary"})})}),e.jsx(ys,{className:"w-64 p-2",align:"end",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground px-2 py-1",children:"Suggested Times"}),b.length===0?e.jsx("p",{className:"text-sm text-muted-foreground px-2 py-2",children:"No suggestions available"}):b.map((x,w)=>e.jsx("button",{type:"button",onClick:()=>v(x.time),className:"w-full flex items-start gap-2 px-2 py-2 text-left rounded-md hover:bg-accent transition-colors",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[w===0&&e.jsx(St,{className:"h-3 w-3 text-amber-500 fill-amber-500"}),e.jsx("span",{className:"font-medium text-sm",children:uw(x.time)})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:x.reason})]})},x.time))]})})]})]})]}),!t.hideDuration&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx($t,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(at,{className:"text-sm font-medium",children:"Estimated Duration"})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>p(!m),className:"w-full px-3 py-2 text-sm text-left border rounded-lg bg-background hover:bg-accent transition-colors flex items-center justify-between",children:[e.jsx("span",{children:t.estimatedDuration?l.find(x=>x.value===t.estimatedDuration)?.label||`${t.estimatedDuration} min`:"Select duration"}),e.jsx(Os,{className:"w-4 h-4 text-muted-foreground"})]}),m&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-popover border rounded-lg shadow-lg max-h-48 overflow-y-auto",children:l.map(x=>e.jsx("button",{type:"button",onClick:()=>{t.onEstimatedDurationChange(x.value),p(!1)},className:`w-full px-3 py-2 text-sm text-left hover:bg-accent transition-colors ${t.estimatedDuration===x.value?"bg-accent":""}`,children:x.label},x.value))})]})]}),t.scheduledTime&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(df,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(at,{className:"text-sm font-medium",children:"Early Reminder"})]}),e.jsx(gn,{checked:t.reminderEnabled,onCheckedChange:t.onReminderEnabledChange})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"You'll be notified when the quest starts. Add an early reminder to prepare ahead."}),t.reminderEnabled&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>g(!u),className:"w-full px-3 py-2 text-sm text-left border rounded-lg bg-background hover:bg-accent transition-colors flex items-center justify-between",children:[e.jsx("span",{children:c.find(x=>x.value===t.reminderMinutesBefore)?.label||"Select time"}),e.jsx(Os,{className:"w-4 h-4 text-muted-foreground"})]}),u&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-popover border rounded-lg shadow-lg max-h-48 overflow-y-auto",children:c.map(x=>e.jsx("button",{type:"button",onClick:()=>{t.onReminderMinutesBeforeChange(x.value),g(!1)},className:`w-full px-3 py-2 text-sm text-left hover:bg-accent transition-colors ${t.reminderMinutesBefore===x.value?"bg-accent":""}`,children:x.label},x.value))})]})]}),!t.hideRecurrence&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Rr,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(at,{className:"text-sm font-medium",children:"Recurrence"})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>f(!h),className:"w-full px-3 py-2 text-sm text-left border rounded-lg bg-background hover:bg-accent transition-colors flex items-center justify-between",children:[e.jsx("span",{children:d.find(x=>x.value===(t.recurrencePattern||"none"))?.label||"None"}),e.jsx(Os,{className:"w-4 h-4 text-muted-foreground"})]}),h&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-popover border rounded-lg shadow-lg",children:d.map(x=>e.jsx("button",{type:"button",onClick:()=>{t.onRecurrencePatternChange(x.value==="none"?null:x.value),f(!1)},className:`w-full px-3 py-2 text-sm text-left hover:bg-accent transition-colors ${(t.recurrencePattern||"none")===x.value?"bg-accent":""}`,children:x.label},x.value))})]}),(t.recurrencePattern==="custom"||t.recurrencePattern==="weekly")&&e.jsx(cw,{selectedDays:t.recurrenceDays,onDaysChange:t.onRecurrenceDaysChange})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Da,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(at,{className:"text-sm font-medium",children:"Location"})]}),e.jsx(ot,{value:t.location||"",onChange:x=>t.onLocationChange(x.target.value||null),placeholder:"Where will this happen? (optional)",className:"bg-muted/30 border-border/50"})]}),!t.hideMoreInformation&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ji,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(at,{className:"text-sm font-medium",children:"More Information"})]}),e.jsx(Kt,{value:t.moreInformation||"",onChange:x=>t.onMoreInformationChange(x.target.value||null),placeholder:"Add extra context, notes, or details (optional)",className:"min-h-[100px] resize-none bg-muted/30 border-border/50",style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent"},"data-vaul-no-drag":!0})]})]})},Mm=n.forwardRef(({className:t,...s},r)=>e.jsx(Ht,{ref:r,className:A("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",t),...s}));Mm.displayName=Ht.displayName;const Dm=n.forwardRef(({className:t,...s},r)=>e.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[e.jsx(uf,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(Ht.Input,{ref:r,className:A("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",t),...s})]}));Dm.displayName=Ht.Input.displayName;const Pm=n.forwardRef(({className:t,...s},r)=>e.jsx(Ht.List,{ref:r,className:A("max-h-[300px] overflow-y-auto overflow-x-hidden",t),...s}));Pm.displayName=Ht.List.displayName;const Am=n.forwardRef((t,s)=>e.jsx(Ht.Empty,{ref:s,className:"py-6 text-center text-sm",...t}));Am.displayName=Ht.Empty.displayName;const Rm=n.forwardRef(({className:t,...s},r)=>e.jsx(Ht.Group,{ref:r,className:A("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",t),...s}));Rm.displayName=Ht.Group.displayName;const mw=n.forwardRef(({className:t,...s},r)=>e.jsx(Ht.Separator,{ref:r,className:A("-mx-1 h-px bg-border",t),...s}));mw.displayName=Ht.Separator.displayName;const Im=n.forwardRef(({className:t,...s},r)=>e.jsx(Ht.Item,{ref:r,className:A("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",t),...s}));Im.displayName=Ht.Item.displayName;const Qt={contacts:{all:["contacts"],byUser:t=>["contacts",t],detail:t=>["contacts","detail",t]},contactInteractions:{all:["contact-interactions"],byContact:t=>["contact-interactions",t]},contactReminders:{all:["contact-reminders"],byContact:t=>["contact-reminders",t],upcoming:()=>["contact-reminders","upcoming"]}};function pw(){const{user:t}=be(),s=Ae(),r=Ee({queryKey:Qt.contacts.byUser(t?.id??""),queryFn:async()=>{const{data:c,error:d}=await S.from("contacts").select("*").eq("user_id",t.id).order("name",{ascending:!0});if(d)throw d;return c},enabled:!!t}),a=le({mutationFn:async c=>{const{data:d,error:m}=await S.from("contacts").insert({...c,user_id:t.id}).select().single();if(m)throw m;return d},onSuccess:()=>{s.invalidateQueries({queryKey:Qt.contacts.all}),W.success("Contact created")},onError:c=>{W.error("Failed to create contact"),console.error(c)}}),i=le({mutationFn:async({id:c,...d})=>{const{data:m,error:p}=await S.from("contacts").update(d).eq("id",c).select().single();if(p)throw p;return m},onSuccess:()=>{s.invalidateQueries({queryKey:Qt.contacts.all}),W.success("Contact updated")},onError:c=>{W.error("Failed to update contact"),console.error(c)}}),o=le({mutationFn:async c=>{const{error:d}=await S.from("contacts").delete().eq("id",c);if(d)throw d},onSuccess:()=>{s.invalidateQueries({queryKey:Qt.contacts.all}),W.success("Contact deleted")},onError:c=>{W.error("Failed to delete contact"),console.error(c)}}),l=le({mutationFn:async({id:c,is_favorite:d})=>{const{error:m}=await S.from("contacts").update({is_favorite:d}).eq("id",c);if(m)throw m},onMutate:async({id:c,is_favorite:d})=>{await s.cancelQueries({queryKey:Qt.contacts.byUser(t?.id??"")});const m=s.getQueryData(Qt.contacts.byUser(t?.id??""));return s.setQueryData(Qt.contacts.byUser(t?.id??""),p=>p?.map(h=>h.id===c?{...h,is_favorite:d}:h)),{previous:m}},onError:(c,d,m)=>{s.setQueryData(Qt.contacts.byUser(t?.id??""),m?.previous),W.error("Failed to update favorite")},onSettled:()=>{s.invalidateQueries({queryKey:Qt.contacts.all})}});return{contacts:r.data??[],isLoading:r.isLoading,createContact:a,updateContact:i,deleteContact:o,toggleFavorite:l}}function hw({value:t,onChange:s,placeholder:r="Link to contact...",disabled:a=!1}){const[i,o]=n.useState(!1),{contacts:l,isLoading:c}=pw(),d=n.useMemo(()=>!t||!l?null:l.find(p=>p.id===t)||null,[t,l]),m=p=>p.split(" ").map(h=>h[0]).join("").toUpperCase().slice(0,2);return e.jsxs(Ds,{open:i,onOpenChange:o,children:[e.jsx(Ps,{asChild:!0,children:e.jsxs(U,{variant:"outline",role:"combobox","aria-expanded":i,className:A("w-full justify-between bg-background/50",!d&&"text-muted-foreground"),disabled:a||c,children:[d?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Lr,{className:"h-5 w-5",children:[e.jsx(qr,{src:d.avatar_url||void 0}),e.jsx(Or,{className:"text-[10px]",children:m(d.name)})]}),e.jsx("span",{className:"truncate",children:d.name})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fd,{className:"h-4 w-4"}),e.jsx("span",{children:r})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[d&&e.jsx(Nt,{className:"h-4 w-4 opacity-50 hover:opacity-100",onClick:p=>{p.stopPropagation(),s(null)}}),e.jsx(mf,{className:"h-4 w-4 shrink-0 opacity-50"})]})]})}),e.jsx(ys,{className:"w-[300px] p-0",align:"start",children:e.jsxs(Mm,{children:[e.jsx(Dm,{placeholder:"Search contacts..."}),e.jsxs(Pm,{children:[e.jsx(Am,{children:"No contacts found."}),e.jsx(Rm,{children:l?.map(p=>e.jsxs(Im,{value:p.name,onSelect:()=>{s(p.id===t?null:p.id),o(!1)},children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs(Lr,{className:"h-6 w-6",children:[e.jsx(qr,{src:p.avatar_url||void 0}),e.jsx(Or,{className:"text-[10px]",children:m(p.name)})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm",children:p.name}),p.company&&e.jsx("span",{className:"text-xs text-muted-foreground",children:p.company})]})]}),e.jsx(Pt,{className:A("ml-auto h-4 w-4",t===p.id?"opacity-100":"opacity-0")})]},p.id))})]})]})})]})}const ar=10,fw=10*1024*1024,gw=[".jpg",".jpeg",".png",".webp",".gif",".pdf",".doc",".docx",".txt",".csv"],xw=["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain","text/csv"],yw="image/*,.pdf,.doc,.docx,.txt,.csv",bw="image/",vw=t=>{const s=t.lastIndexOf(".");return s<0?"":t.slice(s).toLowerCase()},ww=t=>{const s=vw(t.name);return gw.includes(s)||t.type?.startsWith(bw)?!0:xw.includes(t.type)},_w=(t,s=0,r=ar)=>{const a=[],i=[],o=Math.max(0,r-s);return o===0?{accepted:[],errors:[`You can attach up to ${ar} files.`]}:(t.forEach(l=>{if(!(i.length>=o)){if(!ww(l)){a.push(`"${l.name}" is not a supported file type.`);return}if(l.size>fw){a.push(`"${l.name}" exceeds the 10MB limit.`);return}i.push(l)}}),t.length>o&&a.push(`Only ${o} more file(s) can be attached (max ${ar}).`),{accepted:i,errors:a})};function jw(){const{user:t}=be(),[s,r]=n.useState(!1),[a,i]=n.useState(null),o=n.useCallback(b=>{if(b instanceof Error)return b.message;if(b&&typeof b=="object"&&"message"in b){const v=b.message;if(typeof v=="string")return v}return String(b??"")},[]),l=n.useCallback(b=>{const v=o(b).toLowerCase();return v.includes("cancelled")||v.includes("canceled")},[o]),c=n.useCallback(b=>{const v=o(b).toLowerCase();return v.includes("unsupported device")||v.includes("not supported")||v.includes("visionkit")||v.includes("removebackground")||v.includes("remove background")||v.includes("code=-8")},[o]),d=n.useCallback(b=>{const v=Date.now(),x=b?.split(".").pop()||"jpg";return`${t?.id}/${v}_${Math.random().toString(36).slice(2)}_quest.${x}`},[t?.id]),m=n.useCallback(async(b,v)=>{if(!t?.id)return i("User not authenticated"),null;r(!0),i(null);try{const x=d(v),{error:w}=await S.storage.from("quest-attachments").upload(x,b,{contentType:b.type||"application/octet-stream",upsert:!1});if(w)throw w;const{data:{publicUrl:j}}=S.storage.from("quest-attachments").getPublicUrl(x);return{fileUrl:j,filePath:x,fileName:v||`attachment-${Date.now()}`,mimeType:b.type||"application/octet-stream",fileSizeBytes:typeof b.size=="number"?b.size:0,isImage:!!b.type?.startsWith("image/")}}catch(x){const w=x instanceof Error?x.message:"Failed to upload attachment";return i(w),W.error(w),null}finally{r(!1)}},[d,t?.id]),p=n.useCallback(async(b,v)=>{const x=await m(b,v);return!x||!x.isImage?x?.fileUrl??null:x.fileUrl},[m]),h=n.useCallback(async()=>new Promise(b=>{const v=document.createElement("input");v.type="file",v.accept="image/*",v.capture="environment",v.onchange=async x=>{const w=x.target.files?.[0];if(!w){b(null);return}const j=await p(w,w.name);b(j)},v.oncancel=()=>b(null),v.click()}),[p]),f=n.useCallback(async()=>{if(!t?.id)return i("User not authenticated"),null;i(null);try{if(nt.isNativePlatform()){const{Camera:b,CameraResultType:v,CameraSource:x}=await ke(async()=>{const{Camera:w,CameraResultType:j,CameraSource:D}=await import("./vendor-FfY6MM0Z.js").then(C=>C.ef);return{Camera:w,CameraResultType:j,CameraSource:D}},__vite__mapDeps([1,2,3]));try{const w=await b.getPhoto({quality:80,allowEditing:!1,resultType:v.Base64,source:x.Prompt,width:1200,height:1200});if(!w.base64String)return null;const j=atob(w.base64String),D=new Array(j.length);for(let N=0;N<j.length;N++)D[N]=j.charCodeAt(N);const C=new Uint8Array(D),_=new Blob([C],{type:`image/${w.format||"jpeg"}`});return await p(_,`photo.${w.format||"jpg"}`)}catch(w){if(l(w))return null;if(c(w))return console.info("Native image picker unsupported on this device, falling back to file input",w),await h();throw w}}else return await h()}catch(b){if(l(b))return null;const v=o(b)||"Failed to pick image";return i(v),W.error(v),null}},[t?.id,p,o,l,c,h]),u=n.useCallback(async b=>{if(!t?.id)return i("User not authenticated"),[];const v=b?.currentCount??0,x=b?.maxCount??ar;return new Promise(w=>{const j=document.createElement("input");j.type="file",j.accept=yw,j.multiple=!0,j.onchange=async D=>{const C=Array.from(D.target.files??[]);if(C.length===0){w([]);return}const{accepted:_,errors:N}=_w(C,v,x);if(N.forEach(k=>W.error(k)),_.length===0){w([]);return}const E=[];for(const k of _){const P=await m(k,k.name);P&&E.push(P)}w(E)},j.oncancel=()=>w([]),j.click()})},[m,t?.id]),g=n.useCallback(async b=>{if(!t?.id)return i("User not authenticated"),!1;try{const v=typeof b=="string"?(()=>{const j=new URL(b).pathname.split("/"),D=j.findIndex(C=>C==="quest-attachments");return D===-1?null:j.slice(D+1).join("/")})():b.filePath;if(!v)return!1;const{error:x}=await S.storage.from("quest-attachments").remove([v]);if(x)throw x;return!0}catch(v){const x=v instanceof Error?v.message:"Failed to delete attachment";return i(x),console.error("Delete attachment error:",v),!1}},[t?.id]),y=n.useCallback(async b=>g(b),[g]);return{pickImage:f,pickAttachments:u,uploadImage:p,uploadAttachment:m,deleteImage:y,deleteAttachment:g,isUploading:s,error:a}}function Lm({attachments:t,onAttachmentsChange:s,className:r,disabled:a=!1,helperText:i=!0}){const{pickAttachments:o,deleteAttachment:l,isUploading:c}=jw(),d=Math.max(0,ar-t.length),m=!a&&d>0&&!c,p=async()=>{if(!m)return;const f=await o({currentCount:t.length,maxCount:ar});f.length!==0&&s([...t,...f])},h=async f=>{await l(f),s(t.filter(u=>u.fileUrl!==f.fileUrl))};return e.jsxs("div",{className:A("space-y-2",r),children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs(U,{type:"button",variant:"outline",size:"sm",disabled:!m,onClick:p,className:"gap-2",children:[c?e.jsx(bt,{className:"h-4 w-4 animate-spin"}):e.jsx(pf,{className:"h-4 w-4"}),c?"Uploading...":"Add Photo/File"]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[t.length,"/",ar]})]}),i&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Up to 10 files, 10MB each."}),t.length>0&&e.jsx("div",{className:"grid grid-cols-2 gap-2",children:t.map(f=>e.jsxs("div",{className:"relative rounded-lg border border-border/60 bg-card p-2",children:[e.jsx("button",{type:"button",onClick:()=>h(f),className:"absolute right-1 top-1 rounded-full bg-background/80 p-1 text-muted-foreground hover:text-destructive","aria-label":`Remove ${f.fileName}`,children:e.jsx(Nt,{className:"h-3 w-3"})}),f.isImage?e.jsx("a",{href:f.fileUrl,target:"_blank",rel:"noreferrer",className:"block",children:e.jsx("img",{src:f.fileUrl,alt:f.fileName,className:"h-16 w-full rounded object-cover"})}):e.jsx("a",{href:f.fileUrl,target:"_blank",rel:"noreferrer",className:"flex h-16 items-center justify-center rounded bg-muted/30",children:e.jsx(ya,{className:"h-5 w-5 text-muted-foreground"})}),e.jsxs("div",{className:"mt-2 flex items-center gap-1",children:[f.isImage?e.jsx(hf,{className:"h-3.5 w-3.5 text-muted-foreground"}):e.jsx(ya,{className:"h-3.5 w-3.5 text-muted-foreground"}),e.jsx("span",{className:"truncate text-xs text-muted-foreground",children:f.fileName})]})]},f.fileUrl))})]})}function Vr({className:t,classNames:s,showOutsideDays:r=!0,...a}){return e.jsx(ff,{showOutsideDays:r,className:A("p-3",t),classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center",caption_label:"text-sm font-medium hidden",caption_dropdowns:"flex gap-2 items-center",dropdown:"appearance-none bg-transparent border border-white/20 rounded-lg px-3 py-1.5 text-sm font-medium text-white cursor-pointer hover:border-white/40 hover:bg-white/5 focus:outline-none focus:ring-2 focus:ring-white/30 transition-all",dropdown_month:"",dropdown_year:"",dropdown_icon:"hidden",vhidden:"hidden",nav:"space-x-1 flex items-center",nav_button:A(_a({variant:"outline"}),"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"),nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-white/70 rounded-md w-9 font-normal text-[0.8rem]",row:"flex w-full mt-2",cell:"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:A(_a({variant:"ghost"}),"h-9 w-9 p-0 font-normal aria-selected:opacity-100 text-white hover:bg-white/10 hover:text-white"),day_range_end:"day-range-end",day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent text-accent-foreground",day_outside:"day-outside text-white/30 opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",day_disabled:"text-white/30 opacity-50",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible",...s},components:{IconLeft:()=>e.jsx(Cr,{className:"h-4 w-4"}),IconRight:()=>e.jsx(Et,{className:"h-4 w-4"})},...a})}Vr.displayName="Calendar";const bo=gf,qm=xf,Hn=n.forwardRef(({className:t,children:s,...r},a)=>e.jsx(gd,{ref:a,className:A("overflow-hidden","data-[state=open]:animate-collapsible-down","data-[state=closed]:animate-collapsible-up",t),...r,children:s}));Hn.displayName=gd.displayName;const vo=Fc,Nw=Oc,Om=n.forwardRef(({className:t,...s},r)=>e.jsx(Nn,{className:A("fixed inset-0 z-50 bg-black/58 backdrop-blur-[2px] data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...s,ref:r}));Om.displayName=Nn.displayName;const kw=Hr("fixed z-50 gap-4 border-border/70 bg-card/95 p-6 shadow-[0_20px_40px_rgba(0,0,0,0.34)] backdrop-blur-xl transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-200 data-[state=open]:duration-300",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),Bn=n.forwardRef(({side:t="right",className:s,children:r,...a},i)=>e.jsxs(Nw,{children:[e.jsx(Om,{}),e.jsx(kn,{ref:i,className:A(kw({side:t}),s),...a,children:r})]}));Bn.displayName=kn.displayName;const Fm=({className:t,...s})=>e.jsx("div",{className:A("flex flex-col space-y-2 text-center sm:text-left",t),...s});Fm.displayName="SheetHeader";const $m=({className:t,...s})=>e.jsx("div",{className:A("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...s});$m.displayName="SheetFooter";const Un=n.forwardRef(({className:t,...s},r)=>e.jsx(Cn,{ref:r,className:A("text-lg font-semibold text-foreground",t),...s}));Un.displayName=Cn.displayName;const wo=n.forwardRef(({className:t,...s},r)=>e.jsx(Sn,{ref:r,className:A("text-sm text-muted-foreground",t),...s}));wo.displayName=Sn.displayName;const us=xd("NativeCalendar",{web:()=>ke(()=>import("./NativeCalendarWeb-BdBzToYJ.js"),__vite__mapDeps([15,1,2,3])).then(t=>new t.NativeCalendarWeb)}),vr=t=>`${t}-calendar-auth`,Cw=()=>nt.isNativePlatform()&&nt.getPlatform()==="ios";function zn(t={}){const{user:s}=be(),r=Ae(),{enabled:a=!0}=t,i=Ee({queryKey:["calendar-user-settings",s?.id],enabled:a&&!!s?.id,queryFn:async()=>{if(!s?.id)return null;const{data:j,error:D}=await S.from("calendar_user_settings").select("user_id, integration_visible, nudge_dismissed_at, default_provider").eq("user_id",s.id).maybeSingle();if(D)throw D;return j}}),o=Ee({queryKey:["calendar-connections",s?.id],enabled:a&&!!s?.id,queryFn:async()=>{if(!s?.id)return[];const{data:j,error:D}=await S.from("user_calendar_connections").select("id, provider, calendar_email, primary_calendar_id, primary_calendar_name, sync_mode, sync_enabled, platform, last_synced_at").eq("user_id",s.id).eq("sync_enabled",!0).order("created_at",{ascending:!0});if(D)throw D;return j||[]}}),l=i.data,c=o.data||[],d=n.useMemo(()=>{const j={};for(const D of c)j[D.provider]=D;return j},[c]),m=l?.default_provider||null,p=l?.integration_visible??!1,h=async()=>{await Promise.all([r.invalidateQueries({queryKey:["calendar-user-settings"]}),r.invalidateQueries({queryKey:["calendar-connections"]}),r.invalidateQueries({queryKey:["quest-calendar-links"]})])},f=le({mutationFn:async j=>{if(!s?.id)throw new Error("User not authenticated");const D={user_id:s.id,integration_visible:p,default_provider:m,...j},{error:C}=await S.from("calendar_user_settings").upsert(D,{onConflict:"user_id"});if(C)throw C},onSuccess:h}),u=le({mutationFn:async({provider:j,redirectUri:D,syncMode:C="send_only"})=>{const _=vr(j),{data:N,error:E}=await S.functions.invoke(_,{body:{action:"getAuthUrl",redirectUri:D,syncMode:C}});if(E)throw new Error(E.message||`Failed to start ${j} connection`);return N?.url||N?.auth_url}}),g=le({mutationFn:async({provider:j,code:D,redirectUri:C,syncMode:_="send_only"})=>{const N=vr(j),{data:E,error:k}=await S.functions.invoke(N,{body:{action:"exchangeCode",code:D,redirectUri:C,syncMode:_}});if(k)throw new Error(k.message||`Failed to connect ${j}`);return E},onSuccess:h}),y=le({mutationFn:async j=>{if(j==="apple"){if(!s?.id)throw new Error("User not authenticated");const{error:_}=await S.from("user_calendar_connections").delete().eq("user_id",s.id).eq("provider","apple");if(_)throw _;return}const D=vr(j),{error:C}=await S.functions.invoke(D,{body:{action:"disconnect"}});if(C)throw new Error(C.message||`Failed to disconnect ${j}`)},onSuccess:h}),b=le({mutationFn:async({provider:j,syncMode:D})=>{if(j==="apple"){if(!s?.id)throw new Error("User not authenticated");const{error:N}=await S.from("user_calendar_connections").update({sync_mode:D}).eq("user_id",s.id).eq("provider","apple");if(N)throw N;return}const C=vr(j),{error:_}=await S.functions.invoke(C,{body:{action:"setSyncMode",syncMode:D}});if(_)throw new Error(_.message||`Failed to set ${j} sync mode`)},onSuccess:h}),v=le({mutationFn:async j=>{if(j==="apple"){if(!(await us.isAvailable()).available)return[];if(!(await us.requestPermissions()).granted)return[];const{calendars:P}=await us.listCalendars();return P.map(T=>({id:T.id,name:T.title,isPrimary:T.isPrimary}))}const D=vr(j),{data:C,error:_}=await S.functions.invoke(D,{body:{action:"listCalendars"}});if(_)throw new Error(_.message||`Failed to list ${j} calendars`);return(Array.isArray(C?.calendars)?C.calendars:[]).map(E=>({id:String(E.id),name:String(E.summary||E.name||E.id),isPrimary:!!(E.primary||E.isDefaultCalendar)}))}}),x=le({mutationFn:async({provider:j,calendarId:D,calendarName:C})=>{if(!D)throw new Error("calendarId is required");if(j==="apple"){if(!s?.id)throw new Error("User not authenticated");const{error:E}=await S.from("user_calendar_connections").update({primary_calendar_id:D,primary_calendar_name:C??D,calendar_id:D}).eq("user_id",s.id).eq("provider","apple");if(E)throw E;return}const _=vr(j),{error:N}=await S.functions.invoke(_,{body:{action:"setPrimaryCalendar",calendarId:D,calendarName:C}});if(N)throw new Error(N.message||`Failed to set ${j} primary calendar`)},onSuccess:h}),w=le({mutationFn:async({syncMode:j="send_only"}={})=>{if(!s?.id)throw new Error("User not authenticated");if(!Cw())throw new Error("Apple Calendar is only available on iOS native");if(!(await us.isAvailable()).available)throw new Error("Native Apple Calendar plugin unavailable");if(!(await us.requestPermissions()).granted)throw new Error("Calendar permission not granted");const{calendars:_}=await us.listCalendars(),N=_.find(k=>k.isPrimary)||_[0];if(!N)throw new Error("No writable Apple calendars found on this device");const{error:E}=await S.from("user_calendar_connections").upsert({user_id:s.id,provider:"apple",sync_enabled:!0,sync_mode:j,primary_calendar_id:N.id,primary_calendar_name:N.title,calendar_id:N.id,platform:"ios"},{onConflict:"user_id,provider"});if(E)throw E},onSuccess:h});return{settings:l,connections:c,connectedByProvider:d,defaultProvider:m,integrationVisible:p,isLoading:i.isLoading||o.isLoading,upsertSettings:f,beginOAuthConnection:u,completeOAuthConnection:g,disconnectProvider:y,setProviderSyncMode:b,listProviderCalendars:v,setPrimaryCalendar:x,connectAppleNative:w}}const Hm={easy:{bg:"bg-emerald-600",text:"text-emerald-400",pill:"bg-emerald-500",border:"border-emerald-500/40"},medium:{bg:"bg-[#FF914F]/80",text:"text-[#FF914F]",pill:"bg-[#FF914F]/80",border:"border-[#FF914F]/35"},hard:{bg:"bg-violet-500",text:"text-violet-400",pill:"bg-violet-500",border:"border-violet-500/40"}},Sw={easy:ft,medium:Gt,hard:Ta};function qs(t){const[s,r]=t.split(":").map(Number),a=s>=12?"PM":"AM";return`${s%12||12}:${String(r).padStart(2,"0")} ${a}`}function Ew(){const t=[];for(let s=0;s<24;s++)for(let r=0;r<60;r+=30)t.push(`${String(s).padStart(2,"0")}:${String(r).padStart(2,"0")}`);return t}function Bm(t=new Date){const s=new Date(t);s.setSeconds(0,0);const r=s.getMinutes(),a=r%30;return a!==0&&s.setMinutes(r+(30-a)),`${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}`}const Mr=Ew(),xn=[{label:"1m",value:1},{label:"15m",value:15},{label:"30m",value:30},{label:"45m",value:45},{label:"1h",value:60},{label:"1.5h",value:90},{label:"All Day",value:1440},{label:"Custom",value:-1}],Tw=({difficulty:t})=>{const s=Sw[t];return e.jsx(s,{className:"h-5 w-5"})},Um=n.memo(function({open:s,onOpenChange:r,selectedDate:a,prefilledTime:i,onAdd:o,isAdding:l=!1,onCreateCampaign:c,preventClose:d=!1,onPreventedCloseAttempt:m}){const[p,h]=n.useState(""),[f,u]=n.useState("medium"),[g,y]=n.useState(!1),[b,v]=n.useState(i??null),[x,w]=n.useState(30),[j,D]=n.useState(null),[C,_]=n.useState([]),[N,E]=n.useState(!1),[k,P]=n.useState(15),[T,I]=n.useState(null),[R,L]=n.useState(null),[$,q]=n.useState(null),[F,H]=n.useState(!0),[J,G]=n.useState(te(a,"yyyy-MM-dd")),[re,ie]=n.useState(!1),[K,xe]=n.useState(!1),[Te,Ne]=n.useState([]),[B,z]=n.useState(""),[Q,Y]=n.useState(!1),[ue,fe]=n.useState([]),{integrationVisible:De,defaultProvider:Ce,connections:Be}=zn(),qe=n.useMemo(()=>(Ce?Be.find(Le=>Le.provider===Ce)?.provider??null:null)||Be[0]?.provider||null,[Be,Ce]),he=!!(De&&Be.length>0&&qe),ye=n.useRef(null),Ue=n.useRef(null),Re=n.useRef([]),Ie=n.useRef(!1);n.useEffect(()=>{i&&v(i)},[i]),n.useEffect(()=>{s?G(te(a,"yyyy-MM-dd")):(h(""),u("medium"),y(!1),v(null),w(30),D(null),_([]),E(!1),P(15),I(null),L(null),q(null),H(!0),ie(!1),xe(!1),Ne([]),Y(!1),fe([]),Ie.current=!1)},[s,a]),n.useEffect(()=>{K&&Ue.current&&setTimeout(()=>{Ue.current?.scrollIntoView({block:"center",behavior:"smooth"})},150)},[K,b]);const ee=n.useMemo(()=>{if(!b||!x)return null;const me=Ca(b);return me?te(qd(me,x),"HH:mm"):null},[b,x]),ne=x!==null&&!xn.some(me=>me.value===x),X=n.useMemo(()=>x?x===1440?"All Day":x>=60?`${x/60}h`:`${x} min`:"No duration",[x]),ae=n.useMemo(()=>{const me=X;if(J){const Le=new Date(J+"T00:00:00");return so(Le)?`${me} - Today`:`${me} - ${te(Le,"EEE, MMM d")}`}return`${me} - Inbox`},[X,J]),Se=Hm[f],ve=J?new Date(J+"T00:00:00"):a,_e=!!J&&!!b,Me=!!p.trim()&&_e,et=n.useCallback((me,Le)=>{Ne(Xe=>{const pt=[...Xe];return pt[me]=Le,pt})},[]),Je=n.useCallback((me,Le)=>{Le.key==="Enter"&&Te[me]?.trim()&&(Le.preventDefault(),Ne(Xe=>{const pt=[...Xe];return pt.splice(me+1,0,""),pt}),setTimeout(()=>Re.current[me+1]?.focus(),50)),Le.key==="Backspace"&&!Te[me]&&Te.length>0&&(Le.preventDefault(),Ne(Xe=>Xe.filter((pt,ce)=>ce!==me)),setTimeout(()=>Re.current[Math.max(0,me-1)]?.focus(),50))},[Te]),lt=n.useCallback(me=>{Ne(Le=>Le.filter((Xe,pt)=>pt!==me))},[]),dt=n.useCallback(()=>{Ne(me=>[...me,""]),setTimeout(()=>Re.current[Te.length]?.focus(),50)},[Te.length]),Mt=n.useCallback(me=>{if(me){r(!0);return}if(d){window.dispatchEvent(new CustomEvent("add-quest-sheet-close-attempted")),m?.();return}r(!1)},[r,m,d]),vt=n.useCallback(async()=>{p.trim()&&(window.dispatchEvent(new CustomEvent("add-quest-create-attempted")),await o({text:p,taskDate:J,difficulty:f,scheduledTime:b,estimatedDuration:x,recurrencePattern:j,recurrenceDays:C,reminderEnabled:N,reminderMinutesBefore:k,moreInformation:T,location:R,contactId:$,autoLogInteraction:F,sendToInbox:!1,sendToCalendar:Q&&he,subtasks:Te.filter(me=>me.trim()),imageUrl:ue.find(me=>me.isImage)?.fileUrl??null,attachments:ue}),r(!1))},[p,J,f,b,x,j,C,N,k,T,R,$,F,Q,he,Te,ue,o,r]),Rt=n.useCallback(async()=>{p.trim()&&(await o({text:p,taskDate:null,difficulty:f,scheduledTime:null,estimatedDuration:x,recurrencePattern:j,recurrenceDays:C,reminderEnabled:N,reminderMinutesBefore:k,moreInformation:T,location:R,contactId:$,autoLogInteraction:F,sendToInbox:!0,sendToCalendar:!1,subtasks:Te.filter(me=>me.trim()),imageUrl:ue.find(me=>me.isImage)?.fileUrl??null,attachments:ue}),r(!1))},[p,f,x,j,C,N,k,T,R,$,F,Te,ue,o,r]);return n.useEffect(()=>{s&&window.dispatchEvent(new CustomEvent("add-quest-sheet-opened"))},[s]),n.useEffect(()=>{s&&(Ie.current||p.trim()&&(Ie.current=!0,window.dispatchEvent(new CustomEvent("add-quest-title-entered"))))},[s,p]),n.useEffect(()=>{b&&window.dispatchEvent(new CustomEvent("add-quest-time-selected",{detail:{scheduledTime:b}}))},[b]),e.jsx(vo,{open:s,onOpenChange:Mt,children:e.jsxs(Bn,{side:"bottom","data-tour":"add-quest-sheet",className:"h-[92vh] rounded-t-2xl flex flex-col p-0 gap-0 overflow-hidden",onOpenAutoFocus:me=>me.preventDefault(),children:[e.jsx(Un,{className:"sr-only",children:"Add Quest"}),e.jsx(wo,{className:"sr-only",children:"Create a new quest with schedule, subtasks, and optional details."}),e.jsxs("div",{className:A("relative px-5 pt-4 pb-5 flex-shrink-0",Se.bg),children:[e.jsx("button",{onClick:()=>Mt(!1),className:"absolute top-3 right-3 p-1.5 rounded-full bg-black/20 hover:bg-black/30 transition-colors text-white z-10","aria-label":"Close",children:e.jsx(Nt,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex flex-col items-center text-center pt-2 text-white",children:[e.jsx(Tw,{difficulty:f}),e.jsx("p",{className:"text-sm opacity-80 mt-1.5",children:"New Quest"}),e.jsx(ot,{"data-tour":"add-quest-title-input",placeholder:"Quest Title",value:p,onChange:me=>h(me.target.value),disabled:l,className:"mt-2 text-center text-lg font-bold bg-white/10 border-white/20 text-white placeholder:text-white/50 focus-visible:ring-white/30 h-11"}),e.jsx("p",{className:"text-white/70 text-xs mt-1",children:ae})]}),e.jsx("div",{className:"flex justify-center gap-3 mt-3",children:[{value:"easy",icon:ft,label:"Easy"},{value:"medium",icon:Gt,label:"Medium"},{value:"hard",icon:Ta,label:"Hard"}].map(({value:me,icon:Le,label:Xe})=>e.jsxs("button",{onClick:()=>u(me),className:A("w-14 h-12 rounded-xl flex flex-col items-center justify-center gap-0.5 transition-all border-2",f===me?"bg-white/30 border-white scale-110":"bg-white/10 border-transparent hover:bg-white/20"),children:[e.jsx(Le,{className:"h-4 w-4 text-white"}),e.jsx("span",{className:"text-[10px] font-medium text-white/80 leading-none",children:Xe})]},me))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4 space-y-3",children:[e.jsxs("button",{onClick:()=>ie(!re),className:"w-full flex items-center justify-between bg-card rounded-xl px-4 py-3 border border-border/50 hover:bg-muted/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2.5 text-sm font-medium",children:[e.jsx(Ft,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:X})]}),e.jsx(Et,{className:A("h-4 w-4 text-muted-foreground transition-transform",re&&"rotate-90")})]}),re&&e.jsxs("div",{className:"space-y-2 px-1",children:[e.jsx("div",{className:"flex gap-2 flex-wrap",children:xn.map(me=>{const Le=me.value===-1?ne:x===me.value;return e.jsx("button",{onClick:()=>{me.value===-1?(z(""),w(null)):(z(""),w(me.value))},className:A("px-4 py-2 rounded-lg text-sm font-bold transition-all duration-150",Le?A(Se.pill,"text-white shadow-md"):"bg-muted/50 text-muted-foreground hover:bg-muted"),children:me.label},me.value)})}),(ne||x===null&&B!==void 0)&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ot,{type:"number",inputMode:"numeric",placeholder:"Minutes",value:B,onChange:me=>{const Le=me.target.value;z(Le);const Xe=parseInt(Le,10);!isNaN(Xe)&&Xe>0?w(Xe):w(null)},className:"w-28 h-9 text-sm",autoFocus:!0}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"min"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Ds,{children:[e.jsx(Ps,{asChild:!0,children:e.jsxs("button",{className:A("flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border text-sm font-medium transition-colors",J?"bg-card border-border/50 text-foreground":"bg-muted/30 border-dashed border-border/50 text-muted-foreground"),children:[e.jsx($t,{className:"h-4 w-4"}),J?te(ve,"MMM d"):"Date"]})}),e.jsx(ys,{className:"w-auto p-0 z-[100]",align:"start",children:e.jsx(Vr,{mode:"single",selected:ve,onSelect:me=>G(me?te(me,"yyyy-MM-dd"):null),className:"pointer-events-auto"})})]}),e.jsxs("button",{onClick:()=>{b||v(Bm()),xe(!K)},"data-tour":"add-quest-time-chip",className:A("flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border text-sm font-medium transition-colors",b?"bg-card border-border/50 text-foreground":"bg-muted/30 border-dashed border-border/50 text-muted-foreground"),children:[e.jsx(Ft,{className:"h-4 w-4"}),b?qs(b):"Time"]})]}),K&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ot,{"aria-label":"Custom quest time","data-tour":"add-quest-time-input",type:"time",step:60,value:b||"",onChange:me=>v(me.target.value||null),className:"h-10"}),e.jsxs("div",{ref:ye,className:"relative h-[180px] overflow-y-auto rounded-xl bg-card border border-border/50 snap-y snap-mandatory scrollbar-none",style:{scrollbarWidth:"none"},children:[e.jsx("div",{className:"sticky top-0 h-12 bg-gradient-to-b from-card to-transparent z-10 pointer-events-none"}),e.jsx("div",{className:"flex flex-col items-center py-1",children:Mr.map(me=>{const Le=b===me,Xe=b?Mr.indexOf(b):-1,pt=Mr.indexOf(me),ce=Xe>=0?Math.abs(pt-Xe):0,Oe=Le?1:Math.max(.25,1-ce*.15);return e.jsx("button",{"data-tour":"add-quest-time-slot",ref:Le?Ue:void 0,onClick:()=>v(me),className:A("w-[85%] py-2.5 rounded-xl text-center text-sm font-semibold snap-center transition-all duration-150 my-0.5",Le?A(Se.pill,"text-white shadow-lg scale-[1.02]"):"text-foreground hover:bg-muted/50"),style:{opacity:Le?1:Oe},children:Le&&ee?`${qs(me)} â€“ ${qs(ee)}`:qs(me)},me)})}),e.jsx("div",{className:"sticky bottom-0 h-12 bg-gradient-to-t from-card to-transparent z-10 pointer-events-none"})]})]}),e.jsxs("div",{className:"bg-card rounded-xl border border-border/50 overflow-hidden",children:[Te.map((me,Le)=>e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b border-border/30 group",children:[e.jsx(lr,{disabled:!0,className:"h-4 w-4 opacity-50"}),e.jsx("input",{ref:Xe=>{Re.current[Le]=Xe},value:me,onChange:Xe=>et(Le,Xe.target.value),onKeyDown:Xe=>Je(Le,Xe),placeholder:"Subtask",className:"flex-1 bg-transparent text-sm outline-none placeholder:text-muted-foreground/50"}),e.jsx("button",{onClick:()=>lt(Le),className:"p-1 rounded opacity-0 group-hover:opacity-100 hover:bg-destructive/10 text-muted-foreground hover:text-destructive transition-all",children:e.jsx($s,{className:"h-3.5 w-3.5"})})]},Le)),e.jsxs("div",{role:"button",tabIndex:0,onClick:dt,onKeyDown:me=>{(me.key==="Enter"||me.key===" ")&&(me.preventDefault(),dt())},className:"flex items-center gap-2 px-3 py-2.5 w-full text-left hover:bg-muted/30 transition-colors border-b border-border/30 cursor-pointer",children:[e.jsx(lr,{disabled:!0,className:"h-4 w-4 opacity-30"}),e.jsx("span",{className:"text-sm text-muted-foreground/60",children:"Add Subtask"})]}),e.jsx(Kt,{value:T||"",onChange:me=>I(me.target.value||null),placeholder:"Add notes, meeting links or phone numbers...",className:"min-h-[70px] border-0 rounded-none bg-transparent resize-none focus-visible:ring-0 focus-visible:ring-offset-0 text-sm",style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent"},"data-vaul-no-drag":!0})]}),e.jsxs("div",{className:"space-y-2 px-1",children:[e.jsx(at,{className:"text-sm font-medium text-muted-foreground",children:"Photo / Files"}),e.jsx(Lm,{attachments:ue,onAttachmentsChange:fe})]}),e.jsxs(bo,{open:g,onOpenChange:y,children:[e.jsx(qm,{asChild:!0,children:e.jsxs(U,{variant:"ghost",size:"sm",className:"w-full justify-between text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(yd,{className:"w-4 h-4"}),"Advanced Settings"]}),e.jsx("span",{className:"text-xs",children:g?"â–²":"â–¼"})]})}),e.jsx(Hn,{children:e.jsxs("div",{className:"mt-3 space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground",children:[e.jsx(bd,{className:"w-4 h-4"}),e.jsx("span",{children:"Link to Contact"})]}),e.jsx(hw,{value:$,onChange:q,placeholder:"Select a contact..."}),$&&e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 bg-muted/30 rounded-lg",children:[e.jsx(at,{htmlFor:"auto-log-add",className:"text-sm cursor-pointer",children:"Log as interaction when completed"}),e.jsx(gn,{id:"auto-log-add",checked:F,onCheckedChange:H})]})]}),e.jsx(yo,{scheduledTime:b,estimatedDuration:x,recurrencePattern:j,recurrenceDays:C,reminderEnabled:N,reminderMinutesBefore:k,onScheduledTimeChange:v,onEstimatedDurationChange:w,onRecurrencePatternChange:D,onRecurrenceDaysChange:_,onReminderEnabledChange:E,onReminderMinutesBeforeChange:P,moreInformation:T,onMoreInformationChange:I,location:R,onLocationChange:L,selectedDate:a,taskDifficulty:f,hideScheduledTime:!0,hideDuration:!0,hideMoreInformation:!0})]})})]})]})}),e.jsxs("div",{className:"px-5 pt-4 pb-6 flex-shrink-0 flex flex-col gap-3 border-t border-border/50",children:[he&&e.jsxs("div",{className:"flex items-center justify-between rounded-md border border-border/50 px-3 py-2",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Send to ",qe==="apple"?"Apple":qe==="google"?"Google":"Outlook"," Calendar after create"]}),e.jsx(gn,{checked:Q,onCheckedChange:Y})]}),e.jsx(U,{onClick:vt,"data-tour":"add-quest-create-button",disabled:l||!Me,className:A("w-full text-white",Me?A(Se.pill,"hover:opacity-90"):""),children:l?"Creating...":"Create Quest"}),e.jsxs(U,{variant:"outline",onClick:Rt,disabled:l||!p.trim(),className:"w-full",children:[e.jsx(to,{className:"mr-2 h-4 w-4"}),"Add to Inbox instead"]}),c&&e.jsxs("button",{onClick:()=>{r(!1),c()},className:"text-xs text-muted-foreground hover:text-foreground transition-colors flex items-center justify-center gap-1.5 py-1",children:[e.jsx(da,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Or create a Campaign"}),e.jsx("span",{className:"rounded-full border border-border/60 px-2 py-0.5 text-[10px] leading-none text-muted-foreground/80",children:"Max 2 active"})]})]})]})})}),Mw=t=>{const{user:s}=be(),r=Ae(),{data:a=[],isLoading:i}=Ee({queryKey:["subtasks",t],queryFn:async()=>{if(!s?.id||!t)return[];const{data:u,error:g}=await S.from("subtasks").select("*").eq("task_id",t).eq("user_id",s.id).order("sort_order",{ascending:!0});if(g)throw g;return u},enabled:!!s?.id&&!!t}),o=le({mutationFn:async u=>{if(!s?.id||!t)throw new Error("Missing required data");const g=a.length>0?Math.max(...a.map(v=>v.sort_order))+1:0,{data:y,error:b}=await S.from("subtasks").insert({task_id:t,user_id:s.id,title:u,sort_order:g}).select().single();if(b)throw b;return y},onSuccess:()=>{r.invalidateQueries({queryKey:["subtasks",t]}),r.invalidateQueries({queryKey:["daily-tasks"]})},onError:()=>{W.error("Failed to add subtask")}}),l=le({mutationFn:async({subtaskId:u,completed:g})=>{const{error:y}=await S.from("subtasks").update({completed:g,completed_at:g?new Date().toISOString():null}).eq("id",u);if(y)throw y},onSuccess:()=>{r.invalidateQueries({queryKey:["subtasks",t]}),r.invalidateQueries({queryKey:["daily-tasks"]})}}),c=le({mutationFn:async u=>{const{error:g}=await S.from("subtasks").delete().eq("id",u);if(g)throw g},onSuccess:()=>{r.invalidateQueries({queryKey:["subtasks",t]}),r.invalidateQueries({queryKey:["daily-tasks"]})}}),d=le({mutationFn:async({subtaskId:u,title:g})=>{const{error:y}=await S.from("subtasks").update({title:g}).eq("id",u);if(y)throw y},onSuccess:()=>{r.invalidateQueries({queryKey:["subtasks",t]}),r.invalidateQueries({queryKey:["daily-tasks"]})},onError:()=>{W.error("Failed to update subtask")}}),m=le({mutationFn:async u=>{if(!s?.id||!t)throw new Error("Missing required data");const g=a.length>0?Math.max(...a.map(v=>v.sort_order))+1:0,y=u.map((v,x)=>({task_id:t,user_id:s.id,title:v,sort_order:g+x})),{error:b}=await S.from("subtasks").insert(y);if(b)throw b},onSuccess:()=>{r.invalidateQueries({queryKey:["subtasks",t]}),r.invalidateQueries({queryKey:["daily-tasks"]}),W.success("Subtasks added!")},onError:()=>{W.error("Failed to add subtasks")}}),p=a.filter(u=>u.completed).length,h=a.length,f=h>0?Math.round(p/h*100):0;return{subtasks:a,isLoading:i,addSubtask:o.mutate,toggleSubtask:l.mutate,deleteSubtask:c.mutate,updateSubtask:d.mutate,bulkAddSubtasks:m.mutateAsync,isAdding:o.isPending,isBulkAdding:m.isPending,completedCount:p,totalCount:h,progressPercent:f}},Dw=/^\d{4}-\d{2}-\d{2}$/,Pw=t=>{const s=t?.trim().toLowerCase();return s==="easy"||s==="medium"||s==="hard"?s:s&&["simple","beginner","low"].includes(s)?"easy":s&&["difficult","advanced","challenging","high"].includes(s)?"hard":"medium"},$i=t=>{if(!t)return null;const s=t.trim();if(!s)return null;const r=s.includes("T")?s.slice(0,10):s;if(!Dw.test(r))return null;const a=new Date(`${r}T00:00:00`);return pn(a)?r:null},Aw=t=>{const s=$i(t);if(!s)return null;const r=new Date(`${s}T00:00:00`);return pn(r)?r:null};function zm({task:t,open:s,onOpenChange:r,onSave:a,isSaving:i,onDelete:o,isDeleting:l,onSendToCalendar:c,hasCalendarLink:d=!1,isSendingToCalendar:m=!1}){const[p,h]=n.useState(""),[f,u]=n.useState(null),[g,y]=n.useState("medium"),[b,v]=n.useState(null),[x,w]=n.useState(30),[j,D]=n.useState(null),[C,_]=n.useState([]),[N,E]=n.useState(!1),[k,P]=n.useState(15),[T,I]=n.useState(null),[R,L]=n.useState(!1),[$,q]=n.useState(!1),[F,H]=n.useState([]),[J,G]=n.useState(null),[re,ie]=n.useState(!1),[K,xe]=n.useState(!1),[Te,Ne]=n.useState(""),[B,z]=n.useState(""),Q=n.useRef(null),Y=n.useRef(null),{subtasks:ue,addSubtask:fe,toggleSubtask:De,deleteSubtask:Ce}=Mw(t?.id??null);n.useEffect(()=>{if(t&&s){h(t.task_text),u($i(t.task_date)),y(Pw(t.difficulty)),v(Fi(t.scheduled_time)),w(t.estimated_duration??30),D(t.recurrence_pattern||null),_(Array.isArray(t.recurrence_days)?t.recurrence_days:[]),E(!!t.reminder_enabled),P(typeof t.reminder_minutes_before=="number"&&t.reminder_minutes_before>0?t.reminder_minutes_before:15),I(t.notes||null);const ae=(t.attachments??[]).map((Se,ve)=>({fileUrl:Se.fileUrl,filePath:Se.filePath,fileName:Se.fileName,mimeType:Se.mimeType,fileSizeBytes:Se.fileSizeBytes,isImage:Se.isImage,sortOrder:Se.sortOrder??ve}));ae.length>0?H(ae):t.image_url?H([{fileUrl:t.image_url,filePath:"",fileName:"image",mimeType:"image/jpeg",fileSizeBytes:0,isImage:!0,sortOrder:0}]):H([]),G(t.location||null),ie(!1),xe(!1),L(!!t.recurrence_pattern||!!t.reminder_enabled||!!t.location)}},[t,s]),n.useEffect(()=>{K&&Y.current&&setTimeout(()=>{Y.current?.scrollIntoView({block:"center",behavior:"smooth"})},150)},[K,b]);const Be=n.useMemo(()=>{if(!b||!x)return null;const ae=Ca(b);return ae?te(qd(ae,x),"HH:mm"):null},[b,x]),qe=x!==null&&!xn.some(ae=>ae.value===x),he=n.useMemo(()=>x?x===1440?"All Day":x>=60?`${x/60}h`:`${x} min`:"No duration",[x]),ye=n.useMemo(()=>Aw(f),[f]),Ue=n.useMemo(()=>{const ae=he;if(ye){const Se=ye;return so(Se)?`${ae} Â· Today`:`${ae} Â· ${te(Se,"EEE, MMM d")}`}return`${ae} Â· Inbox`},[he,ye]),Re=Hm[g],Ie=ye??new Date,ee=n.useCallback(async()=>{!t||!p.trim()||(await a(t.id,{task_text:p.trim(),task_date:$i(f),difficulty:g,scheduled_time:Fi(b),estimated_duration:x,recurrence_pattern:j,recurrence_days:Array.isArray(C)?C:[],reminder_enabled:N,reminder_minutes_before:Number.isFinite(k)&&k>0?k:15,notes:T,category:t.category||null,image_url:F.find(ae=>ae.isImage)?.fileUrl??null,location:J,attachments:F}),r(!1))},[t,p,f,g,b,x,j,C,N,k,T,F,J,a,r]),ne=async()=>{!t||!o||(await o(t.id),q(!1),r(!1))},X=n.useCallback(()=>{B.trim()&&(fe(B.trim()),z(""))},[B,fe]);return e.jsxs(vo,{open:s,onOpenChange:r,children:[e.jsxs(Bn,{side:"bottom",className:"h-[92vh] rounded-t-2xl flex flex-col p-0 gap-0 overflow-hidden",children:[e.jsx(Un,{className:"sr-only",children:"Edit Quest"}),e.jsx(wo,{className:"sr-only",children:"Update this quest details, schedule, and reminders."}),e.jsxs("div",{className:A("relative px-5 pt-3 pb-3 flex-shrink-0",Re.bg),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>r(!1),className:"p-1.5 rounded-full bg-black/20 hover:bg-black/30 transition-colors text-white","aria-label":"Close",children:e.jsx(yf,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(ot,{value:p,onChange:ae=>h(ae.target.value),className:"text-base font-bold bg-white/10 border-white/20 text-white placeholder:text-white/50 focus-visible:ring-white/30 h-9",placeholder:"Quest title"}),e.jsx("p",{className:"text-white/70 text-xs mt-1",children:Ue})]}),e.jsx("button",{onClick:()=>r(!1),className:"p-1.5 rounded-full bg-black/20 hover:bg-black/30 transition-colors text-white","aria-label":"Close",children:e.jsx(Nt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex justify-center gap-3 mt-2",children:[{value:"easy",icon:ft,label:"Easy"},{value:"medium",icon:Gt,label:"Medium"},{value:"hard",icon:Ta,label:"Hard"}].map(({value:ae,icon:Se,label:ve})=>e.jsxs("button",{onClick:()=>y(ae),className:A("w-14 h-12 rounded-xl flex flex-col items-center justify-center gap-0.5 transition-all border-2",g===ae?"bg-white/30 border-white scale-110":"bg-white/10 border-transparent hover:bg-white/20"),children:[e.jsx(Se,{className:"h-4 w-4 text-white"}),e.jsx("span",{className:"text-[10px] font-medium text-white/80 leading-none",children:ve})]},ae))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4 space-y-3",children:[e.jsxs("button",{onClick:()=>ie(!re),className:"w-full flex items-center justify-between bg-card rounded-xl px-4 py-3 border border-border/50 hover:bg-muted/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2.5 text-sm font-medium",children:[e.jsx(Ft,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:he})]}),e.jsx(Et,{className:A("h-4 w-4 text-muted-foreground transition-transform",re&&"rotate-90")})]}),re&&e.jsxs("div",{className:"space-y-2 px-1",children:[e.jsx("div",{className:"flex gap-2 flex-wrap",children:xn.map(ae=>{const Se=ae.value===-1?qe:x===ae.value;return e.jsx("button",{onClick:()=>{ae.value===-1?(Ne(""),w(null)):(Ne(""),w(ae.value))},className:A("px-4 py-2 rounded-lg text-sm font-bold transition-all duration-150",Se?A(Re.pill,"text-white shadow-md"):"bg-muted/50 text-muted-foreground hover:bg-muted"),children:ae.label},ae.value)})}),(qe||x===null&&Te!==void 0)&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ot,{type:"number",inputMode:"numeric",placeholder:"Minutes",value:Te,onChange:ae=>{const Se=ae.target.value;Ne(Se);const ve=parseInt(Se,10);!isNaN(ve)&&ve>0?w(ve):w(null)},className:"w-28 h-9 text-sm",autoFocus:!0}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"min"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Ds,{children:[e.jsx(Ps,{asChild:!0,children:e.jsxs("button",{className:A("flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border text-sm font-medium transition-colors",f?"bg-card border-border/50 text-foreground":"bg-muted/30 border-dashed border-border/50 text-muted-foreground"),children:[e.jsx($t,{className:"h-4 w-4"}),f?te(Ie,"MMM d"):"Date"]})}),e.jsx(ys,{className:"w-auto p-0 z-[100]",align:"start",children:e.jsx(Vr,{mode:"single",selected:Ie,onSelect:ae=>u(ae?te(ae,"yyyy-MM-dd"):null),className:"pointer-events-auto"})})]}),e.jsxs("button",{onClick:()=>{b||v(Bm()),xe(!K)},className:A("flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border text-sm font-medium transition-colors",b?"bg-card border-border/50 text-foreground":"bg-muted/30 border-dashed border-border/50 text-muted-foreground"),children:[e.jsx(Ft,{className:"h-4 w-4"}),b?qs(b):"Time"]})]}),K&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ot,{"aria-label":"Custom quest time",type:"time",step:60,value:b||"",onChange:ae=>v(ae.target.value||null),className:"h-10"}),e.jsxs("div",{ref:Q,className:"relative h-[180px] overflow-y-auto rounded-xl bg-card border border-border/50 snap-y snap-mandatory scrollbar-none",style:{scrollbarWidth:"none"},children:[e.jsx("div",{className:"sticky top-0 h-12 bg-gradient-to-b from-card to-transparent z-10 pointer-events-none"}),e.jsx("div",{className:"flex flex-col items-center py-1",children:Mr.map(ae=>{const Se=b===ae,ve=b?Mr.indexOf(b):-1,_e=Mr.indexOf(ae),Me=ve>=0?Math.abs(_e-ve):0,et=Se?1:Math.max(.25,1-Me*.15);return e.jsx("button",{ref:Se?Y:void 0,onClick:()=>v(ae),className:A("w-[85%] py-2.5 rounded-xl text-center text-sm font-semibold snap-center transition-all duration-150 my-0.5",Se?A(Re.pill,"text-white shadow-lg scale-[1.02]"):"text-foreground hover:bg-muted/50"),style:{opacity:Se?1:et},children:Se&&Be?`${qs(ae)} â€“ ${qs(Be)}`:qs(ae)},ae)})}),e.jsx("div",{className:"sticky bottom-0 h-12 bg-gradient-to-t from-card to-transparent z-10 pointer-events-none"})]})]}),e.jsxs("div",{className:"bg-card rounded-xl border border-border/50 overflow-hidden",children:[ue.map(ae=>e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b border-border/30 group",children:[e.jsx(lr,{checked:ae.completed,onCheckedChange:Se=>De({subtaskId:ae.id,completed:!!Se}),className:"h-4 w-4"}),e.jsx("span",{className:A("flex-1 text-sm",ae.completed&&"line-through text-muted-foreground"),children:ae.title}),e.jsx("button",{onClick:()=>Ce(ae.id),className:"p-1 rounded opacity-0 group-hover:opacity-100 hover:bg-destructive/10 text-muted-foreground hover:text-destructive transition-all",children:e.jsx($s,{className:"h-3.5 w-3.5"})})]},ae.id)),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b border-border/30",children:[e.jsx(lr,{disabled:!0,className:"h-4 w-4 opacity-30"}),e.jsx("input",{value:B,onChange:ae=>z(ae.target.value),onKeyDown:ae=>{ae.key==="Enter"&&B.trim()&&(ae.preventDefault(),X())},placeholder:"Add Subtask",className:"flex-1 bg-transparent text-sm outline-none placeholder:text-muted-foreground/60"})]}),e.jsx(Kt,{value:T||"",onChange:ae=>I(ae.target.value||null),placeholder:"Add notes, meeting links or phone numbers...",className:"min-h-[70px] border-0 rounded-none bg-transparent resize-none focus-visible:ring-0 focus-visible:ring-offset-0 text-sm",style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent"},"data-vaul-no-drag":!0})]}),e.jsxs("div",{className:"space-y-2 px-1",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Photo / Files"}),e.jsx(Lm,{attachments:F,onAttachmentsChange:H})]}),e.jsxs(bo,{open:R,onOpenChange:L,children:[e.jsx(qm,{asChild:!0,children:e.jsxs(U,{variant:"ghost",size:"sm",className:"w-full justify-between text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(yd,{className:"w-4 h-4"}),"Advanced Settings"]}),e.jsx("span",{className:"text-xs",children:R?"â–²":"â–¼"})]})}),e.jsx(Hn,{children:e.jsx("div",{className:"mt-3",children:e.jsx(yo,{scheduledTime:b,estimatedDuration:x,recurrencePattern:j,recurrenceDays:C,reminderEnabled:N,reminderMinutesBefore:k,onScheduledTimeChange:v,onEstimatedDurationChange:w,onRecurrencePatternChange:D,onRecurrenceDaysChange:_,onReminderEnabledChange:E,onReminderMinutesBeforeChange:P,moreInformation:T,onMoreInformationChange:I,location:J,onLocationChange:G,hideScheduledTime:!0,hideDuration:!0,hideMoreInformation:!0})})})]})]})}),e.jsxs("div",{className:"px-5 pt-4 pb-6 flex-shrink-0 flex flex-col gap-3 border-t border-border/50",children:[e.jsx(U,{onClick:ee,disabled:i||!p.trim(),className:A("w-full text-white",p.trim()?A(Re.pill,"hover:opacity-90"):""),children:i?"Saving...":"Save Changes"}),c&&e.jsxs(U,{variant:"outline",onClick:()=>c(t?.id||""),disabled:m||!t?.id,className:"w-full",children:[e.jsx(vd,{className:"w-4 h-4 mr-2"}),m?"Syncing...":d?"Re-send to Calendar":"Send to Calendar"]}),o&&e.jsxs(U,{variant:"ghost",onClick:()=>q(!0),disabled:l,className:"w-full text-destructive hover:text-destructive hover:bg-destructive/10",children:[e.jsx($s,{className:"w-4 h-4 mr-2"}),"Delete"]})]})]}),e.jsx(Aa,{open:$,onOpenChange:q,children:e.jsxs(Ur,{children:[e.jsxs(zr,{children:[e.jsx(Kr,{children:"Delete this quest?"}),e.jsxs(Wr,{children:['This action cannot be undone. This will permanently delete "',t?.task_text,'".']})]}),e.jsxs(Qr,{children:[e.jsx(Gr,{children:"Cancel"}),e.jsx(or,{onClick:ne,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:l?"Deleting...":"Delete"})]})]})})]})}function Rw(){const t=n.useCallback(async a=>{const{data:{user:i}}=await S.auth.getUser();if(!i){console.log("[SchedulingLearner] No user - skipping completion tracking");return}console.log("[SchedulingLearner] Tracking completion for user:",i.id),console.log("[SchedulingLearner] Data:",{taskText:a.taskText?.substring(0,30),category:a.category,difficulty:a.difficulty});try{const{data:o,error:l}=await S.functions.invoke("analyze-user-patterns",{body:{type:"task_completion",data:a}});l?console.error("[SchedulingLearner] Edge function error:",l):console.log("[SchedulingLearner] Completion saved:",o)}catch(o){console.error("[SchedulingLearner] Error tracking completion:",o)}},[]),s=n.useCallback(async(a,i,o)=>{const{data:{user:l}}=await S.auth.getUser();if(l)try{const c={suggestedTime:a,actualTime:i,taskDifficulty:o};await S.functions.invoke("analyze-user-patterns",{body:{type:"schedule_modification",data:c}})}catch(c){console.error("[useSchedulingLearner] Error tracking modification:",c)}},[]),r=n.useCallback(async(a,i,o,l)=>{const{data:{user:c}}=await S.auth.getUser();if(!c){console.log("[SchedulingLearner] No user - skipping creation tracking");return}console.log("[SchedulingLearner] Tracking creation:",{taskText:l?.substring(0,30),category:o,difficulty:i});try{const d={scheduledTime:a,difficulty:i,createdAt:new Date().toISOString(),hour:new Date().getHours(),taskText:l,category:o},{data:m,error:p}=await S.functions.invoke("analyze-user-patterns",{body:{type:"task_creation",data:d}});p?console.error("[SchedulingLearner] Edge function error:",p):console.log("[SchedulingLearner] Creation saved:",m)}catch(d){console.error("[SchedulingLearner] Error tracking creation:",d)}},[]);return{trackTaskCompletion:t,trackScheduleModification:s,trackTaskCreation:r}}const Iw=async(t,s)=>{if(!t)return{bonusXP:0,toastReason:"Task Complete!"};try{const{data:r,error:a}=await S.from("epic_habits").select("epic_id, epics!inner(is_public, status)").eq("epics.status","active").eq("epics.is_public",!0);if(a)return console.error("Failed to fetch epic habits:",a),{bonusXP:0,toastReason:"Task Complete!"};if(!r||r.length===0)return{bonusXP:0,toastReason:"Task Complete!"};const{data:i,error:o}=await S.from("epic_members").select("epic_id").eq("user_id",t).in("epic_id",r.map(l=>l.epic_id));if(o)return console.error("Failed to fetch memberships:",o),{bonusXP:0,toastReason:"Task Complete!"};if(i&&i.length>0){const l=Math.round(s*.1),c=s>0?Math.max(1,l):0;return{bonusXP:c,toastReason:`Task Complete! +${c} Guild Bonus (10%) ðŸŽ¯`}}}catch(r){console.error("Unexpected error computing guild bonus:",r)}return{bonusXP:0,toastReason:"Task Complete!"}},Qm=["mind","body","soul"],Lw={body:["gym","run","exercise","workout","walk","yoga","stretch","fitness","sports"],soul:["meditate","journal","breathe","gratitude","reflect","pray","mindful","relax","rest"],mind:["read","learn","study","plan","organize","think","write","research","course"]};function xi(t,s){if(s&&Qm.includes(s))return s;const r=t.toLowerCase();for(const[a,i]of Object.entries(Lw))if(i.some(o=>r.includes(o)))return a;return null}const yi=t=>!t||t.length===0?null:t.find(s=>s.isImage)?.fileUrl??null;function Ll(t){if(!t)return!1;const s=(t.code??"").toUpperCase(),r=`${t.message??""} ${t.details??""} ${t.hint??""}`.toLowerCase(),a=r.includes("task_attachments");return s==="42P01"&&a?!0:a&&(s.startsWith("PGRST")||r.includes("schema cache")||r.includes("does not exist")||r.includes("could not find the table")||r.includes("relation"))}const bi=()=>({attachmentsSkippedDueToSchema:!1}),Km=t=>{const{user:s}=be(),{toast:r}=Ms(),a=Ae(),{companion:i}=Tt(),{updateDisciplineFromRitual:o}=Tu(),{showXPToast:l}=Jd(),{awardCustomXP:c}=Xt(),{trackTaskCompletion:d,trackTaskCreation:m}=Rw(),p=n.useRef(!1),h=()=>{r({title:"Attachments unavailable",description:"Quest saved, but attachments could not be stored. Please try again after the backend migration finishes."})},f=async _=>{if(!s?.id)throw new Error("User not authenticated");const{data:N,error:E}=await S.from("daily_tasks").select("task_date, scheduled_time, habit_source_id, source").eq("id",_).eq("user_id",s.id).maybeSingle();if(E)throw E;if(!N)throw new Error("Task not found");return N},u=async(_,N)=>{if(!s?.id)throw new Error("User not authenticated");const{error:E}=await S.from("task_attachments").delete().eq("task_id",_).eq("user_id",s.id);if(E){if(Ll(E))return{attachmentsSkippedDueToSchema:!0};throw E}if(N.length===0)return bi();const k=N.map((T,I)=>({task_id:_,user_id:s.id,file_url:T.fileUrl,file_path:T.filePath,file_name:T.fileName,mime_type:T.mimeType,file_size_bytes:T.fileSizeBytes,is_image:T.isImage,sort_order:T.sortOrder??I})),{error:P}=await S.from("task_attachments").insert(k);if(P){if(Ll(P))return{attachmentsSkippedDueToSchema:!0};throw P}return bi()},g=le({mutationFn:async _=>{if(p.current)throw new Error("Please wait...");p.current=!0;try{if(!s?.id)throw new Error("User not authenticated");const N=Tr({task_date:_.taskDate!==void 0?_.taskDate:t,scheduled_time:_.scheduledTime||null,habit_source_id:null,source:_.taskDate===null?"inbox":"manual"}),E=N.task_date;let k=S.from("daily_tasks").select("id").eq("user_id",s.id);E===null?k=k.is("task_date",null):k=k.eq("task_date",E);const{data:P,error:T}=await k;if(T)throw T;const I=(P?.length||0)+1,R=rl(_.difficulty,I),L=xi(_.taskText,_.category),$=(_.attachments??[]).slice(0,10),q=yi($)??_.imageUrl??null,{data:F,error:H}=await S.from("daily_tasks").insert({user_id:s.id,task_text:_.taskText,difficulty:_.difficulty,xp_reward:R,task_date:N.task_date,is_main_quest:_.isMainQuest??!1,scheduled_time:N.scheduled_time,estimated_duration:_.estimatedDuration||null,recurrence_pattern:_.recurrencePattern||null,recurrence_days:_.recurrenceDays||null,recurrence_end_date:_.recurrenceEndDate||null,is_recurring:!!_.recurrencePattern,reminder_enabled:_.reminderEnabled??!1,reminder_minutes_before:_.reminderMinutesBefore??15,category:L,is_bonus:!1,notes:_.notes||null,contact_id:_.contactId||null,auto_log_interaction:_.autoLogInteraction??!0,image_url:q,location:_.location||null,source:N.source??(N.task_date===null?"inbox":"manual")}).select().single();if(H)throw H.message?.includes("MAX_TASKS_REACHED")||H.message?.includes("Maximum quest limit")?new Error("Maximum quest limit reached for today"):H;let J=bi();if(F?.id)try{J=await u(F.id,$)}catch(re){throw await S.from("daily_tasks").delete().eq("id",F.id).eq("user_id",s.id),re}const G=(_.subtasks||[]).map(re=>re.trim()).filter(re=>re.length>0);if(G.length>0&&F?.id){const{error:re}=await S.from("subtasks").insert(G.map((ie,K)=>({task_id:F.id,user_id:s.id,title:ie,sort_order:K})));if(re)throw await S.from("daily_tasks").delete().eq("id",F.id).eq("user_id",s.id),re}return{...F??{},attachmentsSkippedDueToSchema:J.attachmentsSkippedDueToSchema}}finally{p.current=!1}},onMutate:async _=>{await a.cancelQueries({queryKey:["daily-tasks"]}),await a.cancelQueries({queryKey:["calendar-tasks"]});const N=a.getQueriesData({queryKey:["daily-tasks"]}),E=a.getQueriesData({queryKey:["calendar-tasks"]}),k=Tr({task_date:_.taskDate!==void 0?_.taskDate:t,scheduled_time:_.scheduledTime||null,habit_source_id:null,source:_.taskDate===null?"inbox":"manual"}),P=yi(_.attachments)??_.imageUrl??null,T={id:`temp-${Date.now()}`,user_id:s?.id,task_text:_.taskText,difficulty:_.difficulty,task_date:k.task_date,completed:!1,completed_at:null,is_main_quest:_.isMainQuest??!1,scheduled_time:k.scheduled_time,estimated_duration:_.estimatedDuration||null,xp_reward:rl(_.difficulty,1),created_at:new Date().toISOString(),category:xi(_.taskText,_.category),is_bonus:!1,is_recurring:!!_.recurrencePattern,recurrence_pattern:_.recurrencePattern||null,recurrence_days:_.recurrenceDays||null,reminder_enabled:_.reminderEnabled??!1,reminder_minutes_before:_.reminderMinutesBefore??15,reminder_sent:!1,parent_template_id:null,notes:_.notes||null,image_url:P,location:_.location||null,source:k.source??(k.task_date===null?"inbox":"manual")};return T.task_date&&a.setQueryData(["daily-tasks",s?.id,T.task_date],I=>!I||!Array.isArray(I)?I:[T,...I]),{previousDailyTasks:N,previousCalendarTasks:E}},onError:(_,N,E)=>{E?.previousDailyTasks&&E.previousDailyTasks.forEach(([k,P])=>{a.setQueryData(k,P)}),E?.previousCalendarTasks&&E.previousCalendarTasks.forEach(([k,P])=>{a.setQueryData(k,P)}),r({title:"Failed to add quest",description:_.message,variant:"destructive"})},onSettled:()=>{a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]}),a.invalidateQueries({queryKey:["inbox-tasks"]}),a.invalidateQueries({queryKey:["inbox-count"]})},onSuccess:_=>{r({title:"Quest added!"}),_?.attachmentsSkippedDueToSchema&&h(),window.dispatchEvent(new CustomEvent("task-added",{detail:{taskDate:_?.task_date??null,scheduledTime:_?.scheduled_time??null}})),_&&m(_.scheduled_time,_.difficulty||"medium",_.category,_.task_text)}}),y=le({mutationFn:async({taskId:_,completed:N,xpReward:E,forceUndo:k=!1})=>{if(!s?.id)throw new Error("User not authenticated");const{data:P,error:T}=await S.from("daily_tasks").select(`
          completed_at, task_text, habit_source_id, task_date, difficulty, scheduled_time, category,
          is_main_quest, xp_reward,
          contact_id, auto_log_interaction,
          contact:contacts!contact_id(id, name, avatar_url)
        `).eq("id",_).eq("user_id",s.id).maybeSingle();if(T)throw T;const I=P?.completed_at!==null,R=P?.task_text||"Task",L=P?.habit_source_id,$=P?.task_date||te(new Date,"yyyy-MM-dd"),q=P?.is_main_quest===!0,F=Number(P?.xp_reward??E),H=Math.round(F*qi),J=q&&E<=F?H:E;if(I&&!N&&!k)throw new Error("Cannot uncheck completed tasks");if(!N&&k){const{error:De}=await S.from("daily_tasks").update({completed:!1,completed_at:null}).eq("id",_).eq("user_id",s.id);if(De)throw De;return J>0&&await c(-J,"task_undo","Quest undone",{task_id:_}),L&&await S.from("habit_completions").delete().eq("user_id",s.id).eq("habit_id",L).eq("date",$),{taskId:_,completed:!1,xpAwarded:0,wasAlreadyCompleted:!0,isUndo:!0,taskText:R,habitSourceId:L}}if(!N){const{error:De}=await S.from("daily_tasks").update({completed:!1,completed_at:null}).eq("id",_).eq("user_id",s.id);if(De)throw De;return L&&await S.from("habit_completions").delete().eq("user_id",s.id).eq("habit_id",L).eq("date",$),{taskId:_,completed:!1,xpAwarded:0,wasAlreadyCompleted:I,isUndo:!1,taskText:R,habitSourceId:L}}const{bonusXP:G,toastReason:re}=await Iw(s.id,J),ie=J+G,{data:K,error:xe}=await S.from("daily_tasks").update({completed:!0,completed_at:new Date().toISOString()}).eq("id",_).eq("user_id",s.id).eq("completed",!1).select();if(xe)throw xe;if(!K||K.length===0)throw new Error("Task was already completed");const Ne=(await c(ie,"task_complete",re,{task_id:_}))?.xpAwarded??0;if(L){const{error:De}=await S.from("habit_completions").upsert({user_id:s.id,habit_id:L,date:$},{onConflict:"user_id,habit_id,date"});De?console.error("[Task Toggle] Failed to sync habit completion:",De):console.log("[Task Toggle] Synced habit completion for habit:",L)}const B=P?.difficulty||"medium",z=P?.scheduled_time||null,Q=P?.category||null,Y=P?.contact_id||null,ue=P?.auto_log_interaction??!0,fe=P?.contact;return{taskId:_,completed:!0,xpAwarded:Ne,bonusXP:G,toastReason:re,wasAlreadyCompleted:I,isUndo:!1,taskText:R,habitSourceId:L,taskDifficulty:B,taskScheduledTime:z,taskCategory:Q,contactId:Y,autoLogInteraction:ue,contact:fe}},onSuccess:async({completed:_,xpAwarded:N,toastReason:E,wasAlreadyCompleted:k,isUndo:P,taskId:T,taskText:I,habitSourceId:R,taskDifficulty:L,taskScheduledTime:$,taskCategory:q})=>{if(a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]}),R&&(a.invalidateQueries({queryKey:["habit-completions"]}),a.invalidateQueries({queryKey:["habits"]}),a.invalidateQueries({queryKey:["habit-surfacing"]}),a.invalidateQueries({queryKey:["epics"]})),P){r({title:"Quest undone",description:"XP has been adjusted"});return}if(_&&!k){N>0&&l(N,E||"Quest Complete!"),i?.id&&o(i.id).catch(console.error),window.dispatchEvent(new CustomEvent("mission-completed")),window.dispatchEvent(new CustomEvent("quest-completed"));const F=new Date;console.log("[TaskMutations] About to track completion:",{taskId:T,taskText:I?.substring(0,50),taskDifficulty:L,taskCategory:q});try{await d({taskId:T,completedAt:F.toISOString(),difficulty:L||"medium",scheduledTime:$,actualCompletionHour:F.getHours(),dayOfWeek:F.getDay(),wasOnTime:$?Math.abs(parseInt($.split(":")[0])-F.getHours())<=1:null,category:q||void 0,taskText:I}),console.log("[TaskMutations] trackTaskCompletion succeeded")}catch(H){console.error("[TaskMutations] trackTaskCompletion failed:",H)}r({title:"Quest completed! âœ¨",description:I.length>40?I.substring(0,40)+"...":I,duration:5e3,action:n.createElement(Bd,{altText:"Undo completion",onClick:()=>{y.mutate({taskId:T,completed:!1,xpReward:N,forceUndo:!0})}},"Undo")})}},onError:_=>{const N=_.message==="Please wait..."?"Please wait for the previous action to complete":_.message.includes("Failed to fetch")||_.message.includes("Load failed")?"Network error. Please check your connection and try again.":_.message;r({title:"Failed to toggle quest",description:N,variant:"destructive"})},retry:2,retryDelay:1e3}),b=le({mutationFn:async _=>{if(!s?.id)throw new Error("User not authenticated");if(!_)throw new Error("Invalid task ID");const{error:N}=await S.from("daily_tasks").delete().eq("id",_).eq("user_id",s.id);if(N)throw N},onSuccess:()=>{a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]})},onError:_=>{r({title:"Failed to delete quest",description:_.message,variant:"destructive"})}}),v=le({mutationFn:async _=>{if(!s?.id)throw new Error("User not authenticated");const N=Tr({task_date:_.task_date??null,scheduled_time:_.scheduled_time??null,habit_source_id:_.habit_source_id??null,source:_.source??null}),{data:E,error:k}=await S.from("daily_tasks").insert({user_id:s.id,task_text:_.task_text,task_date:N.task_date,xp_reward:_.xp_reward??10,difficulty:_.difficulty??"medium",scheduled_time:N.scheduled_time,estimated_duration:_.estimated_duration,is_main_quest:_.is_main_quest??!1,epic_id:_.epic_id,sort_order:_.sort_order,notes:_.notes,priority:_.priority,energy_level:_.energy_level,category:_.category,habit_source_id:_.habit_source_id,is_recurring:_.is_recurring??!1,recurrence_pattern:_.recurrence_pattern,recurrence_days:_.recurrence_days,reminder_enabled:_.reminder_enabled??!1,reminder_minutes_before:_.reminder_minutes_before,source:N.source??(N.task_date===null?"inbox":"manual")}).select().single();if(k)throw k;return E},onSuccess:()=>{a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]})},onError:_=>{r({title:"Failed to restore quest",description:_.message,variant:"destructive"})}}),x=le({mutationFn:async _=>{if(!s?.id)throw new Error("User not authenticated");const{data:N,error:E}=await S.from("daily_tasks").select("id, user_id, task_date").eq("id",_).eq("user_id",s.id).eq("task_date",t).maybeSingle();if(E)throw E;if(!N)throw new Error("Task not found or access denied");await S.from("daily_tasks").update({is_main_quest:!1}).eq("user_id",s.id).eq("task_date",t);const{error:k}=await S.from("daily_tasks").update({is_main_quest:!0}).eq("id",_).eq("user_id",s.id);if(k)throw k},onSuccess:()=>{a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]}),r({title:"Main quest updated!"})},onError:_=>{r({title:"Failed to update main quest",description:_.message,variant:"destructive"})}}),w=le({mutationFn:async({taskId:_,updates:N})=>{if(!s?.id)throw new Error("User not authenticated");let E=!1,k=!1,P=!1;const T={};if(N.task_text!==void 0&&(T.task_text=N.task_text),N.task_date!==void 0&&(T.task_date=N.task_date),N.difficulty!==void 0&&(T.difficulty=N.difficulty),N.scheduled_time!==void 0&&(T.scheduled_time=N.scheduled_time),N.estimated_duration!==void 0&&(T.estimated_duration=N.estimated_duration),N.recurrence_pattern!==void 0&&(T.recurrence_pattern=N.recurrence_pattern),N.recurrence_days!==void 0&&(T.recurrence_days=N.recurrence_days),N.reminder_enabled!==void 0&&(T.reminder_enabled=N.reminder_enabled),N.reminder_minutes_before!==void 0&&(T.reminder_minutes_before=N.reminder_minutes_before),N.notes!==void 0&&(T.notes=N.notes),N.category!==void 0||N.task_text!==void 0){const L=N.category&&Qm.includes(N.category)?N.category:N.task_text?xi(N.task_text,N.category||void 0):N.category;T.category=L}N.image_url!==void 0&&(T.image_url=N.image_url);const I=N.attachments!==void 0;if(I&&(T.image_url=yi(N.attachments)??null),N.location!==void 0&&(T.location=N.location),N.task_date!==void 0||N.scheduled_time!==void 0){const L=await f(_),$=dn(L,{task_date:N.task_date,scheduled_time:N.scheduled_time});T.task_date=$.task_date,T.scheduled_time=$.scheduled_time,$.source!==L.source&&(T.source=$.source),E=$.normalizedToInbox,k=$.strippedScheduledTime}if(Object.keys(T).length===0)return{normalizedToInbox:E,strippedScheduledTime:k,attachmentsSkippedDueToSchema:P};const{error:R}=await S.from("daily_tasks").update(T).eq("id",_).eq("user_id",s.id);if(R)throw R;return I&&(P=(await u(_,N.attachments??[])).attachmentsSkippedDueToSchema),{normalizedToInbox:E,strippedScheduledTime:k,attachmentsSkippedDueToSchema:P}},onSuccess:(_,N)=>{a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]}),_?.attachmentsSkippedDueToSchema&&h();const E=Object.entries(N.updates).filter(([,P])=>P!==void 0).map(([P])=>P),k=E.length===1&&E[0]==="scheduled_time";if(_?.normalizedToInbox){r({title:"Moved to Inbox",description:"Regular quests without a time are kept in Inbox."});return}if(_?.strippedScheduledTime&&!k){r({title:"Time removed",description:"Inbox quests do not keep a scheduled time."});return}k||r({title:"Quest updated!"})},onError:_=>{r({title:"Failed to update quest",description:_.message,variant:"destructive"})}}),j=le({mutationFn:async _=>{if(!s?.id)throw new Error("User not authenticated");for(const N of _){const{error:E}=await S.from("daily_tasks").update({sort_order:N.sort_order}).eq("id",N.id).eq("user_id",s.id);if(E)throw E}},onMutate:async _=>{await a.cancelQueries({queryKey:["daily-tasks"]}),await a.cancelQueries({queryKey:["calendar-tasks"]});const N=a.getQueriesData({queryKey:["daily-tasks"]}),E=a.getQueriesData({queryKey:["calendar-tasks"]}),k=new Map(_.map(P=>[P.id,P.sort_order]));return a.setQueriesData({queryKey:["daily-tasks"]},P=>!P||!Array.isArray(P)?P:[...P].map(T=>({...T,sort_order:k.has(T.id)?k.get(T.id):T.sort_order})).sort((T,I)=>(T.sort_order??999)-(I.sort_order??999))),a.setQueriesData({queryKey:["calendar-tasks"]},P=>!P||!Array.isArray(P)?P:[...P].map(T=>({...T,sort_order:k.has(T.id)?k.get(T.id):T.sort_order})).sort((T,I)=>(T.sort_order??999)-(I.sort_order??999))),{previousDailyTasks:N,previousCalendarTasks:E}},onError:(_,N,E)=>{E?.previousDailyTasks&&E.previousDailyTasks.forEach(([k,P])=>{a.setQueryData(k,P)}),E?.previousCalendarTasks&&E.previousCalendarTasks.forEach(([k,P])=>{a.setQueryData(k,P)}),r({title:"Failed to reorder quests",description:_.message,variant:"destructive"})},onSettled:()=>{a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]})}}),D=le({mutationFn:async({taskId:_,targetSection:N})=>{if(!s?.id)throw new Error("User not authenticated");const k={morning:"09:00",afternoon:"14:00",evening:"19:00",unscheduled:null}[N],P=await f(_),T=dn(P,{scheduled_time:k}),I={task_date:T.task_date,scheduled_time:T.scheduled_time,sort_order:0};T.source!==P.source&&(I.source=T.source);const{error:R}=await S.from("daily_tasks").update(I).eq("id",_).eq("user_id",s.id);if(R)throw R;return T},onSuccess:_=>{a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]}),_?.normalizedToInbox&&r({title:"Moved to Inbox",description:"Regular quests without a time are kept in Inbox."})},onError:_=>{r({title:"Failed to move quest",description:_.message,variant:"destructive"})}}),C=le({mutationFn:async({taskId:_,targetDate:N})=>{if(!s?.id)throw new Error("User not authenticated");const E=await f(_),k=dn(E,{task_date:N}),P={task_date:k.task_date,scheduled_time:k.scheduled_time,sort_order:0};k.source!==E.source&&(P.source=k.source);const{error:T}=await S.from("daily_tasks").update(P).eq("id",_).eq("user_id",s.id);if(T)throw T;return{taskId:_,targetDate:k.task_date,normalizedToInbox:k.normalizedToInbox}},onMutate:async()=>{await a.cancelQueries({queryKey:["daily-tasks"]}),await a.cancelQueries({queryKey:["calendar-tasks"]});const _=a.getQueriesData({queryKey:["daily-tasks"]}),N=a.getQueriesData({queryKey:["calendar-tasks"]});return{previousDaily:_,previousCalendar:N}},onError:(_,N,E)=>{E?.previousDaily&&E.previousDaily.forEach(([k,P])=>a.setQueryData(k,P)),E?.previousCalendar&&E.previousCalendar.forEach(([k,P])=>a.setQueryData(k,P)),r({title:"Failed to move quest",description:_.message,variant:"destructive"})},onSuccess:_=>{_?.normalizedToInbox&&r({title:"Moved to Inbox",description:"Regular quests without a time are kept in Inbox."})},onSettled:()=>{a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]})}});return{addTask:g.mutateAsync,toggleTask:y.mutate,deleteTask:b.mutateAsync,restoreTask:v.mutateAsync,setMainQuest:x.mutate,updateTask:w.mutateAsync,reorderTasks:j.mutate,moveTaskToSection:D.mutate,moveTaskToDate:C.mutate,isAdding:g.isPending,isToggling:y.isPending,isDeleting:b.isPending,isRestoring:v.isPending,isUpdating:w.isPending,isReordering:j.isPending,isMoving:D.isPending,isMovingDate:C.isPending}};function ql(t){if(!t.task_date)throw new Error("TASK_DATE_REQUIRED");if(!t.scheduled_time)throw new Error("SCHEDULED_TIME_REQUIRED");const s=Ca(t.scheduled_time,new Date(`${t.task_date}T00:00:00`));if(!s)throw new Error("SCHEDULED_TIME_INVALID");const r=t.estimated_duration&&t.estimated_duration>0?t.estimated_duration:30,a=new Date(s.getTime()+r*6e4);return{startDate:s.toISOString(),endDate:a.toISOString()}}function Wm(t={}){const{user:s}=be(),r=Ae(),{enabled:a=!0}=t,{connections:i,defaultProvider:o}=zn({enabled:a}),c=Ee({queryKey:["quest-calendar-links",s?.id],enabled:a&&!!s?.id,queryFn:async()=>{if(!s?.id)return[];const{data:x,error:w}=await S.from("quest_calendar_links").select("id, task_id, user_id, connection_id, provider, external_calendar_id, external_event_id, sync_mode, last_app_sync_at, last_provider_sync_at").eq("user_id",s.id);if(w)throw w;return x||[]}}).data||[],d=n.useMemo(()=>{const x=new Map;for(const w of c){const j=x.get(w.task_id)||[];j.push(w),x.set(w.task_id,j)}return x},[c]),m=x=>i.find(w=>w.provider===x)||null,p=x=>{if(x){if(!m(x))throw new Error("NO_CALENDAR_CONNECTION");return x}if(o&&m(o))return o;const w=i[0]?.provider;if(!w)throw new Error("NO_CALENDAR_CONNECTION");return w},h=async x=>{if(!s?.id)throw new Error("User not authenticated");const{data:w,error:j}=await S.from("daily_tasks").select("id, task_text, task_date, scheduled_time, estimated_duration, location, notes").eq("id",x).eq("user_id",s.id).single();if(j||!w)throw new Error("Task not found");return w},f=async(x,w)=>{if(!s?.id)throw new Error("User not authenticated");const j={};if(w.taskDate!==void 0&&(j.task_date=w.taskDate),w.scheduledTime!==void 0&&(j.scheduled_time=w.scheduledTime),w.estimatedDuration!==void 0&&(j.estimated_duration=w.estimatedDuration),Object.keys(j).length===0)return;const{error:D}=await S.from("daily_tasks").update(j).eq("id",x).eq("user_id",s.id);if(D)throw D},u=le({mutationFn:async({taskId:x,options:w})=>{if(!s?.id)throw new Error("User not authenticated");const j=p(w?.provider),D=m(j);if(!D)throw new Error("NO_CALENDAR_CONNECTION");w&&await f(x,w);const C=await h(x);if(!C.task_date)throw new Error("TASK_DATE_REQUIRED");if(!C.scheduled_time)throw new Error("SCHEDULED_TIME_REQUIRED");const _=(d.get(x)||[]).find(P=>P.provider===j);if(j==="apple"){if(!(await us.isAvailable()).available)throw new Error("Apple Calendar is only available on iOS native builds");if(!(await us.requestPermissions()).granted)throw new Error("Calendar permission not granted");const I=D.primary_calendar_id;if(!I)throw new Error("No primary Apple calendar selected");const R=ql(C),{eventId:L}=await us.createOrUpdateEvent({calendarId:I,eventId:_?.external_event_id,title:C.task_text,notes:C.notes,location:C.location,startDate:R.startDate,endDate:R.endDate,isAllDay:!1}),$=new Date().toISOString(),{error:q}=await S.from("quest_calendar_links").upsert({user_id:s.id,task_id:C.id,connection_id:D.id,provider:"apple",external_calendar_id:I,external_event_id:L,sync_mode:D.sync_mode,last_app_sync_at:$,last_provider_sync_at:$},{onConflict:"task_id,connection_id"});if(q)throw q;return}const N=`${j}-calendar-events`,E=_?"updateLinkedEvent":"createLinkedEvent",{error:k}=await S.functions.invoke(N,{body:{action:E,taskId:x,syncMode:D.sync_mode}});if(k)throw new Error(k.message||`Failed to send task to ${j}`)},onSuccess:async()=>{await Promise.all([r.invalidateQueries({queryKey:["quest-calendar-links"]}),r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]})])}}),g=le({mutationFn:async({taskId:x})=>{if(!s?.id)throw new Error("User not authenticated");const w=(d.get(x)||[]).filter(D=>D.sync_mode==="full_sync");if(w.length===0)return;const j=await h(x);if(!(!j.task_date||!j.scheduled_time))for(const D of w){if(D.provider==="apple"){const N=m("apple");if(!N?.primary_calendar_id)continue;const E=ql(j),{eventId:k}=await us.createOrUpdateEvent({calendarId:D.external_calendar_id||N.primary_calendar_id,eventId:D.external_event_id,title:j.task_text,notes:j.notes,location:j.location,startDate:E.startDate,endDate:E.endDate,isAllDay:!1});await S.from("quest_calendar_links").update({external_event_id:k,last_app_sync_at:new Date().toISOString()}).eq("id",D.id).eq("user_id",s.id);continue}const C=`${D.provider}-calendar-events`,{error:_}=await S.functions.invoke(C,{body:{action:"updateLinkedEvent",taskId:x}});if(_)throw new Error(_.message||`Failed full sync update for ${D.provider}`)}},onSuccess:async()=>{await r.invalidateQueries({queryKey:["quest-calendar-links"]})}}),y=le({mutationFn:async({taskId:x})=>{if(!s?.id)throw new Error("User not authenticated");const w=(d.get(x)||[]).filter(j=>j.sync_mode==="full_sync");if(w.length!==0)for(const j of w){if(j.provider==="apple"){await us.deleteEvent({eventId:j.external_event_id}).catch(()=>null),await S.from("quest_calendar_links").delete().eq("id",j.id).eq("user_id",s.id);continue}const D=`${j.provider}-calendar-events`;await S.functions.invoke(D,{body:{action:"deleteLinkedEvent",taskId:x}})}},onSuccess:async()=>{await r.invalidateQueries({queryKey:["quest-calendar-links"]})}}),b=le({mutationFn:async({provider:x})=>{const w=`${x}-calendar-events`,{error:j}=await S.functions.invoke(w,{body:{action:"syncLinkedChanges"}});if(j)throw new Error(j.message||`Failed to sync ${x} updates`)},onSuccess:async()=>{await Promise.all([r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),r.invalidateQueries({queryKey:["quest-calendar-links"]})])}});return{links:c,linksByTask:d,hasLinkedEvent:x=>(d.get(x)||[]).length>0,sendTaskToCalendar:u,syncTaskUpdate:g,syncTaskDelete:y,syncProviderPull:b}}const qw=/^([01]\d|2[0-3]):([0-5]\d)$/,Ow=/^\d{4}-\d{2}-\d{2}$/,Fw=n.memo(function(){const s=Ea(),r=as(),{user:a}=be(),{isTabActive:i}=La(),o=Ae(),{inboxTasks:l,inboxCount:c,isLoading:d,toggleInboxTask:m,deleteInboxTask:p}=sw({enabled:i}),[h,f]=n.useState(!1),[u,g]=n.useState(null),{addTask:y,updateTask:b,isUpdating:v}=Km(te(new Date,"yyyy-MM-dd")),{sendTaskToCalendar:x,syncTaskUpdate:w,syncTaskDelete:j,hasLinkedEvent:D}=Wm({enabled:i}),{connections:C}=zn({enabled:i}),_=n.useCallback(async P=>{const T=()=>{W.error("No calendar connected. Opening Preferences..."),r("/profile",{state:{openTab:"preferences"}})};if(C.length===0){T();return}let I,R;const L=async()=>{await x.mutateAsync({taskId:P,options:I||R?{taskDate:I,scheduledTime:R}:void 0})};try{await L(),W.success("Quest synced to calendar");return}catch($){let q=$ instanceof Error?$.message:"Failed to send quest to calendar";if(q.includes("NO_CALENDAR_CONNECTION")){T();return}for(let F=0;F<2;F+=1){if(q.includes("NO_CALENDAR_CONNECTION")){T();return}if(q.includes("TASK_DATE_REQUIRED")&&!I){const H=window.prompt("Choose a date to send this quest (YYYY-MM-DD)",te(new Date,"yyyy-MM-dd"));if(!H||!Ow.test(H)){W.error("Calendar send cancelled. Please choose a valid YYYY-MM-DD date.");return}I=H}if((q.includes("SCHEDULED_TIME_REQUIRED")||q.includes("SCHEDULED_TIME_INVALID"))&&!R){const H=window.prompt("Choose a time to send this quest (HH:mm)","09:00");if(!H||!qw.test(H)){W.error("Calendar send cancelled. Please choose a valid HH:mm time.");return}R=H}try{await L(),W.success("Quest synced to calendar");return}catch(H){if(q=H instanceof Error?H.message:"Failed to send quest to calendar",q.includes("NO_CALENDAR_CONNECTION")){T();return}if(!q.includes("TASK_DATE_REQUIRED")&&!q.includes("SCHEDULED_TIME_REQUIRED")&&!q.includes("SCHEDULED_TIME_INVALID")){W.error(q);return}}}if(q.includes("TASK_DATE_REQUIRED")){W.error("Please assign a date before sending this quest to calendar.");return}if(q.includes("SCHEDULED_TIME_REQUIRED")||q.includes("SCHEDULED_TIME_INVALID")){W.error("Please assign a time before sending this quest to calendar.");return}W.error(q)}},[C.length,r,x]),N=n.useCallback(async(P,T)=>{await b({taskId:P,updates:T}),await w.mutateAsync({taskId:P}).catch(()=>{W.error("Saved quest, but failed to sync linked calendar event")}),o.invalidateQueries({queryKey:["inbox-tasks"]}),o.invalidateQueries({queryKey:["inbox-count"]}),g(null)},[b,w,o]),E=n.useCallback(async P=>{await j.mutateAsync({taskId:P}).catch(()=>{W.error("Failed to remove linked calendar event")}),p(P)},[p,j]),k=n.useCallback(async P=>{if(!a?.id)return;const T=P.sendToInbox?null:P.taskDate??te(new Date,"yyyy-MM-dd"),I=await y({taskText:P.text,difficulty:P.difficulty,taskDate:T,isMainQuest:!1,scheduledTime:P.scheduledTime,estimatedDuration:P.estimatedDuration,recurrencePattern:P.recurrencePattern,recurrenceDays:P.recurrenceDays,reminderEnabled:P.reminderEnabled,reminderMinutesBefore:P.reminderMinutesBefore,notes:P.moreInformation,location:P.location,contactId:P.contactId,autoLogInteraction:P.autoLogInteraction,subtasks:P.subtasks,imageUrl:P.imageUrl,attachments:P.attachments});P.sendToCalendar&&I?.id&&await _(I.id),P.sendToInbox||o.invalidateQueries({queryKey:["daily-tasks"]}),o.invalidateQueries({queryKey:["inbox-tasks"]}),o.invalidateQueries({queryKey:["inbox-count"]}),f(!1)},[a?.id,y,_,o]);return e.jsx(Ia,{mode:"instant",children:e.jsxs("div",{className:"min-h-screen bg-transparent pb-24 pt-safe",children:[e.jsx(qa,{}),e.jsx("div",{className:"max-w-lg mx-auto px-4 pt-6",style:{paddingTop:"max(1.5rem, env(safe-area-inset-top, 0px))"},children:e.jsxs(M.div,{initial:s?!1:{opacity:0,y:-12},animate:{opacity:1,y:0},transition:{duration:s?0:.24},className:"text-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-semibold tracking-tight bg-gradient-to-r from-celestial-blue to-blue-400 bg-clip-text text-transparent",children:"Inbox"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Capture now. Conquer later."}),c>0&&e.jsxs(Fe,{variant:"celestial",className:"text-xs mt-2",children:[c," quests"]})]})}),e.jsx("div",{className:"max-w-lg mx-auto px-4 pt-4",children:d?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(P=>e.jsx("div",{className:"h-14 bg-muted/30 rounded-xl animate-pulse"},P))}):c===0?e.jsx(Gv,{icon:to,title:"Inbox is empty",description:"Capture quests with the + button â€” schedule them later when you're ready.",actionLabel:"Add a quest",onAction:()=>f(!0)}):e.jsx("div",{className:"space-y-2",children:l.map(P=>e.jsxs("div",{className:"flex items-center gap-3 py-3 px-3 rounded-2xl bg-card/82 backdrop-blur-lg border border-border/55 shadow-[0_8px_18px_rgba(0,0,0,0.16)]",children:[e.jsx("button",{onClick:()=>{m({taskId:P.id,completed:!P.completed}),mt.light()},className:"flex-shrink-0 w-6 h-6 rounded-full border-2 border-muted-foreground/40 hover:border-primary flex items-center justify-center transition-colors",children:P.completed&&e.jsx(Pt,{className:"w-4 h-4 text-primary"})}),e.jsx("span",{className:A("text-sm flex-1 min-w-0",P.completed&&"line-through text-muted-foreground"),children:P.task_text}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[e.jsx("button",{onClick:()=>{g(P),mt.light()},className:"p-2 rounded-xl hover:bg-muted/55 text-muted-foreground hover:text-foreground transition-colors touch-manipulation","aria-label":"Edit quest",children:e.jsx(wd,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>{E(P.id),mt.light()},className:"p-2 rounded-xl hover:bg-destructive/12 text-muted-foreground hover:text-destructive transition-colors touch-manipulation","aria-label":"Delete quest",children:e.jsx($s,{className:"w-4 h-4"})})]})]},P.id))})}),e.jsx(Tm,{onTap:()=>f(!0)}),e.jsx(Um,{open:h,onOpenChange:f,selectedDate:new Date,onAdd:k}),e.jsx(zm,{task:u,open:!!u,onOpenChange:P=>!P&&g(null),onSave:N,isSaving:v,onSendToCalendar:_,hasCalendarLink:u?D(u.id):!1,isSendingToCalendar:x.isPending,onDelete:async P=>{await E(P),g(null)},isDeleting:!1})]})})}),vi=(t,s,r)=>Math.max(s,Math.min(r,t)),$w=()=>Math.max(0,document.documentElement.scrollHeight-window.innerHeight),Hw=t=>{const s=window.getComputedStyle(t),r=s.overflowY||s.overflow;return/(auto|scroll|overlay)/i.test(r)&&t.scrollHeight>t.clientHeight},Bw=t=>{if(!t)return{kind:"window"};let s=t;for(;s;){if(Hw(s))return{kind:"element",element:s};s=s.parentElement}return{kind:"window"}};function Uw({containerRef:t,edgeThreshold:s=80,scrollSpeed:r=8,enabled:a=!1}){const i=n.useRef(null),o=n.useRef({kind:"window"}),l=n.useRef(0),c=n.useCallback(()=>{i.current!==null&&(cancelAnimationFrame(i.current),i.current=null),l.current=0},[]),d=n.useCallback(()=>{if(!a||l.current===0){c();return}const f=l.current;let u=!1;if(o.current.kind==="window"){const g=window.scrollY,y=$w(),b=vi(g+f,0,y);Math.abs(b-g)>.01&&(window.scrollTo({top:b,left:window.scrollX,behavior:"auto"}),u=!0)}else{const{element:g}=o.current,y=g.scrollTop,b=Math.max(0,g.scrollHeight-g.clientHeight),v=vi(y+f,0,b);Math.abs(v-y)>.01&&(g.scrollTop=v,u=!0)}if(!u){c();return}i.current=requestAnimationFrame(d)},[a,c]),m=n.useCallback(f=>{if(o.current.kind==="window")return{topDistance:f,bottomDistance:window.innerHeight-f};const u=o.current.element.getBoundingClientRect();return{topDistance:f-u.top,bottomDistance:u.bottom-f}},[]),p=n.useCallback(f=>{const g=1-vi(f,0,s)/s;if(g<=0)return 0;const y=Math.max(1,r*.5),b=Math.max(y+1,r*2.5),v=g*g;return y+(b-y)*v},[s,r]),h=n.useCallback(f=>{if(!a)return;o.current=Bw(t.current);const{topDistance:u,bottomDistance:g}=m(f),y=u<=s,b=g<=s;let v=0;if(y&&(!b||u<=g)?v=-p(u):b&&(v=p(g)),l.current=v,v===0){c();return}i.current===null&&(i.current=requestAnimationFrame(d))},[t,s,a,m,p,d,c]);return n.useEffect(()=>(a||c(),()=>c()),[a,c]),{updatePosition:h,stopScroll:c}}const zw={coarseStepMinutes:15,fineStepMinutes:5,minMinute:0,maxMinute:1439,coarseHoursPerViewport:6,fineHoursPerViewport:2,precisionActivationMode:"manual-hold",precisionHoldMs:220,precisionHoldMovementPx:14,precisionActivationWindowPx:72,precisionExitMovementPx:96,zoomTickCount:7},Ol=720,Qw=320,Oa=t=>({...zw,...t}),Kw=Object.freeze({coarseStepMinutes:15,fineStepMinutes:5,coarseHoursPerViewport:12,fineHoursPerViewport:2,precisionActivationMode:"manual-hold"}),nr=(t,s)=>{const r=Oa(s);return Math.max(r.minMinute,Math.min(r.maxMinute,Math.round(t)))},Ww=(t,s,r)=>{const a=Oa(r),i=Math.max(1,s),o=Math.round(t/i)*i;return nr(o,a)},Fl=(t,s,r)=>{const a=Oa(r),i=a.fineStepMinutes;return Ww(t,i,a)},wi=(t,s)=>{const r=nr(t,s),a=Math.floor(r/60),i=r%60;return`${String(a).padStart(2,"0")}:${String(i).padStart(2,"0")}`},Gw=(t,s)=>{const[r,a]=t.split(":"),i=Number(r),o=Number(a);return!Number.isFinite(i)||!Number.isFinite(o)?nr(0,s):nr(i*60+o,s)},_i=(t,s=Ol)=>{const r=Oa(t),a=Math.max(Qw,Math.round(Number.isFinite(s)?s:Ol)),i=a/Math.max(60,r.coarseHoursPerViewport*60),o=a/Math.max(60,r.fineHoursPerViewport*60);return{viewportHeight:a,coarsePixelsPerMinute:Math.max(.1,i),finePixelsPerMinute:Math.max(.1,o)}},Yw=300,Vw='[data-interactive="true"]',Xw=8,Jw=2,Zw=async t=>{try{await fs.impact({style:t})}catch{}},ji=()=>{if(typeof window>"u")return 720;const t=window.visualViewport?.height??window.innerHeight;return Number.isFinite(t)?t:720},e_=t=>{if(typeof window>"u")return!1;const s=window.getComputedStyle(t),r=s.overflowY||s.overflow;return/(auto|scroll|overlay)/i.test(r)&&t.scrollHeight>t.clientHeight},t_=t=>{if(!t)return{kind:"window"};let s=t;for(;s;){if(e_(s))return{kind:"element",element:s};s=s.parentElement}return{kind:"window"}},$l=t=>t.kind==="window"?typeof window>"u"?0:Number.isFinite(window.scrollY)?window.scrollY:window.pageYOffset:t.element.scrollTop;function s_({containerRef:t,onDrop:s,snapConfig:r,activationThresholdPx:a=Xw}){const i=n.useMemo(()=>Oa(r),[r]),o=Math.max(0,a),[l,c]=n.useState(null),[d,m]=n.useState(null),[p,h]=n.useState(null),[f,u]=n.useState("coarse"),[g,y]=n.useState(null),b=Di(0),v=Di(0),x=n.useRef(null),w=n.useRef("09:00"),j=n.useRef(540),D=n.useRef(540),C=n.useRef(0),_=n.useRef(540),N=n.useRef(540),E=n.useRef(0),k=n.useRef(!1),P=n.useRef(_i(i,ji())),T=n.useRef(null),I=n.useRef({}),R=n.useRef(null),L=n.useRef({kind:"window"}),$=n.useRef(0),q=n.useRef(0),F=n.useRef(null),H=n.useRef(null),{updatePosition:J,stopScroll:G}=Uw({containerRef:t,enabled:l!==null,edgeThreshold:80,scrollSpeed:8}),re=n.useCallback(ee=>ee instanceof Element&&!!ee.closest(Vw),[]),ie=n.useCallback(()=>{T.current&&(clearTimeout(T.current),T.current=null)},[]),K=n.useCallback(()=>{const ee=I.current;ee.pointermove&&window.removeEventListener("pointermove",ee.pointermove),ee.pointerup&&window.removeEventListener("pointerup",ee.pointerup),ee.pointercancel&&window.removeEventListener("pointercancel",ee.pointercancel),ee.touchmove&&window.removeEventListener("touchmove",ee.touchmove),ee.touchend&&window.removeEventListener("touchend",ee.touchend),ee.touchcancel&&window.removeEventListener("touchcancel",ee.touchcancel),ee.scroll&&(ee.scrollContext?.kind==="element"?ee.scrollContext.element.removeEventListener("scroll",ee.scroll):window.removeEventListener("scroll",ee.scroll)),I.current={}},[]),xe=n.useCallback(()=>{u("coarse"),y(null),P.current=_i(i,ji())},[i]),Te=n.useCallback((ee,ne)=>{const X=nr(ee,i),ae=nr(X+ne,i),Se=ae-X;D.current=X,C.current=Se,_.current=ae;const ve=(X-j.current)*P.current.coarsePixelsPerMinute,_e=(ae-j.current)*P.current.coarsePixelsPerMinute;v.set(ve),b.set(_e),!k.current&&Math.abs(_e)>.5&&(k.current=!0);const Me=Fl(ae,"fine",i);Me!==N.current&&(N.current=Me,m(wi(Me,i)))},[v,b,i]),Ne=n.useCallback((ee,ne)=>{if(!x.current)return;const X=Number.isFinite(ee)?ee:E.current,ae=q.current;q.current=X;const Se=ne?.source??"pointer";ne?.skipAutoscrollUpdate||J(X);const ve=$l(L.current)-$.current,Me=X+ve-E.current,et=j.current+Me/P.current.coarsePixelsPerMinute,Je=nr(et,i);let lt=C.current;if(Se==="pointer"&&Math.abs(ae-X)>Jw&&Math.abs(lt)>0){const dt=Math.sign(X-ae),Mt=Math.sign(lt);dt!==0&&dt===-Mt&&(lt-=Mt*i.fineStepMinutes,Math.sign(lt)!==Mt&&(lt=0))}Te(Je,lt)},[Te,i,J]),B=n.useCallback(()=>{H.current!==null&&typeof window<"u"&&(window.cancelAnimationFrame(H.current),H.current=null),F.current=null},[]),z=n.useCallback(ee=>{const ne=F.current;H.current!==null&&typeof window<"u"&&(window.cancelAnimationFrame(H.current),H.current=null),ne!==null&&(F.current=null,Ne(ne,{source:"pointer",...ee}))},[Ne]),Q=n.useCallback(ee=>{if(!x.current)return;const ne=Number.isFinite(ee)?ee:E.current;if(F.current=ne,typeof window>"u"){z();return}H.current===null&&(H.current=window.requestAnimationFrame(()=>{H.current=null;const X=F.current;X!==null&&(F.current=null,Ne(X,{source:"pointer"}))}))},[z,Ne]),Y=n.useCallback(()=>{const ee=t_(t.current);L.current=ee,$.current=$l(ee);const ne=()=>{x.current&&Ne(q.current,{skipAutoscrollUpdate:!0,source:"scroll"})};I.current.scroll=ne,I.current.scrollContext=ee,ee.kind==="element"?ee.element.addEventListener("scroll",ne,{passive:!0}):window.addEventListener("scroll",ne,{passive:!0})},[t,Ne]),ue=n.useCallback(ee=>{if(x.current)return;const ne=Number.isFinite(ee.startY)?ee.startY:0,X=Gw(ee.scheduledTime,i),ae=wi(X,i);R.current=null,x.current=ee.taskId,w.current=ae,j.current=X,D.current=X,C.current=0,_.current=X,N.current=X,E.current=ne,q.current=ne,k.current=!1,P.current=_i(i,ji()),c(ee.taskId),m(ae),b.set(0),v.set(0),u("coarse"),y(null),Y()},[Y,v,b,i]),fe=n.useCallback(ee=>{if(x.current)return!0;const ne=R.current;if(!ne)return!1;const X=Number.isFinite(ee)?ee:ne.startY;return q.current=X,Math.abs(X-ne.startY)<o?!1:(ue(ne),!0)},[ue,o]),De=n.useCallback(()=>{z({skipAutoscrollUpdate:!0}),K(),R.current=null;const ee=x.current,ne=Fl(_.current,"fine",i),X=k.current?wi(ne,i):w.current,ae=ee&&X!==w.current;ee&&ae&&(Zw(Wt.Medium),s(ee,X),h(ee),ie(),T.current=setTimeout(()=>{h(null)},Yw)),x.current=null,c(null),m(null),b.set(0),v.set(0),B(),G(),L.current={kind:"window"},$.current=0,q.current=0,D.current=j.current,C.current=0,k.current=!1,xe()},[ie,B,v,b,z,s,K,xe,i,G]),Ce=n.useCallback((ee,ne,X,ae)=>{if(x.current||R.current)return;K(),B();const Se=Number.isFinite(X)?X:0;R.current={taskId:ee,scheduledTime:ne,startY:Se},q.current=Se,C.current=0,k.current=!1;const ve=Je=>{fe(Je.clientY)&&Q(Je.clientY)},_e=()=>{if(x.current){De();return}R.current=null,D.current=j.current,C.current=0,B(),K()},Me=Je=>{const lt=Je.touches[0];!lt||!fe(lt.clientY)||(Je.preventDefault(),Q(lt.clientY))},et=()=>{if(x.current){De();return}R.current=null,D.current=j.current,C.current=0,B(),K()};I.current={},ae==="touch"?(I.current.touchmove=Me,I.current.touchend=et,I.current.touchcancel=et,window.addEventListener("touchmove",Me,{passive:!1}),window.addEventListener("touchend",et),window.addEventListener("touchcancel",et)):(I.current.pointermove=ve,I.current.pointerup=_e,I.current.pointercancel=_e,window.addEventListener("pointermove",ve),window.addEventListener("pointerup",_e),window.addEventListener("pointercancel",_e))},[B,De,fe,Q,K]),Be=n.useCallback((ee,ne,X)=>{if(ee.defaultPrevented||x.current||R.current||re(ee.target))return;const ae=ee.touches[0];ae&&Ce(ne,X,ae.clientY,"touch")},[re,Ce]),qe=n.useCallback(ee=>{ee.stopPropagation()},[]),he=n.useCallback(ee=>{ee.stopPropagation()},[]),ye=n.useCallback((ee,ne,X)=>{ee.defaultPrevented||x.current||R.current||re(ee.target)||ee.pointerType==="mouse"&&ee.button!==0||Ce(ne,X,ee.clientY,"pointer")},[re,Ce]),Ue=n.useCallback(ee=>{if(z({skipAutoscrollUpdate:!0}),!x.current)return!1;const ne=_.current,X=D.current,ae=C.current+ee*i.fineStepMinutes;return Te(X,ae),_.current===ne?!1:(k.current=!0,!0)},[Te,z,i]),Re=n.useCallback((ee,ne)=>({onPointerDownCapture:X=>ye(X,ee,ne),onPointerDown:X=>ye(X,ee,ne),onTouchStartCapture:X=>Be(X,ee,ne),onTouchStart:X=>Be(X,ee,ne),onTouchMove:qe,onTouchEnd:he,onTouchCancel:he}),[ye,Be,he,qe]),Ie=n.useCallback((ee,ne)=>({onPointerDownCapture:X=>ye(X,ee,ne),onPointerDown:X=>ye(X,ee,ne),onTouchStartCapture:X=>Be(X,ee,ne),onTouchStart:X=>Be(X,ee,ne),onTouchMove:qe,onTouchEnd:he,onTouchCancel:he}),[ye,Be,he,qe]);return n.useEffect(()=>()=>{K(),ie(),B(),R.current=null,D.current=j.current,C.current=0,G()},[ie,B,K,G]),{draggingTaskId:l,previewTime:d,dragOffsetY:b,dragVisualOffsetY:b,dragEdgeOffsetY:v,justDroppedId:p,isDragging:l!==null,snapMode:f,zoomRail:g,nudgeByFineStep:Ue,getDragHandleProps:Re,getRowDragProps:Ie}}const Hl=vf,Bl=wf,r_=n.forwardRef(({className:t,inset:s,children:r,...a},i)=>e.jsxs(_d,{ref:i,className:A("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[state=open]:bg-accent focus:bg-accent",s&&"pl-8",t),...a,children:[r,e.jsx(Et,{className:"ml-auto h-4 w-4"})]}));r_.displayName=_d.displayName;const a_=n.forwardRef(({className:t,...s},r)=>e.jsx(jd,{ref:r,className:A("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...s}));a_.displayName=jd.displayName;const Hi=n.forwardRef(({className:t,sideOffset:s=4,...r},a)=>e.jsx(bf,{children:e.jsx(Nd,{ref:a,sideOffset:s,className:A("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...r})}));Hi.displayName=Nd.displayName;const Rs=n.forwardRef(({className:t,inset:s,...r},a)=>e.jsx(kd,{ref:a,className:A("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",s&&"pl-8",t),...r}));Rs.displayName=kd.displayName;const n_=n.forwardRef(({className:t,children:s,checked:r,...a},i)=>e.jsxs(Cd,{ref:i,className:A("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",t),checked:r,...a,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Sd,{children:e.jsx(Pt,{className:"h-4 w-4"})})}),s]}));n_.displayName=Cd.displayName;const i_=n.forwardRef(({className:t,children:s,...r},a)=>e.jsxs(Ed,{ref:a,className:A("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",t),...r,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Sd,{children:e.jsx(En,{className:"h-2 w-2 fill-current"})})}),s]}));i_.displayName=Ed.displayName;const o_=n.forwardRef(({className:t,inset:s,...r},a)=>e.jsx(Td,{ref:a,className:A("px-2 py-1.5 text-sm font-semibold",s&&"pl-8",t),...r}));o_.displayName=Td.displayName;const l_=n.forwardRef(({className:t,...s},r)=>e.jsx(Md,{ref:r,className:A("-mx-1 my-1 h-px bg-muted",t),...s}));l_.displayName=Md.displayName;const c_=["January","February","March","April","May","June","July","August","September","October","November","December"],d_=({selectedDate:t,onDateSelect:s,onMonthChange:r,tasks:a,milestones:i=[],onTaskClick:o,onMilestoneClick:l,onDateLongPress:c})=>{const[d,m]=n.useState(null),p=ba(t),h=va(t),f=Od(p,{weekStartsOn:0}),u=Fd(h,{weekStartsOn:0}),g=Pi({start:f,end:u}),y=new Date().getFullYear(),b=Array.from({length:8},(k,P)=>y-2+P),v=t.getMonth(),x=t.getFullYear(),w=k=>{const P=new Date(t);P.setMonth(parseInt(k)),(r||s)(P)},j=k=>{const P=new Date(t);P.setFullYear(parseInt(k)),(r||s)(P)},D=k=>{const P=setTimeout(()=>{Hg("pop"),c?.(k)},500);m(P)},C=()=>{d&&(clearTimeout(d),m(null))},_=k=>{const P=te(k,"yyyy-MM-dd");return a.filter(T=>T.task_date===P)},N=k=>{const P=te(k,"yyyy-MM-dd");return i.filter(T=>T.target_date===P)},E=k=>{const T=_(k).filter(I=>I.scheduled_time&&I.estimated_duration);for(let I=0;I<T.length;I++)for(let R=I+1;R<T.length;R++){const L=Ca(T[I].scheduled_time,new Date("2000-01-01T00:00:00")),$=Ca(T[R].scheduled_time,new Date("2000-01-01T00:00:00"));if(!L||!$)continue;const q=new Date(L.getTime()+T[I].estimated_duration*6e4),F=new Date($.getTime()+T[R].estimated_duration*6e4);if(L<F&&$<q)return!0}return!1};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(Na,{value:v.toString(),onValueChange:w,children:[e.jsx(Fr,{className:"w-[120px] h-9 text-xl font-bold border-0 bg-transparent hover:bg-muted/50 focus:ring-0 px-2",children:e.jsx(ka,{})}),e.jsx($r,{className:"bg-popover border border-border z-[110]",children:c_.map((k,P)=>e.jsx(Gs,{value:P.toString(),children:k},k))})]}),e.jsxs(Na,{value:x.toString(),onValueChange:j,children:[e.jsx(Fr,{className:"w-[80px] h-9 text-xl font-bold border-0 bg-transparent hover:bg-muted/50 focus:ring-0 px-2",children:e.jsx(ka,{})}),e.jsx($r,{className:"bg-popover border border-border z-[110]",children:b.map(k=>e.jsx(Gs,{value:k.toString(),children:k},k))})]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(U,{variant:"outline",size:"icon",onClick:()=>(r||s)(Kf(t)),children:e.jsx(Cr,{className:"h-4 w-4"})}),e.jsx(U,{variant:"outline",size:"icon",onClick:()=>(r||s)(Sr(t,1)),children:e.jsx(Et,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"border border-border",children:[e.jsx("div",{className:"grid grid-cols-7 border-b border-border bg-muted/30",children:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((k,P)=>e.jsx("div",{className:A("text-center text-sm font-medium text-muted-foreground p-2",P<6&&"border-r border-border"),children:k},k))}),e.jsx("div",{className:"grid grid-cols-7",children:g.map((k,P)=>{const T=_(k),I=N(k),R=wa(k,t),L=wa(k,new Date),$=E(k),q=(P+1)%7===0,F=P>=g.length-7,H=T.length+I.length,J=3;return e.jsxs("div",{className:A("min-h-[120px] p-2 cursor-pointer transition-colors bg-background",!q&&"border-r border-border",!F&&"border-b border-border",R&&"bg-primary/10",L&&"bg-primary/5",!Wf(k,t)&&"bg-muted/20 text-muted-foreground"),onClick:()=>s(k),onTouchStart:()=>D(k),onTouchEnd:C,onMouseDown:()=>D(k),onMouseUp:C,onMouseLeave:C,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:A("text-sm font-medium",L&&"bg-celestial-blue text-white w-6 h-6 flex items-center justify-center rounded-full ring-2 ring-celestial-blue/30"),children:te(k,"d")}),e.jsxs("div",{className:"flex items-center gap-1",children:[I.length>0&&e.jsx(St,{className:"h-3 w-3 text-amber-500"}),$&&e.jsx(cr,{className:"h-3 w-3 text-destructive"})]})]}),e.jsxs("div",{className:"space-y-0.5",children:[I.slice(0,2).map(G=>e.jsxs("div",{onClick:re=>{re.stopPropagation(),l?.(G)},className:A("text-xs p-1 border-l-2 truncate transition-all hover:bg-amber-500/10","border-l-amber-500 bg-amber-500/5",G.completed_at&&"opacity-50 line-through"),children:[e.jsx(St,{className:"h-2 w-2 inline mr-1 text-amber-500"}),G.title]},G.id)),T.slice(0,Math.max(0,J-I.length)).map(G=>e.jsxs("div",{onClick:re=>{re.stopPropagation(),o(G)},className:A("text-xs p-1 border-l-2 truncate transition-all hover:bg-muted/50",G.completed&&"opacity-50 line-through",G.is_main_quest&&"border-l-amber-500 bg-amber-500/5",!G.is_main_quest&&G.difficulty==="easy"&&"border-l-emerald-500 bg-emerald-500/5",!G.is_main_quest&&G.difficulty==="medium"&&"border-l-amber-500 bg-amber-500/5",!G.is_main_quest&&G.difficulty==="hard"&&"border-l-rose-500 bg-rose-500/5"),children:[G.scheduled_time&&e.jsx(Ft,{className:"h-2 w-2 inline mr-1"}),G.task_text]},G.id)),H>J&&e.jsxs(Fe,{variant:"secondary",className:"text-[10px] py-0",children:["+",H-J," more"]})]})]},k.toString())})})]})]})},u_=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Ul=t=>{if(!t)return null;const s=new Date(t);return Number.isNaN(s.getTime())?null:s};function m_({selectedDate:t,onMonthSelect:s,onBack:r,onClose:a,onYearChange:i,tasks:o,milestones:l=[]}){const[c,d]=n.useState(!1),m=t.getFullYear(),p=new Date,h=new Date().getFullYear(),f=Array.from({length:16},(w,j)=>h-5+j),u=()=>{i(m-1)},g=()=>{i(m+1)},y=w=>{i(w),d(!1)},b=w=>{const j=Fs(an(new Date,m),w);s(j)},v=w=>{const j=ba(Fs(an(new Date,m),w)),D=va(j),C=Pi({start:j,end:D});return o.filter(_=>{const N=Ul(_.task_date);return N?C.some(E=>te(E,"yyyy-MM-dd")===te(N,"yyyy-MM-dd")):!1})},x=w=>{const j=ba(Fs(an(new Date,m),w)),D=va(j),C=Pi({start:j,end:D});return l.filter(_=>{const N=Ul(_.target_date);return N?C.some(E=>te(E,"yyyy-MM-dd")===te(N,"yyyy-MM-dd")):!1})};return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-border/30",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(U,{variant:"ghost",size:"icon",onClick:u,className:"h-8 w-8",children:e.jsx(Cr,{className:"h-5 w-5"})}),e.jsxs(Ds,{open:c,onOpenChange:d,children:[e.jsx(Ps,{asChild:!0,children:e.jsx("button",{className:"text-2xl font-bold text-primary hover:opacity-80 transition-opacity",children:m})}),e.jsx(ys,{className:"w-32 p-0 bg-background border border-border z-[70] pointer-events-auto",align:"start",onOpenAutoFocus:w=>w.preventDefault(),onPointerDownOutside:w=>w.preventDefault(),children:e.jsx("div",{className:"h-64 overflow-y-auto overscroll-contain p-2",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},onTouchMove:w=>w.stopPropagation(),onTouchStart:w=>w.stopPropagation(),children:e.jsx("div",{className:"space-y-1",children:f.map(w=>e.jsx("button",{onClick:j=>{j.stopPropagation(),y(w)},className:A("w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors",w===m?"bg-primary text-primary-foreground":"hover:bg-muted"),children:w},w))})})})]}),e.jsx(U,{variant:"ghost",size:"icon",onClick:g,className:"h-8 w-8",children:e.jsx(Et,{className:"h-5 w-5"})})]}),e.jsx(U,{variant:"ghost",size:"icon",onClick:a,className:"h-9 w-9 rounded-full bg-muted",children:e.jsx(Nt,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"p-4 overflow-y-auto flex-1",children:e.jsx("div",{className:"grid grid-cols-3 gap-3",children:u_.map((w,j)=>{const D=v(j),C=x(j),_=p.getMonth()===j&&p.getFullYear()===m,N=t.getMonth()===j&&t.getFullYear()===m,E=D.filter(T=>!T.completed).length,k=D.filter(T=>T.completed).length,P=C.length>0;return e.jsxs("button",{onClick:()=>b(j),className:A("flex flex-col items-center justify-center py-4 px-2 rounded-xl transition-all min-h-[80px]",N?"bg-coral-500 text-white":_?"bg-coral-500/15 text-coral-500":"text-foreground hover:bg-muted/50"),children:[e.jsx("span",{className:A("text-base font-semibold",N&&"text-white"),children:w}),e.jsxs("div",{className:"flex items-center justify-center gap-1 mt-2 min-h-[8px]",children:[P&&e.jsx("div",{className:A("w-2 h-2 rounded-full",N?"bg-white/70":"bg-amber-500")}),E>0&&e.jsx("div",{className:A("w-2 h-2 rounded-full",N?"bg-white/70":"bg-coral-500")}),k>0&&e.jsx("div",{className:A("w-2 h-2 rounded-full",N?"bg-white/50":"bg-celestial-blue")})]})]},w)})})})]})}const zl=t=>{if(!t)return null;const s=new Date(`${t}T00:00:00`);return Number.isNaN(s.getTime())?null:s},p_=(t,s,r="")=>{try{return Number.isNaN(t.getTime())?r:te(t,s)}catch{return r}};function h_({open:t,onOpenChange:s,selectedDate:r,onDateSelect:a,tasks:i,milestones:o=[],onTimeSlotLongPress:l}){const[c,d]=n.useState(!1),m=y=>{a(y),s(!1)},p=y=>{a(y)},h=y=>{const b=zl(y.task_date);b&&(a(b),s(!1))},f=y=>{const b=zl(y.target_date);b&&(a(b),s(!1))},u=y=>{a(an(r,y))},g=y=>{a(y),d(!1)};return e.jsx(ns,{open:t,onOpenChange:s,children:e.jsxs(Vt,{className:"max-w-2xl w-full h-[90vh] p-0 gap-0 flex flex-col bg-background",hideCloseButton:!0,children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border shrink-0",children:[e.jsx(xs,{className:"text-lg font-semibold",children:p_(r,"MMMM yyyy","Calendar")}),e.jsx(U,{variant:"ghost",size:"icon",onClick:()=>s(!1),className:"h-8 w-8",children:e.jsx(Nt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"px-4 py-2 text-sm text-muted-foreground border-b border-border/50 shrink-0",children:"Tap any date to view daily schedule"}),e.jsx("div",{className:"flex-1 overflow-y-auto px-4 py-3",children:c?e.jsx(m_,{selectedDate:r,onMonthSelect:g,onBack:()=>d(!1),onClose:()=>s(!1),onYearChange:u,tasks:i,milestones:o}):e.jsx(d_,{selectedDate:r,onDateSelect:m,onMonthChange:p,tasks:i,milestones:o,onTaskClick:h,onMilestoneClick:f,onDateLongPress:y=>l?.(y,"09:00")})})]})})}function f_({rail:t,className:s}){return null}function g_({text:t,className:s,speed:r=30,pauseDuration:a=2e3,initialDelay:i=3e3}){const o=n.useRef(null),l=n.useRef(null),[c,d]=n.useState(!1),[m,p]=n.useState(0);n.useEffect(()=>{const b=()=>{if(o.current&&l.current){const w=o.current.offsetWidth,j=l.current.scrollWidth,D=j>w;d(D),D&&p(j-w+20)}},v=setTimeout(b,100),x=new ResizeObserver(b);return o.current&&x.observe(o.current),()=>{clearTimeout(v),x.disconnect()}},[t]);const h=m/r,f=i/1e3+h+a*2/1e3,u=i/1e3/f,g=h/2/f,y=a/1e3/f;return e.jsx("div",{ref:o,className:A("overflow-hidden",s),children:e.jsx(M.span,{ref:l,className:"whitespace-nowrap inline-block",animate:c?{x:[0,0,-m,-m,0,0]}:{x:0},transition:c?{duration:f,times:[0,u,u+g,u+g+y,u+g*2+y,1],repeat:1/0,ease:"linear"}:{duration:0},children:t})})}const _o=t=>{const{user:s}=be(),r=Ae(),{data:a,isLoading:i,error:o}=Ee({queryKey:["journey-path",t],queryFn:async()=>{if(!t||!s?.id)return null;const{data:m,error:p}=await S.from("epic_journey_paths").select("*").eq("epic_id",t).order("milestone_index",{ascending:!1}).limit(1).maybeSingle();if(p)throw console.error("Error fetching journey path:",p),p;return m},enabled:!!t&&!!s?.id,staleTime:600*1e3}),l=le({mutationFn:async({milestoneIndex:m})=>{if(!t||!s?.id)throw new Error("Missing epic or user");const{data:p,error:h}=await S.functions.invoke("generate-journey-path",{body:{epicId:t,milestoneIndex:m,userId:s.id}});if(h)throw h;if(p?.error)throw new Error(p.error);return p},onSuccess:()=>{r.invalidateQueries({queryKey:["journey-path",t]})},onError:m=>{console.error("Failed to generate journey path:",m)}}),c=n.useCallback(()=>{!t||!s?.id||!a&&!i&&l.mutate({milestoneIndex:0})},[t,s?.id,a,i,l]),d=n.useCallback(m=>{!t||!s?.id||l.mutate({milestoneIndex:m})},[t,s?.id,l]);return{pathImageUrl:a?.image_url||null,currentMilestoneIndex:a?.milestone_index??-1,isLoading:i,isGenerating:l.isPending,error:o,generateInitialPath:c,regeneratePathForMilestone:d}},Ql=[70,40,60,25,75,35,55,45],x_=t=>{const s=[];for(let r=0;r<t;r++){const a=t===1?.5:r/(t-1),i=8+a*84,o=Ql[r%Ql.length],l=Math.sin(a*Math.PI*2)*8,c=o+l,d=r===0||r===t-1?10:6+Math.random()*4;s.push({x:i,y:c,size:d})}return s},Bi=(t,s)=>{if(s.length<2)return{x:10,y:50};const r=Math.max(0,Math.min(100,t))/100,a=s.length-1,i=r*a,o=Math.min(Math.floor(i),a-1),l=i-o,c=s[o],d=s[o+1],m=(c.x+d.x)/2,p=(c.y+d.y)/2+(o%2===0?-10:10),h=1-l,f=h*h*c.x+2*h*l*m+l*l*d.x,u=h*h*c.y+2*h*l*p+l*l*d.y;return{x:f,y:u}},Kl=t=>{if(t.length<2)return"";let s=`M ${t[0].x} ${t[0].y}`;for(let r=1;r<t.length;r++){const a=t[r-1],i=t[r],o=(a.x+i.x)/2,l=(a.y+i.y)/2+(r%2===0?-12:12);if(r===Math.max(1,Math.floor(t.length*.4))){const c=o,d=(a.y+i.y)/2;s+=` Q ${o-5} ${l} ${c-4} ${d}`,s+=` C ${c-8} ${d-12} ${c+8} ${d-12} ${c+4} ${d}`,s+=` Q ${o+5} ${l} ${i.x} ${i.y}`}else s+=` Q ${o} ${l} ${i.x} ${i.y}`}return s},y_=(t,s)=>{if(t.length<2||s<=0)return"";const r=Bi(s,t),a=Math.max(0,Math.min(100,s))/100,i=t.length-1,o=a*i,l=Math.floor(o);let c=`M ${t[0].x} ${t[0].y}`;for(let d=1;d<=l&&d<t.length;d++){const m=t[d-1],p=t[d],h=(m.x+p.x)/2,f=(m.y+p.y)/2+(d%2===0?-12:12);if(d===Math.max(1,Math.floor(t.length*.4))){const u=h,g=(m.y+p.y)/2;c+=` Q ${h-5} ${f} ${u-4} ${g}`,c+=` C ${u-8} ${g-12} ${u+8} ${g-12} ${u+4} ${g}`,c+=` Q ${h+5} ${f} ${p.x} ${p.y}`}else c+=` Q ${h} ${f} ${p.x} ${p.y}`}return l<i&&(c+=` L ${r.x} ${r.y}`),c},b_=({milestone:t,currentProgress:s,isPostcard:r})=>{const[a,i]=n.useState(!1),o=t.milestone_percent-s,l=Math.min(100,Math.max(0,s/t.milestone_percent*100));n.useEffect(()=>(a&&(document.body.style.overflow="hidden"),()=>{document.body.style.overflow=""}),[a]);const c=async()=>{try{await fs.impact({style:Wt.Medium})}catch{}i(!0)},d=()=>r?`A cosmic postcard is forming in the starlight... ${t.chapter_number?`Chapter ${t.chapter_number}`:"A new chapter"} of your companion's tale awaits.`:"A new milestone on your journey awaits... Keep going to discover what lies ahead.";return e.jsxs(Ds,{open:a,onOpenChange:i,children:[e.jsx(Ps,{asChild:!0,children:e.jsx("button",{onClick:c,className:A("w-11 h-11 -m-4 flex items-center justify-center","cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 rounded-full","group transition-all duration-200","active:scale-90 active:bg-white/5"),"aria-label":`Unlock milestone at ${t.milestone_percent}%`,children:e.jsx(M.div,{className:A("w-4 h-4 rounded-full flex items-center justify-center",r?"text-amber-400/70":"text-purple-400/70","group-hover:scale-125 transition-transform"),animate:{opacity:[.5,1,.5],scale:[1,1.1,1]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx(td,{className:"w-3.5 h-3.5"})})})}),e.jsx(ys,{className:A("w-64 p-0 border overflow-hidden shadow-xl","supports-[backdrop-filter]:backdrop-blur-xl",r?"bg-gradient-to-br from-amber-950/98 via-yellow-950/95 to-slate-950/98 border-amber-500/20":"bg-gradient-to-br from-purple-950/98 via-slate-950/95 to-slate-950/98 border-purple-500/20"),sideOffset:12,collisionPadding:{top:50,bottom:50,left:16,right:16},children:e.jsxs(M.div,{initial:{opacity:0,scale:.95,y:-5},animate:{opacity:1,scale:1,y:0},transition:{type:"spring",stiffness:300,damping:25},children:[e.jsx(Pe,{children:a&&e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx(M.div,{className:A("absolute top-3 right-4",r?"text-amber-400/40":"text-purple-400/40"),initial:{opacity:0,scale:0},animate:{opacity:1,scale:1,rotate:360},exit:{opacity:0,scale:0},transition:{opacity:{duration:.3},rotate:{duration:4,repeat:1/0,ease:"linear"}},children:e.jsx(pe,{className:"w-4 h-4"})}),e.jsx(M.div,{className:A("absolute bottom-6 left-3",r?"text-amber-400/25":"text-purple-400/25"),initial:{opacity:0,scale:0},animate:{opacity:1,scale:[1,1.3,1],rotate:-360},exit:{opacity:0,scale:0},transition:{opacity:{duration:.3,delay:.1},scale:{duration:3,repeat:1/0},rotate:{duration:5,repeat:1/0,ease:"linear"}},children:e.jsx(St,{className:"w-3 h-3"})}),e.jsx(M.div,{className:A("absolute top-1/2 right-6 w-1.5 h-1.5 rounded-full",r?"bg-amber-400/30":"bg-purple-400/30"),initial:{opacity:0},animate:{opacity:[0,1,0],y:[0,-10,0]},exit:{opacity:0},transition:{duration:2,repeat:1/0,delay:.5}})]})}),e.jsxs("div",{className:"p-4 relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(M.div,{className:A("w-8 h-8 rounded-full flex items-center justify-center",r?"bg-amber-500/20 text-amber-400 shadow-[0_0_12px_rgba(251,191,36,0.3)]":"bg-purple-500/20 text-purple-400 shadow-[0_0_12px_rgba(168,85,247,0.3)]"),animate:{boxShadow:r?["0 0 12px rgba(251,191,36,0.3)","0 0 20px rgba(251,191,36,0.5)","0 0 12px rgba(251,191,36,0.3)"]:["0 0 12px rgba(168,85,247,0.3)","0 0 20px rgba(168,85,247,0.5)","0 0 12px rgba(168,85,247,0.3)"]},transition:{duration:2,repeat:1/0},children:e.jsx(jn,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-white leading-tight",children:"Mystery Awaits..."}),e.jsx("p",{className:A("text-xs leading-tight",r?"text-amber-400/80":"text-purple-400/80"),children:r?"Postcard Milestone":"Journey Milestone"})]})]}),e.jsx("div",{className:A("h-px w-full mb-3",r?"bg-amber-400/20":"bg-purple-400/20")}),e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsxs("div",{className:"relative w-12 h-12 flex-shrink-0",children:[e.jsxs("svg",{className:"w-12 h-12 -rotate-90",viewBox:"0 0 36 36",children:[e.jsx("circle",{cx:"18",cy:"18",r:"14",fill:"none",stroke:"currentColor",strokeWidth:"2.5",className:"text-white/10"}),e.jsx(M.circle,{cx:"18",cy:"18",r:"14",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",className:r?"text-amber-400":"text-purple-400",initial:{strokeDasharray:"0 100"},animate:{strokeDasharray:`${l*.88} 100`},transition:{duration:.8,ease:"easeOut"}})]}),e.jsxs("span",{className:A("absolute inset-0 flex items-center justify-center text-xs font-bold",r?"text-amber-400":"text-purple-400"),children:[Math.round(l),"%"]})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-white/60 leading-snug",children:"Unlock at"}),e.jsxs("p",{className:A("text-lg font-bold leading-tight",r?"text-amber-400":"text-purple-400"),children:[t.milestone_percent,"%"]}),e.jsx("p",{className:"text-xs text-white/50 leading-snug",children:o>0?`${Math.round(o)}% to go`:"Almost there!"})]})]}),e.jsxs("p",{className:"text-xs text-white/75 leading-relaxed italic mb-3",children:['"',d(),'"']}),(t.phase_name||t.target_date)&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.phase_name&&e.jsx("span",{className:A("px-2 py-1 rounded-md text-[11px] font-medium",r?"bg-amber-400/10 text-amber-400/70":"bg-purple-400/10 text-purple-400/70"),children:t.phase_name}),t.target_date&&e.jsxs("span",{className:A("px-2 py-1 rounded-md text-[11px] font-medium",r?"bg-amber-400/10 text-amber-400/70":"bg-purple-400/10 text-purple-400/70"),children:["Est. ",te(new Date(t.target_date),"MMM d")]})]})]})]})})]})},v_=({isRevealing:t,isPostcard:s,onComplete:r})=>(n.useEffect(()=>{if(t){(async()=>{try{await fs.notification({type:_f.Success})}catch{}})();const i=setTimeout(r,2e3);return()=>clearTimeout(i)}},[t,r]),e.jsx(Pe,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(M.div,{className:A("absolute inset-0 rounded-full border-2",s?"border-amber-400":"border-purple-400"),initial:{scale:.5,opacity:1},animate:{scale:4,opacity:0},exit:{opacity:0},transition:{duration:.8,ease:"easeOut"},style:{width:20,height:20,marginLeft:-10,marginTop:-10}}),e.jsx(M.div,{className:A("absolute inset-0 rounded-full border",s?"border-amber-400/50":"border-purple-400/50"),initial:{scale:.5,opacity:1},animate:{scale:5,opacity:0},exit:{opacity:0},transition:{duration:1,ease:"easeOut",delay:.1},style:{width:20,height:20,marginLeft:-10,marginTop:-10}}),e.jsx(M.div,{className:A("absolute rounded-full",s?"bg-amber-400":"bg-purple-400"),initial:{scale:0,opacity:.8},animate:{scale:[0,2.5,0],opacity:[.8,.4,0]},exit:{opacity:0},transition:{duration:.6,ease:"easeOut"},style:{width:24,height:24,marginLeft:-12,marginTop:-12,filter:"blur(6px)"}}),Array.from({length:8}).map((a,i)=>{const o=i/8*Math.PI*2,l=30+Math.random()*20;return e.jsx(M.div,{className:A("absolute w-1.5 h-1.5 rounded-full",s?"bg-amber-400":"bg-purple-400"),initial:{x:0,y:0,scale:1,opacity:1},animate:{x:Math.cos(o)*l,y:Math.sin(o)*l,scale:0,opacity:0},exit:{opacity:0},transition:{duration:.6+Math.random()*.3,ease:"easeOut",delay:Math.random()*.1},style:{marginLeft:-3,marginTop:-3}},`particle-${i}`)}),e.jsx(M.div,{className:A("absolute",s?"text-amber-400":"text-purple-400"),initial:{scale:0,rotate:0,opacity:1},animate:{scale:[0,1.5,0],rotate:180,opacity:[1,1,0]},exit:{opacity:0},transition:{duration:.8,ease:"easeOut"},style:{marginLeft:-8,marginTop:-30},children:e.jsx(pe,{className:"w-4 h-4"})}),e.jsx(M.div,{className:A("absolute",s?"text-yellow-300":"text-purple-300"),initial:{scale:0,rotate:0,opacity:1},animate:{scale:[0,1.2,0],rotate:-90,opacity:[1,1,0]},exit:{opacity:0},transition:{duration:.7,ease:"easeOut",delay:.1},style:{marginLeft:15,marginTop:-20},children:e.jsx(St,{className:"w-3 h-3"})}),e.jsx(M.div,{className:A("absolute",s?"text-amber-300":"text-purple-300"),initial:{scale:0,y:0,opacity:1},animate:{scale:[0,1,0],y:-25,opacity:[1,1,0]},exit:{opacity:0},transition:{duration:.6,ease:"easeOut",delay:.15},style:{marginLeft:-20,marginTop:-15},children:e.jsx(ft,{className:"w-3 h-3"})})]})})),w_=({milestone:t,pos:s,index:r,progress:a,sortedMilestones:i})=>{const o=t.milestone_percent,l=a>=o||!!t.completed_at,c=r<i.length-1?i[r+1].milestone_percent:101,d=a>=o&&a<c,m=t.is_postcard_milestone,p=o===100||r===i.length-1,h=r===0,f=m?s.size*1.3:s.size,u=n.useRef(l),[g,y]=n.useState(!1);n.useEffect(()=>{l&&!u.current&&!h&&y(!0),u.current=l},[l,h]);const b=()=>{y(!1)};return e.jsxs(M.div,{className:"absolute transform -translate-x-1/2 -translate-y-1/2",style:{left:`${s.x}%`,top:`${s.y}%`},initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{delay:r*.1,duration:.5},children:[e.jsx(v_,{isRevealing:g,isPostcard:!!m,onComplete:b}),e.jsx(Pe,{children:l&&e.jsx(M.div,{className:A("absolute inset-0 rounded-full",m?d?"bg-yellow-400":"bg-yellow-400/50":d?"bg-primary":"bg-primary/50"),style:{width:f*3,height:f*3,marginLeft:-f,marginTop:-f,filter:"blur(8px)"},initial:g?{scale:0,opacity:0}:{scale:1,opacity:.5},animate:d?{scale:[1,1.3,1],opacity:[.5,.8,.5]}:{scale:1,opacity:.5},exit:{scale:0,opacity:0},transition:g?{scale:{duration:.5,ease:"easeOut"},opacity:{duration:.5,ease:"easeOut"}}:{duration:2,repeat:d?1/0:0,ease:"easeInOut"}})}),e.jsx(M.div,{className:A("rounded-full relative z-10",l?m?"bg-gradient-to-br from-yellow-400 via-amber-300 to-yellow-500 shadow-[0_0_10px_rgba(250,204,21,0.5)]":"bg-gradient-to-br from-primary via-purple-400 to-primary shadow-[0_0_10px_rgba(167,108,255,0.5)]":"bg-muted/30 border border-muted/50"),style:{width:f,height:f},animate:g?{scale:[.5,1.4,1],rotate:[0,180,360]}:d?{boxShadow:m?["0 0 10px rgba(250,204,21,0.5)","0 0 20px rgba(250,204,21,0.8)","0 0 10px rgba(250,204,21,0.5)"]:["0 0 10px rgba(167,108,255,0.5)","0 0 20px rgba(167,108,255,0.8)","0 0 10px rgba(167,108,255,0.5)"]}:{},transition:g?{duration:.6,ease:"easeOut"}:{duration:1.5,repeat:1/0,ease:"easeInOut"}}),e.jsx("div",{className:A("absolute top-full mt-1 left-1/2 -translate-x-1/2 text-[10px] font-medium whitespace-nowrap flex items-center gap-0.5 max-w-[60px] overflow-hidden",l?m?"text-yellow-400":"text-primary":"text-muted-foreground/50",p&&l&&"text-yellow-400"),children:e.jsx(Pe,{mode:"wait",children:h?e.jsx(M.span,{className:"font-semibold",initial:{opacity:1},animate:{opacity:1},children:"Start"},"start"):l?m?e.jsx(M.div,{initial:{opacity:0,scale:0,rotate:-180},animate:{opacity:1,scale:1,rotate:0},transition:{type:"spring",stiffness:300,damping:20,delay:g?.3:0},children:e.jsx(Da,{className:"w-3 h-3"})},"postcard"):e.jsx(M.span,{className:"truncate",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{type:"spring",stiffness:300,damping:20,delay:g?.3:0},children:t.title.slice(0,8)},"title"):e.jsx(M.div,{initial:{opacity:1},exit:{opacity:0,scale:0,rotate:180},transition:{duration:.3},children:e.jsx(b_,{milestone:t,currentProgress:a,isPostcard:!!m})},"mystery")})})]})},__=t=>{switch(t){case"sick":return"saturate-50 brightness-75";case"sad":return"saturate-75 brightness-90";case"worried":return"saturate-90";default:return""}},j_=n.memo(function({progress:s,targetDays:r,className:a,companionImageUrl:i,companionMood:o,showCompanion:l=!0,milestones:c,epicId:d,transparentBackground:m=!1}){const{pathImageUrl:p,isGenerating:h}=_o(d),f=n.useMemo(()=>!c||c.length===0?[{id:"start",title:"Start",milestone_percent:0,is_postcard_milestone:!1,completed_at:null},{id:"end",title:"Finish",milestone_percent:100,is_postcard_milestone:!0,completed_at:null}]:[{id:"start",title:"Start",milestone_percent:0,is_postcard_milestone:!1,completed_at:new Date().toISOString()},...c].sort((x,w)=>x.milestone_percent-w.milestone_percent),[c]),u=n.useMemo(()=>x_(f.length),[f.length]),g=n.useMemo(()=>{const v=x=>{const w=Math.sin(x*9999)*1e4;return w-Math.floor(w)};return Array.from({length:20},(x,w)=>({x:v(w*1)*100,y:v(w*2+.5)*100,size:1+v(w*3+.7)*2,delay:v(w*4+.3)*3,duration:2+v(w*5+.9)*2}))},[]),b=(v=>{const x=Math.max(0,Math.min(100,v)),w=Math.round(x/100*120);return{border:`hsl(${w}, 70%, 50%)`,glowStrong:`hsla(${w}, 80%, 60%, 0.4)`,glowMedium:`hsla(${w}, 80%, 60%, 0.3)`,glowSoft:`hsla(${w}, 70%, 40%, 0.2)`,glowInner:`hsla(${w}, 80%, 60%, 0.1)`}})(s);return e.jsxs("div",{className:A("relative w-full h-56 rounded-xl overflow-hidden",!m&&!p&&"bg-gradient-to-br from-slate-950 via-purple-950/50 to-slate-950",a),style:m?void 0:{boxShadow:`
          0 0 10px ${b.glowStrong},
          0 0 20px ${b.glowMedium},
          0 0 40px ${b.glowSoft},
          inset 0 0 15px ${b.glowInner}
        `},children:[p&&e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("img",{src:p,alt:"Journey path",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-slate-950/90 via-slate-950/50 to-slate-950/70"})]}),h&&!p&&e.jsxs("div",{className:"absolute inset-0 bg-gradient-to-br from-slate-950 via-purple-950/50 to-slate-950",children:[e.jsx(M.div,{className:"absolute inset-0 bg-gradient-to-r from-transparent via-primary/10 to-transparent",animate:{x:["-100%","100%"]},transition:{duration:2,repeat:1/0,ease:"linear"}}),e.jsxs("div",{className:"absolute bottom-2 left-2 text-xs text-primary/60 flex items-center gap-1",children:[e.jsx(pe,{className:"w-3 h-3 animate-pulse"}),e.jsx("span",{children:"Mapping your path..."})]})]}),!p&&!m&&e.jsxs("div",{className:"absolute inset-0 opacity-40",children:[e.jsx("div",{className:"absolute top-1/2 left-1/3 w-24 h-24 bg-primary/30 rounded-full blur-xl"}),e.jsx("div",{className:"absolute top-1/3 right-1/4 w-16 h-16 bg-purple-500/20 rounded-full blur-lg"})]}),g.map((v,x)=>e.jsx(M.div,{className:"absolute rounded-full bg-white/60",style:{left:`${v.x}%`,top:`${v.y}%`,width:v.size,height:v.size},animate:{opacity:[.2,.8,.2],scale:[1,1.2,1]},transition:{duration:v.duration,delay:v.delay,repeat:1/0,ease:"easeInOut"}},`bg-${x}`)),e.jsxs("svg",{className:"absolute inset-0 w-full h-full",viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"pulseGradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"hsl(var(--primary) / 0.15)"}),e.jsx("stop",{offset:"40%",stopColor:"hsl(var(--primary) / 0.15)"}),e.jsx("stop",{offset:"50%",stopColor:"hsl(var(--primary) / 0.8)"}),e.jsx("stop",{offset:"60%",stopColor:"hsl(var(--primary) / 0.15)"}),e.jsx("stop",{offset:"100%",stopColor:"hsl(var(--primary) / 0.15)"}),e.jsx("animate",{attributeName:"x1",values:"-100%;100%",dur:"2.5s",repeatCount:"indefinite"}),e.jsx("animate",{attributeName:"x2",values:"0%;200%",dur:"2.5s",repeatCount:"indefinite"})]}),e.jsxs("filter",{id:"trailGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"1",result:"blur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"blur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("path",{d:Kl(u),fill:"none",stroke:"hsl(var(--muted) / 0.15)",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:Kl(u),fill:"none",stroke:"url(#pulseGradient)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",opacity:"0.7"}),s>0&&e.jsx(M.path,{d:y_(u,s),fill:"none",stroke:"hsl(var(--primary))",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",filter:"url(#trailGlow)",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:1.5,ease:"easeOut"}})]}),u.map((v,x)=>e.jsx(w_,{milestone:f[x],pos:v,index:x,progress:s,sortedMilestones:f},`star-${f[x].id}`)),l&&i&&e.jsxs(M.div,{className:"absolute transform -translate-x-1/2 -translate-y-1/2 z-20",style:{left:`${Bi(s,u).x}%`,top:`${Bi(s,u).y}%`},initial:{scale:0,opacity:0},animate:{scale:1,opacity:1,y:[0,-4,0]},transition:{scale:{duration:.5},opacity:{duration:.5},y:{duration:2,repeat:1/0,ease:"easeInOut"}},children:[e.jsx(M.div,{className:"absolute inset-0 rounded-full bg-primary/40",style:{width:36,height:36,marginLeft:-4,marginTop:-4,filter:"blur(6px)"},animate:{scale:[1,1.2,1],opacity:[.4,.7,.4]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx("div",{className:A("w-7 h-7 rounded-full border-2 border-primary overflow-hidden bg-background shadow-lg",__(o)),children:e.jsx("img",{src:i,alt:"Companion",className:"w-full h-full object-cover"})})]}),e.jsxs("div",{className:"absolute bottom-2 right-3 flex items-center gap-1.5",children:[e.jsxs("div",{className:"text-xs font-bold text-primary",children:[s,"%"]}),e.jsx("div",{className:"w-8 h-1 bg-muted/20 rounded-full overflow-hidden",children:e.jsx(M.div,{className:"h-full bg-gradient-to-r from-primary to-purple-400",initial:{width:0},animate:{width:`${s}%`},transition:{duration:1}})})]}),e.jsx("div",{className:"absolute top-2 left-3 text-[10px] uppercase tracking-wider text-muted-foreground/60 font-medium",children:"Star Path Journey"})]})}),Qn=t=>{const{user:s}=be(),r=Ae(),{data:a=[],isLoading:i,error:o}=Ee({queryKey:["milestones",t],queryFn:async()=>{if(!s||!t)return[];const{data:C,error:_}=await S.from("epic_milestones").select("*").eq("epic_id",t).eq("user_id",s.id).order("phase_order",{ascending:!0,nullsFirst:!0}).order("milestone_percent",{ascending:!0});if(_)throw _;return C},enabled:!!s&&!!t,staleTime:180*1e3}),l=n.useMemo(()=>a.reduce((_,N)=>{const E=N.phase_name||"General",k=N.phase_order??0,P=_.find(T=>T.phaseName===E);return P?P.milestones.push(N):_.push({phaseName:E,phaseOrder:k,milestones:[N]}),_},[]).sort((_,N)=>_.phaseOrder-N.phaseOrder),[a]),c=a.filter(C=>C.completed_at).length,d=a.length,m=a.find(C=>!C.completed_at),p=a.filter(C=>C.is_postcard_milestone),h=n.useCallback(()=>{for(const C of l)if(C.milestones.filter(N=>!N.completed_at).length>0)return C.phaseName;return l[l.length-1]?.phaseName||null},[l]),f=n.useCallback(()=>{const C=new Date;C.setHours(0,0,0,0);const _=h();return l.map(N=>{const E=N.milestones.filter(q=>q.completed_at).length,k=N.milestones.length,P=k>0?E/k*100:0,T=N.milestones.filter(q=>q.target_date).map(q=>new Date(q.target_date)).sort((q,F)=>q.getTime()-F.getTime()),I=T[0]||null,R=T[T.length-1]||null,L=N.milestones.filter(q=>q.completed_at||!q.target_date?!1:new Date(q.target_date)<C),$=R?qt(R,C):null;return{phaseName:N.phaseName,phaseOrder:N.phaseOrder,completed:E,total:k,progress:P,isComplete:P===100,isCurrent:N.phaseName===_,isOnTrack:L.length===0,overdueMilestones:L.length,daysUntilEnd:$,startDate:I,endDate:R}})},[l,h]),u=n.useCallback(()=>f().find(N=>N.isCurrent)?.progress??0,[f]),g=n.useCallback((C,_)=>{if(!C||!_||d===0)return null;const N=new Date,E=new Date(C),k=new Date(_),P=qt(k,E),T=qt(N,E);if(P<=0)return null;const I=d>0?c/d*100:0,R=Math.min(100,T/P*100),L=I-R,$=T>0?I/T:0;let q=null;if($>0){const K=(100-I)/$;q=new Date,q.setDate(q.getDate()+K)}const F=$>0&&q?qt(k,q):0;let H;L>=10?H="A":L>=0?H="B":L>=-10?H="C":L>=-25?H="D":H="F";const G=f().find(ie=>ie.isCurrent);let re="on_track";return G&&G.overdueMilestones>0&&(re=G.overdueMilestones>1?"behind":"at_risk"),{score:H,overallProgress:I,expectedProgress:R,progressDelta:L,velocity:$,estimatedCompletionDate:q,daysAheadOrBehind:F,currentPhaseHealth:re}},[c,d,f]),y=n.useCallback(C=>{if(C.completed_at||!C.target_date)return!1;const _=new Date(C.target_date),N=new Date;return N.setHours(0,0,0,0),_.setHours(0,0,0,0),_<N},[]),b=n.useCallback(C=>{if(!C.target_date)return null;const _=new Date(C.target_date),N=new Date;N.setHours(0,0,0,0),_.setHours(0,0,0,0);const E=_.getTime()-N.getTime();return Math.ceil(E/(1e3*60*60*24))},[]),v=n.useCallback(()=>a.find(C=>C.is_postcard_milestone&&!C.completed_at),[a]),x=n.useCallback(()=>{const C=v();if(!C)return null;const _=d>0?c/d*100:0,N=C.milestone_percent;return{current:_,target:N,remaining:Math.max(0,N-_),milestone:C}},[v,c,d]),w=le({mutationFn:async({milestoneId:C,epicId:_,onPostcardTrigger:N})=>{if(!s)throw new Error("Not authenticated");const E=a.find(P=>P.id===C);if(!E)throw new Error("Milestone not found");const{error:k}=await S.from("epic_milestones").update({completed_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",C).eq("user_id",s.id);if(k)throw k;return{milestone:E,onPostcardTrigger:N}},onSuccess:({milestone:C,onPostcardTrigger:_})=>{r.invalidateQueries({queryKey:["milestones",t]}),r.invalidateQueries({queryKey:["epics"]}),W.success(`Milestone completed: ${C.title}`),C.is_postcard_milestone&&_&&_(C)},onError:C=>{console.error("Failed to complete milestone:",C),W.error("Failed to complete milestone")}}),j=le({mutationFn:async C=>{if(!s)throw new Error("Not authenticated");const{error:_}=await S.from("epic_milestones").update({completed_at:null,updated_at:new Date().toISOString()}).eq("id",C).eq("user_id",s.id);if(_)throw _},onSuccess:()=>{r.invalidateQueries({queryKey:["milestones",t]}),r.invalidateQueries({queryKey:["epics"]}),W.success("Milestone unmarked")},onError:C=>{console.error("Failed to uncomplete milestone:",C),W.error("Failed to update milestone")}}),D=le({mutationFn:async C=>{if(!s)throw new Error("Not authenticated");let _=5;C.targetDays<=14?_=3:C.targetDays<=30?_=4:C.targetDays<=60?_=5:_=6;const N=new Date(C.startDate),E=Array.from({length:_},(P,T)=>{const I=Math.round((T+1)/_*100),R=Math.floor(C.targetDays*I/100),L=new Date(N);return L.setDate(L.getDate()+R),{epic_id:C.epicId,user_id:s.id,title:T===_-1?"The Finale":`Chapter ${T+1}`,description:T===_-1?"Complete your epic journey!":`Reach ${I}% of your goal`,target_date:L.toISOString().split("T")[0],milestone_percent:I,is_postcard_milestone:!0,phase_order:T+1,chapter_number:T+1}}),{error:k}=await S.from("epic_milestones").insert(E);if(k)throw k;return E},onSuccess:()=>{r.invalidateQueries({queryKey:["milestones",t]}),r.invalidateQueries({queryKey:["epics"]})},onError:C=>{console.error("Failed to backfill milestones:",C)}});return{milestones:a,milestonesByPhase:l,isLoading:i,error:o,completedCount:c,totalCount:d,nextMilestone:m,postcardMilestones:p,completeMilestone:w,uncompleteMilestone:j,getCurrentPhase:h,getPhaseStats:f,getCurrentPhaseProgress:u,getJourneyHealth:g,isMilestoneOverdue:y,getDaysUntilMilestone:b,getNextPostcardMilestone:v,getProgressToNextPostcard:x,backfillLegacyMilestones:D,isCompleting:w.isPending,isBackfilling:D.isPending}};function Gm(){const[t,s]=n.useState(null),[r,a]=n.useState(!1),[i,o]=n.useState(null),l=n.useCallback(async v=>{a(!0),o(null);try{const{data:x,error:w}=await S.functions.invoke("generate-journey-schedule",{body:v});if(w)throw w;if(x?.error)throw new Error(x.error);const j=x;return s(j),j}catch(x){const w=x instanceof Error?x.message:"Failed to build schedule";return o(w),console.error("Failed to generate schedule:",x),null}finally{a(!1)}},[]),c=n.useCallback(async v=>{a(!0),o(null);try{const{data:x,error:w}=await S.functions.invoke("generate-journey-schedule",{body:v});if(w)throw w;if(x?.error)throw new Error(x.error);const j=x;return s(j),j}catch(x){const w=x instanceof Error?x.message:"Failed to adjust schedule";return o(w),console.error("Failed to adjust schedule:",x),null}finally{a(!1)}},[]),d=7,m=n.useMemo(()=>t?.milestones.filter(v=>v.isPostcardMilestone).length??0,[t]),p=n.useCallback(v=>{s(x=>{if(!x)return x;const w=x.milestones.find(j=>j.id===v);return!w||!w.isPostcardMilestone&&x.milestones.filter(D=>D.isPostcardMilestone).length>=d?x:{...x,milestones:x.milestones.map(j=>j.id===v?{...j,isPostcardMilestone:!j.isPostcardMilestone}:j)}})},[]),h=n.useCallback(v=>{s(x=>x&&{...x,rituals:x.rituals.map(w=>w.id===v.id?v:w)})},[]),f=n.useCallback(v=>{s(x=>x&&{...x,rituals:[...x.rituals,v]})},[]),u=n.useCallback(v=>{s(x=>x&&{...x,rituals:x.rituals.filter(w=>w.id!==v)})},[]),g=n.useCallback(v=>{s(x=>x&&{...x,rituals:v})},[]),y=n.useCallback((v,x)=>{s(w=>w&&{...w,milestones:w.milestones.map(j=>j.id===v?{...j,targetDate:x}:j)})},[]),b=n.useCallback(()=>{s(null),o(null),a(!1)},[]);return{schedule:t,isLoading:r,error:i,generateSchedule:l,adjustSchedule:c,toggleMilestone:p,updateRitual:h,addRitual:f,removeRitual:u,setRituals:g,updateMilestoneDate:y,reset:b,postcardCount:m,maxPostcards:d}}function N_(t,s,r,a,i){const{milestones:o,completedCount:l,totalCount:c,getPhaseStats:d,getCurrentPhase:m,getJourneyHealth:p}=Qn(t);return n.useMemo(()=>{const h=new Date,f=m(),u=d(),g=p(a,i),y=[],b=[],v=c,x=[...o].sort((q,F)=>new Date(q.target_date||0).getTime()-new Date(F.target_date||0).getTime()),w=a?new Date(a):x[0]?.target_date?new Date(x[0].target_date):h,j=i?new Date(i):x[x.length-1]?.target_date?new Date(x[x.length-1].target_date):h,D=Math.max(1,qt(h,w)),C=l/D,_=v-l,N=C>0?_/C:1/0,E=C>0?new Date(h.getTime()+N*24*60*60*1e3):null,k=E?qt(j,E):-999,P=[];if(s&&s.length>0){const q=new Map;s.forEach(F=>{const H=q.get(F.habit_id)||{completions:[],title:F.habit?.title||"Unknown"};H.completions.push(new Date(F.completed_at)),q.set(F.habit_id,H)}),q.forEach((F,H)=>{const G=F.completions.filter(fe=>qt(h,fe)<=30),re={},ie={0:0,1:0,2:0,3:0,4:0,5:0,6:0},K={0:0,1:0,2:0,3:0,4:0,5:0,6:0};G.forEach(fe=>{ie[fe.getDay()]++});for(let fe=0;fe<30;fe++){const De=Dn(h,fe);K[De.getDay()]++}for(let fe=0;fe<7;fe++)re[fe.toString()]=K[fe]>0?ie[fe]/K[fe]:0;const xe=Math.floor(G.length/2),Te=G.slice(0,xe).length,Ne=G.slice(xe).length;let B="stable";Ne>Te*1.2?B="improving":Ne<Te*.8&&(B="declining");const z=G.length/30,Y=Object.entries(re).sort((fe,De)=>fe[1]-De[1]).slice(0,2).filter(([,fe])=>fe<.3).map(([fe])=>["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][parseInt(fe)]);let ue;Y.length>0?ue=`You often skip this on ${Y.join(" and ")}. Consider a lighter version for those days.`:B==="declining"&&(ue="Your completion rate is declining. Maybe simplify or reschedule?"),P.push({habitId:H,habitTitle:F.title,completionRate:z,weekdayRates:re,trend:B,suggestion:ue})})}let T=null,I=!1;const R=r?qt(h,r):0;if(k<-7&&(I=!0,T="behind_schedule",y.push({type:"warning",priority:"high",title:"You're falling behind",description:`At your current pace, you'll finish ${Math.abs(k)} days late. Let's adjust your plan.`,action:{label:"Get back on track",adjustmentText:"I'm behind schedule. Please help me get back on track by redistributing milestones or simplifying the plan."}}),b.push({label:"Get Back on Track",description:"We will redistribute milestones to match your pace",adjustmentText:"I'm behind schedule. Redistribute milestones realistically based on my current pace, prioritizing the most important ones.",icon:"target",priority:"primary"})),k>7&&(y.push({type:"celebration",priority:"low",title:"You're ahead of schedule!",description:`You're on track to finish ${k} days early. Consider accelerating or adding depth.`,action:{label:"Accelerate journey",adjustmentText:"I'm ahead of schedule! Please compress my timeline or add more challenging milestones."}}),b.push({label:"Accelerate Journey",description:"Compress timeline since you're ahead",adjustmentText:"I'm ahead of schedule. Compress my timeline or add more challenging milestones to maximize growth.",icon:"rocket",priority:"secondary"})),g&&(g.score==="D"||g.score==="F")){I=!0,T=T||"poor_health";const q=g.progressDelta<-20?"You're significantly behind expected progress":"Your journey needs attention to stay on track";y.push({type:"warning",priority:"high",title:"Journey needs attention",description:q,action:{label:"Review & adjust",adjustmentText:`My journey health is poor. ${q}. Please suggest adjustments to get back on track.`}})}R>5&&(I=!0,T=T||"inactive",y.push({type:"suggestion",priority:"medium",title:"Welcome back!",description:`It's been ${R} days since your last activity. Let's reassess your timeline.`,action:{label:"Adjust for break",adjustmentText:`I took a ${R}-day break. Please adjust my milestones to account for this time away.`}}),b.push({label:"Adjust for Break",description:`Account for your ${R}-day break`,adjustmentText:`I took a ${R}-day break. Shift my remaining milestones forward while keeping the overall pace realistic.`,icon:"clock",priority:"primary"}));const L=P.filter(q=>q.completionRate<.3);L.length>0&&(y.push({type:"suggestion",priority:"medium",title:"Some habits need attention",description:`${L.map(q=>q.habitTitle).join(", ")} have low completion rates.`,action:{label:"Simplify routine",adjustmentText:`I'm struggling with these habits: ${L.map(q=>q.habitTitle).join(", ")}. Please suggest easier alternatives or reduced frequency.`}}),b.push({label:"Simplify Routine",description:"Make struggling habits more achievable",adjustmentText:`These habits are hard to maintain: ${L.map(q=>q.habitTitle).join(", ")}. Suggest simpler versions or reduced frequency.`,icon:"shield",priority:"secondary"}));const $=u.find(q=>q.phaseName===f);if($&&!$.isOnTrack&&$.daysUntilEnd!==null&&$.daysUntilEnd<7){const q=$.total-$.completed;y.push({type:"warning",priority:"high",title:"Phase deadline approaching",description:`Only ${$.daysUntilEnd} days left in "${$.phaseName}" with ${q} milestones to go.`,action:{label:"Redistribute phase",adjustmentText:`I'm running out of time in the "${$.phaseName}" phase. Please redistribute remaining milestones.`}})}return b.length===0&&b.push({label:"Optimize Timeline",description:"Get guidance to improve your schedule",adjustmentText:"Analyze my current progress and optimize the remaining timeline for best results.",icon:"sparkles",priority:"primary"},{label:"Add Buffer Time",description:"Extend deadline by 2 weeks",adjustmentText:"Add 2 weeks of buffer time to my journey and redistribute milestones accordingly.",icon:"clock",priority:"secondary"}),b.find(q=>q.label==="Simplify Routine")||b.push({label:"Focus on Essentials",description:"Keep only the most impactful milestones",adjustmentText:"Simplify my journey to focus on the most essential milestones. Remove or combine less critical ones.",icon:"target",priority:"secondary"}),{shouldShowAdvisor:I,advisorTrigger:T,insights:y,habitPatterns:P,velocityPerDay:C,estimatedCompletionDate:E,daysAheadOrBehind:k,smartQuickActions:b.slice(0,4)}},[o,l,c,s,r,a,i,d,m,p])}const Wl={rocket:Hc,clock:Ft,target:At,sparkles:pe,shield:Es};function k_({epicId:t,onSelectAdjustment:s,onDismiss:r,variant:a="card",className:i}){const[o,l]=n.useState(!1),[c,d]=n.useState(!1),{user:m}=be(),{data:p}=Ee({queryKey:["epic-details",t],queryFn:async()=>{const{data:v,error:x}=await S.from("epics").select("start_date, end_date, epic_habits(habit_id)").eq("id",t).maybeSingle();if(x)throw x;return v||null},enabled:!!t}),{data:h}=Ee({queryKey:["epic-habit-completions",t,m?.id],queryFn:async()=>{if(!m?.id||!p?.epic_habits?.length)return[];const v=p.epic_habits.map(D=>D.habit_id),x=te(Dn(new Date,30),"yyyy-MM-dd"),{data:w,error:j}=await S.from("habit_completions").select("habit_id, date, habits(title)").eq("user_id",m.id).in("habit_id",v).gte("date",x);if(j)throw j;return(w||[]).map(D=>({habit_id:D.habit_id,completed_at:D.date,habit:D.habits}))},enabled:!!m?.id&&!!p?.epic_habits?.length}),{data:f}=Ee({queryKey:["last-epic-activity",t,m?.id],queryFn:async()=>{if(!m?.id)return null;const{data:v,error:x}=await S.from("epic_progress_log").select("date").eq("epic_id",t).eq("user_id",m.id).order("date",{ascending:!1}).limit(1).maybeSingle();if(x&&x.code!=="PGRST116")throw x;return v?.date?new Date(v.date):void 0},enabled:!!m?.id&&!!t}),u=N_(t,h,f,p?.start_date,p?.end_date),g=()=>{l(!0),r?.()};if(o||!u.shouldShowAdvisor&&a!=="inline")return null;const y=u.insights[0],b=u.smartQuickActions.find(v=>v.priority==="primary");return a==="banner"?e.jsx(Pe,{children:e.jsx(M.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:A("bg-gradient-to-r from-primary/10 via-primary/5 to-transparent","border border-primary/20 rounded-lg p-3",i),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0",children:e.jsx(pe,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:y?.title||"Journey Check-in"}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:y?.description||"Get suggestions to optimize your plan"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[b&&e.jsxs(U,{size:"sm",variant:"default",className:"text-xs h-7 gap-1",onClick:()=>s(b.adjustmentText),children:[b.label,e.jsx(Et,{className:"w-3 h-3"})]}),e.jsx(U,{size:"icon",variant:"ghost",className:"h-6 w-6",onClick:g,children:e.jsx(Nt,{className:"w-3 h-3"})})]})]})})}):a==="inline"?e.jsxs("div",{className:A("space-y-3",i),children:[e.jsx("div",{className:"grid grid-cols-2 gap-2",children:u.smartQuickActions.map((v,x)=>{const w=Wl[v.icon];return e.jsx(M.button,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{delay:x*.05},onClick:()=>s(v.adjustmentText),className:A("p-3 rounded-lg text-left transition-all","hover:scale-[1.02] active:scale-[0.98]",v.priority==="primary"?"bg-primary/10 border border-primary/30 hover:bg-primary/20":"bg-secondary/50 border border-border/50 hover:bg-secondary"),children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:A("w-7 h-7 rounded-full flex items-center justify-center flex-shrink-0",v.priority==="primary"?"bg-primary/20":"bg-muted"),children:e.jsx(w,{className:A("w-3.5 h-3.5",v.priority==="primary"?"text-primary":"text-muted-foreground")})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs font-medium",children:v.label}),e.jsx("p",{className:"text-[10px] text-muted-foreground line-clamp-2",children:v.description})]})]})},x)})}),u.insights.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>d(!c),className:"flex items-center gap-1.5 text-xs text-muted-foreground hover:text-foreground transition-colors",children:[e.jsx(eo,{className:"w-3 h-3"}),e.jsxs("span",{children:[u.insights.length," insight",u.insights.length>1?"s":""," available"]}),e.jsx(Et,{className:A("w-3 h-3 transition-transform",c&&"rotate-90")})]}),e.jsx(Pe,{children:c&&e.jsx(M.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"space-y-2 overflow-hidden",children:u.insights.map((v,x)=>e.jsx(Gl,{insight:v,onAction:s},x))})})]}),u.estimatedCompletionDate&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground bg-secondary/30 rounded-lg px-3 py-2",children:[u.daysAheadOrBehind>=0?e.jsx(Ts,{className:"w-3.5 h-3.5 text-green-500"}):e.jsx(ca,{className:"w-3.5 h-3.5 text-amber-500"}),e.jsxs("span",{children:["Est. completion: ",te(u.estimatedCompletionDate,"MMM d, yyyy"),u.daysAheadOrBehind!==0&&e.jsxs("span",{className:A("ml-1",u.daysAheadOrBehind>=0?"text-green-500":"text-amber-500"),children:["(",u.daysAheadOrBehind>0?"+":"",u.daysAheadOrBehind," days)"]})]})]})]}):e.jsxs(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:A("bg-card border border-border rounded-xl overflow-hidden",i),children:[e.jsx("div",{className:"px-4 py-3 bg-gradient-to-r from-primary/10 to-transparent border-b border-border/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center",children:e.jsx(pe,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Smart Reschedule"}),e.jsx("p",{className:"text-[10px] text-muted-foreground",children:"Personalized suggestions"})]})]}),e.jsx(U,{size:"icon",variant:"ghost",className:"h-6 w-6",onClick:g,children:e.jsx(Nt,{className:"w-3 h-3"})})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[y&&e.jsx(Gl,{insight:y,onAction:s,featured:!0}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:u.smartQuickActions.slice(0,2).map((v,x)=>{const w=Wl[v.icon];return e.jsxs(U,{variant:v.priority==="primary"?"default":"outline",size:"sm",className:"h-auto py-2 px-3 justify-start gap-2",onClick:()=>s(v.adjustmentText),children:[e.jsx(w,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsx("span",{className:"text-xs truncate",children:v.label})]},x)})}),u.estimatedCompletionDate&&e.jsxs("div",{className:"flex items-center justify-between text-xs bg-secondary/30 rounded-lg px-3 py-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Projected finish"}),e.jsxs("span",{className:"font-medium flex items-center gap-1",children:[te(u.estimatedCompletionDate,"MMM d"),u.daysAheadOrBehind>=0?e.jsxs(Fe,{variant:"outline",className:"text-[10px] px-1 py-0 text-green-500 border-green-500/30",children:["+",u.daysAheadOrBehind,"d"]}):e.jsxs(Fe,{variant:"outline",className:"text-[10px] px-1 py-0 text-amber-500 border-amber-500/30",children:[u.daysAheadOrBehind,"d"]})]})]})]})]})}function Gl({insight:t,onAction:s,featured:r=!1}){const a=()=>{switch(t.type){case"warning":return e.jsx(Xs,{className:"w-3.5 h-3.5 text-amber-500"});case"celebration":return e.jsx(Ts,{className:"w-3.5 h-3.5 text-green-500"});default:return e.jsx(eo,{className:"w-3.5 h-3.5 text-blue-500"})}},i=()=>{switch(t.type){case"warning":return"bg-amber-500/10 border-amber-500/20";case"celebration":return"bg-green-500/10 border-green-500/20";default:return"bg-blue-500/10 border-blue-500/20"}};return e.jsx("div",{className:A("rounded-lg border p-3",i(),r&&"ring-1 ring-primary/20"),children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"mt-0.5",children:a()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium",children:t.title}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:t.description}),t.action&&e.jsxs(U,{size:"sm",variant:"ghost",className:"h-6 px-2 text-[10px] mt-2 gap-1",onClick:()=>s(t.action.adjustmentText),children:[t.action.label,e.jsx(Et,{className:"w-3 h-3"})]})]})]})})}const C_=[{label:"I'm falling behind",value:"I'm falling behind schedule and need more time for each milestone"},{label:"Ahead of schedule",value:"I'm ahead of schedule, please compress the timeline"},{label:"Extend deadline",value:"I need to extend my deadline, please redistribute milestones"},{label:"More milestones",value:"Add more intermediate milestones to track progress better"},{label:"Simplify plan",value:"Simplify the plan with fewer, more focused milestones"}],S_=({epicId:t,epicTitle:s,epicGoal:r,currentDeadline:a,children:i})=>{const[o,l]=n.useState(!1),[c,d]=n.useState(""),[m,p]=n.useState(a?new Date(a):void 0),[h,f]=n.useState("input"),[u,g]=n.useState(!0),{user:y}=be(),b=Ae(),{milestones:v,milestonesByPhase:x,getJourneyHealth:w}=Qn(t),j=w(),{schedule:D,adjustSchedule:C,isLoading:_,error:N,reset:E}=Gm(),k={phases:x.map((q,F)=>({id:`phase-${F}`,name:q.phaseName,description:"",startDate:q.milestones[0]?.target_date||"",endDate:q.milestones[q.milestones.length-1]?.target_date||"",phaseOrder:q.phaseOrder})),milestones:v.map(q=>({id:q.id,title:q.title,description:q.description||"",targetDate:q.target_date||"",phaseOrder:q.phase_order||0,phaseName:q.phase_name||"General",isPostcardMilestone:q.is_postcard_milestone||!1,milestonePercent:q.milestone_percent})),rituals:[]},P=q=>{d(q),g(!1)},T=q=>{d(q),g(!1)},I=async()=>{if(!c.trim()&&m?.toISOString()===a){W.error("Please describe your adjustment or change the deadline");return}await C({goal:r||s,deadline:m?.toISOString()||a,adjustmentRequest:c,previousSchedule:k})&&f("preview")},R=async()=>{if(!(!D||!y)){f("saving");try{const{error:q}=await S.from("epic_milestones").delete().eq("epic_id",t).eq("user_id",y.id);if(q)throw q;const F=D.milestones.map(J=>({epic_id:t,user_id:y.id,title:J.title,description:J.description,milestone_percent:J.milestonePercent,target_date:J.targetDate,phase_name:J.phaseName,phase_order:J.phaseOrder,is_postcard_milestone:J.isPostcardMilestone})),{error:H}=await S.from("epic_milestones").insert(F);if(H)throw H;if(m&&m.toISOString()!==a){const{error:J}=await S.from("epics").update({end_date:m.toISOString()}).eq("id",t).eq("user_id",y.id);if(J)throw J}b.invalidateQueries({queryKey:["milestones",t]}),b.invalidateQueries({queryKey:["epics"]}),W.success("Journey rescheduled!",{description:`${D.milestones.length} milestones updated`}),l(!1),L()}catch(q){console.error("Failed to apply schedule changes:",q),W.error("Failed to update schedule"),f("preview")}}},L=()=>{f("input"),d(""),g(!0),E()},$=q=>{l(q),q||L()};return e.jsxs(ur,{open:o,onOpenChange:$,handleOnly:!0,shouldScaleBackground:!1,modal:!1,children:[e.jsx(ho,{asChild:!0,children:i||e.jsxs(U,{variant:"outline",size:"sm",className:"gap-1.5 text-xs",children:[e.jsx(Vs,{className:"w-3.5 h-3.5"}),"Reschedule"]})}),e.jsxs(mr,{className:"max-h-[90vh]",children:[e.jsxs(pr,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(hr,{className:"flex items-center gap-2",children:[e.jsx(Vs,{className:"w-5 h-5 text-primary"}),"Smart Reschedule"]}),j&&e.jsxs(Fe,{variant:"outline",className:A("text-xs",j.score==="A"&&"border-green-500/50 text-green-500",j.score==="B"&&"border-blue-500/50 text-blue-500",j.score==="C"&&"border-amber-500/50 text-amber-500",(j.score==="D"||j.score==="F")&&"border-red-500/50 text-red-500"),children:[e.jsx(Ss,{className:"w-3 h-3 mr-1"}),"Health: ",j.score]})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[h==="input"&&"Personalized suggestions to optimize your journey",h==="preview"&&"Review and apply the new schedule",h==="saving"&&"Applying changes..."]})]}),e.jsx(On,{className:"flex-1 px-4 max-h-[60vh]",children:e.jsxs(Pe,{mode:"wait",children:[h==="input"&&e.jsxs(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"space-y-4 pb-4",children:[u&&e.jsx(k_,{epicId:t,onSelectAdjustment:T,onDismiss:()=>g(!1),variant:"inline"}),!u&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Quick adjustments"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:C_.map(q=>e.jsx(Fe,{variant:"outline",className:"cursor-pointer hover:bg-primary/10 hover:border-primary/50 transition-colors",onClick:()=>P(q.value),children:q.label},q.label))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Describe your changes"}),e.jsx(Kt,{value:c,onChange:q=>d(q.target.value),placeholder:"e.g., I need to take a 2-week break next month, please adjust milestones around that...",className:"min-h-[100px] resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Adjust deadline (optional)"}),e.jsxs(Ds,{children:[e.jsx(Ps,{asChild:!0,children:e.jsxs(U,{variant:"outline",className:A("w-full justify-start text-left font-normal",!m&&"text-muted-foreground"),children:[e.jsx($t,{className:"mr-2 h-4 w-4"}),m?te(m,"PPP"):"Pick a new deadline"]})}),e.jsx(ys,{className:"w-auto p-0",align:"start",children:e.jsx(Vr,{mode:"single",selected:m,onSelect:p,disabled:q=>q<new Date,initialFocus:!0})})]})]}),e.jsxs("div",{className:"bg-secondary/30 rounded-lg p-3 space-y-1",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Current journey"}),e.jsx("div",{className:"text-sm font-medium",children:s}),e.jsxs("div",{className:"flex gap-3 text-xs text-muted-foreground",children:[e.jsxs("span",{children:[v.length," milestones"]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:[v.filter(q=>q.completed_at).length," completed"]})]})]}),N&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive bg-destructive/10 rounded-lg p-3",children:[e.jsx(cr,{className:"w-4 h-4"}),N]})]},"input"),h==="preview"&&D&&e.jsxs(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"space-y-4 pb-4",children:[e.jsxs("div",{className:A("rounded-lg p-3 border",D.feasibilityAssessment.feasibility==="comfortable"&&"bg-green-500/10 border-green-500/20",D.feasibilityAssessment.feasibility==="achievable"&&"bg-blue-500/10 border-blue-500/20",D.feasibilityAssessment.feasibility==="aggressive"&&"bg-amber-500/10 border-amber-500/20",D.feasibilityAssessment.feasibility==="very_aggressive"&&"bg-red-500/10 border-red-500/20"),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(pe,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-medium text-sm capitalize",children:[hs(D.feasibilityAssessment.feasibility)," timeline"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:D.feasibilityAssessment.message})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground mb-2",children:["New milestones (",D.milestones.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-[200px] overflow-y-auto",children:D.milestones.map((q,F)=>e.jsxs("div",{className:"flex items-center gap-3 p-2 bg-secondary/30 rounded-lg",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center text-xs font-medium",children:F+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-sm font-medium truncate",children:q.title}),q.isPostcardMilestone&&e.jsx(pe,{className:"w-3 h-3 text-amber-500 flex-shrink-0"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-muted-foreground",children:[e.jsx("span",{children:q.phaseName}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:te(new Date(q.targetDate),"MMM d")})]})]})]},q.id))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-secondary/30 rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-lg font-bold",children:v.length}),e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Current milestones"})]}),e.jsxs("div",{className:"bg-primary/10 rounded-lg p-3 text-center border border-primary/20",children:[e.jsx("div",{className:"text-lg font-bold text-primary",children:D.milestones.length}),e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"New milestones"})]})]})]},"preview"),h==="saving"&&e.jsxs(M.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center py-12",children:[e.jsx(bt,{className:"w-8 h-8 animate-spin text-primary mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Updating your journey..."})]},"saving")]})}),e.jsxs(Ku,{className:"border-t pt-4",children:[h==="input"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(U,{variant:"outline",className:"flex-1",onClick:()=>l(!1),children:"Cancel"}),e.jsx(U,{className:"flex-1 gap-2",onClick:I,disabled:_,children:_?e.jsxs(e.Fragment,{children:[e.jsx(bt,{className:"w-4 h-4 animate-spin"}),"Building..."]}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"w-4 h-4"}),"Build New Schedule"]})})]}),h==="preview"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(U,{variant:"outline",className:"flex-1",onClick:()=>f("input"),children:"Back"}),e.jsxs(U,{className:"flex-1 gap-2",onClick:R,children:[e.jsx(Ar,{className:"w-4 h-4"}),"Apply Changes"]})]})]})]})]})},E_=({show:t,milestoneTitle:s,chapterNumber:r,onDismiss:a})=>{const[i,o]=n.useState("entering");n.useEffect(()=>{if(t){o("entering"),io(),fs.impact({style:Wt.Heavy}).catch(()=>{});const c=["#F59E0B","#F97316","#FBBF24","#FCD34D","#D97706"];Ot({particleCount:80,spread:70,origin:{y:.6},colors:c}),setTimeout(()=>{Ot({particleCount:50,angle:60,spread:55,origin:{x:0,y:.6},colors:c}),Ot({particleCount:50,angle:120,spread:55,origin:{x:1,y:.6},colors:c})},200),setTimeout(()=>o("main"),300)}},[t]);const l=()=>{o("exiting"),setTimeout(()=>{a()},300)};return t?e.jsx(Pe,{children:e.jsx(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-background/80 backdrop-blur-sm",onClick:l,children:e.jsxs(M.div,{initial:{scale:.8,rotateY:180,opacity:0},animate:i==="exiting"?{scale:.8,opacity:0,y:20}:{scale:1,rotateY:0,opacity:1},transition:{type:"spring",damping:20,stiffness:300,duration:.6},className:"relative w-[85vw] max-w-sm p-6 rounded-2xl bg-gradient-to-br from-amber-500/20 via-orange-500/10 to-yellow-500/20 border border-amber-500/30 shadow-2xl",onClick:c=>c.stopPropagation(),style:{perspective:1e3},children:[e.jsx("div",{className:"absolute inset-0 rounded-2xl bg-amber-500/10 blur-xl"}),e.jsxs("div",{className:"relative z-10 flex flex-col items-center text-center space-y-4",children:[e.jsxs(M.div,{initial:{scale:0},animate:{scale:1},transition:{delay:.3,type:"spring",stiffness:500},className:"relative",children:[e.jsx("div",{className:"w-20 h-20 rounded-2xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shadow-lg",children:e.jsx(Dd,{className:"w-10 h-10 text-white"})}),e.jsx(M.div,{animate:{rotate:360},transition:{duration:3,repeat:1/0,ease:"linear"},className:"absolute -top-2 -right-2",children:e.jsx(pe,{className:"w-6 h-6 text-amber-400"})}),e.jsx(M.div,{animate:{scale:[1,1.2,1]},transition:{duration:2,repeat:1/0},className:"absolute -bottom-1 -left-2",children:e.jsx(pe,{className:"w-5 h-5 text-yellow-400"})})]}),e.jsxs(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.4},children:[e.jsx("h2",{className:"text-xl font-bold bg-gradient-to-r from-amber-400 via-orange-400 to-yellow-500 bg-clip-text text-transparent",children:"Postcard Unlocked!"}),r&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Chapter ",r]})]}),s&&e.jsx(M.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},className:"text-sm text-foreground/80 font-medium",children:s}),e.jsx(M.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.6},className:"text-xs text-muted-foreground italic",children:"Your companion is sending you a cosmic memory..."}),e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.7},className:"pt-2",children:e.jsx(U,{onClick:l,className:"bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white px-8",children:"Continue"})})]}),e.jsx("button",{onClick:l,className:"absolute top-3 right-3 p-1 rounded-full hover:bg-white/10 transition-colors",children:e.jsx(Nt,{className:"w-4 h-4 text-muted-foreground"})}),e.jsx(pe,{className:"absolute top-4 left-4 w-4 h-4 text-amber-400/50"}),e.jsx(pe,{className:"absolute bottom-4 right-4 w-4 h-4 text-orange-400/50"})]})})}):null},T_=({milestone:t,isOpen:s,onClose:r,onComplete:a,onUncomplete:i,isCompleting:o,status:l,postcard:c})=>{if(!t)return null;const d=l==="completed",m=l==="overdue",p=t.is_postcard_milestone,f=p?tr.POSTCARD:tr.REGULAR,g=(()=>{if(!t.target_date)return null;const y=new Date(t.target_date),b=new Date;return b.setHours(0,0,0,0),y.setHours(0,0,0,0),qt(y,b)})();return e.jsx(ur,{open:s,onOpenChange:y=>!y&&r(),handleOnly:!0,shouldScaleBackground:!1,modal:!1,children:e.jsxs(mr,{className:"max-h-[90vh]",children:[e.jsxs(pr,{className:"pb-2 border-b border-border/50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.phase_name&&e.jsx(Fe,{variant:"outline",className:"text-xs",children:t.phase_name}),p&&e.jsxs(Fe,{variant:"outline",className:"text-xs text-royal-purple border-royal-purple/30 bg-royal-purple/10",children:[e.jsx(pe,{className:"w-3 h-3 mr-1"}),"Celebration"]})]}),e.jsx(U,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:r,children:e.jsx(Nt,{className:"w-4 h-4"})})]}),e.jsxs(hr,{className:"text-left flex items-center gap-2 mt-2",children:[e.jsx("span",{children:t.title}),p&&e.jsx(pe,{className:"w-4 h-4 text-amber-500"})]})]}),e.jsx("div",{className:"flex-1 max-h-[60vh] overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},"data-vaul-no-drag":!0,children:e.jsxs("div",{className:"px-4 py-4 space-y-5",children:[e.jsxs(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex flex-wrap items-center gap-2",children:[d&&e.jsxs(Fe,{className:"bg-green-500/10 text-green-600 border-green-200",children:[e.jsx(Ar,{className:"w-3 h-3 mr-1"}),"Completed"]}),m&&e.jsxs(Fe,{variant:"destructive",className:"bg-destructive/10",children:[e.jsx(cr,{className:"w-3 h-3 mr-1"}),"Overdue"]}),!d&&!m&&e.jsx(Fe,{variant:"secondary",children:"Pending"}),t.target_date&&e.jsxs("div",{className:A("flex items-center gap-1.5 text-sm",m&&"text-destructive"),children:[e.jsx($t,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:te(new Date(t.target_date),"MMM d, yyyy")}),g!==null&&!d&&e.jsxs("span",{className:"text-muted-foreground text-xs",children:["(",g>0?`in ${g} day${g!==1?"s":""}`:g===0?"today":`${Math.abs(g)} day${Math.abs(g)!==1?"s":""} ago`,")"]})]})]}),t.description&&e.jsxs(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.05},className:"space-y-2",children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground",children:"Description"}),e.jsx("p",{className:"text-sm leading-relaxed",children:t.description})]}),p&&e.jsxs(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.1},className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ga,{className:"w-4 h-4 text-primary"}),e.jsx("h4",{className:"text-sm font-semibold",children:"Cosmiq Story"})]}),c?e.jsxs("div",{className:"rounded-xl border border-border/50 bg-card/50 overflow-hidden",children:[c.chapter_title&&e.jsx("div",{className:"px-4 py-3 border-b border-border/30 bg-primary/5",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(St,{className:"w-4 h-4 text-amber-500"}),e.jsxs("span",{className:"text-sm font-medium",children:[c.chapter_number?`Chapter ${c.chapter_number}: `:"",c.chapter_title]})]})}),c.image_url&&e.jsxs("div",{className:"relative aspect-video w-full",children:[e.jsx("img",{src:c.image_url,alt:c.location_name,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-3",children:e.jsxs("div",{className:"flex items-center gap-1.5 text-white/90",children:[e.jsx(Da,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-sm font-medium",children:c.location_name})]})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[c.location_description&&e.jsx("p",{className:"text-sm text-muted-foreground italic",children:c.location_description}),c.story_content&&e.jsx("div",{className:"space-y-2",children:e.jsx("p",{className:"text-sm leading-relaxed",children:c.story_content})}),c.clue_text&&e.jsxs("div",{className:"flex items-start gap-2 p-3 rounded-lg bg-purple-500/10 border border-purple-200/30",children:[e.jsx(la,{className:"w-4 h-4 text-purple-500 mt-0.5 shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-purple-600 block mb-1",children:"Mystery Clue"}),e.jsxs("p",{className:"text-sm italic text-purple-700/80",children:['"',c.clue_text,'"']})]})]}),c.prophecy_line&&e.jsxs("div",{className:"flex items-start gap-2 p-3 rounded-lg bg-amber-500/10 border border-amber-200/30",children:[e.jsx(jf,{className:"w-4 h-4 text-amber-500 mt-0.5 shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-amber-600 block mb-1",children:"Prophecy Fragment"}),e.jsxs("p",{className:"text-sm italic text-amber-700/80",children:['"',c.prophecy_line,'"']})]})]}),c.characters_featured&&c.characters_featured.length>0&&e.jsxs("div",{className:"flex items-center gap-2 pt-2 border-t border-border/30",children:[e.jsx(bd,{className:"w-3.5 h-3.5 text-muted-foreground"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Featuring:"," ",c.characters_featured.join(", ")]})]})]})]}):d?e.jsxs("div",{className:"rounded-xl border border-border/50 bg-muted/30 p-4 text-center",children:[e.jsx(bt,{className:"w-6 h-6 text-muted-foreground mx-auto mb-2 animate-spin"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Your story chapter is being written..."})]}):e.jsxs("div",{className:"relative rounded-xl border border-dashed border-stardust-gold/40 bg-gradient-to-br from-stardust-gold/10 via-amber-500/5 to-royal-purple/10 p-5 text-center overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-stardust-gold/10 to-transparent animate-shimmer"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-stardust-gold/20 flex items-center justify-center mx-auto mb-3",children:e.jsx(pe,{className:"w-6 h-6 text-stardust-gold"})}),e.jsxs("p",{className:"text-sm text-foreground/90 font-medium",children:["Complete this milestone to unlock"," ",e.jsx("span",{className:"text-stardust-gold",children:t.chapter_number?`Chapter ${t.chapter_number}`:"a new chapter"})," ","of your cosmic journey!"]})]})]})]})]})}),e.jsx("div",{className:"p-4 border-t border-border/50",children:e.jsx(Pe,{mode:"wait",children:d?e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:e.jsxs(U,{variant:"outline",className:"w-full",onClick:()=>i(t),disabled:o,children:[o?e.jsx(bt,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(Nt,{className:"w-4 h-4 mr-2"}),"Mark Incomplete"]})},"uncomplete"):e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:e.jsxs(U,{className:"w-full gap-2",onClick:()=>a(t),disabled:o,children:[o?e.jsx(bt,{className:"w-4 h-4 animate-spin"}):e.jsx(Ar,{className:"w-4 h-4"}),"Complete Milestone",e.jsxs(Fe,{variant:"secondary",className:"ml-1 bg-primary-foreground/20 text-primary-foreground text-xs",children:["+",f," XP"]})]})},"complete")})})]})})},M_=({epicId:t,epicTitle:s,epicGoal:r,currentDeadline:a,children:i})=>{const[o,l]=n.useState(!1),[c,d]=n.useState(null),{milestones:m,milestonesByPhase:p,isLoading:h,completedCount:f,totalCount:u,completeMilestone:g,uncompleteMilestone:y,getCurrentPhase:b,isMilestoneOverdue:v,isCompleting:x}=Qn(t),{postcards:w,checkMilestoneForPostcard:j,postcardJustUnlocked:D,clearPostcardUnlocked:C}=$v(),{companion:_}=Tt(),{awardMilestoneComplete:N,awardPhaseComplete:E,awardEpicComplete:k}=Xt(),{regeneratePathForMilestone:P}=_o(t),T=b(),I=n.useMemo(()=>w?.filter(G=>G.epic_id===t)||[],[w,t]),R=G=>I.find(re=>re.milestone_percent===G.milestone_percent),L=G=>{const re=p.find(K=>K.phaseName===G.phase_name);if(!re)return;re.milestones.every(K=>K.id===G.id||K.completed_at)&&E(re.phaseName)},$=G=>{m.every(ie=>ie.id===G.id||ie.completed_at)&&u>0&&k(s)},q=async G=>{const re=m.findIndex(ie=>ie.id===G.id);g.mutate({milestoneId:G.id,epicId:t,onPostcardTrigger:ie=>{j(ie.id,t,_?.id||"",{spirit_animal:_?.spirit_animal,favorite_color:_?.favorite_color,core_element:_?.core_element,eye_color:_?.eye_color,fur_color:_?.fur_color})}},{onSuccess:()=>{re>=0&&P(re+1),N(G.is_postcard_milestone||!1),L(G),$(G),d(null)}})},F=G=>{y.mutate(G.id),d(null)},H=G=>{d(G)},J=G=>G.completed_at?"completed":v(G)?"overdue":"pending";return e.jsxs(e.Fragment,{children:[e.jsx(E_,{show:!!D,milestoneTitle:D?.milestoneTitle,chapterNumber:D?.chapterNumber,onDismiss:C}),e.jsxs(ur,{open:o,onOpenChange:l,shouldScaleBackground:!1,handleOnly:!0,children:[e.jsx(ho,{asChild:!0,children:i||e.jsxs(U,{variant:"ghost",size:"sm",className:"gap-1.5 text-xs",children:[e.jsx(da,{className:"w-3.5 h-3.5"}),"View Timeline"]})}),e.jsxs(mr,{className:"max-h-[85vh]",children:[e.jsxs(pr,{className:"pb-2",children:[e.jsxs(hr,{className:"flex items-center gap-2",children:[e.jsx(da,{className:"w-5 h-5 text-primary"}),s]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Fe,{variant:"secondary",className:"text-xs",children:[f," / ",u," milestones"]}),T&&e.jsxs(Fe,{variant:"outline",className:"text-xs",children:["Current: ",T]})]}),a&&e.jsx(S_,{epicId:t,epicTitle:s,epicGoal:r,currentDeadline:a,children:e.jsxs(U,{variant:"ghost",size:"sm",className:"gap-1.5 text-xs h-7",children:[e.jsx(Vs,{className:"w-3.5 h-3.5"}),"Reschedule"]})})]})]}),e.jsx("div",{className:"flex-1 px-4 pb-6 max-h-[60vh] overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},"data-vaul-no-drag":!0,children:h?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary"})}):m.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(da,{className:"w-10 h-10 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No milestones yet"})]}):e.jsx("div",{className:"space-y-2",children:m.sort((G,re)=>!G.target_date&&!re.target_date?0:G.target_date?re.target_date?new Date(G.target_date).getTime()-new Date(re.target_date).getTime():-1:1).map(G=>{const re=J(G);return e.jsxs("div",{onClick:()=>H(G),className:A("flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors",re==="completed"&&"bg-green-500/5",re==="overdue"&&"bg-destructive/5",re==="pending"&&"bg-secondary/30 hover:bg-secondary/50"),children:[e.jsx(lr,{checked:!!G.completed_at,disabled:!0,className:"pointer-events-none"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("span",{className:A("text-sm",re==="completed"&&"line-through text-muted-foreground"),children:G.title})}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[G.target_date&&e.jsx("span",{className:A("text-xs text-muted-foreground",re==="overdue"&&"text-destructive"),children:te(new Date(G.target_date),"MMM d")}),re==="completed"&&e.jsx(Ar,{className:"w-4 h-4 text-green-600"}),re==="overdue"&&e.jsx(cr,{className:"w-4 h-4 text-destructive"}),G.is_postcard_milestone&&!G.completed_at&&e.jsx(St,{className:"w-4 h-4 text-amber-500"}),e.jsx(Et,{className:"w-4 h-4 text-muted-foreground/50"})]})]},G.id)})})})]})]}),e.jsx(T_,{milestone:c,isOpen:!!c,onClose:()=>d(null),onComplete:q,onUncomplete:F,isCompleting:x,status:c?J(c):"pending",postcard:c?R(c):void 0})]})},Yl=n.memo(function({epic:s,children:r}){const[a,i]=n.useState(!1),{pathImageUrl:o,isLoading:l}=_o(s.id),{milestones:c,totalCount:d}=Qn(s.id),{companion:m}=Tt(),p=n.useMemo(()=>Math.max(0,qt(new Date(s.end_date),new Date)),[s.end_date]),h=n.useMemo(()=>c.map(f=>({id:f.id,title:f.title,milestone_percent:f.milestone_percent,is_postcard_milestone:f.is_postcard_milestone,completed_at:f.completed_at,description:f.description,phase_name:f.phase_name,target_date:f.target_date,chapter_number:f.chapter_number})),[c]);return e.jsxs(ur,{open:a,onOpenChange:i,shouldScaleBackground:!1,handleOnly:!0,children:[e.jsx(ho,{asChild:!0,children:r}),e.jsxs(mr,{className:"max-h-[85vh]",children:[e.jsxs(pr,{className:"pb-2",children:[e.jsxs(hr,{className:"flex items-center gap-2",children:[e.jsx(At,{className:"w-5 h-5 text-primary"}),s.title]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"font-bold text-primary",children:[Math.round(s.progress_percentage),"% Complete"]}),e.jsxs("span",{className:"text-muted-foreground flex items-center gap-1",children:[e.jsx(Gt,{className:"w-3.5 h-3.5 text-orange-500"}),p,"d left"]})]}),e.jsx(Hs,{value:s.progress_percentage,className:"h-2"})]})]}),e.jsxs("div",{className:"flex-1 px-4 pb-6 max-h-[60vh] overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},"data-vaul-no-drag":!0,children:[e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mb-4",children:e.jsxs("div",{className:"rounded-xl overflow-hidden border border-border/30 bg-card/30 backdrop-blur-sm",children:[e.jsxs("div",{className:"relative h-56 w-full overflow-hidden",children:[o&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:o,alt:"Your journey path",className:"absolute inset-0 w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background/80 via-background/30 to-transparent"})]}),e.jsx(j_,{progress:s.progress_percentage,targetDays:s.target_days,companionImageUrl:m?.current_image_url,companionMood:m?.current_mood,showCompanion:!0,milestones:h,transparentBackground:!!o,className:"absolute inset-0"})]}),l&&!o&&e.jsx("div",{className:"h-56 flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx(pe,{className:"w-8 h-8 text-primary/50 mx-auto animate-pulse"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Loading journey path..."})]})})]})}),e.jsxs("div",{className:"flex items-center justify-center gap-6 mb-6 text-sm text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(St,{className:"w-4 h-4 text-purple-400"}),e.jsxs("span",{children:[d," milestones"]})]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx($t,{className:"w-4 h-4 text-sky-400"}),e.jsxs("span",{children:[s.target_days,"d journey"]})]})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(M_,{epicId:s.id,epicTitle:s.title,epicGoal:s.description,currentDeadline:s.end_date,children:e.jsxs(U,{variant:"outline",className:"gap-2",children:[e.jsx(da,{className:"w-4 h-4"}),"View Milestones"]})})})]})]})]})}),D_=t=>{const[s,r]=t.split(":"),a=parseInt(s),i=a>=12?"p":"a";return`${a%12||12}:${r}${i}`};function Ni({time:t,overrideTime:s,label:r,rowKind:a="task",tone:i="default",durationMinutes:o,laneIndex:l=0,laneCount:c=1,overlapCount:d=0,showLine:m=!0,isLast:p=!1,isDragTarget:h=!1,className:f,children:u,...g}){const y=s??t,b=s!=null,v=i==="now",x=a==="task",w=a==="marker",j=x&&!!y;return e.jsxs("div",{className:A("relative flex gap-2",h&&"rounded-lg",f),"data-timeline-lane":j?l:void 0,"data-timeline-lane-count":j?c:void 0,"data-timeline-overlap":j?d:void 0,...g,children:[e.jsx("div",{className:A("w-9 flex-shrink-0 text-left",w?"pt-[8px]":"pt-[22px]"),children:y?e.jsx("span",{className:A(w?"text-[9px]":"text-[10px]","font-medium leading-none transition-colors",v?"font-semibold text-stardust-gold":b?"text-primary font-bold":"text-muted-foreground"),children:D_(y)}):r?e.jsx("span",{className:"text-[9px] font-semibold uppercase tracking-wide text-muted-foreground/80",children:r}):null}),e.jsx("div",{className:A("flex-1 min-w-0",w?"py-0":"py-1"),children:u})]})}const P_=({percent:t,size:s=32,strokeWidth:r=3,className:a,showLabel:i=!1})=>{const o=(s-r)/2,l=o*2*Math.PI,c=l-t/100*l,d=()=>t===100?"hsl(var(--chart-2))":t>=50?"hsl(var(--chart-4))":"hsl(var(--primary))";return e.jsxs("div",{className:A("relative inline-flex items-center justify-center",a),children:[e.jsxs("svg",{width:s,height:s,className:"transform -rotate-90",children:[e.jsx("circle",{cx:s/2,cy:s/2,r:o,fill:"none",stroke:"hsl(var(--muted))",strokeWidth:r}),e.jsx("circle",{cx:s/2,cy:s/2,r:o,fill:"none",stroke:d(),strokeWidth:r,strokeDasharray:l,strokeDashoffset:c,strokeLinecap:"round",className:"transition-all duration-300 ease-out"})]}),i&&e.jsxs("span",{className:"absolute text-xs font-medium",children:[t,"%"]})]})},A_=30,Ui=t=>Number.isFinite(t.estimated_duration)&&(t.estimated_duration??0)>0?Number(t.estimated_duration):A_,zi=t=>{const s=$n(t);return s?s.hour*60+s.minute:null},R_=(t,s)=>{const r=[];for(const a of t){const i=a.scheduled_time,o=zi(i);o!==null&&r.push({id:a.id,startMinutes:o,endMinutes:o+Ui(a)})}return r.sort((a,i)=>a.startMinutes-i.startMinutes)},I_=(t,s)=>{const r=R_(t);if(r.length<2)return[];const a=[];for(let i=0;i<r.length-1;i+=1){const o=r[i];for(let l=i+1;l<r.length;l+=1){const c=r[l];if(c.startMinutes>=o.endMinutes)break;const d=Math.min(o.endMinutes,c.endMinutes)-c.startMinutes;d<=0||a.push({taskAId:o.id,taskBId:c.id,overlapMinutes:d})}}return a},L_=(t,s)=>{const r=I_(t),a=new Map;for(const i of r)a.has(i.taskAId)||a.set(i.taskAId,new Set),a.has(i.taskBId)||a.set(i.taskBId,new Set),a.get(i.taskAId)?.add(i.taskBId),a.get(i.taskBId)?.add(i.taskAId);return a},Ym=(t,s,r)=>{const a=s.find(m=>m.id===t);if(!a)return new Set;const i=r?.[t],o=i!==void 0?i:a.scheduled_time,l=zi(o);if(l===null)return new Set;const c=l+Ui(a),d=new Set;for(const m of s){if(m.id===t)continue;const p=r?.[m.id],h=p!==void 0?p:m.scheduled_time,f=zi(h);if(f===null)continue;const u=f+Ui(m);Math.min(c,u)-Math.max(l,f)>0&&d.add(m.id)}return d},q_=30,O_=t=>!Number.isFinite(t.estimated_duration)||(t.estimated_duration??0)<=0?q_:Number(t.estimated_duration),F_=t=>{const s=$n(t);return s?s.hour*60+s.minute:null},$_=(t,s)=>t.map(r=>{const a=r.scheduled_time,i=F_(a);if(i===null)return null;const o=O_(r);return{...r,startMinute:i,endMinute:i+o}}).filter(r=>r!==null).sort((r,a)=>r.startMinute!==a.startMinute?r.startMinute-a.startMinute:r.endMinute!==a.endMinute?r.endMinute-a.endMinute:r.id.localeCompare(a.id)),H_=(t,s)=>{const r=$_(t),a=new Map;if(r.length===0)return{orderedTaskIds:[],byTaskId:a};const i=[],o=[];let l=[],c=0,d=null;const m=()=>{if(l.length!==0){for(const p of l){const h=a.get(p);h&&(h.laneCount=Math.max(h.laneCount,c),a.set(p,h))}l=[],c=0}};for(const p of r){for(let y=i.length-1;y>=0;y-=1)i[y].endMinute<=p.startMinute&&i.splice(y,1);i.length===0&&m();const h=new Set(i.map(y=>y.laneIndex));let f=0;for(;h.has(f);)f+=1;i.push({id:p.id,endMinute:p.endMinute,laneIndex:f}),l.push(p.id),c=Math.max(c,i.length),o.push(p.id);const u=Ym(p.id,t,s).size,g=d===null?0:Math.max(0,p.startMinute-d);d=p.startMinute,a.set(p.id,{id:p.id,startMinute:p.startMinute,endMinute:p.endMinute,laneIndex:f,laneCount:1,overlapCount:u,gapBeforeMinutes:g})}return m(),{orderedTaskIds:o,byTaskId:a}},Vl=t=>{if(!t)return null;try{const s=new Date(t);return Number.isNaN(s.getTime())?null:Math.max(0,qt(s,new Date))}catch{return null}},B_=(t,s,r="")=>{try{return Number.isNaN(t.getTime())?r:te(t,s)}catch{return r}},U_=(t,s,r,a)=>t&&t.map(i=>i.id!==s||!i.subtasks?i:{...i,subtasks:i.subtasks.map(o=>o.id===r?{...o,completed:a}:o)}),z_=t=>{const[s,r]=t.split(":"),a=parseInt(s),i=a>=12?"PM":"AM";return`${a%12||12}:${r} ${i}`},Xl=8e3,Q_=360,sr=1439,rr=180,kr=.2,Nr=1,K_=10,Jl=.45,Vm=104,W_=8,G_=10,Y_=4,V_=180,Qi=.5,X_=24,J_=72,Z_=140,ej=180,tj=140,sj=100,rj=75,Ki=1,aj=1,nj=2,ij=3,oj=t=>!Number.isFinite(t)||t<=Qi?null:t<=X_?{repeatMs:ej,stepMultiplier:Ki}:t<=J_?{repeatMs:tj,stepMultiplier:aj}:t<=Z_?{repeatMs:sj,stepMultiplier:nj}:{repeatMs:rj,stepMultiplier:ij},Zl=()=>{if(typeof window>"u"||typeof document>"u")return Vm;const t=document.createElement("div");t.style.position="fixed",t.style.visibility="hidden",t.style.pointerEvents="none",t.style.top="0",t.style.left="0",t.style.height="var(--bottom-nav-safe-offset)",document.body.appendChild(t);const s=t.getBoundingClientRect().height;if(t.remove(),Number.isFinite(s)&&s>0)return s;const r=Number.parseFloat(window.getComputedStyle(document.documentElement).fontSize||"16");return(Number.isFinite(r)&&r>0?r:16)*6.5},wr=t=>{if(!t)return null;const[s,r]=t.split(":").map(Number);return!Number.isFinite(s)||!Number.isFinite(r)?null:s*60+r},Wi=t=>{const s=Math.max(0,Math.min(1439,Math.round(t))),r=Math.floor(s/60),a=s%60;return`${String(r).padStart(2,"0")}:${String(a).padStart(2,"0")}`},lj=t=>Wi(t).replace(":",""),cj=t=>Math.max(0,Math.min(1,t)),dj=(t,s)=>(t%s+s)%s,ec=(t,s)=>s>0?t*K_:0,uj=(t,s)=>{if(s-t<=1)return[];const r=Math.ceil((t+1)/60)*60,a=[];for(let i=r;i<s;i+=60)i<=sr&&a.push(i);return a},Xm=(t,s)=>{if(t.length===0)return null;let r=t[0],a=Math.abs(r-s);for(let i=1;i<t.length;i+=1){const o=t[i],l=Math.abs(o-s);if(l<a){r=o,a=l;continue}l===a&&o<r&&(r=o)}return r},mj=(t,s)=>{if(s-t<60)return null;const a=(t+s)/2,i=uj(t,s);return Xm(i,a)},pj=(t,s)=>{for(let r=1;r<s.length;r+=1){const a=s[r-1],i=s[r];if(a<t&&t<i)return!0}return!1},hj=(t,s)=>{const r=[...t].sort((i,o)=>i-o),a=new Set([s]);if(r.length===0)return Array.from(a).sort((i,o)=>i-o);for(const i of r){const o=dj(i,rr),l=o===0,c=l?i-rr:i-o,d=l?i+rr:c+rr;c>=0&&c<=sr&&a.add(c),d>=0&&d<=sr&&a.add(d)}if(r.length>1){for(const i of Array.from(a))i!==s&&pj(i,r)&&a.delete(i);for(let i=1;i<r.length;i+=1){const o=r[i-1],l=r[i],c=mj(o,l);c!==null&&a.add(c)}}return Array.from(a).sort((i,o)=>i-o)},fj=(t,s)=>{if(s.length<2)return t;for(let r=1;r<s.length;r+=1){const a=s[r-1],i=s[r],o=Array.from(t.values()).filter(d=>a<d.minute&&d.minute<i).sort((d,m)=>d.minute-m.minute);if(o.length<=1)continue;if(o.find(d=>d.kind==="now")){for(const d of o)d.kind==="placeholder"&&t.delete(d.minute);continue}const c=Xm(o.filter(d=>d.kind==="placeholder").map(d=>d.minute),(a+i)/2);if(c!==null)for(const d of o)d.kind==="placeholder"&&d.minute!==c&&t.delete(d.minute)}return t},gj=(t,s)=>{const r=new Map;for(const p of t)r.set(p,kr);if(t.length===0)return r;if(t.length===1)return r.set(t[0],Nr),r;const a=t[0],i=t[t.length-1];if(s<=a)return r.set(a,Nr),r;if(s>=i)return r.set(i,Nr),r;const o=t.findIndex(p=>p>=s);if(o<=0)return r.set(a,Nr),r;const l=t[o-1],c=t[o],d=cj((s-l)/(c-l)),m=Nr-kr;return r.set(l,kr+(1-d)*m),r.set(c,kr+d*m),r},xj=n.memo(function({tasks:s,selectedDate:r,isVisible:a=!0,onToggle:i,onAddQuest:o,completedCount:l,totalCount:c,currentStreak:d=0,onUndoToggle:m,onEditQuest:p,calendarTasks:h=[],calendarMilestones:f=[],onDateSelect:u,activeEpics:g=[],onDeleteQuest:y,onMoveQuestToNextDay:b,onUpdateScheduledTime:v,onTimeSlotLongPress:x,onSendToCalendar:w,hasCalendarLink:j,onTimelineDragPreviewTimeChange:D}){const C=Ea(),{capabilities:_}=uo(),E=n.useMemo(()=>{if(typeof window>"u")return!1;const O=window.Capacitor;return!!(O?.isNativePlatform?.()&&O?.getPlatform?.()==="ios")},[])||!!C||!_.allowBackgroundAnimation,{profile:k}=Yt(),P=Ae(),T=k?.completed_tasks_stay_in_place??!0,I=le({mutationFn:async({taskId:O,subtaskId:de,completed:V})=>{const{error:se}=await S.from("subtasks").update({completed:V,completed_at:V?new Date().toISOString():null}).eq("id",de).eq("task_id",O);if(se)throw se},onMutate:async({taskId:O,subtaskId:de,completed:V})=>{await P.cancelQueries({queryKey:["daily-tasks"]});const se=P.getQueriesData({queryKey:["daily-tasks"]});return P.setQueriesData({queryKey:["daily-tasks"]},ze=>U_(ze,O,de,V)),{previousDailyTasks:se}},onError:(O,de,V)=>{V?.previousDailyTasks&&V.previousDailyTasks.forEach(([se,ze])=>{P.setQueryData(se,ze)})},onSettled:()=>{P.invalidateQueries({queryKey:["daily-tasks"]})}}),R=n.useRef(null),L=n.useRef(null),[$,q]=n.useState(null),F=n.useCallback(O=>{L.current=O,R.current=O},[]),[H,J]=n.useState(new Set),[G,re]=n.useState(!1),[ie,K]=n.useState("custom"),[xe,Te]=n.useState(new Set),[Ne,B]=n.useState(new Set),[z,Q]=n.useState(new Set),[Y,ue]=n.useState(0),[fe,De]=n.useState(!1),Ce=n.useRef(null),Be=n.useRef(null),qe=n.useRef(null);n.useEffect(()=>{B(O=>{const de=s.filter(se=>se.completed).map(se=>se.id),V=new Set(O);return de.forEach(se=>V.delete(se)),V.size!==O.size?V:O})},[s]);const he=n.useCallback(()=>{Be.current!==null&&window.clearTimeout(Be.current),Be.current=window.setTimeout(()=>{ue(0),De(!1),Ce.current=null,Be.current=null},Xl)},[]),ye=n.useCallback(()=>{const O=Date.now(),V=Ce.current!==null&&O-Ce.current<=Xl?Y+1:1;ue(V),Ce.current=O,he(),V>1&&(De(!0),window.setTimeout(()=>{De(!1)},E?600:1e3))},[Y,he,E]),Ue=n.useCallback(()=>{Be.current!==null&&(window.clearTimeout(Be.current),Be.current=null),ue(0),De(!1),Ce.current=null},[]);n.useEffect(()=>()=>{Be.current!==null&&window.clearTimeout(Be.current)},[]),n.useEffect(()=>{Ue()},[r,Ue]);const Re=O=>{switch(O){case"high":return 0;case"medium":return 1;case"low":return 2;default:return 3}},{ritualTasks:Ie,questTasks:ee}=n.useMemo(()=>{const O=s.filter(se=>!!se.habit_source_id),de=s.filter(se=>!se.habit_source_id),V=se=>{let ze=[...se].sort((Qe,$e)=>{switch(ie){case"time":return Qe.scheduled_time&&$e.scheduled_time?Qe.scheduled_time.localeCompare($e.scheduled_time):Qe.scheduled_time?-1:$e.scheduled_time?1:0;case"priority":return Re(Qe.priority)-Re($e.priority);case"xp":return $e.xp_reward-Qe.xp_reward;default:{const tt=Qe.sort_order??9999,gt=$e.sort_order??9999;return tt!==gt?tt-gt:Qe.scheduled_time&&$e.scheduled_time?Qe.scheduled_time.localeCompare($e.scheduled_time):Qe.scheduled_time?-1:$e.scheduled_time?1:Qe.id.localeCompare($e.id)}}});if(!T){const Qe=ze.filter(tt=>!tt.completed),$e=ze.filter(tt=>tt.completed);ze=[...Qe,...$e]}return ze};return{ritualTasks:V(O),questTasks:V(de)}},[s,ie,T]),ne=n.useMemo(()=>ee.filter(O=>!!O.scheduled_time).sort((O,de)=>(O.scheduled_time||"").localeCompare(de.scheduled_time||"")),[ee]),X=n.useMemo(()=>ee.filter(O=>!O.scheduled_time),[ee]),ae=n.useMemo(()=>[...ne,...X],[ne,X]),Se=n.useMemo(()=>[...ae,...Ie],[ae,Ie]),ve=s_({containerRef:R,snapConfig:Kw,onDrop:(O,de)=>{const V=Ym(O,Se,{[O]:de}).size;v?.(O,de),V>0&&W(`Overlap: ${V} quest${V===1?"":"s"}`)}}),_e=ve.dragVisualOffsetY??ve.dragOffsetY,Me=ve.dragEdgeOffsetY??_e,et=n.useRef(new Map),[Je,lt]=n.useState(null),dt=Di(0),Mt=n.useRef(Vm),vt=n.useRef(0),Rt=n.useRef(null),me=n.useRef(Ki),Le=n.useRef(null),Xe=n.useRef(null),pt=n.useRef(!1),[ce,Oe]=n.useState(()=>wr(te(new Date,"HH:mm"))??0),Ke=wa(r,new Date),ct=n.useRef(null),ut=n.useRef(null),Dt=n.useRef(a),kt=n.useRef(Ke),is=n.useRef(!1);n.useEffect(()=>{const O=ve.isDragging?ve.previewTime??null:null;ct.current!==O&&(ct.current=O,D?.(O))},[D,ve.isDragging,ve.previewTime]),n.useEffect(()=>()=>{D?.(null)},[D]);const bs=n.useCallback(()=>{Le.current!==null&&(window.clearTimeout(Le.current),Le.current=null)},[]),Jt=n.useCallback(()=>{Xe.current!==null&&(window.clearInterval(Xe.current),Xe.current=null)},[]),It=n.useCallback(()=>{vt.current=0,Rt.current=null,me.current=Ki,pt.current=!1,bs(),Jt()},[bs,Jt]),As=n.useCallback((O,de,V)=>{Jt(),me.current=Math.max(1,V),pt.current=!0,Xe.current=window.setInterval(()=>{if(!ve.isDragging||vt.current!==O){pt.current=!1,Jt();return}const se=Math.max(1,me.current);for(let ze=0;ze<se;ze+=1)if(!ve.nudgeByFineStep(O)){pt.current=!1,Jt();return}},de)},[Jt,ve.isDragging,ve.nudgeByFineStep]),Us=n.useCallback((O,de)=>{if(!ve.isDragging||O===0||de===null){It();return}const V=de.repeatMs,se=de.stepMultiplier,ze=vt.current,Qe=Rt.current,$e=me.current,tt=ze!==O,gt=Qe!==V,Ve=$e!==se;if(vt.current=O,Rt.current=V,me.current=se,tt){pt.current=!1,bs(),Jt(),Le.current=window.setTimeout(()=>{if(Le.current=null,!ve.isDragging||vt.current!==O)return;const wt=Rt.current;if(wt===null){It();return}const os=Math.max(1,me.current);As(O,wt,os)},V_);return}pt.current&&(gt||Ve)&&As(O,V,se)},[bs,Jt,As,It,ve.isDragging]);n.useLayoutEffect(()=>{if(!ve.draggingTaskId){lt(null),dt.set(0);return}let O=null;const de=()=>{const V=et.current.get(ve.draggingTaskId);if(!V)return!1;const se=V.getBoundingClientRect(),ze=se.width>0?se.width:V.clientWidth||V.offsetWidth||1,Qe=se.height>0?se.height:V.clientHeight||V.offsetHeight||1;return lt({taskId:ve.draggingTaskId,top:se.top,left:se.left,width:ze,height:Qe}),Mt.current=Zl(),!0};return!de()&&typeof window<"u"&&(O=window.requestAnimationFrame(()=>{de()})),()=>{O!==null&&typeof window<"u"&&window.cancelAnimationFrame(O)}},[dt,ve.draggingTaskId]),n.useEffect(()=>{if(!ve.isDragging||!Je){dt.set(0),It();return}const O=($e,tt)=>{const gt=window.visualViewport,Ve=gt?.height??window.innerHeight,wt=gt?.offsetTop??0,os=wt+Ve,Lt=L.current?.getBoundingClientRect(),ws=document.querySelector('nav[aria-label="Main navigation"]')?.getBoundingClientRect(),Js=!!Lt&&Number.isFinite(Lt.top)&&Number.isFinite(Lt.bottom)&&Lt.bottom>Lt.top+1,fr=!!ws&&Number.isFinite(ws.top)&&Number.isFinite(ws.bottom)&&ws.bottom>ws.top,Xr=Js?Lt.top:wt,He=Js?Lt.bottom:os,_t=os-Mt.current-Je.height,Zt=He-Je.height-G_,Jr=fr?ws.top-Je.height-Y_:null,Zr=Math.max(wt,Xr)+W_,$a=Jr!==null?Math.min(Jr,_t):Js?Zt:_t,Ha=Math.max(Zr,$a),Ba=Zr-Je.top,Ua=Ha-Je.top,zp=Math.max(Ba,Math.min(Ua,$e));dt.set(zp);const Qp=Math.max(Ba,Math.min(Ua,tt)),Wn=tt-Qp,Kp=Wn>Qi?1:Wn<-Qi?-1:0,Wp=oj(Math.abs(Wn));Us(Kp,Wp)};O(_e.get(),Me.get());const de=_e.on("change",$e=>{O($e,Me.get())}),V=Me===_e?null:Me.on("change",$e=>{O(_e.get(),$e)}),se=()=>O(_e.get(),Me.get());window.addEventListener("resize",se);const ze=window.visualViewport,Qe=!!ze&&typeof ze.addEventListener=="function"&&typeof ze.removeEventListener=="function";return Qe&&(ze.addEventListener("resize",se),ze.addEventListener("scroll",se)),()=>{de(),V?.(),It(),window.removeEventListener("resize",se),Qe&&(ze.removeEventListener("resize",se),ze.removeEventListener("scroll",se))}},[Me,dt,Je,_e,It,Us,ve.isDragging]),n.useEffect(()=>{ve.isDragging||It()},[It,ve.isDragging]),n.useEffect(()=>()=>{It()},[It]),n.useEffect(()=>{if(!Ke)return;const O=()=>{const V=wr(te(new Date,"HH:mm"))??0;Oe(V)};O();const de=window.setInterval(O,6e4);return()=>window.clearInterval(de)},[Ke,r]);const ge=n.useMemo(()=>H_(ne),[ne]),it=n.useMemo(()=>new Map(ne.map(O=>[O.id,O])),[ne]),xt=n.useMemo(()=>{if(ge.orderedTaskIds.length===0)return ne;const O=[];for(const de of ge.orderedTaskIds){const V=it.get(de);V&&O.push(V)}return O.length>0?O:ne},[ge.orderedTaskIds,ne,it]),st=n.useMemo(()=>{const O=Ke,V=[...ne.map(Ve=>wr(Ve.scheduled_time)).filter(Ve=>Ve!==null)].sort((Ve,wt)=>Ve-wt),se=V.length>0?V[0]:Q_;let ze=hj(V,se);V.length>0&&(ze=ze.filter(Ve=>Ve>se));const Qe=Math.max(se,Math.min(sr,ce));if(O&&V.length===0){const Ve=Math.floor(Qe/rr)*rr,wt=Ve+rr;Ve>=se&&Ve<=sr&&ze.push(Ve),wt>=se&&wt<=sr&&ze.push(wt)}const $e=Array.from(new Set(ze)).sort((Ve,wt)=>Ve-wt),tt=O?gj($e,ce):new Map($e.map(Ve=>[Ve,kr])),gt=new Map;for(const Ve of $e)gt.set(Ve,{id:`timeline-marker-placeholder-${lj(Ve)}`,minute:Ve,time:Wi(Ve),kind:"placeholder",emphasis:tt.get(Ve)??kr});if(O){const Ve=Math.max(0,Math.min(sr,ce));gt.set(Ve,{id:"timeline-marker-now",minute:Ve,time:Wi(Ve),kind:"now",emphasis:Nr})}return Array.from(fj(gt,V).values())},[Ke,ce,ne]),Bt=n.useMemo(()=>[...st.map(de=>({kind:"marker",marker:de,minute:de.minute,sortKey:`0-${de.minute}-${de.id}`})),...xt.map(de=>{const V=wr(de.scheduled_time);return V===null?null:{kind:"task",task:de,minute:V,sortKey:`1-${V}-${de.id}`}}).filter(de=>!!de)].sort((de,V)=>de.minute!==V.minute?de.minute-V.minute:de.sortKey.localeCompare(V.sortKey)).map(de=>de.kind==="marker"?{kind:"marker",marker:de.marker}:{kind:"task",task:de.task}),[xt,st]),Z=n.useMemo(()=>Bt.some(O=>O.kind==="marker"&&O.marker.kind==="now"),[Bt])&&s.length>0;n.useLayoutEffect(()=>{if(typeof window>"u")return;const O=()=>{const ze=L.current;if(!ze){q(null);return}const Qe=window.visualViewport?.height??window.innerHeight,$e=Zl(),tt=Math.floor(Qe-ze.getBoundingClientRect().top-$e);Number.isFinite(tt)&&q(Math.max(120,tt))},de=window.requestAnimationFrame(O);O(),window.addEventListener("resize",O);const V=window.visualViewport,se=!!V&&typeof V.addEventListener=="function"&&typeof V.removeEventListener=="function";return se&&(V.addEventListener("resize",O),V.addEventListener("scroll",O)),()=>{window.cancelAnimationFrame(de),window.removeEventListener("resize",O),se&&(V.removeEventListener("resize",O),V.removeEventListener("scroll",O))}},[Y,Z,Ke,s.length,Bt.length]),n.useEffect(()=>{const O=Ke,de=a&&!Dt.current,V=O&&!kt.current,se=Z&&!is.current;if(a&&O&&Z&&!ve.isDragging&&(de||V||se)&&ut.current&&typeof window<"u"){const Qe=L.current;if(Qe&&Qe.scrollHeight>Qe.clientHeight+1){const $e=ut.current.getBoundingClientRect(),tt=Qe.getBoundingClientRect(),gt=$e.top-tt.top+$e.height/2,Ve=Qe.scrollTop+gt-Qe.clientHeight*Jl,wt=Math.max(0,Qe.scrollHeight-Qe.clientHeight);Qe.scrollTo({top:Math.max(0,Math.min(wt,Ve)),behavior:"smooth"})}else{const $e=ut.current.getBoundingClientRect(),tt=$e.top+$e.height/2,gt=Math.max(0,window.scrollY+tt-window.innerHeight*Jl);window.scrollTo({top:gt,behavior:"smooth"})}}Dt.current=a,kt.current=O,is.current=Z},[Z,Ke,a,ve.isDragging]);const ht=n.useMemo(()=>L_(Se),[Se]),Ye=n.useMemo(()=>ve.draggingTaskId?it.get(ve.draggingTaskId)??null:null,[it,ve.draggingTaskId]),yt=n.useMemo(()=>Ye?ge.byTaskId.get(Ye.id)??null:null,[Ye,ge.byTaskId]),zs=!!(ve.isDragging&&Je&&Ye&&Je.taskId===Ye.id),Ct=yt?ec(yt.laneIndex,yt.overlapCount):0,Fa=Ye?ht.get(Ye.id)?.size??0:0,Ut=n.useMemo(()=>{const O=[],de=new Map;for(const V of Ie){const se=V.epic_id;se&&(de.has(se)||de.set(se,[]),de.get(se).push(V))}for(const V of g){const se=de.get(V.id);!se||se.length===0||O.push({epicId:V.id,title:V.title,progress:Math.round(V.progress_percentage??0),daysLeft:Vl(V.end_date),rituals:se,completedCount:se.filter(ze=>!!ze.completed).length,epic:V})}return O},[Ie,g]);n.useEffect(()=>{Q(O=>{const de=new Set(O);let V=!1;for(const se of g)de.has(se.id)||(de.add(se.id),V=!0);return V?de:O})},[g]);const Fp=n.useCallback(O=>{Q(de=>{const V=new Set(de);return V.has(O)?V.delete(O):V.add(O),V})},[]),$p=s.reduce((O,de)=>{if(!de.completed)return O;const V=de.is_main_quest?Math.round(de.xp_reward*qi):de.xp_reward;return O+V},0),Hp=c>0?l/c*100:0,Bp=c>0&&l===c,To=async O=>{try{await fs.impact({style:O})}catch{}},Mo=n.useCallback(O=>!!(O.subtasks&&O.subtasks.length>0||O.notes||O.priority||O.energy_level||O.estimated_duration||O.is_recurring&&O.recurrence_pattern||O.difficulty||O.category),[]),Do=n.useCallback((O,de)=>{de.stopPropagation(),J(V=>{const se=new Set(V);return se.has(O)?se.delete(O):se.add(O),se})},[]),Up=O=>{switch(O){case"mind":return Ss;case"body":return Xi;case"soul":return Ws;default:return null}},Kn=n.useCallback((O,de,V=0)=>{const se=!!O.completed||Ne.has(O.id),ze=!!O.habit_source_id,Qe=O.is_main_quest?Math.round(O.xp_reward*qi):O.xp_reward,$e=de?.isDragging??!1,tt=de?.isPressed??!1,gt=de?.isActivated??!1,Ve=H.has(O.id),wt=Mo(O),os=Up(O.category),Lt=O.subtasks??[],ws=Lt.filter(He=>!!He.completed).length,Js=!!(os&&O.category||O.difficulty||O.priority||O.energy_level||O.estimated_duration||O.is_recurring&&O.recurrence_pattern),fr=He=>{if(He.stopPropagation(),$e||gt||tt){He.preventDefault();return}se&&m?(B(_t=>{const Zt=new Set(_t);return Zt.delete(O.id),Zt}),Ue(),To(Wt.Light),m(O.id,Qe)):(B(_t=>new Set(_t).add(O.id)),ye(),To(Wt.Medium),$g(),Te(_t=>new Set(_t).add(O.id)),setTimeout(()=>{Te(_t=>{const Zt=new Set(_t);return Zt.delete(O.id),Zt})},600),i(O.id,!se,Qe))};return e.jsxs(bo,{open:Ve,onOpenChange:()=>{},children:[e.jsxs("div",{className:A("flex items-center gap-3 transition-all relative group","select-none min-h-[46px]",ze?"py-3":"py-2",se&&"opacity-60",$e&&"cursor-grabbing",gt&&!$e&&"bg-muted/30 rounded-lg"),children:[e.jsx("div",{className:"relative ml-1 flex flex-col items-center self-start pt-0.5 gap-0",children:e.jsx("button",{"data-interactive":"true",onClick:fr,onTouchStart:He=>{qe.current={x:He.touches[0].clientX,y:He.touches[0].clientY}},onTouchEnd:He=>{if(He.preventDefault(),He.stopPropagation(),qe.current){const _t=Math.abs(He.changedTouches[0].clientX-qe.current.x),Zt=Math.abs(He.changedTouches[0].clientY-qe.current.y);_t<5&&Zt<5&&fr(He)}qe.current=null},className:A("relative flex items-center justify-center w-11 h-11 touch-manipulation transition-transform select-none","active:scale-95"),style:{WebkitTapHighlightColor:"transparent",touchAction:"manipulation"},"aria-label":se?"Mark task as incomplete":"Mark task as complete",role:"checkbox","aria-checked":se,children:E?e.jsx("div",{className:A("flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all",se?"bg-primary border-primary":"border-muted-foreground/40 hover:border-primary"),children:se&&e.jsx(Pt,{className:"w-4 h-4 text-primary-foreground"})}):e.jsx(M.div,{className:A("flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all",se?"bg-primary border-primary":"border-muted-foreground/40 hover:border-primary"),whileTap:!$e&&!tt?{scale:.85}:{},children:se&&e.jsx(M.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:25},children:e.jsx(Pt,{className:"w-4 h-4 text-primary-foreground"})})})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[ze&&e.jsx(Rr,{className:"w-4 h-4 text-accent flex-shrink-0"}),e.jsx(g_,{text:O.task_text,className:A("text-sm flex-1",se&&"text-muted-foreground",se&&(xe.has(O.id)?"animate-strikethrough":"line-through"))})]}),O.scheduled_time&&e.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1 mt-0.5",children:[e.jsx(Ft,{className:"w-3 h-3"}),z_(O.scheduled_time)]}),V>0&&e.jsxs("span",{className:"mt-1 inline-flex items-center rounded-full border border-primary/35 bg-primary/10 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-primary",children:["Overlaps: ",V]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!se&&!$e&&!gt&&(p||w||y||b)&&e.jsxs(Hl,{children:[e.jsx(Bl,{asChild:!0,children:e.jsx(U,{"data-interactive":"true","aria-label":"Quest actions",variant:"ghost",size:"icon",className:"h-9 w-9 -m-1.5 opacity-100 md:opacity-0 md:group-hover:opacity-100 md:group-focus-within:opacity-100 md:focus-visible:opacity-100 transition-opacity touch-manipulation",onClick:He=>He.stopPropagation(),children:e.jsx(Nf,{className:"w-4 h-4"})})}),e.jsxs(Hi,{align:"end",className:"w-44",children:[p&&e.jsxs(Rs,{onClick:He=>{He.stopPropagation(),p(O)},children:[e.jsx(wd,{className:"w-4 h-4 mr-2"}),"Edit quest"]}),w&&e.jsxs(Rs,{onClick:He=>{He.stopPropagation(),w(O.id)},children:[e.jsx(vd,{className:"w-4 h-4 mr-2"}),j?.(O.id)?"Re-send to calendar":"Send to calendar"]}),b&&!ze&&e.jsxs(Rs,{onClick:He=>{He.stopPropagation(),b(O.id)},children:[e.jsx(kf,{className:"w-4 h-4 mr-2"}),"Move to tomorrow"]}),y&&e.jsxs(Rs,{className:"text-destructive focus:text-destructive",onClick:He=>{He.stopPropagation(),y(O.id)},children:[e.jsx($s,{className:"w-4 h-4 mr-2"}),"Delete quest"]})]})]}),O.is_main_quest&&e.jsx(Fe,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 bg-primary/10 border-primary/30",children:"Main"}),e.jsxs("span",{className:"text-sm font-bold text-stardust-gold/80",children:["+",Qe]}),wt&&e.jsx(U,{"data-interactive":"true",variant:"ghost",size:"icon",className:"h-7 w-7 -m-1 flex-shrink-0",onClick:He=>Do(O.id,He),children:e.jsx(Os,{className:A("w-4 h-4 text-muted-foreground transition-transform duration-200",Ve&&"rotate-180")})})]})]}),e.jsx(Hn,{children:e.jsxs("div",{className:"pl-8 pr-2 pb-2 space-y-2",children:[Lt.length>0&&e.jsxs("div",{className:"space-y-1.5 rounded-md border border-border/40 bg-muted/20 p-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-[11px] font-medium uppercase tracking-wide text-muted-foreground",children:"Subtasks"}),e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:[ws,"/",Lt.length]})]}),e.jsx("div",{className:"space-y-1",children:Lt.map(He=>e.jsxs("label",{className:"flex items-center gap-2 rounded-sm px-1 py-1 text-xs",children:[e.jsx(lr,{checked:!!He.completed,onCheckedChange:_t=>{I.mutate({taskId:O.id,subtaskId:He.id,completed:!!_t})},onClick:_t=>_t.stopPropagation(),className:"h-3.5 w-3.5"}),e.jsx("span",{className:A("text-xs",He.completed&&"text-muted-foreground line-through"),children:He.title})]},He.id))})]}),O.notes&&(E?e.jsxs("div",{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(ya,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-xs leading-relaxed whitespace-pre-line",children:Ri(O.notes)})]}):e.jsxs(M.div,{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(ya,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-xs leading-relaxed whitespace-pre-line",children:Ri(O.notes)})]})),Js&&e.jsxs("div",{className:"flex flex-wrap gap-1.5",children:[os&&O.category&&e.jsxs(Fe,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 gap-1 border-muted-foreground/30",children:[e.jsx(os,{className:"w-3 h-3"}),O.category]}),O.difficulty&&e.jsx(Fe,{variant:"outline",className:A("text-xs px-1.5 py-0.5 h-5",O.difficulty==="easy"&&"bg-green-500/10 text-green-500 border-green-500/30",O.difficulty==="medium"&&"bg-yellow-500/10 text-yellow-500 border-yellow-500/30",O.difficulty==="hard"&&"bg-red-500/10 text-red-500 border-red-500/30"),children:O.difficulty}),O.priority&&e.jsxs(Fe,{variant:"outline",className:A("text-xs px-1.5 py-0.5 h-5",O.priority==="high"&&"bg-red-500/10 text-red-500 border-red-500/30",O.priority==="medium"&&"bg-yellow-500/10 text-yellow-500 border-yellow-500/30",O.priority==="low"&&"bg-blue-500/10 text-blue-500 border-blue-500/30"),children:[O.priority," priority"]}),O.energy_level&&e.jsxs(Fe,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 gap-1 border-muted-foreground/30",children:[e.jsx(ft,{className:"w-3 h-3"}),hs(O.energy_level)]}),O.estimated_duration&&e.jsxs(Fe,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 gap-1 border-muted-foreground/30",children:[e.jsx(Tn,{className:"w-3 h-3"}),O.estimated_duration,"m"]}),O.is_recurring&&O.recurrence_pattern&&e.jsxs(Fe,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 gap-1 bg-accent/10 text-accent border-accent/30",children:[e.jsx(Rr,{className:"w-3 h-3"}),hs(O.recurrence_pattern)]})]})]})})]})},[i,m,p,w,j,y,b,H,Mo,Do,xe,Ne,I,E,ye,Ue]);return e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"relative px-2 py-2 overflow-visible",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>re(!0),className:"flex items-center gap-1.5 hover:opacity-80 transition-opacity",children:e.jsx("span",{className:"text-lg font-bold",children:B_(r,"MMM d, yyyy","Invalid date")})}),d>0&&e.jsxs("div",{className:A("flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",d>=30?"bg-stardust-gold/20 text-stardust-gold":d>=14?"bg-celestial-blue/20 text-celestial-blue":"bg-orange-500/10 text-orange-400"),children:[e.jsx(Gt,{className:"h-3.5 w-3.5"}),d]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[c>0&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(P_,{percent:Hp,size:24,strokeWidth:2.5}),e.jsxs("span",{className:"text-xs font-medium text-muted-foreground",children:[l,"/",c]})]}),e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx($c,{className:A("h-4 w-4",Bp?"text-stardust-gold":"text-stardust-gold/70")}),e.jsx("span",{className:"font-semibold text-stardust-gold",children:$p})]})]})]}),e.jsx(Pe,{children:Y>1&&e.jsxs(M.div,{initial:E?{opacity:1}:{opacity:0,y:8,scale:.96},animate:{opacity:1,y:0,scale:1},exit:E?{opacity:0}:{opacity:0,y:-6,scale:.98},transition:{duration:E?.1:.24},className:A("mb-3 relative overflow-hidden rounded-xl border px-3 py-2","bg-gradient-to-r from-stardust-gold/12 via-primary/10 to-stardust-gold/12 border-stardust-gold/30",fe&&!E&&"animate-combo-pop"),"data-testid":"combo-banner",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Gt,{className:"w-4 h-4 text-stardust-gold"}),e.jsxs("span",{className:"text-sm font-semibold text-stardust-gold",children:["Combo x",Y]})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Keep completing quests"})]}),!E&&fe&&e.jsxs("div",{className:"pointer-events-none absolute inset-0",children:[e.jsx("span",{className:"absolute left-4 top-2 h-1.5 w-1.5 rounded-full bg-stardust-gold animate-combo-particle"}),e.jsx("span",{className:"absolute left-1/2 top-1 h-1 w-1 rounded-full bg-primary animate-combo-particle [animation-delay:120ms]"}),e.jsx("span",{className:"absolute right-5 bottom-2 h-1.5 w-1.5 rounded-full bg-celestial-blue animate-combo-particle [animation-delay:200ms]"})]})]},"combo-banner")}),s.length===0?e.jsxs("div",{className:"text-center py-6",children:[e.jsx(En,{className:"w-10 h-10 mx-auto text-muted-foreground/30 mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"No tasks for this day"}),e.jsxs("p",{className:"text-xs text-muted-foreground/70",children:["Tap ",e.jsx(xa,{className:"w-3 h-3 inline"})," to add your first quest"]}),e.jsxs(U,{variant:"outline",size:"sm",className:"mt-3",onClick:o,children:[e.jsx(xa,{className:"w-3 h-3 mr-1.5"}),"Add Quest"]})]}):e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:s.length>0&&e.jsxs(Hl,{children:[e.jsx(Bl,{asChild:!0,children:e.jsx("button",{className:"p-1 rounded opacity-40 hover:opacity-70 transition-opacity flex-shrink-0",children:e.jsx(Sf,{className:"w-3 h-3"})})}),e.jsxs(Hi,{align:"start",className:"w-28",children:[e.jsx(Rs,{onClick:()=>K("custom"),className:A("text-xs",ie==="custom"&&"bg-accent/10"),children:"Custom"}),e.jsx(Rs,{onClick:()=>K("time"),className:A("text-xs",ie==="time"&&"bg-accent/10"),children:"Time"}),e.jsx(Rs,{onClick:()=>K("priority"),className:A("text-xs",ie==="priority"&&"bg-accent/10"),children:"Priority"}),e.jsx(Rs,{onClick:()=>K("xp"),className:A("text-xs",ie==="xp"&&"bg-accent/10"),children:"XP"})]})]})}),Bt.length>0&&e.jsx("div",{children:e.jsx("div",{ref:F,className:"overflow-y-auto overscroll-contain pr-1",style:$?{maxHeight:`${$}px`}:void 0,"data-testid":"scheduled-timeline-pane",children:Bt.map((O,de)=>{if(O.kind==="marker"){const He=O.marker,_t=de>0?Bt[de-1]:null,Zt=de<Bt.length-1?Bt[de+1]:null,Jr=_t?.kind==="task"?wr(_t.task.scheduled_time):null,Zr=Zt?.kind==="task"?wr(Zt.task.scheduled_time):null,$a=Jr!==null&&Zr!==null&&Jr<He.minute&&He.minute<Zr,Ha=He.kind==="placeholder"?.72+He.emphasis*.28:1,Ba=He.kind==="placeholder"?.25+He.emphasis*.65:1,Ua=$a?`translateY(-50%) scale(${Ha})`:`scale(${Ha})`;return e.jsx("div",{className:A("pointer-events-none select-none",$a&&"h-0 overflow-visible"),"data-testid":He.id,children:e.jsx("div",{ref:He.kind==="now"?ut:void 0,style:{opacity:Ba,transform:Ua,transformOrigin:"left center"},children:e.jsx(Ni,{rowKind:"marker",time:He.time,tone:He.kind==="now"?"now":"default",showLine:de>0,isLast:de===Bt.length-1,children:e.jsx("div",{className:"h-px"})})})},He.id)}const V=O.task,se=ve.draggingTaskId===V.id,ze=ve.isDragging,Qe=ve.justDroppedId===V.id,$e=se&&zs,tt=ge.byTaskId.get(V.id),gt=tt?.laneIndex,Ve=tt?.laneCount,wt=tt?ec(tt.laneIndex,tt.overlapCount):0,os=V.scheduled_time&&!V.completed?ve.getRowDragProps(V.id,V.scheduled_time):void 0,Lt=!!os,ws=ht.get(V.id)?.size??0,Js={WebkitUserSelect:"none",userSelect:"none",WebkitTouchCallout:"none",touchAction:se&&!$e?"none":"pan-y",pointerEvents:ze&&!se?"none":"auto",opacity:$e?0:ze&&!se?.7:1,boxShadow:se&&!$e?"0 15px 30px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -4px rgba(0, 0, 0, 0.15)":"none",backgroundColor:se&&!$e?"hsl(var(--background))":"transparent",borderRadius:se&&!$e?12:0,transition:"none",willChange:se&&!$e?"transform":void 0},fr=e.jsx(Ni,{rowKind:"task",time:V.scheduled_time,overrideTime:se?ve.previewTime:void 0,showLine:de>0,isLast:de===Bt.length-1,isDragTarget:se,durationMinutes:V.estimated_duration,laneIndex:gt,laneCount:Ve,overlapCount:tt?.overlapCount,className:A(Lt&&!se&&"cursor-grab active:cursor-grabbing",se&&"cursor-grabbing"),"data-testid":`timeline-row-${V.id}`,...os,children:Kn(V,void 0,ws)}),Xr=!E&&Qe&&!se?{scale:[1,1.02,.98,1],y:[0,-2,1,0]}:void 0;return e.jsx(M.div,{ref:He=>{He?et.current.set(V.id,He):et.current.delete(V.id)},className:A("relative",se&&!$e&&"z-50"),layout:!se||$e,animate:Xr,transition:Xr?{duration:.25,ease:[.25,.1,.25,1],layout:{type:"spring",stiffness:420,damping:34,mass:.7}}:{layout:{type:"spring",stiffness:420,damping:34,mass:.7}},"data-timeline-lane":gt,"data-timeline-lane-count":Ve,"data-timeline-overlap":tt?.overlapCount,style:{...Js,x:wt,y:se&&!$e?_e:0},children:fr},V.id)})})})]}),Ut.length>0&&e.jsxs("div",{className:"mt-6 pt-4 border-t border-border/30",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"w-9 flex-shrink-0"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs font-medium text-muted-foreground uppercase tracking-wide",children:[e.jsx(At,{className:"h-3 w-3"}),"Campaigns"]}),e.jsx("div",{className:"flex-1 border-t border-dashed border-border/40"})]}),e.jsx("div",{className:"space-y-2",children:Ut.map(O=>{const de=z.has(O.epicId);return e.jsxs("div",{className:"rounded-xl border border-border/30 bg-card/30 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2.5",children:[e.jsx(Yl,{epic:{id:O.epic.id,title:O.epic.title,description:O.epic.description??void 0,progress_percentage:O.epic.progress_percentage??0,target_days:O.epic.target_days,start_date:O.epic.start_date,end_date:O.epic.end_date,epic_habits:O.epic.epic_habits},children:e.jsxs("button",{className:"flex items-center gap-2 min-w-0 flex-1 text-left focus:outline-none",children:[e.jsx(At,{className:"w-4 h-4 text-primary shrink-0"}),e.jsx("span",{className:"text-sm font-medium truncate",children:O.title})]})}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsxs("span",{className:"text-primary font-bold text-xs",children:[O.progress,"%"]}),O.daysLeft!==null&&e.jsxs("span",{className:"text-muted-foreground text-xs",children:[O.daysLeft,"d"]}),e.jsxs(Fe,{variant:"secondary",className:"text-xs h-5 px-1.5",children:[O.completedCount,"/",O.rituals.length]}),e.jsx("button",{onClick:V=>{V.stopPropagation(),Fp(O.epicId)},className:"p-1 -m-1 focus:outline-none",children:de?e.jsx(Zi,{className:"w-4 h-4 text-muted-foreground"}):e.jsx(Os,{className:"w-4 h-4 text-muted-foreground"})})]})]}),de&&e.jsx("div",{className:"border-t border-border/20 px-2 pb-1",children:O.rituals.map(V=>{const se=ve.draggingTaskId===V.id,ze=ve.isDragging,Qe=ht.get(V.id)?.size??0;return e.jsx(M.div,{className:A("relative",se&&"z-50"),style:{y:se?ve.dragOffsetY:0,pointerEvents:ze&&!se?"none":"auto",opacity:ze&&!se?.7:1},children:Kn(V,void 0,Qe)},V.id)})})]},O.epicId)})})]}),g&&g.length>0&&Ie.length===0&&e.jsx("div",{className:"mt-4 pt-3 border-t border-border/20 space-y-2",children:g.map(O=>{const de=Math.round(O.progress_percentage??0),V=Vl(O.end_date);return e.jsx(Yl,{epic:{id:O.id,title:O.title,description:O.description??void 0,progress_percentage:O.progress_percentage??0,target_days:O.target_days,start_date:O.start_date,end_date:O.end_date,epic_habits:O.epic_habits},children:e.jsx("button",{className:"w-full text-left focus:outline-none",children:e.jsx("div",{className:"flex items-center justify-between py-2 px-3 rounded-xl hover:bg-muted/30 border border-border/30 bg-card/30",children:e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx(At,{className:"w-4 h-4 text-primary shrink-0"}),e.jsx("span",{className:"text-sm font-medium truncate max-w-[140px]",children:O.title}),e.jsxs("span",{className:"text-primary font-bold text-xs shrink-0",children:[de,"%"]}),V!==null&&e.jsxs("span",{className:"text-muted-foreground text-xs shrink-0",children:["Â· ",V,"d"]})]})})})},O.id)})})]}),zs&&Ye&&Je&&typeof document<"u"?Cf.createPortal(e.jsx(M.div,{"data-testid":"timeline-drag-overlay",className:"pointer-events-none fixed z-[120] rounded-xl bg-background shadow-[0_18px_32px_-10px_rgba(0,0,0,0.35),0_10px_16px_-8px_rgba(0,0,0,0.2)]",style:{top:Je.top,left:Je.left,width:Je.width,x:Ct,y:dt},children:e.jsx(Ni,{rowKind:"task",time:Ye.scheduled_time,overrideTime:ve.previewTime??void 0,isDragTarget:!0,durationMinutes:Ye.estimated_duration,laneIndex:yt?.laneIndex,laneCount:yt?.laneCount,overlapCount:yt?.overlapCount,className:"cursor-grabbing","data-testid":`timeline-drag-overlay-row-${Ye.id}`,children:Kn(Ye,void 0,Fa)})}),document.body):null,e.jsx(h_,{open:G,onOpenChange:re,selectedDate:r,onDateSelect:O=>{u&&u(O)},tasks:h,milestones:f,onTaskDrop:()=>{},onTimeSlotLongPress:x}),e.jsx(f_,{rail:ve.zoomRail})]})}),tc=80,yj=14,bj=8,vj=async t=>{try{await fs.impact({style:t})}catch{}},sn=(t,s)=>{const r=Math.max(7,s),a=Yf(t),i=Math.floor(r/2),o=Dn(a,i),l=Cs(o,r-1);return{start:o,end:l}},wj=n.memo(function({selectedDate:s,onDateSelect:r,tasksPerDay:a={},daysToShow:i=14,isActive:o=!0}){const l=n.useRef(null),c=n.useRef(null),d=n.useRef(!0),m=n.useRef(o),p=n.useRef(null),h=n.useRef(!1),[f,u]=n.useState(()=>sn(s,i).start),[g,y]=n.useState(()=>sn(s,i).end),[b,v]=n.useState(0),x=Math.max(yj,i);n.useEffect(()=>{const N=sn(s,i);u(N.start),y(N.end)},[i]),n.useEffect(()=>{const N=s.getTime();if(!(N<f.getTime()||N>g.getTime()))return;const k=sn(s,i);u(k.start),y(k.end)},[i,g,f,s]);const w=n.useMemo(()=>{const N=Gf(g,f)+1;return Array.from({length:Math.max(1,N)},(E,k)=>Cs(f,k))},[g,f]),j=n.useCallback(N=>{const E=te(N,"yyyy-MM-dd");return a[E]||0},[a]),D=n.useCallback(()=>{const N=l.current;if(!N)return null;const k=c.current??N.querySelector("button[data-date-pill='true']");if(!k)return null;const P=N.offsetWidth,T=k.offsetWidth;return P===0||T===0?null:Math.max(0,P/2-T/2)},[]),C=n.useCallback(()=>{const N=D();N!==null&&v(E=>Math.abs(E-N)<.5?E:N)},[D]),_=n.useCallback(()=>{const N=l.current;if(!N||h.current)return;const{scrollLeft:E,clientWidth:k,scrollWidth:P}=N;if(E<=tc){h.current=!0,p.current={previousScrollWidth:P,previousScrollLeft:E},u(T=>Dn(T,x));return}E+k>=P-tc&&(h.current=!0,y(T=>Cs(T,x)))},[x]);return n.useLayoutEffect(()=>{const N=l.current;if(!N){h.current=!1;return}const E=p.current;if(E){const P=N.scrollWidth-E.previousScrollWidth;N.scrollLeft=E.previousScrollLeft+P,p.current=null}const k=typeof window<"u"?window.requestAnimationFrame(()=>{h.current=!1}):null;return()=>{k!==null&&window.cancelAnimationFrame(k)}},[g,f]),n.useLayoutEffect(()=>{d.current=!0},[s]),n.useLayoutEffect(()=>{o&&!m.current&&(d.current=!0),m.current=o},[o]),n.useLayoutEffect(()=>{C()},[w,s,o,C]),n.useEffect(()=>{if(typeof ResizeObserver>"u")return;const N=l.current;if(!N)return;const E=new ResizeObserver(()=>{C()});return E.observe(N),()=>{E.disconnect()}},[C]),n.useLayoutEffect(()=>{if(!o||!d.current)return;let N=null,E=!1;const k=P=>{if(E||!d.current)return;const T=l.current,I=c.current;if(!T||!I){P>0&&typeof window<"u"&&(N=window.requestAnimationFrame(()=>{k(P-1)}));return}const R=T.offsetWidth,L=I.offsetWidth;if((R===0||L===0)&&P>0&&typeof window<"u"){N=window.requestAnimationFrame(()=>{k(P-1)});return}if(R===0||L===0)return;const $=D();if($!==null&&Math.abs($-b)>=.5){v($),P>0&&typeof window<"u"&&(N=window.requestAnimationFrame(()=>{k(P-1)}));return}const F=I.offsetLeft-R/2+L/2,H=Math.max(0,T.scrollWidth-R),J=Math.min(Math.max(F,0),H);try{T.scrollTo({left:J,behavior:"smooth"})}catch{}T.scrollLeft=J,d.current=!1};return k(bj),()=>{E=!0,N!==null&&window.cancelAnimationFrame(N)}},[D,w,b,o,s]),e.jsxs("div",{ref:l,onScroll:_,className:A("flex gap-2 overflow-x-auto pb-2 scrollbar-hide -mx-1 px-1 transition-all duration-200"),style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:[e.jsx("div",{"aria-hidden":"true","data-testid":"date-pill-edge-spacer-start",className:"shrink-0",style:{width:`${b}px`}}),w.map(N=>{const E=wa(N,s),k=so(N),P=j(N),T=te(N,"yyyy-MM-dd");return e.jsxs(M.button,{ref:E?c:void 0,"data-date-pill":"true",onClick:async()=>{await vj(Wt.Light),r(N)},className:A("flex-shrink-0 flex flex-col items-center justify-center","min-w-[52px] h-16 rounded-xl transition-all duration-200","border border-border/50",E?"bg-gradient-to-br from-primary to-purple-500 text-white border-primary shadow-lg shadow-primary/25":"bg-card/50 hover:bg-card hover:border-primary/30",k&&!E&&"border-celestial-blue/50 ring-1 ring-celestial-blue/30 bg-celestial-blue/5"),animate:{scale:1,y:0},transition:{type:"spring",stiffness:400,damping:25},children:[e.jsx("span",{className:A("text-[10px] font-medium uppercase tracking-wide",E?"text-white/90":k?"text-celestial-blue":"text-muted-foreground"),children:te(N,"EEE")}),e.jsx("span",{className:A("text-lg font-bold leading-tight",E?"text-white":k?"text-celestial-blue":"text-foreground"),children:te(N,"d")}),e.jsx("div",{className:"flex gap-0.5 mt-0.5 h-1.5",children:P>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:A("h-1.5 w-1.5 rounded-full",E?"bg-white/70":k?"bg-celestial-blue/60":"bg-stardust-gold/60")}),P>1&&e.jsx("div",{className:A("h-1.5 w-1.5 rounded-full",E?"bg-white/50":k?"bg-celestial-blue/40":"bg-stardust-gold/40")}),P>2&&e.jsx("div",{className:A("h-1.5 w-1.5 rounded-full",E?"bg-white/30":k?"bg-celestial-blue/20":"bg-stardust-gold/20")})]})})]},T)}),e.jsx("div",{"aria-hidden":"true","data-testid":"date-pill-edge-spacer-end",className:"shrink-0",style:{width:`${b}px`}})]})}),_j=({onClick:t,className:s})=>e.jsx(U,{variant:"ghost",size:"icon",onClick:t,className:A("h-8 w-8 rounded-full bg-muted/50 hover:bg-muted text-muted-foreground hover:text-foreground transition-colors",s),"aria-label":"Page information",children:e.jsx(Ji,{className:"h-4 w-4"})}),jj=({open:t,onClose:s,title:r,icon:a,description:i,features:o,tip:l})=>e.jsx(ns,{open:t,onOpenChange:s,children:e.jsxs(Vt,{className:"max-w-md",children:[e.jsxs(Bs,{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(a,{className:"h-6 w-6 text-primary"})}),e.jsx(xs,{className:"text-2xl",children:r})]}),e.jsx(dr,{className:"text-base",children:i})]}),e.jsx("div",{className:"space-y-3 py-4",children:o.map((c,d)=>e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-5 w-5 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0 mt-0.5",children:e.jsx(Pt,{className:"h-3 w-3 text-primary"})}),e.jsx("p",{className:"text-sm text-muted-foreground flex-1",children:c})]},d))}),l&&e.jsx("div",{className:"bg-accent/10 border border-accent/20 rounded-lg p-4",children:e.jsx("p",{className:"text-sm italic text-muted-foreground",children:l})}),e.jsx(U,{onClick:s,className:"w-full",children:"Got it!"})]})}),Nj=n.memo(function({open:s,currentStreak:r,freezesAvailable:a,onUseFreeze:i,onResetStreak:o,onOpenChange:l,isResolving:c}){const[d,m]=n.useState(null),p=async()=>{m("freeze"),await i()},h=async()=>{m("reset"),await o()};return e.jsx(ns,{open:s,onOpenChange:l,children:e.jsxs(Vt,{className:"sm:max-w-md bg-background/95 backdrop-blur-xl border-amber-500/30",hideCloseButton:!0,children:[e.jsxs(Bs,{className:"text-center",children:[e.jsx(M.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},className:"mx-auto mb-4 p-4 rounded-full bg-amber-500/20 border border-amber-500/30",children:e.jsx(Xs,{className:"w-10 h-10 text-amber-400"})}),e.jsx(xs,{className:"text-2xl font-bold text-center",children:"Your Streak is at Risk!"}),e.jsx(dr,{className:"text-center text-muted-foreground",children:"You missed a day. What would you like to do?"})]}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs(M.div,{initial:{y:10,opacity:0},animate:{y:0,opacity:1},transition:{delay:.1},className:"flex items-center justify-center gap-3 p-4 rounded-xl bg-gradient-to-r from-orange-500/20 to-red-500/20 border border-orange-500/30",children:[e.jsx(Gt,{className:"w-8 h-8 text-orange-400"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-3xl font-bold text-foreground",children:r}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"day streak"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(M.div,{initial:{x:-20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.2},children:[e.jsx(U,{onClick:p,disabled:c||a<=0,className:"w-full h-auto py-4 px-4 bg-gradient-to-r from-cyan-500/20 to-blue-500/20 hover:from-cyan-500/30 hover:to-blue-500/30 border border-cyan-500/40 text-foreground",variant:"outline",children:e.jsxs("div",{className:"flex items-center gap-4 w-full",children:[e.jsx("div",{className:"p-2 rounded-full bg-cyan-500/20",children:e.jsx(Ef,{className:"w-6 h-6 text-cyan-400"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-semibold text-base",children:"Use Streak Freeze"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Keep your ",r,"-day streak alive"]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"text-sm font-medium text-cyan-400",children:[a," available"]})})]})}),a<=0&&e.jsx("p",{className:"text-xs text-muted-foreground text-center mt-1",children:"No freezes available. Freezes reset weekly."})]}),e.jsx(M.div,{initial:{x:20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.3},children:e.jsx(U,{onClick:h,disabled:c,className:"w-full h-auto py-4 px-4 bg-muted/30 hover:bg-muted/50 border border-border/50 text-foreground",variant:"outline",children:e.jsxs("div",{className:"flex items-center gap-4 w-full",children:[e.jsx("div",{className:"p-2 rounded-full bg-muted/30",children:e.jsx(pe,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-semibold text-base",children:"Start Fresh"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Let the streak reset and begin anew"})]})]})})})]}),c&&e.jsx(M.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center text-sm text-muted-foreground",children:d==="freeze"?"Preserving your streak...":"Resetting streak..."})]})]})})}),Jm=n.forwardRef(({className:t,...s},r)=>e.jsx(Pd,{className:A("grid gap-2",t),...s,ref:r}));Jm.displayName=Pd.displayName;const un=n.forwardRef(({className:t,...s},r)=>e.jsx(Ad,{ref:r,className:A("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...s,children:e.jsx(Tf,{className:"flex items-center justify-center",children:e.jsx(En,{className:"h-2.5 w-2.5 fill-current text-current"})})}));un.displayName=Ad.displayName;const kj=({value:t,onChange:s})=>e.jsxs("div",{className:"space-y-3",children:[e.jsx(at,{className:"text-sm font-bold",children:"Difficulty (affects XP reward)"}),e.jsxs(Jm,{value:t,onValueChange:s,className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(un,{value:"easy",id:"easy",className:"peer sr-only"}),e.jsxs(at,{htmlFor:"easy",className:"flex flex-col items-center gap-2 rounded-lg border-2 border-muted bg-background p-4 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary cursor-pointer transition-all",children:[e.jsx(ft,{className:"h-5 w-5 text-green-500"}),e.jsx("span",{className:"font-semibold",children:"Easy"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",ai.EASY," XP"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(un,{value:"medium",id:"medium",className:"peer sr-only"}),e.jsxs(at,{htmlFor:"medium",className:"flex flex-col items-center gap-2 rounded-lg border-2 border-muted bg-background p-4 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary cursor-pointer transition-all",children:[e.jsx(Gt,{className:"h-5 w-5 text-orange-500"}),e.jsx("span",{className:"font-semibold",children:"Medium"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",ai.MEDIUM," XP"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(un,{value:"hard",id:"hard",className:"peer sr-only"}),e.jsxs(at,{htmlFor:"hard",className:"flex flex-col items-center gap-2 rounded-lg border-2 border-muted bg-background p-4 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary cursor-pointer transition-all",children:[e.jsx(Ta,{className:"h-6 w-6 text-red-500"}),e.jsx("span",{className:"font-semibold",children:"Hard"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",ai.HARD," XP"]})]})]})]})]}),Zm={jan:0,january:0,feb:1,february:1,mar:2,march:2,apr:3,april:3,may:4,jun:5,june:5,jul:6,july:6,aug:7,august:7,sep:8,sept:8,september:8,oct:9,october:9,nov:10,november:10,dec:11,december:11};function Cj(t){return t>=1&&t<=6?"pm":t>=7&&t<=11?"am":t===12?"pm":"am"}function sc(t){let s=parseInt(t[1]);const r=t[2]?parseInt(t[2]):0;let a=t[3]?.toLowerCase();return!a&&s>=1&&s<=12&&(a=Cj(s)),a==="pm"&&s<12&&(s+=12),a==="am"&&s===12&&(s=0),`${s.toString().padStart(2,"0")}:${r.toString().padStart(2,"0")}`}function Sj(t){const s=t[1].toLowerCase(),r=parseInt(t[2]),a=Zm[s];if(a===void 0||r<1||r>31)return te(new Date,"yyyy-MM-dd");let i=Fs(new Date,a);return i=Ir(i,r),i<new Date&&(i=Fs(new Date(ro(new Date)+1,0,1),a),i=Ir(i,r)),te(i,"yyyy-MM-dd")}function Ej(t){const s=parseInt(t[1]),r=t[2].toLowerCase(),a=Zm[r];if(a===void 0||s<1||s>31)return te(new Date,"yyyy-MM-dd");let i=Fs(new Date,a);return i=Ir(i,s),i<new Date&&(i=Fs(new Date(ro(new Date)+1,0,1),a),i=Ir(i,s)),te(i,"yyyy-MM-dd")}function Tj(t){const s=parseInt(t[1]),r=parseInt(t[2]),a=s-1,i=r;if(a<0||a>11||i<1||i>31)return te(new Date,"yyyy-MM-dd");let o=Fs(new Date,a);return o=Ir(o,i),o<new Date&&(o=Fs(new Date(ro(new Date)+1,0,1),a),o=Ir(o,i)),te(o,"yyyy-MM-dd")}const ep=[{regex:/\bat\s+(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i,handler:sc},{regex:/\b(\d{1,2})(?::(\d{2}))?\s*(am|pm)/i,handler:sc},{regex:/\b(?:first\s*thing|wake\s*up|early\s*morning|dawn|sunrise)\b/i,handler:()=>"06:00"},{regex:/\bmorning\b/i,handler:()=>"09:00"},{regex:/\bmid[- ]?morning\b/i,handler:()=>"10:00"},{regex:/\b(?:noon|midday|lunch(?:time)?)\b/i,handler:()=>"12:00"},{regex:/\bearly\s*afternoon\b/i,handler:()=>"13:00"},{regex:/\bafternoon\b/i,handler:()=>"14:00"},{regex:/\blate\s*afternoon\b/i,handler:()=>"16:00"},{regex:/\b(?:before\s*dinner|pre[- ]?dinner)\b/i,handler:()=>"17:00"},{regex:/\bevening\b/i,handler:()=>"18:00"},{regex:/\b(?:after\s*dinner|post[- ]?dinner)\b/i,handler:()=>"19:00"},{regex:/\bnight\b/i,handler:()=>"21:00"},{regex:/\b(?:before\s*bed|bedtime|end\s*of\s*day)\b/i,handler:()=>"22:00"},{regex:/\blate\s*night\b/i,handler:()=>"23:00"},{regex:/\bmidnight\b/i,handler:()=>"00:00"}],tp=[{regex:/\bin\s+(\d+)\s*days?\b/i,handler:t=>te(Cs(new Date,parseInt(t[1])),"yyyy-MM-dd")},{regex:/\bin\s+(\d+)\s*weeks?\b/i,handler:t=>te(Ai(new Date,parseInt(t[1])),"yyyy-MM-dd")},{regex:/\bin\s+(\d+)\s*months?\b/i,handler:t=>te(Sr(new Date,parseInt(t[1])),"yyyy-MM-dd")},{regex:/\bnext\s+week\b/i,handler:()=>te(Ai(new Date,1),"yyyy-MM-dd")},{regex:/\btoday\b/i,handler:()=>te(new Date,"yyyy-MM-dd")},{regex:/\btomorrow\b/i,handler:()=>te(Cs(new Date,1),"yyyy-MM-dd")},{regex:/\bday\s*after\s*tomorrow\b/i,handler:()=>te(Cs(new Date,2),"yyyy-MM-dd")},{regex:/\bthis\s*weekend\b/i,handler:()=>te(Yn(new Date),"yyyy-MM-dd")},{regex:/\b(?:end\s*of\s*week|eow)\b/i,handler:()=>te(Vn(new Date),"yyyy-MM-dd")},{regex:/\b(?:start\s*of\s*(?:next\s*)?week|beginning\s*of\s*week)\b/i,handler:()=>te(Xn(new Date),"yyyy-MM-dd")},{regex:/\b(?:end\s*of\s*month|eom)\b/i,handler:()=>te(va(new Date),"yyyy-MM-dd")},{regex:/\bnext\s*month\b/i,handler:()=>te(ba(Sr(new Date,1)),"yyyy-MM-dd")},{regex:/\b(?:in\s*a\s*)?fortnight\b/i,handler:()=>te(Cs(new Date,14),"yyyy-MM-dd")},{regex:/\b(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|june?|july?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\s+(\d{1,2})(?:st|nd|rd|th)?\b/i,handler:Sj},{regex:/\b(\d{1,2})(?:st|nd|rd|th)?\s+(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|june?|july?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\b/i,handler:Ej},{regex:/\b(\d{1,2})[/-](\d{1,2})\b/,handler:Tj},{regex:/\bnext\s+monday\b/i,handler:()=>te(Xn(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+tuesday\b/i,handler:()=>te(qo(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+wednesday\b/i,handler:()=>te(Oo(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+thursday\b/i,handler:()=>te(Fo(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+friday\b/i,handler:()=>te(Vn(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+saturday\b/i,handler:()=>te(Yn(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+sunday\b/i,handler:()=>te($o(new Date),"yyyy-MM-dd")},{regex:/\bmonday\b/i,handler:()=>te(Xn(new Date),"yyyy-MM-dd")},{regex:/\btuesday\b/i,handler:()=>te(qo(new Date),"yyyy-MM-dd")},{regex:/\bwednesday\b/i,handler:()=>te(Oo(new Date),"yyyy-MM-dd")},{regex:/\bthursday\b/i,handler:()=>te(Fo(new Date),"yyyy-MM-dd")},{regex:/\bfriday\b/i,handler:()=>te(Vn(new Date),"yyyy-MM-dd")},{regex:/\bsaturday\b/i,handler:()=>te(Yn(new Date),"yyyy-MM-dd")},{regex:/\bsunday\b/i,handler:()=>te($o(new Date),"yyyy-MM-dd")}],sp=[{regex:/\bfor\s+(\d+)\s*h(?:ours?)?\b/i,handler:t=>parseInt(t[1])*60},{regex:/\bfor\s+(\d+)\s*m(?:in(?:utes?)?)?\b/i,handler:t=>parseInt(t[1])},{regex:/\b(\d+)\s*h(?:ours?)?\s*(?:(\d+)\s*m(?:in)?s?)?\b/i,handler:t=>parseInt(t[1])*60+(t[2]?parseInt(t[2]):0)},{regex:/\b(\d+)\s*m(?:in(?:utes?)?)?\b/i,handler:t=>parseInt(t[1])},{regex:/\bhalf\s*(?:an?\s*)?hour\b/i,handler:()=>30},{regex:/\bquarter\s*(?:of\s*an?\s*)?hour\b/i,handler:()=>15},{regex:/\b(?:a\s*)?couple\s*(?:of\s*)?hours?\b/i,handler:()=>120},{regex:/\b(?:a\s*)?few\s*(?:of\s*)?hours?\b/i,handler:()=>180},{regex:/\b(?:a\s*)?few\s*(?:of\s*)?min(?:ute)?s?\b/i,handler:()=>10},{regex:/\b(?:all|full)\s*day\b/i,handler:()=>480},{regex:/\bhalf\s*day\b/i,handler:()=>240},{regex:/\bquick\b/i,handler:()=>15},{regex:/\bbrief\b/i,handler:()=>5},{regex:/\bpomodoro\b/i,handler:()=>25},{regex:/\bdeep\s*work\b/i,handler:()=>90},{regex:/\bsprint\b/i,handler:()=>45}],rp=[{regex:/\b(super\s+)?easy\b/i,result:"easy"},{regex:/\bsimple\b/i,result:"easy"},{regex:/\blight\b/i,result:"easy"},{regex:/\bbasic\b/i,result:"easy"},{regex:/\btrivial\b/i,result:"easy"},{regex:/\bhard\b/i,result:"hard"},{regex:/\bdifficult\b/i,result:"hard"},{regex:/\bchallenging\b/i,result:"hard"},{regex:/\bcomplex\b/i,result:"hard"},{regex:/\btough\b/i,result:"hard"},{regex:/\bintense\b/i,result:"hard"}],ap=[{regex:/!{4,}/,priority:"urgent"},{regex:/!{3}/,priority:"high"},{regex:/!{2}/,priority:"medium"},{regex:/!1\b/i,priority:"urgent"},{regex:/!2\b/i,priority:"high"},{regex:/!3\b/i,priority:"medium"},{regex:/!4\b/i,priority:"low"},{regex:/\bp1\b/i,priority:"urgent"},{regex:/\bp2\b/i,priority:"high"},{regex:/\bp3\b/i,priority:"medium"},{regex:/\bp4\b/i,priority:"low"},{regex:/\bURGENT\b/i,priority:"urgent"},{regex:/\bASAP\b/i,priority:"urgent"},{regex:/\bcritical\b/i,priority:"urgent"},{regex:/\bemergency\b/i,priority:"urgent"},{regex:/\bhigh\s*priority\b/i,priority:"high"},{regex:/\bimportant\b/i,priority:"high"},{regex:/\bmust\s+do\b/i,priority:"high"},{regex:/\bmedium\s*priority\b/i,priority:"medium"},{regex:/\blow\s*priority\b/i,priority:"low"},{regex:/\bsomeday\b/i,priority:"low"},{regex:/\bbacklog\b/i,priority:"low"},{regex:/\bwhenever\b/i,priority:"low"},{regex:/\btop\s*3\b/i,isTopThree:!0},{regex:/\b#1\b/,isTopThree:!0},{regex:/\bpriority\s*(?:one|1)\b/i,isTopThree:!0},{regex:/\bmost\s*important\b/i,isTopThree:!0},{regex:/\bmain\s*focus\b/i,isTopThree:!0}],np=[{regex:/\bevery\s*day\b/i,result:"daily"},{regex:/\bdaily\b/i,result:"daily"},{regex:/\bevery\s*week\b/i,result:"weekly"},{regex:/\bweekly\b/i,result:"weekly"},{regex:/\bevery\s*month\b/i,result:"monthly"},{regex:/\bmonthly\b/i,result:"monthly"},{regex:/\bevery\s*(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/i,result:"weekly"},{regex:/\b(?:twice\s*(?:a\s*)?(?:day|daily)|2x\s*daily)\b/i,result:"twice_daily"},{regex:/\b(?:alternate\s*days?|every\s*other\s*day)\b/i,result:"alternate"},{regex:/\b(?:biweekly|every\s*(?:two|2)\s*weeks?)\b/i,result:"biweekly"}],ip=[{regex:/\bweekdays?\s*(?:only)?\b/i,days:[1,2,3,4,5]},{regex:/\bweekends?\s*(?:only)?\b/i,days:[0,6]},{regex:/\bMWF\b|mon(?:day)?\s*wed(?:nesday)?\s*fri(?:day)?/i,days:[1,3,5]},{regex:/\bTTh?\b|tue(?:sday)?\s*thu(?:rsday)?/i,days:[2,4]},{regex:/\b(\d)x\s*(?:a\s*)?week\b/i,frequency:"custom"},{regex:/\b(?:three|3)\s*times?\s*(?:a\s*)?week\b/i,frequency:"3x_week"},{regex:/\b(?:five|5)\s*times?\s*(?:a\s*)?week\b/i,frequency:"5x_week"},{regex:/\b(?:twice|2x?)\s*(?:a\s*)?week\b/i,frequency:"2x_week"}],op=[{regex:/@home\b/i,result:"home"},{regex:/@work\b/i,result:"work"},{regex:/@office\b/i,result:"work"},{regex:/@errands?\b/i,result:"errands"},{regex:/@phone\b/i,result:"phone"},{regex:/@computer\b/i,result:"computer"},{regex:/@anywhere\b/i,result:"anywhere"},{regex:/@gym\b/i,result:"gym"},{regex:/@outside\b/i,result:"outside"},{regex:/@online\b/i,result:"online"}],lp=[{regex:/\blow\s*energy\b/i,result:"low"},{regex:/\btired\b/i,result:"low"},{regex:/\bexhausted\b/i,result:"low"},{regex:/\blazy\b/i,result:"low"},{regex:/\bhigh\s*energy\b/i,result:"high"},{regex:/\bfocused\b/i,result:"high"},{regex:/\benergetic\b/i,result:"high"},{regex:/\bpumped\b/i,result:"high"},{regex:/\bpeak\b/i,result:"high"}],cp=[{regex:/remind\s*(?:me\s+)?(\d+)\s*(?:min(?:ute)?s?)\s*(?:before|early|prior)/i,handler:t=>parseInt(t[1])},{regex:/remind\s*(?:me\s+)?(?:at\s+least\s+)?(\d+)\s*(?:h(?:ou)?rs?)\s*(?:before|early|prior)/i,handler:t=>parseInt(t[1])*60},{regex:/remind\s*(?:me\s+)?(?:a\s+)?half\s*(?:an?\s+)?(?:h(?:ou)?r)\s*(?:before|early|prior)/i,handler:()=>30},{regex:/remind\s*(?:me\s+)?(?:an?\s+|one\s+)(?:h(?:ou)?r)\s*(?:before|early|prior)/i,handler:()=>60},{regex:/remind\s*me\b/i,handler:()=>15},{regex:/(?:set|with)\s*(?:a\s+)?reminder/i,handler:()=>15}],dp=[{regex:/\bnotes?:\s*(.+?)(?=\s*(?:!{1,4}|p[1-4]|\bat\s+\d|@|\bremind|\btomorrow|\btoday|$))/i,handler:t=>t[1].trim()},{regex:/\/\/\s*(.+?)$/i,handler:t=>t[1].trim()},{regex:/\(([^)]+)\)\s*$/i,handler:t=>t[1].trim()}],up=[{regex:/\b(?:remove|clear|delete|no|unset)\s*(?:the\s*)?(?:scheduled?\s*)?time\b/i,clears:"time"},{regex:/\b(?:remove|clear|delete|no|unset)\s*(?:the\s*)?(?:scheduled?\s*)?date\b/i,clears:"date"},{regex:/\b(?:remove|clear|delete|no|unset)\s*(?:the\s*)?(?:estimated?\s*)?duration\b/i,clears:"duration"},{regex:/\b(?:remove|clear|delete|no|unset|stop)\s*(?:the\s*)?(?:recurrence|repeat(?:ing)?)\b/i,clears:"recurrence"},{regex:/\bunschedule\b/i,clears:"both"},{regex:/\bclear\s*(?:all\s*)?schedule\b/i,clears:"both"},{regex:/\b(?:reset|clear\s*all|start\s*fresh|defaults?)\b/i,clears:"all"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?category\b/i,clears:"category"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?(?:attribute|type)\b/i,clears:"category"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?priority\b/i,clears:"priority"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?notes?\b/i,clears:"notes"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?remind(?:er)?\b/i,clears:"reminder"}],mp=[{regex:/\b(?:for\s+)?(?:mind|mental|brain|cognitive|intellectual|thinking|#mind)\b/i,category:"mind"},{regex:/\b(?:for\s+)?(?:body|physical|fitness|workout|exercise|health|#body)\b/i,category:"body"},{regex:/\b(?:for\s+)?(?:soul|spirit(?:ual)?|emotional|heart|inner|#soul)\b/i,category:"soul"}],pp=[{regex:/\b(?:pause|skip|disable|deactivate|turn\s*off|stop)\s*(?:this)?\b/i,paused:!0},{regex:/\b(?:resume|activate|enable|turn\s*on|unpause|start)\s*(?:this)?\b/i,paused:!1},{regex:/\b(?:archive|hide)\s*(?:this)?\b/i,archived:!0},{regex:/\b(?:unarchive|unhide|restore)\s*(?:this)?\b/i,archived:!1}],hp=[{regex:/\b(?:bonus|extra\s*credit|stretch\s*goal|optional|nice\s*to\s*have)\b/i,isBonus:!0},{regex:/\b(?:required|mandatory|essential|core)\b/i,isBonus:!1}],fp=[{regex:/\b(?:milestone|checkpoint|key\s*moment|major|significant|big\s*step)\b/i,isMilestone:!0}],gp=[{regex:/\b(?:worth\s*)?(\d+)\s*(?:xp|points?|pts?)\b/i,handler:t=>parseInt(t[1])},{regex:/\b(?:double|2x)\s*xp\b/i,multiplier:2},{regex:/\b(?:triple|3x)\s*xp\b/i,multiplier:3},{regex:/\bhigh\s*value\b/i,xp:100},{regex:/\bquick\s*win\b/i,xp:25}],xp=[{regex:/\b(?:rename|call\s*it|change\s*(?:name|title)\s*to)\s*[:\s]*["']?(.+?)["']?$/i,handler:t=>t[1].trim()}],yp=[{regex:/\b(?:break\s*(?:this\s*)?down|decompose|split\s*(?:into\s*)?(?:sub)?tasks?|suggest\s*(?:sub)?steps?|expand)\b/i,trigger:!0}],bp=[{regex:/\b(?:plan|schedule|organize|optimise|optimize)\s*(?:my|the|today'?s?)?\s*(?:day|schedule|tasks?|quests?)\b/i,trigger:!0},{regex:/\b(?:help\s*me\s*)?plan\s*(?:out\s*)?today\b/i,trigger:!0},{regex:/\bwhat\s*should\s*I\s*do\s*(?:today|first|next)\b/i,trigger:!0},{regex:/\b(?:build|create|make)\s*(?:my|a)?\s*schedule\b/i,trigger:!0},{regex:/\bauto[- ]?schedule\b/i,trigger:!0}],vp=[{regex:/\b(?:plan|schedule|organize|optimise|optimize)\s*(?:my|the|this)?\s*week\b/i,trigger:!0},{regex:/\bweekly\s*(?:plan|planning|schedule)\b/i,trigger:!0},{regex:/\bwhat\s*should\s*I\s*do\s*this\s*week\b/i,trigger:!0},{regex:/\b(?:build|create|make)\s*(?:my|a)?\s*weekly\s*(?:plan|schedule)\b/i,trigger:!0},{regex:/\bplan\s*(?:out\s*)?(?:the\s*)?(?:next\s*)?(?:7|seven)\s*days?\b/i,trigger:!0},{regex:/\bweek\s*ahead\b/i,trigger:!0}];function Mj(t){let s=t;return[...ep.map(a=>a.regex),...tp.map(a=>a.regex),...sp.map(a=>a.regex),...rp.map(a=>a.regex),...ap.map(a=>a.regex),...np.map(a=>a.regex),...ip.map(a=>a.regex),...op.map(a=>a.regex),...lp.map(a=>a.regex),...cp.map(a=>a.regex),...dp.map(a=>a.regex),...up.map(a=>a.regex),...mp.map(a=>a.regex),...pp.map(a=>a.regex),...hp.map(a=>a.regex),...fp.map(a=>a.regex),...gp.map(a=>a.regex),...xp.map(a=>a.regex),...yp.map(a=>a.regex),...bp.map(a=>a.regex),...vp.map(a=>a.regex)].forEach(a=>{s=s.replace(a,"")}),s=s.replace(/\s+/g," ").replace(/^\s*[-,;:]\s*/,"").replace(/\s*[-,;:]\s*$/,"").trim(),s}function Dj(t){const s={text:t,difficulty:"medium",scheduledTime:null,scheduledDate:null,estimatedDuration:null,recurrencePattern:null,recurrenceEndDate:null,priority:null,energyLevel:"medium",context:null,isTopThree:!1,reminderEnabled:!1,reminderMinutesBefore:null,notes:null,contactId:null,autoLogInteraction:!0,mentionedContactName:null,clearTime:!1,clearDate:!1,clearDuration:!1,clearRecurrence:!1,clearAll:!1,clearCategory:!1,clearPriority:!1,clearNotes:!1,clearReminder:!1,category:null,frequency:null,customDays:null,paused:null,archived:null,isBonus:null,isMilestone:null,xpReward:null,xpMultiplier:null,newTitle:null,triggerDecomposition:!1,triggerPlanMyDay:!1,triggerPlanMyWeek:!1,imageUrl:null,attachments:[]};for(const r of up)r.regex.test(t)&&((r.clears==="time"||r.clears==="both")&&(s.clearTime=!0),(r.clears==="date"||r.clears==="both")&&(s.clearDate=!0),r.clears==="duration"&&(s.clearDuration=!0),r.clears==="recurrence"&&(s.clearRecurrence=!0),r.clears==="all"&&(s.clearAll=!0),r.clears==="category"&&(s.clearCategory=!0),r.clears==="priority"&&(s.clearPriority=!0),r.clears==="notes"&&(s.clearNotes=!0),r.clears==="reminder"&&(s.clearReminder=!0));for(const r of ep){const a=t.match(r.regex);if(a){s.scheduledTime=r.handler(a);break}}for(const r of tp){const a=t.match(r.regex);if(a){s.scheduledDate=r.handler(a);break}}for(const r of sp){const a=t.match(r.regex);if(a){s.estimatedDuration=r.handler(a);break}}for(const r of rp)if(r.regex.test(t)){s.difficulty=r.result;break}for(const r of ap)r.regex.test(t)&&(r.isTopThree?s.isTopThree=!0:r.priority&&!s.priority&&(s.priority=r.priority));for(const r of np)if(r.regex.test(t)){s.recurrencePattern=r.result;break}for(const r of ip)if(t.match(r.regex)){r.days&&(s.customDays=r.days),r.frequency&&(s.frequency=r.frequency);break}for(const r of op)if(r.regex.test(t)){s.context=r.result;break}for(const r of lp)if(r.regex.test(t)){s.energyLevel=r.result;break}for(const r of cp){const a=t.match(r.regex);if(a){s.reminderEnabled=!0,s.reminderMinutesBefore=r.handler(a);break}}for(const r of mp)if(r.regex.test(t)){s.category=r.category;break}for(const r of pp)if(r.regex.test(t)){r.paused!==void 0&&(s.paused=r.paused),r.archived!==void 0&&(s.archived=r.archived);break}for(const r of hp)if(r.regex.test(t)){s.isBonus=r.isBonus;break}for(const r of fp)if(r.regex.test(t)){s.isMilestone=r.isMilestone;break}for(const r of gp){const a=t.match(r.regex);if(a){r.handler?s.xpReward=r.handler(a):r.xp?s.xpReward=r.xp:r.multiplier&&(s.xpMultiplier=r.multiplier);break}}for(const r of xp){const a=t.match(r.regex);if(a){s.newTitle=r.handler(a);break}}for(const r of yp)if(r.regex.test(t)){s.triggerDecomposition=r.trigger;break}for(const r of vp)if(r.regex.test(t)){s.triggerPlanMyWeek=r.trigger;break}if(!s.triggerPlanMyWeek){for(const r of bp)if(r.regex.test(t)){s.triggerPlanMyDay=r.trigger;break}}for(const r of dp){const a=t.match(r.regex);if(a){s.notes=r.handler(a);break}}return s.text=Mj(t),s}function Pj(){const[t,s]=n.useState(""),[r,a]=n.useState(null);n.useEffect(()=>{t.trim()?a(Dj(t)):a(null)},[t]);const i=n.useCallback(()=>{s(""),a(null)},[]);return{input:t,setInput:s,parsed:r,reset:i}}function Aj(){const[t,s]=n.useState("prompt"),[r,a]=n.useState(!0),i=n.useCallback(async()=>{if(!navigator.permissions)return navigator.mediaDevices?.getUserMedia?(s("prompt"),"prompt"):(s("unsupported"),"unsupported");try{const l=await navigator.permissions.query({name:"microphone"}),c=l.state==="granted"?"granted":l.state==="denied"?"denied":"prompt";return s(c),l.onchange=()=>{const d=l.state==="granted"?"granted":l.state==="denied"?"denied":"prompt";s(d)},c}catch{return s("prompt"),"prompt"}},[]),o=n.useCallback(async()=>{if(!navigator.mediaDevices?.getUserMedia)return s("unsupported"),"unsupported";try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(c=>c.stop()),s("granted"),"granted"}catch(l){if(l instanceof Error){if(l.name==="NotAllowedError"||l.name==="PermissionDeniedError")return s("denied"),"denied";if(l.name==="NotFoundError")return s("unsupported"),"unsupported"}return s("denied"),"denied"}},[]);return n.useEffect(()=>{i().finally(()=>a(!1))},[i]),{status:t,isLoading:r,checkPermission:i,requestPermission:o}}function wp({onInterimResult:t,onFinalResult:s,onError:r,onPermissionNeeded:a,onAutoStopping:i,language:o="en-US",autoStopOnSilence:l=!0,silenceTimeoutMs:c=1500}={}){const[d,m]=n.useState(!1),[p,h]=n.useState(!1),f=n.useRef(null),u=n.useRef(null),{status:g,requestPermission:y,checkPermission:b}=Aj(),v=typeof window<"u"&&("SpeechRecognition"in window||"webkitSpeechRecognition"in window),x=n.useCallback(()=>{u.current&&(clearTimeout(u.current),u.current=null),h(!1)},[]),w=n.useCallback(()=>{x(),h(!1),f.current&&(f.current.stop(),f.current=null,m(!1))},[x]),j=n.useCallback(()=>{if(!v)return null;const _=window.SpeechRecognition||window.webkitSpeechRecognition;if(!_)return null;const N=new _;return N.continuous=!0,N.interimResults=!0,N.lang=o,N.onresult=E=>{let k="",P="";for(let T=E.resultIndex;T<E.results.length;T++){const I=E.results[T][0].transcript;E.results[T].isFinal?P+=I:k+=I}P&&s&&s(P),k&&t&&t(k),l&&(k||P)&&(x(),u.current=setTimeout(()=>{h(!0),i?.(),setTimeout(()=>{w()},300)},c))},N.onerror=E=>{console.error("Speech recognition error:",E.error),x(),m(!1),r&&r({"not-allowed":"Microphone access denied. Please enable microphone permissions.","no-speech":"No speech detected. Please try again.","audio-capture":"No microphone found. Please check your device.",network:"Network error. Please check your connection."}[E.error]||`Speech recognition error: ${E.error}`)},N.onend=()=>{x(),m(!1)},N},[v,o,t,s,r,l,c,x,w]),D=n.useCallback(async()=>{if(!v){r?.("Speech recognition is not supported in this browser.");return}const _=await b();if(_==="denied"||_==="unsupported"){a?.();return}if(_==="prompt"&&await y()!=="granted"){a?.();return}if(f.current=j(),f.current)try{f.current.start(),m(!0)}catch(N){console.error("Failed to start recording:",N),r?.("Failed to start recording. Please try again.")}},[v,j,r,b,y,a]),C=n.useCallback(()=>{d?w():D()},[d,D,w]);return n.useEffect(()=>()=>{x(),f.current&&f.current.stop()},[x]),{isRecording:d,isAutoStopping:p,isSupported:v,permissionStatus:g,startRecording:D,stopRecording:w,toggleRecording:C,requestPermission:y}}function Rj({onApply:t}){const[s,r]=n.useState(!1),{input:a,setInput:i,parsed:o,reset:l}=Pj(),{isRecording:c,toggleRecording:d,isSupported:m}=wp({onInterimResult:f=>{i(u=>u+" "+f)},onFinalResult:f=>{i(u=>(u+" "+f).trim())},language:"en-US",autoStopOnSilence:!0}),p=o&&(o.scheduledTime||o.scheduledDate||o.estimatedDuration||o.difficulty!=="medium"||o.recurrencePattern||o.priority||o.context||o.isTopThree||o.reminderEnabled||o.notes||o.category||o.frequency||o.customDays||o.paused!==null||o.archived!==null||o.isBonus!==null||o.isMilestone!==null||o.xpReward||o.xpMultiplier||o.newTitle||o.triggerDecomposition||o.energyLevel!=="medium"||o.clearTime||o.clearDate||o.clearDuration||o.clearRecurrence||o.clearAll||o.clearCategory||o.clearPriority||o.clearNotes||o.clearReminder),h=()=>{o&&t(o),l(),r(!1)};return s?e.jsxs("div",{className:"space-y-3 p-3 rounded-lg bg-muted/50 border border-border",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"Quick Edit"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ot,{value:a,onChange:f=>i(f.target.value),placeholder:"e.g., 'at 3pm for 1 hour daily for body'",className:"flex-1 text-sm"}),m&&e.jsx(U,{variant:c?"destructive":"outline",size:"icon",onClick:d,className:"shrink-0",children:c?e.jsx(Mf,{className:"h-4 w-4"}):e.jsx(Rd,{className:"h-4 w-4"})})]}),p&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[o.scheduledTime&&e.jsxs(Ze,{color:"primary",children:["â° ",o.scheduledTime]}),o.scheduledDate&&e.jsxs(Ze,{color:"accent",children:["ðŸ“… ",o.scheduledDate]}),o.estimatedDuration&&e.jsxs(Ze,{color:"secondary",children:["â±ï¸ ",o.estimatedDuration,"min"]}),o.difficulty!=="medium"&&e.jsxs(Ze,{color:o.difficulty==="easy"?"green":"red",children:[o.difficulty==="easy"?"ðŸŒ±":"ðŸ”¥"," ",o.difficulty]}),o.recurrencePattern&&e.jsxs(Ze,{color:"purple",children:["ðŸ”„ ",o.recurrencePattern]}),o.priority&&e.jsxs(Ze,{color:o.priority==="urgent"?"red":o.priority==="high"?"orange":"blue",children:["âš¡ ",o.priority]}),o.category&&e.jsxs(Ze,{color:o.category==="mind"?"blue":o.category==="body"?"green":"purple",children:[o.category==="mind"?"ðŸ§ ":o.category==="body"?"ðŸ’ª":"âœ¨"," ",o.category]}),o.context&&e.jsxs(Ze,{color:"secondary",children:["ðŸ“ @",o.context]}),o.energyLevel!=="medium"&&e.jsxs(Ze,{color:o.energyLevel==="low"?"gray":"yellow",children:[o.energyLevel==="low"?"ðŸ˜´":"âš¡"," ",o.energyLevel," energy"]}),o.frequency&&e.jsxs(Ze,{color:"purple",children:["ðŸ“Š ",o.frequency]}),o.customDays&&e.jsxs(Ze,{color:"purple",children:["ðŸ“… ",Ij(o.customDays)]}),o.isTopThree&&e.jsx(Ze,{color:"yellow",children:"â­ Top 3"}),o.reminderEnabled&&e.jsxs(Ze,{color:"blue",children:["ðŸ”” ",o.reminderMinutesBefore?`${o.reminderMinutesBefore}min before`:"reminder"]}),o.isBonus===!0&&e.jsx(Ze,{color:"yellow",children:"ðŸŽ Bonus"}),o.isBonus===!1&&e.jsx(Ze,{color:"primary",children:"âœ“ Required"}),o.isMilestone&&e.jsx(Ze,{color:"gold",children:"ðŸ† Milestone"}),o.xpReward&&e.jsxs(Ze,{color:"yellow",children:["âœ¨ ",o.xpReward," XP"]}),o.xpMultiplier&&e.jsxs(Ze,{color:"yellow",children:["âœ¨ ",o.xpMultiplier,"x XP"]}),o.paused===!0&&e.jsx(Ze,{color:"orange",children:"â¸ï¸ Pause"}),o.paused===!1&&e.jsx(Ze,{color:"green",children:"â–¶ï¸ Resume"}),o.archived===!0&&e.jsx(Ze,{color:"gray",children:"ðŸ“¦ Archive"}),o.newTitle&&e.jsxs(Ze,{color:"primary",children:['âœï¸ "',o.newTitle,'"']}),o.triggerDecomposition&&e.jsx(Ze,{color:"blue",children:"ðŸ”€ Break down"}),o.notes&&e.jsx(Ze,{color:"secondary",children:"ðŸ“ Note added"}),o.clearAll&&e.jsx(Ze,{color:"destructive",children:"ðŸš« Reset all"}),o.clearTime&&!o.clearAll&&e.jsx(Ze,{color:"destructive",children:"ðŸš« Remove time"}),o.clearDate&&!o.clearAll&&e.jsx(Ze,{color:"destructive",children:"ðŸš« Remove date"}),o.clearDuration&&!o.clearAll&&e.jsx(Ze,{color:"destructive",children:"ðŸš« Remove duration"}),o.clearRecurrence&&!o.clearAll&&e.jsx(Ze,{color:"destructive",children:"ðŸš« Remove repeat"}),o.clearCategory&&!o.clearAll&&e.jsx(Ze,{color:"destructive",children:"ðŸš« Remove category"}),o.clearPriority&&!o.clearAll&&e.jsx(Ze,{color:"destructive",children:"ðŸš« Remove priority"}),o.clearNotes&&!o.clearAll&&e.jsx(Ze,{color:"destructive",children:"ðŸš« Remove notes"}),o.clearReminder&&!o.clearAll&&e.jsx(Ze,{color:"destructive",children:"ðŸš« Remove reminder"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(U,{variant:"ghost",size:"sm",onClick:()=>{l(),r(!1)},className:"flex-1",children:"Cancel"}),e.jsxs(U,{size:"sm",onClick:h,disabled:!p,className:"flex-1 gap-1",children:[e.jsx(Pt,{className:"h-3 w-3"}),"Apply"]})]})]}):e.jsxs(U,{variant:"ghost",size:"sm",onClick:()=>r(!0),className:"w-full justify-start text-muted-foreground hover:text-foreground gap-2",children:[e.jsx(pe,{className:"h-4 w-4"}),"Quick edit with natural language..."]})}function Ze({children:t,color:s}){const r={primary:"bg-primary/10 text-primary",accent:"bg-accent/50 text-accent-foreground",secondary:"bg-secondary text-secondary-foreground",green:"bg-green-500/20 text-green-600 dark:text-green-400",red:"bg-red-500/20 text-red-600 dark:text-red-400",purple:"bg-purple-500/20 text-purple-600 dark:text-purple-400",blue:"bg-blue-500/20 text-blue-600 dark:text-blue-400",orange:"bg-orange-500/20 text-orange-600 dark:text-orange-400",yellow:"bg-yellow-500/20 text-yellow-600 dark:text-yellow-400",gold:"bg-amber-500/20 text-amber-600 dark:text-amber-400",gray:"bg-muted text-muted-foreground",destructive:"bg-destructive/20 text-destructive"};return e.jsx("span",{className:A("inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs",r[s]||r.secondary),children:t})}function Ij(t){const s=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return t.map(r=>s[r]).join(", ")}const _p=["M","T","W","T","F","S","S"],Lj=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],qj=[{value:"daily",label:"Daily",days:[0,1,2,3,4,5,6]},{value:"5x_week",label:"Weekdays",days:[0,1,2,3,4]},{value:"weekly",label:"Weekly",days:[0]},{value:"custom",label:"Custom",days:[]}];function jp({frequency:t,customDays:s,onFrequencyChange:r}){const a=t==="weekly"||t==="custom",i=l=>{r(l.value,l.days)},o=l=>{const c=s.includes(l)?s.filter(d=>d!==l):[...s,l].sort((d,m)=>d-m);r(t,c)};return e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-[10px] text-muted-foreground block",children:"Frequency"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:qj.map(l=>e.jsx("button",{type:"button",onClick:()=>i(l),className:A("px-2 py-1 text-xs rounded-full border transition-all",t===l.value?"bg-primary text-primary-foreground border-primary":"bg-background border-border text-muted-foreground hover:border-primary/50"),children:l.label},l.value))}),a&&e.jsx("div",{className:"flex gap-1 pt-1",children:_p.map((l,c)=>e.jsx("button",{type:"button",onClick:()=>o(c),title:Lj[c],className:A("w-7 h-7 rounded-full text-[10px] font-bold transition-all border",s.includes(c)?"bg-primary border-primary text-primary-foreground":"border-border bg-background text-muted-foreground hover:border-primary/50"),children:l},c))})]})}function Np(t){switch(t){case"daily":return[0,1,2,3,4,5,6];case"weekdays":case"5x_week":return[0,1,2,3,4];case"weekly":return[0];default:return[]}}function Oj(t){return!t||t.length===0||t.length===7?"":t.map(s=>_p[s]).join("")}const rc={mind:{icon:Ss,label:"Mind",color:"text-blue-500 border-blue-500/50 bg-blue-500/10"},body:{icon:Xi,label:"Body",color:"text-green-500 border-green-500/50 bg-green-500/10"},soul:{icon:Gt,label:"Soul",color:"text-orange-500 border-orange-500/50 bg-orange-500/10"}},Fj=n.memo(function({ritual:s,open:r,onOpenChange:a,onSaveComplete:i,onDelete:o,isDeleting:l}){const{user:c}=be(),d=Ae(),[m,p]=n.useState(""),[h,f]=n.useState(""),[u,g]=n.useState("daily"),[y,b]=n.useState(null),[v,x]=n.useState(""),[w,j]=n.useState("medium"),[D,C]=n.useState("soul"),[_,N]=n.useState(null),[E,k]=n.useState([]),[P,T]=n.useState(!1),[I,R]=n.useState(15),[L,$]=n.useState(!1),[q,F]=n.useState(!1),[H,J]=n.useState(!1);n.useEffect(()=>{s&&(p(s.title),f(s.description||""),g(s.frequency||"daily"),b(s.estimated_minutes||null),x(s.preferred_time||""),j(s.difficulty||"medium"),C(s.category||"soul"),N(s.recurrence_pattern||null),k(s.recurrence_days||s.custom_days||[]),T(s.reminder_enabled||!1),R(s.reminder_minutes_before||15),$(!!s.recurrence_pattern||!!s.reminder_enabled||!!s.category))},[s]);const G=K=>{if(K.clearAll){x(""),b(null),N(null),k([]),T(!1);return}K.newTitle?p(K.newTitle):K.text&&K.text!==m&&p(K.text),K.scheduledTime&&x(K.scheduledTime),K.estimatedDuration&&b(K.estimatedDuration),K.difficulty&&j(K.difficulty),K.recurrencePattern&&N(K.recurrencePattern),K.category&&C(K.category),K.customDays&&k(K.customDays),K.reminderEnabled&&(T(!0),K.reminderMinutesBefore&&R(K.reminderMinutesBefore)),K.clearTime&&x(""),K.clearDuration&&b(null),K.clearRecurrence&&(N(null),k([])),K.clearCategory&&C("soul"),K.clearReminder&&T(!1)},re=async()=>{if(!(!s||!c?.id||!m.trim())){F(!0);try{const K={title:m.trim(),description:h.trim()||null,frequency:u,estimated_minutes:y,difficulty:w,preferred_time:v||null,category:D,custom_days:E.length>0?E:null},xe={task_text:m.trim(),difficulty:w,scheduled_time:v||null,estimated_duration:y,category:D,recurrence_pattern:_,recurrence_days:E,reminder_enabled:P,reminder_minutes_before:I},{error:Te}=await S.from("habits").update(K).eq("id",s.habitId).eq("user_id",c.id);if(Te){console.error("Error updating habit:",Te),W.error("Failed to update ritual template");return}const{error:Ne}=await S.from("daily_tasks").update(xe).eq("habit_source_id",s.habitId).eq("user_id",c.id).eq("completed",!1);Ne?(console.error("Error updating linked tasks:",Ne),W.warning("Ritual updated, but some task instances may not have synced")):W.success("Ritual updated everywhere!"),d.invalidateQueries({queryKey:["habits"]}),d.invalidateQueries({queryKey:["daily-tasks"]}),d.invalidateQueries({queryKey:["epics"]}),d.invalidateQueries({queryKey:["habit-surfacing"]}),d.invalidateQueries({queryKey:["epic-progress"]}),i?.(),a(!1)}catch(K){console.error("Error saving ritual:",K),W.error("Failed to save changes")}finally{F(!1)}}},ie=async()=>{!s||!o||(await o(s.habitId),J(!1),a(!1))};return e.jsxs(vo,{open:r,onOpenChange:a,children:[e.jsxs(Bn,{side:"bottom",className:"h-[85vh] rounded-t-xl",children:[e.jsxs(Fm,{className:"pb-2",children:[e.jsxs(Un,{className:"flex items-center gap-2",children:[e.jsx(Rr,{className:"h-5 w-5 text-accent"}),"Edit Ritual"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Changes sync to all instances of this ritual"})]}),e.jsx(On,{className:"h-[calc(85vh-140px)] pr-4",children:e.jsxs("div",{className:"space-y-6 py-4","data-vaul-no-drag":!0,children:[e.jsx(Rj,{onApply:G}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(at,{htmlFor:"title",children:"Ritual Name"}),e.jsx(ot,{id:"title",value:m,onChange:K=>p(K.target.value),placeholder:"What's your ritual?"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(at,{htmlFor:"description",children:"Description"}),e.jsx(Kt,{id:"description",value:h,onChange:K=>f(K.target.value),placeholder:"What does this ritual involve? Add details about how to perform it, timing, or any tips...",rows:3}),!h&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Add details about what this ritual involves - this was drafted when you created your campaign"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(at,{children:"Difficulty"}),e.jsx(kj,{value:w,onChange:j})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(at,{htmlFor:"time",children:"Scheduled Time"}),e.jsx(ot,{id:"time",type:"time",value:v,onChange:K=>x(K.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(at,{htmlFor:"duration",children:"Duration (min)"}),e.jsx(ot,{id:"duration",type:"number",value:y||"",onChange:K=>b(K.target.value?parseInt(K.target.value):null),placeholder:"30",min:"1"})]})]}),e.jsx(jp,{frequency:u==="3x_week"?"custom":u,customDays:E,onFrequencyChange:(K,xe)=>{g(K),k(xe)}}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(at,{children:"Attribute Boost"}),e.jsx("div",{className:"flex gap-2",children:Object.keys(rc).map(K=>{const xe=rc[K],Te=xe.icon;return e.jsxs(U,{type:"button",variant:"outline",size:"sm",onClick:()=>C(K),className:A("flex-1 gap-2",D===K&&xe.color),children:[e.jsx(Te,{className:"h-4 w-4"}),xe.label]},K)})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Which companion attribute grows when you complete this ritual"})]}),e.jsxs("div",{className:"pt-2",children:[e.jsxs(U,{variant:"ghost",size:"sm",onClick:()=>$(!L),className:"w-full justify-between text-muted-foreground",children:["Advanced Options",e.jsx("span",{className:"text-xs",children:L?"â–²":"â–¼"})]}),L&&e.jsx("div",{className:"mt-4",children:e.jsx(yo,{scheduledTime:v||null,estimatedDuration:y,recurrencePattern:_,recurrenceDays:E,reminderEnabled:P,reminderMinutesBefore:I,moreInformation:null,onScheduledTimeChange:x,onEstimatedDurationChange:b,onRecurrencePatternChange:N,onRecurrenceDaysChange:k,onReminderEnabledChange:T,onReminderMinutesBeforeChange:R,onMoreInformationChange:()=>{},location:null,onLocationChange:()=>{},hideRecurrence:!0})})]}),o&&e.jsx("div",{className:"pt-6 mt-4 border-t border-border/50",children:e.jsxs(U,{variant:"ghost",onClick:()=>J(!0),disabled:l||q,className:"w-full text-destructive hover:text-destructive hover:bg-destructive/10",children:[e.jsx($s,{className:"w-4 h-4 mr-2"}),"Delete Ritual"]})})]})}),e.jsxs($m,{className:"pt-4 flex gap-2",children:[e.jsx(U,{variant:"outline",className:"flex-1",onClick:()=>a(!1),disabled:q,children:"Cancel"}),e.jsx(U,{className:"flex-1",onClick:re,disabled:q||!m.trim(),children:q?e.jsxs(e.Fragment,{children:[e.jsx(bt,{className:"w-4 h-4 mr-2 animate-spin"}),"Saving..."]}):"Save Changes"})]})]}),e.jsx(Aa,{open:H,onOpenChange:J,children:e.jsxs(Ur,{children:[e.jsxs(zr,{children:[e.jsx(Kr,{children:"Delete this ritual?"}),e.jsxs(Wr,{children:['This will permanently delete "',s?.title,'" and remove all future instances. Completed tasks will remain in your history.']})]}),e.jsxs(Qr,{children:[e.jsx(Gr,{children:"Cancel"}),e.jsx(or,{onClick:ie,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:l?"Deleting...":"Delete"})]})]})})]})}),jo=120*1e3,No=1800*1e3,$j="Network error. Please check your connection and try again.",Hj=`
  *,
  epics(title),
  contact:contacts!contact_id(id, name, avatar_url),
  subtasks(id, title, completed, sort_order),
  task_attachments(id, task_id, file_url, file_path, file_name, mime_type, file_size_bytes, is_image, sort_order, created_at)
`,Bj=`
  *,
  epics(title),
  contact:contacts!contact_id(id, name, avatar_url),
  subtasks(id, title, completed, sort_order)
`,ko=(t,s)=>["daily-tasks",t,s],Co=async(t,s)=>{const r=o=>S.from("daily_tasks").select(o).eq("user_id",t).eq("task_date",s).order("sort_order",{ascending:!0}).order("created_at",{ascending:!1});let{data:a,error:i}=await r(Hj);if(Qj(i)&&(console.warn("daily_tasks query could not embed task_attachments, retrying without attachments relation"),{data:a,error:i}=await r(Bj)),i)throw zj(i)?(console.warn("Failed to fetch daily tasks (network):",{message:i.message}),new Error($j)):(console.error("Failed to fetch daily tasks:",i),i);return(a||[]).map(o=>({...o,epic_title:o.epics?.title||null,contact:o.contact,subtasks:(o.subtasks??[]).slice().sort((l,c)=>(l.sort_order??Number.MAX_SAFE_INTEGER)-(c.sort_order??Number.MAX_SAFE_INTEGER)),attachments:(o.task_attachments??[]).slice().sort((l,c)=>(l.sort_order??Number.MAX_SAFE_INTEGER)-(c.sort_order??Number.MAX_SAFE_INTEGER)).map(l=>({id:l.id,taskId:l.task_id,fileUrl:l.file_url,filePath:l.file_path,fileName:l.file_name,mimeType:l.mime_type,fileSizeBytes:l.file_size_bytes,isImage:l.is_image,sortOrder:l.sort_order??void 0,createdAt:l.created_at}))}))},Uj=(t,s={})=>{const{user:r}=be(),{enabled:a=!0}=s,i=t?te(t,"yyyy-MM-dd"):te(new Date,"yyyy-MM-dd"),{data:o=[],isLoading:l,error:c}=Ee({queryKey:ko(r?.id,i),queryFn:async()=>{if(!r?.id)throw new Error("User not authenticated");return Co(r.id,i)},enabled:a&&!!r?.id,staleTime:jo,gcTime:No,placeholderData:p=>p,refetchOnWindowFocus:!1}),d=o.filter(p=>p.completed).length,m=o.length;return{tasks:o,isLoading:l,error:c,taskDate:i,completedCount:d,totalCount:m}};function zj(t){const s=t?.message?.toLowerCase()??"";return s.includes("load failed")||s.includes("failed to fetch")||s.includes("network request failed")||s.includes("typeerror: failed to fetch")}function Qj(t){if(!t)return!1;const s=(t.code??"").toUpperCase(),r=`${t.message??""} ${t.details??""} ${t.hint??""}`.toLowerCase();return r.includes("task_attachments")&&(s.startsWith("PGRST")||r.includes("relationship")||r.includes("embed")||r.includes("could not find"))}const Kj=xd("WidgetData",{web:()=>ke(()=>import("./WidgetDataWeb-12a7qG7b.js"),__vite__mapDeps([16,1,2,3])).then(t=>new t.WidgetDataWeb)}),Wj=(t,s,r={})=>{const{enabled:a=!0}=r,i=n.useRef(""),o=n.useRef(()=>{}),l=n.useRef(!1),d=nt.isNativePlatform()&&nt.getPlatform()==="ios"&&Vj("WidgetData"),m=n.useCallback(async(p=!1)=>{if(!a||l.current||!d)return;const h=Yj();if(s!==h)return;const f=t.filter(b=>!b.habit_source_id),u=t.filter(b=>!!b.habit_source_id),g=f.slice(0,10).map(b=>({id:b.id,text:b.task_text,completed:b.completed??!1,xpReward:b.xp_reward,isMainQuest:b.is_main_quest??!1,category:b.category,section:Gj(b.scheduled_time),scheduledTime:b.scheduled_time})),y=JSON.stringify({date:s,tasks:g,questCount:f.length,questCompleted:f.filter(b=>!!b.completed).length,ritualCount:u.length,ritualCompleted:u.filter(b=>!!b.completed).length});if(!(!p&&y===i.current))try{await Kj.updateWidgetData({tasks:g,completedCount:f.filter(b=>!!b.completed).length,totalCount:f.length,ritualCount:u.length,ritualCompleted:u.filter(b=>!!b.completed).length,date:s}),i.current=y}catch(b){if(Xj(b)){l.current=!0,console.info("[WidgetSync] WidgetData plugin unavailable at runtime; disabling widget sync for this session.");return}console.error("[WidgetSync] Failed to sync:",b)}},[a,d,s,t]);return n.useEffect(()=>{o.current=m},[m]),n.useEffect(()=>{a&&m()},[a,m]),n.useEffect(()=>{if(!a||!d)return;const p=setTimeout(()=>{o.current(!0)},500);return()=>clearTimeout(p)},[a,d]),n.useEffect(()=>{if(!a||!d)return;const p=Dr.addListener("appStateChange",({isActive:h})=>{h&&o.current(!0)});return()=>{p.then(h=>h.remove())}},[a,d]),{syncToWidget:m}};function Gj(t){if(!t)return"unscheduled";const s=parseInt(t.split(":")[0],10);return s<12?"morning":s<17?"afternoon":"evening"}function Yj(t=new Date){const s=t.getFullYear(),r=String(t.getMonth()+1).padStart(2,"0"),a=String(t.getDate()).padStart(2,"0");return`${s}-${r}-${a}`}function Vj(t){const s=nt.isPluginAvailable;return typeof s=="function"?s(t):!1}function Xj(t){const s=typeof t=="object"&&t!==null&&"code"in t?String(t.code??""):"",r=typeof t=="string"?t:t instanceof Error?t.message:typeof t=="object"&&t!==null&&"message"in t?String(t.message??""):"";return s.toUpperCase()==="UNIMPLEMENTED"||r.toUpperCase().includes("UNIMPLEMENTED")}const Jj=(t,s={})=>{const{enabled:r=!0}=s,{tasks:a,isLoading:i,taskDate:o,completedCount:l,totalCount:c}=Uj(t,{enabled:r});Wj(a,o,{enabled:r});const{addTask:d,toggleTask:m,deleteTask:p,setMainQuest:h,updateTask:f,reorderTasks:u,moveTaskToSection:g,moveTaskToDate:y,restoreTask:b,isAdding:v,isToggling:x,isDeleting:w,isUpdating:j,isReordering:D,isMoving:C,isMovingDate:_,isRestoring:N}=Km(o);return{tasks:a,isLoading:i,addTask:d,toggleTask:m,deleteTask:p,setMainQuest:h,updateTask:f,reorderTasks:u,moveTaskToSection:g,moveTaskToDate:y,restoreTask:b,isAdding:v,isToggling:x,isDeleting:w,isUpdating:j,isReordering:D,isMoving:C,isMovingDate:_,isRestoring:N,completedCount:l,totalCount:c}},Zj=(t,s,r={})=>{const{user:a}=be(),{enabled:i=!0}=r,o=()=>{{const f=ba(t),u=va(t),g=Od(f,{weekStartsOn:0}),y=Fd(u,{weekStartsOn:0});return{start:g,end:y}}},{start:l,end:c}=o(),d=te(l,"yyyy-MM-dd"),m=te(c,"yyyy-MM-dd"),{data:p=[],isLoading:h}=Ee({queryKey:["calendar-tasks",a?.id,d,m,s],queryFn:async()=>{if(!a?.id)throw new Error("User not authenticated");const{data:f,error:u}=await S.from("daily_tasks").select("*").eq("user_id",a.id).gte("task_date",d).lte("task_date",m).order("scheduled_time",{ascending:!0,nullsFirst:!1}).order("created_at",{ascending:!1});if(u)throw u;return f||[]},enabled:i&&!!a,staleTime:120*1e3,refetchOnWindowFocus:!1});return{tasks:p,isLoading:h}},ki=t=>{const s=t.toLowerCase(),r=["read","study","learn","course","book","lesson","tutorial","class","lecture","podcast","audiobook","article","research","education","work","meeting","email","project","deadline","task","report","present","schedule","agenda","calendar","productivity","efficient","prioritize","plan","organize","budget","finance","goal","track","review","prepare","declutter","sort","file","list","todo","checklist","write","journal","blog","code","program","develop","design","build","debug","test","deploy","website","app","software","think","analyze","solve","problem","puzzle","brain","mental","focus","concentrate","memory","memorize","practice","skill","improve","strategy","calculate","math","logic","critical","decision","language","spanish","french","german","japanese","chinese","korean","english","duolingo","vocabulary","grammar","fluent"],a=["exercise","workout","run","running","walk","walking","jog","jogging","gym","lift","weight","strength","cardio","hiit","crossfit","fitness","train","training","marathon","sprint","rep","set","warmup","cooldown","yoga","pilates","stretch","stretching","swim","swimming","bike","cycling","hike","hiking","climb","climbing","dance","dancing","sport","tennis","basketball","soccer","football","golf","martial","boxing","kickbox","push-up","pushup","sit-up","situp","squat","plank","burpee","lunge","deadlift","bench","curl","crunch","jumping","step","abs","core","eat","meal","breakfast","lunch","dinner","snack","cook","cooking","diet","nutrition","protein","vegetable","fruit","healthy","calorie","fast","fasting","keto","vegan","portion","prep","recipe","sleep","rest","nap","hydrate","water","vitamin","supplement","health","doctor","dentist","medicine","checkup","therapy","physical","shower","hygiene","skincare","teeth","floss","brush","groom","posture","ergonomic","stand","move","active","steps","outdoor","recover","recovery","foam","massage","ice","heat","sauna"],i=["meditate","meditation","mindful","mindfulness","breathe","breathing","calm","peace","peaceful","quiet","stillness","present","aware","center","ground","zen","mantra","affirmation","pray","prayer","spiritual","soul","spirit","faith","worship","church","temple","mosque","scripture","bible","devotion","sacred","gratitude","grateful","thankful","appreciate","appreciation","bless","reflect","reflection","introspect","self-care","selfcare","healing","emotion","emotional","feel","feeling","mood","happy","joy","positive","anxiety","stress","cope","release","let go","forgive","accept","therapy","therapist","counseling","mental health","friend","family","partner","spouse","parent","child","loved","call","text","connect","connection","relationship","social","community","talk","listen","conversation","catch up","visit","hang out","date","help","volunteer","donate","give","giving","charity","serve","service","kindness","kind","compassion","empathy","care","support","encourage","art","artist","creative","create","paint","painting","draw","drawing","sketch","craft","diy","pottery","knit","sew","photography","photo","music","sing","singing","song","instrument","piano","guitar","drum","practice music","play music","compose","melody","perform","nature","garden","gardening","plant","flower","outdoor","park","beach","sunset","sunrise","stargazing","wildlife","bird","pet","dog","cat","relax","relaxation","unwind","hobby","fun","enjoy","pleasure","treat","spa","bath","candle","tea","cozy","comfort","movie","show","inspire","inspiration","dream","vision","purpose","meaning","value","intention","manifest","visualize","believe","hope","aspire","transform"],o=p=>p.filter(h=>h.includes(" ")?s.includes(h):new RegExp(`\\b${h}\\b|${h}s?\\b`,"i").test(s)).length,l=o(r),c=o(a),d=o(i),m=Math.max(l,c,d);return m===0?null:l===m?"mind":c===m?"body":d===m?"soul":null};function ac(t,s){switch(t.frequency?.toLowerCase()){case"daily":return!0;case"weekly":return t.custom_days&&t.custom_days.length>0?t.custom_days.includes(s):s===0;case"weekdays":case"5x_week":return s>=0&&s<=4;case"weekends":return s===5||s===6;case"3x_week":return t.custom_days&&t.custom_days.length>0?t.custom_days.includes(s):[0,2,4].includes(s);case"custom":return t.custom_days&&t.custom_days.length>0?t.custom_days.includes(s):!1;default:return!0}}function eN(t){const{user:s}=be(),r=Ae(),a=su(),i=Kg(),o=i===0?6:i-1,{data:l,isLoading:c,error:d}=Ee({queryKey:["habit-surfacing",s?.id,a],queryFn:async()=>{if(!s?.id)return[];const{data:f,error:u}=await S.from("habits").select(`
          id,
          title,
          description,
          difficulty,
          category,
          frequency,
          estimated_minutes,
          preferred_time,
          custom_days,
          epic_habits(epic_id, epics(id, title, status))
        `).eq("user_id",s.id).eq("is_active",!0);if(u)throw u;const{data:g,error:y}=await S.from("daily_tasks").select("id, habit_source_id, completed").eq("user_id",s.id).eq("task_date",a).not("habit_source_id","is",null);if(y)throw y;const b=new Map(g?.map(x=>[x.habit_source_id,x])||[]);return(f||[]).filter(x=>{const w=x.epic_habits?.[0],j=w?.epics;return!(w&&j&&j.status!=="active")}).map(x=>{const j=x.epic_habits?.[0]?.epics,D=b.get(x.id);return{id:x.id,habit_id:x.id,habit_name:x.title,habit_description:x.description||null,frequency:x.frequency||"daily",estimated_minutes:x.estimated_minutes||null,preferred_time:x.preferred_time||null,epic_id:j?.id||null,epic_title:j?.title||null,task_id:D?.id||null,is_completed:D?.completed||!1,category:ki(x.title),custom_days:x.custom_days||null}})},enabled:!!s?.id}),m=le({mutationFn:async f=>{if(!s?.id)throw new Error("Not authenticated");const u=l?.find(b=>b.habit_id===f);if(!u)throw new Error("Habit not found");if(u.task_id)return{id:u.task_id};const{data:g,error:y}=await S.from("daily_tasks").insert({user_id:s.id,task_text:u.habit_name,task_date:a,habit_source_id:f,epic_id:u.epic_id,category:ki(u.habit_name),source:"recurring",scheduled_time:u.preferred_time,estimated_duration:u.estimated_minutes}).select("id").single();if(y)throw y;return g},onSuccess:()=>{r.invalidateQueries({queryKey:["habit-surfacing"]}),r.invalidateQueries({queryKey:["tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),r.invalidateQueries({queryKey:["daily-tasks"]})}}),p=le({mutationFn:async()=>{if(!s?.id)throw new Error("Not authenticated");const f=l?.filter(w=>!w.task_id&&ac(w,o))||[];if(console.log("[Habit Surfacing] Habits to surface:",f.length,f),f.length===0)return console.log("[Habit Surfacing] No habits need surfacing"),[];const u=f.map(w=>({user_id:s.id,task_text:w.habit_name,task_date:a,habit_source_id:w.habit_id,epic_id:w.epic_id,category:ki(w.habit_name),source:"recurring",scheduled_time:w.preferred_time,estimated_duration:w.estimated_minutes})),{data:g}=await S.from("daily_tasks").select("habit_source_id").eq("user_id",s.id).eq("task_date",a).not("habit_source_id","is",null),y=new Set(g?.map(w=>w.habit_source_id)||[]),b=u.filter(w=>!y.has(w.habit_source_id));if(console.log("[Habit Surfacing] Inserting new tasks:",b.length,"of",u.length),b.length===0)return console.log("[Habit Surfacing] All habits already have tasks for today"),[];const{data:v,error:x}=await S.from("daily_tasks").insert(b).select("id");if(x)throw console.error("[Habit Surfacing] Insert error:",x),x;return console.log("[Habit Surfacing] Successfully surfaced",v?.length,"habits"),v},onSuccess:f=>{r.invalidateQueries({queryKey:["habit-surfacing"]}),r.invalidateQueries({queryKey:["tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),r.invalidateQueries({queryKey:["daily-tasks"]}),f&&f.length>0&&W.success(`${f.length} ritual${f.length>1?"s":""} added to today's quests`)},onError:f=>{console.error("[Habit Surfacing] Mutation error:",f),W.error("Failed to surface habits as quests")}}),h=l?.filter(f=>!f.task_id&&ac(f,o)).length||0;return{surfacedHabits:l||[],isLoading:c,error:d,surfaceHabit:m.mutate,surfaceAllEpicHabits:p.mutate,surfaceAllHabits:p.mutate,unsurfacedEpicHabitsCount:h,unsurfacedHabitsCount:h}}function tN(t){const{user:s}=be(),r=Ae(),a=te(t||new Date,"yyyy-MM-dd"),i=Vf(t||new Date),{data:o,isLoading:l}=Ee({queryKey:["recurring-templates",s?.id,a],queryFn:async()=>{if(!s?.id)return[];const{data:d,error:m}=await S.from("daily_tasks").select(`
          id,
          task_text,
          difficulty,
          scheduled_time,
          estimated_duration,
          category,
          recurrence_pattern,
          recurrence_days,
          recurrence_end_date,
          xp_reward,
          epic_id,
          reminder_enabled,
          reminder_minutes_before
        `).eq("user_id",s.id).eq("is_recurring",!0).not("recurrence_pattern","is",null);if(m)throw m;const{data:p,error:h}=await S.from("daily_tasks").select("parent_template_id, task_text").eq("user_id",s.id).eq("task_date",a);if(h)throw h;const f=new Set(p?.filter(y=>y.parent_template_id).map(y=>y.parent_template_id)),u=new Set(p?.map(y=>y.task_text.toLowerCase()));return(d||[]).filter(y=>{if(f.has(y.id)||u.has(y.task_text.toLowerCase()))return!1;if(y.recurrence_end_date){const b=ps(y.recurrence_end_date);if((t||new Date)>b)return!1}return sN(y,i)})},enabled:!!s?.id}),c=le({mutationFn:async()=>{if(!s?.id||!o?.length)return[];const d=o.map(h=>({user_id:s.id,task_text:h.task_text,task_date:a,difficulty:h.difficulty,scheduled_time:h.scheduled_time,estimated_duration:h.estimated_duration,category:h.category,xp_reward:h.xp_reward,epic_id:h.epic_id,reminder_enabled:h.reminder_enabled,reminder_minutes_before:h.reminder_minutes_before,parent_template_id:h.id,source:"recurring",is_recurring:!1})),{data:m,error:p}=await S.from("daily_tasks").upsert(d,{onConflict:"user_id,task_date,parent_template_id",ignoreDuplicates:!0}).select("id");if(p)throw p;return m},onSuccess:d=>{r.invalidateQueries({queryKey:["recurring-templates"]}),r.invalidateQueries({queryKey:["tasks"]}),r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),d&&d.length>0&&console.log(`[RecurringSpawner] Spawned ${d.length} recurring tasks for ${a}`)},onError:d=>{console.error("[RecurringSpawner] Failed to spawn recurring tasks:",d),W.error("Failed to create recurring quests")}});return{pendingRecurringCount:o?.length||0,isLoading:l,spawnRecurringTasks:c.mutate,isSpawning:c.isPending}}function sN(t,s){const r=t.recurrence_pattern?.toLowerCase();if(!r)return!1;switch(r){case"daily":return!0;case"weekly":return t.recurrence_days&&t.recurrence_days.length>0?t.recurrence_days.includes(s):!0;case"weekdays":return s>=1&&s<=5;case"weekends":return s===0||s===6;case"custom":return t.recurrence_days&&t.recurrence_days.length>0?t.recurrence_days.includes(s):!1;default:return!!(r.includes("daily")||r.includes("day"))}}function rN(){const{user:t}=be(),{toast:s}=Ms(),r=Ae(),{data:a,isLoading:i}=Ee({queryKey:["streak-at-risk",t?.id],queryFn:async()=>{if(!t?.id)return null;const{data:l,error:c}=await S.from("profiles").select("streak_at_risk, streak_at_risk_since, current_habit_streak, streak_freezes_available").eq("id",t.id).maybeSingle();return c?(console.error("Error fetching streak at risk:",c),null):{streak_at_risk:l.streak_at_risk??!1,streak_at_risk_since:l.streak_at_risk_since,current_habit_streak:l.current_habit_streak??0,streak_freezes_available:l.streak_freezes_available??0}},enabled:!!t?.id,staleTime:3e4}),o=le({mutationFn:async l=>{const{data:c,error:d}=await S.functions.invoke("resolve-streak-freeze",{body:{action:l}});if(d)throw d;return c},onSuccess:(l,c)=>{r.invalidateQueries({queryKey:["streak-at-risk"]}),r.invalidateQueries({queryKey:["profile"]}),s(c==="use_freeze"?{title:"Streak Preserved! â„ï¸",description:`Your ${l.newStreak}-day streak is safe. ${l.freezesRemaining} freeze${l.freezesRemaining===1?"":"s"} remaining.`}:{title:"Fresh Start",description:"Your streak has been reset. Time to build a new one!"})},onError:l=>{console.error("Error resolving streak:",l),s({title:"Error",description:"Failed to process your choice. Please try again.",variant:"destructive"})}});return{needsStreakDecision:a?.streak_at_risk??!1,currentStreak:a?.current_habit_streak??0,freezesAvailable:a?.streak_freezes_available??0,streakAtRiskSince:a?.streak_at_risk_since,isLoading:i,useFreeze:()=>o.mutateAsync("use_freeze"),resetStreak:()=>o.mutateAsync("reset_streak"),isResolving:o.isPending}}const aN=2,nN=["Create Your First Quest ðŸŽ¯","Create Your First Quest","Complete Your First Quest âœ…","Complete Your First Quest","Meet Your Companion âœ¨","Meet Your Companion","Morning Check-in ðŸŒ…","Morning Check-in","Create Your First Campaign ðŸš€","Create Your First Campaign","Listen to Your Mentor ðŸŽ§","Listen to Your Mentor"],iN=[2,3,4],oN=t=>`onboarding_task_cleanup_version_${aN}_${t}`;function lN(t,s,r=!1){const a=Ae(),i=n.useRef(!1);n.useEffect(()=>{if(r||!t||!s)return;const o=oN(t);rt.getItem(o)==="true"||i.current||(i.current=!0,(async()=>{try{const{error:c}=await S.from("daily_tasks").delete().eq("user_id",t).eq("source","onboarding");if(c){console.error("[OnboardingCleanup] Failed to delete onboarding-source tasks:",c);return}const{error:d}=await S.from("daily_tasks").delete().eq("user_id",t).in("task_text",[...nN]).eq("difficulty","easy").eq("is_main_quest",!1).in("xp_reward",[...iN]);if(d){console.error("[OnboardingCleanup] Failed to delete legacy tutorial-title tasks:",d);return}rt.setItem(o,"true"),a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]})}finally{i.current=!1}})())},[s,r,a,t])}function So(){const{user:t}=be(),s=n.useCallback(async l=>{if(!t)return;const{interactionType:c,inputText:d,detectedIntent:m,aiResponse:p,userAction:h,modifications:f}=l;try{const{data:{session:u}}=await S.auth.getSession();if(!u||u.user.id!==t.id)return;const{error:g}=await S.from("ai_interactions").insert({user_id:t.id,interaction_type:c,input_text:d,detected_intent:m,ai_response:p,user_action:h,modifications:f});if(g){console.warn("Failed to track interaction (non-blocking):",g.message);return}await r(t.id,h)}catch(u){console.warn("Error tracking interaction (non-blocking):",u)}},[t]),r=async(l,c)=>{try{const{data:d}=await S.from("user_ai_learning").select("interaction_count, acceptance_rate, modification_rate").eq("user_id",l).maybeSingle();if(!d){await S.from("user_ai_learning").insert({user_id:l,interaction_count:1,acceptance_rate:c==="accepted"?100:0,modification_rate:c==="modified"?100:0,last_interaction_at:new Date().toISOString()});return}const m=(d.interaction_count||0)+1,p=d.acceptance_rate||0,h=d.modification_rate||0,f=c==="accepted"?(p*(m-1)+100)/m:p*(m-1)/m,u=c==="modified"?(h*(m-1)+100)/m:h*(m-1)/m;await S.from("user_ai_learning").update({interaction_count:m,acceptance_rate:Math.round(f*100)/100,modification_rate:Math.round(u*100)/100,last_interaction_at:new Date().toISOString()}).eq("user_id",l)}catch(d){console.error("Error updating learning from action:",d)}},a=n.useCallback(async l=>{if(!t)return;const{storyType:c,themeColor:d,category:m,epicDuration:p,habitDifficulty:h,habitFrequency:f,wasSuccessful:u}=l;try{const{data:g}=await S.from("user_ai_learning").select("preference_weights, successful_patterns, failed_patterns, common_contexts").eq("user_id",t.id).maybeSingle(),y=g?.preference_weights||{story_type:{},theme_color:{},categories:{}},b=g?.successful_patterns||{},v=g?.failed_patterns||{},x=g?.common_contexts||[],w=u?1:-.5;c&&(y.story_type=y.story_type||{},y.story_type[c]=(y.story_type[c]||0)+w),d&&(y.theme_color=y.theme_color||{},y.theme_color[d]=(y.theme_color[d]||0)+w),m&&!x.includes(m)&&x.push(m);const j=`${c||"none"}_${p||30}_${h||"medium"}`;u?b[j]=(b[j]||0)+1:v[j]=(v[j]||0)+1;const D={preference_weights:y,successful_patterns:b,failed_patterns:v,common_contexts:x.slice(-20),updated_at:new Date().toISOString()};u&&(p&&(D.preferred_epic_duration=p),h&&(D.preferred_habit_difficulty=h),f&&(D.preferred_habit_frequency=f)),await S.from("user_ai_learning").upsert({user_id:t.id,...D},{onConflict:"user_id"})}catch(g){console.error("Error updating preference weights:",g)}},[t]),i=n.useCallback(async(l,c)=>{if(t)try{const{data:d}=await S.from("epics").select("story_type_slug, theme_color, target_days").eq("id",l).maybeSingle();if(!d)return;const{data:m}=await S.from("epic_habits").select("habits(difficulty, frequency, category, custom_days)").eq("epic_id",l),p=m?.length?m.reduce((f,u)=>{const g=u.habits?.difficulty||"medium";return f+(g==="easy"?1:g==="medium"?2:3)},0)/m.length:2,h=p<1.5?"easy":p<2.5?"medium":"hard";await a({storyType:d.story_type_slug||void 0,themeColor:d.theme_color||void 0,epicDuration:d.target_days,habitDifficulty:h,wasSuccessful:c==="completed"})}catch(d){console.error("Error tracking epic outcome:",d)}},[t,a]),o=n.useCallback(async(l,c,d)=>{if(t)try{const{data:m}=await S.from("user_ai_learning").select("successful_patterns, failed_patterns, energy_by_hour, day_of_week_patterns").eq("user_id",t.id).maybeSingle(),p=m?.successful_patterns||{},h=m?.failed_patterns||{},f=m?.energy_by_hour||{},u=m?.day_of_week_patterns||{},g=c==="completed",y=new Date().toLocaleDateString("en-US",{weekday:"long"}).toLowerCase();if(d?.actualCompletionTime&&g){const x=d.actualCompletionTime.split(":")[0];f[x]=(f[x]||50)+5}else if(d?.scheduledTime&&!g){const x=d.scheduledTime.split(":")[0];f[x]=Math.max(0,(f[x]||50)-5)}const b=(u[`${y}_total`]||0)+1,v=(u[`${y}_success`]||0)+(g?1:0);if(u[`${y}_total`]=b,u[`${y}_success`]=v,u[y]=Math.round(v/b*100),d?.category){const x=`category_${d.category}`;g?p[x]=(p[x]||0)+1:h[x]=(h[x]||0)+1}if(d?.difficulty){const x=`difficulty_${d.difficulty}`;g?p[x]=(p[x]||0)+1:h[x]=(h[x]||0)+1}await S.from("user_ai_learning").upsert({user_id:t.id,successful_patterns:p,failed_patterns:h,energy_by_hour:f,day_of_week_patterns:u,updated_at:new Date().toISOString()},{onConflict:"user_id"})}catch(m){console.warn("Error tracking daily plan outcome (non-blocking):",m)}},[t]);return{trackInteraction:s,updatePreferenceWeights:a,trackEpicOutcome:i,trackDailyPlanOutcome:o}}const cN=t=>{const s=t?.toLowerCase()?.trim()||"medium";return["easy","simple","beginner","low"].includes(s)?"easy":["hard","difficult","advanced","high","challenging"].includes(s)?"hard":"medium"},dN=t=>{const s=t?.toLowerCase()?.trim()?.replace(/\s+/g,"_")||"daily";return["daily","everyday","every_day","7x_week","7x"].includes(s)?"daily":["5x_week","5x","weekdays","five_times","5_times"].includes(s)?"5x_week":["3x_week","3x","three_times","3_times","thrice"].includes(s)?"3x_week":["weekly","biweekly","twice","2x","2x_week","once","1x","custom","twice_daily"].includes(s)?"custom":"daily"},uN=t=>{if(!t)return"heroic";const s=t.toLowerCase().trim();return["heroic","warrior","mystic","nature","solar"].includes(s)?s:{"#f59e0b":"heroic","#ef4444":"warrior","#10b981":"nature","#ec4899":"mystic","#f97316":"solar","#8b5cf6":"mystic","#3b82f6":"heroic","#475569":"warrior"}[s]||"heroic"},mN=(t={})=>{const{user:s}=be(),r=Ae(),{awardCustomXP:a}=Xt(),{trackEpicOutcome:i}=So(),{enabled:o=!0}=t,{data:l,isLoading:c,error:d}=Ee({queryKey:["epics",s?.id],queryFn:async()=>{if(!s?.id)return[];const{data:y,error:b}=await S.from("epics").select(`
          *,
          epic_habits(
            habit_id,
            habits(id, title, difficulty, description, frequency, estimated_minutes, custom_days, preferred_time, category)
          )
        `).eq("user_id",s.id).order("created_at",{ascending:!1});if(b)throw console.error("Failed to fetch epics:",b),b;return y||[]},enabled:o&&!!s?.id,staleTime:180*1e3,refetchOnWindowFocus:!1,retry:2}),m=le({mutationFn:async y=>{const{data:{session:b},error:v}=await S.auth.getSession();if(v||!b?.user?.id)throw new Error("Not authenticated. Please refresh and try again.");const x=b.user.id;if(!y.habits||y.habits.length===0)throw new Error("Epic must have at least one habit");if(y.target_days<1||y.target_days>365)throw new Error("Target days must be between 1 and 365");let w=[],j=null;try{const{data:D,error:C}=await S.from("habits").insert(y.habits.map(T=>{const I=dN(T.frequency);let R=T.custom_days?.length>0?T.custom_days:null;return!R&&I!=="daily"&&(I==="5x_week"?R=[0,1,2,3,4]:I==="3x_week"?R=[0,2,4]:I==="custom"&&(R=[0])),{user_id:x,title:T.title,description:T.description||null,difficulty:cN(T.difficulty),frequency:I,custom_days:R,preferred_time:T.preferred_time||null,reminder_enabled:T.reminder_enabled||!1,reminder_minutes_before:T.reminder_minutes_before||15,estimated_minutes:T.estimated_minutes||null}})).select();if(C)throw console.error("Failed to create habits:",C),new Error(`Failed to create habits: ${C.message}`);if(!D||D.length===0)throw new Error("No habits were created");w=D;const _=`EPIC-${Math.random().toString(36).substring(2,10).toUpperCase()}`,{data:N,error:E}=await S.from("epics").insert({user_id:x,title:y.title,description:y.description,target_days:y.target_days,is_public:!0,xp_reward:Math.floor(y.target_days*10),invite_code:_,theme_color:uN(y.theme_color),story_type_slug:y.story_type_slug||null}).select().single();if(E)throw console.error("Failed to create epic:",E),await S.from("habits").delete().in("id",w.map(T=>T.id)),new Error(`Failed to create epic: ${E.message}`);if(!N)throw new Error("Epic creation returned no data");j=N;const{error:k}=await S.from("epic_habits").insert(w.map(T=>({epic_id:N.id,habit_id:T.id})));if(k)throw console.error("Failed to link habits:",k),await S.from("epics").delete().eq("id",N.id),await S.from("habits").delete().in("id",w.map(T=>T.id)),new Error(`Failed to link habits: ${k.message}`);if(y.phases&&y.phases.length>0){const{error:T}=await S.from("journey_phases").insert(y.phases.map(I=>({epic_id:N.id,user_id:x,name:I.name,description:I.description,start_date:I.start_date,end_date:I.end_date,phase_order:I.phase_order})));T&&console.error("Failed to create journey phases:",T)}let P=y.milestones;if((!P||P.length===0)&&y.story_type_slug){console.log("[Epic Creation] No milestones provided, generating defaults for story type:",y.story_type_slug);let T=5;y.target_days<=14?T=3:y.target_days<=30?T=4:y.target_days<=60?T=5:T=6;const I=new Date;P=Array.from({length:T},(R,L)=>{const $=Math.round((L+1)/T*100),q=Math.floor(y.target_days*$/100),F=new Date(I);return F.setDate(F.getDate()+q),{title:L===T-1?"The Finale":`Chapter ${L+1}`,description:L===T-1?"Complete your epic journey!":`Reach ${$}% of your goal`,target_date:F.toISOString().split("T")[0],milestone_percent:$,is_postcard_milestone:!0}})}if(P&&P.length>0){console.log("[Epic Creation] Inserting milestones:",P.length,P);const{data:T,error:I}=await S.from("epic_milestones").insert(P.map((R,L)=>({epic_id:N.id,user_id:x,title:R.title,description:R.description||null,target_date:R.target_date,milestone_percent:R.milestone_percent,is_postcard_milestone:R.is_postcard_milestone??!1,phase_order:L+1,phase_name:R.phase_name||R.phaseName||null}))).select();I?(console.error("Failed to create milestones:",I),W.error("Milestones couldn't be created",{description:"You can add them manually from the campaign settings"})):console.log("[Epic Creation] Successfully created milestones:",T?.length)}else console.log("[Epic Creation] No milestones to insert and no story type for fallback");if(y.story_type_slug){const[T,I]=await Promise.all([S.from("user_companion").select("spirit_animal, core_element, favorite_color, fur_color").eq("user_id",x).maybeSingle(),S.from("profiles").select("selected_mentor_id").eq("id",x).maybeSingle()]);let R;if(I.data?.selected_mentor_id){const{data:F}=await S.from("mentors").select("id, name, slug").eq("id",I.data.selected_mentor_id).maybeSingle();F&&(R={id:F.id,name:F.name,slug:F.slug||void 0})}const L=y.milestones?.filter(F=>F.is_postcard_milestone)||[],$=L.length||5,q=L.map((F,H)=>({chapterNumber:H+1,title:F.title,targetDate:F.target_date,milestonePercent:F.milestone_percent}));S.functions.invoke("generate-epic-narrative-seed",{body:{userId:x,epicId:N.id,epicTitle:y.title,epicDescription:y.description,targetDays:y.target_days,storyTypeSlug:y.story_type_slug,companionData:T.data||void 0,mentorData:R,userGoal:y.description,totalChapters:$,milestoneData:q}}).catch(F=>{console.error("Narrative seed generation failed:",F)}),S.functions.invoke("generate-journey-path",{body:{epicId:N.id,milestoneIndex:0,userId:x}}).catch(F=>{console.error("Initial journey path generation failed:",F)})}return N}catch(D){throw j&&S.from("epics").delete().eq("id",j.id).then(({error:C})=>{C&&console.error("Failed to cleanup epic:",C)}),w.length>0&&S.from("habits").delete().in("id",w.map(C=>C.id)).then(({error:C})=>{C&&console.error("Failed to cleanup habits:",C)}),D}},onSuccess:()=>{r.invalidateQueries({queryKey:["epics"]}),r.invalidateQueries({queryKey:["habits"]}),window.dispatchEvent(new CustomEvent("campaign-created")),W.success("Epic quest created! ðŸŽ¯",{description:"Your companion is excited for this legendary journey!"})},onError:y=>{console.error("Failed to create epic:",y),W.error("Failed to create epic")}}),p=le({mutationFn:async({epicId:y,status:b})=>{if(!s?.id)throw new Error("User not authenticated");const{data:v,error:x}=await S.from("epics").select("xp_reward, title, progress_percentage, status, user_id").eq("id",y).eq("user_id",s.id).maybeSingle();if(x)throw console.error("Failed to fetch epic:",x),new Error(`Failed to fetch epic: ${x.message}`);if(!v)throw new Error("Epic not found or you don't have permission");if(v.status==="completed"&&b==="completed")throw new Error("Epic is already completed");const{error:w}=await S.from("epics").update({status:b,completed_at:b==="completed"?new Date().toISOString():null}).eq("id",y).eq("user_id",s.id);if(w)throw w;if(b==="abandoned"){console.log("[Epic Abandon] Cleaning up rituals and milestones for epic:",y);const{data:j}=await S.from("epic_habits").select("habit_id").eq("epic_id",y);if(j&&j.length>0){const C=j.map(P=>P.habit_id);console.log("[Epic Abandon] Deactivating habits:",C);const{error:_}=await S.from("habits").update({is_active:!1}).in("id",C).eq("user_id",s.id);_&&console.error("Failed to deactivate habits:",_);const N=te(new Date,"yyyy-MM-dd"),{error:E}=await S.from("daily_tasks").delete().in("habit_source_id",C).gte("task_date",N).eq("completed",!1);E&&console.error("Failed to delete future habit tasks:",E);const{error:k}=await S.from("epic_habits").delete().eq("epic_id",y);k&&console.error("Failed to delete epic_habits links:",k)}const{error:D}=await S.from("epic_milestones").delete().eq("epic_id",y).eq("user_id",s.id);D&&console.error("Failed to delete milestones:",D),console.log("[Epic Abandon] Cleanup complete")}return{epic:v,status:b,wasAlreadyCompleted:v.status==="completed"}},onSuccess:async({epic:y,status:b,wasAlreadyCompleted:v},x)=>{if(r.invalidateQueries({queryKey:["epics"]}),r.invalidateQueries({queryKey:["habits"]}),r.invalidateQueries({queryKey:["habit-surfacing"]}),r.invalidateQueries({queryKey:["daily-tasks"]}),(b==="completed"||b==="abandoned")&&i(x.epicId,b).catch(w=>{console.error("Failed to track epic outcome:",w)}),b==="completed"&&!v){try{await a(y.xp_reward,"epic_complete",`Epic "${y.title}" Completed!`,{epic_id:x?.epicId})}catch(w){console.error("Failed to award epic completion XP:",w)}W.success("Epic Completed! ðŸ†",{description:`You've conquered the ${y.title} epic! Your companion grows stronger!`})}else b==="abandoned"&&W("Epic abandoned",{description:"You can always start a new epic when ready."})},onError:y=>{console.error("Failed to update epic:",y),W.error("Failed to update epic status")}}),h=le({mutationFn:async({epicId:y,habitId:b})=>{if(!y||!b)throw new Error("Invalid epic or habit ID");const{data:v}=await S.from("epic_habits").select("id").eq("epic_id",y).eq("habit_id",b).maybeSingle();if(v)throw new Error("Habit is already linked to this epic");const{error:x}=await S.from("epic_habits").insert({epic_id:y,habit_id:b});if(x)throw console.error("Failed to link habit to epic:",x),x},onSuccess:()=>{r.invalidateQueries({queryKey:["epics"]}),W.success("Habit linked to epic! âš”ï¸")},onError:y=>{console.error("Failed to link habit:",y),W.error("Failed to link habit to epic")}}),f=le({mutationFn:async({epicId:y,habitId:b})=>{if(!y||!b)throw new Error("Invalid epic or habit ID");const{error:v}=await S.from("epic_habits").delete().eq("epic_id",y).eq("habit_id",b);if(v)throw console.error("Failed to remove habit from epic:",v),v},onSuccess:()=>{r.invalidateQueries({queryKey:["epics"]}),W("Habit removed from epic")},onError:y=>{console.error("Failed to remove habit:",y),W.error("Failed to remove habit from epic")}}),u=l?.filter(y=>y.status==="active")||[],g=l?.filter(y=>y.status==="completed")||[];return{epics:l||[],activeEpics:u,completedEpics:g,isLoading:c,error:d,createEpic:m.mutateAsync,isCreating:m.isPending,isCreateSuccess:m.isSuccess,updateEpicStatus:p.mutate,addHabitToEpic:h.mutate,removeHabitFromEpic:f.mutate}};function pN({open:t,onOpenChange:s,tasks:r,selectedDate:a,onComplete:i}){const[o,l]=n.useState(""),[c,d]=n.useState(!1),m=Ae(),p=n.useMemo(()=>r.filter(u=>!u.completed),[r]),h=n.useMemo(()=>{const g=new Date().getHours(),y=[];return p.length>3&&g>14&&y.push({icon:e.jsx(At,{className:"h-4 w-4"}),label:"Focus on top 3",prompt:"Keep only the 3 most important remaining tasks for today and move the rest to tomorrow"}),p.length>0&&y.push({icon:e.jsx(Ft,{className:"h-4 w-4"}),label:"Push all by 1 hour",prompt:"Push all remaining tasks back by 1 hour"}),p.length>2&&y.push({icon:e.jsx($t,{className:"h-4 w-4"}),label:"Move rest to tomorrow",prompt:"Move all remaining incomplete tasks to tomorrow"}),y.push({icon:e.jsx(pe,{className:"h-4 w-4"}),label:"Reschedule smarter",prompt:"Reorganize the remaining tasks based on current time and energy optimization"}),y.slice(0,4)},[p]),f=async u=>{if(u.trim()){d(!0);try{const g=te(a,"yyyy-MM-dd"),{data:y,error:b}=await S.functions.invoke("adjust-saved-daily-plan",{body:{planDate:g,adjustmentRequest:u,currentTasks:p.map(v=>({id:v.id,title:v.task_text,scheduledTime:v.scheduled_time}))}});if(b)throw b;if(y?.adjustments&&Array.isArray(y.adjustments)){let v=0;for(const x of y.adjustments)if(x.action==="update"&&x.taskId&&x.updates){const w={...x.updates};if(Object.prototype.hasOwnProperty.call(w,"task_date")||Object.prototype.hasOwnProperty.call(w,"scheduled_time")){const{data:j,error:D}=await S.from("daily_tasks").select("task_date, scheduled_time, habit_source_id, source").eq("id",x.taskId).maybeSingle();if(D)throw D;if(j){const C=dn(j,{task_date:w.task_date,scheduled_time:w.scheduled_time});w.task_date=C.task_date,w.scheduled_time=C.scheduled_time,C.source!==j.source&&(w.source=C.source),C.normalizedToInbox&&(v+=1)}}await S.from("daily_tasks").update(w).eq("id",x.taskId)}else if(x.action==="delete"&&x.taskId)await S.from("daily_tasks").delete().eq("id",x.taskId);else if(x.action==="move_to_tomorrow"&&x.taskId){const w=new Date(a);w.setDate(w.getDate()+1);const{data:j,error:D}=await S.from("daily_tasks").select("task_date, scheduled_time, habit_source_id, source").eq("id",x.taskId).maybeSingle();if(D)throw D;if(!j)continue;const C=Tr({task_date:te(w,"yyyy-MM-dd"),scheduled_time:j.scheduled_time,habit_source_id:j.habit_source_id,source:j.source});C.normalizedToInbox&&(v+=1);const _={task_date:C.task_date,scheduled_time:C.scheduled_time};C.source!==j.source&&(_.source=C.source),await S.from("daily_tasks").update(_).eq("id",x.taskId)}v>0&&W(`${v} quest${v===1?"":"s"} stayed in Inbox (time required).`)}m.invalidateQueries({queryKey:["daily-tasks"]}),W.success(y?.message||"Plan adjusted!"),l(""),i()}catch(g){console.error("Adjust error:",g),W.error("Failed to adjust plan")}finally{d(!1)}}};return e.jsx(ur,{open:t,onOpenChange:s,children:e.jsxs(mr,{className:"max-h-[70vh]",children:[e.jsxs(pr,{className:"text-center pb-2",children:[e.jsx("div",{className:"flex justify-center mb-2",children:e.jsx("div",{className:"p-2 rounded-full bg-primary/10",children:e.jsx(Vs,{className:"h-5 w-5 text-primary"})})}),e.jsx(hr,{children:"Quick Adjust"}),e.jsxs(fo,{children:[p.length," task",p.length!==1?"s":""," remaining"]})]}),e.jsxs("div",{className:"px-4 pb-6 space-y-4",children:[e.jsx("div",{className:"grid grid-cols-2 gap-2",children:h.map((u,g)=>e.jsxs(M.button,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:g*.05},onClick:()=>f(u.prompt),disabled:c,className:A("flex items-center gap-2 p-3 rounded-lg","bg-muted/50 border border-border/50","hover:bg-muted hover:border-primary/30 transition-all","text-left text-sm","disabled:opacity-50 disabled:cursor-not-allowed"),children:[e.jsx("div",{className:"text-primary",children:u.icon}),e.jsx("span",{className:"font-medium",children:u.label})]},g))}),e.jsxs("div",{className:"relative",children:[e.jsx(ot,{value:o,onChange:u=>l(u.target.value),placeholder:"Or describe what to change...",className:"pr-12",onKeyDown:u=>u.key==="Enter"&&f(o),disabled:c}),e.jsx(U,{size:"icon",variant:"ghost",className:"absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8",onClick:()=>f(o),disabled:!o.trim()||c,children:c?e.jsx(bt,{className:"h-4 w-4 animate-spin"}):e.jsx(Jc,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:["Move workout to 6pm","Cancel meeting prep","Add 30min break"].map(u=>e.jsx("button",{onClick:()=>l(u),disabled:c,className:"text-xs px-2 py-1 rounded-full bg-muted/50 text-muted-foreground hover:text-foreground transition-colors",children:u},u))})]})]})})}function hN(){const[t,s]=n.useState([]),[r,a]=n.useState(!1),[i,o]=n.useState(null),l=n.useCallback(async(f,u)=>{if(!f.trim()){o("Please enter a goal");return}a(!0),o(null);try{const{data:g,error:y}=await S.functions.invoke("generate-epic-suggestions",{body:{goal:f.trim(),deadline:u?.deadline,targetDays:u?.targetDays,clarificationAnswers:u?.clarificationAnswers,epicContext:u?.epicContext,timelineAnalysis:u?.timelineAnalysis}});if(y)throw y;if(g.error)throw new Error(g.error);const b=(g.suggestions||[]).map(v=>({...v,selected:!1}));s(b)}catch(g){const y=g instanceof Error?g.message:"Failed to build suggestions";o(y),W.error(y)}finally{a(!1)}},[]),c=n.useCallback(f=>{s(u=>u.map(g=>g.id===f?{...g,selected:!g.selected}:g))},[]),d=n.useCallback(()=>{s(f=>f.map(u=>({...u,selected:!0})))},[]),m=n.useCallback(()=>{s(f=>f.map(u=>({...u,selected:!1})))},[]),p=n.useCallback(()=>t.filter(f=>f.selected),[t]),h=n.useCallback(()=>{s([]),o(null),a(!1)},[]);return{suggestions:t,isLoading:r,error:i,generateSuggestions:l,toggleSuggestion:c,selectAll:d,deselectAll:m,getSelectedSuggestions:p,reset:h}}const fN=()=>{const t=Ae(),{data:s,isLoading:r}=Ee({queryKey:["epic-templates"],queryFn:async()=>{const{data:l,error:c}=await S.from("epic_templates").select("*").order("is_featured",{ascending:!1}).order("popularity_count",{ascending:!1});if(c)throw c;return(l||[]).map(d=>({...d,habits:Array.isArray(d.habits)?d.habits:JSON.parse(d.habits||"[]")}))}}),a=le({mutationFn:async l=>{const{data:c,error:d}=await S.from("epic_templates").select("popularity_count").eq("id",l).maybeSingle();c?await S.from("epic_templates").update({popularity_count:(c.popularity_count||0)+1}).eq("id",l):d&&console.error("Error incrementing popularity:",d)},onSuccess:()=>{t.invalidateQueries({queryKey:["epic-templates"]})}}),i=s?.filter(l=>l.is_featured)||[];return{templates:s||[],featuredTemplates:i,isLoading:r,incrementPopularity:a}};function gN(){const{user:t}=be(),{data:s,isLoading:r,refetch:a}=Ee({queryKey:["user-ai-context",t?.id],queryFn:async()=>{if(!t)return null;const{data:f,error:u}=await S.functions.invoke("enrich-user-context");return u?(console.error("Error fetching AI context:",u),null):f},enabled:!!t,staleTime:300*1e3,gcTime:600*1e3}),{data:i,isLoading:o,refetch:l}=Ee({queryKey:["user-ai-learning",t?.id],queryFn:async()=>{if(!t)return null;const{data:f,error:u}=await S.from("user_ai_learning").select("*").eq("user_id",t.id).maybeSingle();return u?(console.error("Error fetching AI learning profile:",u),null):f},enabled:!!t,staleTime:300*1e3,gcTime:600*1e3}),c=s?.atEpicLimit??!1,d=s?.overloaded??!1,m=s?.suggestedWorkload??"normal",p={epicDuration:i?.preferred_epic_duration??s?.preferredEpicDuration??30,habitDifficulty:i?.preferred_habit_difficulty??s?.preferredDifficulty??"medium",habitFrequency:i?.preferred_habit_frequency??s?.preferredHabitFrequency??"daily",commonContexts:i?.common_contexts??s?.commonContexts??[],preferenceWeights:i?.preference_weights??s?.preferenceWeights??{}};return{enrichedContext:s,learningProfile:i,isLoading:r||o,isContextLoading:r,isLearningLoading:o,isAtEpicLimit:c,isOverloaded:d,suggestedWorkload:m,capacityWarning:c?"You have 2 active epics. Consider completing one before starting another.":d?"You seem overloaded. Consider simplifying your current habits before adding more.":null,preferences:p,activeEpicCount:s?.activeEpics.length??0,activeHabitCount:s?.activeHabits.length??0,completionRate:s?.completionRates.thisWeek??0,refetch:()=>{a(),l()},refetchContext:a,refetchLearning:l}}function xN(t={}){const{debounceMs:s=500,minInputLength:r=10,useOrchestrator:a=!1}=t,[i,o]=n.useState(null),[l,c]=n.useState(!1),[d,m]=n.useState(null),[p,h]=n.useState(null),f=n.useRef(null),u=n.useRef(""),g=n.useCallback(async _=>{if(!_||_.length<r)return o(null),null;if(_===u.current)return i;u.current=_,c(!0),m(null);try{const N=a?"ai-orchestrator":"classify-task-intent",E=a?{input:_,interactionType:"classify"}:{input:_},{data:k,error:P}=await S.functions.invoke(N,{body:E});if(P)throw new Error(P.message);if(k?.error)throw new Error(k.error);let T;return a?(T={type:k.type||"quest",confidence:k.confidence||0,reasoning:k.reasoning||"",suggestedDeadline:k.suggestedDeadline,suggestedDuration:k.suggestedDuration,needsClarification:k.needsClarification,clarifyingQuestion:k.clarifyingQuestion,clarificationContext:k.clarificationContext,extractedTasks:k.extractedTasks,suggestedTasks:k.suggestedTasks,detectedContext:k.detectedContext,epicClarifyingQuestions:k.epicClarifyingQuestions,epicContext:k.epicContext,epicDetails:k.epicDetails,timelineAnalysis:k.timelineAnalysis,capacityWarnings:k.capacityWarnings,warning:k.warning},k.capacityWarnings?h(k.capacityWarnings):k.enrichedContext&&h({atEpicLimit:k.enrichedContext.atEpicLimit??!1,overloaded:k.enrichedContext.overloaded??!1,suggestedWorkload:k.enrichedContext.suggestedWorkload??"normal"})):T=k,o(T),T}catch(N){return console.error("Intent classification error:",N),m(N instanceof Error?N.message:"Classification failed"),o(null),null}finally{c(!1)}},[i,r,a]),y=n.useCallback(async(_,N)=>{if(!_||!N)return null;c(!0),m(null);try{const{data:E,error:k}=await S.functions.invoke("classify-task-intent",{body:{input:_,clarification:N,previousContext:i?.clarificationContext}});if(k)throw new Error(k.message);if(E?.error)throw new Error(E.error);const P=E;return o(P),P}catch(E){return console.error("Intent clarification error:",E),m(E instanceof Error?E.message:"Clarification failed"),null}finally{c(!1)}},[i?.clarificationContext]),b=n.useCallback(async(_,N)=>{if(!_||!N||Object.keys(N).length===0)return null;c(!0),m(null);try{const{data:E,error:k}=await S.functions.invoke("classify-task-intent",{body:{input:_,epicAnswers:N}});if(k)throw new Error(k.message);if(E?.error)throw new Error(E.error);const P=E;return o(P),P}catch(E){return console.error("Epic clarification error:",E),m(E instanceof Error?E.message:"Epic clarification failed"),null}finally{c(!1)}},[]),v=n.useCallback(_=>{if(f.current&&clearTimeout(f.current),!_||_.length<r){o(null);return}f.current=setTimeout(()=>{g(_)},s)},[g,s,r]),x=n.useCallback(()=>{f.current&&clearTimeout(f.current),o(null),m(null),c(!1),u.current=""},[]);n.useEffect(()=>()=>{f.current&&clearTimeout(f.current)},[]);const w=i?.type==="epic"&&i.confidence>=.6,j=i?.type==="habit"&&i.confidence>=.6,D=i?.type==="brain-dump"&&i.confidence>=.7&&(i.extractedTasks?.length??0)>=2,C=w&&i?.needsClarification===!0&&(i?.epicClarifyingQuestions?.length??0)>0;return{classification:i,isClassifying:l,error:d,classify:g,clarify:y,clarifyEpic:b,classifyDebounced:v,reset:x,isEpicDetected:w,isHabitDetected:j,isBrainDumpDetected:D,needsClarification:i?.needsClarification??!1,clarifyingQuestion:i?.clarifyingQuestion,extractedTasks:i?.extractedTasks??[],suggestedTasks:i?.suggestedTasks??[],detectedContext:i?.detectedContext,needsEpicClarification:C,epicClarifyingQuestions:i?.epicClarifyingQuestions??[],epicContext:i?.epicContext,epicDetails:i?.epicDetails,timelineAnalysis:i?.timelineAnalysis??null,capacityWarnings:p,capacityWarning:i?.warning??null,isAtEpicLimit:p?.atEpicLimit??!1,isOverloaded:p?.overloaded??!1}}const yN={easy:"bg-green-500/10 text-green-500 border-green-500/30",medium:"bg-amber-500/10 text-amber-500 border-amber-500/30",hard:"bg-red-500/10 text-red-500 border-red-500/30"},bN={daily:"Daily",weekdays:"Weekdays","5x_week":"5x/week","3x_week":"3x/week",weekly:"Weekly",custom:"Custom"},vN=n.memo(function({ritual:s,onUpdate:r,onDelete:a,isEditing:i=!1}){const[o,l]=n.useState(i),[c,d]=n.useState(s),m=()=>{r(c),l(!1)},p=()=>{d(s),l(!1)},h=(u,g)=>{d({...c,frequency:u,customDays:g})};if(o)return e.jsxs(M.div,{layout:!0,className:"p-3 rounded-lg border bg-muted/30 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ot,{value:c.title,onChange:u=>d({...c,title:u.target.value}),placeholder:"Ritual name",className:"font-medium"}),e.jsx(ot,{value:c.description,onChange:u=>d({...c,description:u.target.value}),placeholder:"Description (optional)",className:"text-sm"})]}),e.jsx(jp,{frequency:c.frequency==="3x_week"?"custom":c.frequency,customDays:c.customDays||Np(c.frequency),onFrequencyChange:h}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] text-muted-foreground mb-1 block",children:"Difficulty"}),e.jsxs(Na,{value:c.difficulty,onValueChange:u=>d({...c,difficulty:u}),children:[e.jsx(Fr,{className:"h-8 text-xs",children:e.jsx(ka,{})}),e.jsxs($r,{children:[e.jsx(Gs,{value:"easy",children:"Easy"}),e.jsx(Gs,{value:"medium",children:"Medium"}),e.jsx(Gs,{value:"hard",children:"Hard"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] text-muted-foreground mb-1 block",children:"Minutes"}),e.jsx(ot,{type:"number",value:c.estimatedMinutes||"",onChange:u=>d({...c,estimatedMinutes:parseInt(u.target.value)||void 0}),placeholder:"15",className:"h-8 text-xs"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(U,{size:"sm",variant:"outline",className:"flex-1",onClick:p,children:[e.jsx(Nt,{className:"w-3 h-3 mr-1"}),"Cancel"]}),e.jsxs(U,{size:"sm",className:"flex-1",onClick:m,children:[e.jsx(Pt,{className:"w-3 h-3 mr-1"}),"Save"]})]})]});const f=Oj(s.customDays||[]);return e.jsxs(M.div,{layout:!0,className:"group flex items-center gap-2 p-3 rounded-lg border bg-background hover:bg-muted/30 transition-colors",children:[e.jsx(Df,{className:"w-4 h-4 text-muted-foreground/50 cursor-grab"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-sm truncate",children:s.title}),e.jsx(Fe,{variant:"outline",className:A("text-[10px] px-1.5 py-0",yN[s.difficulty]),children:s.difficulty})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:bN[s.frequency]}),f&&s.frequency!=="daily"&&e.jsx(e.Fragment,{children:e.jsxs("span",{className:"text-[10px] opacity-70",children:["(",f,")"]})}),s.estimatedMinutes&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"â€¢"}),e.jsx(Ft,{className:"w-3 h-3"}),e.jsxs("span",{children:[s.estimatedMinutes,"min"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(U,{size:"icon",variant:"ghost",className:"h-7 w-7",onClick:()=>l(!0),children:e.jsx(Pf,{className:"w-3.5 h-3.5"})}),e.jsx(U,{size:"icon",variant:"ghost",className:"h-7 w-7 text-destructive hover:text-destructive",onClick:()=>a(s.id),children:e.jsx($s,{className:"w-3.5 h-3.5"})})]})]})});function wN({rituals:t,originalRituals:s,onRitualsChange:r,className:a}){const[i,o]=n.useState(!1),[l,c]=n.useState(""),d=n.useMemo(()=>t.reduce((y,b)=>{const v=b.estimatedMinutes||15,w={daily:7,"5x_week":5,"3x_week":3,weekly:1,custom:3}[b.frequency]||3;return y+v*w},0),[t]),m=Math.round(d/60*10)/10,p=y=>{r(t.map(b=>b.id===y.id?y:b))},h=y=>{r(t.filter(b=>b.id!==y))},f=()=>{if(!l.trim())return;const y={id:`custom-${Date.now()}`,title:l.trim(),description:"",frequency:"daily",difficulty:"medium",estimatedMinutes:15};r([...t,y]),c(""),o(!1)},u=()=>{r([...s])},g=JSON.stringify(t)!==JSON.stringify(s);return e.jsxs("div",{className:A("space-y-4",a),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(Fe,{variant:"secondary",className:"gap-1",children:[e.jsx(pe,{className:"w-3 h-3"}),t.length," Rituals"]}),e.jsxs(Fe,{variant:"outline",className:"gap-1",children:[e.jsx(Ft,{className:"w-3 h-3"}),"~",m," hrs/week"]})]}),g&&e.jsxs(U,{variant:"ghost",size:"sm",onClick:u,className:"text-xs gap-1",children:[e.jsx(Af,{className:"w-3 h-3"}),"Reset"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Pe,{mode:"popLayout",children:t.map(y=>e.jsx(M.div,{layout:!0,initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,x:-20},children:e.jsx(vN,{ritual:y,onUpdate:p,onDelete:h})},y.id))}),e.jsx(Pe,{children:i?e.jsxs(M.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"flex gap-2",children:[e.jsx(ot,{value:l,onChange:y=>c(y.target.value),placeholder:"New ritual name...",className:"flex-1",autoFocus:!0,onKeyDown:y=>{y.key==="Enter"&&f(),y.key==="Escape"&&o(!1)}}),e.jsx(U,{size:"sm",onClick:f,disabled:!l.trim(),children:"Add"}),e.jsx(U,{size:"sm",variant:"outline",onClick:()=>o(!1),children:"Cancel"})]}):e.jsx(M.div,{layout:!0,children:e.jsxs(U,{variant:"outline",size:"sm",className:"w-full border-dashed gap-2",onClick:()=>o(!0),children:[e.jsx(xa,{className:"w-4 h-4"}),"Add Custom Ritual"]})})})]}),e.jsxs("div",{className:"flex gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-green-500"}),t.filter(y=>y.difficulty==="easy").length," easy"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-amber-500"}),t.filter(y=>y.difficulty==="medium").length," medium"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-red-500"}),t.filter(y=>y.difficulty==="hard").length," hard"]})]})]})}const _N=n.memo(function({milestones:s,storyType:r,className:a}){const i=n.useMemo(()=>s.filter(o=>o.isPostcardMilestone),[s]);return i.length===0?null:e.jsxs("div",{className:A("space-y-3",a),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Rf,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"font-medium text-sm",children:"Your Story Chapters"}),e.jsxs(Fe,{variant:"secondary",className:"text-xs ml-auto",children:[i.length," chapters"]})]}),e.jsx("div",{className:"grid gap-2",children:i.map((o,l)=>e.jsxs(M.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:l*.1},className:"relative overflow-hidden rounded-lg border bg-gradient-to-r from-amber-500/5 to-orange-500/5 p-3",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent -translate-x-full animate-[shimmer_2s_infinite]"}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-gradient-to-br from-amber-500/20 to-orange-500/20 border border-amber-500/30 flex items-center justify-center flex-shrink-0",children:e.jsx(pe,{className:"w-5 h-5 text-amber-500"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-0.5",children:[e.jsxs("span",{className:"text-xs font-medium text-amber-600",children:["Chapter ",l+1]}),e.jsx(St,{className:"w-3 h-3 text-amber-500"})]}),e.jsx("p",{className:"font-medium text-sm truncate",children:o.title}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground mt-1",children:[e.jsx(Da,{className:"w-3 h-3"}),e.jsx("span",{className:"italic",children:"Location revealed on completion"})]})]}),e.jsxs(Fe,{variant:"outline",className:"text-[10px] flex-shrink-0",children:[o.milestonePercent,"%"]})]})]},o.id))}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Complete milestones to unlock cosmic postcards from your companion's journey"})]})}),jN=n.memo(function({isAtEpicLimit:s=!1,isOverloaded:r=!1,suggestedWorkload:a="normal",isLoading:i=!1,className:o}){const l=s||r;return i?null:e.jsx(Pe,{children:l&&e.jsxs(M.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:A("px-3 py-2 rounded-lg text-xs flex items-center gap-2",r?"bg-destructive/10 border border-destructive/30 text-destructive":"bg-amber-500/10 border border-amber-500/30 text-amber-600 dark:text-amber-400",o),children:[e.jsx(Xs,{className:"h-3.5 w-3.5 flex-shrink-0"}),e.jsx("span",{children:r?"You seem overloaded. Consider simplifying current habits first.":s?"You have 2 active epics. Complete one before starting another.":a==="light"?"Consider a lighter workload today.":null})]})})}),Ci=[{id:"heroic",label:"Heroic Gold",color:"from-amber-500 to-yellow-600",value:"#f59e0b"},{id:"warrior",label:"Warrior Red",color:"from-red-500 to-rose-600",value:"#ef4444"},{id:"nature",label:"Nature Green",color:"from-emerald-500 to-green-600",value:"#10b981"},{id:"mystic",label:"Mystic Pink",color:"from-pink-500 to-rose-600",value:"#ec4899"},{id:"solar",label:"Solar Orange",color:"from-orange-500 to-yellow-500",value:"#f97316"}];function NN({goal:t,questions:s,onSubmit:r,onSkip:a,isLoading:i=!1}){const[o,l]=n.useState({}),c=(u,g)=>{l(y=>({...y,[u]:g}))},d=(u,g)=>{l(y=>{const b=y[u]||[],v=b.includes(g)?b.filter(x=>x!==g):[...b,g];return{...y,[u]:v}})},m=()=>{const u={};Object.entries(o).forEach(([g,y])=>{Array.isArray(y)?u[g]=y.join(", "):u[g]=y}),r(u)},h=s.filter(u=>u.required).every(u=>{const g=o[u.id];return u.multiSelect?Array.isArray(g)&&g.length>0:g!==void 0&&g!==""}),f=u=>u.includes("date")||u.includes("exam")||u.includes("target")?$t:u.includes("hours")||u.includes("time")||u.includes("days")?Ft:u.includes("subject")||u.includes("level")||u.includes("status")?ga:At;return e.jsxs(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"bg-gradient-to-br from-primary/5 via-background to-primary/5 rounded-xl border border-primary/20 p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:e.jsx(pe,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Let's personalize your epic"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-1",children:t})]})]}),e.jsx("div",{className:"space-y-4",children:s.map((u,g)=>{const y=f(u.id);return e.jsxs(M.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:g*.1},className:"space-y-2",children:[e.jsxs(at,{className:"text-sm flex items-center gap-2",children:[e.jsx(y,{className:"w-4 h-4 text-muted-foreground"}),u.question,u.required&&e.jsx("span",{className:"text-destructive",children:"*"})]}),u.type==="select"&&u.options&&u.multiSelect?e.jsx("div",{className:"flex flex-wrap gap-2",children:u.options.map(b=>{const v=(o[u.id]||[]).includes(b);return e.jsxs("button",{type:"button",onClick:()=>d(u.id,b),className:A("px-3 py-1.5 rounded-full text-sm border transition-all flex items-center gap-1",v?"bg-primary text-primary-foreground border-primary":"bg-background border-border hover:border-primary/50"),children:[v&&e.jsx(Pt,{className:"w-3 h-3"}),b]},b)})}):u.type==="select"&&u.options&&e.jsxs(Na,{value:o[u.id]?.toString()||"",onValueChange:b=>c(u.id,b),children:[e.jsx(Fr,{className:"h-9",children:e.jsx(ka,{placeholder:"Select an option..."})}),e.jsx($r,{children:u.options.map(b=>e.jsx(Gs,{value:b,children:b},b))})]}),u.type==="date"&&e.jsx(ot,{type:"date",value:o[u.id]?.toString()||"",onChange:b=>c(u.id,b.target.value),className:"h-9",min:new Date().toISOString().split("T")[0]}),u.type==="number"&&e.jsx(ot,{type:"number",value:o[u.id]?.toString()||"",onChange:b=>c(u.id,parseInt(b.target.value)||""),placeholder:u.placeholder||"Enter a number...",className:"h-9",min:1,max:24}),u.type==="text"&&e.jsx(ot,{type:"text",value:o[u.id]?.toString()||"",onChange:b=>c(u.id,b.target.value),placeholder:u.placeholder||"Type your answer...",className:"h-9"})]},u.id)})}),e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsx(U,{onClick:m,disabled:!h||i,className:"flex-1 h-10",children:i?e.jsxs(e.Fragment,{children:[e.jsx(bt,{className:"w-4 h-4 mr-2 animate-spin"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"Generate My Epic",e.jsx(Et,{className:"w-4 h-4 ml-1"})]})}),e.jsx(U,{variant:"ghost",size:"sm",onClick:a,disabled:i,className:"text-muted-foreground hover:text-foreground",children:"Skip"})]}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"This helps create a personalized study plan just for you"})]})}const kN=[{label:"2 weeks",getValue:()=>Ai(new Date,2)},{label:"1 month",getValue:()=>Sr(new Date,1)},{label:"3 months",getValue:()=>Sr(new Date,3)},{label:"6 months",getValue:()=>Sr(new Date,6)},{label:"1 year",getValue:()=>Xf(new Date,1)}];function CN({value:t,onChange:s,minDate:r}){const[a,i]=n.useState(!1),o=r||Cs(new Date,7),l=t?qt(t,new Date):null;return e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:kN.map(c=>{const d=c.getValue(),m=t&&te(t,"yyyy-MM-dd")===te(d,"yyyy-MM-dd");return e.jsx(U,{type:"button",variant:m?"default":"outline",size:"sm",onClick:()=>s(d),className:"flex-1 min-w-[80px]",children:c.label},c.label)})}),e.jsxs(Ds,{open:a,onOpenChange:i,modal:!0,children:[e.jsx(Ps,{asChild:!0,children:e.jsxs(U,{variant:"outline",className:A("w-full justify-start text-left font-normal h-12",!t&&"text-muted-foreground"),children:[e.jsx($t,{className:"mr-2 h-4 w-4"}),t?e.jsxs("span",{className:"flex items-center gap-2",children:[te(t,"EEEE, MMMM d, yyyy"),l&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",l," days)"]})]}):e.jsx("span",{children:"Pick a specific date"})]})}),e.jsx(ys,{className:"w-auto p-0 z-[100] pointer-events-auto",align:"start",onOpenAutoFocus:c=>c.preventDefault(),children:e.jsx(Vr,{mode:"single",selected:t,onSelect:c=>{s(c),i(!1)},disabled:c=>c<o,initialFocus:!0,className:"pointer-events-auto",captionLayout:"dropdown",fromYear:new Date().getFullYear(),toYear:new Date().getFullYear()+10})})]}),t&&l&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Ft,{className:"w-4 h-4"}),e.jsxs("span",{children:[l," days until deadline",l<=14&&e.jsxs("span",{className:"ml-2 text-amber-500 font-medium",children:[e.jsx(ft,{className:"w-3 h-3 inline mr-1"}),"Intensive"]})]})]})]})}function SN({phase:t,milestones:s,isFirst:r,isLast:a,onMilestoneToggle:i,onMilestoneDateChange:o,postcardCount:l=0,maxPostcards:c=7}){const[d,m]=n.useState(null),[p,h]=n.useState(new Set),f=ps(t.startDate),u=x=>{h(w=>{const j=new Set(w);return j.has(x)?j.delete(x):j.add(x),j})},g=ps(t.endDate),y=qt(g,f)+1,b=["from-blue-500/20 to-cyan-500/20 border-blue-500/30","from-purple-500/20 to-pink-500/20 border-purple-500/30","from-amber-500/20 to-orange-500/20 border-amber-500/30","from-green-500/20 to-emerald-500/20 border-green-500/30","from-rose-500/20 to-red-500/20 border-rose-500/30"],v=b[(t.phaseOrder-1)%b.length];return e.jsxs("div",{className:"relative",children:[!r&&e.jsx("div",{className:"absolute left-6 -top-4 w-0.5 h-4 bg-border"}),e.jsxs("div",{className:A("p-4 rounded-xl border bg-gradient-to-br",v),children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-background/50 flex items-center justify-center font-bold text-sm",children:t.phaseOrder}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold",children:t.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[te(f,"MMM d")," - ",te(g,"MMM d")," (",y," days)"]})]})]}),e.jsxs(Fe,{variant:"outline",className:"text-xs",children:[y,"d"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:t.description}),s.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-xs font-medium text-muted-foreground flex items-center gap-1",children:[e.jsx(Mn,{className:"w-3 h-3"}),"Milestones"]}),s.map(x=>e.jsx("div",{className:A("w-full p-2.5 rounded-lg text-left transition-all","bg-background/50 hover:bg-background/80","border border-transparent hover:border-primary/30",x.isPostcardMilestone&&"ring-1 ring-amber-500/50"),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:w=>{w.stopPropagation(),i?.(x.id)},disabled:!x.isPostcardMilestone&&l>=c,className:A("flex-shrink-0 transition-all",x.isPostcardMilestone?"text-amber-500 hover:text-amber-600":l>=c?"text-muted-foreground/30 cursor-not-allowed":"text-muted-foreground hover:text-amber-500"),title:x.isPostcardMilestone?"Remove celebration milestone":l>=c?`Max ${c} postcards reached`:"Mark as celebration milestone",children:e.jsx(St,{className:"w-4 h-4",fill:x.isPostcardMilestone?"currentColor":"none"})}),e.jsxs("button",{onClick:()=>u(x.id),className:"flex-1 min-w-0 text-left flex items-center gap-1",children:[e.jsx(Et,{className:A("w-3 h-3 flex-shrink-0 transition-transform",p.has(x.id)&&"rotate-90")}),e.jsx("p",{className:A("text-sm font-medium",p.has(x.id)?"whitespace-normal break-words":"truncate"),children:x.title})]}),e.jsxs(Ds,{open:d===x.id,onOpenChange:w=>m(w?x.id:null),children:[e.jsx(Ps,{asChild:!0,children:e.jsxs(U,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-muted-foreground hover:text-foreground",onClick:w=>w.stopPropagation(),children:[e.jsx($t,{className:"w-3 h-3 mr-1"}),te(ps(x.targetDate),"MMM d")]})}),e.jsx(ys,{className:"w-auto p-0",align:"end",children:e.jsx(Vr,{mode:"single",selected:ps(x.targetDate),onSelect:w=>{w&&(o?.(x.id,te(w,"yyyy-MM-dd")),m(null))},className:"pointer-events-auto"})})]}),x.isPostcardMilestone&&e.jsx(Fe,{variant:"secondary",className:"text-[10px] px-1 py-0 h-4 flex-shrink-0",children:"Postcard"})]})},x.id))]})]}),!a&&e.jsx("div",{className:"absolute left-6 -bottom-4 w-0.5 h-4 bg-border"})]})}function EN({feasibilityAssessment:t,phases:s,milestones:r,rituals:a,weeklyHoursEstimate:i,deadline:o,onMilestoneToggle:l,onMilestoneDateChange:c,postcardCount:d=0,maxPostcards:m=7}){const p=n.useMemo(()=>[...s].sort((g,y)=>g.phaseOrder-y.phaseOrder),[s]),h=n.useMemo(()=>{const g=new Map;return r.forEach(y=>{const b=g.get(y.phaseOrder)||[];g.set(y.phaseOrder,[...b,y])}),g},[r]),f={comfortable:{bg:"bg-green-500/10",text:"text-green-500",border:"border-green-500/30"},achievable:{bg:"bg-blue-500/10",text:"text-blue-500",border:"border-blue-500/30"},aggressive:{bg:"bg-amber-500/10",text:"text-amber-500",border:"border-amber-500/30"},very_aggressive:{bg:"bg-red-500/10",text:"text-red-500",border:"border-red-500/30"}},u=f[t.feasibility]||f.achievable;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:A("p-4 rounded-xl border",u.bg,u.border),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:A("p-2 rounded-lg",u.bg),children:e.jsx($t,{className:A("w-5 h-5",u.text)})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("span",{className:"font-semibold text-sm",children:[t.daysAvailable," days available"]}),e.jsx(Fe,{variant:"outline",className:A("text-xs",u.text,u.border),children:hs(t.feasibility)})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.message})]})]})}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ft,{className:"w-4 h-4"}),e.jsxs("span",{children:["~",i," hrs/week"]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(St,{className:"w-4 h-4 text-amber-500"}),e.jsxs("span",{children:[d,"/",m," celebration milestones"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[p.map((g,y)=>e.jsx(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:y*.1},children:e.jsx(SN,{phase:g,milestones:h.get(g.phaseOrder)||[],isFirst:y===0,isLast:y===p.length-1,onMilestoneToggle:l,onMilestoneDateChange:c,postcardCount:d,maxPostcards:m})},g.id)),e.jsx(M.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{delay:p.length*.1},className:"p-4 bg-gradient-to-r from-primary/10 to-purple-500/10 rounded-xl border border-primary/30",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full bg-primary/20",children:e.jsx(Mn,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Goal Complete!"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:te(ps(o),"EEEE, MMMM d, yyyy")})]}),e.jsx(pe,{className:"w-5 h-5 text-primary ml-auto animate-pulse"})]})})]}),e.jsxs("div",{className:"p-4 rounded-lg bg-muted/30 border",children:[e.jsxs("p",{className:"text-xs font-medium text-muted-foreground mb-2",children:["Daily & Weekly Rituals (",a.length,")"]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[a.slice(0,4).map(g=>e.jsx(Fe,{variant:"secondary",className:"text-xs",children:g.title},g.id)),a.length>4&&e.jsxs(Fe,{variant:"outline",className:"text-xs",children:["+",a.length-4," more"]})]})]})]})}const TN=[{label:"Less aggressive",value:"Make the schedule less aggressive, I need more breathing room"},{label:"More intensive",value:"I can dedicate more time, make it more intensive"},{label:"Fewer milestones",value:"Reduce the number of milestones, keep only the essential ones"},{label:"More rest days",value:"Include more rest days and recovery time"}];function MN({onSubmit:t,isLoading:s}){const[r,a]=n.useState(""),[i,o]=n.useState(!1),l=d=>{t(d)},c=()=>{r.trim()&&(t(r.trim()),a(""),o(!1))};return s?e.jsxs("div",{className:"p-4 bg-muted/50 rounded-xl border border-dashed flex items-center justify-center gap-2",children:[e.jsx(bt,{className:"w-4 h-4 animate-spin text-primary"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Adjusting your plan..."})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(Id,{className:"w-4 h-4"}),"Want to adjust the plan?"]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[TN.map(d=>e.jsx(U,{variant:"outline",size:"sm",onClick:()=>l(d.value),className:"text-xs",children:d.label},d.label)),e.jsxs(U,{variant:"ghost",size:"sm",onClick:()=>o(!i),className:"text-xs",children:[e.jsx(pe,{className:"w-3 h-3 mr-1"}),"Custom request"]})]}),i&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(ot,{placeholder:"e.g., 'I have prior experience, skip the basics'",value:r,onChange:d=>a(d.target.value),onKeyDown:d=>d.key==="Enter"&&c(),className:"flex-1"}),e.jsx(U,{onClick:c,disabled:!r.trim(),size:"sm",children:"Adjust"})]})]})}const DN=[{id:"experience_level",question:"What is your current experience level?",type:"select",options:["Complete beginner","Some experience","Intermediate","Advanced"],required:!0},{id:"daily_time",question:"How much time can you dedicate daily?",type:"text",placeholder:"e.g., 1-2 hours, 30 minutes",required:!0},{id:"priority_focus",question:"What aspect is most important to you?",type:"text",placeholder:"e.g., speed, thoroughness, consistency",required:!1}];function PN({open:t,onOpenChange:s,onCreateEpic:r,isCreating:a,initialGoal:i="",initialTargetDays:o,template:l,showTemplatesFirst:c=!1,clarificationAnswers:d,epicContext:m}){const p=n.useRef(!1),h=n.useRef(null),[f,u]=n.useState("goal"),[g,y]=n.useState(i),[b,v]=n.useState(void 0),[x,w]=n.useState(""),{preferences:j,isAtEpicLimit:D}=gN(),{trackInteraction:C}=So(),{schedule:_,isLoading:N,generateSchedule:E,adjustSchedule:k,toggleMilestone:P,updateMilestoneDate:T,reset:I,setRituals:R,postcardCount:L,maxPostcards:$}=Gm(),[q,F]=n.useState([]),{classify:H,isClassifying:J,clarifyEpic:G,reset:re}=xN({useOrchestrator:!1}),[ie,K]=n.useState(!1),[xe,Te]=n.useState([]),[Ne,B]=n.useState({}),[z,Q]=n.useState(void 0),Y=n.useMemo(()=>b?Math.max(7,qt(b,new Date)):o||j.epicDuration||30,[b,o,j.epicDuration]),[ue,fe]=n.useState(""),[De,Ce]=n.useState(""),[Be,qe]=n.useState([]),[he,ye]=n.useState(null),[Ue,Re]=n.useState(Ci[0].id),[Ie,ee]=n.useState(l||null),{medium:ne,success:X,light:ae,tap:Se}=cm();fN();const{suggestions:ve,error:_e,getSelectedSuggestions:Me,reset:et}=hN(),[Je,lt]=n.useState(""),{isRecording:dt,isAutoStopping:Mt,startRecording:vt,stopRecording:Rt}=wp({onInterimResult:ge=>lt(ge),onFinalResult:ge=>{y(it=>(it?it+" "+ge:ge).trim()),lt(""),X()},autoStopOnSilence:!0,silenceTimeoutMs:2e3});n.useEffect(()=>{if(Ie&&t){fe(Ie.name),Ce(Ie.description),v(Cs(new Date,Ie.target_days)),Re(Ie.theme_color||Ci[0].id);const ge=xt=>xt==="daily"?"daily":xt==="5x_week"?"5x_week":xt==="3x_week"||xt==="weekly"?"3x_week":"custom",it=Ie.habits.map((xt,st)=>({id:`template-${st}`,type:"habit",title:xt.title,description:"",difficulty:xt.difficulty||"medium",frequency:ge(xt.frequency||"daily"),selected:!0}));qe(it),u("goal")}},[Ie,t]),n.useEffect(()=>{l&&t&&ee(l)},[l,t]),n.useEffect(()=>{t||(p.current=!1)},[t]),n.useEffect(()=>{h.current&&h.current.scrollTo({top:0,behavior:"instant"})},[f]);const me=n.useMemo(()=>Me(),[Me]),Le=n.useMemo(()=>_?.rituals?(console.log("[Pathfinder] Mapping schedule rituals:",_.rituals.length,_.rituals.map(ge=>({title:ge.title,estimatedMinutes:ge.estimatedMinutes}))),_.rituals.map(ge=>({id:ge.id,title:ge.title,description:ge.description,type:"habit",difficulty:ge.difficulty,frequency:ge.frequency,estimatedMinutes:ge.estimatedMinutes,isSelected:!0}))):[...me.filter(ge=>ge.type==="habit"),...Be],[_,me,Be]),Xe=n.useMemo(()=>_?.milestones||me.filter(ge=>ge.type==="milestone"),[_,me]),pt=n.useMemo(()=>Y*yy.XP_PER_DAY,[Y]),ce=n.useCallback(async(ge,it)=>{if(!g.trim()||!b)return;Se();const xt=te(b,"yyyy-MM-dd"),st=ge??(Object.keys(Ne).length>0?Ne:d),vs=await E({goal:g,deadline:xt,clarificationAnswers:st,epicContext:it??z??m,timelineContext:x.trim()||void 0});if(!vs){W.error("Failed to build timeline",{description:"Please try again or adjust your goal"});return}vs.rituals&&F([...vs.rituals]),vs.suggestedStoryType&&ye(vs.suggestedStoryType),vs.suggestedThemeColor&&Re(vs.suggestedThemeColor),ue||fe(g),u("timeline"),X()},[g,b,d,m,Ne,z,x,ue,E,Se,X]),Oe=n.useCallback(async ge=>{if(!_||!b)return;await k({goal:g,deadline:te(b,"yyyy-MM-dd"),adjustmentRequest:ge,previousSchedule:{phases:_.phases,milestones:_.milestones,rituals:_.rituals}})?(X(),W.success("Schedule updated!",{description:ge.toLowerCase().includes("intensive")?"Made your plan more intensive":ge.toLowerCase().includes("less")||ge.toLowerCase().includes("breathing")?"Made your plan more relaxed":"Adjusted based on your feedback"})):(ae(),W.error("Failed to adjust schedule",{description:"Please try again"}))},[_,b,g,k,X,ae]),Ke=n.useCallback(()=>{_&&(u("suggestions"),ne())},[_,ne]),ct=n.useCallback(async()=>{if(!g.trim()||!b)return;Se();const ge=await H(g);if(console.log("[Pathfinder] Classification result:",{input:g,type:ge?.type,confidence:ge?.confidence,needsClarification:ge?.needsClarification,questionsCount:ge?.epicClarifyingQuestions?.length,epicContext:ge?.epicContext}),ge?.type==="epic"){const it=ge.epicClarifyingQuestions?.length?ge.epicClarifyingQuestions:DN;Te(it),K(!0)}else ue||fe(g),await ce()},[g,b,ue,H,Se,ce]),ut=n.useCallback(async ge=>{B(ge),K(!1);const xt=(await G(g,ge))?.epicContext;xt&&Q(xt),ue||fe(g),await ce(ge,xt)},[g,G,ue,ce]),Dt=n.useCallback(async()=>{K(!1),ue||fe(g),await ce()},[g,ue,ce]),kt=n.useCallback(()=>{u("review"),ne()},[ne]),is=n.useCallback(()=>{if(Le.length===0){console.warn("Cannot create epic: no habits selected");return}const ge=Le.map(st=>({title:st.title,description:st.description,difficulty:st.difficulty,frequency:st.frequency||"daily",custom_days:st.customDays||Np(st.frequency||"daily"),estimated_minutes:st.estimatedMinutes}));console.log("[Pathfinder] Creating epic with habits:",ge.length,ge.map(st=>st.title)),ge.length<2&&_?.rituals&&_.rituals.length>ge.length&&console.warn("[Pathfinder] Habit count mismatch! Schedule has",_.rituals.length,"but habits array has",ge.length);const it=_?.milestones.map(st=>({title:st.title,description:st.description,target_date:st.targetDate,milestone_percent:st.milestonePercent,is_postcard_milestone:st.isPostcardMilestone}));console.log("[Pathfinder] Creating epic with milestones:",it?.length||0,it);const xt=_?.phases.map(st=>({name:st.name,description:st.description,start_date:st.startDate,end_date:st.endDate,phase_order:st.phaseOrder}));C({interactionType:"epic-creation",inputText:g,aiResponse:{totalSuggestions:ve?.length||0,selectedHabits:Le.length,targetDays:Y,storyType:he,hasSchedule:!!_},userAction:"accepted",detectedIntent:"epic"}),r({title:ue||g,description:De||void 0,target_days:Y,habits:ge,milestones:it,phases:xt,is_public:!0,story_type_slug:he||void 0,theme_color:Ue}),X()},[Le,ue,g,De,Y,he,Ue,_,r,X,C,ve]),bs=n.useCallback(()=>{ae(),f==="timeline"?u("goal"):f==="suggestions"?u("timeline"):f==="review"&&u("suggestions")},[f,ae]),Jt=n.useCallback(()=>{u("goal"),y(i),v(void 0),w(""),fe(""),Ce(""),qe([]),ye(null),Re(Ci[0].id),ee(null),K(!1),Te([]),B({}),Q(void 0),et(),I(),re(),s(!1)},[s,et,I,re,i]),It=n.useCallback(()=>{dt?Rt():vt(),Se()},[dt,vt,Rt,Se]),As=["goal","timeline","suggestions","review"],Us=As.indexOf(f);return e.jsx(ns,{open:t,onOpenChange:Jt,children:e.jsxs(Vt,{className:"sm:max-w-lg max-h-[90vh] flex flex-col p-0",children:[e.jsxs(Bs,{className:"p-6 pb-4",children:[e.jsxs(xs,{className:"flex items-center gap-2",children:[e.jsx(pe,{className:"w-5 h-5 text-primary"}),"Pathfinder"]}),e.jsxs(dr,{children:[f==="goal"&&"Set your goal and deadline",f==="timeline"&&"Review your personalized timeline",f==="suggestions"&&"Confirm your rituals and milestones",f==="review"&&"Review and create your campaign"]})]}),D&&e.jsx("div",{className:"px-6 pb-2",children:e.jsx(jN,{isAtEpicLimit:D,isLoading:!1})}),e.jsx("div",{className:"px-6 pb-4",children:e.jsx("div",{className:"flex items-center justify-center gap-2",children:As.map((ge,it)=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:A("w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all",f===ge?"bg-primary text-primary-foreground":Us>it?"bg-primary/20 text-primary":"bg-muted text-muted-foreground"),children:Us>it?e.jsx(Pt,{className:"w-4 h-4"}):it+1}),it<As.length-1&&e.jsx("div",{className:A("w-4 h-0.5 mx-1",Us>it?"bg-primary":"bg-muted")})]},ge))})}),e.jsx("div",{ref:h,className:"flex-1 min-h-0 overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:e.jsxs(Pe,{mode:"wait",children:[f==="goal"&&e.jsxs(M.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"px-6 pb-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(at,{htmlFor:"goal-input",className:"text-base font-semibold",children:"What's your goal?"}),e.jsxs("div",{className:"relative",children:[e.jsx(Kt,{id:"goal-input",placeholder:"e.g., Pass the bar exam, Run a marathon, Learn Spanish",value:dt?g+(Je?" "+Je:""):g,onChange:ge=>y(ge.target.value),rows:3,className:"pr-12 text-base"}),e.jsx(U,{size:"icon",variant:dt?"default":"ghost",className:A("absolute right-2 top-2 h-8 w-8",dt&&"animate-pulse bg-red-500 hover:bg-red-600"),onClick:It,disabled:Mt,children:e.jsx(Rd,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(at,{htmlFor:"context-input",className:"text-base font-semibold flex items-center gap-2",children:["List current experience",e.jsx("span",{className:"text-sm font-normal text-muted-foreground",children:"(optional)"})]}),e.jsx(Kt,{id:"context-input",placeholder:"e.g., Already know basics, studying for 2 weeks, starting from scratch",value:x,onChange:ge=>w(ge.target.value),rows:2,className:"text-base"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(at,{className:"text-base font-semibold flex items-center gap-2",children:[e.jsx($t,{className:"w-4 h-4"}),"When do you need to achieve this?"]}),e.jsx(CN,{value:b,onChange:v})]}),e.jsx(Pe,{children:ie&&xe.length>0&&e.jsx(NN,{goal:g,questions:xe,onSubmit:ut,onSkip:Dt,isLoading:J})}),!ie&&e.jsx(U,{onClick:ct,disabled:!g.trim()||!b||J||N,className:"w-full h-12 text-base",size:"lg",children:J?e.jsxs(e.Fragment,{children:[e.jsx(bt,{className:"w-4 h-4 mr-2 animate-spin"}),"Analyzing your goal..."]}):N?e.jsxs(e.Fragment,{children:[e.jsx(bt,{className:"w-4 h-4 mr-2 animate-spin"}),"Building your plan..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Vs,{className:"w-5 h-5 mr-2"}),"Build My Plan"]})}),_e&&e.jsx("p",{className:"text-sm text-destructive text-center",children:_e})]},"goal"),f==="timeline"&&_&&b&&e.jsx(M.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"flex flex-col h-full min-h-0",children:e.jsx("div",{className:"flex-1 overflow-y-auto px-4 overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:e.jsxs("div",{className:"space-y-4 pb-4",children:[e.jsx(EN,{feasibilityAssessment:_.feasibilityAssessment,phases:_.phases,milestones:_.milestones,rituals:_.rituals,weeklyHoursEstimate:_.weeklyHoursEstimate,deadline:te(b,"yyyy-MM-dd"),onMilestoneToggle:P,onMilestoneDateChange:T,postcardCount:L,maxPostcards:$}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(MN,{onSubmit:Oe,isLoading:N})}),e.jsxs("div",{className:"space-y-3 pt-2",children:[e.jsxs(U,{onClick:Ke,className:"w-full",children:["Continue with this plan",e.jsx(Et,{className:"w-4 h-4 ml-1"})]}),e.jsxs(U,{variant:"ghost",onClick:bs,className:"w-full",children:[e.jsx(Cr,{className:"w-4 h-4 mr-1"}),"Back"]})]})]})})},"timeline"),f==="suggestions"&&e.jsxs(M.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"flex flex-col h-full min-h-0",children:[e.jsx("div",{className:"flex-1 overflow-y-auto px-6 overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:e.jsxs("div",{className:"space-y-4 pb-4",children:[_?.rituals&&e.jsx(wN,{rituals:_.rituals,originalRituals:q,onRitualsChange:R}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(Mn,{className:"w-4 h-4"}),"Milestones (",Xe.length,")"]}),Xe.map(ge=>e.jsx("div",{className:"p-3 bg-amber-500/10 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:ge.title}),e.jsx(Fe,{variant:"outline",children:ge.targetDate?te(ps(ge.targetDate),"MMM d"):`Week ${ge.suggestedWeek}`})]})},ge.id))]}),_?.milestones&&e.jsx(_N,{milestones:_.milestones,storyType:he})]})}),e.jsxs("div",{className:"p-6 pt-4 border-t bg-background space-y-3",children:[e.jsxs(U,{onClick:kt,className:"w-full",children:["Continue to Review",e.jsx(Et,{className:"w-4 h-4 ml-1"})]}),e.jsxs(U,{variant:"ghost",onClick:bs,className:"w-full",children:[e.jsx(Cr,{className:"w-4 h-4 mr-1"}),"Back to Timeline"]})]})]},"suggestions"),f==="review"&&e.jsxs(M.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"flex flex-col h-full min-h-0",children:[e.jsx("div",{className:"flex-1 overflow-y-auto px-6 overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:e.jsxs("div",{className:"space-y-4 pb-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(at,{htmlFor:"epic-why",children:"Your Why"}),e.jsx(Kt,{id:"epic-why",value:De,onChange:ge=>Ce(ge.target.value),placeholder:"Why are you embarking on this campaign? What's your purpose?",rows:3}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Define your purpose - this will fuel your motivation"})]}),De.trim().length>0&&e.jsxs(M.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-2",children:[e.jsx(at,{htmlFor:"epic-title",children:"Campaign Name"}),e.jsx(ot,{id:"epic-title",value:ue,onChange:ge=>fe(ge.target.value),placeholder:"Name your campaign"})]}),e.jsxs("div",{className:"p-4 bg-gradient-to-r from-primary/10 to-purple-500/10 rounded-xl border border-primary/20",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ft,{className:"w-5 h-5 text-primary"}),e.jsx("span",{className:"font-medium",children:"Completion Reward"})]}),e.jsxs("span",{className:"text-xl font-bold text-primary",children:["+",pt," XP"]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[Y," days â€¢ ",Le.length," rituals â€¢ ",Xe.length," milestones"]})]})]})}),e.jsxs("div",{className:"p-6 pt-4 border-t bg-background space-y-3",children:[e.jsx(U,{onClick:is,disabled:a||Le.length===0||De.trim().length===0||ue.trim().length===0,className:"w-full bg-gradient-to-r from-primary to-purple-600",children:a?e.jsxs(e.Fragment,{children:[e.jsx(bt,{className:"w-4 h-4 mr-2 animate-spin"}),"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(At,{className:"w-4 h-4 mr-2"}),"Create Campaign"]})}),e.jsxs(U,{variant:"ghost",onClick:bs,className:"w-full",children:[e.jsx(Cr,{className:"w-4 h-4 mr-1"}),"Back"]})]})]},"review")]})})]})})}const AN={easy:{label:"Easy",color:"text-green-500 bg-green-500/10 border-green-500/20"},medium:{label:"Medium",color:"text-amber-500 bg-amber-500/10 border-amber-500/20"},hard:{label:"Hard",color:"text-red-500 bg-red-500/10 border-red-500/20"}},RN={daily:"Daily",weekly:"Weekly",custom:"Custom Days"};n.memo(function({suggestion:s,onToggle:r,index:a}){const i=s.type==="habit",o=AN[s.difficulty];return e.jsx(M.button,{initial:{opacity:0,y:20,scale:.95},animate:{opacity:1,y:0,scale:1},transition:{delay:a*.08,duration:.3},onClick:()=>r(s.id),className:A("w-full p-4 rounded-xl border-2 text-left transition-all duration-200","hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]",s.selected?"border-primary bg-primary/5 shadow-md":"border-border/50 bg-card hover:border-primary/30"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:A("w-6 h-6 rounded-full border-2 flex items-center justify-center shrink-0 mt-0.5 transition-all",s.selected?"border-primary bg-primary text-primary-foreground":"border-muted-foreground/30"),children:s.selected&&e.jsx(Pt,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[i?e.jsx(Rr,{className:"w-4 h-4 text-primary shrink-0"}):e.jsx(Mn,{className:"w-4 h-4 text-amber-500 shrink-0"}),e.jsx("span",{className:"font-semibold text-foreground truncate",children:s.title})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2 mb-2",children:Ri(s.description)}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("span",{className:A("text-xs px-2 py-0.5 rounded-full border",i?"text-primary bg-primary/10 border-primary/20":"text-amber-500 bg-amber-500/10 border-amber-500/20"),children:i?"Habit":"Milestone"}),i&&s.frequency&&e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-secondary text-secondary-foreground",children:RN[s.frequency]||s.frequency}),!i&&s.suggestedWeek&&e.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full bg-secondary text-secondary-foreground",children:["Week ",s.suggestedWeek]}),e.jsx("span",{className:A("text-xs px-2 py-0.5 rounded-full border",o.color),children:o.label}),s.category&&e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-muted text-muted-foreground",children:s.category})]})]})]})})});function IN({isVisible:t,campaignTitle:s,habits:r,onComplete:a}){const[i,o]=n.useState(!1),[l,c]=n.useState("title");return n.useEffect(()=>{if(!t){c("title"),o(!1);return}const d=setTimeout(()=>c("habits"),800),m=setTimeout(()=>o(!0),1200),p=setTimeout(()=>c("flyout"),2500+r.length*200),h=setTimeout(a,3500+r.length*200);return()=>{clearTimeout(d),clearTimeout(m),clearTimeout(p),clearTimeout(h)}},[t,r.length,a]),t?e.jsx(Pe,{children:e.jsxs(M.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-[100] flex items-center justify-center bg-background/95 backdrop-blur-sm",onClick:a,children:[i&&e.jsx(If,{width:window.innerWidth,height:window.innerHeight,recycle:!1,numberOfPieces:150,gravity:.3,colors:["#a855f7","#ec4899","#f59e0b","#10b981","#3b82f6"]}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",children:e.jsx(M.div,{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 rounded-full bg-primary/20 blur-3xl",animate:{scale:[1,1.2,1],opacity:[.3,.5,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}})}),e.jsxs("div",{className:"relative z-10 flex flex-col items-center gap-6 px-6 max-w-md mx-auto",children:[e.jsxs(M.div,{initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",damping:12,stiffness:200},className:"text-center",children:[e.jsxs(M.div,{className:"flex items-center justify-center gap-2 mb-2",animate:{scale:[1,1.05,1]},transition:{duration:1.5,repeat:1/0},children:[e.jsx(pe,{className:"w-6 h-6 text-stardust-gold"}),e.jsx("span",{className:"text-sm font-medium text-stardust-gold uppercase tracking-wider",children:"Campaign Created!"}),e.jsx(pe,{className:"w-6 h-6 text-stardust-gold"})]}),e.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-primary via-purple-500 to-accent bg-clip-text text-transparent",children:s})]}),e.jsx(Pe,{children:l!=="title"&&e.jsxs(M.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"w-full space-y-2",children:[e.jsx(M.p,{initial:{opacity:0},animate:{opacity:1},className:"text-center text-sm text-muted-foreground mb-3",children:"Cosmiq Rituals added to Today's Agenda"}),r.map((d,m)=>e.jsxs(M.div,{initial:{opacity:0,x:-30,scale:.9},animate:l==="flyout"?{opacity:0,x:-100,y:200,scale:.5,transition:{delay:m*.1,duration:.4}}:{opacity:1,x:0,scale:1,transition:{delay:m*.15,type:"spring",damping:15}},className:"flex items-center gap-3 p-3 rounded-xl bg-card/80 border border-accent/30 backdrop-blur-sm",children:[e.jsx("div",{className:"flex-shrink-0 w-8 h-8 rounded-full bg-accent/20 flex items-center justify-center",children:e.jsx(Rr,{className:"w-4 h-4 text-accent"})}),e.jsx("span",{className:"flex-1 text-sm font-medium truncate",children:d.title}),e.jsx(M.div,{initial:{scale:0},animate:{scale:1},transition:{delay:m*.15+.3,type:"spring"},children:e.jsx(Ar,{className:"w-5 h-5 text-primary"})})]},m))]})}),l==="habits"&&e.jsxs(M.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:r.length*.15+.3},className:"flex items-center gap-2 px-4 py-2 rounded-full bg-accent/20 border border-accent/40",children:[e.jsx(pe,{className:"w-4 h-4 text-accent"}),e.jsxs("span",{className:"text-sm font-semibold text-accent",children:[r.length," Cosmiq Ritual",r.length!==1?"s":""," Ready"]})]}),e.jsx(M.p,{initial:{opacity:0},animate:{opacity:.5},transition:{delay:2},className:"text-xs text-muted-foreground",children:"Tap anywhere to continue"})]})]})}):null}class LN extends n.Component{constructor(s){super(s),this.state={hasError:!1,error:null,errorCount:0}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,r){const{section:a}=this.props;oe.error(`SectionErrorBoundary [${a}] caught error`,{section:a,error:s.message,stack:s.stack,componentStack:r.componentStack}),this.setState(i=>({errorCount:i.errorCount+1}))}handleRetry=()=>{const{onRetry:s,section:r}=this.props;oe.info(`Retrying section: ${r}`),this.setState({hasError:!1,error:null}),s&&s()};render(){const{hasError:s,error:r,errorCount:a}=this.state,{children:i,section:o,title:l="Something went wrong",description:c="This section couldn't load properly",icon:d=Xs,fallback:m,showRetry:p=!0,compact:h=!1,className:f=""}=this.props;if(!s)return i;if(m)return m;const u=3,g=p&&a<u;return h?e.jsxs("div",{className:`flex items-center gap-3 p-3 rounded-lg bg-destructive/10 border border-destructive/20 ${f}`,children:[e.jsx(d,{className:"h-5 w-5 text-destructive flex-shrink-0"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("p",{className:"text-sm font-medium text-destructive truncate",children:l})}),g&&e.jsx(U,{variant:"ghost",size:"sm",onClick:this.handleRetry,className:"flex-shrink-0",children:e.jsx(ir,{className:"h-4 w-4"})})]}):e.jsxs(We,{className:`p-6 text-center ${f}`,children:[e.jsx(d,{className:"h-12 w-12 text-destructive mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:l}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:c}),!1,g?e.jsxs(U,{variant:"outline",size:"sm",onClick:this.handleRetry,className:"gap-2",children:[e.jsx(ir,{className:"h-4 w-4"}),"Try Again"]}):a>=u?e.jsx("p",{className:"text-xs text-muted-foreground",children:"Please refresh the page or try again later"}):null]})}}const qN=({children:t})=>e.jsx(LN,{section:"quests",title:"Quests unavailable",description:"Unable to load your quests right now",children:t});function ON(t){const{user:s}=be(),r=Ae(),a=Ee({queryKey:Qt.contactInteractions.byContact(t??""),queryFn:async()=>{if(!t)return[];const{data:l,error:c}=await S.from("contact_interactions").select("*").eq("contact_id",t).order("occurred_at",{ascending:!1});if(c)throw c;return l},enabled:!!s&&!!t}),i=le({mutationFn:async l=>{if(!s)throw new Error("Not authenticated");const{data:c,error:d}=await S.from("contact_interactions").insert({...l,user_id:s.id,occurred_at:l.occurred_at??new Date().toISOString()}).select().single();if(d)throw d;return c},onSuccess:(l,c)=>{r.invalidateQueries({queryKey:Qt.contactInteractions.byContact(c.contact_id)}),r.invalidateQueries({queryKey:Qt.contacts.all}),W.success("Interaction logged")},onError:l=>{W.error("Failed to log interaction"),console.error("Create interaction error:",l)}}),o=le({mutationFn:async({id:l,contactId:c})=>{const{error:d}=await S.from("contact_interactions").delete().eq("id",l);if(d)throw d;return c},onSuccess:l=>{r.invalidateQueries({queryKey:Qt.contactInteractions.byContact(l)}),W.success("Interaction deleted")},onError:l=>{W.error("Failed to delete interaction"),console.error("Delete interaction error:",l)}});return{interactions:a.data??[],isLoading:a.isLoading,createInteraction:i,deleteInteraction:o}}function FN(){const[t,s]=n.useState(null),{createInteraction:r}=ON(t?.contact?.id),a=n.useCallback((c,d,m,p)=>{m&&p&&s({taskId:c,taskText:d,contact:m,autoLogInteraction:p})},[]),i=n.useCallback(async(c,d)=>{t&&(await r.mutateAsync({contact_id:t.contact.id,interaction_type:c,summary:d}),s(null))},[t,r]),o=n.useCallback(()=>{s(null)},[]),l=n.useCallback(()=>{s(null)},[]);return{pendingInteraction:t,isModalOpen:!!t,handleTaskCompleted:a,logInteraction:i,skipInteraction:o,closeModal:l,isLogging:r.isPending}}const $N=[{value:"call",label:"Call",icon:qf},{value:"email",label:"Email",icon:Dd},{value:"meeting",label:"Meeting",icon:$t},{value:"message",label:"Message",icon:Id},{value:"note",label:"Note",icon:ya}];function HN({open:t,onOpenChange:s,contactName:r,contactAvatarUrl:a,taskTitle:i,onLog:o,onSkip:l}){const[c,d]=n.useState(""),[m,p]=n.useState(i),[h,f]=n.useState(!1),u=n.useMemo(()=>{const v=i.toLowerCase();return v.includes("call")||v.includes("phone")?"call":v.includes("email")||v.includes("send")||v.includes("write")?"email":v.includes("meet")||v.includes("lunch")||v.includes("coffee")?"meeting":v.includes("text")||v.includes("message")?"message":"note"},[i]);Lf.useEffect(()=>{c||d(u)},[u,c]);const g=async()=>{if(!(!c||!m.trim())){f(!0);try{await o(c,m.trim()),s(!1)}finally{f(!1)}}},y=()=>{l(),s(!1)},b=r.split(" ").map(v=>v[0]).join("").toUpperCase().slice(0,2);return e.jsx(ns,{open:t,onOpenChange:s,children:e.jsxs(Vt,{className:"sm:max-w-md",children:[e.jsxs(Bs,{children:[e.jsx(xs,{children:"Log Interaction"}),e.jsxs(dr,{children:["Record this as an interaction with ",r,"?"]})]}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-muted/50",children:[e.jsxs(Lr,{className:"h-10 w-10",children:[e.jsx(qr,{src:a||void 0}),e.jsx(Or,{className:"bg-primary/10 text-primary text-sm",children:b})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:r}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Type"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:$N.map(v=>{const x=v.icon,w=c===v.value;return e.jsxs("button",{type:"button",onClick:()=>d(v.value),className:A("flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm transition-all",w?"bg-primary text-primary-foreground":"bg-muted hover:bg-muted/80 text-foreground"),children:[e.jsx(x,{className:"h-3.5 w-3.5"}),v.label]},v.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Summary"}),e.jsx(Kt,{value:m,onChange:v=>p(v.target.value),placeholder:"What happened?",rows:2})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(U,{variant:"outline",onClick:y,className:"flex-1",disabled:h,children:"Just Complete"}),e.jsx(U,{onClick:g,className:"flex-1",disabled:!c||!m.trim()||h,children:h?e.jsxs(e.Fragment,{children:[e.jsx(bt,{className:"h-4 w-4 mr-2 animate-spin"}),"Logging..."]}):"Log & Complete"})]})]})})}const yn="/journeys",BN=(t,s)=>t!==yn&&s===yn,UN=(t,s=new Date)=>wa(t,s)?t:s,zN=t=>t?.walkthrough_completed===!0,QN=(t,s,r)=>t?!1:s===!0||zN(r),KN=/^([01]\d|2[0-3]):([0-5]\d)$/,WN=/^\d{4}-\d{2}-\d{2}$/,GN=()=>{const t=Ea(),s=Ma(),r=as(),{isTabActive:a}=La(),[i,o]=n.useState(new Date),[l,c]=n.useState(!1),[d,m]=n.useState(!1),[p,h]=n.useState(null),[f,u]=n.useState(!1),[g,y]=n.useState(!1),[b,v]=n.useState(!1),[x,w]=n.useState(null),[j,D]=n.useState(null),C=n.useRef(s.pathname),_=n.useRef(s.pathname),{user:N}=be(),E=Ae(),{profile:k,loading:P}=Yt(),{needsStreakDecision:T,currentStreak:I,freezesAvailable:R,useFreeze:L,resetStreak:$,isResolving:q}=rN();n.useEffect(()=>{_.current=s.pathname},[s.pathname]),n.useEffect(()=>{const Z=C.current;BN(Z,s.pathname)&&o(()=>new Date),C.current=s.pathname},[s.pathname]);const F=n.useCallback(()=>{_.current===yn&&o(Z=>UN(Z))},[]);n.useEffect(()=>{if(!a||nt.isNativePlatform())return;const Z=()=>{document.visibilityState==="visible"&&F()};return document.addEventListener("visibilitychange",Z),()=>{document.removeEventListener("visibilitychange",Z)}},[a,F]),n.useEffect(()=>{if(!a||!nt.isNativePlatform())return;let Z=!1,we=null;return(async()=>{const Ye=await Dr.addListener("appStateChange",({isActive:yt})=>{yt&&F()});if(Z){await Ye.remove();return}we=Ye})(),()=>{Z=!0,we&&we.remove()}},[a,F]);const{trackDailyPlanOutcome:H}=So(),{epics:J,createEpic:G,isCreating:re}=mN({enabled:a}),ie=n.useMemo(()=>J?.filter(Z=>Z.status==="active").slice(0,5)||[],[J]),{currentStreak:K}=co(),{sendTaskToCalendar:xe,syncTaskUpdate:Te,syncTaskDelete:Ne,syncProviderPull:B,hasLinkedEvent:z}=Wm({enabled:a}),{connections:Q}=zn({enabled:a}),{pendingInteraction:Y,isModalOpen:ue,handleTaskCompleted:fe,logInteraction:De,skipInteraction:Ce,closeModal:Be}=FN(),{tasks:qe,isLoading:he,addTask:ye,toggleTask:Ue,updateTask:Re,deleteTask:Ie,restoreTask:ee,moveTaskToDate:ne,completedCount:X,totalCount:ae,isAdding:Se,isUpdating:ve,isDeleting:_e}=Jj(i,{enabled:a}),[Me,et]=n.useState(null),[Je,lt]=n.useState(null),{tasks:dt}=Zj(i,"month",{enabled:a}),{surfaceAllEpicHabits:Mt,unsurfacedEpicHabitsCount:vt}=eN(),{pendingRecurringCount:Rt,spawnRecurringTasks:me}=tN(i),Le=n.useRef(!1),Xe=n.useRef(!1),pt=n.useRef(te(i,"yyyy-MM-dd"));n.useEffect(()=>{if(!a)return;const Z=te(i,"yyyy-MM-dd");pt.current!==Z&&(pt.current=Z,Le.current=!1,Xe.current=!1),vt>0&&!Le.current&&(Le.current=!0,Mt()),Rt>0&&!Xe.current&&(Xe.current=!0,me())},[a,vt,Rt,i,Mt,me]);const ce=k?.onboarding_data??null,Oe=QN(P,k?.onboarding_completed,ce);lN(N?.id,Oe,P);const Ke=n.useCallback(async Z=>{if(Z.habit_source_id){const{data:we}=await S.from("habits").select("frequency, custom_days, description").eq("id",Z.habit_source_id).maybeSingle();lt({habitId:Z.habit_source_id,taskId:Z.id,title:Z.task_text,description:we?.description||null,difficulty:Z.difficulty||"medium",frequency:we?.frequency||"daily",custom_days:we?.custom_days||[],estimated_minutes:Z.estimated_duration,preferred_time:Z.scheduled_time,category:Z.category,recurrence_pattern:Z.recurrence_pattern,recurrence_days:Z.recurrence_days,reminder_enabled:Z.reminder_enabled,reminder_minutes_before:Z.reminder_minutes_before})}else et(Z)},[]),{pendingTaskId:ct,clearPendingTask:ut}=sx(),Dt=n.useRef(null);n.useEffect(()=>{if(!a||!ct||Dt.current===ct||he)return;const Z=qe.find(we=>we.id===ct);Z?(oe.log("[Journeys] Opening deep-linked task:",ct),Dt.current=ct,Ke(Z),ut()):(oe.log("[Journeys] Deep link task not found in daily tasks:",ct),Dt.current=ct,ut())},[a,ct,qe,he,ut,Ke]);const kt=n.useMemo(()=>{const Z={};return dt.forEach(we=>{we.task_date&&(Z[we.task_date]=(Z[we.task_date]||0)+1)}),Z},[dt]),is=n.useCallback(async Z=>{const we=()=>{W.error("No calendar connected. Opening Preferences..."),r("/profile",{state:{openTab:"preferences"}})};if(Q.length===0){we();return}let ht,Ye;const yt=async()=>{await xe.mutateAsync({taskId:Z,options:ht||Ye?{taskDate:ht,scheduledTime:Ye}:void 0})};try{await yt(),W.success("Quest synced to calendar");return}catch(zs){let Ct=zs instanceof Error?zs.message:"Failed to send quest to calendar";if(Ct.includes("NO_CALENDAR_CONNECTION")){we();return}for(let Fa=0;Fa<2;Fa+=1){if(Ct.includes("NO_CALENDAR_CONNECTION")){we();return}if(Ct.includes("TASK_DATE_REQUIRED")&&!ht){const Ut=window.prompt("Choose a date to send this quest (YYYY-MM-DD)",te(i,"yyyy-MM-dd"));if(!Ut||!WN.test(Ut)){W.error("Calendar send cancelled. Please choose a valid YYYY-MM-DD date.");return}ht=Ut}if((Ct.includes("SCHEDULED_TIME_REQUIRED")||Ct.includes("SCHEDULED_TIME_INVALID"))&&!Ye){const Ut=window.prompt("Choose a time to send this quest (HH:mm)","09:00");if(!Ut||!KN.test(Ut)){W.error("Calendar send cancelled. Please choose a valid HH:mm time.");return}Ye=Ut}try{await yt(),W.success("Quest synced to calendar");return}catch(Ut){if(Ct=Ut instanceof Error?Ut.message:"Failed to send quest to calendar",Ct.includes("NO_CALENDAR_CONNECTION")){we();return}if(!Ct.includes("TASK_DATE_REQUIRED")&&!Ct.includes("SCHEDULED_TIME_REQUIRED")&&!Ct.includes("SCHEDULED_TIME_INVALID")){W.error(Ct);return}}}if(Ct.includes("TASK_DATE_REQUIRED")){W.error("Please assign a date before sending this quest to calendar.");return}if(Ct.includes("SCHEDULED_TIME_REQUIRED")||Ct.includes("SCHEDULED_TIME_INVALID")){W.error("Please assign a time before sending this quest to calendar.");return}W.error(Ct)}},[Q.length,r,i,xe]),bs=n.useCallback(async Z=>{const we=Z.sendToInbox?null:Z.taskDate??te(i,"yyyy-MM-dd"),ht=await ye({taskText:Z.text,difficulty:Z.difficulty,taskDate:we,isMainQuest:!1,scheduledTime:Z.scheduledTime,estimatedDuration:Z.estimatedDuration,recurrencePattern:Z.recurrencePattern,recurrenceDays:Z.recurrenceDays,reminderEnabled:Z.reminderEnabled,reminderMinutesBefore:Z.reminderMinutesBefore,notes:Z.moreInformation,location:Z.location,contactId:Z.contactId,autoLogInteraction:Z.autoLogInteraction,subtasks:Z.subtasks,imageUrl:Z.imageUrl,attachments:Z.attachments});Z.sendToCalendar&&ht?.id&&await is(ht.id),m(!1)},[i,ye,is]),Jt=n.useCallback((Z,we,ht,Ye)=>{we&&Ye?.ai_generated&&H(Z,"completed",{scheduledTime:Ye.scheduled_time??void 0,difficulty:Ye.difficulty??void 0,category:Ye.category??void 0,wasOnTime:!0}),Ue({taskId:Z,completed:we,xpReward:ht},{onSuccess:yt=>{yt.completed&&yt.contact&&yt.autoLogInteraction&&fe(yt.taskId,yt.taskText,yt.contact,yt.autoLogInteraction)}})},[Ue,H,fe]),It=n.useCallback((Z,we)=>{Ue({taskId:Z,completed:!1,xpReward:we,forceUndo:!0})},[Ue]),As=n.useCallback(async(Z,we)=>{await Re({taskId:Z,updates:we}),await Te.mutateAsync({taskId:Z}).catch(()=>{W.error("Saved quest, but failed to sync linked calendar event")}),et(null)},[Re,Te]),Us=n.useCallback(async(Z,we)=>{we&&H(Z,"deleted"),await Ne.mutateAsync({taskId:Z}).catch(()=>{W.error("Failed to remove linked calendar event")}),await Ie(Z),W.success("Quest deleted"),et(null)},[Ie,H,Ne]),ge=n.useCallback(async Z=>{if(N?.id){try{const{error:we}=await S.from("habits").delete().eq("id",Z).eq("user_id",N.id);if(we)throw we;const{error:ht}=await S.from("daily_tasks").delete().eq("habit_source_id",Z).eq("user_id",N.id).eq("completed",!1);ht&&console.error("Error deleting linked tasks:",ht),E.invalidateQueries({queryKey:["habits"]}),E.invalidateQueries({queryKey:["daily-tasks"]}),E.invalidateQueries({queryKey:["epics"]}),W.success("Ritual deleted")}catch(we){console.error("Error deleting ritual:",we),W.error("Failed to delete ritual")}lt(null)}},[N?.id,E]),it=n.useCallback(Z=>{o(Z)},[]),xt=n.useCallback(async Z=>{const we=qe.find(Ye=>Ye.id===Z);if(!we)return;const ht={task_text:we.task_text,task_date:we.task_date,xp_reward:we.xp_reward,difficulty:we.difficulty,scheduled_time:we.scheduled_time,estimated_duration:we.estimated_duration,is_main_quest:we.is_main_quest,epic_id:we.epic_id,sort_order:we.sort_order,priority:we.priority,energy_level:we.energy_level,category:we.category,habit_source_id:we.habit_source_id,is_recurring:we.is_recurring,recurrence_pattern:we.recurrence_pattern,recurrence_days:we.recurrence_days,reminder_enabled:we.reminder_enabled,reminder_minutes_before:we.reminder_minutes_before};try{await fs.impact({style:Wt.Medium})}catch{}await Ne.mutateAsync({taskId:Z}).catch(()=>{W.error("Failed to remove linked calendar event")}),await Ie(Z),W("Quest deleted",{duration:4e3,action:{label:"Undo",onClick:async()=>{try{await ee(ht),W.success("Quest restored")}catch{W.error("Failed to restore quest")}}}})},[qe,Ie,ee,Ne]),st=n.useCallback(async Z=>{const ht=qe.find(zs=>zs.id===Z)?.task_date;try{await fs.impact({style:Wt.Light})}catch{}const Ye=Cs(i,1),yt=te(Ye,"yyyy-MM-dd");ne({taskId:Z,targetDate:yt}),W(`Moved to ${te(Ye,"EEEE, MMM d")}`,{duration:4e3,action:{label:"Undo",onClick:()=>{ht&&(ne({taskId:Z,targetDate:ht}),W.success("Move undone"))}}})},[qe,i,ne]);n.useEffect(()=>{if(!a)return;const Z=Q.filter(Ye=>Ye.sync_mode==="full_sync"&&(Ye.provider==="google"||Ye.provider==="outlook")).map(Ye=>Ye.provider);if(Z.length===0)return;const we=()=>{for(const Ye of Z)B.mutate({provider:Ye})};we();const ht=window.setInterval(()=>{we()},120*1e3);return()=>{window.clearInterval(ht)}},[a,Q,B]);const Bt=n.useCallback(async Z=>{try{await G(Z),y(!1),w({title:Z.title,habits:Z.habits.map(we=>({title:we.title}))}),v(!0)}catch(we){console.error("Failed to create campaign:",we)}},[G]),vs=n.useCallback(()=>{v(!1),w(null)},[]);return e.jsxs(Ia,{mode:"instant",children:[e.jsx(qa,{}),e.jsxs("div",{className:"min-h-screen pb-nav-safe pt-safe px-4 relative z-10",children:[e.jsxs(M.div,{initial:t?!1:{opacity:0,y:-14},animate:{opacity:1,y:0},transition:{duration:t?0:.22},className:"mb-6 text-center relative",children:[e.jsx("div",{className:"absolute right-0 top-0",children:e.jsx(_j,{onClick:()=>c(!0)})}),e.jsx("h1",{className:"text-3xl font-semibold tracking-tight mb-2 bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent",children:"Quests"}),e.jsx("p",{className:"text-sm text-muted-foreground/90",children:j?`Dragging to ${qs(j)}`:"Daily quests. Your path to progress."})]}),e.jsxs(qN,{children:[e.jsx(M.div,{initial:t?!1:{opacity:0,scale:.98},animate:{opacity:1,scale:1},transition:{delay:t?0:.04,duration:t?0:.2},className:"mb-4",children:e.jsx(wj,{selectedDate:i,onDateSelect:it,tasksPerDay:kt,isActive:a})}),e.jsx(M.div,{initial:t?!1:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{delay:t?0:.1,duration:t?0:.2},children:e.jsx(xj,{tasks:qe,selectedDate:i,isVisible:s.pathname===yn,onToggle:Jt,onAddQuest:()=>{h(null),m(!0)},completedCount:X,totalCount:ae,currentStreak:K,onUndoToggle:It,onEditQuest:Ke,calendarTasks:dt,calendarMilestones:[],onDateSelect:o,activeEpics:ie,onDeleteQuest:xt,onSendToCalendar:is,hasCalendarLink:z,onMoveQuestToNextDay:st,onUpdateScheduledTime:(Z,we)=>{Re({taskId:Z,updates:{scheduled_time:we}}),Te.mutate({taskId:Z})},onTimeSlotLongPress:(Z,we)=>{o(Z),h(we),m(!0)},onTimelineDragPreviewTimeChange:D})})]}),e.jsx(Um,{open:d,onOpenChange:m,selectedDate:i,onAdd:bs,isAdding:Se,prefilledTime:p,onCreateCampaign:()=>y(!0)}),e.jsx(zm,{task:Me,open:!!Me&&!Me.habit_source_id,onOpenChange:Z=>!Z&&et(null),onSave:As,isSaving:ve,onSendToCalendar:is,hasCalendarLink:Me?z(Me.id):!1,isSendingToCalendar:xe.isPending,onDelete:Us,isDeleting:_e}),e.jsx(Fj,{ritual:Je,open:!!Je,onOpenChange:Z=>!Z&&lt(null),onDelete:ge}),e.jsx(jj,{open:l,onClose:()=>c(!1),title:"About Quests",icon:Ld,description:"Quests unite your daily tasks and recurring rituals into one powerful view.",features:["Complete daily quests to earn XP","Rituals repeat automatically to build habits","Track your streak and maintain momentum"],tip:"Add quests by tapping the + button in the corner!"}),e.jsx(Nj,{open:T,currentStreak:I,freezesAvailable:R,onUseFreeze:L,onResetStreak:$,isResolving:q}),e.jsx(HN,{open:ue,onOpenChange:Be,contactName:Y?.contact?.name??"",contactAvatarUrl:Y?.contact?.avatar_url,taskTitle:Y?.taskText??"",onLog:async(Z,we)=>{await De(Z,we)},onSkip:Ce}),qe.some(Z=>Z.ai_generated)&&e.jsx(M.button,{initial:t?!1:{scale:.9,opacity:0},animate:{scale:1},transition:{duration:t?0:.2},className:"fixed bottom-24 right-4 z-40 p-3 rounded-full bg-card/92 backdrop-blur-xl border border-border/60 shadow-[0_10px_24px_rgba(0,0,0,0.28)] active:scale-95 transition-transform",onClick:()=>u(!0),"aria-label":"Open quick adjust",children:e.jsx(Vs,{className:"h-5 w-5 text-primary"})}),e.jsx(pN,{open:f,onOpenChange:u,tasks:qe,selectedDate:i,onComplete:()=>{E.invalidateQueries({queryKey:["daily-tasks"]}),u(!1)}}),e.jsx(PN,{open:g,onOpenChange:y,onCreateEpic:Bt,isCreating:re,showTemplatesFirst:!1}),e.jsx(IN,{isVisible:b,campaignTitle:x?.title||"",habits:x?.habits||[],onComplete:vs}),e.jsx(Tm,{onTap:()=>{h(null),m(!0)}})]})]})},kp=["/mentor","/inbox","/journeys","/companion"],YN={"/mentor":Ib,"/inbox":Fw,"/journeys":GN,"/companion":Wv},Cp=t=>kp.includes(t),VN={"/mentor":0,"/inbox":0,"/journeys":0,"/companion":0},nc=1,Sp=n.memo(({activePath:t})=>{const s=Ae(),{user:r}=be(),[a,i]=n.useState([t]),o=n.useRef(t),l=n.useRef(new Set([t])),c=n.useRef(VN),d=n.useRef(!1),m=n.useRef([]),p=n.useCallback(()=>{if(!r?.id)return;const h=te(new Date,"yyyy-MM-dd");s.prefetchQuery({queryKey:ko(r.id,h),queryFn:()=>Co(r.id,h),staleTime:jo,gcTime:No}).catch(()=>{})},[s,r?.id]);return n.useEffect(()=>{p()},[p]),n.useEffect(()=>{i(h=>h.includes(t)?h:[...h,t])},[t]),n.useLayoutEffect(()=>{const h=o.current;h!==t&&(c.current[h]=window.scrollY);const u=l.current.has(t)?c.current[t]??0:0;if(l.current.add(t),o.current=t,!d.current){d.current=!0;return}if(Math.abs(window.scrollY-u)<=nc)return;const g=window.requestAnimationFrame(()=>{const y=window.requestAnimationFrame(()=>{Math.abs(window.scrollY-u)<=nc||window.scrollTo({top:u,left:0,behavior:"auto"})});m.current.push(y)});return m.current.push(g),()=>{for(const y of m.current)window.cancelAnimationFrame(y);m.current=[]}},[t]),e.jsx("div",{className:"relative",children:kp.map(h=>{if(!a.includes(h))return null;const f=YN[h],u=h===t;return e.jsx("div",{style:{display:u?"block":"none"},"aria-hidden":!u,children:e.jsx(Sb,{isTabActive:u,children:e.jsx("section",{children:e.jsx(f,{})})})},h)})})});Sp.displayName="MainTabsKeepAlive";const oa=n.forwardRef(({className:t,activeClassName:s,pendingClassName:r,to:a,...i},o)=>e.jsx(Of,{ref:o,to:a,className:({isActive:l,isPending:c})=>A(t,l&&s,c&&r),...i}));oa.displayName="NavLink";const Ep=n.memo(({isActive:t=!1})=>{const{presence:s,isLoading:r}=Rn(),{navGlow:a,primaryAura:i}=bm(),[o,l]=n.useState(!1);if(n.useEffect(()=>{const m=window.matchMedia("(prefers-reduced-motion: reduce)");l(m.matches);const p=()=>l(m.matches);return m.addEventListener("change",p),()=>m.removeEventListener("change",p)},[]),r||!s.isPresent)return null;const c=!o&&(s.mood==="joyful"||s.mood==="content"),d=s.needsAttention&&!t;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute inset-0 rounded-full -z-10",style:{boxShadow:a,animation:c?`companion-nav-breathe ${3/s.pulseRate}s ease-in-out infinite`:"none",willChange:c?"box-shadow":"auto"}}),d&&e.jsx("div",{className:"absolute -top-0.5 -right-0.5 w-2 h-2 rounded-full",style:{backgroundColor:i,boxShadow:`0 0 6px ${i}`,animation:o?"none":"companion-attention-pulse 2s ease-in-out infinite"}}),e.jsx("style",{children:`
        @keyframes companion-nav-breathe {
          0%, 100% {
            opacity: 0.6;
            transform: scale(1);
          }
          50% {
            opacity: 1;
            transform: scale(1.05);
          }
        }

        @keyframes companion-attention-pulse {
          0%, 100% {
            opacity: 0.7;
            transform: scale(1);
          }
          50% {
            opacity: 1;
            transform: scale(1.3);
          }
        }
      `})]})});Ep.displayName="CompanionNavPresence";const Tp=n.memo(()=>{const t=Ae(),{user:s}=be(),{profile:r}=Yt(),{companion:a,progressToNext:i}=Tt(),{inboxCount:o}=rw(),l=n.useCallback(()=>{if(!s?.id)return;const h=te(new Date,"yyyy-MM-dd");t.prefetchQuery({queryKey:ko(s.id,h),queryFn:()=>Co(s.id,h),staleTime:jo,gcTime:No}).catch(()=>{})},[t,s?.id]),c=n.useCallback(h=>{h==="journeys"&&l()},[l]),d=Br(r),{data:m,isLoading:p}=Ee({queryKey:["selected-mentor",d],enabled:!!d,staleTime:600*1e3,queryFn:async()=>{if(!d)throw new Error("No mentor selected");const{data:h,error:f}=await S.from("mentors").select("slug, name, primary_color").eq("id",d).maybeSingle();if(f)throw f;return h}});return e.jsx(e.Fragment,{children:e.jsx("nav",{className:"fixed bottom-0 left-0 right-0 cosmiq-glass-nav z-50 border-t border-border/40 transition-transform duration-200",role:"navigation","aria-label":"Main navigation",style:{paddingBottom:"env(safe-area-inset-bottom, 0px)"},children:e.jsxs("div",{className:"max-w-lg mx-auto flex items-center justify-around px-2 sm:px-4 py-2.5",children:[e.jsx(oa,{to:"/mentor",className:"flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition-all duration-200 active:scale-95 touch-manipulation min-w-[58px] min-h-[56px]",activeClassName:"bg-orange-500/12","data-tour":"mentor-tab",onClick:()=>mt.light(),onMouseEnter:()=>c("mentor"),onFocus:()=>c("mentor"),children:({isActive:h})=>e.jsxs(e.Fragment,{children:[p?e.jsx("div",{className:"h-7 w-7 rounded-full bg-muted animate-pulse","aria-hidden":!0}):m?e.jsx(pa,{mentorSlug:m.slug||"",mentorName:m.name,primaryColor:m.primary_color||"#000",size:"sm",className:"w-7 h-7",showBorder:!1}):e.jsx(fd,{className:`h-6 w-6 transition-colors duration-200 ${h?"text-orange-300":"text-muted-foreground"}`}),e.jsx("span",{className:`text-[11px] font-medium transition-colors duration-200 ${h?"text-orange-200":"text-muted-foreground/85"}`,children:"Mentor"})]})}),e.jsx(oa,{to:"/inbox",className:"flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition-all duration-200 active:scale-95 touch-manipulation min-w-[58px] min-h-[56px] relative",activeClassName:"bg-celestial-blue/12",onClick:()=>mt.light(),onMouseEnter:()=>c("inbox"),onFocus:()=>c("inbox"),children:({isActive:h})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(to,{className:`h-6 w-6 transition-colors duration-200 ${h?"text-celestial-blue":"text-muted-foreground"}`}),o>0&&e.jsx(Fe,{className:"absolute -top-1 -right-2 h-4 min-w-[16px] px-1 p-0 flex items-center justify-center text-[9px] bg-celestial-blue text-white border-0",children:o>9?"9+":o})]}),e.jsx("span",{className:`text-[11px] font-medium transition-colors duration-200 ${h?"text-celestial-blue":"text-muted-foreground/85"}`,children:"Inbox"})]})}),e.jsx(oa,{to:"/journeys",className:"flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition-all duration-200 active:scale-95 touch-manipulation min-w-[58px] min-h-[56px]",activeClassName:"bg-cosmiq-glow/12","data-tour":"quests-tab",onClick:()=>mt.light(),onPointerDown:l,onMouseEnter:()=>c("journeys"),onFocus:()=>c("journeys"),children:({isActive:h})=>e.jsxs(e.Fragment,{children:[e.jsx(Ld,{className:`h-6 w-6 transition-colors duration-200 ${h?"text-cosmiq-glow":"text-muted-foreground"}`}),e.jsx("span",{className:`text-[11px] font-medium transition-colors duration-200 ${h?"text-cosmiq-glow":"text-muted-foreground/85"}`,children:"Quests"})]})}),e.jsx(oa,{to:"/companion",className:"flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition-all duration-200 active:scale-95 touch-manipulation min-w-[58px] min-h-[56px] relative",activeClassName:"bg-stardust-gold/12","data-tour":"companion-tab",onClick:()=>mt.light(),onMouseEnter:()=>c("companion"),onFocus:()=>c("companion"),children:({isActive:h})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(Ep,{isActive:h}),e.jsx(Ff,{fill:"currentColor",className:`h-6 w-6 -rotate-45 transition-colors duration-200 ${h?"text-stardust-gold":"text-muted-foreground"}`}),a&&i>90&&e.jsx(Fe,{className:"absolute -top-1 -right-1 h-4 w-4 p-0 flex items-center justify-center text-[9px] bg-stardust-gold text-black animate-pulse",children:"!"})]}),e.jsx("span",{className:`text-[11px] font-medium transition-colors duration-200 ${h?"text-stardust-gold":"text-muted-foreground/85"}`,children:"Companion"})]})})]})})})});Tp.displayName="BottomNav";const XN=new Set(["/welcome","/terms","/privacy","/test-scroll","/test-day-planner"]),JN=["/auth","/onboarding"],ZN=t=>JN.some(s=>t===s||t.startsWith(`${s}/`)),e1=(t,s)=>!(!s||XN.has(t)||ZN(t)),Si=2,mn=2,ic=250,t1=1400,s1=2600,Ei='[data-tour="evolve-companion-button"]',oc=72,r1={create_quest:4,morning_checkin:3},ms=[{id:"quests_campaigns_intro",route:"/journeys"},{id:"create_quest",route:"/journeys"},{id:"morning_checkin",route:"/mentor"},{id:"evolve_companion",route:"/companion"},{id:"post_evolution_companion_intro",route:"/companion"},{id:"mentor_closeout",route:"/companion"}],Ys=["open_add_quest","enter_title","select_time","submit_create_quest"],lc=new Set(ms.map(t=>t.id)),a1=new Set([...ms.map(t=>t.id),"meet_companion"]),n1=new Set([...Ys,"stay_on_quests","quests_campaigns_intro"]),Mp=t=>typeof t=="string"&&a1.has(t),cc=t=>typeof t=="string"&&n1.has(t),Eo=t=>!!t&&typeof t=="object"&&!Array.isArray(t),i1=new Set(["mentor_intro_hello","stay_on_quests","quests_campaigns_intro","open_add_quest","enter_title","select_time","submit_create_quest","open_companion_tab","confirm_companion_progress","open_mentor_tab","submit_morning_checkin","tap_evolve_companion","complete_companion_evolution","post_evolution_companion_intro","mentor_closeout_message"]),o1=t=>typeof t=="string"&&i1.has(t),dc=t=>Array.isArray(t)?t.filter(o1):[],_r=(t,s)=>{typeof window>"u"||window.dispatchEvent(new CustomEvent(t,{detail:s}))},l1=t=>{switch(t){case"mentor_intro_hello":return[];case"quests_campaigns_intro":case"post_evolution_companion_intro":return[];case"stay_on_quests":return['[data-tour="quests-tab"]'];case"open_add_quest":return['[data-tour="add-quest-fab"]'];case"enter_title":return['[data-tour="add-quest-title-input"]'];case"select_time":return['[data-tour="add-quest-time-chip"]','[data-tour="add-quest-time-input"]'];case"submit_create_quest":return['[data-tour="add-quest-create-button"]'];case"open_companion_tab":return['[data-tour="companion-tab"]'];case"confirm_companion_progress":return['[data-tour="companion-progress-area"]','[data-tour="companion-page"]'];case"open_mentor_tab":return['[data-tour="mentor-tab"]'];case"submit_morning_checkin":return['[data-tour="checkin-submit"]','[data-tour="morning-checkin"]'];case"tap_evolve_companion":return['[data-tour="evolve-companion-button"]'];case"complete_companion_evolution":case"mentor_closeout_message":return[];default:return[]}},uc={atlas:{text:"Welcome. We begin with one deliberate step, then the next becomes clear.",support:"Stay with me for this short walkthrough, and your path will settle into focus."},eli:{text:"Hey, I'm glad you're here. We'll take this one clear step at a time together.",support:"Short walkthrough now, then you'll have a rhythm you can trust."},sienna:{text:"Hi, I'm really glad you're here. We'll keep this gentle and steady together.",support:"I'll guide your first steps so this feels safe, clear, and doable."},stryker:{text:"You showed up. Good. We execute this fast and clean.",support:"Lock the walkthrough, then run your day like a mission."},carmen:{text:"Welcome. We're setting your standard from the first tap.",support:"Quick walkthrough, then your system is live and accountable."},reign:{text:"I love this energy. Let's set your pace and move with intention.",support:"Nail this walkthrough, then build momentum and own the day."},solace:{text:"Hi friend, you're in the right place. Let's begin with one steady win.",support:"I'll keep this calm and clear so you feel grounded right away."}},c1=(t,s)=>{const r=t?.toLowerCase();return r&&uc[r]?uc[r]:s&&s!=="Your mentor"?{text:`Hey, I'm ${s}. I'm glad you're here.`,support:"I'll guide your first few taps so you can settle in quickly."}:{text:"Hey, I'm your mentor. I'm glad you're here.",support:"I'll guide your first few taps so you can settle in quickly."}},mc={atlas:{text:"This is Quests: choose what matters now, or place a to-do for later.",support:"Campaigns are for long-term goals, pursued with steady direction over time."},eli:{text:"This is Quests. We can do a task now or save a to-do for later.",support:"Campaigns are how we go after long-term goals one step at a time."},sienna:{text:"This is Quests. You can handle something now or set a gentle to-do for later.",support:"Campaigns support your long-term goals so growth feels steady, not rushed."},stryker:{text:"This is Quests. Execute a task now or queue a to-do for later.",support:"Campaigns are for long-term goals; we run them with consistent follow-through."},carmen:{text:"This is Quests. Handle priority tasks now or schedule to-dos for later.",support:"Campaigns are your long-term goals, managed with structure and standards."},reign:{text:"This is Quests. Hit a task now or line up a to-do for later.",support:"Campaigns are for long-term goals and sustained momentum."},solace:{text:"This is Quests. You can take care of something now or leave a to-do for later.",support:"Campaigns hold your long-term goals so you can keep moving with calm consistency."}},d1=t=>{const s=t?.toLowerCase();return s&&mc[s]?mc[s]:{text:"This is Quests. You can do a task now or save a to-do for later.",support:"Campaigns are for long-term goals you want to pursue with consistency."}},u1=t=>{for(const s of t)if(document.querySelector(s))return s;return null},m1=(t,s)=>{const r=t.getBoundingClientRect();return r.top>=oc&&r.bottom<=s-oc},Ti=(t,s)=>{if(t.size!==s.size)return!1;for(const r of t)if(!s.has(r))return!1;return!0},bn=t=>{const s=new Set(t);return ms.map(r=>r.id).filter(r=>s.has(r))},vn=t=>{const s=new Set(t);return Ys.filter(r=>s.has(r))},wn=t=>{const s=new Set(t);return Ys.find(r=>!s.has(r))??"submit_create_quest"},pc=t=>{if(!Eo(t))return null;const s=Array.isArray(t.completed)?t.completed.filter(cc):[],r=vn(s.filter(o=>o!=="stay_on_quests"&&o!=="quests_campaigns_intro")),a=cc(t.current)?t.current:null;return{current:a&&Ys.includes(a)?a:wn(r),completed:r,startedAt:typeof t.startedAt=="string"?t.startedAt:void 0,completedAt:typeof t.completedAt=="string"?t.completedAt:void 0}},p1=(t,s)=>{const r=t?.completed??[],a=s?.completed??[],i=vn(new Set([...r,...a])),o=wn(i),l=i.length>=Ys.length;return{current:o,completed:i,startedAt:t?.startedAt??s?.startedAt??new Date().toISOString(),completedAt:l?t?.completedAt??s?.completedAt??new Date().toISOString():void 0}},h1=({completedSteps:t,milestones:s,createQuestProgress:r})=>r.completed.length>0||t.has("create_quest")||t.has("meet_companion")||t.has("morning_checkin")||t.has("evolve_companion")||t.has("post_evolution_companion_intro")||t.has("mentor_closeout")||s.has("stay_on_quests")||s.has("open_add_quest")||s.has("enter_title")||s.has("select_time")||s.has("submit_create_quest"),f1=({completedSteps:t,awardedSteps:s,milestonesCompleted:r,createQuestProgress:a,completed:i,completedAt:o,flowVersion:l,evolutionInFlight:c,evolutionStartedAt:d,evolutionCompletedAt:m})=>{const p=new Set(t),h=new Set(s),f=new Set(r),u=h1({completedSteps:p,milestones:f,createQuestProgress:a}),g=new Set(t.filter(C=>lc.has(C)));u&&g.add("quests_campaigns_intro");const y=i||p.has("mentor_closeout");y&&ms.forEach(C=>g.add(C.id));const b=new Set(r);u&&b.add("quests_campaigns_intro"),y&&b.add("post_evolution_companion_intro");const v=new Set(s.filter(C=>lc.has(C))),x=bn(g),w=bn(v),j=Array.from(b),D=l!==mn||!Ti(new Set(x),p)||!Ti(new Set(w),h)||!Ti(new Set(j),f);return{completedSteps:x,xpAwardedSteps:w,milestonesCompleted:j,createQuestProgress:a,completed:y||ms.every(C=>g.has(C.id)),completedAt:o,evolutionInFlight:c,evolutionStartedAt:d,evolutionCompletedAt:m,needsMigration:D}},hc=t=>Array.isArray(t)?t.filter(Mp):[],fc=t=>Array.isArray(t)?t.filter(Mp):[],Dp=t=>`guided_tutorial_progress_${t}`,gc=t=>{if(!t)return null;const s=rt.getItem(Dp(t));if(!s)return null;try{const r=JSON.parse(s);return Eo(r)?r:null}catch{return null}},xc=t=>{const s=t?.guided_tutorial;return Eo(s)?s:null},yc=t=>t==="/welcome"||t==="/preview"||t.startsWith("/auth")||t.startsWith("/onboarding"),g1=new Set(["/","/mentor","/inbox","/journeys","/companion"]),x1=({pathname:t,stepRoute:s,tutorialReady:r,tutorialComplete:a,currentStepId:i,evolutionInFlight:o})=>!r||a||!s||i==="evolve_companion"&&o||!g1.has(t)?!1:t!==s,y1={isIntroDialogueActive:!1,isActive:!1,currentStep:null,currentSubstep:null,stepRoute:null,mentorInstructionLines:[],progressText:"",activeTargetSelectors:[],activeTargetSelector:null,isStrictLockActive:!1,canTemporarilyHide:!1,dialogueText:"",dialogueSupportText:void 0,speakerName:"Your mentor",speakerPrimaryColor:"#f59e0b",speakerSlug:void 0,speakerAvatarUrl:void 0,dialogueActionLabel:void 0,onDialogueAction:void 0},Pp=n.createContext(y1),b1=(t,s)=>{switch(t){case"quests_campaigns_intro":return d1(s);case"stay_on_quests":return{text:"Start on Quests. We'll build your first quest together.",support:"You and I are setting the tone for your whole adventure."};case"open_add_quest":return{text:"Tap the + in the bottom right.",support:"This opens your quest forge."};case"enter_title":return{text:"Type your quest title here.",support:"Name it clearly so future-you knows exactly what to do."};case"select_time":return{text:"Set a time so this is scheduled.",support:"A quest with a time gets done."};case"submit_create_quest":return{text:"Now tap Create Quest.",support:"Once you submit, your first mission goes live."};case"open_companion_tab":return{text:"Open Companion.",support:"Let's check in with your ally."};case"confirm_companion_progress":return{text:"This is your companion progress area.",support:"Every completed quest strengthens your bond."};case"open_mentor_tab":return{text:"Head to Mentor.",support:"We're about to lock in your focus for the day."};case"submit_morning_checkin":return{text:"Complete your check-in and submit.",support:"Keep it honest and simple."};case"tap_evolve_companion":return{text:"Your companion is ready. Tap Evolve.",support:"This is the moment your effort transforms into growth."};case"complete_companion_evolution":return{text:"Evolution is in progress. This may take a little while.",support:"You can leave this screen and use the app like usual. I'll bring you back to complete your tutorial when it's ready."};case"post_evolution_companion_intro":return{text:"Great evolution. This Companion page is where you follow your bond and growth.",support:"Take a look here before we close out."};case"mentor_closeout_message":return{text:"Outstanding. You completed your tutorial.",support:"Now keep the momentum going with your daily quests and check-ins."};default:return{text:"Let's keep going."}}},v1=t=>!(!t||t==="mentor_intro_hello"||t==="quests_campaigns_intro"||t==="confirm_companion_progress"||t==="submit_morning_checkin"||t==="complete_companion_evolution"||t==="post_evolution_companion_intro"||t==="mentor_closeout_message"),w1=()=>{const{user:t}=be(),{profile:s,loading:r}=Yt(),{awardCustomXP:a}=Xt(),i=Yr(),o=Ae(),l=Ma(),c=as(),d=n.useRef(!1),m=n.useRef(new Set),p=n.useRef(null),h=n.useRef(null),f=n.useRef(null),u=n.useRef(null),g=n.useRef(null),y=n.useRef(null),[b,v]=n.useState([]),[x,w]=n.useState([]),[j,D]=n.useState([]),[C,_]=n.useState([]),[N,E]=n.useState(null),[k,P]=n.useState(null),T=s?.onboarding_data??null,I=T?.walkthrough_completed===!0,R=n.useMemo(()=>gc(t?.id),[t?.id]),L=n.useMemo(()=>xc(T),[T]),$=L?.version===Si&&L?.eligible===!0;n.useEffect(()=>{v([]),w([]),D([]),_([]),E(null),P(null),d.current=!1,m.current.clear(),p.current=null,y.current=null},[t?.id]);const q=n.useMemo(()=>{const ce=hc(L?.completedSteps),Oe=hc(R?.completedSteps);return Array.from(new Set([...ce,...Oe]))},[R?.completedSteps,L?.completedSteps]),F=n.useMemo(()=>{const ce=fc(L?.xpAwardedSteps),Oe=fc(R?.xpAwardedSteps);return Array.from(new Set([...ce,...Oe]))},[R?.xpAwardedSteps,L?.xpAwardedSteps]),H=n.useMemo(()=>{const ce=dc(L?.milestonesCompleted),Oe=dc(R?.milestonesCompleted);return Array.from(new Set([...ce,...Oe]))},[R?.milestonesCompleted,L?.milestonesCompleted]),J=n.useMemo(()=>pc(L?.substeps?.create_quest),[L?.substeps]),G=n.useMemo(()=>pc(R?.substeps?.create_quest),[R?.substeps]),re=n.useMemo(()=>p1(J,G),[G,J]),ie=n.useMemo(()=>f1({completedSteps:q,awardedSteps:F,milestonesCompleted:H,createQuestProgress:re,completed:!!(L?.completed??R?.completed??!1),completedAt:typeof L?.completedAt=="string"?L.completedAt:typeof R?.completedAt=="string"?R.completedAt:void 0,flowVersion:typeof L?.flowVersion=="number"?L.flowVersion:typeof R?.flowVersion=="number"?R.flowVersion:void 0,evolutionInFlight:!!(L?.evolutionInFlight??R?.evolutionInFlight??!1),evolutionStartedAt:typeof L?.evolutionStartedAt=="string"?L.evolutionStartedAt:typeof R?.evolutionStartedAt=="string"?R.evolutionStartedAt:void 0,evolutionCompletedAt:typeof L?.evolutionCompletedAt=="string"?L.evolutionCompletedAt:typeof R?.evolutionCompletedAt=="string"?R.evolutionCompletedAt:void 0}),[R?.completed,R?.completedAt,R?.evolutionCompletedAt,R?.evolutionInFlight,R?.evolutionStartedAt,R?.flowVersion,re,F,q,H,L?.completed,L?.completedAt,L?.evolutionCompletedAt,L?.evolutionInFlight,L?.evolutionStartedAt,L?.flowVersion]),K=ie.completedSteps,xe=ie.xpAwardedSteps,Te=ie.milestonesCompleted,Ne=n.useMemo(()=>{const ce=vn([...ie.createQuestProgress.completed,...j]);return{...ie.createQuestProgress,completed:ce,current:wn(ce)}},[ie.createQuestProgress,j]),B=n.useMemo(()=>new Set([...K,...b]),[K,b]),z=n.useMemo(()=>new Set([...xe,...x]),[xe,x]),Q=n.useMemo(()=>new Set([...Te,...C]),[Te,C]),Y=n.useMemo(()=>ms.find(ce=>!B.has(ce.id)),[B]),ue=Y?.id??null,fe=n.useMemo(()=>ie.evolutionInFlight,[ie.evolutionInFlight]),De=N??fe,Ce=!!t?.id&&!r&&I&&$,Be=ie.completed,qe=Ce&&(Be||!Y),he=!!Y&&!Q.has("mentor_intro_hello"),ye=Y?.route??null,Ue=x1({pathname:l.pathname,stepRoute:ye,tutorialReady:Ce,tutorialComplete:qe,currentStepId:ue,evolutionInFlight:De}),Re=n.useCallback(async ce=>{if(!t?.id)return;const Oe=new Date().toISOString(),ct={...gc(t.id)??{},...ce,version:Si,flowVersion:mn,eligible:!0,lastUpdatedAt:Oe};rt.setItem(Dp(t.id),JSON.stringify(ct));const ut=s?.onboarding_data??{},kt={...xc(ut)??{},...ce,version:Si,flowVersion:mn,eligible:!0,lastUpdatedAt:Oe},{error:is}=await S.from("profiles").update({onboarding_data:{...ut,guided_tutorial:kt}}).eq("id",t.id);is||o.invalidateQueries({queryKey:["profile",t.id]})},[s?.onboarding_data,o,t?.id]);n.useEffect(()=>{if(!Ce||!ie.needsMigration)return;const ce={flowVersion:mn,completedSteps:ie.completedSteps,xpAwardedSteps:ie.xpAwardedSteps,milestonesCompleted:ie.milestonesCompleted,substeps:{create_quest:{current:ie.createQuestProgress.current,completed:ie.createQuestProgress.completed,startedAt:ie.createQuestProgress.startedAt,completedAt:ie.createQuestProgress.completedAt}},completed:ie.completed,completedAt:ie.completedAt??(ie.completed?new Date().toISOString():void 0),evolutionInFlight:ie.evolutionInFlight,evolutionStartedAt:ie.evolutionStartedAt,evolutionCompletedAt:ie.evolutionCompletedAt},Oe=JSON.stringify(ce);y.current!==Oe&&(y.current=Oe,Re(ce))},[ie,Re,Ce]);const Ie=n.useCallback(ce=>{if(Q.has(ce))return;_r("tutorial_step_transition",{userId:t?.id,milestoneId:ce,route:l.pathname}),_(Ke=>Ke.includes(ce)?Ke:[...Ke,ce]);const Oe=Array.from(new Set([...Array.from(Q),ce]));Re({milestonesCompleted:Oe})},[l.pathname,Q,Re,t?.id]),ee=n.useCallback(ce=>{if(he||!Ce||Y?.id!=="create_quest"||Ne.current!==ce||Ne.completed.includes(ce))return;const Oe=[...Ne.completed,ce],Ke=vn(Oe),ct=wn(Ke),ut=Ke.length>=Ys.length;D(Dt=>Dt.includes(ce)?Dt:[...Dt,ce]),Ie(ce),Re({substeps:{create_quest:{current:ct,completed:Ke,startedAt:Ne.startedAt??new Date().toISOString(),completedAt:ut?new Date().toISOString():void 0}}})},[Ne,Y?.id,he,Ie,Re,Ce]),ne=n.useCallback(ce=>{if(he||!Ce||B.has(ce)||m.current.has(ce))return;m.current.add(ce),window.setTimeout(()=>{m.current.delete(ce)},1e3);const Oe=new Set([...B,ce]),Ke=bn(Oe),ct=ms.every(kt=>Oe.has(kt.id));v(kt=>kt.includes(ce)?kt:[...kt,ce]);const ut=new Set(z),Dt=r1[ce]??0;!ut.has(ce)&&Dt>0&&(ut.add(ce),w(kt=>kt.includes(ce)?kt:[...kt,ce]),a(Dt,"guided_tutorial_step_complete",void 0,{guided_step:ce,source:"guided_tutorial"})),Re({completedSteps:Ke,xpAwardedSteps:bn(ut),completed:ct,completedAt:ct?new Date().toISOString():void 0})},[a,z,B,he,Re,Ce]);n.useEffect(()=>{!qe||d.current||(d.current=!0,Re({completedSteps:ms.map(ce=>ce.id),xpAwardedSteps:Array.from(z),completed:!0,completedAt:new Date().toISOString()}))},[z,Re,qe]),n.useEffect(()=>{if(!(!Ce||qe||he||!Y)){if(Y.id==="quests_campaigns_intro"){if(l.pathname!=="/journeys")return;Q.has("quests_campaigns_intro")&&ne("quests_campaigns_intro");return}if(Y.id!=="create_quest"){if(Y.id==="morning_checkin"){if(!Q.has("open_mentor_tab")&&l.pathname==="/mentor"&&Ie("open_mentor_tab"),Q.has("open_mentor_tab")&&!Q.has("submit_morning_checkin")){const ce=()=>{if(typeof document>"u"||l.pathname!=="/mentor")return!1;const Ke=!!document.querySelector('[data-tour="checkin-submit"]');return!!!document.querySelector('[data-tour="morning-checkin"]')||Ke?!1:(Ie("submit_morning_checkin"),ne("morning_checkin"),!0)};if(ce())return;const Oe=window.setInterval(()=>{ce()&&window.clearInterval(Oe)},ic);return()=>{window.clearInterval(Oe)}}return}if(Y.id==="evolve_companion"){const ce=t?.id?o.getQueryData(wu(t.id)):null;ce&&ce.current_stage>0&&!Q.has("complete_companion_evolution")&&(Ie("complete_companion_evolution"),ne("evolve_companion"));return}if(Y.id==="post_evolution_companion_intro"){if(l.pathname!=="/companion")return;Q.has("post_evolution_companion_intro")&&ne("post_evolution_companion_intro");return}if(Y.id==="mentor_closeout"){if(l.pathname!=="/companion")return;Q.has("mentor_closeout_message")||Ie("mentor_closeout_message");const ce=window.setTimeout(()=>{ne("mentor_closeout")},s1);return()=>{window.clearTimeout(ce)}}}}},[Ne.current,Y,l.pathname,ee,Ie,ne,o,Q,he,qe,Ce,t?.id]),n.useEffect(()=>{if(!Y||!Ce||qe||he)return;const ce=[];return Y.id==="create_quest"&&(ce.push({eventName:"add-quest-sheet-opened",handler:()=>{l.pathname==="/journeys"&&ee("open_add_quest")}}),ce.push({eventName:"add-quest-title-entered",handler:()=>{l.pathname==="/journeys"&&ee("enter_title")}}),ce.push({eventName:"add-quest-time-selected",handler:Oe=>{l.pathname!=="/journeys"||!Oe.detail?.scheduledTime||ee("select_time")}}),ce.push({eventName:"task-added",handler:Oe=>{if(l.pathname!=="/journeys")return;const Ke=Oe.detail;!Ke?.taskDate||!Ke?.scheduledTime||Ne.current==="submit_create_quest"&&(ee("submit_create_quest"),ne("create_quest"))}})),Y.id==="morning_checkin"&&ce.push({eventName:"morning-checkin-completed",handler:()=>{l.pathname==="/mentor"&&(Q.has("open_mentor_tab")||Ie("open_mentor_tab"),Ie("submit_morning_checkin"),ne("morning_checkin"))}}),Y.id==="evolve_companion"&&(ce.push({eventName:"evolution-loading-start",handler:()=>{Q.has("tap_evolve_companion")||Ie("tap_evolve_companion"),E(!0),Re({evolutionInFlight:!0,evolutionStartedAt:new Date().toISOString()})}}),ce.push({eventName:"companion-evolved",handler:()=>{E(!1),Re({evolutionInFlight:!1,evolutionCompletedAt:new Date().toISOString()}),Q.has("complete_companion_evolution")||Ie("complete_companion_evolution"),ne("evolve_companion")}})),ce.forEach(({eventName:Oe,handler:Ke})=>{window.addEventListener(Oe,Ke)}),()=>{ce.forEach(({eventName:Oe,handler:Ke})=>{window.removeEventListener(Oe,Ke)})}},[Ne.current,Y,l.pathname,ee,Ie,ne,Q,Re,he,qe,Ce]);const X=n.useMemo(()=>Y?Q.has("mentor_intro_hello")?Y.id==="quests_campaigns_intro"?"quests_campaigns_intro":Y.id==="create_quest"?Ne.current:Y.id==="morning_checkin"?Q.has("open_mentor_tab")?"submit_morning_checkin":"open_mentor_tab":Y.id==="evolve_companion"?De?"complete_companion_evolution":"tap_evolve_companion":Y.id==="post_evolution_companion_intro"?"post_evolution_companion_intro":Y.id==="mentor_closeout"?"mentor_closeout_message":null:"mentor_intro_hello":null,[Ne.current,Y,De,Q]),ae=X==="mentor_intro_hello",Se=X==="mentor_intro_hello"||X==="quests_campaigns_intro"||X==="post_evolution_companion_intro",ve=Se?X==="mentor_intro_hello"?"Start Tutorial":"Continue":void 0,_e=n.useCallback(()=>{!X||!Se||Ie(X)},[X,Ie,Se]),Me=n.useMemo(()=>X?l1(X):[],[X]);n.useEffect(()=>{if(!Ue||!ye){u.current=null;return}const ce=`${l.pathname}->${ye}`;u.current!==ce&&(u.current=ce,_r("tutorial_route_restored",{userId:t?.id,from:l.pathname,to:ye,stepId:Y?.id??null,milestoneId:X}),c(ye,{replace:!0}))},[X,Y?.id,l.pathname,c,Ue,ye,t?.id]),n.useEffect(()=>{if(!X){h.current=null,f.current=null;return}h.current=Date.now(),f.current=null,_r("tutorial_step_enter",{userId:t?.id,stepId:Y?.id,milestoneId:X,route:l.pathname})},[X,Y?.id,l.pathname,t?.id]),n.useEffect(()=>{if(!Ce||qe||!X||ae||Ue||yc(l.pathname)){P(null),p.current=null;return}let ce=!1;const Oe=()=>{if(ce)return;const ct=u1(Me);P(ct);const ut=`${X}|${l.pathname}|${ct??"none"}`;f.current!==ut&&(f.current=ut,_r("tutorial_target_resolution",{userId:t?.id,stepId:Y?.id,milestoneId:X,selectorsTried:Me,resolvedSelector:ct,route:l.pathname,latencyMs:h.current===null?null:Date.now()-h.current}))};Oe();const Ke=window.setInterval(Oe,ic);return window.addEventListener("resize",Oe),window.addEventListener("orientationchange",Oe),window.addEventListener("scroll",Oe,!0),()=>{ce=!0,window.clearInterval(Ke),window.removeEventListener("resize",Oe),window.removeEventListener("orientationchange",Oe),window.removeEventListener("scroll",Oe,!0)}},[Me,X,Y?.id,ae,l.pathname,Ue,qe,Ce,t?.id]);const et=Ce&&!qe&&!Ue&&!yc(l.pathname)&&!!Y;n.useEffect(()=>{if(!(et&&ue==="evolve_companion"&&X==="tap_evolve_companion"&&l.pathname==="/companion")){g.current=null;return}const Oe=`${ue}|${X}|${l.pathname}`;if(g.current===Oe||k!==Ei)return;const Ke=document.querySelector(Ei);if(!Ke||(g.current=Oe,m1(Ke,window.innerHeight)))return;const ut=typeof window.matchMedia=="function"&&window.matchMedia("(prefers-reduced-motion: reduce)").matches?"auto":"smooth";Ke.scrollIntoView({block:"center",inline:"nearest",behavior:ut}),_r("tutorial_target_autoscroll",{userId:t?.id,stepId:ue,milestoneId:X,route:l.pathname,selector:Ei,behavior:ut})},[k,X,ue,et,l.pathname,t?.id]);const Je=ue==="create_quest"?Ne.current:null,lt=ue?ms.findIndex(ce=>ce.id===ue):-1,dt=Ne.completed.length+1,Mt=ue==="create_quest"?`Step ${lt+1} of ${ms.length} - Create Quest ${Math.min(dt,Ys.length)}/${Ys.length}`:ue?`Step ${lt+1} of ${ms.length}`:"",vt=X?X==="mentor_intro_hello"?c1(i?.slug,i?.name??"Your mentor"):b1(X,i?.slug):{text:"",support:void 0},Rt=vt.support?[vt.text,vt.support]:[vt.text],me=et&&Me.length>0&&!k;me&&p.current===null&&(p.current=Date.now()),me||(p.current=null);const Le=me&&p.current!==null&&Date.now()-p.current>t1;n.useEffect(()=>{!Le||!X||_r("tutorial_target_missing",{userId:t?.id,stepId:ue,milestoneId:X,selectorsTried:Me,route:l.pathname,elapsedMs:Date.now()-(p.current??Date.now())})},[Me,X,ue,l.pathname,Le,t?.id]);const Xe=Le?"I'm waiting for this area to load. Stay on this screen and it'll highlight as soon as it's ready.":vt.support,pt=v1(X);return{isIntroDialogueActive:ae,isActive:et,currentStep:ue,currentSubstep:Je,stepRoute:ye,mentorInstructionLines:Rt,progressText:Mt,activeTargetSelectors:Me,activeTargetSelector:k,isStrictLockActive:!!(et&&k&&pt),canTemporarilyHide:X==="complete_companion_evolution",dialogueText:vt.text,dialogueSupportText:Xe,speakerName:i?.name??"Your mentor",speakerPrimaryColor:i?.primary_color??"#f59e0b",speakerSlug:i?.slug,speakerAvatarUrl:i?.avatar_url,dialogueActionLabel:ve,onDialogueAction:Se?_e:void 0}},_1=({children:t})=>{const s=w1();return e.jsx(Pp.Provider,{value:s,children:t})},Ap=()=>n.useContext(Pp),j1=12,N1=12,Gi=0,bc=t=>t.anchor==="bottom"?{anchor:"bottom",bottomPx:Math.max(0,Math.round(t.bottomPx))}:{anchor:"top",topPx:Math.max(0,Math.round(t.topPx))},Rp=(t,s)=>t.anchor===s.anchor&&(t.anchor==="bottom"?t.bottomPx===s.bottomPx:t.topPx===s.topPx),k1=(t,s,r)=>!(t.right+r<=s.left||t.left-r>=s.right||t.bottom+r<=s.top||t.top-r>=s.bottom),vc=(t,s,r)=>{const a=s.anchor==="bottom"?r-s.bottomPx-t.height:s.topPx;return{top:a,bottom:a+t.height,left:t.left,right:t.right,width:t.width,height:t.height}},C1=(t,s)=>{const r=Math.max(s.top-t.bottom,t.top-s.bottom,0),a=Math.max(s.left-t.right,t.left-s.right,0);return r*1e3+a},S1=({panelRect:t,targetRect:s,viewportHeight:r,baseBottomPx:a=Gi,gapPx:i=j1,topMarginPx:o=N1})=>{const l={anchor:"bottom",bottomPx:a};if(!s)return bc(l);const c=Math.max(a,r-t.height-o),d=Math.max(a,r-s.top+i),m={anchor:"bottom",bottomPx:Math.min(d,c)},h=[l,m,{anchor:"top",topPx:o}].map(bc).filter((g,y,b)=>y===b.findIndex(v=>Rp(v,g)));for(const g of h){const y=vc(t,g,r);if(!k1(y,s,i))return g}let f=h[0],u=Number.NEGATIVE_INFINITY;for(const g of h){const y=vc(t,g,r),b=C1(y,s);b>u&&(f=g,u=b)}return f},E1=()=>{const{isActive:t,activeTargetSelector:s,canTemporarilyHide:r,progressText:a,dialogueText:i,dialogueSupportText:o,speakerName:l,speakerPrimaryColor:c,speakerSlug:d,speakerAvatarUrl:m,dialogueActionLabel:p,onDialogueAction:h}=Ap(),f=n.useRef(null),[u,g]=n.useState({anchor:"bottom",bottomPx:Gi}),[y,b]=n.useState(!1),v=n.useCallback(()=>{if(!t)return;const w=f.current;if(!w)return;const j=w.getBoundingClientRect();if(j.height<=0)return;const C=(s?document.querySelector(s):null)?.getBoundingClientRect()??null,_=S1({panelRect:j,targetRect:C,viewportHeight:window.innerHeight});g(N=>Rp(N,_)?N:_)},[s,t]);n.useEffect(()=>{if(!t){g({anchor:"bottom",bottomPx:Gi});return}const w=window.requestAnimationFrame(v),j=()=>v();window.addEventListener("resize",j),window.addEventListener("scroll",j,!0),window.addEventListener("orientationchange",j);const D=typeof ResizeObserver<"u"?new ResizeObserver(()=>v()):null;return D&&f.current&&D.observe(f.current),()=>{window.cancelAnimationFrame(w),window.removeEventListener("resize",j),window.removeEventListener("scroll",j,!0),window.removeEventListener("orientationchange",j),D?.disconnect()}},[t,v]),n.useEffect(()=>{r||b(!1)},[r]);const x=n.useMemo(()=>u.anchor==="bottom"?{top:"auto",bottom:`${u.bottomPx}px`}:{bottom:"auto",top:`${u.topPx}px`},[u]);return!t||!i||r&&y?null:e.jsx("section",{ref:f,"data-tutorial":"mentor-dialogue-panel",className:"pointer-events-none fixed left-0 right-0 z-[105] px-3 pb-[calc(env(safe-area-inset-bottom,0px)+10px)] transition-[top,bottom] duration-200",style:x,"aria-live":"polite",children:e.jsx("div",{className:"pointer-events-none mx-auto max-w-4xl rounded-2xl border border-white/20 bg-black/65 shadow-[0_18px_40px_rgba(0,0,0,0.45)] backdrop-blur-md",children:e.jsxs("div",{className:"flex items-end gap-3 p-3 sm:p-4",children:[e.jsx("div",{className:"shrink-0",children:e.jsx(pa,{mentorSlug:(d||"").toLowerCase(),mentorName:l,primaryColor:c||"#f59e0b",avatarUrl:m,size:"sm",className:"h-20 w-20 sm:h-24 sm:w-24",showBorder:!0,showGlow:!1})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-[0.16em] text-amber-200/90",children:a}),e.jsx("p",{className:"mt-1 inline-flex rounded-md bg-black/45 px-2 py-0.5 text-xs font-semibold text-amber-100",children:l}),e.jsx("p",{className:"mt-2 text-base leading-relaxed text-white sm:text-lg",children:i}),o?e.jsx("p",{className:"mt-1 text-sm leading-relaxed text-white/80",children:o}):null,r?e.jsx("div",{className:"mt-3",children:e.jsx(U,{type:"button",variant:"ghost","aria-label":"Hide tutorial",onClick:()=>b(!0),className:"pointer-events-auto h-9 rounded-xl border border-white/25 bg-black/45 text-white hover:bg-black/60",children:"Hide tutorial"})}):null,h?e.jsx("div",{className:"mt-3",children:e.jsx(U,{type:"button",onClick:h,className:"pointer-events-auto h-9 rounded-xl bg-amber-500 text-black hover:bg-amber-400",children:p||"Continue"})}):null]})]})})})},rn=(t,s,r)=>Math.min(Math.max(t,s),r),T1=(t,s)=>{const r=t.getBoundingClientRect(),a=window.innerWidth,i=window.innerHeight,o=rn(r.left-s,0,a),l=rn(r.top-s,0,i),c=rn(r.right+s,0,a),d=rn(r.bottom+s,0,i);return{top:l,left:o,width:Math.max(0,c-o),height:Math.max(0,d-l)}},wc=t=>t?Array.from(t.querySelectorAll(["button:not([disabled])","[href]","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(","))).filter(s=>!s.hasAttribute("disabled")&&s.tabIndex!==-1):[],M1=({active:t,targetSelector:s,panelSelector:r='[data-tutorial="mentor-dialogue-panel"]'})=>{const[a,i]=n.useState(null),[o,l]=n.useState(null),[c,d]=n.useState(null);n.useEffect(()=>{if(!t||!s){i(null),d(null);return}const u=()=>{const y=document.querySelector(s);i(y),d(y?T1(y,10):null)};u();const g=window.setInterval(u,250);return window.addEventListener("scroll",u,!0),window.addEventListener("resize",u),window.addEventListener("orientationchange",u),()=>{window.clearInterval(g),window.removeEventListener("scroll",u,!0),window.removeEventListener("resize",u),window.removeEventListener("orientationchange",u)}},[t,s]),n.useEffect(()=>{if(!t){l(null);return}const u=()=>{l(document.querySelector(r))};u();const g=window.setInterval(u,250);return()=>{window.clearInterval(g)}},[t,r]),n.useEffect(()=>{if(!(!t||!a))return a.classList.add("mentor-spotlight-target-elevated"),()=>{a.classList.remove("mentor-spotlight-target-elevated")}},[t,a]),n.useEffect(()=>{if(!t||!a)return;const u=g=>{if(g.key!=="Tab")return;const y=[...wc(a),...wc(o)];if(y.length===0)return;const b=document.activeElement,v=b?y.indexOf(b):-1;if(v===-1){g.preventDefault(),y[0]?.focus();return}const x=g.shiftKey?(v-1+y.length)%y.length:(v+1)%y.length;g.preventDefault(),y[x]?.focus()};return document.addEventListener("keydown",u),()=>{document.removeEventListener("keydown",u)}},[t,o,a]);const m={onPointerDown:u=>{u.preventDefault(),u.stopPropagation()},onClick:u=>{u.preventDefault(),u.stopPropagation()}};if(!n.useMemo(()=>t&&a&&c,[t,a,c])||!c)return null;const h=window.innerWidth,f=window.innerHeight;return e.jsxs("div",{className:"mentor-spotlight-root","aria-hidden":"true","data-testid":"mentor-spotlight-guard",children:[e.jsx("div",{className:"mentor-spotlight-mask",style:{top:0,left:0,width:"100%",height:`${c.top}px`},...m}),e.jsx("div",{className:"mentor-spotlight-mask",style:{top:`${c.top}px`,left:0,width:`${c.left}px`,height:`${c.height}px`},...m}),e.jsx("div",{className:"mentor-spotlight-mask",style:{top:`${c.top}px`,left:`${c.left+c.width}px`,width:`${Math.max(0,h-(c.left+c.width))}px`,height:`${c.height}px`},...m}),e.jsx("div",{className:"mentor-spotlight-mask",style:{top:`${c.top+c.height}px`,left:0,width:"100%",height:`${Math.max(0,f-(c.top+c.height))}px`},...m}),e.jsx("div",{className:"mentor-spotlight-ring",style:{top:`${c.top}px`,left:`${c.left}px`,width:`${c.width}px`,height:`${c.height}px`}})]})},D1=n.lazy(()=>ke(()=>import("./Home-L-5X-wse.js"),__vite__mapDeps([17,1,2,3]))),P1=n.lazy(()=>ke(()=>import("./Auth-CQfbnNNe.js"),__vite__mapDeps([18,1,2,3,19,20,21,22]))),A1=n.lazy(()=>ke(()=>import("./ResetPassword-BvgYC8R-.js"),__vite__mapDeps([23,1,2,3,19]))),R1=n.lazy(()=>ke(()=>import("./Onboarding-k1NpOsP0.js"),__vite__mapDeps([24,1,2,3,19,25,26]))),I1=n.lazy(()=>ke(()=>import("./Welcome-BniXWGnV.js"),__vite__mapDeps([27,1,2,3,20,22]))),L1=n.lazy(()=>ke(()=>import("./Preview-CYnBbUiB.js"),__vite__mapDeps([28,1,2,3,20]))),q1=n.lazy(()=>ke(()=>import("./Profile-4P-wRwvt.js"),__vite__mapDeps([29,1,2,3,30,25]))),O1=n.lazy(()=>ke(()=>import("./Premium-1drsp01V.js"),__vite__mapDeps([31,1,2,3,30]))),F1=n.lazy(()=>ke(()=>import("./PepTalkDetail-1TNhOqLa.js"),__vite__mapDeps([32,1,2,3]))),$1=n.lazy(()=>ke(()=>import("./Admin-BnhXWjHL.js"),__vite__mapDeps([33,1,2,3]))),H1=n.lazy(()=>ke(()=>import("./MentorSelection-BCmT8-Uf.js"),__vite__mapDeps([34,1,2,3,26]))),B1=n.lazy(()=>ke(()=>import("./NotFound-BP23OId0.js"),__vite__mapDeps([35,1,2,3]))),U1=n.lazy(()=>ke(()=>import("./Reflection-CXvFG5cM.js"),__vite__mapDeps([36,1,2,3]))),z1=n.lazy(()=>ke(()=>import("./MentorChat-DjU0Nqr4.js"),__vite__mapDeps([37,1,2,3]))),Q1=n.lazy(()=>ke(()=>import("./Library-BRbm9ycn.js"),__vite__mapDeps([38,1,2,3,39,21,40]))),K1=n.lazy(()=>ke(()=>import("./Challenges-BRgf_Emy.js"),__vite__mapDeps([41,1,2,3]))),W1=n.lazy(()=>ke(()=>import("./Search-DMX1P1zp.js"),__vite__mapDeps([42,1,2,3,40,39,21,14]))),G1=n.lazy(()=>ke(()=>import("./PepTalks-CCWX7rYy.js"),__vite__mapDeps([43,1,2,3,39,21]))),Y1=n.lazy(()=>ke(()=>import("./TermsOfService-w_f3-aY3.js"),__vite__mapDeps([44,1,2,3]))),V1=n.lazy(()=>ke(()=>import("./PrivacyPolicy-7Iie3xLI.js"),__vite__mapDeps([45,1,2,3]))),X1=n.lazy(()=>ke(()=>import("./PremiumSuccess-B6FIak20.js"),__vite__mapDeps([46,1,2,3]))),J1=n.lazy(()=>ke(()=>import("./Epics-BgO2tYO9.js"),__vite__mapDeps([47,1,2,3,48]))),Z1=n.lazy(()=>ke(()=>import("./SharedEpics-DGIzq_OP.js"),__vite__mapDeps([49,1,2,3]))),ek=n.lazy(()=>ke(()=>import("./Partners-BLBukkD5.js"),__vite__mapDeps([50,1,2,3]))),tk=n.lazy(()=>ke(()=>import("./JoinEpic-W34clMf2.js"),__vite__mapDeps([51,1,2,3,48]))),sk=n.lazy(()=>ke(()=>import("./Creator-b5L_840A.js"),__vite__mapDeps([52,1,2,3]))),rk=n.lazy(()=>ke(()=>import("./InfluencerDashboard-OzmIh1a9.js"),__vite__mapDeps([53,1,2,3]))),ak=n.lazy(()=>ke(()=>import("./AccountDeletionHelp-Xj1B0htH.js"),__vite__mapDeps([54,1,2,3,30]))),nk=n.lazy(()=>ke(()=>import("./Recaps-PXy4zS3O.js"),__vite__mapDeps([55,1,2,3]))),ik=n.lazy(()=>ke(()=>import("./HelpCenter-BVG7X1Yt.js"),__vite__mapDeps([56,1,2,3]))),ok=n.lazy(()=>ke(()=>import("./TestDayPlanner-D66FsT_o.js"),__vite__mapDeps([57,1,2,3]))),lk=n.lazy(()=>ke(()=>import("./TestScroll-77Rr5Lqb.js"),__vite__mapDeps([58,1,2,3]))),ck=n.lazy(()=>ke(()=>import("./Contacts-CH3JNG76.js"),__vite__mapDeps([59,1,2,3]))),dk=n.lazy(()=>ke(()=>import("./IAPTest-M3iPyTWM.js"),__vite__mapDeps([60,1,2,3]))),uk=new $f({defaultOptions:{queries:{staleTime:300*1e3,gcTime:600*1e3,refetchOnWindowFocus:!1,refetchOnReconnect:!0,retry:2,retryDelay:t=>Math.min(1e3*2**t,3e4)},mutations:{retry:1,retryDelay:1e3}}}),_c=()=>{[()=>ke(()=>import("./Profile-4P-wRwvt.js"),__vite__mapDeps([29,1,2,3,30,25])),()=>ke(()=>import("./MentorChat-DjU0Nqr4.js"),__vite__mapDeps([37,1,2,3]))].forEach(s=>s())};typeof window<"u"&&("requestIdleCallback"in window?window.requestIdleCallback(_c,{timeout:3e3}):setTimeout(_c,1500));const Yi=n.memo(()=>e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"h-12 w-12 mx-auto rounded-full border-4 border-primary border-t-transparent animate-spin"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading..."})]})}));Yi.displayName="LoadingFallback";const Ip=n.memo(()=>{const{pathname:t}=Ma();return n.useEffect(()=>{Cp(t)||window.scrollTo(0,0)},[t]),null});Ip.displayName="ScrollToTop";const Lp=n.memo(()=>e.jsxs(e.Fragment,{children:[e.jsx(Px,{}),e.jsx($0,{})]}));Lp.displayName="EvolutionAwareContent";const qp=n.memo(()=>{const{isActive:t,activeTargetSelector:s,isStrictLockActive:r}=Ap();return e.jsxs(e.Fragment,{children:[e.jsx(M1,{active:t&&r,targetSelector:s}),e.jsx(E1,{})]})});qp.displayName="MentorTutorialLayer";const Op=n.memo(()=>{const{profile:t,loading:s}=Yt(),{session:r,status:a}=be(),[i,o]=n.useState(!1),[l,c]=n.useState(!1),d=Ma(),m=as();if(H0({enabled:a==="authenticated"&&!!r?.user}),n.useEffect(()=>{const u=window.location.hash;u.includes("type=recovery")&&!d.pathname.includes("/auth/reset-password")&&m(`/auth/reset-password${u}`,{replace:!0}),c(!0)},[d.pathname,m]),n.useEffect(()=>{if(d.pathname!=="/"||typeof window>"u"||!r?.user||s||t?.onboarding_completed!==!0)return;Ii.getItem("initialRouteRedirected")||(Ii.setItem("initialRouteRedirected","true"),m("/journeys",{replace:!0}))},[d.pathname,m,t?.onboarding_completed,s,r?.user]),n.useEffect(()=>{const u=g=>{const y=g.detail;typeof y=="string"&&m(y)};return window.addEventListener("native-push-navigation",u),()=>window.removeEventListener("native-push-navigation",u)},[m]),n.useEffect(()=>{const u=g=>{const{path:y}=g.detail;y&&m(y)};return window.addEventListener("deep-link-navigation",u),()=>window.removeEventListener("deep-link-navigation",u)},[m]),n.useEffect(()=>{if(r?.user)try{In()&&Fx(r.user.id).catch(u=>{oe.error("Failed to initialize native push:",u)})}catch(u){oe.log("Native push initialization skipped:",u)}},[r]),n.useEffect(()=>{if(!s&&!i){const u=setTimeout(()=>{Zf(),o(!0)},100);return()=>clearTimeout(u)}},[s,i]),!l&&window.location.hash.includes("type=recovery"))return e.jsx(Yi,{});const p=Br(t),h=Cp(d.pathname)?d.pathname:null,f=e1(d.pathname,!!r?.user);return e.jsx(yg,{mentorId:p,children:e.jsx(vg,{children:e.jsx(Bg,{children:e.jsx(_1,{children:e.jsx(R0,{children:e.jsx(iu,{children:e.jsx(Pu,{children:e.jsx(Lx,{children:e.jsx(E0,{children:e.jsxs(n.Suspense,{fallback:e.jsx(Yi,{}),children:[e.jsx(Lp,{}),h?e.jsx(jt,{children:e.jsx(Sp,{activePath:h})}):e.jsx(Pe,{mode:"sync",initial:!1,children:e.jsxs(Hf,{location:d,children:[e.jsx(Ge,{path:"/welcome",element:e.jsx(I1,{})}),e.jsx(Ge,{path:"/preview",element:e.jsx(L1,{})}),e.jsx(Ge,{path:"/auth",element:e.jsx(P1,{})}),e.jsx(Ge,{path:"/auth/reset-password",element:e.jsx(A1,{})}),e.jsx(Ge,{path:"/creator",element:e.jsx(sk,{})}),e.jsx(Ge,{path:"/creator/dashboard",element:e.jsx(rk,{})}),e.jsx(Ge,{path:"/onboarding",element:e.jsx(R1,{})}),e.jsx(Ge,{path:"/",element:e.jsx(jt,{children:e.jsx(D1,{})})}),e.jsx(Ge,{path:"/profile",element:e.jsx(jt,{children:e.jsx(q1,{})})}),e.jsx(Ge,{path:"/premium",element:e.jsx(jt,{children:e.jsx(O1,{})})}),e.jsx(Ge,{path:"/premium/success",element:e.jsx(jt,{children:e.jsx(X1,{})})}),e.jsx(Ge,{path:"/pep-talk/:id",element:e.jsx(jt,{children:e.jsx(F1,{})})}),e.jsx(Ge,{path:"/mentor-selection",element:e.jsx(jt,{children:e.jsx(H1,{})})}),e.jsx(Ge,{path:"/admin",element:e.jsx(jt,{requireMentor:!1,children:e.jsx($1,{})})}),e.jsx(Ge,{path:"/tasks",element:e.jsx(gr,{to:"/journeys",replace:!0})}),e.jsx(Ge,{path:"/epics",element:e.jsx(jt,{children:e.jsx(J1,{})})}),e.jsx(Ge,{path:"/join/:code",element:e.jsx(tk,{})}),e.jsx(Ge,{path:"/shared-epics",element:e.jsx(jt,{children:e.jsx(Z1,{})})}),e.jsx(Ge,{path:"/mentor-chat",element:e.jsx(jt,{children:e.jsx(z1,{})})}),e.jsx(Ge,{path:"/horoscope",element:e.jsx(gr,{to:"/journeys",replace:!0})}),e.jsx(Ge,{path:"/cosmic/:placement/:sign",element:e.jsx(gr,{to:"/journeys",replace:!0})}),e.jsx(Ge,{path:"/challenges",element:e.jsx(jt,{children:e.jsx(K1,{})})}),e.jsx(Ge,{path:"/reflection",element:e.jsx(jt,{children:e.jsx(U1,{})})}),e.jsx(Ge,{path:"/library",element:e.jsx(jt,{children:e.jsx(Q1,{})})}),e.jsx(Ge,{path:"/pep-talks",element:e.jsx(jt,{children:e.jsx(G1,{})})}),e.jsx(Ge,{path:"/inspire",element:e.jsx(gr,{to:"/pep-talks",replace:!0})}),e.jsx(Ge,{path:"/search",element:e.jsx(jt,{children:e.jsx(W1,{})})}),e.jsx(Ge,{path:"/partners",element:e.jsx(ek,{})}),e.jsx(Ge,{path:"/account-deletion",element:e.jsx(ak,{})}),e.jsx(Ge,{path:"/recaps",element:e.jsx(jt,{children:e.jsx(nk,{})})}),e.jsx(Ge,{path:"/help",element:e.jsx(jt,{children:e.jsx(ik,{})})}),e.jsx(Ge,{path:"/campaigns",element:e.jsx(gr,{to:"/journeys",replace:!0})}),e.jsx(Ge,{path:"/contacts",element:e.jsx(jt,{children:e.jsx(ck,{})})}),e.jsx(Ge,{path:"/iap-test",element:e.jsx(dk,{})}),e.jsx(Ge,{path:"/guilds",element:e.jsx(gr,{to:"/campaigns",replace:!0})}),e.jsx(Ge,{path:"/terms",element:e.jsx(Y1,{})}),e.jsx(Ge,{path:"/privacy",element:e.jsx(V1,{})}),e.jsx(Ge,{path:"/test-scroll",element:e.jsx(lk,{})}),e.jsx(Ge,{path:"/test-day-planner",element:e.jsx(ok,{})}),e.jsx(Ge,{path:"*",element:e.jsx(B1,{})})]},d.pathname)}),f&&e.jsx(Tp,{}),e.jsx(qp,{})]})})})})})})})})})})});Op.displayName="AppContent";const mk=()=>(n.useEffect(()=>{Ox()},[]),e.jsx(es,{children:e.jsx(Bf,{client:uk,children:e.jsx(Vg,{children:e.jsx(Cg,{children:e.jsx(Ug,{children:e.jsx(zg,{children:e.jsxs(Kd,{children:[e.jsx(mg,{}),e.jsx(pg,{}),e.jsx(qx,{}),e.jsx(Uf,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:e.jsxs(rx,{children:[e.jsx(Ip,{}),e.jsx(Op,{})]})})]})})})})})})}));window.addEventListener("error",t=>{oe.error("Unhandled error:",t.error)});window.addEventListener("unhandledrejection",t=>{oe.error("Unhandled promise rejection:",t.reason)});"serviceWorker"in navigator&&!window.Capacitor?.isNativePlatform?.()&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js",{scope:"/"}).catch(()=>{})});const pk=()=>(n.useEffect(()=>{Jf()},[]),e.jsx(mk,{}));document.getElementById("debug-indicator")?.remove();zf.createRoot(document.getElementById("root")).render(e.jsx(pk,{}));export{Bs as $,qm as A,U as B,lr as C,Hn as D,jk as E,Lb as F,Fe as G,A as H,Rb as I,ux as J,mx as K,at as L,pa as M,px as N,Aa as O,Hs as P,bk as Q,Ur as R,qa as S,zr as T,Kr as U,Wr as V,Qr as W,Gr as X,or as Y,ns as Z,Vt as _,ot as a,PN as a$,xs as a0,cx as a1,bx as a2,Qs as a3,hx as a4,Li as a5,rt as a6,$u as a7,rs as a8,zn as a9,Km as aA,Ra as aB,ur as aC,ho as aD,mr as aE,pr as aF,hr as aG,kj as aH,cw as aI,Fj as aJ,$g as aK,Hb as aL,Ri as aM,Ku as aN,Vu as aO,$v as aP,Qn as aQ,Xu as aR,j_ as aS,ki as aT,yy as aU,dr as aV,Ds as aW,Ps as aX,ys as aY,fN as aZ,mN as a_,Wm as aa,_j as ab,xo as ac,Fn as ad,Ns as ae,ks as af,jj as ag,On as ah,xk as ai,er as aj,ta as ak,Ks as al,Dg as am,J0 as an,je as ao,Kt as ap,L0 as aq,jv as ar,mv as as,hs as at,lb as au,bu as av,cm as aw,Ab as ax,Gv as ay,eN as az,uo as b,qu as b0,$0 as b1,mt as b2,Lr as b3,qr as b4,Or as b5,Kd as b6,Wd as b7,Gd as b8,ao as b9,Uw as ba,Qt as bb,Hl as bc,Bl as bd,Hi as be,Rs as bf,Vr as bg,ON as bh,vo as bi,Bn as bj,Fm as bk,Un as bl,pw as bm,fx as bn,Nk as bo,M0 as bp,P0 as bq,T0 as br,Nb as bs,Ox as bt,vk as bu,io as bv,qg as bw,yk as bx,kk as by,Ln as bz,be as c,Tt as d,Ia as e,We as f,oo as g,Br as h,cu as i,ix as j,nx as k,oe as l,Yt as m,In as n,_k as o,gn as p,Na as q,Fr as r,S as s,ka as t,Ms as u,$r as v,Gs as w,Fx as x,wk as y,bo as z};
