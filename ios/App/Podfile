require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'
require 'fileutils'

def mutate_file(path)
  return unless File.exist?(path)

  stat = File.stat(path)
  original_permissions = stat.mode & 0o7777
  made_writable = false

  if (original_permissions & 0o200).zero?
    File.chmod(original_permissions | 0o200, path)
    made_writable = true
  end

  yield(path)
ensure
  if made_writable && File.exist?(path)
    File.chmod(original_permissions, path)
  end
end

# Ensure Capgo's hook script runs during pod install so unused providers stay disabled.
def configure_social_login_podspec
  plugin_root = File.expand_path('../../node_modules/@capgo/capacitor-social-login', __dir__)
  script_path = File.join(plugin_root, 'scripts', 'configure-dependencies.js')
  config_path = File.expand_path('App/capacitor.config.json', __dir__)

  return unless File.exist?(script_path)

  capacitor_config = File.exist?(config_path) ? File.read(config_path) : nil
  env = {
    'CAPACITOR_PLATFORM_NAME' => 'ios',
    'CAPACITOR_ROOT_DIR' => File.expand_path('..', __dir__)
  }
  env['CAPACITOR_CONFIG'] = capacitor_config if capacitor_config

  Dir.chdir(plugin_root) do
    success = system(env, 'node', script_path)
    puts('[SocialLogin] Failed to configure dependencies; falling back to defaults') unless success
  end
end

configure_social_login_podspec

platform :ios, '16.0'
use_frameworks!

def capacitor_pods
  pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCommunityAppleSignIn', :path => '../../node_modules/@capacitor-community/apple-sign-in'
  pod 'CapacitorCommunityContacts', :path => '../../node_modules/@capacitor-community/contacts'
  pod 'CapacitorApp', :path => '../../node_modules/@capacitor/app'
  pod 'CapacitorCamera', :path => '../../node_modules/@capacitor/camera'
  pod 'CapacitorFilesystem', :path => '../../node_modules/@capacitor/filesystem'
  pod 'CapacitorHaptics', :path => '../../node_modules/@capacitor/haptics'
  pod 'CapacitorPushNotifications', :path => '../../node_modules/@capacitor/push-notifications'
  pod 'CapacitorScreenOrientation', :path => '../../node_modules/@capacitor/screen-orientation'
  pod 'CapacitorShare', :path => '../../node_modules/@capacitor/share'
  pod 'CapacitorSplashScreen', :path => '../../node_modules/@capacitor/splash-screen'
  pod 'CapgoCapacitorSocialLogin', :path => '../../node_modules/@capgo/capacitor-social-login'
  pod 'CapgoNativePurchases', :path => '../../node_modules/@capgo/native-purchases'
end

target 'App' do
  pod 'IONFilesystemLib', :path => '../IONFilesystemLib'
  capacitor_pods
  # Add your Pods here
end

post_install do |installer|
  assertDeploymentTarget(installer)

  script_phase_names = [
    '[CP] Copy XCFrameworks',
    '[CP] Embed Pods Frameworks'
  ].freeze

  configure_script_phase = lambda do |phase|
    next unless phase.respond_to?(:name) && script_phase_names.include?(phase.name)

    phase.always_out_of_date = '1' if phase.respond_to?(:always_out_of_date=)
    if phase.respond_to?(:based_on_dependency_analysis=)
      phase.based_on_dependency_analysis = '0'
    elsif phase.respond_to?(:basedOnDependencyAnalysis=)
      phase.basedOnDependencyAnalysis = '0'
    end
  end

  installer.pods_project.targets.each do |pods_target|
    pods_target.shell_script_build_phases.each { |phase| configure_script_phase.call(phase) }
  end

  installer.aggregate_targets.each do |aggregate_target|
    user_project_changed = false

    aggregate_target.user_targets.each do |user_target|
      user_target.shell_script_build_phases.each { |phase| configure_script_phase.call(phase) }

      next unless user_target.name == 'App'

      user_target.build_configurations.each do |config|
        next unless %w[Debug Release].include?(config.name)
        next if config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] == 'NO'

        config.build_settings['ENABLE_USER_SCRIPT_SANDBOXING'] = 'NO'
        user_project_changed = true
      end
    end

    aggregate_target.user_project.save if user_project_changed
  end

  alamofire_response_serialization = File.join(__dir__, 'Pods', 'Alamofire', 'Source', 'Features', 'ResponseSerialization.swift')
  mutate_file(alamofire_response_serialization) do |file|
    original = 'public protocol DataDecoder: Sendable'
    patched = '@preconcurrency public protocol DataDecoder: Sendable'

    file_contents = File.read(file)
    unless file_contents.include?(patched)
      File.write(
        file,
        file_contents.sub(original, patched)
      )
    end

    json_extension = 'extension JSONDecoder: DataDecoder {}'
    json_replacement = "@available(iOS 16.0, *)\nextension JSONDecoder: DataDecoder {}"
    plist_extension = 'extension PropertyListDecoder: DataDecoder {}'
    plist_replacement = "@available(iOS 16.0, *)\nextension PropertyListDecoder: DataDecoder {}"

    updated_contents = File.read(file)
    if updated_contents.include?(json_extension) && !updated_contents.include?(json_replacement)
      updated_contents = updated_contents.sub(json_extension, json_replacement)
    end
    if updated_contents.include?(plist_extension) && !updated_contents.include?(plist_replacement)
      updated_contents = updated_contents.sub(plist_extension, plist_replacement)
    end
    File.write(file, updated_contents)
  end

  gid_activity_indicator = File.join(__dir__, 'Pods', 'GoogleSignIn', 'GoogleSignIn', 'Sources', 'GIDAppCheck', 'UI', 'GIDActivityIndicatorViewController.m')
  mutate_file(gid_activity_indicator) do |file|
    file_contents = File.read(file)
    if file_contents.include?('UIActivityIndicatorViewStyleGray')
      File.write(
        file,
        file_contents.gsub('UIActivityIndicatorViewStyleGray', 'UIActivityIndicatorViewStyleMedium')
      )
    end
  end

  alamofire_event_monitor = File.join(__dir__, 'Pods', 'Alamofire', 'Source', 'Features', 'EventMonitor.swift')
  mutate_file(alamofire_event_monitor) do |file|
    file_contents = File.read(file)
    shim = "extension InputStream: @unchecked Sendable {}"
    unless file_contents.include?(shim)
      file_contents = file_contents.sub('import Foundation', "import Foundation\n\n#{shim}")
      File.write(file, file_contents)
    end
  end
  mutate_file(gid_activity_indicator) do |file|
    original = <<~'ORIGINAL'
      UIActivityIndicatorViewStyle style;
      if (@available(iOS 13.0, *)) {
        style = UIActivityIndicatorViewStyleLarge;
      } else {
        style = UIActivityIndicatorViewStyleGray;
      }
    ORIGINAL

    patched = <<~'PATCHED'
      #if __IPHONE_OS_VERSION_MAX_ALLOWED >= 130000
        UIActivityIndicatorViewStyle style = UIActivityIndicatorViewStyleLarge;
      #else
        UIActivityIndicatorViewStyle style;
        if (@available(iOS 13.0, *)) {
          style = UIActivityIndicatorViewStyleLarge;
        } else {
          style = UIActivityIndicatorViewStyleGray;
        }
      #endif
    PATCHED

    file_contents = File.read(file)
    unless file_contents.include?('#if __IPHONE_OS_VERSION_MAX_ALLOWED >= 130000')
      File.write(
        file,
        file_contents.sub(original, patched)
      )
    end
  end

  xcframework_root = File.join(__dir__, 'Pods')
  device_slice = 'ios-arm64'
  excluded_tokens = %w[simulator maccatalyst]

  Dir.glob(File.join(xcframework_root, '**', '*.xcframework')).each do |xcframework|
    device_slice_path = File.join(xcframework, device_slice)
    next if Dir.exist?(device_slice_path)

    fallback = Dir.glob(File.join(xcframework, "#{device_slice}_*")).find do |candidate|
      File.directory?(candidate) && excluded_tokens.none? { |token| File.basename(candidate).include?(token) }
    end

    next unless fallback

    FileUtils.rm_rf(device_slice_path)
    FileUtils.mkdir_p(device_slice_path)
    FileUtils.cp_r(File.join(fallback, '.'), device_slice_path)
    puts "Created #{device_slice} slice for #{File.basename(xcframework)} using #{File.basename(fallback)}"
  end
end
