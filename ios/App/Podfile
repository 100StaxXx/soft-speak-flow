require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'

platform :ios, '16.0'
use_frameworks!

def capacitor_pods
  pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCommunityAppleSignIn', :path => '../../node_modules/@capacitor-community/apple-sign-in'
  pod 'CapacitorFilesystem', :path => '../../node_modules/@capacitor/filesystem'
  pod 'CapacitorPushNotifications', :path => '../../node_modules/@capacitor/push-notifications'
  pod 'CapacitorScreenOrientation', :path => '../../node_modules/@capacitor/screen-orientation'
  pod 'CapacitorShare', :path => '../../node_modules/@capacitor/share'
  pod 'CapacitorSplashScreen', :path => '../../node_modules/@capacitor/splash-screen'
  pod 'CapgoCapacitorSocialLogin', :path => '../../node_modules/@capgo/capacitor-social-login'
end

target 'App' do
  capacitor_pods
  # Add your Pods here
end

post_install do |installer|
  assertDeploymentTarget(installer)

  script_phase_names = [
    '[CP] Copy XCFrameworks',
    '[CP] Embed Pods Frameworks'
  ].freeze

  configure_script_phase = lambda do |phase|
    next unless phase.respond_to?(:name) && script_phase_names.include?(phase.name)

    phase.always_out_of_date = '1' if phase.respond_to?(:always_out_of_date=)
    if phase.respond_to?(:based_on_dependency_analysis=)
      phase.based_on_dependency_analysis = '0'
    elsif phase.respond_to?(:basedOnDependencyAnalysis=)
      phase.basedOnDependencyAnalysis = '0'
    end
  end

  installer.pods_project.targets.each do |pods_target|
    pods_target.shell_script_build_phases.each { |phase| configure_script_phase.call(phase) }
  end

  installer.aggregate_targets.each do |aggregate_target|
    aggregate_target.user_targets.each do |user_target|
      user_target.shell_script_build_phases.each { |phase| configure_script_phase.call(phase) }
    end
  end

  # Fix XCFramework copy scripts to handle missing paths gracefully
  # This addresses issues with IONFilesystemLib, FBSDKCoreKit_Basics, and other XCFramework pods
  # where the architecture slice path may not match expected structure
  installer.pods_project.targets.each do |target|
    target.shell_script_build_phases.each do |phase|
      next unless phase.name == '[CP] Copy XCFrameworks'
      next if phase.shell_script.nil? || phase.shell_script.empty?
      
      # Skip if already patched
      next if phase.shell_script.include?('# PATCHED: XCFramework copy with path validation')
      
      original_script = phase.shell_script
      patched_script = original_script.dup
      
      # Modify rsync commands to check source paths before executing
      patched_script = patched_script.gsub(
        /^([ \t]*)(rsync\s+--delete\s+-av\s+[^\n]*?"([^"]+\.xcframework\/[^"]*)"[^\n]*?"([^"]+)")[ \t]*$/
      ) do |match|
        indent = $1 || ''
        full_cmd = $2
        source_pattern = $3
        dest_path = $4
        source_dir = source_pattern.sub(/\/?\*$/, '')
        
        # Generate a safer version that checks if source exists
        <<~BASH.gsub(/^(?=\S)/, indent).rstrip
# Check if XCFramework source path exists before rsync
if [ -d "#{source_dir}" ] || [ -e "#{source_dir}" ]; then
  #{full_cmd}
else
  echo "warning: Skipping copy for non-existent XCFramework path: #{source_dir}"
  mkdir -p "#{dest_path}" 2>/dev/null || true
fi
        BASH
      end
      
      # If regex didn't match (script unchanged), use fallback wrapper approach
      if patched_script == original_script
        phase.shell_script = <<~BASH
#!/bin/bash
# PATCHED: XCFramework copy with path validation (fallback wrapper)
# Wrapping script to handle missing XCFramework paths gracefully

# Create a wrapper function for rsync that checks source existence
safe_rsync() {
  local src_pattern="${@: -2:1}"
  local src_dir="${src_pattern%/*}"
  src_dir="${src_dir%\\*}"
  
  if [ -d "$src_dir" ] || [ -e "$src_dir" ]; then
    rsync "$@"
  else
    echo "warning: Skipping rsync for non-existent path: $src_dir"
    mkdir -p "${@: -1}" 2>/dev/null || true
    return 0
  fi
}

# Override rsync command for this script
rsync() {
  safe_rsync "$@"
}

#{original_script}
        BASH
      else
        phase.shell_script = "#!/bin/bash\n# PATCHED: XCFramework copy with path validation\n\n" + patched_script
      end
    end
  end

  alamofire_response_serialization = File.join(__dir__, 'Pods', 'Alamofire', 'Source', 'Features', 'ResponseSerialization.swift')
  if File.exist?(alamofire_response_serialization)
    original = 'public protocol DataDecoder: Sendable'
    patched = '@preconcurrency public protocol DataDecoder: Sendable'

    file_contents = File.read(alamofire_response_serialization)
    unless file_contents.include?(patched)
      File.write(
        alamofire_response_serialization,
        file_contents.sub(original, patched)
      )
    end

    json_extension = 'extension JSONDecoder: DataDecoder {}'
    json_replacement = "@available(iOS 16.0, *)\nextension JSONDecoder: DataDecoder {}"
    plist_extension = 'extension PropertyListDecoder: DataDecoder {}'
    plist_replacement = "@available(iOS 16.0, *)\nextension PropertyListDecoder: DataDecoder {}"

    updated_contents = File.read(alamofire_response_serialization)
    if updated_contents.include?(json_extension) && !updated_contents.include?(json_replacement)
      updated_contents = updated_contents.sub(json_extension, json_replacement)
    end
    if updated_contents.include?(plist_extension) && !updated_contents.include?(plist_replacement)
      updated_contents = updated_contents.sub(plist_extension, plist_replacement)
    end
    File.write(alamofire_response_serialization, updated_contents)
  end

  gid_activity_indicator = File.join(__dir__, 'Pods', 'GoogleSignIn', 'GoogleSignIn', 'Sources', 'GIDAppCheck', 'UI', 'GIDActivityIndicatorViewController.m')
  if File.exist?(gid_activity_indicator)
    file_contents = File.read(gid_activity_indicator)
    if file_contents.include?('UIActivityIndicatorViewStyleGray')
      File.write(
        gid_activity_indicator,
        file_contents.gsub('UIActivityIndicatorViewStyleGray', 'UIActivityIndicatorViewStyleMedium')
      )
    end
  end

  alamofire_event_monitor = File.join(__dir__, 'Pods', 'Alamofire', 'Source', 'Features', 'EventMonitor.swift')
  if File.exist?(alamofire_event_monitor)
    file_contents = File.read(alamofire_event_monitor)
    shim = "extension InputStream: @unchecked Sendable {}"
    unless file_contents.include?(shim)
      file_contents = file_contents.sub('import Foundation', "import Foundation\n\n#{shim}")
      File.write(alamofire_event_monitor, file_contents)
    end
  end

  gid_activity_indicator = File.join(__dir__, 'Pods', 'GoogleSignIn', 'GoogleSignIn', 'Sources', 'GIDAppCheck', 'UI', 'GIDActivityIndicatorViewController.m')
  if File.exist?(gid_activity_indicator)
    original = <<~'ORIGINAL'
      UIActivityIndicatorViewStyle style;
      if (@available(iOS 13.0, *)) {
        style = UIActivityIndicatorViewStyleLarge;
      } else {
        style = UIActivityIndicatorViewStyleGray;
      }
    ORIGINAL

    patched = <<~'PATCHED'
      #if __IPHONE_OS_VERSION_MAX_ALLOWED >= 130000
        UIActivityIndicatorViewStyle style = UIActivityIndicatorViewStyleLarge;
      #else
        UIActivityIndicatorViewStyle style;
        if (@available(iOS 13.0, *)) {
          style = UIActivityIndicatorViewStyleLarge;
        } else {
          style = UIActivityIndicatorViewStyleGray;
        }
      #endif
    PATCHED

    file_contents = File.read(gid_activity_indicator)
    unless file_contents.include?('#if __IPHONE_OS_VERSION_MAX_ALLOWED >= 130000')
      File.write(
        gid_activity_indicator,
        file_contents.sub(original, patched)
      )
    end
  end
end
