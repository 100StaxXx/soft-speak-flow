require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'

platform :ios, '16.0'
use_frameworks!

def capacitor_pods
  pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCommunityAppleSignIn', :path => '../../node_modules/@capacitor-community/apple-sign-in'
  pod 'CapacitorFilesystem', :path => '../../node_modules/@capacitor/filesystem'
  pod 'CapacitorPushNotifications', :path => '../../node_modules/@capacitor/push-notifications'
  pod 'CapacitorScreenOrientation', :path => '../../node_modules/@capacitor/screen-orientation'
  pod 'CapacitorShare', :path => '../../node_modules/@capacitor/share'
  pod 'CapacitorSplashScreen', :path => '../../node_modules/@capacitor/splash-screen'
  pod 'CapgoCapacitorSocialLogin', :path => '../../node_modules/@capgo/capacitor-social-login'
end

target 'App' do
  capacitor_pods
  # Add your Pods here
end

post_install do |installer|
  assertDeploymentTarget(installer)

  script_phase_names = [
    '[CP] Copy XCFrameworks',
    '[CP] Embed Pods Frameworks'
  ].freeze

  configure_script_phase = lambda do |phase|
    next unless phase.respond_to?(:name) && script_phase_names.include?(phase.name)

    phase.always_out_of_date = '1' if phase.respond_to?(:always_out_of_date=)
    if phase.respond_to?(:based_on_dependency_analysis=)
      phase.based_on_dependency_analysis = '0'
    elsif phase.respond_to?(:basedOnDependencyAnalysis=)
      phase.basedOnDependencyAnalysis = '0'
    end
  end

  installer.pods_project.targets.each do |pods_target|
    pods_target.shell_script_build_phases.each { |phase| configure_script_phase.call(phase) }
  end

  installer.aggregate_targets.each do |aggregate_target|
    aggregate_target.user_targets.each do |user_target|
      user_target.shell_script_build_phases.each { |phase| configure_script_phase.call(phase) }
    end
  end

  # Fix XCFramework copy scripts to handle missing slices gracefully
  # This patches the generated shell scripts to check if source exists before rsync
  pods_dir = File.join(__dir__, 'Pods')
  target_support_files = File.join(pods_dir, 'Target Support Files')
  
  # Helper function to patch xcframework copy scripts for resilience
  patch_xcframework_script = lambda do |script_content|
    return script_content if script_content.include?('# PATCHED: xcframework copy resilience')
    
    patched = script_content
    
    # Replace rsync --delete -av commands with a guarded version
    # Pattern matches: rsync --delete -av [any options] "source/*" "dest"
    # We extract the source base path and wrap in a conditional
    patched = patched.gsub(/(rsync\s+--delete\s+-av\s+(?:[^"]*\s+)*"([^"]+)\/\*"\s+"[^"]+")/) do |match|
      full_cmd = $1
      source_base = $2
      
      # Create an inline conditional that checks if source exists before running rsync
      # Use double brackets for bash compatibility and proper quoting
      <<~GUARDED.chomp
# PATCHED: xcframework copy resilience - check source exists
if [[ -d "#{source_base}" ]] && [[ -n "$(ls -A "#{source_base}" 2>/dev/null)" ]]; then
  #{full_cmd}
else
  echo "warning: Skipping xcframework copy - source does not exist or is empty: #{source_base}"
fi
      GUARDED
    end
    
    patched
  end
  
  if Dir.exist?(target_support_files)
    Dir.glob(File.join(target_support_files, '**', '*-xcframeworks.sh')).each do |script_path|
      next unless File.exist?(script_path)
      
      script_content = File.read(script_path)
      patched_content = patch_xcframework_script.call(script_content)
      
      if patched_content != script_content
        File.write(script_path, patched_content)
        puts "Patched XCFramework copy script: #{script_path}"
      end
    end
  end
  
  # Also patch individual target scripts that might have xcframework copy commands
  installer.pods_project.targets.each do |target|
    target.shell_script_build_phases.each do |phase|
      next unless phase.name == '[CP] Copy XCFrameworks'
      next if phase.shell_script.nil? || phase.shell_script.empty?
      
      patched_script = patch_xcframework_script.call(phase.shell_script)
      
      if patched_script != phase.shell_script
        phase.shell_script = patched_script
        puts "Patched inline XCFramework copy script for target: #{target.name}"
      end
    end
  end

  alamofire_response_serialization = File.join(__dir__, 'Pods', 'Alamofire', 'Source', 'Features', 'ResponseSerialization.swift')
  if File.exist?(alamofire_response_serialization)
    original = 'public protocol DataDecoder: Sendable'
    patched = '@preconcurrency public protocol DataDecoder: Sendable'

    file_contents = File.read(alamofire_response_serialization)
    unless file_contents.include?(patched)
      File.write(
        alamofire_response_serialization,
        file_contents.sub(original, patched)
      )
    end

    json_extension = 'extension JSONDecoder: DataDecoder {}'
    json_replacement = "@available(iOS 16.0, *)\nextension JSONDecoder: DataDecoder {}"
    plist_extension = 'extension PropertyListDecoder: DataDecoder {}'
    plist_replacement = "@available(iOS 16.0, *)\nextension PropertyListDecoder: DataDecoder {}"

    updated_contents = File.read(alamofire_response_serialization)
    if updated_contents.include?(json_extension) && !updated_contents.include?(json_replacement)
      updated_contents = updated_contents.sub(json_extension, json_replacement)
    end
    if updated_contents.include?(plist_extension) && !updated_contents.include?(plist_replacement)
      updated_contents = updated_contents.sub(plist_extension, plist_replacement)
    end
    File.write(alamofire_response_serialization, updated_contents)
  end

  gid_activity_indicator = File.join(__dir__, 'Pods', 'GoogleSignIn', 'GoogleSignIn', 'Sources', 'GIDAppCheck', 'UI', 'GIDActivityIndicatorViewController.m')
  if File.exist?(gid_activity_indicator)
    file_contents = File.read(gid_activity_indicator)
    if file_contents.include?('UIActivityIndicatorViewStyleGray')
      File.write(
        gid_activity_indicator,
        file_contents.gsub('UIActivityIndicatorViewStyleGray', 'UIActivityIndicatorViewStyleMedium')
      )
    end
  end

  alamofire_event_monitor = File.join(__dir__, 'Pods', 'Alamofire', 'Source', 'Features', 'EventMonitor.swift')
  if File.exist?(alamofire_event_monitor)
    file_contents = File.read(alamofire_event_monitor)
    shim = "extension InputStream: @unchecked Sendable {}"
    unless file_contents.include?(shim)
      file_contents = file_contents.sub('import Foundation', "import Foundation\n\n#{shim}")
      File.write(alamofire_event_monitor, file_contents)
    end
  end

  gid_activity_indicator = File.join(__dir__, 'Pods', 'GoogleSignIn', 'GoogleSignIn', 'Sources', 'GIDAppCheck', 'UI', 'GIDActivityIndicatorViewController.m')
  if File.exist?(gid_activity_indicator)
    original = <<~'ORIGINAL'
      UIActivityIndicatorViewStyle style;
      if (@available(iOS 13.0, *)) {
        style = UIActivityIndicatorViewStyleLarge;
      } else {
        style = UIActivityIndicatorViewStyleGray;
      }
    ORIGINAL

    patched = <<~'PATCHED'
      #if __IPHONE_OS_VERSION_MAX_ALLOWED >= 130000
        UIActivityIndicatorViewStyle style = UIActivityIndicatorViewStyleLarge;
      #else
        UIActivityIndicatorViewStyle style;
        if (@available(iOS 13.0, *)) {
          style = UIActivityIndicatorViewStyleLarge;
        } else {
          style = UIActivityIndicatorViewStyleGray;
        }
      #endif
    PATCHED

    file_contents = File.read(gid_activity_indicator)
    unless file_contents.include?('#if __IPHONE_OS_VERSION_MAX_ALLOWED >= 130000')
      File.write(
        gid_activity_indicator,
        file_contents.sub(original, patched)
      )
    end
  end
end
