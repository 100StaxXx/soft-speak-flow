require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'

platform :ios, '16.0'
use_frameworks!

def capacitor_pods
  pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCommunityAppleSignIn', :path => '../../node_modules/@capacitor-community/apple-sign-in'
  pod 'CapacitorFilesystem', :path => '../../node_modules/@capacitor/filesystem'
  pod 'CapacitorPushNotifications', :path => '../../node_modules/@capacitor/push-notifications'
  pod 'CapacitorScreenOrientation', :path => '../../node_modules/@capacitor/screen-orientation'
  pod 'CapacitorShare', :path => '../../node_modules/@capacitor/share'
  pod 'CapacitorSplashScreen', :path => '../../node_modules/@capacitor/splash-screen'
  pod 'CapgoCapacitorSocialLogin', :path => '../../node_modules/@capgo/capacitor-social-login'
end

target 'App' do
  capacitor_pods
  # Add your Pods here
end

post_install do |installer|
  assertDeploymentTarget(installer)

  # Fix XCFramework copy scripts that fail due to missing architecture slices
  # Common issues:
  # - XCFrameworks with different architecture naming (ios-arm64_arm64e vs ios-arm64)
  # - Stale pod caches referencing removed dependencies (e.g., FBSDKCoreKit_Basics)
  # - Corrupted XCFramework downloads
  #
  # Fix: Remove 'set -e' so rsync failures don't abort the build, and ensure exit 0
  fix_xcframework_script = lambda do |phase|
    next unless phase.respond_to?(:name) && phase.name == '[CP] Copy XCFrameworks'
    next unless phase.respond_to?(:shell_script)

    original_script = phase.shell_script
    next if original_script.nil? || original_script.include?('# XCFramework copy fix applied')

    # Remove 'set -e' which causes immediate exit on rsync failures
    # Replace rsync calls with error-tolerant versions
    modified_script = original_script
      .gsub(/^set -e\s*$/, '# set -e  # Disabled to handle XCFramework copy failures gracefully')
      .gsub(/^(\s*)rsync\s/, '\1/usr/bin/rsync ')  # Use absolute path to avoid any aliases

    fixed_script = <<~'SCRIPT'
      #!/bin/sh
      # XCFramework copy fix applied
      # This script has been modified to handle missing architecture slices gracefully
      # If you see warnings about missing files, try: cd ios/App && rm -rf Pods && pod install
      
      SCRIPT
    fixed_script += modified_script
    fixed_script += <<~'SCRIPT'
      
      # Exit successfully - rsync warnings (exit code 23) and missing files are non-fatal
      # The frameworks may use different architecture slices or already be present
      exit 0
      SCRIPT

    phase.shell_script = fixed_script
  end

  script_phase_names = [
    '[CP] Copy XCFrameworks',
    '[CP] Embed Pods Frameworks'
  ].freeze

  configure_script_phase = lambda do |phase|
    next unless phase.respond_to?(:name) && script_phase_names.include?(phase.name)

    phase.always_out_of_date = '1' if phase.respond_to?(:always_out_of_date=)
    if phase.respond_to?(:based_on_dependency_analysis=)
      phase.based_on_dependency_analysis = '0'
    elsif phase.respond_to?(:basedOnDependencyAnalysis=)
      phase.basedOnDependencyAnalysis = '0'
    end
  end

  installer.pods_project.targets.each do |pods_target|
    pods_target.shell_script_build_phases.each do |phase|
      configure_script_phase.call(phase)
      fix_xcframework_script.call(phase)
    end
  end

  installer.aggregate_targets.each do |aggregate_target|
    aggregate_target.user_targets.each do |user_target|
      user_target.shell_script_build_phases.each do |phase|
        configure_script_phase.call(phase)
        fix_xcframework_script.call(phase)
      end
    end
  end

  alamofire_response_serialization = File.join(__dir__, 'Pods', 'Alamofire', 'Source', 'Features', 'ResponseSerialization.swift')
  if File.exist?(alamofire_response_serialization)
    original = 'public protocol DataDecoder: Sendable'
    patched = '@preconcurrency public protocol DataDecoder: Sendable'

    file_contents = File.read(alamofire_response_serialization)
    unless file_contents.include?(patched)
      File.write(
        alamofire_response_serialization,
        file_contents.sub(original, patched)
      )
    end

    json_extension = 'extension JSONDecoder: DataDecoder {}'
    json_replacement = "@available(iOS 16.0, *)\nextension JSONDecoder: DataDecoder {}"
    plist_extension = 'extension PropertyListDecoder: DataDecoder {}'
    plist_replacement = "@available(iOS 16.0, *)\nextension PropertyListDecoder: DataDecoder {}"

    updated_contents = File.read(alamofire_response_serialization)
    if updated_contents.include?(json_extension) && !updated_contents.include?(json_replacement)
      updated_contents = updated_contents.sub(json_extension, json_replacement)
    end
    if updated_contents.include?(plist_extension) && !updated_contents.include?(plist_replacement)
      updated_contents = updated_contents.sub(plist_extension, plist_replacement)
    end
    File.write(alamofire_response_serialization, updated_contents)
  end

  gid_activity_indicator = File.join(__dir__, 'Pods', 'GoogleSignIn', 'GoogleSignIn', 'Sources', 'GIDAppCheck', 'UI', 'GIDActivityIndicatorViewController.m')
  if File.exist?(gid_activity_indicator)
    file_contents = File.read(gid_activity_indicator)
    if file_contents.include?('UIActivityIndicatorViewStyleGray')
      File.write(
        gid_activity_indicator,
        file_contents.gsub('UIActivityIndicatorViewStyleGray', 'UIActivityIndicatorViewStyleMedium')
      )
    end
  end

  alamofire_event_monitor = File.join(__dir__, 'Pods', 'Alamofire', 'Source', 'Features', 'EventMonitor.swift')
  if File.exist?(alamofire_event_monitor)
    file_contents = File.read(alamofire_event_monitor)
    shim = "extension InputStream: @unchecked Sendable {}"
    unless file_contents.include?(shim)
      file_contents = file_contents.sub('import Foundation', "import Foundation\n\n#{shim}")
      File.write(alamofire_event_monitor, file_contents)
    end
  end

  gid_activity_indicator = File.join(__dir__, 'Pods', 'GoogleSignIn', 'GoogleSignIn', 'Sources', 'GIDAppCheck', 'UI', 'GIDActivityIndicatorViewController.m')
  if File.exist?(gid_activity_indicator)
    original = <<~'ORIGINAL'
      UIActivityIndicatorViewStyle style;
      if (@available(iOS 13.0, *)) {
        style = UIActivityIndicatorViewStyleLarge;
      } else {
        style = UIActivityIndicatorViewStyleGray;
      }
    ORIGINAL

    patched = <<~'PATCHED'
      #if __IPHONE_OS_VERSION_MAX_ALLOWED >= 130000
        UIActivityIndicatorViewStyle style = UIActivityIndicatorViewStyleLarge;
      #else
        UIActivityIndicatorViewStyle style;
        if (@available(iOS 13.0, *)) {
          style = UIActivityIndicatorViewStyleLarge;
        } else {
          style = UIActivityIndicatorViewStyleGray;
        }
      #endif
    PATCHED

    file_contents = File.read(gid_activity_indicator)
    unless file_contents.include?('#if __IPHONE_OS_VERSION_MAX_ALLOWED >= 130000')
      File.write(
        gid_activity_indicator,
        file_contents.sub(original, patched)
      )
    end
  end
end
