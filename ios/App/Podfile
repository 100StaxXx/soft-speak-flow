require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'

platform :ios, '14.0'
use_frameworks!

# workaround to avoid Xcode caching of Pods that requires
# Product -> Clean Build Folder after new Cordova plugins installed
# Requires CocoaPods 1.6 or newer
install! 'cocoapods', :disable_input_output_paths => true

def capacitor_pods
  pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCommunityAppleSignIn', :path => '../../node_modules/@capacitor-community/apple-sign-in'
  pod 'CapacitorFilesystem', :path => '../../node_modules/@capacitor/filesystem'
  pod 'CapacitorPushNotifications', :path => '../../node_modules/@capacitor/push-notifications'
  pod 'CapacitorScreenOrientation', :path => '../../node_modules/@capacitor/screen-orientation'
  pod 'CapacitorShare', :path => '../../node_modules/@capacitor/share'
  pod 'CapacitorSplashScreen', :path => '../../node_modules/@capacitor/splash-screen'
  pod 'CapgoCapacitorSocialLogin', :path => '../../node_modules/@capgo/capacitor-social-login'
end

def patch_google_sign_in_indicator!
  file = File.join(__dir__, 'Pods/GoogleSignIn/GoogleSignIn/Sources/GIDAppCheck/UI/GIDActivityIndicatorViewController.m')
  return unless File.exist?(file)

  contents = File.read(file)
  return if contents.include?('#pragma clang diagnostic push')

  original = <<'ORIGINAL'
  UIActivityIndicatorViewStyle style;
  if (@available(iOS 13.0, *)) {
    style = UIActivityIndicatorViewStyleLarge;
  } else {
    style = UIActivityIndicatorViewStyleGray;
  }
  _activityIndicator = [[UIActivityIndicatorView alloc] initWithActivityIndicatorStyle:style];
ORIGINAL

  patched = <<'PATCHED'
  UIActivityIndicatorViewStyle style;
  if (@available(iOS 13.0, *)) {
    style = UIActivityIndicatorViewStyleLarge;
  } else {
#if __IPHONE_OS_VERSION_MIN_REQUIRED < __IPHONE_13_0
#pragma clang diagnostic push
#pragma clang diagnostic ignored "-Wdeprecated-declarations"
    style = UIActivityIndicatorViewStyleGray;
#pragma clang diagnostic pop
#endif
  }
  _activityIndicator = [[UIActivityIndicatorView alloc] initWithActivityIndicatorStyle:style];
PATCHED

  if contents.include?(original)
    File.write(file, contents.sub(original, patched))
    puts 'Patched GoogleSignIn UIActivityIndicatorViewController to avoid deprecated styles.'
  else
    warn 'GoogleSignIn UIActivityIndicatorViewController snippet not found; update Podfile patch.'
  end
end

target 'App' do
  capacitor_pods
  # Add your Pods here
end

post_install do |installer|
  assertDeploymentTarget(installer)
  patch_google_sign_in_indicator!
end
