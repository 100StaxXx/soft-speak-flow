require_relative '../../node_modules/@capacitor/ios/scripts/pods_helpers'

platform :ios, '14.0'
use_frameworks!

def capacitor_pods
  pod 'Capacitor', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCordova', :path => '../../node_modules/@capacitor/ios'
  pod 'CapacitorCommunityAppleSignIn', :path => '../../node_modules/@capacitor-community/apple-sign-in'
  pod 'CapacitorFilesystem', :path => '../../node_modules/@capacitor/filesystem'
  pod 'CapacitorPushNotifications', :path => '../../node_modules/@capacitor/push-notifications'
  pod 'CapacitorScreenOrientation', :path => '../../node_modules/@capacitor/screen-orientation'
  pod 'CapacitorShare', :path => '../../node_modules/@capacitor/share'
  pod 'CapacitorSplashScreen', :path => '../../node_modules/@capacitor/splash-screen'
  pod 'CapgoCapacitorSocialLogin', :path => '../../node_modules/@capgo/capacitor-social-login'
end

target 'App' do
  capacitor_pods
  # Add your Pods here
end

post_install do |installer|
  assertDeploymentTarget(installer)

  phases_to_force = [
    '[CP] Copy XCFrameworks',
    '[CP] Embed Pods Frameworks'
  ]

  update_phases = lambda do |phases|
    phases.each do |phase|
      next unless phase.respond_to?(:name) && phase.name
      next unless phases_to_force.include?(phase.name)
      next unless phase.respond_to?(:always_out_of_date=)

      phase.always_out_of_date = '1'
    end
  end

  installer.pods_project.targets.each do |target|
    update_phases.call(target.shell_script_build_phases)
  end

  user_projects = []

  installer.aggregate_targets.each do |aggregate_target|
    aggregate_target.user_targets.each do |user_target|
      update_phases.call(user_target.shell_script_build_phases)
    end

    if aggregate_target.respond_to?(:user_project) && aggregate_target.user_project
      user_projects << aggregate_target.user_project
    end
  end

  user_projects.uniq.each(&:save)

  alamofire_response_serialization = File.join(__dir__, 'Pods', 'Alamofire', 'Source', 'Features', 'ResponseSerialization.swift')
  if File.exist?(alamofire_response_serialization)
    file_contents = File.read(alamofire_response_serialization)
    updated = false

    original = 'public protocol DataDecoder: Sendable'
    patched = '@preconcurrency public protocol DataDecoder: Sendable'
    if file_contents.include?(original) && !file_contents.include?(patched)
      file_contents = file_contents.sub(original, patched)
      updated = true
    end

    legacy_sendable_shims = <<~'SWIFT'
      #if swift(>=5.5)
      @available(iOS, introduced: 13.0, obsoleted: 16.0)
      @available(tvOS, introduced: 13.0, obsoleted: 16.0)
      @available(watchOS, introduced: 6.0, obsoleted: 9.0)
      @available(macOS, introduced: 10.15, obsoleted: 13.0)
      @available(macCatalyst, introduced: 13.0, obsoleted: 16.0)
      extension JSONDecoder: @unchecked Sendable {}

      @available(iOS, introduced: 13.0, obsoleted: 16.0)
      @available(tvOS, introduced: 13.0, obsoleted: 16.0)
      @available(watchOS, introduced: 6.0, obsoleted: 9.0)
      @available(macOS, introduced: 10.15, obsoleted: 13.0)
      @available(macCatalyst, introduced: 13.0, obsoleted: 16.0)
      extension PropertyListDecoder: @unchecked Sendable {}
      #endif
    SWIFT

    unless file_contents.include?('extension JSONDecoder: @unchecked Sendable')
      anchor = 'extension PropertyListDecoder: DataDecoder {}'
      replacement = "#{anchor}\n\n#{legacy_sendable_shims}"
      file_contents = file_contents.sub(anchor, replacement)
      updated = true
    end

    if updated
      File.write(alamofire_response_serialization, file_contents)
    end
  end

  alamofire_event_monitor = File.join(__dir__, 'Pods', 'Alamofire', 'Source', 'Features', 'EventMonitor.swift')
  if File.exist?(alamofire_event_monitor)
    file_contents = File.read(alamofire_event_monitor)
    event_monitor_shim = <<~'SWIFT'

      #if swift(>=5.5)
      extension InputStream: @unchecked Sendable {}
      #endif
    SWIFT

    unless file_contents.include?('extension InputStream: @unchecked Sendable')
      File.write(alamofire_event_monitor, file_contents + event_monitor_shim)
    end
  end

  google_indicator_file = File.join(__dir__, 'Pods', 'GoogleSignIn', 'GoogleSignIn', 'Sources', 'GIDAppCheck', 'UI', 'GIDActivityIndicatorViewController.m')
  if File.exist?(google_indicator_file)
    file_contents = File.read(google_indicator_file)
    if file_contents.include?('UIActivityIndicatorViewStyleGray')
      File.write(
        google_indicator_file,
        file_contents.gsub('UIActivityIndicatorViewStyleGray', 'UIActivityIndicatorViewStyleMedium')
      )
    end
  end

  installer.pods_project.save
end
