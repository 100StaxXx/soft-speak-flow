const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/EnergyBeamGame-DOxMRCf9.js","assets/vendor-DK8VKJIv.js","assets/date-vendor-BRrA_NVo.js","assets/three-vendor-qI8GXUTd.js","assets/gameUtils-CBfv9FnM.js","assets/gameLifecycle-CMc-cG6H.js","assets/TapSequenceGame-Y_mi02ZY.js","assets/useMaxAspectRect-BoDFlwNt.js","assets/AstralFrequencyGame-CRA64nE1.js","assets/EclipseTimingGame-D4la_ig9.js","assets/StarfallDodgeGame-ssuF2kJe.js","assets/SoulSerpentGame-80vRXiPh.js","assets/OrbMatchGame-5RJgDfJp.js","assets/GalacticMatchGame-CX74TnbQ.js","assets/WidgetDataWeb-8xljeQLN.js","assets/CompanionStoryJournal-CYdEackS.js","assets/CompanionPostcards-DSPFFCea.js","assets/useFirstTimeModal-CJe3iQV7.js","assets/NativeCalendarWeb-Cz8pElqg.js","assets/Home-C8MlTeIW.js","assets/Auth-DO_x6Z6p.js","assets/nativeNavigation-Cw_epy89.js","assets/authRedirect-CNOm6dF3.js","assets/redirectUrl-BrdfvnoF.js","assets/StaticBackgroundImage-DYm4uelU.js","assets/CalendarOAuthCallback-B3iqrPzA.js","assets/ResetPassword-DwQ8jTyx.js","assets/Onboarding-DovSRxEd.js","assets/CompanionPersonalization-ib8qH5vS.js","assets/MentorGrid-DSyXDvnP.js","assets/Welcome-ao5GqiCW.js","assets/Preview-U93ZkXyR.js","assets/Profile-C_Hsi-pK.js","assets/alert-CSmvq9VB.js","assets/clipboard-3OJHfwXT.js","assets/Premium-CF5-6AqT.js","assets/PepTalkDetail-C2NlybG_.js","assets/PromoCodeRedeem-Pw6hMTxk.js","assets/Admin-cFATfUA6.js","assets/MentorSelection-DVZkmn5N.js","assets/NotFound-DuyunY91.js","assets/Reflection-UCSAjkj9.js","assets/MentorChat-4J7eyygm.js","assets/Library-BjID8b-5.js","assets/PepTalkCard-Bf2ZIl8x.js","assets/QuoteCard-Cm3HBnaL.js","assets/Challenges-Bd-ZKO6N.js","assets/Search-B1sWCGDb.js","assets/PepTalks-CNZFjcAs.js","assets/TermsOfService-C-QMkV-s.js","assets/PrivacyPolicy-wKBegAdL.js","assets/PremiumSuccess-DAlAis3E.js","assets/Epics-C9QLI4HE.js","assets/SharedEpics-tC-ZIcqD.js","assets/Partners-DBc-P0Ar.js","assets/JoinEpic-S6OTtz2E.js","assets/Creator-CF03iclo.js","assets/InfluencerDashboard-RKD2R17e.js","assets/AccountDeletionHelp-BaOsrkpW.js","assets/Recaps-DBRIU8br.js","assets/HelpCenter-5zRnk6B8.js","assets/TestDayPlanner-o7wCqj5Y.js","assets/TestScroll-DfMeuAn2.js","assets/Contacts-DmlfAl8q.js","assets/IAPTest-CIiYsZFB.js","assets/SupportReport-DF6AIZ2o.js"])))=>i.map(i=>d[i]);
import{S as qf,i as Lf,c as Of,r as n,t as Ff,a as $f,j as e,V as Bd,R as Ud,b as dr,A as Hd,C as zd,X as kt,T as Kd,D as Qd,P as Bf,$ as Uf,d as Wd,e as Hf,f as zf,g as Kf,h as Qf,k as Bt,l as Re,m as P,n as Mt,o as Ze,u as Ie,p as tr,q as Ee,s as Gd,I as Wf,v as Gf,N as Gn,O as Yd,w as Yf,x as Vd,y as Xd,z as Jd,B as Zd,E as eu,F as Vf,G as Xf,H as ts,J as Sl,K as be,M as zo,L as Yn,Q as wa,U as ca,W as Ca,Y as Jf,Z as tu,_ as zs,a0 as Vn,a1 as su,a2 as Xn,a3 as Zf,a4 as Jn,a5 as Zn,a6 as au,a7 as eg,a8 as Sa,a9 as Rr,aa as bt,ab as ru,ac as aa,ad as Ko,ae as Ds,af as ws,ag as Ut,ah as As,ai as El,aj as It,ak as tg,al as sg,am as ag,an as rg,ao as ng,ap as nu,aq as ei,ar as ke,as as Ks,at as Sr,au as Qo,av as ig,aw as Dt,ax as V,ay as he,az as og,aA as iu,aB as lg,aC as cg,aD as ou,aE as dg,aF as lu,aG as cu,aH as du,aI as sr,aJ as ar,aK as ti,aL as uu,aM as mu,aN as pu,aO as hu,aP as Ir,aQ as zt,aR as fu,aS as ug,aT as Er,aU as Rs,aV as gu,aW as xu,aX as mg,aY as yu,aZ as pg,a_ as hg,a$ as fg,b0 as Nt,b1 as ia,b2 as gg,b3 as Wo,b4 as Ws,b5 as xg,b6 as yg,b7 as bg,b8 as wg,b9 as Tl,ba as Rt,bb as vs,bc as Go,bd as Yr,be as vg,bf as Ci,bg as Ml,bh as _g,bi as bu,bj as jg,bk as Ng,bl as wu,bm as kg,bn as vu,bo as Cg,bp as Vr,bq as Sg,br as es,bs as Eg,bt as Tg,bu as _u,bv as Dl,bw as rr,bx as ju,by as Nu,bz as ku,bA as Mg,bB as bo,bC as Dg,bD as Ag,bE as Pg,bF as Rg,bG as Ig,bH as qg,bI as oa,bJ as Cu,bK as Su,bL as Lg,bM as Eu,bN as Tu,bO as Og,bP as Mu,bQ as Fg,bR as Du,bS as Au,bT as $g,bU as Bg,bV as Pu,bW as Ug,bX as Hg,bY as qr,bZ as Xr,b_ as zg,b$ as Jr,c0 as Kg,c1 as Ru,c2 as Qg,c3 as Iu,c4 as Wg,c5 as Ht,c6 as Gg,c7 as nr,c8 as Kt,c9 as Yg,ca as qu,cb as Vg,cc as Lu,cd as Lr,ce as Ou,cf as Xg,cg as Xa,ch as Fu,ci as Jg,cj as Zg,ck as $u,cl as Bu,cm as Yo,cn as Tr,co as ex,cp as Uu,cq as Hu,cr as wo,cs as zu,ct as Ku,cu as tx,cv as Qu,cw as Wu,cx as Gu,cy as Yu,cz as Vu,cA as Xu,cB as Ju,cC as sx,cD as ax,cE as rx,cF as Zu,cG as nx,cH as ix,cI as ox,cJ as lx,cK as cx,cL as em,cM as tm,cN as dx,cO as ux,cP as sm,cQ as mx,cR as px,cS as hx,cT as fx,cU as si,cV as am,cW as gx,cX as xx,cY as yx,cZ as rm,c_ as bx,c$ as wx,d0 as vx,d1 as Ge,d2 as Fa,d3 as _x,d4 as jx,d5 as Nx}from"./vendor-DK8VKJIv.js";import{o as ae,F as Jt,G as kx,H as va,I as nm,J as Vo,s as Or,e as Fr,B as im,z as om,K as vo,L as Cx,c as Ja,g as $r,i as Sx,v as Gs,w as En,M as Ft,j as ai,k as lm,h as Ts,a as ir,m as _o,N as Si,O as Ei,P as Ti,Q as Al,R as Pl,S as Rl,T as Il,U as or,V as Xo,W as jo,p as Ex,X as Tx,q as Mx}from"./date-vendor-BRrA_NVo.js";import"./three-vendor-qI8GXUTd.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const l of o.addedNodes)l.tagName==="LINK"&&l.rel==="modulepreload"&&r(l)}).observe(document,{childList:!0,subtree:!0});function a(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=a(i);fetch(i.href,o)}})();const Dx=async()=>{try{console.debug("Capacitor initialized, splash screen visible")}catch(t){console.debug("Capacitor initialization error:",t)}},Ax=async()=>{try{await qf.hide({fadeOutDuration:300}),console.debug("Splash screen hidden")}catch(t){console.debug("Splash screen not available:",t)}},ql={debug:0,info:1,warn:2,error:3},Px="warn";function Tn(t){return ql[t]>=ql[Px]}function Rx(t){const s=t.scope?`[${t.scope}]`:"";return s?`${s} ${t.message}`:t.message}function Ix(t){Lf()&&Of(t.message,{level:"error",extra:t.context,tags:t.scope?{scope:t.scope}:void 0})}function cs(t,s,a,r){if(!Tn(t))return;const i={message:s,context:a,timestamp:new Date().toISOString(),scope:r},l=[Rx(i)];switch(a&&Object.keys(a).length>0&&l.push(a),t){case"debug":console.log(...l);break;case"info":console.log(...l);break;case"warn":console.warn(...l);break;case"error":console.error(...l),Ix(i);break}}function qx(t){return{debug:(s,a)=>cs("debug",s,a,t),info:(s,a)=>cs("info",s,a,t),warn:(s,a)=>cs("warn",s,a,t),error:(s,a)=>{s instanceof Error?cs("error",s.message,{...a,stack:s.stack,name:s.name},t):cs("error",s,a,t)}}}function Lx(t,s){const a=performance.now();return{end:r=>{const i=Math.round(performance.now()-a);return cs("debug",`${t} completed in ${i}ms`,{...r,durationMs:i},s),i},checkpoint:r=>{const i=Math.round(performance.now()-a);return cs("debug",`${t} checkpoint: ${r} at ${i}ms`,{elapsedMs:i},s),i}}}const ue={debug:(t,s)=>cs("debug",t,s),info:(t,s)=>cs("info",t,s),warn:(t,s)=>cs("warn",t,s),error:(t,s)=>{t instanceof Error?cs("error",t.message,{...s,stack:t.stack,name:t.name}):cs("error",t,s)},log:(t,...s)=>{Tn("debug")&&console.log(t,...s)},scope:t=>qx(t),time:(t,s)=>Lx(t,s),dev:(t,s)=>{},group:(t,s)=>{if(Tn("debug")){console.group(t);try{s()}finally{console.groupEnd()}}},table:t=>{Tn("debug")&&console.table(t)}},Ox=1,Fx=1e6;let Mi=0;function $x(){return Mi=(Mi+1)%Number.MAX_SAFE_INTEGER,Mi.toString()}const Di=new Map,Ll=t=>{if(Di.has(t))return;const s=setTimeout(()=>{Di.delete(t),Mr({type:"REMOVE_TOAST",toastId:t})},Fx);Di.set(t,s)},Bx=(t,s)=>{switch(s.type){case"ADD_TOAST":return{...t,toasts:[s.toast,...t.toasts].slice(0,Ox)};case"UPDATE_TOAST":return{...t,toasts:t.toasts.map(a=>a.id===s.toast.id?{...a,...s.toast}:a)};case"DISMISS_TOAST":{const{toastId:a}=s;return a?Ll(a):t.toasts.forEach(r=>{Ll(r.id)}),{...t,toasts:t.toasts.map(r=>r.id===a||a===void 0?{...r,open:!1}:r)}}case"REMOVE_TOAST":return s.toastId===void 0?{...t,toasts:[]}:{...t,toasts:t.toasts.filter(a=>a.id!==s.toastId)}}},Mn=[];let Dn={toasts:[]};function Mr(t){Dn=Bx(Dn,t),Mn.forEach(s=>{s(Dn)})}function Ux({...t}){const s=$x(),a=i=>Mr({type:"UPDATE_TOAST",toast:{...i,id:s}}),r=()=>Mr({type:"DISMISS_TOAST",toastId:s});return Mr({type:"ADD_TOAST",toast:{...t,id:s,open:!0,onOpenChange:i=>{i||r()}}}),{id:s,dismiss:r,update:a}}function _s(){const[t,s]=n.useState(Dn);return n.useEffect(()=>(Mn.push(s),()=>{const a=Mn.indexOf(s);a>-1&&Mn.splice(a,1)}),[t]),{...t,toast:Ux,dismiss:a=>Mr({type:"DISMISS_TOAST",toastId:a})}}function I(...t){return Ff($f(t))}function Ps(t){return t?t.replace(/[_-]+/g," ").replace(/\s+/g," ").trim().toLowerCase().replace(/\b[a-z]/g,s=>s.toUpperCase()):""}function No(t){return t?t.replace(/\*\*([^*]+)\*\*/g,"$1").replace(/\*([^*]+)\*/g,"$1").replace(/__([^_]+)__/g,"$1").replace(/_([^_]+)_/g,"$1").replace(/~~([^~]+)~~/g,"$1").replace(/`([^`]+)`/g,"$1").trim():""}const Hx=Bf,cm=n.forwardRef(({className:t,...s},a)=>e.jsx(Bd,{ref:a,className:I("pointer-events-none fixed bottom-[calc(64px+env(safe-area-inset-bottom,0px)+12px)] right-0 z-[100] flex max-h-screen w-full flex-col p-4 sm:bottom-0 sm:max-w-[420px]",t),...s}));cm.displayName=Bd.displayName;const zx=dr("group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-y-0 data-[swipe=end]:translate-y-[var(--radix-toast-swipe-end-y)] data-[swipe=move]:translate-y-[var(--radix-toast-swipe-move-y)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-bottom-full data-[state=open]:slide-in-from-bottom-full",{variants:{variant:{default:"border bg-background text-foreground",destructive:"destructive group border-destructive bg-destructive text-destructive-foreground"}},defaultVariants:{variant:"default"}}),dm=n.forwardRef(({className:t,variant:s,...a},r)=>e.jsx(Ud,{ref:r,className:I(zx({variant:s}),t),...a}));dm.displayName=Ud.displayName;const um=n.forwardRef(({className:t,...s},a)=>e.jsx(Hd,{ref:a,className:I("inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors group-[.destructive]:border-muted/40 hover:bg-secondary group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 group-[.destructive]:focus:ring-destructive disabled:pointer-events-none disabled:opacity-50",t),...s}));um.displayName=Hd.displayName;const mm=n.forwardRef(({className:t,...s},a)=>e.jsx(zd,{ref:a,className:I("absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity group-hover:opacity-100 group-[.destructive]:text-red-300 hover:text-foreground group-[.destructive]:hover:text-red-50 focus:opacity-100 focus:outline-none focus:ring-2 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",t),"toast-close":"",...s,children:e.jsx(kt,{className:"h-4 w-4"})}));mm.displayName=zd.displayName;const pm=n.forwardRef(({className:t,...s},a)=>e.jsx(Kd,{ref:a,className:I("text-sm font-semibold",t),...s}));pm.displayName=Kd.displayName;const hm=n.forwardRef(({className:t,...s},a)=>e.jsx(Qd,{ref:a,className:I("text-sm opacity-90",t),...s}));hm.displayName=Qd.displayName;function Kx(){const{toasts:t}=_s();return e.jsxs(Hx,{swipeDirection:"up",children:[t.map(function({id:s,title:a,description:r,action:i,...o}){return e.jsxs(dm,{...o,children:[e.jsxs("div",{className:"grid gap-1",children:[a&&e.jsx(pm,{children:a}),r&&e.jsx(hm,{children:r})]}),i,e.jsx(mm,{})]},s)}),e.jsx(cm,{})]})}const Qx=({...t})=>e.jsx(Uf,{theme:"dark",className:"toaster group",position:"bottom-center",swipeDirections:["bottom","left","right"],toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"group-[.toast]:text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...t}),fm=Kf,gm=Hf,xm=zf,Jo=n.forwardRef(({className:t,sideOffset:s=4,...a},r)=>e.jsx(Wd,{ref:r,sideOffset:s,className:I("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...a}));Jo.displayName=Wd.displayName;const mn=()=>{try{const t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch{return!1}},pn=()=>{try{const t="__storage_test__";return sessionStorage.setItem(t,t),sessionStorage.removeItem(t),!0}catch{return!1}},st={getItem:t=>{try{return mn()?localStorage.getItem(t):null}catch{return null}},setItem:(t,s)=>{try{return mn()?(localStorage.setItem(t,s),!0):!1}catch{return!1}},removeItem:t=>{try{return mn()?(localStorage.removeItem(t),!0):!1}catch{return!1}},clear:()=>{try{return mn()?(localStorage.clear(),!0):!1}catch{return!1}}},ko={getItem:t=>{try{return pn()?sessionStorage.getItem(t):null}catch{return null}},setItem:(t,s)=>{try{return pn()?(sessionStorage.setItem(t,s),!0):!1}catch{return!1}},removeItem:t=>{try{return pn()?(sessionStorage.removeItem(t),!0):!1}catch{return!1}},clear:()=>{try{return pn()?(sessionStorage.clear(),!0):!1}catch{return!1}}},Wx="https://opbfpbbqvuksuvmtmssd.supabase.co",Gx="sb_publishable_JIATfg-h-gcg2TLZGmQeSw_XcHqQZvB",Yx={getItem:t=>st.getItem(t),setItem:(t,s)=>{st.setItem(t,s)},removeItem:t=>{st.removeItem(t)}},k=Qf(Wx,Gx,{auth:{storage:Yx,persistSession:!0,autoRefreshToken:!0}}),ym=n.createContext({currentTheme:null,isTransitioning:!1}),Vx=()=>n.useContext(ym),Xx=({children:t,mentorId:s})=>{const[a,r]=n.useState(null),[i,o]=n.useState(!1);n.useEffect(()=>{let u=!0,p;return(async()=>{if(!s){u&&(r(null),c());return}try{const{data:f}=await k.from("mentors").select("theme_config").eq("id",s).maybeSingle();if(!u)return;if(f?.theme_config){o(!0);const m=f.theme_config;r(m),l(m),p=setTimeout(()=>{u&&o(!1)},300)}else c()}catch(f){console.error("Error applying theme:",f),u&&(c(),o(!1))}})(),()=>{u=!1,p&&clearTimeout(p)}},[s]);const l=u=>{const p=document.documentElement;p.style.setProperty("--primary",u.primary),p.style.setProperty("--secondary",u.secondary),p.style.setProperty("--accent",u.accent),p.style.setProperty("--background",u.background),p.style.setProperty("--foreground",u.foreground),p.style.setProperty("--card",u.card),p.style.setProperty("--card-foreground",u.foreground),p.style.setProperty("--popover",u.card),p.style.setProperty("--popover-foreground",u.foreground),p.style.setProperty("--primary-foreground",u.foreground),p.style.setProperty("--secondary-foreground",u.foreground),p.style.setProperty("--accent-foreground",u.foreground),p.style.setProperty("--radius",u.border_radius),u.glow_effect?p.style.setProperty("--shadow-glow",`0 0 24px hsl(${u.primary} / 0.5)`):p.style.setProperty("--shadow-glow","0 0 0 transparent"),u.border_style==="sharp"?p.classList.add("sharp-borders"):p.classList.remove("sharp-borders"),u.texture&&u.texture!=="none"&&p.style.setProperty("--bg-texture",u.texture),p.classList.add("theme-transition"),setTimeout(()=>p.classList.remove("theme-transition"),300)},c=()=>{const u=document.documentElement;u.style.setProperty("--primary","270 60% 50%"),u.style.setProperty("--secondary","240 6% 20%"),u.style.setProperty("--accent","270 50% 35%"),u.style.setProperty("--background","0 0% 7%"),u.style.setProperty("--foreground","0 0% 100%"),u.style.setProperty("--card","240 6% 15%"),u.style.setProperty("--radius","1.25rem"),u.style.setProperty("--shadow-glow","0 0 24px hsl(270 60% 50% / 0.5)"),u.classList.remove("sharp-borders")},d=n.useMemo(()=>({currentTheme:a,isTransitioning:i}),[a,i]);return e.jsx(ym.Provider,{value:d,children:t})},Jx=n.createContext(void 0),hn="cosmiq_view_mode";function Zx({children:t}){const[s,a]=n.useState(()=>{const l=st.getItem(hn);return l==="focus"||l==="quest"?l:"quest"}),r=n.useCallback(l=>{a(l),st.setItem(hn,l)},[]),i=n.useCallback(()=>{a(l=>{const c=l==="focus"?"quest":"focus";return st.setItem(hn,c),c})},[]);n.useEffect(()=>{st.setItem(hn,s)},[s]);const o=n.useMemo(()=>({viewMode:s,setViewMode:r,toggleViewMode:i}),[s,r,i]);return e.jsx(Jx.Provider,{value:o,children:t})}const On={dawn:{start:5,end:8,colors:{primary:"hsl(25, 90%, 55%)",accent:"hsl(340, 75%, 60%)",nebula1:"hsl(330, 65%, 45%)",nebula2:"hsl(25, 80%, 50%)",nebula3:"hsl(45, 90%, 60%)",starTint:"warm",gradient:"from-rose-950/40 via-amber-900/30 to-slate-900/50"}},morning:{start:8,end:12,colors:{primary:"hsl(195, 85%, 50%)",accent:"hsl(170, 75%, 45%)",nebula1:"hsl(185, 70%, 45%)",nebula2:"hsl(45, 85%, 55%)",nebula3:"hsl(210, 75%, 50%)",starTint:"neutral",gradient:"from-sky-950/40 via-cyan-900/30 to-slate-900/50"}},afternoon:{start:12,end:17,colors:{primary:"hsl(35, 95%, 55%)",accent:"hsl(190, 80%, 50%)",nebula1:"hsl(40, 85%, 50%)",nebula2:"hsl(180, 70%, 45%)",nebula3:"hsl(55, 90%, 60%)",starTint:"warm",gradient:"from-amber-950/40 via-teal-900/30 to-slate-900/50"}},sunset:{start:17,end:20,colors:{primary:"hsl(330, 80%, 55%)",accent:"hsl(20, 90%, 55%)",nebula1:"hsl(340, 75%, 50%)",nebula2:"hsl(25, 85%, 55%)",nebula3:"hsl(280, 60%, 50%)",starTint:"warm",gradient:"from-pink-950/40 via-orange-900/30 to-purple-950/40"}},night:{start:20,end:5,colors:{primary:"hsl(230, 70%, 55%)",accent:"hsl(195, 90%, 55%)",nebula1:"hsl(240, 60%, 45%)",nebula2:"hsl(200, 75%, 50%)",nebula3:"hsl(270, 55%, 45%)",starTint:"cool",gradient:"from-indigo-950/50 via-slate-900/40 to-black/60"}}},ey=t=>t>=5&&t<8?"dawn":t>=8&&t<12?"morning":t>=12&&t<17?"afternoon":t>=17&&t<20?"sunset":"night",ty=(t,s,a)=>{const r=On[a],i=t*60+s;let o=r.start*60,l=r.end*60;a==="night"&&(t>=20?l=1740:(o=0,l=300));const c=l-o,d=i-o;return Math.max(0,Math.min(1,d/c))},sy=(t,s)=>(t*60+s)*.5%360,ay=On.night.colors,bm=n.createContext({period:"night",progress:0,colors:ay,rotationHue:0}),ry=()=>n.useContext(bm),ny=({children:t})=>{const[s,a]=n.useState("night"),[r,i]=n.useState(0),[o,l]=n.useState(0);n.useEffect(()=>{const u=()=>{const h=new Date,f=h.getHours(),m=h.getMinutes(),g=ey(f),y=ty(f,m,g),b=sy(f,m);a(g),i(y),l(b)};u();const p=setInterval(u,6e4);return()=>clearInterval(p)},[]),n.useEffect(()=>{const u=document.documentElement,p=On[s].colors;u.style.setProperty("--time-primary",p.primary),u.style.setProperty("--time-accent",p.accent),u.style.setProperty("--time-nebula-1",p.nebula1),u.style.setProperty("--time-nebula-2",p.nebula2),u.style.setProperty("--time-nebula-3",p.nebula3),u.style.setProperty("--time-gradient",p.gradient),u.style.setProperty("--rotation-hue",`${o}deg`),u.setAttribute("data-time-period",s)},[s,o]);const c=n.useMemo(()=>On[s].colors,[s]),d=n.useMemo(()=>({period:s,progress:r,colors:c,rotationHue:o}),[s,r,c,o]);return e.jsx(bm.Provider,{value:d,children:t})},iy=typeof navigator<"u",oy=iy&&"vibrate"in navigator&&typeof navigator.vibrate=="function";let Ol=!1;const br=t=>{if(!(!oy||Ol))try{navigator.vibrate(t)}catch(s){console.warn("Haptics unavailable, disabling vibration",s),Ol=!0}},gt={light:()=>{br(10)},medium:()=>{br(20)},heavy:()=>{br(30)},success:()=>{br([10,50,10])},error:()=>{br([50,100,50])}},ly=({xp:t,reason:s,show:a,onComplete:r})=>(n.useEffect(()=>{if(a){gt.light(),Bt({particleCount:20,spread:50,origin:{y:.7},colors:["#A76CFF","#C084FC"],ticks:100,gravity:1.2});const i=setTimeout(r,2e3);return()=>clearTimeout(i)}},[a,r]),e.jsx(Re,{children:a&&e.jsx(P.div,{initial:{opacity:0,y:20,scale:.9},animate:{opacity:1,y:0,scale:1,transition:{type:"spring",stiffness:400,damping:20}},exit:{opacity:0,y:-10,scale:.95,transition:{duration:.15}},className:"fixed bottom-28 left-1/2 -translate-x-1/2 z-50",children:e.jsx(P.div,{className:"bg-black/70 backdrop-blur-sm border border-white/20 px-4 py-2 rounded-full",animate:{boxShadow:["0 0 10px rgba(167, 108, 255, 0.3)","0 0 20px rgba(167, 108, 255, 0.5)","0 0 10px rgba(167, 108, 255, 0.3)"]},transition:{duration:1.5,repeat:1/0},children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Mt,{className:"h-4 w-4 text-stardust-gold"}),e.jsxs("span",{className:"text-sm font-semibold text-white",children:["+",t," XP"]}),s&&e.jsx("span",{className:"text-xs text-white/70",children:s})]})})})})),ds=ue.scope("iOS Audio"),ma=Ze.getPlatform()==="ios"||/iPad|iPhone|iPod/.test(navigator.userAgent);let Ai=null,Pi=!1,An=!1;function Fn(){if(typeof window>"u")return null;if(!Ai)try{const t=window.AudioContext||window.webkitAudioContext;t&&(Ai=new t)}catch(t){ds.error("Failed to create AudioContext",{error:t})}return Ai}async function Zr(){const t=Fn();if(!t)return!1;if(t.state==="suspended")try{return await t.resume(),Pi=!0,ds.debug("AudioContext resumed successfully"),!0}catch(s){return ds.error("Failed to resume AudioContext",{error:s}),!1}return Pi=t.state==="running",Pi}function cy(){return Fn()?.state==="running"}function Zo(){if(typeof document>"u"||An)return;const t=async()=>{if(!An){An=!0,ds.info("User interaction detected, enabling audio..."),await Zr();try{const s=new Audio;s.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA",s.volume=.001,s.playsInline=!0;const a=s.play();a&&a.then(()=>{s.pause(),s.src="",ds.debug("Audio unlocked via silent play")}).catch(()=>{ds.debug("Silent play caught (expected on some platforms)")})}catch(s){ds.debug("Silent unlock failed (non-critical)",{error:s})}document.removeEventListener("touchstart",t,!0),document.removeEventListener("touchend",t,!0),document.removeEventListener("click",t,!0),document.removeEventListener("keydown",t,!0)}};document.addEventListener("touchstart",t,{capture:!0,passive:!0}),document.addEventListener("touchend",t,{capture:!0,passive:!0}),document.addEventListener("click",t,{capture:!0}),document.addEventListener("keydown",t,{capture:!0})}function IT(t){const s=new Audio;return s.playsInline=!0,s["webkit-playsinline"]=!0,s.preload="auto",t&&(s.src=t),s}async function dy(t){if(!t)return!1;ma&&!cy()&&await Zr();try{const s=t.play();return s&&await s,!0}catch(s){const a=s;return a.name==="NotAllowedError"?(ds.debug("Play blocked - waiting for user interaction"),!1):(a.name==="AbortError"||ds.error("Play failed",{error:s}),!1)}}class uy{isMuted=!1;listeners=new Set;audioElements=new Set;constructor(){typeof window<"u"&&(this.loadState(),Zo(),document.addEventListener("visibilitychange",this.handleVisibilityChange),Ze.isNativePlatform()&&document.addEventListener("resume",()=>{this.isMuted||this.resumeAllAudio()}))}loadState(){const s=st.getItem("global_audio_muted");this.isMuted=s==="true"}saveState(){st.setItem("global_audio_muted",this.isMuted.toString())}handleVisibilityChange=()=>{document.hidden?ds.info("App backgrounded"):(ds.info("App foregrounded"),this.isMuted||setTimeout(()=>this.resumeAllAudio(),100))};registerAudio(s){this.audioElements.add(s),this.isMuted&&(s.muted=!0)}unregisterAudio(s){this.audioElements.delete(s)}async resumeAllAudio(){await Zr();for(const s of this.audioElements)s.paused&&!this.isMuted&&dy(s)}getMuted(){return this.isMuted}setMuted(s){if(this.isMuted!==s){this.isMuted=s,this.saveState();for(const a of this.audioElements)a.muted=s;this.notifyListeners(),typeof window<"u"&&window.dispatchEvent(new CustomEvent("ios-audio-mute-change",{detail:s}))}}toggleMute(){return this.setMuted(!this.isMuted),this.isMuted}subscribe(s){return this.listeners.add(s),()=>this.listeners.delete(s)}notifyListeners(){for(const s of this.listeners)try{s(this.isMuted)}catch(a){ds.error("Listener error",{error:a})}}canPlay(){return!this.isMuted&&An}}const wr=new uy;typeof window<"u"&&Zo();class my{isMuted=!1;listeners=new Set;constructor(){typeof window<"u"&&(this.loadPreferences(),Zo(),ma&&wr.subscribe(s=>{this.isMuted!==s&&(this.isMuted=s,this.notifyListeners())}))}loadPreferences(){try{const s=st.getItem("global_audio_muted");s&&(this.isMuted=s==="true",ma&&wr.setMuted(this.isMuted))}catch(s){console.warn("Failed to load global audio preferences:",s)}}savePreferences(){try{st.setItem("global_audio_muted",this.isMuted.toString())}catch(s){console.warn("Failed to save global audio preferences:",s)}}notifyListeners(){this.listeners.forEach(s=>{try{s(this.isMuted)}catch(a){console.error("Error in global audio listener:",a)}}),typeof window<"u"&&window.dispatchEvent(new CustomEvent("global-audio-mute-change",{detail:this.isMuted}))}toggleMute(){return this.isMuted=!this.isMuted,this.savePreferences(),ma&&wr.setMuted(this.isMuted),this.notifyListeners(),this.isMuted}setMuted(s){this.isMuted!==s&&(this.isMuted=s,this.savePreferences(),ma&&wr.setMuted(s),this.notifyListeners())}getMuted(){return this.isMuted}subscribe(s){return this.listeners.add(s),()=>{this.listeners.delete(s)}}canPlayAudio(){return ma?!this.isMuted&&wr.canPlay():!this.isMuted}async ensureReady(){ma&&await Zr()}}const Co=new my;class py{audioContext=null;masterVolume=.5;isMuted=!1;isGloballyMuted=!1;activeIntervals=new Set;globalMuteUnsubscribe=null;constructor(){typeof window<"u"&&(this.audioContext=Fn(),this.loadSoundPreferences(),this.isGloballyMuted=Co.getMuted(),this.globalMuteUnsubscribe=Co.subscribe(s=>{this.isGloballyMuted=s,s&&this.stopAllAmbientSounds()}),window.addEventListener("beforeunload",()=>{this.stopAllAmbientSounds(),this.globalMuteUnsubscribe&&this.globalMuteUnsubscribe()}))}shouldMute(){return this.isMuted||this.isGloballyMuted}async ensureAudioContext(){return this.audioContext||(this.audioContext=Fn()),this.audioContext&&this.audioContext.state==="suspended"&&await Zr(),this.audioContext}loadSoundPreferences(){const s=st.getItem("sound_volume"),a=st.getItem("sound_muted");s&&(this.masterVolume=parseFloat(s)),a&&(this.isMuted=a==="true")}setVolume(s){this.masterVolume=Math.max(0,Math.min(1,s)),st.setItem("sound_volume",this.masterVolume.toString())}toggleMute(){return this.isMuted=!this.isMuted,st.setItem("sound_muted",this.isMuted.toString()),this.isMuted&&this.stopAllAmbientSounds(),this.isMuted}stopAllAmbientSounds(){this.activeIntervals.forEach(s=>clearInterval(s)),this.activeIntervals.clear()}createOscillator(s,a,r="sine"){if(!this.audioContext||this.shouldMute())return null;const i=this.audioContext.createOscillator(),o=this.audioContext.createGain();return i.type=r,i.frequency.setValueAtTime(s,this.audioContext.currentTime),o.gain.setValueAtTime(this.masterVolume*.3,this.audioContext.currentTime),o.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+a),i.connect(o),o.connect(this.audioContext.destination),i.start(this.audioContext.currentTime),i.stop(this.audioContext.currentTime+a),null}async playEvolutionStart(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[220,277,330,440,554,659,880,1108].forEach((a,r)=>{setTimeout(()=>{this.createOscillator(a,.2,"sawtooth"),this.createOscillator(a*1.5,.1,"sine")},r*80)})}async playEvolutionSuccess(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=[130.81,164.81,196],a=[[523.25,659.25,783.99],[659.25,830.61,987.77],[783.99,987.77,1174.66],[1046.5,1318.51,1567.98]];s.forEach((r,i)=>{setTimeout(()=>{this.createOscillator(r,.4,"sawtooth")},i*150)}),a.forEach((r,i)=>{setTimeout(()=>{r.forEach(o=>{this.createOscillator(o,.35,"triangle"),this.createOscillator(o*2,.15,"sine")})},i*180)})}async playSparkle(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=1500+Math.random()*1e3;this.createOscillator(s,.15,"sine")}async playHabitComplete(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(800,.1,"triangle"),setTimeout(()=>{this.createOscillator(1200,.15,"sine")},50)))}async playXPGain(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[440,554.37,659.25].forEach((a,r)=>{setTimeout(()=>{this.createOscillator(a,.1,"square")},r*40)})}async playMissionComplete(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(523.25,.15,"triangle"),setTimeout(()=>{this.createOscillator(659.25,.15,"triangle")},75),setTimeout(()=>{this.createOscillator(783.99,.2,"triangle")},150)))}async playLessonComplete(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(659.25,.2,"sine"),setTimeout(()=>{this.createOscillator(783.99,.25,"sine")},100),setTimeout(()=>{this.createOscillator(1046.5,.3,"sine")},200)))}async playAchievementUnlock(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[{freq:392,duration:.2},{freq:523.25,duration:.2},{freq:659.25,duration:.3},{freq:783.99,duration:.4}].forEach((a,r)=>{setTimeout(()=>{this.createOscillator(a.freq,a.duration,"triangle")},r*150)})}async playButtonClick(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&this.createOscillator(300,.05,"square"))}async playNotification(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(660,.15,"sine"),setTimeout(()=>{this.createOscillator(880,.2,"sine")},100)))}async playStreakMilestone(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[523.25,659.25,783.99,1046.5,1318.51].forEach((a,r)=>{setTimeout(()=>{this.createOscillator(a,.25,"triangle")},r*100)})}async playAmbientNature(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=[100,150,200,250];s.forEach(r=>{this.createOscillator(r+Math.random()*20,2,"sine")});const a=setInterval(()=>{if(this.shouldMute()){clearInterval(a),this.activeIntervals.delete(a);return}s.forEach(r=>{this.createOscillator(r+Math.random()*20,2,"sine")})},2e3);return this.activeIntervals.add(a),()=>{clearInterval(a),this.activeIntervals.delete(a)}}async playCalming(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(220,3,"sine"),setTimeout(()=>{this.createOscillator(440,3,"sine")},1500)))}async playArcadeEntrance(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=150,a=800,r=.6,i=this.audioContext.createOscillator(),o=this.audioContext.createGain();i.type="sawtooth",i.frequency.setValueAtTime(s,this.audioContext.currentTime),i.frequency.exponentialRampToValueAtTime(a,this.audioContext.currentTime+r),o.gain.setValueAtTime(this.masterVolume*.25,this.audioContext.currentTime),o.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+r),i.connect(o),o.connect(this.audioContext.destination),i.start(),i.stop(this.audioContext.currentTime+r);const l=this.audioContext.createOscillator(),c=this.audioContext.createGain();l.type="square",l.frequency.setValueAtTime(s*2,this.audioContext.currentTime),l.frequency.exponentialRampToValueAtTime(a*1.5,this.audioContext.currentTime+r),c.gain.setValueAtTime(this.masterVolume*.1,this.audioContext.currentTime),c.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+r),l.connect(c),c.connect(this.audioContext.destination),l.start(),l.stop(this.audioContext.currentTime+r),setTimeout(()=>{this.createOscillator(1200,.15,"sine"),this.createOscillator(1500,.1,"sine")},400)}async playArcadeSelect(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=this.audioContext.createOscillator(),a=this.audioContext.createGain();s.type="square",s.frequency.setValueAtTime(600,this.audioContext.currentTime),s.frequency.exponentialRampToValueAtTime(800,this.audioContext.currentTime+.08),a.gain.setValueAtTime(this.masterVolume*.2,this.audioContext.currentTime),a.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.1),s.connect(a),a.connect(this.audioContext.destination),s.start(),s.stop(this.audioContext.currentTime+.1)}async playArcadeHighScore(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[523.25,659.25,783.99,1046.5].forEach((a,r)=>{setTimeout(()=>{this.createOscillator(a,.2,"triangle"),this.createOscillator(a*2,.1,"sine")},r*100)}),setTimeout(()=>{[1046.5,1318.51,1567.98].forEach(a=>{this.createOscillator(a,.4,"triangle")})},450)}async playEncounterTrigger(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[329.63,392,493.88,659.25].forEach((a,r)=>{setTimeout(()=>{const i=this.audioContext.createOscillator(),o=this.audioContext.createGain();i.type="square",i.frequency.setValueAtTime(a,this.audioContext.currentTime),o.gain.setValueAtTime(this.masterVolume*.25,this.audioContext.currentTime),o.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.15),i.connect(o),o.connect(this.audioContext.destination),i.start(),i.stop(this.audioContext.currentTime+.15)},r*100)})}async playStrikethrough(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=this.audioContext.createOscillator(),a=this.audioContext.createGain();s.type="sine",s.frequency.setValueAtTime(1200,this.audioContext.currentTime),s.frequency.exponentialRampToValueAtTime(300,this.audioContext.currentTime+.15),a.gain.setValueAtTime(this.masterVolume*.25,this.audioContext.currentTime),a.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.18),s.connect(a),a.connect(this.audioContext.destination),s.start(),s.stop(this.audioContext.currentTime+.2),setTimeout(()=>{this.createOscillator(800,.08,"triangle")},100)}}const us=new py,hy=()=>us.playEvolutionStart(),fy=()=>us.playEvolutionSuccess(),qT=()=>us.playHabitComplete(),gy=()=>us.playXPGain(),el=()=>us.playMissionComplete(),xy=()=>us.playAchievementUnlock(),yy=()=>us.playEncounterTrigger(),by=()=>us.playStrikethrough(),wy=t=>{switch(t){case"complete":return us.playHabitComplete();case"error":return us.playButtonClick();case"pop":return us.playSparkle();case"success":return us.playMissionComplete()}},wm=n.createContext(null),vy=({children:t})=>{const[s,a]=n.useState({xp:0,reason:"",show:!1}),r=n.useCallback((l,c)=>{a({xp:l,reason:c,show:!0}),gy()},[]),i=n.useCallback(()=>{a(l=>({...l,show:!1}))},[]),o=n.useMemo(()=>({showXPToast:r}),[r]);return e.jsxs(wm.Provider,{value:o,children:[t,e.jsx(ly,{xp:s.xp,reason:s.reason,show:s.show,onComplete:i})]})},vm=()=>{const t=n.useContext(wm);if(!t)throw new Error("useXPToast must be used within XPProvider");return t},_m=n.createContext(void 0),_y=({children:t})=>{const[s,a]=n.useState(!1),[r,i]=n.useState(null),o=n.useMemo(()=>({isEvolvingLoading:s,setIsEvolvingLoading:a,onEvolutionComplete:r,setOnEvolutionComplete:i}),[s,r]);return e.jsx(_m.Provider,{value:o,children:t})},ri=()=>{const t=n.useContext(_m);if(t===void 0)throw new Error("useEvolution must be used within an EvolutionProvider");return t},jm=n.createContext(void 0),jy=({children:t})=>{const[s,a]=n.useState(!1),[r,i]=n.useState([]),o=n.useCallback(u=>{i(p=>p.includes(u)?p:[...p,u])},[]),l=n.useCallback(u=>{let p=!1;return i(h=>h.includes(u)?(p=!0,h.filter(f=>f!==u)):h),p},[]),c=n.useCallback(()=>{i([])},[]),d=n.useMemo(()=>({isEvolutionInProgress:s,setEvolutionInProgress:a,pendingCelebrations:r,addPendingCelebration:o,consumePendingCelebration:l,clearAllPending:c}),[s,r,o,l,c]);return e.jsx(jm.Provider,{value:d,children:t})},Ny=()=>{const t=n.useContext(jm);if(t===void 0)throw new Error("useCelebration must be used within a CelebrationProvider");return t},Nm=2;function km(t){const s=new Date,a=Intl.DateTimeFormat().resolvedOptions().timeZone;if(parseInt(new Intl.DateTimeFormat("en-US",{hour:"numeric",hour12:!1,timeZone:a}).format(s))<Nm){const i=new Date(s);return i.setDate(i.getDate()-1),Fl(i,a)}return Fl(s,a)}function ky(t){const s=new Date,a=Intl.DateTimeFormat().resolvedOptions().timeZone,r=parseInt(new Intl.DateTimeFormat("en-US",{hour:"numeric",hour12:!1,timeZone:a}).format(s)),i=new Intl.DateTimeFormat("en-US",{weekday:"short",timeZone:a});let o=s;r<Nm&&(o=new Date(s),o.setDate(o.getDate()-1));const l=i.format(o);return{Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6}[l]??0}function Fl(t,s){return new Intl.DateTimeFormat("en-CA",{year:"numeric",month:"2-digit",day:"2-digit",timeZone:s}).format(t)}function Cy(){return Intl.DateTimeFormat().resolvedOptions().timeZone}const Ri=[0,250,750,1500],Sy=4e3,Cm=n.createContext(void 0),Ey=t=>new Promise(s=>{window.setTimeout(s,t)}),Ty=({children:t})=>{const s=Ie(),[a,r]=n.useState(null),[i,o]=n.useState(null),[l,c]=n.useState("loading"),d=n.useRef(null),u=n.useRef("loading"),p=n.useRef(null),h=n.useRef(null),f=n.useRef(0);n.useEffect(()=>{d.current=i},[i]),n.useEffect(()=>{u.current=l},[l]);const m=n.useCallback((S,N)=>{o(S),r(S?.user??null),c(N??(S?.user?"authenticated":"unauthenticated"))},[]),g=n.useCallback(async S=>{try{const N=Cy();await k.from("profiles").update({timezone:N}).eq("id",S)}catch(N){console.error("Failed to save timezone:",N)}},[]),y=n.useCallback(async()=>{await s.refetchQueries({queryKey:["profile"]}),await Promise.all([s.invalidateQueries({queryKey:["mentor-page-data"]}),s.invalidateQueries({queryKey:["mentor-personality"]}),s.invalidateQueries({queryKey:["mentor"]}),s.invalidateQueries({queryKey:["selected-mentor"]})])},[s]),b=n.useCallback(async()=>{s.clear(),ko.removeItem("initialRouteRedirected");try{await k.removeAllChannels()}catch(S){console.error("Failed to remove realtime channels:",S)}},[s]),w=n.useCallback(async()=>{if(p.current)return p.current;const S=d.current;c(D=>D==="loading"?"loading":"recovering");const N=(async()=>{let D=null,R,_=!1;for(let C=0;C<Ri.length;C+=1){const E=Ri[C];E>0&&await Ey(E);const{data:{session:O},error:M}=await k.auth.getSession();if(M){D=M;continue}if(_=!0,R=O??null,O?.user||!S?.user||C>=Ri.length-1)break}if(R?.user){m(R,"authenticated"),g(R.user.id);return}if(_){m(null,"unauthenticated");return}if(console.error("Failed to refresh session:",D),S?.user){c("recovering");return}m(null,"unauthenticated")})().finally(()=>{p.current=null});return p.current=N,N},[m,g]),x=n.useCallback(async()=>{if(h.current)return h.current;const S=(async()=>{let N=null;try{await k.auth.signOut()}catch(D){N=D}if(await b(),m(null,"unauthenticated"),N)throw console.error("Sign out error:",N),N})().finally(()=>{h.current=null});return h.current=S,S},[m,b]);n.useEffect(()=>{w()},[w]),n.useEffect(()=>{const{data:{subscription:S}}=k.auth.onAuthStateChange((N,D)=>{m(D,D?.user?"authenticated":"unauthenticated"),D?.user&&(N==="SIGNED_IN"||N==="TOKEN_REFRESHED"||N==="INITIAL_SESSION")&&g(D.user.id),(N==="SIGNED_IN"||N==="TOKEN_REFRESHED")&&setTimeout(()=>{y().catch(R=>{console.error("Auth sync refresh failed:",R)})},0),N==="SIGNED_OUT"&&b()});return()=>{S.unsubscribe()}},[m,b,g,y]);const v=n.useCallback(()=>{if(u.current==="loading"||u.current==="unauthenticated")return;const S=Date.now();S-f.current<Sy||(f.current=S,w())},[w]);n.useEffect(()=>{if(!Ze.isNativePlatform())return;let S=!1,N=null;return(async()=>{const R=await tr.addListener("appStateChange",({isActive:_})=>{_&&v()});if(S){await R.remove();return}N=R})(),()=>{S=!0,N&&N.remove()}},[v]),n.useEffect(()=>{if(Ze.isNativePlatform())return;const S=()=>{document.visibilityState==="visible"&&v()};return document.addEventListener("visibilitychange",S),()=>document.removeEventListener("visibilitychange",S)},[v]);const j=l==="loading"||l==="recovering",T=n.useMemo(()=>({user:a,session:i,status:l,loading:j,signOut:x,refreshSession:w}),[j,w,i,x,l,a]);return n.createElement(Cm.Provider,{value:T},t)},_e=()=>{const t=n.useContext(Cm);if(!t)throw new Error("useAuth must be used within AuthProvider");return t},My=5,ni=()=>{const{user:t}=_e(),{data:s,isLoading:a}=Ee({queryKey:["companion-care-signals",t?.id],queryFn:async()=>{if(!t?.id)return null;const{data:i,error:o}=await k.from("user_companion").select(`
          care_consistency,
          care_responsiveness,
          care_balance,
          care_intent,
          care_recovery,
          care_pattern,
          evolution_path,
          evolution_path_locked,
          path_determination_date,
          dormant_since,
          dormancy_count,
          dormancy_recovery_days,
          inactive_days,
          bond_level,
          total_interactions,
          last_interaction_at
        `).eq("user_id",t.id).maybeSingle();if(o)throw console.error("Failed to fetch care signals:",o),o;return i},enabled:!!t?.id,staleTime:6e4});return{care:n.useMemo(()=>{const i={consistency:s?.care_consistency??.5,responsiveness:s?.care_responsiveness??.5,balance:s?.care_balance??.5,intent:s?.care_intent??.5,recovery:s?.care_recovery??.5},o=i.consistency*.3+i.responsiveness*.15+i.balance*.2+i.intent*.2+i.recovery*.15,l={path:s?.evolution_path??null,isLocked:s?.evolution_path_locked??!1,determinedAt:s?.path_determination_date??null},c=s?.dormant_since,d=!!c,u=s?.dormancy_recovery_days??0,p=s?.inactive_days??0,m=!d&&p>=5?Math.max(1,7-p):null,g={isDormant:d,dormantSince:c??null,dormancyCount:s?.dormancy_count??0,recoveryDays:u,daysUntilWake:d?Math.max(0,My-u):0,inactiveDays:p,daysUntilDormancy:m},y={level:s?.bond_level??0,totalInteractions:s?.total_interactions??0,lastInteractionAt:s?.last_interaction_at??null},w=s?.care_pattern?.dormancy_warning===!0;let x="content";return d?x="silent":o>.8?x="joyful":o>.6?x="content":o>.4?x="neutral":o>.2?x="reserved":x="quiet",{careSignals:i,overallCare:o,evolutionPath:l,dormancy:g,bond:y,hasDormancyWarning:w,dialogueTone:x}},[s]),isLoading:a}},Dy=t=>{switch(t){case"steady_guardian":return{name:"Steady Guardian",description:"Your consistent care has shaped a calm, protective companion.",icon:"ðŸ›¡ï¸",color:"text-amber-400",bgColor:"bg-amber-500/10",borderColor:"border-amber-500/30"};case"volatile_ascendant":return{name:"Volatile Ascendant",description:"Your intense but erratic energy has forged a powerful, passionate companion.",icon:"âš¡",color:"text-purple-400",bgColor:"bg-purple-500/10",borderColor:"border-purple-500/30"};case"neglected_wanderer":return{name:"Neglected Wanderer",description:"Time apart has made your companion independent but distant.",icon:"ðŸŒ™",color:"text-slate-400",bgColor:"bg-slate-500/10",borderColor:"border-slate-500/30"};case"balanced_architect":return{name:"Balanced Architect",description:"Perfect harmony in your care has awakened a rare, transcendent form.",icon:"âœ¨",color:"text-cyan-400",bgColor:"bg-cyan-500/10",borderColor:"border-cyan-500/30"};default:return{name:"Forming",description:"Your care patterns are still being observed...",icon:"ðŸŒ€",color:"text-muted-foreground",bgColor:"bg-muted/10",borderColor:"border-muted/30"}}},Sm={mood:"neutral",auraHue:45,auraOpacity:0,particleEffect:"none",particleCount:0,pulseRate:1,isPresent:!1,evolutionPath:null,needsAttention:!1,overallCare:.5},Em=n.createContext({presence:Sm,isLoading:!0}),Ay={steady_guardian:45,volatile_ascendant:280,neglected_wanderer:210,balanced_architect:180},Py={joyful:{particleEffect:"sparkle",particleCount:[6,8],opacity:[.04,.06]},content:{particleEffect:"gentle",particleCount:[4,6],opacity:[.03,.05]},neutral:{particleEffect:"gentle",particleCount:[3,4],opacity:[.02,.03]},reserved:{particleEffect:"minimal",particleCount:[2,3],opacity:[.01,.02]},quiet:{particleEffect:"minimal",particleCount:[1,2],opacity:[.005,.01]},dormant:{particleEffect:"none",particleCount:[0,0],opacity:[0,0]}},Tm=n.memo(({children:t})=>{const{user:s}=_e(),{care:a,isLoading:r}=ni(),i=n.useMemo(()=>{if(!s||r)return Sm;const{overallCare:l,evolutionPath:c,dormancy:d,hasDormancyWarning:u,dialogueTone:p}=a,h=["joyful","content","neutral","reserved","quiet","dormant"],f=p,m=d.isDormant?"dormant":h.includes(f)?f:"neutral",g=c.path?Ay[c.path]??45:45,y=Py[m],[b,w]=y.opacity,x=b+(w-b)*l,[v,j]=y.particleCount,T=Math.round(v+(j-v)*l),S=.7+l*.6;return{mood:m,auraHue:g,auraOpacity:x,particleEffect:y.particleEffect,particleCount:T,pulseRate:S,isPresent:!d.isDormant,evolutionPath:c.path,needsAttention:u||l<.3,overallCare:l}},[s,r,a]),o=n.useMemo(()=>({presence:i,isLoading:r}),[i,r]);return e.jsx(Em.Provider,{value:o,children:t})});Tm.displayName="CompanionPresenceProvider";const ii=()=>{const t=n.useContext(Em);if(!t)throw new Error("useCompanionPresence must be used within CompanionPresenceProvider");return t},$l=t=>{try{if(t.startsWith("cosmiq://task/"))return{type:"task",taskId:t.replace("cosmiq://task/","").split("?")[0],rawUrl:t};if(t.startsWith("cosmiq://calendar/oauth/callback")){const s=new URL(t),a=s.searchParams.get("provider"),r=s.searchParams.get("status"),i=s.searchParams.get("message")??void 0;return{type:"calendar_oauth",provider:a==="google"||a==="outlook"?a:void 0,status:r==="success"||r==="error"?r:void 0,message:i,rawUrl:t}}return{type:"unknown",rawUrl:t}}catch(s){return ue.error("[DeepLink] Failed to parse URL:",s),{type:"unknown",rawUrl:t}}},Ry=t=>{if(!Ze.isNativePlatform())return()=>{};let s=null;return tr.getLaunchUrl().then(a=>{if(a?.url){ue.log("[DeepLink] App launched with URL:",a.url);const r=$l(a.url);t(r)}}),tr.addListener("appUrlOpen",a=>{ue.log("[DeepLink] App URL opened:",a.url);const r=$l(a.url);t(r)}).then(a=>{s=a}),()=>{s?.remove()}},Mm=n.createContext({pendingTaskId:null,clearPendingTask:()=>{}}),Iy=()=>n.useContext(Mm),qy=({children:t})=>{const[s,a]=n.useState(null),r=n.useCallback(o=>{if(ue.log("[DeepLinkProvider] Received deep link:",o),o.type==="task"&&o.taskId){a(o.taskId),window.dispatchEvent(new CustomEvent("deep-link-navigation",{detail:{path:"/journeys",taskId:o.taskId}}));return}if(o.type==="calendar_oauth"&&o.provider&&o.status){const l=new URLSearchParams({calendar_oauth_provider:o.provider,calendar_oauth_status:o.status});o.message&&l.set("calendar_oauth_message",o.message),window.dispatchEvent(new CustomEvent("deep-link-navigation",{detail:{path:`/profile?${l.toString()}`}}))}},[]),i=n.useCallback(()=>{a(null)},[]);return n.useEffect(()=>Ry(r),[r]),e.jsx(Mm.Provider,{value:{pendingTaskId:s,clearPendingTask:i},children:t})},ss=()=>{const{user:t}=_e(),{data:s,isLoading:a,error:r,refetch:i}=Ee({queryKey:["profile",t?.id],queryFn:async()=>{if(!t)return null;const{data:o,error:l}=await k.from("profiles").select("*").eq("id",t.id).maybeSingle();if(l)throw console.error("Error fetching profile:",l),l;if(!o){const{data:c,error:d}=await k.from("profiles").upsert({id:t.id,email:t.email??null},{onConflict:"id",ignoreDuplicates:!1}).select("*").maybeSingle();if(d)throw console.error("Error creating profile:",d),d;if(!c)throw new Error("Failed to create profile");return c}return o},enabled:!!t,staleTime:120*1e3,refetchOnWindowFocus:!1});return{profile:s??null,loading:a,error:r,refetch:i}},Ly=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i,Dm=t=>typeof t=="object"&&t!==null&&!Array.isArray(t),Am=t=>{if(!t||!Dm(t.onboarding_data))return null;const s=t.onboarding_data.mentorId;if(typeof s!="string")return null;const a=s.trim();return a&&Ly.test(a)?a:null},Oy=t=>{if(!Dm(t))return{};const{mentorId:s,...a}=t;return a},Fy=t=>{if(!t)return!1;if(t.code==="23503")return!0;const s=`${t.message??""} ${t.details??""}`.toLowerCase();return s.includes("profiles_selected_mentor_id_fkey")||s.includes("foreign key")},ur=t=>{if(!t)return null;if(t.selected_mentor_id)return t.selected_mentor_id;const s=Am(t);return!s||t.onboarding_completed===!0?null:s},$y=["active","cancelled","past_due","trialing","incomplete"],By=["monthly","yearly"];function Bl(t){return typeof t=="string"&&$y.includes(t)}function Ul(t){return typeof t=="string"&&By.includes(t)}function Uy(){const{user:t,loading:s}=_e(),{data:a,isLoading:r,error:i,refetch:o}=Ee({queryKey:["subscription",t?.id],queryFn:async()=>{if(!t)return null;const{data:f,error:m}=await k.functions.invoke("check-apple-subscription");if(m)throw m;return f},enabled:!!t,staleTime:300*1e3,refetchInterval:!1}),l=s||!!t&&r,c=n.useMemo(()=>{if(!a||!a.subscribed)return null;const f=Bl(a.status)?a.status:"incomplete",m=Ul(a.plan)?a.plan:"monthly";return Bl(a.status)||ue.warn(`Unexpected subscription status: ${a.status}`),a.plan&&!Ul(a.plan)&&ue.warn(`Unexpected subscription plan: ${a.plan}`),{status:f,plan:m,current_period_end:a.subscription_end}},[a]),d=a?.subscribed||!1,u=c?.status==="cancelled",p=n.useMemo(()=>c?.current_period_end?new Date(c.current_period_end):null,[c?.current_period_end]),h=n.useMemo(()=>c?.plan==="yearly"?"$59.99/year":"$9.99/month",[c?.plan]);return{subscription:c,isLoading:l,error:i,refetch:o,isActive:d,isCancelled:u,hasPremium:d,nextBillingDate:p,planPrice:h,plan:c?.plan}}const So=t=>typeof t=="object"&&t!==null&&!Array.isArray(t),Hy=t=>{if(!So(t))return!1;const s=t.guided_tutorial;return So(s)?s.completed===!0:!1},zy=t=>{if(typeof window>"u"||typeof t!="string"||t.length===0)return!1;try{const s=window.localStorage;if(!s||typeof s.getItem!="function")return!1;const a=s.getItem(`guided_tutorial_progress_${t}`);if(!a)return!1;const r=JSON.parse(a);return So(r)?r.completed===!0:!1}catch{return!1}};function Ky(){const{profile:t,loading:s}=ss(),{isActive:a,isLoading:r}=Uy();if(s||r)return{hasAccess:!0,isSubscribed:!1,isInTrial:!1,trialExpired:!1,trialDaysRemaining:0,accessSource:"none",gateReason:"none",trialEndsAt:null,loading:!0};if(!t)return{hasAccess:!0,isSubscribed:a,isInTrial:!1,trialExpired:!1,trialDaysRemaining:0,accessSource:a?"subscription":"none",gateReason:"none",trialEndsAt:null,loading:!1};const o=Hy(t.onboarding_data)||zy(t.id),l=!!(t.trial_started_at||t.trial_ends_at);let c=null;t.trial_ends_at?c=new Date(t.trial_ends_at):l&&t.created_at&&(c=new Date(new Date(t.created_at).getTime()+10080*60*1e3));const d=new Date,u=l&&c?d>c:!1,p=l&&c?d<=c:l;let h=0;if(p&&c){const b=c.getTime()-d.getTime();h=Math.max(0,Math.ceil(b/(1e3*60*60*24)))}const f=!a&&o;let m=!0,g="none",y="none";return a?(g="subscription",m=!0):f?(m=!1,y="pre_trial_signup"):p?(g="trial",m=!0):u&&(m=!1,y="trial_expired"),{hasAccess:m,isSubscribed:a,isInTrial:p&&!a,trialExpired:u&&!a,trialDaysRemaining:a?0:h,accessSource:g,gateReason:y,trialEndsAt:c,loading:!1}}const Ys=n.forwardRef(({className:t,value:s,...a},r)=>e.jsx(Gd,{ref:r,className:I("relative h-2 w-full overflow-hidden rounded-full bg-secondary/50",t),...a,children:e.jsx(Wf,{className:"h-full w-full flex-1 bg-gradient-to-r from-primary to-accent transition-all duration-500 ease-out shadow-glow",style:{transform:`translateX(-${100-(s||0)}%)`}})}));Ys.displayName=Gd.displayName;const Br=dr("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-[14px] text-sm font-semibold ring-offset-background transition-colors duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 active:scale-[0.985]",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-[0_10px_20px_hsl(var(--primary)/0.28)] hover:bg-primary/92 active:bg-primary/88",destructive:"bg-destructive text-destructive-foreground shadow-[0_10px_20px_hsl(var(--destructive)/0.25)] hover:bg-destructive/92 active:bg-destructive/88",outline:"border border-border/70 bg-card/70 text-foreground hover:bg-card/90",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/85",ghost:"text-foreground/85 hover:bg-foreground/5 hover:text-foreground",link:"text-royal-purple underline-offset-4 hover:underline",cta:"bg-gradient-to-r from-royal-purple via-accent-purple to-nebula-pink text-pure-white shadow-[0_12px_24px_hsl(var(--royal-purple)/0.32)] hover:brightness-105",gradient:"bg-gradient-to-r from-primary to-accent text-pure-white shadow-[0_12px_24px_hsl(var(--primary)/0.25)] hover:brightness-105",accent:"bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-[0_10px_20px_hsl(28_96%_56%/0.3)] hover:brightness-105"},size:{default:"h-11 px-4",sm:"h-9 rounded-[12px] px-3 text-xs",lg:"h-12 rounded-[16px] px-6 text-base",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),z=n.forwardRef(({className:t,variant:s,size:a,asChild:r=!1,...i},o)=>{const l=r?Gf:"button";return e.jsx(l,{className:I(Br({variant:s,size:a,className:t})),ref:o,...i})});z.displayName="Button";const Xe=n.forwardRef(({className:t,...s},a)=>e.jsx("div",{ref:a,className:I("rounded-2xl border text-card-foreground","bg-card/78 backdrop-blur-lg","border-border/60","shadow-[0_12px_28px_rgba(0,0,0,0.22)]","transition-colors duration-200",t),...s}));Xe.displayName="Card";const Qy=n.forwardRef(({className:t,...s},a)=>e.jsx("div",{ref:a,className:I("flex flex-col space-y-1.5 p-4 sm:p-6",t),...s}));Qy.displayName="CardHeader";const Wy=n.forwardRef(({className:t,...s},a)=>e.jsx("h3",{ref:a,className:I("text-xl sm:text-2xl font-semibold leading-none tracking-tight",t),...s}));Wy.displayName="CardTitle";const Gy=n.forwardRef(({className:t,...s},a)=>e.jsx("p",{ref:a,className:I("text-sm text-muted-foreground",t),...s}));Gy.displayName="CardDescription";const tl=n.forwardRef(({className:t,...s},a)=>e.jsx("div",{ref:a,className:I("p-4 sm:p-6 pt-0",t),...s}));tl.displayName="CardContent";const Yy=n.forwardRef(({className:t,...s},a)=>e.jsx("div",{ref:a,className:I("flex items-center p-4 sm:p-6 pt-0",t),...s}));Yy.displayName="CardFooter";const ea={MONTHLY:"cosmiq_premium_monthly",YEARLY:"cosmiq_premium_yearly"},xs=()=>Ze.isNativePlatform()&&Ze.getPlatform()==="ios",Vy=async t=>{if(!xs())throw new Error("In-App Purchases are only available on iOS");try{return await Gn.purchaseProduct({productIdentifier:t})}catch(s){throw console.error("Purchase failed:",s),s}},Xy=async()=>{if(!xs())throw new Error("In-App Purchases are only available on iOS");try{return(await Gn.restorePurchases())?.purchases||[]}catch(t){throw console.error("Restore failed:",t),t}},Jy=async t=>{if(console.log("[IAP DEBUG] getProducts called with:",t),console.log("[IAP DEBUG] isIAPAvailable:",xs()),console.log("[IAP DEBUG] Platform:",Ze.getPlatform()),console.log("[IAP DEBUG] isNative:",Ze.isNativePlatform()),!xs())return console.log("[IAP DEBUG] IAP not available, returning empty array"),[];try{console.log("[IAP DEBUG] Calling NativePurchases.getProducts...");const s=await Gn.getProducts({productIdentifiers:t});console.log("[IAP DEBUG] Raw result from NativePurchases:",JSON.stringify(s,null,2));const a=s?.products||[];return console.log("[IAP DEBUG] Parsed products count:",a.length),console.log("[IAP DEBUG] Parsed products:",JSON.stringify(a,null,2)),a}catch(s){return console.error("[IAP DEBUG] Get products failed:",s),console.error("[IAP DEBUG] Error details:",JSON.stringify(s,Object.getOwnPropertyNames(s))),[]}},Zy=async()=>{if(xs()){await Gn.manageSubscriptions();return}window.open("https://apps.apple.com/account/subscriptions","_blank")},Hl="Premium subscriptions are temporarily unavailable. Please try again later.";function e0(){const t=Ie(),{toast:s}=_s(),[a,r]=n.useState(!1),[i,o]=n.useState([]),[l,c]=n.useState(!1),[d,u]=n.useState(null),[p,h]=n.useState(!1),[f,m]=n.useState(!1),g=n.useCallback(async()=>{if(console.log("[HOOK DEBUG] fetchProducts called"),console.log("[HOOK DEBUG] IAP_PRODUCTS:",JSON.stringify(ea)),console.log("[HOOK DEBUG] isIAPAvailable:",xs()),!xs())return console.log("[HOOK DEBUG] IAP not available, setting error"),o([]),u("In-App Purchases are only available on iOS devices"),h(!0),[];c(!0),u(null);try{console.log("[HOOK DEBUG] About to call getProducts...");const v=await Jy(Object.values(ea));if(console.log("[HOOK DEBUG] getProducts returned:",v.length,"products"),console.log("[HOOK DEBUG] Products:",JSON.stringify(v)),!v.length)throw console.log("[HOOK DEBUG] No products returned, throwing error"),new Error("No App Store products were returned");return o(v),console.log("[HOOK DEBUG] Products set successfully"),v}catch(v){return console.error("[HOOK DEBUG] Product load error:",v),o([]),u(Hl),[]}finally{c(!1),h(!0),console.log("[HOOK DEBUG] fetchProducts complete")}},[]);n.useEffect(()=>{g()},[g]);const y=n.useCallback(async()=>{if(console.log("[ENSURE DEBUG] ensureProductsAvailable called"),console.log("[ENSURE DEBUG] hasAttemptedProductFetch:",p),console.log("[ENSURE DEBUG] products.length:",i.length),!p||i.length===0){console.log("[ENSURE DEBUG] Condition met - calling fetchProducts()");const v=await g();console.log("[ENSURE DEBUG] fetchProducts returned:",v.length,"products");const j=v.length?v:null;return console.log("[ENSURE DEBUG] Returning:",j?"products":"NULL"),j}return console.log("[ENSURE DEBUG] Using existing products:",i.length),i},[g,p,i]);return{handlePurchase:async v=>{if(console.log("[PURCHASE DEBUG] ========== handlePurchase START =========="),console.log("[PURCHASE DEBUG] productId:",v),console.log("[PURCHASE DEBUG] isIAPAvailable():",xs()),console.log("[PURCHASE DEBUG] Current products state:",i.length),console.log("[PURCHASE DEBUG] hasAttemptedProductFetch:",p),!xs())return console.log("[PURCHASE DEBUG] IAP not available - returning false"),s({title:"Not Available",description:"In-App Purchases are only available on iOS devices",variant:"destructive"}),!1;if(typeof navigator<"u"&&!navigator.onLine)return s({title:"Connection required",description:"This action requires a live connection. Try again when online.",variant:"destructive"}),!1;r(!0);try{console.log("[PURCHASE DEBUG] Calling ensureProductsAvailable...");const j=await y();if(console.log("[PURCHASE DEBUG] ensureProductsAvailable returned:",j?j.length+" products":"NULL"),!j)return s({title:"Unavailable",description:Hl,variant:"destructive"}),!1;console.log("[HOOK DEBUG] Checking productId:",v),console.log("[HOOK DEBUG] Available identifiers:",j.map(_=>_.identifier));const T=j.some(_=>_.identifier===v);if(console.log("[HOOK DEBUG] productExists result:",T),!T)return s({title:"Unavailable",description:"Selected premium plan is not ready yet. Please try again in a moment.",variant:"destructive"}),!1;const S=await Vy(v);if(console.log("[IAP] Purchase response:",JSON.stringify(S,null,2)),!S)throw new Error("Purchase returned no data");const N=S.transactionId,D=S.receipt??S.transactionReceipt;if(console.log("[IAP] Verification payload:",{transactionId:!!N,receipt:!!D}),!N&&!D)throw new Error("No transaction ID or receipt data available");const{error:R}=await k.functions.invoke("verify-apple-receipt",{body:N?{transactionId:N}:{receipt:D}});if(R)throw R;return await t.invalidateQueries({queryKey:["subscription"]}),s({title:"Success!",description:"Your subscription is now active"}),!0}catch(j){console.error("Purchase error:",j);const T=j instanceof Error?j.message:"Please try again";return s({title:"Purchase Failed",description:T,variant:"destructive"}),!1}finally{r(!1)}},handleRestore:async()=>{if(!xs()){s({title:"Not Available",description:"In-App Purchases are only available on iOS devices",variant:"destructive"});return}if(typeof navigator<"u"&&!navigator.onLine){s({title:"Connection required",description:"This action requires a live connection. Try again when online.",variant:"destructive"});return}r(!0);try{const v=await Xy();if(!v||!Array.isArray(v)||v.length===0){s({title:"No Purchases Found",description:"No previous purchases to restore"});return}const j=_=>typeof _=="object"&&_!==null,S=[...v].filter(j).sort((_,C)=>{const E=_.transactionDate||0;return(C.transactionDate||0)-E}).find(_=>_.productId?.includes("premium"));if(!S){s({title:"No Subscription Found",description:"No active subscription to restore"});return}const N=S.transactionId,D=S.transactionReceipt??S.receipt;if(!N&&!D)throw new Error("No transaction ID or receipt data available for subscription");const{error:R}=await k.functions.invoke("verify-apple-receipt",{body:N?{transactionId:N}:{receipt:D}});if(R)throw R;await t.invalidateQueries({queryKey:["subscription"]}),s({title:"Restored!",description:"Your subscription has been restored"})}catch(v){console.error("Restore error:",v);const j=v instanceof Error?v.message:"Please try again";s({title:"Restore Failed",description:j,variant:"destructive"})}finally{r(!1)}},handleManageSubscriptions:async()=>{m(!0);try{await Zy(),s({title:"Manage Subscription",description:"Opening Apple's subscription settings..."})}catch(v){console.error("Manage subscription error:",v);const j=v instanceof Error?v.message:"Please try again";s({title:"Unable to open subscriptions",description:j,variant:"destructive"})}finally{m(!1)}},loading:a,manageLoading:f,products:i,productsLoading:l,productError:d,hasLoadedProducts:p,reloadProducts:g,isAvailable:xs()}}const mr=Vf,LT=Xf,t0=Yf,Pm=n.forwardRef(({className:t,...s},a)=>e.jsx(Yd,{className:I("fixed inset-0 z-[220] bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...s,ref:a}));Pm.displayName=Yd.displayName;const Ea=n.forwardRef(({className:t,...s},a)=>e.jsxs(t0,{children:[e.jsx(Pm,{}),e.jsx(Vd,{ref:a,className:I("fixed left-[50%] top-[50%] z-[221] grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",t),...s})]}));Ea.displayName=Vd.displayName;const Ta=({className:t,...s})=>e.jsx("div",{className:I("flex flex-col space-y-2 text-center sm:text-left",t),...s});Ta.displayName="AlertDialogHeader";const Ma=({className:t,...s})=>e.jsx("div",{className:I("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...s});Ma.displayName="AlertDialogFooter";const Da=n.forwardRef(({className:t,...s},a)=>e.jsx(Xd,{ref:a,className:I("text-lg font-semibold",t),...s}));Da.displayName=Xd.displayName;const Aa=n.forwardRef(({className:t,...s},a)=>e.jsx(Jd,{ref:a,className:I("text-sm text-muted-foreground",t),...s}));Aa.displayName=Jd.displayName;const la=n.forwardRef(({className:t,...s},a)=>e.jsx(Zd,{ref:a,className:I(Br(),t),...s}));la.displayName=Zd.displayName;const Pa=n.forwardRef(({className:t,...s},a)=>e.jsx(eu,{ref:a,className:I(Br({variant:"outline"}),"mt-2 sm:mt-0",t),...s}));Pa.displayName=eu.displayName;const mt=n.forwardRef(({className:t,type:s,...a},r)=>e.jsx("input",{type:s,className:I("flex h-11 sm:h-12 w-full rounded-lg border border-input bg-secondary/50 px-3 sm:px-4 py-2 text-sm sm:text-base font-medium text-foreground ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground/70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:border-primary disabled:cursor-not-allowed disabled:opacity-50 transition-all touch-manipulation",t),ref:r,...a}));mt.displayName="Input";const s0=({variant:t="pre_trial_signup"})=>{const[s,a]=n.useState("yearly"),[r,i]=n.useState(!1),[o,l]=n.useState(""),[c,d]=n.useState(!1),[u,p]=n.useState(!1),{handlePurchase:h,handleRestore:f,loading:m,isAvailable:g,products:y,productsLoading:b,productError:w,reloadProducts:x,hasLoadedProducts:v}=e0(),{toast:j}=_s(),{signOut:T}=_e(),S=ts(),N=n.useMemo(()=>y.reduce((A,L)=>(A[L.identifier]=L,A),{}),[y]),D=s==="yearly"?ea.YEARLY:ea.MONTHLY,R=N[D],_=async()=>{if(!R){j({title:"Almost ready",description:"We're still fetching Apple pricing details. Please try again in a moment.",variant:"destructive"});return}const A=s==="yearly"?ea.YEARLY:ea.MONTHLY;await h(A)},C=async()=>{p(!0);try{await T(),S("/auth")}catch{j({title:"Error",description:"Failed to sign out. Please try again.",variant:"destructive"})}finally{p(!1)}},E=async()=>{if(o!=="DELETE"){j({title:"Confirmation required",description:"Please type DELETE to confirm account deletion.",variant:"destructive"});return}d(!0);try{const{data:{session:A}}=await k.auth.getSession();if(!A?.access_token)throw new Error("No active session");const{error:L}=await k.functions.invoke("delete-user",{headers:{Authorization:`Bearer ${A.access_token}`}});if(L)throw L;await T(),S("/auth"),j({title:"Account deleted",description:"Your account has been permanently deleted."})}catch(A){console.error("Delete account error:",A),j({title:"Error",description:"Failed to delete account. Please try again.",variant:"destructive"})}finally{d(!1),i(!1),l("")}},O={monthly:{fallbackPrice:"$9.99",period:"/month",savings:null},yearly:{fallbackPrice:"$59.99",period:"/year",savings:"Save 50%"}},M=t==="trial_expired"?{title:"Your Free Trial Has Ended",subtitle:"Subscribe to keep building momentum with your companion",cta:`Subscribe ${s==="yearly"?"Yearly":"Monthly"}`,legalIntro:"Payment will be charged to your Apple ID account at confirmation of purchase."}:{title:"Keep Your Journey Going",subtitle:"Start your free trial to unlock premium guidance, quests, and companion growth",cta:"Start 7-Day Free Trial",legalIntro:"No charge today. Your Apple ID account will be charged when the free trial ends unless canceled at least 24 hours before the end of the trial."};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-background flex flex-col items-center justify-center px-6 pt-safe pb-safe overflow-y-auto",children:[e.jsxs("div",{className:"w-full max-w-md space-y-6",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-primary to-accent shadow-glow",children:e.jsx(Sl,{className:"h-10 w-10 text-primary-foreground"})}),e.jsx("h1",{className:"font-display text-3xl text-foreground",children:M.title}),e.jsx("p",{className:"text-muted-foreground",children:M.subtitle})]}),e.jsx("div",{className:"flex gap-3",children:["monthly","yearly"].map(A=>e.jsxs(Xe,{onClick:()=>a(A),className:I("flex-1 cursor-pointer transition-all relative overflow-hidden",s===A?"border-2 border-primary bg-primary/5 shadow-glow":"border border-border hover:border-primary/50"),children:[O[A].savings&&e.jsx("div",{className:"absolute top-0 right-0 bg-accent text-accent-foreground text-xs font-bold px-2 py-1 rounded-bl-lg",children:O[A].savings}),e.jsxs(tl,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground capitalize mb-1",children:A}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:(A==="yearly"?N[ea.YEARLY]?.priceString:N[ea.MONTHLY]?.priceString)??O[A].fallbackPrice}),e.jsx("p",{className:"text-xs text-muted-foreground",children:O[A].period})]})]},A))}),e.jsx("div",{className:"space-y-3 py-2",children:[{icon:be,text:"All 21 evolution stages"},{icon:zo,text:"Unlimited mentor chat"},{icon:Yn,text:"Unlimited Quests & Epics"},{icon:Sl,text:"All premium features"}].map((A,L)=>e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsx(A.icon,{className:"h-5 w-5 text-primary flex-shrink-0"}),e.jsx("span",{className:"text-foreground",children:A.text})]},L))}),!g&&e.jsx("div",{className:"bg-muted/30 rounded-lg p-4",children:e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"In-App Purchases are only available on iOS devices"})}),b&&e.jsxs("div",{className:"flex items-center gap-2 rounded-lg border border-dashed border-muted-foreground/30 px-3 py-2 text-sm text-muted-foreground",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-muted-foreground"}),"Contacting the App Store..."]}),w&&e.jsxs("div",{className:"rounded-lg border border-destructive/40 bg-destructive/5 p-3 text-sm text-destructive flex flex-col gap-2",children:[e.jsx("span",{children:w}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(z,{size:"sm",variant:"outline",onClick:()=>{x()},children:"Try Again"}),e.jsx(z,{size:"sm",variant:"ghost",onClick:()=>j({title:"Need help?",description:"Please ensure you're signed in to the App Store and retry."}),children:"Contact support"})]})]}),e.jsx(z,{onClick:_,disabled:m||!g||b||!v||!R,className:"w-full py-7 text-lg font-black uppercase tracking-wider bg-gradient-to-r from-primary to-accent hover:opacity-90 text-primary-foreground shadow-glow",size:"lg",children:m?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary-foreground mr-2"}),"Processing..."]}):M.cta}),e.jsxs(z,{variant:"ghost",onClick:f,disabled:m,className:"w-full text-muted-foreground hover:text-foreground",children:[e.jsx(wa,{className:"h-4 w-4 mr-2"}),"Restore Purchases"]}),e.jsx(z,{variant:"outline",onClick:()=>S("/promo-code"),className:"w-full",children:"Redeem Promo Code"}),e.jsx("p",{className:"text-xs text-center text-muted-foreground -mt-2",children:"Have a promo code? Redeem it to unlock access."}),e.jsxs("p",{className:"text-xs text-center text-muted-foreground leading-relaxed",children:[M.legalIntro,"Subscription automatically renews unless canceled at least 24 hours before the end of the current period. Your account will be charged for renewal within 24 hours prior to the end of the current period. You can manage and cancel your subscriptions by going to Settings ",">"," [Your Name] ",">"," Subscriptions after purchase."]}),e.jsxs("div",{className:"flex justify-center gap-4 text-xs",children:[e.jsx("a",{href:"/privacy",className:"text-muted-foreground underline hover:text-foreground",children:"Privacy Policy"}),e.jsx("a",{href:"/terms",className:"text-muted-foreground underline hover:text-foreground",children:"Terms of Use"})]}),e.jsxs("div",{className:"pt-1 text-center space-y-2",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Need another account?"}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(z,{variant:"link",size:"sm",onClick:C,disabled:u,className:"h-auto p-0 text-xs text-muted-foreground hover:text-foreground",children:u?"Signing out...":"Sign out"}),e.jsx("span",{className:"text-xs text-muted-foreground/60",children:"â€¢"}),e.jsx(z,{variant:"link",size:"sm",onClick:()=>i(!0),className:"h-auto p-0 text-xs text-muted-foreground hover:text-destructive",children:"Delete account"})]})]})]}),e.jsx(mr,{open:r,onOpenChange:i,children:e.jsxs(Ea,{children:[e.jsxs(Ta,{children:[e.jsx(Da,{children:"Delete your account?"}),e.jsxs(Aa,{className:"space-y-3",children:[e.jsx("p",{children:"This action is permanent and cannot be undone. All your data, including your companion, progress, and achievements will be permanently deleted."}),e.jsxs("p",{className:"font-medium text-foreground",children:["Type ",e.jsx("span",{className:"font-bold text-destructive",children:"DELETE"})," to confirm:"]}),e.jsx(mt,{value:o,onChange:A=>l(A.target.value),placeholder:"Type DELETE",className:"mt-2"})]})]}),e.jsxs(Ma,{children:[e.jsx(Pa,{disabled:c,children:"Cancel"}),e.jsx(la,{onClick:E,disabled:c||o!=="DELETE",className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2"}),"Deleting..."]}):"Delete Account"})]})]})})]})},jt=({children:t,requireMentor:s=!0,requireAccess:a=!0})=>{const{user:r,loading:i,status:o}=_e(),{hasAccess:l,gateReason:c,loading:d}=Ky(),u=ts(),[p,h]=n.useState(0),f=o??(i?"loading":r?"authenticated":"unauthenticated"),m=i||f==="recovering"||f==="loading";return n.useEffect(()=>{!m&&f==="unauthenticated"&&u("/welcome",{replace:!0})},[f,m,u]),n.useEffect(()=>{let g;return m||d?g=setInterval(()=>{h(y=>y>=90?y:y+Math.random()*15)},300):h(100),()=>{g&&clearInterval(g)}},[d,m]),m||d?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"w-full max-w-md px-8 space-y-4",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"h-12 w-12 mx-auto rounded-full border-4 border-primary border-t-transparent animate-spin"}),e.jsx("p",{className:"text-foreground",children:"Loading..."})]}),e.jsx(Ys,{value:p,className:"w-full"})]})}):f==="unauthenticated"||!r?null:a&&!l?e.jsx(s0,{variant:c==="trial_expired"?"trial_expired":"pre_trial_signup"}):e.jsx(e.Fragment,{children:t})};class ls extends n.Component{constructor(s){super(s),this.state={hasError:!1,error:null}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,a){console.error("ErrorBoundary caught an error:",s,a)}handleReset=()=>{this.setState({hasError:!1,error:null}),window.location.href="/"};render(){return this.state.hasError?this.props.fallback?this.props.fallback:e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-b from-background to-muted/20 p-4",children:e.jsxs(Xe,{className:"max-w-md w-full p-8 text-center",children:[e.jsx(ca,{className:"h-16 w-16 text-destructive mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-heading font-bold text-foreground mb-2",children:"Something went wrong"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"We encountered an unexpected error. Don't worry, your data is safe."}),this.state.error&&e.jsxs("details",{className:"mb-6 text-left",children:[e.jsx("summary",{className:"cursor-pointer text-sm text-muted-foreground mb-2",children:"Technical details"}),e.jsx("pre",{className:"text-xs bg-muted p-3 rounded overflow-auto max-h-32",children:this.state.error.toString()})]}),e.jsx(z,{onClick:this.handleReset,className:"w-full",children:"Return to Home"})]})}):this.props.children}}const Rm=({error:t,resetError:s,title:a="Something went wrong",description:r="We encountered an error loading this component."})=>e.jsx(Xe,{className:"p-6 border-destructive/50 bg-destructive/5",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:"rounded-full bg-destructive/10 p-3",children:e.jsx(Ca,{className:"h-6 w-6 text-destructive"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:a}),e.jsx("p",{className:"text-sm text-muted-foreground max-w-md",children:r}),t&&e.jsxs("details",{className:"text-xs text-left mt-4",children:[e.jsx("summary",{className:"cursor-pointer text-muted-foreground hover:text-foreground",children:"Technical details"}),e.jsx("pre",{className:"mt-2 p-2 bg-muted rounded text-left overflow-auto max-w-md",children:t.message})]})]}),e.jsxs("div",{className:"flex gap-2",children:[s&&e.jsxs(z,{onClick:s,variant:"outline",size:"sm",children:[e.jsx(wa,{className:"h-4 w-4 mr-2"}),"Try Again"]}),e.jsx(z,{onClick:()=>window.location.reload(),variant:"default",size:"sm",children:"Reload Page"})]})]})}),a0=({error:t,resetError:s})=>e.jsx(Rm,{error:t,resetError:s,title:"Missions Unavailable",description:"We couldn't load your daily missions. Don't worry, your progress is safe."}),r0=({error:t,onClose:s})=>e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-background/95 backdrop-blur-sm",children:e.jsx(Xe,{className:"p-8 max-w-md mx-4 border-destructive/50 bg-card",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:"rounded-full bg-destructive/10 p-4",children:e.jsx(Ca,{className:"h-8 w-8 text-destructive"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-bold text-xl",children:"Evolution Error"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"We encountered an issue during evolution. Your companion's progress has been saved."}),t&&e.jsxs("details",{className:"text-xs text-left mt-4",children:[e.jsx("summary",{className:"cursor-pointer text-muted-foreground hover:text-foreground",children:"Technical details"}),e.jsx("pre",{className:"mt-2 p-2 bg-muted rounded text-left overflow-auto",children:t.message})]})]}),e.jsx(z,{onClick:s||(()=>window.location.reload()),size:"lg",className:"w-full",children:"Close"})]})})}),n0=({error:t,resetError:s})=>e.jsx(Rm,{error:t,resetError:s,title:"Check-in Unavailable",description:"We couldn't load the check-in form. Please try again in a moment."}),zl={Fire:{name:"Inferno",glowA:"20, 100%, 55%",glowB:"35, 100%, 60%",particleStyle:"embers",confettiColors:["#FF6A3D","#FF9F1C","#FFD700","#FF4500"],confettiSpread:100,confettiGravity:.8,confettiParticleCount:150},Water:{name:"Tidal",glowA:"195, 90%, 55%",glowB:"210, 85%, 50%",particleStyle:"bubbles",confettiColors:["#4FC3F7","#29B6F6","#81D4FA","#B3E5FC"],confettiSpread:140,confettiGravity:.4,confettiParticleCount:120},Earth:{name:"Terran",glowA:"25, 40%, 45%",glowB:"100, 50%, 45%",particleStyle:"leaves",confettiColors:["#795548","#8BC34A","#4CAF50","#A1887F"],confettiSpread:90,confettiGravity:.9,confettiParticleCount:130},Air:{name:"Zephyr",glowA:"200, 80%, 80%",glowB:"190, 70%, 90%",particleStyle:"stardust",confettiColors:["#E3F2FD","#BBDEFB","#90CAF9","#E8F5E9"],confettiSpread:180,confettiGravity:.3,confettiParticleCount:100},Lightning:{name:"Storm",glowA:"50, 100%, 55%",glowB:"270, 70%, 60%",particleStyle:"sparks",confettiColors:["#FFD600","#FFFF00","#7C4DFF","#B388FF"],confettiSpread:120,confettiGravity:1,confettiParticleCount:160},Ice:{name:"Frost",glowA:"185, 70%, 70%",glowB:"190, 50%, 92%",particleStyle:"stardust",confettiColors:["#80DEEA","#B2EBF2","#E0F7FA","#FFFFFF"],confettiSpread:100,confettiGravity:.5,confettiParticleCount:130},Nature:{name:"Verdant",glowA:"120, 50%, 50%",glowB:"100, 50%, 70%",particleStyle:"leaves",confettiColors:["#66BB6A","#81C784","#A5D6A7","#DCEDC8"],confettiSpread:110,confettiGravity:.6,confettiParticleCount:140},Light:{name:"Radiant",glowA:"50, 100%, 75%",glowB:"0, 0%, 100%",particleStyle:"stardust",confettiColors:["#FFF59D","#FFEE58","#FFFFFF","#FFF9C4"],confettiSpread:150,confettiGravity:.4,confettiParticleCount:160},Shadow:{name:"Umbral",glowA:"270, 50%, 50%",glowB:"260, 60%, 25%",particleStyle:"sparks",confettiColors:["#7E57C2","#5E35B1","#9575CD","#D1C4E9"],confettiSpread:80,confettiGravity:.7,confettiParticleCount:120},Cosmic:{name:"Celestial",glowA:"285, 60%, 55%",glowB:"230, 50%, 40%",particleStyle:"stardust",confettiColors:["#AB47BC","#CE93D8","#5C6BC0","#7986CB"],confettiSpread:160,confettiGravity:.35,confettiParticleCount:180}},i0={name:"Hatch",glowA:"45, 100%, 60%",glowB:"35, 100%, 70%",particleStyle:"stardust",confettiColors:["#FFD700","#FFA500","#FFFACD","#FFE4B5","#F0E68C"],confettiSpread:140,confettiGravity:.6,confettiParticleCount:200},o0={name:"Cosmic",glowA:"270, 70%, 55%",glowB:"280, 80%, 65%",particleStyle:"stardust",confettiColors:["#A76CFF","#C084FC","#E879F9","#FFD700"],confettiSpread:120,confettiGravity:.6,confettiParticleCount:150},l0=(t,s)=>s?i0:t&&zl[t]?zl[t]:o0,$a=ue.scope("CompanionEvolution"),c0=({phase:t,particleStyle:s})=>{const a=n.useMemo(()=>Array.from({length:12},(r,i)=>({id:i,angle:i/12*Math.PI*2,startRadius:180})),[]);return t==="settle"?null:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:a.map(r=>e.jsx(P.div,{className:`absolute w-2 h-2 evo-particle evo-particle-${s}`,initial:{x:Math.cos(r.angle)*r.startRadius,y:Math.sin(r.angle)*r.startRadius,opacity:.3,scale:1},animate:{x:t==="impact"?0:Math.cos(r.angle)*60,y:t==="impact"?0:Math.sin(r.angle)*60,opacity:t==="impact"?0:.7,scale:t==="impact"?.2:.8},transition:{duration:t==="impact"?.6:1.2,ease:[.25,.1,.25,1]}},r.id))})},d0=({phase:t,show:s})=>{if(!s)return null;const a=t==="anticipation"||t==="impact",r=t==="impact";return e.jsxs("div",{className:"absolute inset-0 pointer-events-none z-10 flex items-center justify-center",children:[e.jsx(P.div,{className:"absolute inset-0",initial:{opacity:.6},animate:{opacity:t==="reveal"||t==="settle"?0:.4},transition:{duration:.5},style:{background:"radial-gradient(ellipse 60% 70% at 50% 50%, transparent 40%, hsl(45, 50%, 15%) 100%)"}}),e.jsxs("svg",{className:"absolute w-full h-full",viewBox:"0 0 400 400",preserveAspectRatio:"xMidYMid slice",children:[e.jsx(P.path,{d:"M200 100 L210 150 L195 180 L205 220 L190 280",fill:"none",stroke:"hsl(50, 100%, 80%)",strokeWidth:"3",className:a?"evo-crack-path drawing":"evo-crack-path",initial:{opacity:0},animate:{opacity:a?1:0},style:{filter:"drop-shadow(0 0 8px hsl(50, 100%, 70%))"}}),e.jsx(P.path,{d:"M200 100 L185 155 L200 190 L180 240 L195 300",fill:"none",stroke:"hsl(50, 100%, 80%)",strokeWidth:"2",className:a?"evo-crack-path drawing delay-100":"evo-crack-path",initial:{opacity:0},animate:{opacity:a?1:0},style:{filter:"drop-shadow(0 0 6px hsl(50, 100%, 70%))"}}),e.jsx(P.path,{d:"M200 100 L220 140 L210 200 L230 260",fill:"none",stroke:"hsl(50, 100%, 80%)",strokeWidth:"2",className:a?"evo-crack-path drawing delay-150":"evo-crack-path",initial:{opacity:0},animate:{opacity:a?1:0},style:{filter:"drop-shadow(0 0 6px hsl(50, 100%, 70%))"}})]}),r&&e.jsx(P.div,{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-48 evo-seam-flash",style:{background:"linear-gradient(180deg, transparent 0%, hsl(50, 100%, 90%) 50%, transparent 100%)"}}),t==="impact"&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:Array.from({length:8}).map((i,o)=>e.jsx(P.div,{className:"absolute w-3 h-4 bg-gradient-to-br from-amber-100 to-amber-200 rounded-sm",initial:{x:0,y:0,rotate:0,opacity:1,scale:1},animate:{x:Math.cos(o/8*Math.PI*2)*140,y:Math.sin(o/8*Math.PI*2)*110+40,rotate:Math.random()*360,opacity:0,scale:.3},transition:{duration:1,ease:"easeOut",delay:o*.02}},o))})]})},u0=({isEvolving:t,newStage:s,newImageUrl:a,mentorSlug:r,userId:i,element:o,onComplete:l})=>{const[c,d]=n.useState("anticipation"),[u,p]=n.useState(""),[h,f]=n.useState(!0),[m,g]=n.useState(!1),[y,b]=n.useState(!1),[w,x]=n.useState(!1),[v,j]=n.useState(!1),T=n.useRef(null),S=n.useRef(null),N=n.useRef(null),D=n.useRef([]),R=s===1,_=n.useMemo(()=>l0(o,R),[o,R]),C=n.useMemo(()=>typeof window<"u"&&window.matchMedia("(prefers-reduced-motion: reduce)").matches,[]),E=n.useCallback(()=>{if(T.current)try{T.current.pause(),T.current.currentTime=0,T.current.src=""}catch(A){$a.error("Error cleaning up audio",{error:A})}finally{T.current=null}},[]);n.useEffect(()=>{if(!t||!a)return;x(!1);const A=new Image;A.src=a,A.onload=()=>x(!0),A.onerror=()=>x(!0);const L=setTimeout(()=>x(!0),2e3);return()=>clearTimeout(L)},[t,a]),n.useEffect(()=>{if(!t||!w)return;let A=!0;return d("anticipation"),g(!1),hy(),gt.light(),(async()=>{if(!r||!i){A&&f(!1);return}try{const{data:q,error:$}=await k.functions.invoke("generate-evolution-voice",{body:{mentorSlug:r,newStage:s,userId:i,isFirstEvolution:R}});if($)throw $;if(!A)return;q?.voiceLine&&p(q.voiceLine),q?.audioContent&&(T.current=new Audio(`data:audio/mp3;base64,${q.audioContent}`)),f(!1)}catch(q){$a.error("Failed to generate evolution voice",{error:q}),A&&(p(R?"A new companion has hatched! Your journey together begins now.":"Your companion has evolved to a new stage!"),f(!1))}})(),N.current=window.setTimeout(()=>{A&&($a.info("Evolution modal timeout reached, showing emergency exit"),b(!0))},15e3),D.current=[],D.current.push(setTimeout(()=>{A&&(d("impact"),gt.heavy(),S.current&&!C&&(S.current.classList.add("animate-evolution-pulse-hit"),setTimeout(()=>{S.current?.classList.remove("animate-evolution-pulse-hit")},600)))},1200)),D.current.push(setTimeout(()=>{A&&(d("reveal"),fy(),T.current&&!h&&!Co.getMuted()&&T.current.play().catch(q=>$a.error("Audio play failed",{error:q})),C||setTimeout(()=>{Bt({particleCount:_.confettiParticleCount,spread:_.confettiSpread,origin:{y:.5},colors:_.confettiColors,ticks:400,gravity:_.confettiGravity,scalar:R?1.8:1.5}),gt.medium(),setTimeout(()=>{Bt({particleCount:50,spread:60,origin:{y:.7,x:.25},colors:_.confettiColors.slice(0,2)}),Bt({particleCount:50,spread:60,origin:{y:.7,x:.75},colors:_.confettiColors.slice(2)})},200)},100))},2200)),D.current.push(setTimeout(()=>{A&&(d("settle"),setTimeout(()=>{A&&g(!0)},800))},3600)),()=>{A=!1,D.current.forEach(clearTimeout),D.current=[],N.current&&(clearTimeout(N.current),N.current=null),E()}},[t,w,h,r,i,s,E,C,R,_]);const O=A=>{if(!m){A.preventDefault(),A.stopPropagation();return}E(),$a.debug("Dispatching evolution events and closing modal"),window.dispatchEvent(new CustomEvent("companion-evolved")),window.dispatchEvent(new CustomEvent("evolution-complete")),window.dispatchEvent(new CustomEvent("evolution-modal-closed")),l()},M=()=>{$a.info("Emergency exit triggered"),E(),N.current&&(clearTimeout(N.current),N.current=null),window.dispatchEvent(new CustomEvent("evolution-modal-closed")),l()};return t?w?e.jsx(Re,{mode:"wait",children:t&&e.jsxs(P.div,{ref:S,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.5},role:"alertdialog","aria-labelledby":"evolution-title","aria-describedby":"evolution-description",className:`fixed inset-0 z-[9999] flex items-center justify-center overflow-hidden gpu-layer evo-card ${m?"cursor-pointer":""}`,onClick:O,onTouchStart:A=>!m&&A.preventDefault(),"data-particles":_.particleStyle,style:{pointerEvents:"auto",touchAction:m?"auto":"none",background:R?"radial-gradient(circle at center, rgba(50, 40, 0, 0.8) 0%, rgba(0, 0, 0, 0.95) 60%, black 100%)":"radial-gradient(circle at center, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0.95) 70%, black 100%)",paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)",paddingLeft:"env(safe-area-inset-left)",paddingRight:"env(safe-area-inset-right)","--evo-glow-a":_.glowA,"--evo-glow-b":_.glowB},children:[e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.6) 100%)"}}),(c==="reveal"||c==="settle")&&!C&&e.jsx(P.div,{className:"absolute inset-0 will-change-transform evo-glow",initial:{opacity:0,scale:.8},animate:{opacity:[.3,.5,.3],scale:[1,1.1,1]},transition:{duration:3,repeat:1/0,ease:"easeInOut"}}),!C&&e.jsx(c0,{phase:c,particleStyle:_.particleStyle}),R&&e.jsx(d0,{phase:c,show:c!=="settle"}),e.jsxs("div",{className:"flex flex-col items-center justify-center gap-6 max-w-4xl w-full px-6 relative z-10",children:[e.jsx(Re,{mode:"wait",children:c==="anticipation"&&e.jsx(P.div,{initial:{opacity:0,scale:.9,filter:"blur(10px)"},animate:{opacity:1,scale:1,filter:"blur(0px)"},exit:{opacity:0,scale:1.05,filter:"blur(5px)"},transition:{duration:.6},className:"text-center will-change-transform",children:e.jsx("h2",{id:"evolution-title",className:"text-3xl sm:text-4xl md:text-5xl font-black text-white tracking-wider",style:{textShadow:`0 0 30px hsl(${_.glowA}), 0 0 60px hsl(${_.glowB} / 0.6)`},children:R?"Something Stirs Within...":"Evolution Awakens..."})},"prophetic-text")}),e.jsx(Re,{children:(c==="reveal"||c==="settle")&&e.jsxs(P.div,{initial:{opacity:0,scale:.92,filter:"blur(12px)"},animate:{opacity:1,scale:1,filter:"blur(0px)"},transition:{duration:1,ease:[.22,1,.36,1]},className:"relative flex items-center justify-center will-change-transform",style:{width:"100%",maxWidth:"600px",height:"55vh",maxHeight:"450px"},children:[e.jsx(P.div,{className:"absolute inset-0 will-change-transform",animate:c==="settle"?{scale:[1,1.08,1],opacity:[.4,.6,.4]}:{},transition:{duration:3,repeat:1/0,ease:"easeInOut"},style:{background:`radial-gradient(circle, hsl(${_.glowA} / 0.35) 0%, transparent 70%)`,filter:"blur(30px)"}}),e.jsx(be,{className:"absolute -top-4 -left-4 w-10 h-10 text-primary animate-pulse will-change-transform",style:{filter:"drop-shadow(0 0 12px currentColor)"}}),e.jsx(be,{className:"absolute -top-4 -right-4 w-10 h-10 text-accent animate-pulse will-change-transform",style:{filter:"drop-shadow(0 0 12px currentColor)",animationDelay:"0.2s"}}),e.jsx(be,{className:"absolute -bottom-4 -left-4 w-10 h-10 text-accent animate-pulse will-change-transform",style:{filter:"drop-shadow(0 0 12px currentColor)",animationDelay:"0.4s"}}),e.jsx(be,{className:"absolute -bottom-4 -right-4 w-10 h-10 text-primary animate-pulse will-change-transform",style:{filter:"drop-shadow(0 0 12px currentColor)",animationDelay:"0.6s"}}),e.jsxs(P.div,{className:"relative rounded-2xl overflow-hidden will-change-transform",animate:c==="settle"?{scale:[1,1.01,1]}:{},transition:{duration:3,repeat:1/0,ease:"easeInOut"},style:{width:"100%",height:"100%",maxWidth:"520px",border:`3px solid hsl(${_.glowA} / 0.6)`,boxShadow:`0 0 40px hsl(${_.glowA} / 0.4), inset 0 0 30px hsl(${_.glowB} / 0.1)`},children:[!C&&e.jsx(P.div,{className:"absolute inset-0 pointer-events-none z-10",animate:{backgroundPosition:["200% 0%","-200% 0%"]},transition:{duration:2.5,repeat:1/0,ease:"linear"},style:{background:"linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.15) 50%, transparent 100%)",backgroundSize:"200% 100%"}}),e.jsx("img",{src:a,alt:"Evolved companion",className:"w-full h-full object-cover transition-opacity duration-300",style:{opacity:v?1:0},loading:"eager",onLoad:()=>j(!0)})]})]},"companion-wrapper")}),e.jsx(Re,{children:(c==="reveal"||c==="settle")&&e.jsxs(P.div,{initial:{opacity:0,y:20,scale:.95},animate:{opacity:1,y:0,scale:1},transition:{type:"spring",stiffness:150,damping:18,delay:.2},className:"text-center space-y-3 will-change-transform",children:[e.jsx(P.h1,{className:"text-4xl sm:text-5xl md:text-6xl font-black uppercase tracking-tight",style:{background:R?"linear-gradient(135deg, #FFD700, #FFA500, #FFD700)":`linear-gradient(135deg, hsl(${_.glowA}), hsl(${_.glowB}), hsl(${_.glowA}))`,backgroundSize:"200% 200%",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",filter:`drop-shadow(0 0 20px hsl(${_.glowA} / 0.6))`},animate:{backgroundPosition:["0% 50%","100% 50%","0% 50%"]},transition:{duration:4,repeat:1/0,ease:"linear"},children:R?"Hatched!":"Evolved!"}),e.jsx("p",{id:"evolution-description",className:"text-lg sm:text-xl md:text-2xl font-semibold text-white/90",style:{textShadow:"0 0 15px rgba(255, 255, 255, 0.5)"},children:R?"Your companion has emerged!":"Your companion grows stronger!"}),c==="settle"&&u&&e.jsx(P.div,{initial:{opacity:0,y:15,scale:.95},animate:{opacity:1,y:0,scale:1},transition:{delay:.3,duration:.4},className:"max-w-lg mx-auto mt-5",children:e.jsx("div",{className:"relative p-5 rounded-xl bg-white/5 border border-white/20 backdrop-blur-md",style:{boxShadow:"0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.1)"},children:e.jsxs("p",{className:"text-base sm:text-lg text-white/95 font-medium italic leading-relaxed",children:['"',u,'"']})})})]},"announcement")}),e.jsx(Re,{children:m&&!y&&e.jsx(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},transition:{delay:.2},className:"absolute left-1/2 transform -translate-x-1/2",style:{bottom:"calc(1.5rem + env(safe-area-inset-bottom, 0px))"},children:e.jsx(P.p,{className:"text-white/90 text-base sm:text-lg font-medium",animate:{opacity:[.6,1,.6]},transition:{duration:2,repeat:1/0},children:"Tap anywhere to continue âœ¨"})})}),y&&e.jsx(P.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"absolute z-[10002]",style:{top:"calc(1rem + env(safe-area-inset-top, 0px))",right:"calc(1rem + env(safe-area-inset-right, 0px))"},children:e.jsx("button",{onClick:A=>{A.stopPropagation(),M()},className:"bg-destructive/90 hover:bg-destructive text-destructive-foreground font-bold px-4 py-2 rounded-lg shadow-lg transition-colors","aria-label":"Close evolution modal",children:"âœ• Close"})})]})]})}):e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/90",style:{paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)"},children:e.jsx(P.div,{animate:{scale:[1,1.1,1],opacity:[.5,1,.5]},transition:{duration:1.5,repeat:1/0},className:"text-primary text-xl font-medium",children:"Preparing evolution..."})}):null},m0=t=>e.jsx(ls,{fallback:e.jsx(r0,{onClose:t.onComplete}),children:e.jsx(u0,{...t})}),p0=()=>{const{user:t}=_e(),{profile:s}=ss(),a=Ie(),{setIsEvolvingLoading:r,onEvolutionComplete:i}=ri(),{setEvolutionInProgress:o}=Ny(),[l,c]=n.useState(!1),d=ur(s),[u,p]=n.useState(null),[,h]=n.useState(null);return n.useEffect(()=>{if(!t)return;const f=k.channel("companion-evolution").on("postgres_changes",{event:"UPDATE",schema:"public",table:"user_companion",filter:`user_id=eq.${t.id}`},async m=>{const g=m.new,y=m.old;if(!g||!y){ue.warn("Evolution listener: Missing payload data");return}const b=typeof g.current_stage=="number"?g.current_stage:null,w=typeof y.current_stage=="number"?y.current_stage:null;if(b===null||w===null){ue.warn("Evolution listener: Invalid stage values");return}if(b>w){const x=typeof g.id=="string"?g.id:null;if(!x){ue.warn("Evolution listener: Missing companion id");return}const[v,j]=await Promise.all([k.from("companion_evolutions").select("image_url").eq("companion_id",x).eq("stage",b).order("evolved_at",{ascending:!1}).limit(1).maybeSingle(),k.from("user_companion").select("core_element").eq("id",x).maybeSingle()]),T=typeof g.current_image_url=="string"?g.current_image_url:"",S=v.data?.image_url||T,N=j.data?.core_element||void 0;let D;if(d){const{data:C}=await k.from("mentors").select("slug").eq("id",d).maybeSingle();D=C?.slug}h(w),p({stage:b,imageUrl:S,mentorSlug:D,element:N}),c(!0),o(!0),window.dispatchEvent(new CustomEvent("evolution-loading-start"));const R=new Date().toISOString().split("T")[0],_=b===1;k.from("companion_memories").insert({user_id:t.id,companion_id:x,memory_type:_?"first_evolution":"evolution",memory_date:R,memory_context:{title:_?"First Evolution":`Evolved to Stage ${b}`,description:_?"The first transformation - proof of our growing bond.":`Another beautiful transformation, reaching stage ${b}.`,emotion:_?"pride":"joy",details:{stage:b,previousStage:w}},referenced_count:0}).then(({error:C})=>{C&&ue.error("Failed to create evolution memory:",C)}),t?.id&&a.invalidateQueries({queryKey:["companion",t.id]})}}).subscribe((m,g)=>{m==="SUBSCRIBED"||(m==="CHANNEL_ERROR"||m==="TIMED_OUT")&&ue.warn("Evolution listener subscription error",{status:m,error:g?.message})});return()=>{k.removeChannel(f)}},[t,t?.id,d,a,o]),!l||!u?null:e.jsx(m0,{isEvolving:l,newStage:u.stage,newImageUrl:u.imageUrl,mentorSlug:u.mentorSlug,element:u.element,userId:t?.id,onComplete:()=>{c(!1),p(null),h(null),r(!1),o(!1),i&&i()}})},h0=()=>{const{user:t}=_e(),s=Ie();n.useEffect(()=>{if(!t?.id)return;const a=k.channel(`habits-sync-${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"habits",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["habits",t.id]}),s.invalidateQueries({queryKey:["habits"]}),s.invalidateQueries({queryKey:["habit-surfacing"]}),s.invalidateQueries({queryKey:["epics"]})}).on("postgres_changes",{event:"*",schema:"public",table:"habit_completions",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["habit-completions",t.id]}),s.invalidateQueries({queryKey:["habit-completions"]}),s.invalidateQueries({queryKey:["habits",t.id]}),s.invalidateQueries({queryKey:["habits"]}),s.invalidateQueries({queryKey:["quest-autocomplete-habits",t.id]})}).subscribe((r,i)=>{(r==="CHANNEL_ERROR"||r==="TIMED_OUT")&&ue.warn("Habits realtime subscription error",{status:r,error:i?.message})});return()=>{k.removeChannel(a)}},[t?.id,s])},f0=()=>{const{user:t}=_e(),s=Ie();n.useEffect(()=>{if(!t?.id)return;const a=k.channel(`epics-sync-${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"epics",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["epics",t.id]}),s.invalidateQueries({queryKey:["epics"]}),s.invalidateQueries({queryKey:["epic-progress"]}),s.invalidateQueries({queryKey:["habit-surfacing"]})}).subscribe((r,i)=>{(r==="CHANNEL_ERROR"||r==="TIMED_OUT")&&ue.warn("Epics realtime subscription error",{status:r,error:i?.message})});return()=>{k.removeChannel(a)}},[t?.id,s])},g0=()=>{const{user:t}=_e(),s=Ie();n.useEffect(()=>{if(!t?.id)return;const a=k.channel(`daily-tasks-sync-${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"daily_tasks",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["daily-tasks"]}),s.invalidateQueries({queryKey:["tasks"]}),s.invalidateQueries({queryKey:["calendar-tasks"]}),s.invalidateQueries({queryKey:["habit-surfacing"]})}).on("postgres_changes",{event:"*",schema:"public",table:"subtasks",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["daily-tasks"]})}).subscribe((r,i)=>{(r==="CHANNEL_ERROR"||r==="TIMED_OUT")&&ue.warn("Daily tasks realtime subscription error",{status:r,error:i?.message})});return()=>{k.removeChannel(a)}},[t?.id,s])},x0=({children:t})=>(h0(),f0(),g0(),e.jsx(e.Fragment,{children:t})),y0=()=>{const[t,s]=n.useState(null),[a,r]=n.useState(!1);n.useEffect(()=>{const l=c=>{c.preventDefault(),s(c),r(!0)};return window.addEventListener("beforeinstallprompt",l),()=>window.removeEventListener("beforeinstallprompt",l)},[]);const i=async()=>{if(!t)return;t.prompt();const{outcome:l}=await t.userChoice;l==="accepted"&&(s(null),r(!1))},o=()=>{r(!1),st.setItem("pwa-install-dismissed","true")};return!a||st.getItem("pwa-install-dismissed")?null:e.jsxs(Xe,{className:"fixed bottom-36 left-4 right-4 p-4 z-50 bg-card border-border shadow-lg md:left-auto md:right-4 md:max-w-sm",children:[e.jsx("button",{onClick:o,className:"absolute top-2 right-2 p-1 hover:bg-muted rounded-full transition-colors",children:e.jsx(kt,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-lg",children:e.jsx(Jf,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-sm mb-1",children:"Install Cosmiq"}),e.jsx("p",{className:"text-xs text-muted-foreground mb-3",children:"Add to your home screen for quick access and offline support"}),e.jsx(z,{onClick:i,size:"sm",className:"w-full",children:"Install App"})]})]})]})},b0=async()=>{if(Ze.isNativePlatform())try{await tu.lock({orientation:"portrait"}),console.log("Orientation locked to portrait")}catch(t){console.error("Failed to lock orientation:",t)}},OT=async()=>{if(Ze.isNativePlatform())try{await tu.lock({orientation:"landscape"}),console.log("Orientation locked to landscape")}catch(t){console.error("Failed to lock to landscape:",t)}};function oi(){try{const t=Ze.isNativePlatform(),s=Ze.getPlatform(),a=t&&s==="ios";return console.log("[NativePush] Platform check:",{isNative:t,platform:s,isSupported:a}),ue.info("[NativePush] Platform check:",{isNative:t,platform:s,isSupported:a}),a}catch(t){return console.log("[NativePush] Platform check error:",t),ue.info("Native push not available:",t),!1}}async function w0(t){if(console.log("[NativePush] ========== INIT START =========="),console.log("[NativePush] User ID:",t),!oi()){console.log("[NativePush] Not supported on this platform, aborting"),ue.info("Native push not supported on this platform");return}try{console.log("[NativePush] Step 1: Requesting permissions...");const s=await zs.requestPermissions();if(console.log("[NativePush] Permission result:",s),console.log("[NativePush] Permission receive status:",s.receive),s.receive!=="granted")throw console.log("[NativePush] Permission DENIED - user did not grant access"),ue.log("Push notification permission denied"),new Error("Push notification permission denied. Please enable in Settings.");console.log("[NativePush] Step 2: Permission granted, registering with APNs..."),await zs.register(),console.log("[NativePush] Step 3: Registration initiated, setting up listeners..."),await zs.addListener("registration",async a=>{console.log("[NativePush] âœ… REGISTRATION SUCCESS"),console.log("[NativePush] Device token received"),ue.log("Push registration success");try{await v0(t,a.value),console.log("[NativePush] Token saved to database successfully")}catch(r){console.log("[NativePush] âŒ Failed to save token:",r)}}),await zs.addListener("registrationError",a=>{console.log("[NativePush] âŒ REGISTRATION ERROR"),console.log("[NativePush] Error details:",JSON.stringify(a)),ue.error("Push registration error:",a)}),await zs.addListener("pushNotificationReceived",a=>{console.log("[NativePush] Notification received:",a),ue.log("Push notification received:",a)}),await zs.addListener("pushNotificationActionPerformed",a=>{console.log("[NativePush] Notification action performed:",a),ue.log("Push notification action performed:",a);const r=a.notification.data;r?.url&&window.dispatchEvent(new CustomEvent("native-push-navigation",{detail:r.url}))}),console.log("[NativePush] ========== INIT COMPLETE ==========")}catch(s){throw console.log("[NativePush] âŒ INIT FAILED"),console.log("[NativePush] Error:",s),ue.error("Error initializing native push:",s),s}}async function v0(t,s){console.log("[NativePush] Saving token to database..."),console.log("[NativePush] User:",t),console.log("[NativePush] Token (first 20 chars):",s.substring(0,20)+"...");try{const{error:a}=await k.from("push_device_tokens").upsert({user_id:t,device_token:s,platform:"ios",user_agent:navigator.userAgent},{onConflict:"user_id,device_token"});if(a)throw console.log("[NativePush] Database error:",a),ue.error("Error saving device token:",a),a;console.log("[NativePush] âœ… Device token saved successfully"),ue.log("Device token saved successfully")}catch(a){throw console.log("[NativePush] âŒ Error saving device token:",a),ue.error("Error saving device token:",a),a}}async function FT(t){if(console.log("[NativePush] Unregistering..."),!!oi())try{await zs.removeAllListeners();const s=await zs.getDeliveredNotifications();console.log("[NativePush] Delivered notifications:",s);const{error:a}=await k.from("push_device_tokens").delete().eq("user_id",t).eq("platform","ios");a?(console.log("[NativePush] Error deleting token:",a),ue.error("Error deleting device token:",a)):console.log("[NativePush] Token deleted from database")}catch(s){throw console.log("[NativePush] Unregister error:",s),ue.error("Error unregistering from push:",s),s}}async function $T(t){try{const{data:s,error:a}=await k.from("push_device_tokens").select("id").eq("user_id",t).eq("platform","ios").limit(1);if(a)throw a;const r=(s?.length||0)>0;return console.log("[NativePush] Has active subscription:",r),r}catch(s){return console.log("[NativePush] Error checking subscription:",s),ue.error("Error checking native push subscription:",s),!1}}async function BT(t){const s=Ze.getPlatform(),a=Ze.isNativePlatform(),r=oi();let i="unknown",o;try{r&&(i=(await zs.checkPermissions()).receive)}catch(c){o=c instanceof Error?c.message:String(c)}const l={platform:s,isNative:a,isSupported:r,permissionStatus:i,error:o};return console.log("[NativePush] Debug info:",l),l}const as=au,_0=eg,j0=su,Im=n.forwardRef(({className:t,...s},a)=>e.jsx(Vn,{ref:a,className:I("fixed inset-0 z-50 bg-black/58 backdrop-blur-[2px] data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...s}));Im.displayName=Vn.displayName;const Qt=n.forwardRef(({className:t,children:s,hideCloseButton:a,...r},i)=>e.jsxs(j0,{children:[e.jsx(Im,{}),e.jsxs(Xn,{ref:i,className:I("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border border-border/70 bg-card/92 p-6 shadow-[0_20px_44px_rgba(0,0,0,0.34)] backdrop-blur-xl duration-200 overscroll-contain data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[49%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[51%] sm:rounded-2xl",t),...r,children:[s,!a&&e.jsxs(Zf,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity data-[state=open]:bg-accent data-[state=open]:text-muted-foreground hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none",children:[e.jsx(kt,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));Qt.displayName=Xn.displayName;const Is=({className:t,...s})=>e.jsx("div",{className:I("flex flex-col space-y-1.5 text-center sm:text-left",t),...s});Is.displayName="DialogHeader";const ps=n.forwardRef(({className:t,...s},a)=>e.jsx(Jn,{ref:a,className:I("text-lg font-semibold leading-none tracking-tight",t),...s}));ps.displayName=Jn.displayName;const Vs=n.forwardRef(({className:t,...s},a)=>e.jsx(Zn,{ref:a,className:I("text-sm text-muted-foreground",t),...s}));Vs.displayName=Zn.displayName;const N0={common:90,uncommon:90,rare:90,epic:90,legendary:120},k0={common:{playerHP:100,adversaryHP:80,attackDamage:12},uncommon:{playerHP:100,adversaryHP:100,attackDamage:15},rare:{playerHP:100,adversaryHP:120,attackDamage:18},epic:{playerHP:100,adversaryHP:150,attackDamage:22},legendary:{playerHP:100,adversaryHP:180,attackDamage:28}},UT={tap_sequence:{levelComplete:20,perfectLevel:30},galactic_match:{levelComplete:20,perfectLevel:30},soul_serpent:{scoreMilestone:25},starfall_dodge:{survivalMilestone:20},energy_beam:{waveComplete:25,bossKill:15},orb_match:{scoreTarget:35,specialActivation:10},eclipse_timing:{songComplete:999,tooManyMisses:999},astral_frequency:{distanceMilestone:12}},C0={perfect:70};function S0(t,s,a){return a?"fail":t/s*100>=C0.perfect?"perfect":"good"}const E0={0:"Egg",1:"Hatchling",2:"Sproutling",3:"Cub",4:"Juvenile",5:"Apprentice",6:"Scout",7:"Fledgling",8:"Warrior",9:"Guardian",10:"Champion",11:"Ascended",12:"Vanguard",13:"Titan",14:"Mythic",15:"Prime",16:"Regal",17:"Eternal",18:"Transcendent",19:"Apex",20:"Ultimate Form"},li=t=>E0[t]||`Stage ${t}`,Kl={common:{primary:"hsl(220, 13%, 50%)",glow:"rgba(100, 116, 139, 0.5)",bg:"from-slate-500/20 to-slate-700/10"},uncommon:{primary:"hsl(142, 76%, 46%)",glow:"rgba(34, 197, 94, 0.5)",bg:"from-emerald-500/20 to-emerald-700/10"},rare:{primary:"hsl(217, 91%, 60%)",glow:"rgba(59, 130, 246, 0.5)",bg:"from-blue-500/20 to-blue-700/10"},epic:{primary:"hsl(271, 91%, 65%)",glow:"rgba(168, 85, 247, 0.5)",bg:"from-purple-500/20 to-purple-700/10"},legendary:{primary:"hsl(38, 92%, 50%)",glow:"rgba(245, 158, 11, 0.6)",bg:"from-amber-500/20 to-orange-600/10"}},T0=({companionImageUrl:t,companionName:s="Companion",companionStage:a=0,adversary:r,adversaryImageUrl:i,onReady:o,onPass:l})=>{const c=Kl[r.tier]||Kl.common,d=n.useMemo(()=>Array.from({length:15},(p,h)=>({id:h,top:h*7+3,duration:.6+h%5*.15,delay:h%7*.1})),[]),u=n.useMemo(()=>Array.from({length:20},(p,h)=>({id:h,x:h%5*25,y:Math.floor(h/5)*25,size:2+h%3,duration:2+h%3,delay:h%5*.3})),[]);return e.jsxs("div",{className:"relative w-full h-[520px] overflow-hidden bg-gradient-to-b from-background via-background/95 to-background",children:[e.jsxs("div",{className:"absolute inset-0",children:[u.map(p=>e.jsx(P.div,{className:"absolute rounded-full bg-white/60",style:{left:`${p.x}%`,top:`${p.y}%`,width:p.size,height:p.size},animate:{opacity:[.2,.8,.2],scale:[1,1.5,1]},transition:{duration:p.duration,repeat:1/0,delay:p.delay}},p.id)),d.map(p=>e.jsx(P.div,{className:"absolute h-[1px] w-full",style:{top:`${p.top}%`,background:"linear-gradient(90deg, transparent 0%, hsl(var(--primary) / 0.4) 50%, transparent 100%)"},animate:{x:["-100%","100%"],opacity:[0,1,0]},transition:{duration:p.duration,repeat:1/0,delay:p.delay,ease:"linear"}},p.id)),e.jsxs("svg",{className:"absolute inset-0 w-full h-full",preserveAspectRatio:"none",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"dividerGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"hsl(var(--primary))",stopOpacity:"0.3"}),e.jsx("stop",{offset:"50%",stopColor:"white",stopOpacity:"0.1"}),e.jsx("stop",{offset:"100%",style:{stopColor:c.primary},stopOpacity:"0.3"})]})}),e.jsx(P.line,{x1:"50%",y1:"0",x2:"50%",y2:"100%",stroke:"url(#dividerGradient)",strokeWidth:"2",initial:{pathLength:0},animate:{pathLength:1},transition:{duration:.8,delay:.2}})]}),e.jsx("div",{className:"absolute inset-y-0 left-0 w-1/2 bg-gradient-to-r from-primary/10 via-primary/5 to-transparent"}),e.jsx("div",{className:"absolute inset-y-0 right-0 w-1/2",style:{background:`linear-gradient(to left, ${c.glow}, transparent)`}})]}),e.jsxs("div",{className:"relative z-10 h-full flex flex-col",children:[e.jsxs("div",{className:"flex-1 flex items-center relative min-h-0",children:[e.jsxs(P.div,{className:"flex-1 h-full flex flex-col items-center justify-center px-3",initial:{x:"-100%",opacity:0},animate:{x:0,opacity:1},transition:{type:"spring",stiffness:70,damping:18,delay:.1},children:[e.jsxs(P.div,{className:"relative w-36 h-36 sm:w-44 sm:h-44",animate:{y:[0,-6,0]},transition:{duration:3.5,repeat:1/0,ease:"easeInOut"},children:[e.jsx(P.div,{className:"absolute -inset-4 rounded-full",style:{background:"radial-gradient(circle, hsl(var(--primary) / 0.3) 0%, transparent 70%)"},animate:{scale:[1,1.2,1],opacity:[.4,.7,.4]},transition:{duration:2.5,repeat:1/0}}),e.jsx("div",{className:"relative w-full h-full rounded-2xl overflow-hidden border-2 border-primary/40 shadow-[0_0_30px_hsl(var(--primary)/0.3)]",children:t?e.jsx("img",{src:t,alt:s,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center",children:e.jsx(be,{className:"w-12 h-12 text-primary"})})})]}),e.jsxs(P.div,{className:"mt-3 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5},children:[e.jsx("p",{className:"text-base font-bold text-foreground",children:s}),e.jsx("p",{className:"text-[10px] text-primary/80 font-medium uppercase tracking-wider",children:li(a)})]})]}),e.jsxs(P.div,{className:"absolute left-[43%] top-[35%] -translate-x-1/2 -translate-y-1/2 z-20",initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",stiffness:300,damping:20,delay:.3},children:[e.jsx(P.div,{className:"absolute inset-0 rounded-lg blur-xl",style:{background:`${c.primary}40`},animate:{scale:[1,1.3,1],opacity:[.5,.8,.5]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx("div",{className:"relative px-3 py-1.5 bg-background/95 border border-primary/50 rounded-md backdrop-blur-sm",style:{boxShadow:`0 0 20px ${c.glow}`},children:e.jsx("span",{className:"text-lg sm:text-xl font-black tracking-tight",style:{background:`linear-gradient(135deg, hsl(var(--primary)) 0%, ${c.primary} 100%)`,backgroundClip:"text",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},children:"VS"})})]}),e.jsxs(P.div,{className:"flex-1 h-full flex flex-col items-center justify-center px-3",initial:{x:"100%",opacity:0},animate:{x:0,opacity:1},transition:{type:"spring",stiffness:70,damping:18,delay:.1},children:[e.jsxs(P.div,{className:"relative w-36 h-36 sm:w-44 sm:h-44",animate:{y:[0,-6,0]},transition:{duration:3.5,repeat:1/0,ease:"easeInOut",delay:.5},children:[e.jsx(P.div,{className:"absolute -inset-4 rounded-full",style:{background:`radial-gradient(circle, ${c.glow} 0%, transparent 70%)`},animate:{scale:[1,1.2,1],opacity:[.4,.7,.4]},transition:{duration:2.5,repeat:1/0}}),e.jsx("div",{className:"relative w-full h-full rounded-2xl overflow-hidden border-2",style:{borderColor:c.primary+"60",boxShadow:`0 0 30px ${c.glow}`},children:i?e.jsx("img",{src:i,alt:r.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:`w-full h-full bg-gradient-to-br ${c.bg} flex items-center justify-center`,children:e.jsx(Sa,{className:"w-12 h-12",style:{color:c.primary,filter:`drop-shadow(0 0 10px ${c.glow})`}})})}),e.jsx(P.div,{className:"absolute -top-1 -right-1 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase text-white shadow-lg",style:{backgroundColor:c.primary},initial:{scale:0},animate:{scale:1},transition:{delay:.6,type:"spring"},children:Ps(r.tier)})]}),e.jsxs(P.div,{className:"mt-3 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5},children:[e.jsx("p",{className:"text-base font-bold",style:{color:c.primary},children:r.name}),e.jsxs("p",{className:"text-[10px] font-medium uppercase tracking-wider",style:{color:c.primary+"cc"},children:[Ps(r.theme)," Adversary"]})]})]})]}),e.jsxs(P.div,{className:"px-5 pb-5 pt-3 bg-gradient-to-t from-background via-background/95 to-transparent",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.7},children:[e.jsx("div",{className:"flex justify-center gap-6 mb-3",children:[{label:"Phases",value:r.phases},{label:"Essence",value:r.statType},{label:"Boost",value:`+${r.statBoost}`}].map(p=>e.jsxs("div",{className:"text-center px-3 py-1.5 rounded-lg bg-muted/30 backdrop-blur-sm",children:[e.jsx("p",{className:"text-[10px] text-muted-foreground uppercase tracking-wider",children:p.label}),e.jsx("p",{className:"text-sm font-bold text-primary",children:typeof p.value=="string"?Ps(p.value):p.value})]},p.label))}),e.jsxs("p",{className:"text-center text-xs text-muted-foreground italic mb-4 line-clamp-2 px-2",children:['"',r.lore,'"']}),e.jsxs("div",{className:"flex gap-3 w-full overflow-hidden",children:[l&&e.jsxs(z,{onClick:l,variant:"ghost",size:"lg",className:"h-12 px-4 text-muted-foreground hover:text-foreground",children:[e.jsx(Rr,{className:"w-5 h-5 mr-1"}),"Pass"]}),e.jsxs(z,{onClick:o,size:"lg",className:"flex-1 min-w-0 h-12 text-sm sm:text-base font-bold bg-gradient-to-r from-primary via-accent to-primary bg-[length:200%_100%] hover:bg-[position:100%_0] transition-all duration-500 shadow-lg shadow-primary/30",children:[e.jsx(bt,{className:"w-5 h-5 mr-2 flex-shrink-0"}),"Begin Harmonization"]})]})]})]})]})},Ql={mind:{icon:Ds,color:"text-cyan-400",bg:"from-cyan-500/30 to-blue-500/30",glow:"shadow-cyan-500/50"},body:{icon:Ko,color:"text-amber-400",bg:"from-amber-500/30 to-orange-500/30",glow:"shadow-amber-500/50"},soul:{icon:aa,color:"text-purple-400",bg:"from-purple-500/30 to-pink-500/30",glow:"shadow-purple-500/50"}},M0={perfect:{title:"Perfect Victory!",icon:ru,color:"text-amber-400",textGradient:"from-amber-300 via-yellow-400 to-orange-400",confettiColors:["#fbbf24","#f59e0b","#d97706","#fcd34d"]},good:{title:"Victory!",icon:Mt,color:"text-primary",textGradient:"from-primary via-accent to-primary",confettiColors:["#8b5cf6","#a855f7","#c084fc","#6366f1"]},fail:{title:"Overcome by Shadow",icon:Sa,color:"text-slate-400",textGradient:"from-slate-400 via-purple-400 to-slate-500",confettiColors:[]}},Wl=["steadies their resolve beside you","refuses to give up","gathers strength for the next attempt","stands ready to try again","believes in your strength"],D0=()=>{const t=n.useMemo(()=>Array.from({length:12},(s,a)=>({id:a,left:Math.random()*100,delay:Math.random()*3,duration:4+Math.random()*3,size:2+Math.random()*3})),[]);return e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:t.map(s=>e.jsx(P.div,{className:"absolute rounded-full",style:{left:`${s.left}%`,top:"-5%",width:s.size,height:s.size,background:"radial-gradient(circle, rgba(168, 85, 247, 0.8), rgba(100, 50, 150, 0.4))",boxShadow:"0 0 6px rgba(168, 85, 247, 0.5)"},animate:{y:["0vh","110vh"],opacity:[0,.8,.6,0],x:[0,Math.sin(s.id)*20,Math.cos(s.id)*15,0]},transition:{duration:s.duration,delay:s.delay,repeat:1/0,ease:"linear"}},s.id))})},A0=({adversary:t,result:s,accuracy:a,xpEarned:r,onClose:i,retryAvailableAt:o,tiltBonus:l,companionImageUrl:c,companionName:d})=>{const u=M0[s],p=u.icon,h=s!=="fail",f=Ql[t.statType]||Ql.soul,m=f.icon,g=n.useMemo(()=>Wl[Math.floor(Math.random()*Wl.length)],[]);n.useEffect(()=>{if(h){ws.impact({style:Ut.Heavy}).catch(()=>{});const w=Date.now()+2e3,x=()=>{Bt({particleCount:3,angle:60,spread:55,origin:{x:0,y:.6},colors:u.confettiColors}),Bt({particleCount:3,angle:120,spread:55,origin:{x:1,y:.6},colors:u.confettiColors}),Date.now()<w&&requestAnimationFrame(x)};x(),setTimeout(()=>{Bt({particleCount:100,spread:100,origin:{y:.5},colors:u.confettiColors})},300)}else ws.impact({style:Ut.Light}).catch(()=>{})},[h,u.confettiColors]);const y=()=>{if(!o)return"";const b=new Date(o),w=new Date;return`Retry in ${Math.ceil((b.getTime()-w.getTime())/(1e3*60*60))}h`};return e.jsxs("div",{className:"flex flex-col items-center gap-4 p-6 text-center overflow-hidden relative",children:[e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx(P.div,{className:`absolute top-1/4 left-1/2 -translate-x-1/2 w-64 h-64 rounded-full blur-3xl ${h?"bg-primary/20":"bg-purple-900/30"}`,animate:{scale:[1,1.2,1],opacity:[.3,.5,.3]},transition:{duration:3,repeat:1/0}}),!h&&e.jsx(P.div,{className:"absolute inset-0 pointer-events-none",initial:{opacity:0},animate:{opacity:1},style:{background:"radial-gradient(ellipse at center, transparent 20%, rgba(15, 10, 30, 0.6) 80%)"}})]}),!h&&e.jsx(D0,{}),e.jsxs(P.div,{className:"relative",initial:{scale:0,rotate:h?-180:0},animate:{scale:1,rotate:0},transition:{type:"spring",duration:.8},children:[e.jsx("div",{className:`absolute inset-0 blur-xl ${h?u.color:"text-purple-500"} opacity-50`}),e.jsx(p,{className:`w-16 h-16 ${u.color} relative z-10 drop-shadow-lg`}),!h&&e.jsx(P.div,{className:"absolute inset-0 rounded-full border-2 border-purple-500/30",animate:{scale:[1,1.5,1],opacity:[.5,0,.5]},transition:{duration:2,repeat:1/0}})]}),e.jsx(P.h2,{className:`text-3xl font-black bg-gradient-to-r ${u.textGradient} bg-clip-text text-transparent`,initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},children:u.title}),c&&e.jsxs(P.div,{className:"relative my-2",initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.3,type:"spring"},children:[e.jsx(P.div,{className:`absolute inset-0 rounded-full bg-gradient-to-r ${h?f.bg:"from-slate-600/30 to-purple-900/30"} blur-xl`,animate:{scale:[1,1.3,1],opacity:h?[.5,.8,.5]:[.3,.5,.3]},transition:{duration:2,repeat:1/0}}),e.jsxs("div",{className:`relative w-28 h-28 rounded-full overflow-hidden border-2 ${h?"border-primary/50 shadow-lg shadow-primary/30":"border-slate-500/40 shadow-lg shadow-purple-900/30"}`,children:[e.jsx("img",{src:c,alt:d||"Companion",className:`w-full h-full object-cover ${h?"":"saturate-75"}`}),!h&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-purple-900/30 to-transparent"})]}),h&&e.jsx(P.div,{className:"absolute -top-1 -right-1",animate:{rotate:360},transition:{duration:4,repeat:1/0,ease:"linear"},children:e.jsx(be,{className:`w-5 h-5 ${f.color}`})}),!h&&e.jsx(P.div,{className:"absolute -bottom-1 -right-1",initial:{scale:0},animate:{scale:1},transition:{delay:.5},children:e.jsx("div",{className:"w-8 h-8 rounded-full bg-slate-800/80 border border-purple-500/40 flex items-center justify-center",children:e.jsx(As,{className:"w-4 h-4 text-purple-400"})})})]}),e.jsx(P.p,{className:`text-sm italic ${h?"text-muted-foreground":"text-purple-300/80"}`,initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},children:h?`${d||"Your companion"} radiates with newfound power!`:`${d||"Your companion"} ${g}`}),e.jsx(P.div,{className:"w-full",initial:{y:30,opacity:0},animate:{y:0,opacity:1},transition:{delay:.5},children:e.jsxs("div",{className:`relative p-4 rounded-xl ${h?`bg-gradient-to-br ${f.bg}`:"bg-gradient-to-br from-slate-800/50 to-purple-900/30"} border ${h?"border-white/10":"border-slate-600/30"} backdrop-blur-sm overflow-hidden`,children:[e.jsx(P.div,{className:`absolute inset-0 rounded-xl border-2 ${h?f.color.replace("text","border"):"border-slate-500/30"} opacity-50`,animate:{opacity:h?[.3,.7,.3]:[.1,.3,.1]},transition:{duration:2,repeat:1/0}}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("div",{className:"flex items-center justify-center gap-2 mb-2",children:h?e.jsxs(e.Fragment,{children:[e.jsx(be,{className:`w-4 h-4 ${f.color}`}),e.jsx("p",{className:`text-sm font-bold uppercase tracking-wider ${f.color}`,children:"Essence Absorbed"}),e.jsx(be,{className:`w-4 h-4 ${f.color}`})]}):e.jsxs(e.Fragment,{children:[e.jsx(El,{className:"w-4 h-4 text-slate-400"}),e.jsx("p",{className:"text-sm font-bold uppercase tracking-wider text-slate-400",children:"Essence Slipped Away"}),e.jsx(El,{className:"w-4 h-4 text-slate-400"})]})}),e.jsx("h3",{className:`text-xl font-bold ${h?"text-foreground":"text-slate-400"} mb-1`,children:t.essenceName}),e.jsxs("p",{className:`text-sm ${h?"text-muted-foreground":"text-slate-500"} mb-3 line-clamp-2`,children:['"',t.essenceDescription,'"']}),e.jsxs("div",{className:`inline-flex items-center gap-2 px-4 py-2 rounded-full ${h?"bg-background/50":"bg-slate-800/50"} border ${h?"border-white/10":"border-slate-600/30"}`,children:[e.jsx(m,{className:`w-5 h-5 ${h?f.color:"text-slate-500"}`}),e.jsx("span",{className:`text-sm font-medium ${h?"text-muted-foreground":"text-slate-500"} capitalize`,children:t.statType}),e.jsxs("span",{className:`text-lg font-bold ${h?f.color:"text-slate-500 line-through"}`,children:["+",t.statBoost]}),!h&&e.jsx("span",{className:"text-xs text-slate-500 ml-1",children:"(Not earned)"})]})]})]})}),h&&e.jsxs(P.div,{className:"flex flex-col items-center gap-1",initial:{scale:0},animate:{scale:1},transition:{delay:.7,type:"spring"},children:[e.jsxs("div",{className:"flex items-center gap-2 text-xl",children:[e.jsx(be,{className:"w-5 h-5 text-primary"}),e.jsxs("span",{className:"font-bold text-primary",children:["+",r," XP"]})]}),l&&e.jsxs(P.div,{className:"flex items-center gap-1 text-xs text-cyan-400",initial:{opacity:0},animate:{opacity:1},transition:{delay:1},children:[e.jsx("span",{children:"ðŸ“±"}),e.jsx("span",{children:"+25% Tilt Bonus!"})]})]}),e.jsxs(P.div,{className:"w-full mt-2",initial:{opacity:0},animate:{opacity:1},transition:{delay:.8},children:[e.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[e.jsx("span",{className:"text-muted-foreground",children:"Accuracy"}),e.jsxs("span",{className:`font-bold ${h?"text-foreground":"text-slate-400"}`,children:[a,"%"]})]}),e.jsx("div",{className:"h-2 bg-muted/30 rounded-full overflow-hidden",children:e.jsx(P.div,{className:`h-full rounded-full ${h?"bg-gradient-to-r from-primary to-accent":"bg-gradient-to-r from-slate-600 to-purple-700/50"}`,initial:{width:0},animate:{width:`${a}%`},transition:{delay:.9,duration:.8,ease:"easeOut"}})})]}),!h&&o&&e.jsxs(P.div,{className:"flex items-center justify-center gap-2 text-sm text-purple-300/70",initial:{y:10,opacity:0},animate:{y:0,opacity:1},transition:{delay:1},children:[e.jsx(P.div,{animate:{rotate:360},transition:{duration:3,repeat:1/0,ease:"linear"},children:e.jsx(wa,{className:"w-4 h-4"})}),e.jsx("span",{children:y()})]}),e.jsx(P.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:1.1},className:"mt-2",children:e.jsx(z,{onClick:i,className:`px-8 ${h?"bg-gradient-to-r from-primary to-accent hover:opacity-90":"bg-gradient-to-r from-slate-700 to-purple-800 hover:from-slate-600 hover:to-purple-700 border border-purple-500/30"}`,variant:h?"default":"outline",size:"lg",children:h?"Continue":"Return to Safety"})})]})},P0={energy_beam:{icon:bt,title:"Star Defender",goal:"Survive endless alien waves!",howToPlay:["Move left/right to dodge attacks","Auto-fire destroys enemies","3 lives - survive as long as possible","Waves get harder - how far can you go?"],statBonus:"body",statIcon:aa},tap_sequence:{icon:ei,title:"Memory Sequence",goal:"How far can your memory take you?",howToPlay:["Watch orbs light up in sequence","Numbers hide - tap from memory!","Wrong tap = lose a life, sequence replays","3 lives total - survive endless levels!"],statBonus:"mind",statIcon:Ds},astral_frequency:{icon:nu,title:"Cosmiq Dash",goal:"Survive the endless cosmic tunnel!",howToPlay:["Swipe or tap â—€ â–¶ to switch lanes","ðŸ”´ RED ASTEROIDS = DANGER! Lose a life","ðŸŸ¡ GOLD CRYSTALS = Points! Collect them","ðŸ”µ CYAN SHIELDS = Protection for 1 hit","Speed increases - survive as long as you can!"],statBonus:"soul",statIcon:be},eclipse_timing:{icon:ng,title:"Stellar Beats",goal:"Hit the notes in rhythm as they fall!",howToPlay:["Watch notes scroll down the 3 lanes","Tap the lane when notes reach the glowing line","Chain combos for multiplied points!"],statBonus:"soul",statIcon:be},starfall_dodge:{icon:rg,title:"Starfall Dodge",goal:"Survive the endless starfall!",howToPlay:["ðŸ“± Tilt or swipe to dodge debris","3 lives - debris hits cost one!","Collect ðŸ’Ž crystals for bonus points","Speed increases - how long can you last?"],statBonus:"body",statIcon:aa},soul_serpent:{icon:bt,title:"Soul Serpent",goal:"Guide the serpent and survive as long as possible!",howToPlay:["Swipe or use D-Pad to change direction","Collect glowing stardust to grow longer","Game ends when you hit yourself!"],statBonus:"body",statIcon:aa},orb_match:{icon:ag,title:"Starburst",goal:"Match orbs before time runs out!",howToPlay:["Touch and drag any orb across the grid","Orbs swap positions as you pass through","Match 3+ of the same color to score","Chain combos for bonus points!"],statBonus:"soul",statIcon:be},galactic_match:{icon:sg,title:"Galactic Match",goal:"Memorize cards, match pairs, survive endless levels!",howToPlay:["All cards revealed at start - MEMORIZE!","Cards hide - match pairs from memory","Wrong match = lose a life (3 total)","Clear level â†’ more cards next level!"],statBonus:"mind",statIcon:Ds},cosmiq_grid:{icon:tg,title:"Cosmiq Grid",goal:"Fill the grid with numbers 1-4!",howToPlay:["Each row must have 1, 2, 3, 4","Each column must have 1, 2, 3, 4","Each 2Ã—2 box must have 1, 2, 3, 4","Tap a cell, then tap a number to place"],statBonus:"mind",statIcon:Ds},stellar_flow:{icon:It,title:"Pathfinder",goal:"Connect matching orbs with flowing paths!",howToPlay:["Drag from one orb to its matching pair","Paths cannot cross each other","Fill every cell to complete the puzzle","Faster times = higher scores!"],statBonus:"soul",statIcon:be}},R0={mind:"hsl(217, 91%, 60%)",body:"hsl(0, 84%, 60%)",soul:"hsl(271, 91%, 65%)"},I0=({gameType:t,onReady:s})=>{const a=P0[t],r=a.icon,i=a.statIcon,o=R0[a.statBonus];return e.jsxs(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"p-6 flex flex-col items-center",children:[e.jsxs(P.div,{className:"relative mb-6",initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200,damping:15},children:[e.jsx(P.div,{className:"absolute inset-0 rounded-full blur-xl opacity-50",style:{backgroundColor:o},animate:{scale:[1,1.3,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx("div",{className:"relative p-5 rounded-full",style:{background:`linear-gradient(135deg, ${o}40, ${o}20)`,border:`2px solid ${o}60`},children:e.jsx(r,{className:"w-12 h-12",style:{color:o,filter:`drop-shadow(0 0 8px ${o})`}})})]}),e.jsx(P.h3,{className:"text-2xl font-bold text-foreground mb-2 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.1},children:a.title}),e.jsx(P.p,{className:"text-muted-foreground text-center mb-6",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.2},children:a.goal}),e.jsxs(P.div,{className:"w-full max-w-xs space-y-3 mb-6",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.3},children:[e.jsx("h4",{className:"text-sm font-semibold text-foreground uppercase tracking-wide text-center",children:"How to Play"}),e.jsx("div",{className:"space-y-2",children:a.howToPlay.map((l,c)=>e.jsxs(P.div,{className:"flex items-start gap-3 text-sm text-muted-foreground",initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:.4+c*.1},children:[e.jsx("span",{className:"flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold text-white",style:{backgroundColor:o},children:c+1}),e.jsx("span",{children:l})]},c))})]}),e.jsxs(P.div,{className:"flex items-center gap-2 mb-6 px-4 py-2 rounded-full",style:{backgroundColor:`${o}15`,border:`1px solid ${o}30`},initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:.5},children:[e.jsx(i,{className:"w-4 h-4",style:{color:o}}),e.jsxs("span",{className:"text-sm font-medium capitalize",style:{color:o},children:[a.statBonus," Stat Bonus"]})]}),e.jsx(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.6},children:e.jsx(z,{onClick:s,size:"lg",className:"px-8 font-bold",style:{background:`linear-gradient(135deg, ${o}, ${o}cc)`,boxShadow:`0 0 20px ${o}50`},children:e.jsx(P.span,{animate:{scale:[1,1.05,1]},transition:{duration:1.5,repeat:1/0},children:"Ready!"})})})]})},Gl=n.lazy(()=>ke(()=>import("./EnergyBeamGame-DOxMRCf9.js"),__vite__mapDeps([0,1,2,3,4,5])).then(t=>({default:t.EnergyBeamGame}))),q0=n.lazy(()=>ke(()=>import("./TapSequenceGame-Y_mi02ZY.js"),__vite__mapDeps([6,1,2,3,4,5,7])).then(t=>({default:t.TapSequenceGame}))),L0=n.lazy(()=>ke(()=>import("./AstralFrequencyGame-CRA64nE1.js"),__vite__mapDeps([8,1,2,3,4])).then(t=>({default:t.AstralFrequencyGame}))),O0=n.lazy(()=>ke(()=>import("./EclipseTimingGame-D4la_ig9.js"),__vite__mapDeps([9,1,2,3,4,5])).then(t=>({default:t.EclipseTimingGame}))),F0=n.lazy(()=>ke(()=>import("./StarfallDodgeGame-ssuF2kJe.js"),__vite__mapDeps([10,1,2,3,4])).then(t=>({default:t.StarfallDodgeGame}))),$0=n.lazy(()=>ke(()=>import("./SoulSerpentGame-80vRXiPh.js"),__vite__mapDeps([11,1,2,3,4])).then(t=>({default:t.SoulSerpentGame}))),B0=n.lazy(()=>ke(()=>import("./OrbMatchGame-5RJgDfJp.js"),__vite__mapDeps([12,1,2,3,4,5,7])).then(t=>({default:t.OrbMatchGame}))),U0=n.lazy(()=>ke(()=>import("./GalacticMatchGame-CX74TnbQ.js"),__vite__mapDeps([13,1,2,3,4,5,7])).then(t=>({default:t.GalacticMatchGame}))),H0=["starfall_dodge","astral_frequency"],z0=12,qm=n.memo(()=>e.jsx(P.div,{className:"absolute top-0 left-0 right-0 z-50 flex justify-center pt-safe-top",initial:{y:-50,opacity:0},animate:{y:0,opacity:1},transition:{type:"spring",stiffness:300,damping:25},children:e.jsx("div",{className:"bg-gradient-to-r from-amber-500 via-yellow-500 to-amber-500 px-6 py-2 rounded-b-xl shadow-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(P.span,{animate:{scale:[1,1.2,1]},transition:{duration:1,repeat:1/0},className:"text-lg",children:"ðŸŽ¯"}),e.jsx("span",{className:"font-bold text-black text-sm uppercase tracking-wider",children:"Practice Round"}),e.jsx(P.span,{animate:{scale:[1,1.2,1]},transition:{duration:1,repeat:1/0,delay:.5},className:"text-lg",children:"ðŸŽ¯"})]})})}));qm.displayName="PracticeBanner";const Lm=n.memo(({gameType:t,onStart:s,onSkip:a})=>{const r={energy_beam:"Star Defender",tap_sequence:"Tap Sequence",astral_frequency:"Cosmiq Dash",eclipse_timing:"Stellar Beats",starfall_dodge:"Starfall Dodge",soul_serpent:"Soul Serpent",orb_match:"Starburst",galactic_match:"Galactic Match"}[t];return e.jsxs(P.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},className:"flex flex-col items-center justify-center p-8 text-center min-h-[400px]",children:[e.jsx(P.div,{className:"mb-6 p-4 rounded-full bg-gradient-to-br from-amber-500/20 to-yellow-500/20 border border-amber-500/30",animate:{boxShadow:["0 0 20px rgba(245, 158, 11, 0.3)","0 0 40px rgba(245, 158, 11, 0.5)","0 0 20px rgba(245, 158, 11, 0.3)"]},transition:{duration:2,repeat:1/0},children:e.jsx("span",{className:"text-5xl",children:"ðŸŽ®"})}),e.jsx("h3",{className:"text-2xl font-bold text-foreground mb-2",children:"Practice Round"}),e.jsxs("p",{className:"text-muted-foreground mb-2",children:["Try ",e.jsx("span",{className:"text-amber-400 font-semibold",children:r})," before the real battle!"]}),e.jsx("p",{className:"text-sm text-muted-foreground/70 mb-8 max-w-xs",children:"This is a quick practice session to warm up. Your score won't count yet!"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(z,{onClick:s,size:"lg",className:"px-8 font-bold bg-gradient-to-r from-amber-500 to-yellow-500 text-black hover:from-amber-600 hover:to-yellow-600",children:[e.jsx(Ks,{className:"w-5 h-5 mr-2"}),"Start Practice"]}),e.jsxs(z,{onClick:a,variant:"ghost",size:"lg",className:"text-muted-foreground hover:text-foreground",children:[e.jsx(Rr,{className:"w-4 h-4 mr-1"}),"Skip"]})]})]})});Lm.displayName="PracticeIntro";const Om=n.memo(({onContinue:t})=>(n.useEffect(()=>{const s=setTimeout(t,2e3);return()=>clearTimeout(s)},[t]),e.jsxs(P.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"flex flex-col items-center justify-center p-8 text-center min-h-[400px]",children:[e.jsx(P.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200,damping:15},className:"mb-6",children:e.jsx("span",{className:"text-6xl",children:"âœ¨"})}),e.jsx(P.h3,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},className:"text-2xl font-bold text-foreground mb-2",children:"Nice Warm-Up!"}),e.jsx(P.p,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"text-muted-foreground mb-6",children:"Now let's do it for real!"}),e.jsxs(P.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},className:"flex items-center gap-2 text-sm text-muted-foreground/70",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Starting real battle..."})]})]})));Om.displayName="PracticeComplete";const Fm=n.memo(()=>e.jsx("div",{className:"pt-2 min-h-[400px] flex items-center justify-center",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground/70",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Loading practice game..."})]})}));Fm.displayName="PracticeLoadingFallback";const Yl=({gameType:t,companionStats:s,onPracticeComplete:a,onSkipPractice:r,isFullscreen:i=!1})=>{const[o,l]=n.useState("intro"),c=i||H0.includes(t),d=n.useCallback(()=>{l("playing")},[]),u=n.useCallback(h=>{l("complete")},[]),p=()=>{const h={companionStats:s,onComplete:u,difficulty:"easy",questIntervalScale:0,isPractice:!0,maxTimer:z0};switch(t){case"energy_beam":return e.jsx(Gl,{...h});case"tap_sequence":return e.jsx(q0,{...h});case"astral_frequency":return e.jsx(L0,{...h});case"eclipse_timing":return e.jsx(O0,{...h});case"starfall_dodge":return e.jsx(F0,{...h});case"soul_serpent":return e.jsx($0,{...h});case"orb_match":return e.jsx(B0,{...h});case"galactic_match":return e.jsx(U0,{...h});default:return e.jsx(Gl,{...h})}};return e.jsx("div",{className:c?"relative h-full":"relative",children:e.jsxs(Re,{mode:"wait",children:[o==="intro"&&e.jsx(Lm,{gameType:t,onStart:d,onSkip:r},"intro"),o==="playing"&&e.jsxs(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:c?"relative h-full":"relative",children:[e.jsx(qm,{}),e.jsx(n.Suspense,{fallback:e.jsx(Fm,{}),children:c?p():e.jsx("div",{className:"pt-2 min-h-[400px] max-h-[calc(100vh-120px)] overflow-y-auto",children:p()})})]},"playing"),o==="complete"&&e.jsx(Om,{onContinue:a},"complete")]})})},K0=dr("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground",celestial:"border-celestial-blue/30 bg-celestial-blue/20 text-celestial-blue",gold:"border-stardust-gold/30 bg-stardust-gold/20 text-stardust-gold",info:"border-celestial-blue/40 bg-celestial-blue/10 text-celestial-blue",reward:"border-stardust-gold/40 bg-stardust-gold/10 text-stardust-gold"}},defaultVariants:{variant:"default"}});function Oe({className:t,variant:s,...a}){return e.jsx("div",{className:I(K0({variant:s}),t),...a})}const Q0={doubt:"from-gray-600 to-slate-800",fear:"from-purple-900 to-indigo-950",chaos:"from-red-600 to-orange-800",stagnation:"from-stone-600 to-zinc-800",anxiety:"from-violet-900 to-purple-950",distraction:"from-cyan-700 to-blue-900",laziness:"from-amber-700 to-orange-900",overthinking:"from-indigo-800 to-slate-900",confusion:"from-pink-800 to-rose-950",vulnerability:"from-emerald-800 to-teal-950",imbalance:"from-rose-700 to-red-900"},W0={doubt:Sr,fear:Sa,chaos:bt,stagnation:As,anxiety:Sr,distraction:be,laziness:As,overthinking:Sr,confusion:bt,vulnerability:As,imbalance:bt},G0=({context:t,onBeginBattle:s,onCancel:a})=>{const[r,i]=n.useState("lore"),o=W0[t.bossTheme]||Sa,l=Q0[t.bossTheme]||"from-slate-900 to-black";return n.useEffect(()=>{const c=setTimeout(()=>i("intel"),3e3),d=setTimeout(()=>i("ready"),6e3);return()=>{clearTimeout(c),clearTimeout(d)}},[]),e.jsx(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-background/95 backdrop-blur-md",children:e.jsxs("div",{className:"max-w-lg w-full mx-4",children:[e.jsxs(Re,{mode:"wait",children:[r==="lore"&&e.jsxs(P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"text-center space-y-6",children:[e.jsx(P.div,{animate:{scale:[1,1.1,1]},transition:{duration:2,repeat:1/0},children:e.jsx("div",{className:I("w-24 h-24 mx-auto rounded-full flex items-center justify-center","bg-gradient-to-br shadow-2xl",l),children:e.jsx(o,{className:"w-12 h-12 text-white/80"})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Oe,{variant:"destructive",className:"text-xs",children:"Final Confrontation"}),e.jsx("h2",{className:"text-3xl font-bold",children:t.bossName}),e.jsxs("p",{className:"text-sm text-muted-foreground italic",children:['"',t.bookTitle,'"']})]}),e.jsx("p",{className:"text-sm text-foreground/80 leading-relaxed",children:t.bossLore})]},"lore"),r==="intel"&&e.jsxs(P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs(Oe,{variant:"outline",className:"mb-2",children:[e.jsx(Qo,{className:"w-3 h-3 mr-1"}),"Intel Gathered"]}),e.jsx("h3",{className:"text-xl font-semibold",children:"Your Journey Has Revealed..."})]}),e.jsxs(Xe,{className:"p-4 space-y-3 bg-primary/5 border-primary/20",children:[e.jsxs("h4",{className:"font-semibold text-sm flex items-center gap-2",children:[e.jsx(be,{className:"w-4 h-4 text-primary"}),"Weakness Hints"]}),e.jsx("ul",{className:"space-y-2",children:t.weaknessHints.map((c,d)=>e.jsxs(P.li,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:d*.3},className:"text-sm text-foreground/80 flex items-start gap-2",children:[e.jsx(Mt,{className:"w-4 h-4 text-yellow-500 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:c})]},d))})]}),t.prophecyLines.length>0&&e.jsxs(Xe,{className:"p-4 space-y-3 bg-accent/5 border-accent/20",children:[e.jsxs("h4",{className:"font-semibold text-sm flex items-center gap-2",children:[e.jsx(Sr,{className:"w-4 h-4 text-accent"}),"Prophecy Fragments"]}),e.jsx("div",{className:"space-y-2",children:t.prophecyLines.map((c,d)=>e.jsxs(P.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5+d*.2},className:"text-sm italic text-foreground/70",children:['"',c,'"']},d))})]})]},"intel"),r==="ready"&&e.jsxs(P.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:1.1},className:"text-center space-y-6",children:[e.jsx(P.div,{animate:{boxShadow:["0 0 20px hsl(var(--destructive) / 0.3)","0 0 40px hsl(var(--destructive) / 0.6)","0 0 20px hsl(var(--destructive) / 0.3)"]},transition:{duration:2,repeat:1/0},className:I("w-32 h-32 mx-auto rounded-full flex items-center justify-center","bg-gradient-to-br",l),children:e.jsx(ig,{className:"w-16 h-16 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Face Your Destiny"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["All your preparations have led to this moment.",e.jsx("br",{}),"Are you ready to complete your story?"]})]}),e.jsxs("div",{className:"flex gap-3 justify-center",children:[e.jsx(z,{variant:"outline",onClick:a,children:"Not Yet"}),e.jsxs(z,{onClick:s,className:"bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700",children:["Begin Battle",e.jsx(Dt,{className:"w-4 h-4 ml-1"})]})]})]},"ready")]}),r!=="ready"&&e.jsx(P.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:1},className:"mt-8 text-center",children:e.jsx(z,{variant:"ghost",size:"sm",onClick:()=>i("ready"),className:"text-muted-foreground",children:"Skip to Battle â†’"})})]})})},Y0=n.memo(function({currentHP:s,maxHP:a,isPlayer:r,label:i,showNumbers:o=!0}){const[l,c]=n.useState(s),[d,u]=n.useState(!1),p=Math.max(0,s/a*100),h=s<=0,f=p<25,m=p<10;n.useEffect(()=>{if(s!==l){u(!0);const b=setTimeout(()=>{c(s),u(!1)},300);return()=>clearTimeout(b)}},[s,l]);const g=()=>h?"bg-gray-500":r?m?"bg-red-600 animate-pulse":f?"bg-orange-500":"bg-green-500":m?"bg-purple-400":f?"bg-purple-500":"bg-purple-600",y=()=>h?"":r?m?"shadow-[0_0_10px_rgba(220,38,38,0.6)]":f?"shadow-[0_0_8px_rgba(249,115,22,0.5)]":"shadow-[0_0_6px_rgba(34,197,94,0.4)]":"shadow-[0_0_8px_rgba(147,51,234,0.5)]";return e.jsxs("div",{className:`flex items-center gap-2 ${r?"flex-row":"flex-row-reverse"}`,children:[e.jsx("div",{className:`flex-shrink-0 ${h?"opacity-50":""}`,children:h?e.jsx(Sa,{className:"w-4 h-4 text-gray-400"}):e.jsx(aa,{className:`w-4 h-4 ${r?"text-green-500":"text-purple-500"} ${f&&!h?"animate-pulse":""}`,fill:r?"rgb(34,197,94)":"rgb(147,51,234)"})}),e.jsxs("div",{className:"flex-1 flex flex-col gap-0.5",children:[i&&e.jsx("span",{className:`text-[10px] font-medium ${r?"text-left":"text-right"} text-muted-foreground truncate`,children:i}),e.jsxs("div",{className:`relative h-4 rounded-full overflow-hidden bg-muted/50 border border-border/50 ${y()}`,children:[e.jsx(Re,{children:f&&!h&&r&&e.jsx(P.div,{initial:{opacity:0},animate:{opacity:[.3,.6,.3]},exit:{opacity:0},transition:{duration:1,repeat:1/0},className:"absolute inset-0 bg-red-500/20"})}),e.jsx(P.div,{className:`absolute inset-y-0 ${r?"left-0":"right-0"} ${g()}`,initial:!1,animate:{width:`${p}%`},transition:{duration:.4,ease:[.4,0,.2,1]},children:e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-white/30 to-transparent"})}),e.jsx(Re,{children:d&&s<l&&e.jsx(P.div,{initial:{opacity:.8},animate:{opacity:0},exit:{opacity:0},transition:{duration:.3},className:"absolute inset-0 bg-red-500/40"})})]})]}),o&&e.jsxs("div",{className:`flex-shrink-0 min-w-[50px] ${r?"text-right":"text-left"}`,children:[e.jsx(P.span,{initial:{scale:1.2,color:s<l?"#ef4444":"#22c55e"},animate:{scale:1,color:"inherit"},className:"text-xs font-mono font-bold text-foreground",children:Math.max(0,s)},s),e.jsxs("span",{className:"text-xs font-mono text-muted-foreground",children:["/",a]})]})]})});n.memo(function({event:s,position:a="adversary"}){const[r,i]=n.useState(0);if(n.useEffect(()=>{s&&i(d=>d+1)},[s]),!s)return null;const o=s.target==="player",c=typeof a=="object"?a:a==="player"||o?{x:60,y:20}:{x:240,y:20};return e.jsx(Re,{mode:"popLayout",children:e.jsx(P.div,{initial:{opacity:1,y:0,scale:.5,x:c.x},animate:{opacity:0,y:-40,scale:1.2,x:c.x+(Math.random()-.5)*20},exit:{opacity:0},transition:{duration:.8,ease:"easeOut"},className:"absolute pointer-events-none z-50",style:{top:c.y},children:e.jsxs("span",{className:`
          text-lg font-bold font-mono
          ${o?"text-red-500":"text-yellow-400"}
          drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)]
        `,children:[o?"-":"+",s.amount]})},r)})});const Vl=n.memo(function({damageEvents:s,className:a=""}){const[r,i]=n.useState([]);return n.useEffect(()=>{if(s.length===0)return;const o=s[s.length-1],l=`${Date.now()}-${Math.random()}`,d=o.target==="player"?50:250,p={id:l,event:o,x:d+(Math.random()-.5)*30,y:30+(Math.random()-.5)*20};i(f=>[...f,p]);const h=setTimeout(()=>{i(f=>f.filter(m=>m.id!==l))},1e3);return()=>clearTimeout(h)},[s.length]),e.jsx("div",{className:`absolute inset-0 pointer-events-none overflow-hidden ${a}`,children:e.jsx(Re,{children:r.map(o=>e.jsx(P.div,{initial:{opacity:1,y:o.y,x:o.x,scale:.5},animate:{opacity:0,y:o.y-50,x:o.x+(Math.random()-.5)*20,scale:1.3},exit:{opacity:0},transition:{duration:.9,ease:"easeOut"},className:"absolute pointer-events-none",children:e.jsxs("span",{className:`
              text-xl font-black font-mono
              ${o.event.target==="player"?"text-red-500 drop-shadow-[0_0_8px_rgba(239,68,68,0.6)]":"text-yellow-400 drop-shadow-[0_0_8px_rgba(250,204,21,0.6)]"}
            `,children:[o.event.target==="player"?"-":"+",o.event.amount]})},o.id))})})});n.memo(function({imageUrl:s,name:a,hpPercent:r,isDefeated:i,size:o="md"}){const l=n.useMemo(()=>i?4:r<=25?3:r<=50?2:r<=75?1:0,[r,i]),c={sm:"w-12 h-12",md:"w-14 h-14",lg:"w-20 h-20"},d=n.useMemo(()=>{const u=[];return l>=1&&u.push("M50,0 L45,30 L55,50 L48,80 L52,100"),l>=2&&(u.push("M0,40 L25,45 L50,50 L75,48 L100,45"),u.push("M30,0 L35,25 L28,60")),l>=3&&(u.push("M70,0 L65,35 L72,70 L68,100"),u.push("M0,70 L30,65 L60,72 L100,68"),u.push("M20,100 L25,70 L18,40")),u},[l]);return e.jsxs("div",{className:`relative ${c[o]}`,children:[e.jsxs(P.div,{className:`
          relative w-full h-full rounded-lg overflow-hidden
          border-2 border-purple-500/50
          ${i?"grayscale":""}
        `,animate:i?{scale:[1,.95,1.05,0],rotate:[0,-5,5,0],opacity:[1,1,1,0]}:{},transition:{duration:.6},children:[s?e.jsx("img",{src:s,alt:a,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-purple-950 via-purple-900 to-purple-700 flex items-center justify-center",children:e.jsx(Sa,{className:"w-7 h-7 text-purple-200/85"})}),e.jsx(P.div,{className:"absolute inset-0 bg-red-900",initial:{opacity:0},animate:{opacity:i?.8:Math.max(0,(100-r)/200)},transition:{duration:.3}}),e.jsx(Re,{children:r<=25&&!i&&e.jsx(P.div,{initial:{opacity:0},animate:{opacity:[.2,.4,.2]},exit:{opacity:0},transition:{duration:1.5,repeat:1/0},className:"absolute inset-0 bg-red-500/30"})})]}),e.jsx(Re,{children:l>0&&e.jsxs(P.svg,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 w-full h-full pointer-events-none",viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[d.map((u,p)=>e.jsx(P.path,{d:u,fill:"none",stroke:"rgba(0,0,0,0.8)",strokeWidth:"2",strokeLinecap:"round",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:.3,delay:p*.1,ease:"easeOut"}},p)),d.map((u,p)=>e.jsx(P.path,{d:u,fill:"none",stroke:"rgba(255,255,255,0.3)",strokeWidth:"1",strokeLinecap:"round",transform:"translate(1, 1)",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.5},transition:{duration:.3,delay:p*.1+.1,ease:"easeOut"}},`highlight-${p}`))]})}),e.jsx(Re,{children:i&&e.jsx(e.Fragment,{children:Array.from({length:8}).map((u,p)=>e.jsx(P.div,{className:"absolute w-3 h-3 bg-purple-500/60 rounded-sm",initial:{x:"50%",y:"50%",scale:1,opacity:1},animate:{x:`${50+(Math.random()-.5)*200}%`,y:`${50+(Math.random()-.5)*200}%`,scale:0,opacity:0,rotate:Math.random()*360},transition:{duration:.8,delay:.2+p*.05,ease:"easeOut"}},p))})})]})});const V0=n.memo(function({imageUrl:s,name:a,hpPercent:r,isDefeated:i}){const o=n.useMemo(()=>i?4:r<=25?3:r<=50?2:r<=75?1:0,[r,i]),l=n.useMemo(()=>{const c=[];return o>=1&&(c.push("M50,0 L48,25 L52,50 L47,75 L50,100"),c.push("M25,0 L28,30 L22,60")),o>=2&&(c.push("M0,50 L20,48 L40,52 L60,49 L80,51 L100,50"),c.push("M75,0 L72,35 L78,70")),o>=3&&(c.push("M10,0 L15,40 L8,80 L12,100"),c.push("M90,0 L85,45 L92,90"),c.push("M0,25 L30,28 L60,24 L100,27"),c.push("M0,75 L25,72 L50,78 L75,74 L100,76")),c},[o]);return e.jsxs("div",{className:"relative w-full aspect-[2.5/1] max-h-[140px] overflow-hidden rounded-xl",children:[e.jsxs(P.div,{className:`
          relative w-full h-full
          ${i?"grayscale":""}
        `,animate:i?{scale:[1,.98,1.02,.95],opacity:[1,1,.8,0]}:{},transition:{duration:.8},children:[s?e.jsx("img",{src:s,alt:a,className:"w-full h-full object-cover object-center"}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-purple-950 via-purple-900 to-purple-700 flex items-center justify-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-1.5",children:[e.jsx(Sa,{className:"w-10 h-10 text-purple-200/85"}),e.jsx("span",{className:"text-[10px] font-semibold uppercase tracking-[0.2em] text-purple-200/70",children:"Adversary"})]})}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-transparent to-background/40"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-background/30 via-transparent to-background/30"}),e.jsx(P.div,{className:"absolute inset-0 bg-red-900",initial:{opacity:0},animate:{opacity:i?.7:Math.max(0,(100-r)/150)},transition:{duration:.3}}),e.jsx(Re,{children:r<=25&&!i&&e.jsx(P.div,{initial:{opacity:0},animate:{opacity:[.1,.3,.1]},exit:{opacity:0},transition:{duration:1.2,repeat:1/0},className:"absolute inset-0 bg-red-500/40"})}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"radial-gradient(ellipse at center, transparent 20%, rgba(0,0,0,0.5) 100%)"}})]}),e.jsx(Re,{children:o>0&&e.jsxs(P.svg,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 w-full h-full pointer-events-none",viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[l.map((c,d)=>e.jsx(P.path,{d:c,fill:"none",stroke:"rgba(0,0,0,0.9)",strokeWidth:"1.5",strokeLinecap:"round",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:.4,delay:d*.08,ease:"easeOut"}},d)),l.map((c,d)=>e.jsx(P.path,{d:c,fill:"none",stroke:"rgba(255,255,255,0.25)",strokeWidth:"0.8",strokeLinecap:"round",transform:"translate(0.5, 0.5)",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.6},transition:{duration:.4,delay:d*.08+.1,ease:"easeOut"}},`highlight-${d}`))]})}),e.jsx(Re,{children:i&&e.jsx(e.Fragment,{children:Array.from({length:12}).map((c,d)=>e.jsx(P.div,{className:"absolute w-3 h-3 bg-purple-500/50 rounded-sm",style:{left:`${d%4*25+12}%`,top:`${Math.floor(d/4)*33+16}%`},initial:{scale:1,opacity:1},animate:{x:(Math.random()-.5)*150,y:(Math.random()-.5)*100+50,scale:0,opacity:0,rotate:Math.random()*360},transition:{duration:.7,delay:.1+d*.03,ease:"easeOut"}},d))})}),e.jsx("div",{className:"absolute inset-0 rounded-xl border border-purple-500/30 pointer-events-none"}),e.jsx(P.div,{className:"absolute inset-0 rounded-xl pointer-events-none",animate:r<=25&&!i?{boxShadow:["inset 0 0 15px rgba(239,68,68,0.2)","inset 0 0 25px rgba(239,68,68,0.4)","inset 0 0 15px rgba(239,68,68,0.2)"]}:{boxShadow:"inset 0 0 15px rgba(147,51,234,0.2)"},transition:{duration:1.5,repeat:1/0}})]})}),Xl=n.memo(function({battleState:s,adversaryImageUrl:a,adversaryName:r,showScreenShake:i=!1,battleTimeLeft:o,battleTimeTotal:l}){const c=s.playerHPPercent<25;return e.jsxs(P.div,{className:"relative w-full",animate:i?{x:[0,-3,3,-2,2,0],y:[0,2,-2,1,-1,0]}:{},transition:{duration:.3},children:[e.jsx(Re,{children:c&&!s.isPlayerDefeated&&e.jsx(P.div,{initial:{opacity:0},animate:{opacity:[.3,.5,.3]},exit:{opacity:0},transition:{duration:2,repeat:1/0},className:"fixed inset-0 pointer-events-none z-40",style:{background:"radial-gradient(ellipse at center, transparent 40%, rgba(220,38,38,0.4) 100%)"}})}),e.jsx("div",{className:"w-full bg-gradient-to-b from-background via-background/95 to-transparent",style:{paddingTop:"max(env(safe-area-inset-top, 0px), 8px)",paddingLeft:"env(safe-area-inset-left, 0px)",paddingRight:"env(safe-area-inset-right, 0px)"},children:e.jsxs("div",{className:"px-2 pt-0.5 pb-1",children:[e.jsx(V0,{imageUrl:a,name:r,hpPercent:s.adversaryHPPercent,isDefeated:s.isAdversaryDefeated}),e.jsxs(P.div,{className:"flex items-center justify-center gap-1.5 mt-1 mb-0.5",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{delay:.2},children:[e.jsx("span",{className:"text-purple-400 text-xs",children:"âš”ï¸"}),e.jsx("h2",{className:"text-sm font-bold text-purple-300 tracking-wide uppercase truncate max-w-[200px]",children:r}),e.jsx("span",{className:"text-purple-400 text-xs",children:"âš”ï¸"})]}),e.jsx("div",{className:"w-full px-1",children:e.jsx(Y0,{currentHP:s.adversaryHP,maxHP:s.adversaryMaxHP,isPlayer:!1,showNumbers:!0})}),o!==void 0&&l!==void 0&&e.jsx("div",{className:"w-full px-1 mt-1",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-1.5 bg-muted/30 rounded-full overflow-hidden",children:e.jsx(P.div,{className:"h-full rounded-full",style:{width:`${o/l*100}%`,background:o<=10?"linear-gradient(90deg, #ef4444, #f87171)":"linear-gradient(90deg, hsl(var(--primary)), hsl(var(--accent)))"},animate:o<=10?{opacity:[1,.6,1]}:{},transition:{duration:.5,repeat:1/0}})}),e.jsxs("span",{className:`text-xs font-mono font-bold min-w-[32px] text-right ${o<=10?"text-red-400":"text-muted-foreground"}`,children:[o,"s"]})]})})]})})]})}),ci=()=>{const{user:t}=_e(),s=n.useRef(new Set),a=n.useCallback(async b=>{if(t&&!s.current.has(b.type)){s.current.add(b.type);try{const{data:w,error:x}=await k.from("achievements").upsert({user_id:t.id,achievement_type:b.type,title:b.title,description:b.description,icon:b.icon,tier:b.tier,metadata:b.metadata||{}},{onConflict:"user_id,achievement_type",ignoreDuplicates:!0}).select("id").maybeSingle();w&&!x&&(V.success("ðŸ† Achievement Unlocked!",{description:b.title}),xy())}catch(w){console.error("Error awarding achievement:",w)}}},[t]),r=async b=>{b===3?await a({type:"three_day_streak",title:"Getting Started",description:"3 days of consistency",icon:"flame",tier:"silver",metadata:{streak:b,pepTalkDuration:"2-3 min",pepTalkMessage:"You're showing effort today. Keep that energy.",pepTalkCategory:"encouragement"}}):b===7?await a({type:"week_streak",title:"Week of Discipline",description:"7 days of unwavering commitment",icon:"trophy",tier:"gold",metadata:{streak:b,pepTalkDuration:"4-5 min",pepTalkMessage:"You're not who you were last week. You're growing.",pepTalkCategory:"discipline"}}):b===14?await a({type:"two_week_streak",title:"Fortnight Fighter",description:"14 days of unwavering discipline",icon:"trophy",tier:"gold",metadata:{streak:b,pepTalkDuration:"4-5 min",pepTalkMessage:"Two weeks of showing up. That's the discipline talking.",pepTalkCategory:"discipline"}}):b===30&&await a({type:"month_streak",title:"Transformed",description:"30 days - You're not the same person anymore",icon:"crown",tier:"platinum",metadata:{streak:b,pepTalkDuration:"7-10 min",pepTalkMessage:"A month ago, you started. Today, you're different. This is transformation.",pepTalkCategory:"breakthrough"}})},i=async b=>{b===1?await a({type:"first_challenge",title:"Challenge Accepted",description:"Completed your first challenge",icon:"target",tier:"bronze"}):b===5?await a({type:"challenge_veteran",title:"Challenge Veteran",description:"Completed 5 challenges",icon:"target",tier:"silver"}):b===10&&await a({type:"challenge_master",title:"Challenge Master",description:"Completed 10 challenges",icon:"target",tier:"gold"})},o=async b=>{await a({habit:{type:"first_habit",title:"First Step",description:"Created your first habit",icon:"check",tier:"bronze",metadata:{pepTalkDuration:"1 min",pepTalkMessage:"Welcome. Every journey starts with one step.",pepTalkCategory:"welcome"}},checkin:{type:"first_checkin",title:"Good Morning",description:"Completed your first check-in",icon:"sunrise",tier:"bronze",metadata:{pepTalkDuration:"1 min",pepTalkMessage:"You showed up today. That matters.",pepTalkCategory:"welcome"}},peptalk:{type:"first_peptalk",title:"Listening",description:"Listened to your first pep talk",icon:"headphones",tier:"bronze",metadata:{pepTalkDuration:"1 min",pepTalkMessage:"You're here. You're listening. Keep going.",pepTalkCategory:"welcome"}},mission:{type:"first_mission",title:"Mission Accepted",description:"Completed your first mission",icon:"target",tier:"bronze",metadata:{pepTalkDuration:"1 min",pepTalkMessage:"One mission down. This is how change happens.",pepTalkCategory:"welcome"}}}[b])},l=async b=>{b===3?await a({type:"companion_stage_3",title:"Growing Together",description:"Your companion reached Stage 3",icon:"sparkles",tier:"silver",metadata:{stage:b,pepTalkDuration:"2-3 min",pepTalkMessage:"Watch how your companion changes as you do.",pepTalkCategory:"growth"}}):b===5?await a({type:"companion_stage_5",title:"Deep Bond",description:"Your companion reached Stage 5",icon:"sparkles",tier:"gold",metadata:{stage:b,pepTalkDuration:"4-5 min",pepTalkMessage:"Stage 5. You're both different now.",pepTalkCategory:"discipline"}}):b===10?await a({type:"companion_stage_10",title:"Evolution Master",description:"Your companion reached Stage 10",icon:"star",tier:"gold",metadata:{stage:b,pepTalkDuration:"4-5 min",pepTalkMessage:"Stage 10. This is discipline and consistency made visible.",pepTalkCategory:"discipline"}}):b===15?await a({type:"companion_stage_15",title:"Transcendent Bond",description:"Your companion reached Stage 15",icon:"crown",tier:"platinum",metadata:{stage:b,pepTalkDuration:"7-10 min",pepTalkMessage:"You've come so far together. This bond is real.",pepTalkCategory:"breakthrough"}}):b===20&&await a({type:"companion_max",title:"Legendary Bond",description:"Your companion reached maximum evolution",icon:"crown",tier:"platinum",metadata:{stage:b,pepTalkDuration:"7-10 min",pepTalkMessage:"Stage 20. You didn't just evolve your companion. You evolved yourself.",pepTalkCategory:"breakthrough"}})},c=async(b,w)=>{const x=b.charAt(0).toUpperCase()+b.slice(1);w===5?await a({type:`${b}_5`,title:`${x} Awakening`,description:`${x} attribute reached 5`,icon:"zap",tier:"silver",metadata:{attribute:b,value:w,pepTalkDuration:"2-3 min",pepTalkMessage:`Your ${b} is growing. You're feeling it, aren't you?`,pepTalkCategory:"growth"}}):w===10?await a({type:`${b}_10`,title:`${x} Mastery`,description:`${x} attribute reached 10`,icon:"zap",tier:"gold",metadata:{attribute:b,value:w,pepTalkDuration:"4-5 min",pepTalkMessage:`${x} at 10. This is what discipline looks like.`,pepTalkCategory:"discipline"}}):w===15&&await a({type:`${b}_15`,title:`${x} Transcendence`,description:`${x} attribute reached 15`,icon:"crown",tier:"platinum",metadata:{attribute:b,value:w,pepTalkDuration:"7-10 min",pepTalkMessage:`${x} at 15. You're operating at a different level now.`,pepTalkCategory:"breakthrough"}})},d=async b=>{b>=50&&await a({type:"total_attributes_50",title:"Balanced Transformation",description:"Total attributes reached 50",icon:"crown",tier:"platinum",metadata:{total:b,pepTalkDuration:"7-10 min",pepTalkMessage:"Mind, Body, Soul - all growing together. This is true transformation.",pepTalkCategory:"breakthrough"}})},u=async b=>{b===3?await a({type:"peptalk_listener_3",title:"Active Listener",description:"Listened to 3 pep talks this week",icon:"headphones",tier:"silver",metadata:{count:b,pepTalkDuration:"2-3 min",pepTalkMessage:"You're not just listening. You're absorbing.",pepTalkCategory:"encouragement"}}):b===10&&await a({type:"peptalk_listener_10",title:"Devoted Student",description:"Listened to 10 pep talks",icon:"headphones",tier:"gold",metadata:{count:b,pepTalkDuration:"4-5 min",pepTalkMessage:"Ten talks. You're committed to this growth.",pepTalkCategory:"discipline"}})},p=async()=>{await a({type:"all_tasks_complete",title:"Perfect Day",description:"Completed every task today",icon:"check-circle",tier:"silver",metadata:{pepTalkDuration:"2-3 min",pepTalkMessage:"You did it all today. Every. Single. Thing.",pepTalkCategory:"encouragement"}})},h=async b=>{await a({type:`story_chapter_${b}`,title:`Chapter ${b} Complete`,description:`Finished story chapter ${b}`,icon:"book",tier:"gold",metadata:{chapter:b,pepTalkDuration:"4-5 min",pepTalkMessage:"Another chapter. Your story is unfolding.",pepTalkCategory:"discipline"}})},f=async()=>{await a({type:"full_storyline",title:"Story Complete",description:"Completed the entire companion storyline",icon:"crown",tier:"platinum",metadata:{pepTalkDuration:"7-10 min",pepTalkMessage:"The full story. From beginning to now. Look at how far you've come.",pepTalkCategory:"breakthrough"}})},m=async()=>{await a({type:"comeback_arc",title:"The Comeback",description:"Returned stronger after a break",icon:"crown",tier:"platinum",metadata:{pepTalkDuration:"7-10 min",pepTalkMessage:"You came back. That's what matters. Welcome home.",pepTalkCategory:"breakthrough"}})},g=n.useCallback(async()=>{await a({type:"arcade_explorer",title:"Arcade Explorer",description:"Discovered the hidden Astral Arcade",icon:"gamepad-2",tier:"silver",metadata:{pepTalkMessage:"You found the secret arcade. Nice work, explorer.",pepTalkCategory:"discovery"}})},[a]),y=n.useCallback(async(b,w)=>{const x={distraction:{prefix:"Focus",icon:"target"},stagnation:{prefix:"Momentum",icon:"waves"},anxiety:{prefix:"Serenity",icon:"heart"},doubt:{prefix:"Confidence",icon:"shield"},chaos:{prefix:"Order",icon:"zap"},laziness:{prefix:"Drive",icon:"flame"},overthinking:{prefix:"Clarity",icon:"brain"},fear:{prefix:"Courage",icon:"shield"},confusion:{prefix:"Wisdom",icon:"sparkles"},vulnerability:{prefix:"Resilience",icon:"gem"},imbalance:{prefix:"Harmony",icon:"scale"}},{prefix:v,icon:j}=x[b];let T=!1,S=null;return w===3?await a({type:`astral_${b}_3`,title:`${v} Initiate`,description:`Defeated 3 ${b} adversaries`,icon:j,tier:"bronze",metadata:{theme:b,count:3}}):w===10?(await a({type:`astral_${b}_10`,title:`${v} Warrior`,description:`Defeated 10 ${b} adversaries`,icon:j,tier:"silver",metadata:{theme:b,count:10}}),T=!0,S="rare"):w===25?(await a({type:`astral_${b}_25`,title:`${v} Champion`,description:`Defeated 25 ${b} adversaries`,icon:j,tier:"gold",metadata:{theme:b,count:25}}),T=!0,S="epic"):w===50&&(await a({type:`astral_${b}_50`,title:`${v} Transcendent`,description:`Defeated 50 ${b} adversaries`,icon:j,tier:"platinum",metadata:{theme:b,count:50}}),T=!0,S="legendary"),{shouldRollLoot:T,lootTier:S}},[a]);return{awardAchievement:a,checkStreakAchievements:r,checkChallengeAchievements:i,checkFirstTimeAchievements:o,checkCompanionAchievements:l,checkAttributeAchievements:c,checkTotalAttributesAchievement:d,checkPepTalkListeningAchievements:u,checkDailyCompletionAchievement:p,checkStoryChapterAchievement:h,checkFullStorylineAchievement:f,checkComebackAchievement:m,checkArcadeDiscovery:g,checkAdversaryDefeatAchievements:y}},X0=()=>{const{data:t,isLoading:s,error:a}=Ee({queryKey:["evolution-thresholds"],queryFn:async()=>{const{data:c,error:d}=await k.from("evolution_thresholds").select("*").order("stage",{ascending:!0});if(d)throw d;return c},staleTime:1/0,gcTime:1/0}),r=t?.reduce((c,d)=>(c[d.stage]=d.xp_required,c),{}),i=c=>r?.[c]??null;return{thresholds:t,thresholdMap:r,isLoading:s,error:a,getThreshold:i,shouldEvolve:(c,d)=>{const u=i(c+1);return u!==null&&d>=u},getStageName:c=>t?.find(d=>d.stage===c)?.stage_name??`Stage ${c}`}},Ii={EASY:12,MEDIUM:16,HARD:22},qi={EASY:10,MEDIUM:14,HARD:20},J0={HABIT_COMPLETE:8,ALL_HABITS_COMPLETE:20,CHALLENGE_COMPLETE:25,WEEKLY_CHALLENGE:60,PEP_TALK_LISTEN:8,CHECK_IN:4,EVENING_REFLECTION:4,WEEKLY_RECAP_VIEWED:5,STREAK_MILESTONE:15,WELCOME_BACK_BONUS:25},Z0={XP_PER_DAY:10},Cs={SESSION_COMPLETE:20,PERFECT_FOCUS_BONUS:5,DAILY_SESSION_CAP:4,CAPPED_SESSION_XP:3},Li={SUBTASK_COMPLETE:3,ALL_SUBTASKS_BONUS:10},fn={TOP_THREE_COMPLETE:15,ALL_TOP_THREE_BONUS:30,URGENT_IMPORTANT:10,NOT_URGENT_IMPORTANT:12},gn={PROCESS_INBOX:2,INBOX_ZERO:10,VOICE_CAPTURE:3},vr={WEEKLY_REVIEW:25,DAILY_REVIEW:8,HIGH_PRODUCTIVITY_DAY:20,PERFECT_DAY:35},Oi={ON_TIME_COMPLETION:5,CONTEXT_MATCH:3},pa={REGULAR:20,POSTCARD:35,PHASE_COMPLETE:45,EPIC_COMPLETE:120},Eo=1.5;function eb(t){return{easy:Ii.EASY,medium:Ii.MEDIUM,hard:Ii.HARD}[t]}function tb(t){return t<=4?1:t===5?.75:t===6?.5:t<=8?.25:(t<=10,.1)}function Fi(t,s){const a=eb(t),r=tb(s);return Math.round(a*r)}async function $m(t,s={}){const{onRetry:a,onValidating:r}=s;r?.();const{data:i,error:o}=await k.functions.invoke("generate-companion-image",{body:{...t,...typeof s.maxRetries=="number"?{maxInternalRetries:s.maxRetries}:{}}});if(o){const u=o.message||String(o);throw console.error("[Validation] Image generation error:",u),u.includes("INSUFFICIENT_CREDITS")||u.includes("Insufficient AI credits")?new Error("The companion creation service is temporarily unavailable. Please contact support."):u.includes("RATE_LIMITED")||u.includes("busy")?new Error("The service is currently busy. Please wait a moment and try again."):u.includes("AI_TIMEOUT")||u.includes("GENERATION_TIMEOUT")||u.toLowerCase().includes("timed out")?new Error("GENERATION_TIMEOUT: Companion creation is taking longer than expected. Please try again."):u.includes("NO_AUTH_HEADER")||u.includes("INVALID_AUTH")?new Error("Your session has expired. Please refresh the page and try again."):new Error(u||"Failed to generate companion image. Please try again.")}if(!i?.imageUrl)throw console.error("[Validation] No image URL in result:",i),new Error("Unable to create your companion's image. Please try again.");const l=i.qualityScore,c=l?.retryCount||0;c>0&&a&&a(c);const d=l?l.overallScore>=70||!l.shouldRetry:!0;return console.log(`[Validation] Complete - Score: ${l?.overallScore||"N/A"}, Retries: ${c}, Passed: ${d}`),{imageUrl:i.imageUrl,validationPassed:d,retryCount:c}}const sb=["failed to send a request to the edge function","failed to fetch","network","timeout","timed out","econnreset","connection","fetcherror","functionsfetcherror"];function Zs(t){return typeof t=="string"&&t.trim().length>0?t:void 0}function Jl(t){return typeof t=="number"&&Number.isFinite(t)?t:void 0}function ab(){return typeof navigator<"u"?navigator.onLine===!1:!1}function Bm(t){if(!t||typeof t!="object"||!("context"in t))return;const s=t.context;return s instanceof Response?s:void 0}function rb(t){const s=Bm(t);if(s)return s.status;if(t&&typeof t=="object"){const a=t.status;if(typeof a=="number")return a}}function nb(t){if(!t)return!1;const s=t.toLowerCase();return sb.some(a=>s.includes(a))}function ib(t){const{name:s,message:a,status:r,backendMessage:i,isOffline:o}=t;if(o)return"network";if(r===401||r===403)return"auth";if(r===429)return"rate_limit";const l=(s??"").toLowerCase(),c=(a??"").toLowerCase(),d=(i??"").toLowerCase(),u=`${l} ${c} ${d}`;return l.includes("functionsrelayerror")||u.includes("relay error invoking the edge function")?"relay":nb(u)?"network":typeof r=="number"&&r>=400?"http":"unknown"}async function Ur(t){const s=t&&typeof t=="object"?Zs(t.name):void 0,a=t&&typeof t=="object"?Zs(t.message):t instanceof Error?t.message:void 0,r=t&&typeof t=="object"?Zs(t.code):void 0,i=rb(t),o=ab();let l;const c=Bm(t);if(c)try{const f=await c.clone().json();if(f&&typeof f=="object"&&!Array.isArray(f)){const m=f,g=Zs(m.message),y=Zs(m.error),b=Zs(m.code),w=Jl(m.upstream_status)??Jl(m.upstreamStatus),x=Zs(m.upstream_error)??Zs(m.upstreamError);(g||y||b||w||x)&&(l={message:g,error:y,code:b,upstreamStatus:w,upstreamError:x})}}catch{}const d=l?.message??l?.error,u=l?.upstreamStatus,p=l?.upstreamError,h=ib({name:s,message:a,status:i,backendMessage:d,isOffline:o});return{name:s,message:a,status:i,code:r,responsePayload:l,backendMessage:d,upstreamStatus:u,upstreamError:p,isOffline:o,category:h}}function Zl(t){const s=t.toLowerCase();return s.includes("edge function")||s.includes("functionsfetcherror")||s.includes("relay error")||s.includes("failed to send a request")}function ec(t){if(!t)return;const s=t.match(/\b([45]\d{2})\b/);if(!s)return;const a=Number(s[1]);return Number.isFinite(a)?a:void 0}function ob(t){const s=t.code??t.responsePayload?.code;if(!(s==="AUDIO_PIPELINE_FAILED"||s==="AUDIO_GENERATION_FAILED"))return null;const r=ec(t.upstreamError)??ec(t.backendMessage)??t.upstreamStatus;return r===401||r===403?"Voice generation is temporarily unavailable (provider authentication failed). Please try again shortly.":r===402?"Voice generation is temporarily unavailable because provider credits are exhausted.":r===429?"Voice generation is being rate-limited right now. Please wait a minute and try again.":typeof r=="number"&&r>=500?"Voice generation is temporarily unavailable. Please try again in a moment.":typeof t.upstreamError=="string"&&t.upstreamError.toLowerCase().includes("timed out")?"Voice generation timed out. Please try again.":null}function Hr(t,s){const a=s?.action??"complete this action";if(t.isOffline||t.category==="network")return`We couldn't reach the server to ${a}. Check your connection and try again.`;if(t.category==="auth")return`Your session has expired. Please sign in again and try to ${a}.`;if(t.category==="rate_limit")return t.backendMessage??"You're making requests too quickly. Please wait a moment and try again.";if(t.category==="relay"||t.status===408)return"Our servers are temporarily unavailable. Please try again in a moment.";const r=ob(t);return r||(typeof t.status=="number"&&t.status>=500?t.backendMessage&&!Zl(t.backendMessage)?t.backendMessage:"Our servers are temporarily unavailable. Please try again in a moment.":t.category==="http"&&t.backendMessage&&!Zl(t.backendMessage)?t.backendMessage:`Unable to ${a}. Please try again.`)}const ks=J0,Um=t=>["companion",t],lb=async t=>{const{data:s,error:a}=await k.from("user_companion").select("*").eq("user_id",t).maybeSingle();if(a)throw a;return s},cb="XP service is temporarily unavailable. Please try again shortly.",zr=t=>{if(!t)return null;const s=t.toLowerCase().replace(/[^a-z0-9]+/g,"_").replace(/^_+|_+$/g,"");return s.length>0?s:null},db=t=>{if(!t)return!1;if(zr(t.code)==="42883")return!0;const a=[t.message,t.details,t.hint].filter(r=>typeof r=="string"&&r.trim().length>0).join(" ").toLowerCase();return a.includes("award_xp_v2")&&(a.includes("could not find function")||a.includes("does not exist")||a.includes("schema cache")||a.includes("undefined function")||a.includes("function not found"))},Hm=t=>t.includes("not_enough_xp")||t.includes("not enough xp")?{code:"not_enough_xp",message:"Your companion is not ready to evolve yet.",category:"xp"}:t.includes("max_stage_reached")||t.includes("max stage")?{code:"max_stage_reached",message:"Your companion has already reached the maximum stage.",category:"max_stage"}:t.includes("already_evolved")||t.includes("already evolved")?{code:"already_evolved",message:"Your companion already evolved to this stage.",category:"duplicate"}:t.includes("companion_not_found")||t.includes("companion not found")?{code:"companion_not_found",message:"No companion found to evolve.",category:"not_found"}:t.includes("not_authenticated")||t.includes("permission denied")||t.includes("jwt")||t.includes("unauthorized")?{code:"unauthorized",message:"Your session has expired. Please sign in again and try evolving.",category:"auth"}:t.includes("rate_limited")||t.includes("rate limit")||t.includes("too many requests")||t.includes("429")?{code:"rate_limited",message:"Evolution is on cooldown. Please try again in a little while.",category:"rate_limit"}:null,ub=t=>t.includes("request_companion_evolution_job")&&(t.includes("could not find")||t.includes("schema cache"))||t.includes("companion_evolution_jobs")&&t.includes("does not exist")||t.includes("failed to fetch")||t.includes("network")||t.includes("timeout")||t.includes("timed out")||t.includes("temporarily unavailable")||t.includes("relay")||t.includes("service_unavailable"),mb=t=>{const s=[t?.code,t?.message,t?.error].filter(Boolean).join(" ").toLowerCase();return s.includes("not enough xp")?"Your companion is not ready to evolve yet.":s.includes("max stage")?"Your companion has already reached the maximum stage.":s.includes("companion not found")?"No companion found to evolve.":s.includes("rate limit")?"Evolution is on cooldown. Please try again in a little while.":"Unable to start evolution right now. Please try again."},pb=t=>{const s=[t?.code,t?.message,t?.error].filter(Boolean).join(" ").toLowerCase(),a=Hm(s);return a?{message:a.message,failureClass:"terminal",reason:a.category,code:a.code}:ub(s)?{message:"Evolution service is temporarily unavailable. Please try again in a minute.",failureClass:"retryable_infrastructure",reason:"direct_payload_infrastructure",code:zr(t?.code)??"evolution_service_unavailable"}:{message:mb(t),failureClass:"non_retryable",reason:"direct_payload_terminal",code:zr(t?.code)}},hb=async t=>{const s=await Ur(t),a=`${s.responsePayload?.code??""} ${s.backendMessage??""} ${s.message??""}`.toLowerCase(),r=Hm(a);return r?{message:r.message,failureClass:"terminal",reason:r.category,code:r.code,invokeCategory:s.category,invokeStatus:s.status??null}:s.category==="auth"?{message:"Your session has expired. Please sign in again and try evolving.",failureClass:"terminal",reason:"auth",code:"unauthorized",invokeCategory:s.category,invokeStatus:s.status??null}:s.category==="rate_limit"?{message:"Evolution is on cooldown. Please try again in a little while.",failureClass:"terminal",reason:"rate_limit",code:"rate_limited",invokeCategory:s.category,invokeStatus:s.status??null}:s.category==="network"||s.category==="relay"||s.status===408||typeof s.status=="number"&&s.status>=500?{message:"Evolution service is temporarily unavailable. Please try again in a minute.",failureClass:"retryable_infrastructure",reason:"invoke_infrastructure",code:zr(s.responsePayload?.code??s.code)??"evolution_service_unavailable",invokeCategory:s.category,invokeStatus:s.status??null}:{message:Hr(s,{action:"start evolution"}),failureClass:"non_retryable",reason:"invoke_unknown",code:zr(s.responsePayload?.code??s.code),invokeCategory:s.category,invokeStatus:s.status??null}},fb=async t=>{if(t instanceof Error&&t.message.trim().length>0)return t;const s=await Ur(t),a=Hr(s,{action:"start evolution"});return new Error(a)},_r=2,xn=[400,900],tc=async t=>{const s=t;await new Promise(a=>setTimeout(a,s))},sc=t=>{const s=Math.max(0,Math.min(t-1,xn.length-1));return xn[s]??xn[xn.length-1]},At=(t={})=>{const{enabled:s=!0}=t,{user:a}=_e(),r=Ie(),{checkCompanionAchievements:i}=ci(),{isEvolvingLoading:o,setIsEvolvingLoading:l}=ri(),{getThreshold:c,shouldEvolve:d}=X0(),u=n.useRef(!1),p=n.useRef(null),h=n.useRef(!1),{data:f,isLoading:m,error:g,refetch:y}=Ee({queryKey:Um(a?.id),queryFn:async()=>a?lb(a.id):null,enabled:s&&!!a,staleTime:6e4,gcTime:1800*1e3,placeholderData:R=>R,retry:3,retryDelay:R=>Math.min(1e3*2**R,5e3)}),b=he({mutationFn:async R=>{const _=Date.now();if(!a)throw new Error("Not authenticated");if(h.current)throw new Error("Companion creation already in progress");h.current=!0;try{ue.log("Starting companion creation process..."),ue.info("Companion creation started",{userId:a.id,spiritAnimal:R.spiritAnimal,coreElement:R.coreElement,stage:0});const C="",E="";ue.log("Generating companion image with validation...");const{imageUrl:O,validationPassed:M,retryCount:A}=await $m({favoriteColor:R.favoriteColor,spiritAnimal:R.spiritAnimal,element:R.coreElement,stage:0,eyeColor:C,furColor:E,storyTone:R.storyTone,flowType:"onboarding"},{maxRetries:0,onRetry:K=>{ue.log(`Validation failed, retrying image generation (attempt ${K})...`)},onValidating:()=>{ue.log("Validating generated image for anatomical issues...")}});A>0?ue.log(`Image generated after ${A} validation retry(ies), passed: ${M}`):ue.log(`Image generated on first attempt, validation passed: ${M}`);const L={imageUrl:O};ue.log("Image generated successfully, creating companion record...");const q=await k.rpc("create_companion_if_not_exists",{p_user_id:a.id,p_favorite_color:R.favoriteColor,p_spirit_animal:R.spiritAnimal,p_core_element:R.coreElement,p_story_tone:R.storyTone,p_current_image_url:L.imageUrl,p_initial_image_url:L.imageUrl,p_eye_color:C,p_fur_color:E});if(q.error)throw console.error("Database error creating companion:",q.error),new Error(`Failed to save companion to database: ${q.error.message}`);const $=q.data;if(ue.log("RPC call successful, result:",$),!$||$.length===0)throw ue.error("No companion data returned from function"),new Error("Failed to create companion record. Please try again.");const B=$[0],W=B.is_new;ue.log(`Companion ${W?"created":"already exists"}:`,B.id);const{data:H}=await k.from("companion_evolutions").select("id").eq("companion_id",B.id).eq("stage",0).maybeSingle();if(!H){ue.log("Creating stage 0 evolution...");const{data:K,error:X}=await k.from("companion_evolutions").insert({companion_id:B.id,stage:0,image_url:L.imageUrl,xp_at_evolution:0}).select().maybeSingle();if(X)throw console.error("Failed to create stage 0 evolution:",X),new Error(`Unable to record stage 0 evolution: ${X.message}`);if(!K)throw console.error("Stage 0 evolution insert returned no data"),new Error("Unable to record stage 0 evolution");(async()=>{try{const{data:ee}=await k.from("user_companion").select("*").eq("id",B.id).single();await k.functions.invoke("generate-evolution-card",{body:{companionId:B.id,evolutionId:K.id,stage:0,species:B.spirit_animal,element:B.core_element,color:B.favorite_color,userAttributes:{vitality:ee?.vitality||300,wisdom:ee?.wisdom||300,discipline:ee?.discipline||300,resolve:ee?.resolve||300,creativity:ee?.creativity||300,alignment:ee?.alignment||300}}}),r.invalidateQueries({queryKey:["evolution-cards"]})}catch(ee){console.error("Stage 0 card generation failed (non-critical):",ee)}})()}return W&&(async(X=3)=>{for(let Y=1;Y<=X;Y++)try{const{error:ee}=await k.functions.invoke("generate-companion-story",{body:{companionId:B.id,stage:0}});if(ee)throw ee;ue.log("Stage 0 story generation started"),r.invalidateQueries({queryKey:["companion-story"]}),r.invalidateQueries({queryKey:["companion-stories-all"]});return}catch(ee){const ie=ee instanceof Error?ee.message:String(ee),fe=ie.includes("network")||ie.includes("timeout")||ie.includes("temporarily unavailable");if(Y<X&&fe){ue.log(`Story generation attempt ${Y} failed, retrying...`),await new Promise(U=>setTimeout(U,2e3*Y));continue}console.error(`Failed to auto-generate stage 0 story after ${Y} attempts:`,ee);break}})().catch(X=>{console.warn("Story generation failed (non-critical):",X?.message||X)}),ue.info("Companion creation completed",{userId:a.id,durationMs:Date.now()-_}),B}catch(C){throw h.current=!1,ue.error("Companion creation mutation failed",{userId:a.id,durationMs:Date.now()-_,error:C instanceof Error?C.message:String(C)}),C}},onSuccess:()=>{h.current=!1,r.invalidateQueries({queryKey:["companion"]}),ue.log("Companion creation successful!")},onError:R=>{h.current=!1,console.error("Failed to create companion:",R)}}),w=he({mutationFn:async({eventType:R,xpAmount:_,metadata:C={},idempotencyKey:E})=>{if(!a)throw new Error("No user found");let O=f;if(!O&&(ue.warn("Companion not loaded yet, fetching..."),await r.refetchQueries({queryKey:["companion",a.id]}),O=r.getQueryData(["companion",a.id]),!O))throw new Error("No companion found. Please create one first.");return await x(O,_,R,C,a,E)},onSuccess:async({shouldEvolve:R,newStage:_})=>{r.invalidateQueries({queryKey:["companion"]}),R&&(await i(_),V.success("âœ¨ Your companion is ready to evolve! Visit your companion page.",{duration:5e3}))},onError:R=>{console.error("XP award failed:",R);const _=R instanceof Error&&R.message?R.message:"Failed to award XP. Please try again.";V.error(_)}}),x=async(R,_,C,E,O,M)=>{if(!O?.id)throw new Error("Not authenticated");const A=Object.fromEntries(Object.entries(E).filter(([,X])=>X!==void 0)),L=M??(typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).slice(2,10)}`),{data:q,error:$}=await k.rpc("award_xp_v2",{p_event_type:C,p_xp_amount:_,p_event_metadata:A,p_idempotency_key:L});if($)throw db($)?(ue.error("award_xp_v2 unavailable during XP award",{userId:O.id,eventType:C,idempotencyKey:L,error_code:$.code??null,error_message:$.message??null,error_details:$.details??null,error_hint:$.hint??null}),new Error(cb)):$;const B=Array.isArray(q)?q[0]:q;if(!B)throw new Error("XP award returned no data");const W=!!B.should_evolve,H=B.xp_after??R.current_xp,K=W?R.current_stage+1:R.current_stage;return ue.log("[XP Award Debug]",{eventType:C,requestedXP:_,awardedXP:B.xp_awarded,capApplied:B.cap_applied,currentStage:R.current_stage,currentXP:B.xp_before,newXP:H,nextThreshold:B.next_threshold,shouldEvolve:W,idempotencyKey:L}),{shouldEvolve:W,newStage:K,newXP:H,xpAwarded:B.xp_awarded??0,capApplied:!!B.cap_applied,nextThreshold:B.next_threshold??null}},v=he({mutationFn:async({newStage:R,currentXP:_})=>{if(u.current)return ue.log("Evolution already in progress, rejecting duplicate request"),p.current&&await p.current,null;u.current=!0;const C=(async()=>{if(!a||!f)throw u.current=!1,new Error("No companion found");l(!0);try{for(let E=1;E<=_r;E+=1){const{data:O,error:M}=await k.functions.invoke("generate-companion-evolution",{body:{}});if(M){const L=await hb(M);if(L.failureClass==="retryable_infrastructure"&&E<_r){ue.warn("Direct evolution invoke failed; retrying",{attempt:E,max_attempts:_r,reason:L.reason,status:L.invokeStatus,category:L.invokeCategory}),await tc(sc(E));continue}throw new Error(L.message)}const A=O??null;if(!A||A.evolved!==!0){const L=pb(A);if(L.failureClass==="retryable_infrastructure"&&E<_r){ue.warn("Direct evolution returned unsuccessful payload; retrying",{attempt:E,max_attempts:_r,reason:L.reason,code:L.code}),await tc(sc(E));continue}throw new Error(L.message)}return{newStage:typeof A.new_stage=="number"?A.new_stage:null}}throw new Error("Evolution service is temporarily unavailable. Please try again in a minute.")}catch(E){throw ue.error("Evolution mutation failed",{error:E instanceof Error?E.message:String(E)}),u.current=!1,l(!1),await fb(E)}})();p.current=C;try{return await C}finally{p.current=null}},onSuccess:R=>{u.current=!1,l(!1),R&&(r.invalidateQueries({queryKey:["companion"]}),r.invalidateQueries({queryKey:["companion-stories-all"]}),r.invalidateQueries({queryKey:["evolution-cards"]}),r.invalidateQueries({queryKey:["current-evolution-card"]}))},onError:R=>{u.current=!1,l(!1),console.error("Evolution failed:",{name:R.name,message:R.message});const _=R instanceof Error&&R.message?R.message:"Unable to evolve your companion right now. Please try again.";V.error(_)}}),j=n.useMemo(()=>f?c(f.current_stage+1):null,[f,c]),T=n.useMemo(()=>{if(!f||!j)return 0;const R=c(f.current_stage)??0,_=j-R;if(_<=0)return 100;const C=(f.current_xp-R)/_*100;return Math.min(100,Math.max(0,C))},[f,c,j]),S=n.useMemo(()=>f?d(f.current_stage,f.current_xp):!1,[f,d]),N=v.isPending,D=n.useCallback(()=>{if(!f||N||!S)return;const R=f.current_stage+1;l(!0),window.dispatchEvent(new CustomEvent("evolution-loading-start")),v.mutate({newStage:R,currentXP:f.current_xp})},[f,S,v,N,l]);return{companion:f,isLoading:m,error:g,refetch:y,createCompanion:b,awardXP:w,evolveCompanion:v,nextEvolutionXP:j,progressToNext:T,isEvolvingLoading:o,canEvolve:S,isEvolutionBusy:N,triggerManualEvolution:D}},zm=5,gb=5,xb="42703",$i=new Set,Bi=new Map,yb=t=>Number.isFinite(t)?Math.max(1,Math.min(gb,Math.floor(t))):zm,bb=t=>{let s=0;for(let a=0;a<t.length;a+=1)s=s*31+t.charCodeAt(a)>>>0;return s},wb=t=>{if(!t||typeof t!="object")return!1;const s=t;if(s.code===xb)return!0;const a=(s.message||"").toLowerCase();return a.includes("variant_index")&&a.includes("does not exist")},vb=t=>{const s=new Set;for(const a of t)typeof a?.variant_index!="number"||!Number.isFinite(a.variant_index)||s.add(Math.floor(a.variant_index));return Array.from(s).sort((a,r)=>a-r)},_b=({theme:t,tier:s,name:a,selectionSeed:r,targetVariants:i=zm,enabled:o=!0})=>{const[l,c]=n.useState(null),[d,u]=n.useState(!1),[p,h]=n.useState(null);return n.useEffect(()=>{if(!o||!t||!s){c(null),u(!1),h(null);return}const f=yb(i),m=`${t}:${s}:${f}`,g=r?.trim()||a.trim()||`${t}:${s}`,y=`${t}:${s}:${g}`;let b=!0;const w=Bi.get(y);return w&&c(w),(async()=>{u(!0),h(null);try{const{data:v,error:j}=await k.from("adversary_images").select("variant_index").eq("theme",t).eq("tier",s).order("variant_index",{ascending:!0});let T=0,S=null;if(j)if(wb(j)){const{data:D,error:R}=await k.from("adversary_images").select("image_url").eq("theme",t).eq("tier",s).order("created_at",{ascending:!0});if(R)throw R;const _=D?.[0];_&&typeof _.image_url=="string"&&(S=_.image_url,T=1)}else throw j;else{const D=vb(v??[]);if(T=D.length,D.length>0){const R=D[bb(g)%D.length],{data:_,error:C}=await k.from("adversary_images").select("image_url, variant_index").eq("theme",t).eq("tier",s).eq("variant_index",R).order("variant_index",{ascending:!0});if(C)throw C;const E=_?.[0];E&&typeof E.image_url=="string"&&(S=E.image_url)}}if(!b)return;S?(c(S),Bi.set(y,S)):c(null);const N=!$i.has(m);T<f&&N&&($i.add(m),k.functions.invoke("generate-adversary-image",{body:{theme:t,tier:s,name:a,targetVariants:f,selectionSeed:g}}).then(({data:D,error:R})=>{if(R)throw new Error(R.message);b&&!S&&typeof D?.imageUrl=="string"&&(c(D.imageUrl),Bi.set(y,D.imageUrl))}).catch(D=>{console.error("Background adversary image top-up failed:",D)}).finally(()=>{$i.delete(m)}))}catch(v){if(!b)return;console.error("Failed to fetch cached adversary variants:",v),h(v instanceof Error?v.message:"Failed to load image"),c(null)}finally{b&&u(!1)}})(),()=>{b=!1}},[t,s,a,o,r,i]),{imageUrl:l,isLoading:d,error:p}};function jb({tier:t,onPlayerDefeated:s,onAdversaryDefeated:a,onDamageDealt:r}){const i=k0[t],o=n.useRef({onPlayerDefeated:s,onAdversaryDefeated:a,onDamageDealt:r});o.current={onPlayerDefeated:s,onAdversaryDefeated:a,onDamageDealt:r};const[l,c]=n.useState(i.playerHP),[d,u]=n.useState(i.adversaryHP),[p,h]=n.useState([]),f=l<=0,m=d<=0,g=n.useMemo(()=>({playerHP:Math.max(0,l),playerMaxHP:i.playerHP,adversaryHP:Math.max(0,d),adversaryMaxHP:i.adversaryHP,isPlayerDefeated:f,isAdversaryDefeated:m,playerHPPercent:Math.max(0,l/i.playerHP*100),adversaryHPPercent:Math.max(0,d/i.adversaryHP*100)}),[l,d,i,f,m]),y=n.useCallback(x=>{f||m||(h(v=>[...v,x]),o.current.onDamageDealt?.(x),x.target==="player"?c(v=>{const j=v-x.amount;return j<=0&&setTimeout(()=>o.current.onPlayerDefeated?.(),0),Math.max(0,j)}):u(v=>{const j=v-x.amount;return j<=0&&setTimeout(()=>o.current.onAdversaryDefeated?.(),0),Math.max(0,j)}))},[f,m]),b=n.useCallback(()=>{c(i.playerHP),u(i.adversaryHP),h([])},[i]),w=n.useCallback(()=>S0(l,i.playerHP,f),[l,i.playerHP,f]);return{battleState:g,dealDamage:y,resetBattle:b,getResult:w,tierAttackDamage:i.attackDamage,damageEvents:p}}const ac=["energy_beam","tap_sequence","orb_match","galactic_match","astral_frequency","eclipse_timing","starfall_dodge","soul_serpent"],Nb={distraction:"tap_sequence",chaos:"galactic_match",stagnation:"energy_beam",laziness:"energy_beam",anxiety:"orb_match",overthinking:"galactic_match",doubt:"tap_sequence",fear:"energy_beam",confusion:"orb_match",vulnerability:"energy_beam",imbalance:"tap_sequence"},Km={distraction:"mind",chaos:"mind",stagnation:"body",laziness:"body",anxiety:"soul",overthinking:"soul",doubt:"mind",fear:"body",confusion:"soul",vulnerability:"body",imbalance:"mind"},sl={common:{phases:1,statBoost:1,xpBase:35},uncommon:{phases:1,statBoost:2,xpBase:45},rare:{phases:2,statBoost:3,xpBase:55},epic:{phases:2,statBoost:4,xpBase:75},legendary:{phases:3,statBoost:5,xpBase:100}},kb={perfect:1.5,good:1,fail:0},Cb=[{name:"Doomscrolling",icon:"ðŸ“±",theme:"distraction"},{name:"Sugar Cravings",icon:"ðŸ¬",theme:"laziness"},{name:"Skipping Workouts",icon:"ðŸƒ",theme:"stagnation"},{name:"Stress Eating",icon:"ðŸ•",theme:"anxiety"},{name:"Procrastination",icon:"â°",theme:"stagnation"},{name:"Negative Self-Talk",icon:"ðŸ’­",theme:"doubt"},{name:"Nail Biting",icon:"ðŸ’…",theme:"anxiety"},{name:"Junk Food",icon:"ðŸ”",theme:"laziness"},{name:"Social Media",icon:"ðŸ“²",theme:"distraction"},{name:"Overthinking",icon:"ðŸ§ ",theme:"overthinking"}],Qm={distraction:["Riftling","Scatter","Flickering","Wandering"],chaos:["Vortex","Maelstrom","Turbulent","Entropic"],stagnation:["Mire","Stillborn","Frozen","Anchored"],laziness:["Slumber","Drift","Languor","Torpid"],anxiety:["Tremor","Spiral","Frantic","Restless"],overthinking:["Echo","Loop","Recursive","Tangled"],doubt:["Shadow","Whisper","Fading","Hollow"],fear:["Dread","Creeping","Lurking","Umbral"],confusion:["Maze","Veiled","Obscured","Fogbound"],vulnerability:["Exposed","Piercing","Breaching","Unshielded"],imbalance:["Tilting","Wavering","Unstable","Teetering"]},Wm={common:["Wisp","Shade","Specter","Phantom"],uncommon:["Wraith","Spirit","Haunt","Revenant"],rare:["Fiend","Demon","Harbinger","Herald"],epic:["Lord","Tyrant","Sovereign","Monarch"],legendary:["Titan","Colossus","Primordial","Ancient"]},Sb={distraction:["Born from scattered thoughts and fractured focus, this entity feeds on mental chaos.","A creature of fleeting moments, it thrives where attention wavers and concentration breaks."],chaos:["Manifested from the entropy of unordered days, this being revels in disorder.","Where plans crumble and routines shatter, this adversary grows stronger."],stagnation:["Formed in the depths of inaction, this entity chains the willing to the unchanging.","A manifestation of paralysis, it whispers that tomorrow is always better."],laziness:["Born from abandoned intentions and forsaken goals, it lulls the ambitious to sleep.","This creature grows fat on postponed dreams and delayed action."],anxiety:["Woven from racing heartbeats and sleepless nights, it amplifies every worry.","A storm of what-ifs given form, feeding on uncertainty and dread."],overthinking:["Created from endless mental loops and circular reasoning, it traps minds in analysis.","This entity spins thoughts into mazes with no exit."],doubt:["A shadow of self-belief, it whispers inadequacy to those who dare to dream.","Born from hesitation and second-guessing, it erodes confidence grain by grain."],fear:["Materialized from primal terrors and modern anxieties, it paralyzes the brave.","This ancient adversary has hunted dreamers since the first star was wished upon."],confusion:["A living labyrinth, this entity thrives when paths blur and direction fades.","Born from lost purpose and wandering souls, it delights in disorientation."],vulnerability:["Forged from moments of exposure and defenselessness, it strikes at unguarded hearts.","This predator hunts those who lower their shields, feeding on raw weakness."],imbalance:["Spawned from tilted scales and unstable foundations, it topples the centered.","Where equilibrium falters and harmony breaks, this adversary finds its strength."]},Eb={distraction:["Focus Essence","Clarity Core","Concentration Crystal"],chaos:["Order Essence","Harmony Shard","Balance Core"],stagnation:["Motion Essence","Momentum Crystal","Flow Core"],laziness:["Vigor Essence","Energy Shard","Drive Core"],anxiety:["Calm Essence","Serenity Crystal","Peace Core"],overthinking:["Stillness Essence","Simplicity Shard","Clarity Core"],doubt:["Confidence Essence","Belief Crystal","Courage Core"],fear:["Bravery Essence","Valor Shard","Fearless Core"],confusion:["Direction Essence","Pathfinder Shard","Clarity Star"],vulnerability:["Shield Essence","Guardian Core","Protection Crystal"],imbalance:["Equilibrium Essence","Stability Shard","Center Core"]},Tb={distraction:"Sharpens mental acuity and strengthens focus.",chaos:"Brings order to turbulent thoughts.",stagnation:"Ignites the spark of movement and progress.",laziness:"Fuels the body with renewed energy.",anxiety:"Soothes the spirit and calms racing thoughts.",overthinking:"Quiets the endless mental chatter.",doubt:"Reinforces self-belief and inner strength.",fear:"Transforms terror into courageous resolve.",confusion:"Illuminates the path forward with clarity.",vulnerability:"Fortifies inner defenses and builds resilience.",imbalance:"Restores harmony and centers the spirit."},xa=t=>t[Math.floor(Math.random()*t.length)],Mb=(t,s)=>t==="weekly"?"uncommon":t==="quest_milestone"?"common":t==="urge_resist"?Math.random()>.7?"uncommon":"common":t==="epic_checkpoint"&&s!==void 0?s>=100?"legendary":s>=75?"epic":s>=50?"rare":"uncommon":"common",Db=(t,s)=>{if(t==="urge_resist"&&s&&["distraction","chaos","stagnation","laziness","anxiety","overthinking","doubt","fear","confusion","vulnerability","imbalance"].includes(s))return s;if(t==="epic_checkpoint"&&s){const r={fitness:["stagnation","laziness"],health:["stagnation","laziness"],body:["stagnation","laziness"],mind:["distraction","overthinking"],learning:["distraction","overthinking"],focus:["distraction","chaos"],soul:["anxiety","fear"],spiritual:["anxiety","doubt"],wellness:["anxiety","fear"],productivity:["chaos","laziness"],creative:["doubt","fear"]},i=s.toLowerCase();for(const[o,l]of Object.entries(r))if(i.includes(o))return xa(l)}return xa(["distraction","chaos","stagnation","laziness","anxiety","overthinking","doubt","fear","confusion","vulnerability","imbalance"])},Ab=(t,s)=>{const a=Qm[t],r=Wm[s];return a.flatMap(i=>r.map(o=>`${i} ${o}`))},Pb=t=>!t||t.length===0?new Set:new Set(t.map(s=>s.trim()).filter(s=>s.length>0)),Rb=(t,s,a)=>{const r=Ab(t,s);if(r.length===0)return`${xa(Qm[t])} ${xa(Wm[s])}`;const i=Pb(a),o=i.size>0?r.filter(c=>!i.has(c)):r,l=o.length>0?o:r;return xa(l)},Ib=t=>{let s=0;for(let a=0;a<t.length;a+=1)s=s*31+t.charCodeAt(a)>>>0;return s},qb=(t,s)=>{const a=Sb[t];if(!a||a.length===0)return"";const r=Ib(`${t}:${s}`)%a.length;return a[r]},Lb=(t,s,a)=>{if(t!=="urge_resist")return Nb[s];const r=new Set(a??[]),i=ac.filter(l=>!r.has(l)),o=i.length>0?i:ac;return xa(o)},Ob=(t,s,a,r,i)=>{const o=Mb(t,s),l=Db(t,a),c=sl[o],d=Rb(l,o,i?.avoidNames),u=qb(l,d),p=xa(Eb[l]),h=Tb[l],f=Lb(t,l,i?.recentMiniGames);return{name:d,theme:l,tier:o,lore:u,miniGameType:f,phases:c.phases,essenceName:p,essenceDescription:h,statType:Km[l],statBoost:c.statBoost}},Gm=(t,s,a)=>{const r=sl[t].xpBase,i=Ym(s),o=kb[i],l=a?1.25:1;return Math.round(r*o*l)},Ym=t=>t>=90?"perfect":t>=50?"good":"fail";function Ce({className:t,...s}){return e.jsx("div",{className:I("relative overflow-hidden rounded-md bg-muted/40",t),...s,children:e.jsx("div",{className:"absolute inset-0 -translate-x-full animate-shimmer bg-gradient-to-r from-transparent via-muted/20 to-transparent"})})}const Fb=()=>e.jsxs("div",{className:"min-h-screen bg-background p-4 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between pt-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(Ce,{className:"h-6 w-32"}),e.jsx(Ce,{className:"h-4 w-48"})]}),e.jsx(Ce,{className:"h-10 w-10 rounded-full"})]}),e.jsxs(Xe,{className:"p-6 space-y-3",children:[e.jsx(Ce,{className:"h-4 w-full"}),e.jsx(Ce,{className:"h-4 w-5/6"}),e.jsx(Ce,{className:"h-3 w-24 ml-auto"})]}),e.jsxs(Xe,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ce,{className:"h-12 w-12 rounded-full"}),e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(Ce,{className:"h-5 w-36"}),e.jsx(Ce,{className:"h-4 w-24"})]})]}),e.jsx(Ce,{className:"h-2 w-full rounded-full"}),e.jsx(Ce,{className:"h-10 w-full rounded-md"})]}),e.jsxs(Xe,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Ce,{className:"h-6 w-32"}),e.jsx(Ce,{className:"h-6 w-6 rounded-full"})]}),e.jsx("div",{className:"flex justify-between",children:[...Array(5)].map((t,s)=>e.jsx(Ce,{className:"h-10 w-10 rounded-full"},s))})]}),e.jsxs(Xe,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ce,{className:"h-10 w-10 rounded-full"}),e.jsx(Ce,{className:"h-5 w-40"})]}),e.jsx(Ce,{className:"h-12 w-full rounded-lg"})]}),e.jsxs(Xe,{className:"p-6 space-y-4",children:[e.jsx(Ce,{className:"h-6 w-36"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ce,{className:"h-4 w-full"}),e.jsx(Ce,{className:"h-4 w-3/4"})]})]})]}),$b=()=>e.jsxs("div",{className:"w-full max-w-md mx-auto space-y-4 p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(Ce,{className:"h-6 w-16 rounded-full"}),e.jsx(Ce,{className:"h-8 w-20"}),e.jsx(Ce,{className:"h-6 w-16 rounded-full"})]}),e.jsx(Ce,{className:"h-2 w-full rounded-full"}),e.jsxs("div",{className:"relative aspect-square rounded-2xl overflow-hidden",children:[e.jsx(Ce,{className:"absolute inset-0"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(Ce,{className:"h-24 w-24 rounded-full"})}),e.jsx(Ce,{className:"absolute top-4 left-4 h-10 w-10 rounded-full"}),e.jsx(Ce,{className:"absolute top-4 right-4 h-10 w-10 rounded-full"}),e.jsx(Ce,{className:"absolute bottom-4 left-4 h-10 w-10 rounded-full"}),e.jsx(Ce,{className:"absolute bottom-4 right-4 h-10 w-10 rounded-full"})]}),e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx(Ce,{className:"h-5 w-48 mx-auto"}),e.jsx(Ce,{className:"h-4 w-32 mx-auto"})]}),e.jsx(Ce,{className:"h-12 w-full rounded-lg"})]}),Bb=()=>e.jsxs(Xe,{className:"p-5 md:p-6 space-y-4 animate-pulse",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(Ce,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ce,{className:"h-5 w-32"}),e.jsx(Ce,{className:"h-3 w-20"})]})]})}),e.jsx(Ce,{className:"h-2 w-full"}),e.jsx("div",{className:"space-y-2",children:[1,2,3].map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx(Ce,{className:"h-5 w-5 rounded-full"}),e.jsx(Ce,{className:"h-4 w-full max-w-xs"})]}),e.jsx(Ce,{className:"h-9 w-24"})]},t))})]}),rc=n.lazy(()=>ke(()=>import("./EnergyBeamGame-DOxMRCf9.js"),__vite__mapDeps([0,1,2,3,4,5])).then(t=>({default:t.EnergyBeamGame}))),Ub=n.lazy(()=>ke(()=>import("./TapSequenceGame-Y_mi02ZY.js"),__vite__mapDeps([6,1,2,3,4,5,7])).then(t=>({default:t.TapSequenceGame}))),Hb=n.lazy(()=>ke(()=>import("./AstralFrequencyGame-CRA64nE1.js"),__vite__mapDeps([8,1,2,3,4])).then(t=>({default:t.AstralFrequencyGame}))),zb=n.lazy(()=>ke(()=>import("./EclipseTimingGame-D4la_ig9.js"),__vite__mapDeps([9,1,2,3,4,5])).then(t=>({default:t.EclipseTimingGame}))),Kb=n.lazy(()=>ke(()=>import("./StarfallDodgeGame-ssuF2kJe.js"),__vite__mapDeps([10,1,2,3,4])).then(t=>({default:t.StarfallDodgeGame}))),Qb=n.lazy(()=>ke(()=>import("./SoulSerpentGame-80vRXiPh.js"),__vite__mapDeps([11,1,2,3,4])).then(t=>({default:t.SoulSerpentGame}))),Wb=n.lazy(()=>ke(()=>import("./OrbMatchGame-5RJgDfJp.js"),__vite__mapDeps([12,1,2,3,4,5,7])).then(t=>({default:t.OrbMatchGame}))),Gb=n.lazy(()=>ke(()=>import("./GalacticMatchGame-CX74TnbQ.js"),__vite__mapDeps([13,1,2,3,4,5,7])).then(t=>({default:t.GalacticMatchGame}))),Ui=new Set,nc=t=>{if(typeof t!="string")return null;const s=t.trim();return s.length>0?s:null},Yb=({open:t,onOpenChange:s,encounter:a,adversary:r,questInterval:i=3,onComplete:o,onPass:l,isBossBattle:c=!1,bossBattleContext:d,onBossBattleCancel:u})=>{const[p,h]=n.useState("reveal"),[f,m]=n.useState(0),[g,y]=n.useState([]),[b,w]=n.useState(!1),[x,v]=n.useState(null),[j,T]=n.useState(!1),[S,N]=n.useState(0),[D,R]=n.useState(0),[_,C]=n.useState(!1),[E,O]=n.useState(!1),{companion:M,refetch:A}=At(),L=n.useRef(!1);n.useEffect(()=>{t&&A()},[t,A]);const{data:q}=Ee({queryKey:["current-evolution-card",M?.id,M?.current_stage],queryFn:async()=>{if(!M?.id)return null;const{data:Z}=await k.from("companion_evolution_cards").select("creature_name").eq("companion_id",M.id).eq("evolution_stage",M.current_stage||0).maybeSingle();return Z},enabled:!!M?.id&&t}),$=nc(q?.creature_name)??nc(M?.cached_creature_name)??"Companion",{battleState:B,dealDamage:W,resetBattle:H,getResult:K,tierAttackDamage:X,damageEvents:Y}=jb({tier:r?.tier||"common",onPlayerDefeated:()=>{L.current||(L.current=!0,ee("fail"))},onAdversaryDefeated:()=>{L.current||(L.current=!0,ee("victory"))},onDamageDealt:Z=>{Z.target==="player"&&(T(!0),setTimeout(()=>T(!1),300))}}),ee=n.useCallback(async Z=>{if(!r||!a)return;const Q=Z==="fail"?"fail":K(),J=Z==="fail"?0:Math.round(B.playerHPPercent),de=Z==="fail"?0:Gm(r.tier,J,b);if(!await o({encounterId:a.id,accuracy:J,phasesCompleted:Z==="fail"?f:r.phases})){s(!1);return}v({result:Q,accuracy:J,xpEarned:de,tiltBonus:b}),h("result")},[r,a,K,B.playerHPPercent,o,f,b,s]);n.useEffect(()=>{if(t){h(c?"boss_intro":"reveal"),m(0),y([]),v(null),w(!1),L.current=!1,H();const Z=r?.tier||"common",Q=N0[Z];N(Q),R(Q)}},[t,c,H,r?.tier]),n.useEffect(()=>{if(p!=="battle"||L.current)return;if(S<=0){if(!L.current){L.current=!0;const Q=100-B.adversaryHPPercent,J=100-B.playerHPPercent,de=Q>J?"victory":"fail";ee(de)}return}const Z=setInterval(()=>{N(Q=>Math.max(0,Q-1))},1e3);return()=>clearInterval(Z)},[p,S,B.adversaryHPPercent,B.playerHPPercent,ee]);const{imageUrl:ie}=_b({theme:r?.theme||"",tier:r?.tier||"",name:r?.name||"",selectionSeed:a?.id,targetVariants:5,enabled:!!r&&t}),fe={mind:Math.floor(((M?.wisdom??300)+(M?.creativity??300))/12),body:Math.floor(((M?.vitality??300)+(M?.discipline??300))/12),soul:Math.floor(((M?.resolve??300)+(M?.alignment??300))/12)},U=n.useCallback(()=>{if(!r)return"energy_beam";const Q={mind:["tap_sequence","galactic_match","orb_match"],body:["energy_beam"],soul:["orb_match","galactic_match"]}[r.statType]||["energy_beam","tap_sequence"];return r.phases===1?r.miniGameType:Q[f%Q.length]},[r,f]),ce=n.useCallback(()=>{s(!1)},[s]),se=n.useCallback(()=>{!t||p==="result"||E||C(!0)},[t,p,E]);n.useEffect(()=>{if(!t||p==="result"||E||_)return;const Z=Q=>{Q.key==="Escape"&&se()};return window.addEventListener("keydown",Z),()=>window.removeEventListener("keydown",Z)},[t,p,E,_,se]);const ne=n.useCallback(async()=>{if(!E){O(!0);try{p==="boss_intro"&&u?.(),l?await l():s(!1)}catch(Z){console.error("Failed to pass encounter during exit:",Z)}finally{O(!1),C(!1)}}},[E,u,s,l,p]),xe=n.useCallback(Z=>{Z||(p==="result"?ce():se())},[ce,p,se]),G=n.useCallback(()=>{h("reveal")},[]),ye=n.useCallback(()=>{se()},[se]),we=n.useCallback(()=>{h("instructions"),m(0),y([]),L.current=!1,H()},[H]),Te=n.useCallback(()=>{const Z=U();Ui.has(Z)?h("battle"):h("practice")},[U]),qe=n.useCallback(()=>{const Z=U();Ui.add(Z),h("battle")},[U]),Se=n.useCallback(()=>{const Z=U();Ui.add(Z),h("battle")},[U]),Pe=n.useCallback(Z=>{L.current||W(Z)},[W]),$e=n.useCallback(Z=>{if(!r||!a||L.current)return;Z.usedTiltControls&&w(!0);const Q=[...g,Z];y(Q),!(B.isPlayerDefeated||B.isAdversaryDefeated)&&(f<r.phases-1?(m(J=>J+1),h("instructions")):(m(0),h("instructions")))},[r,a,f,g,B.isPlayerDefeated,B.isAdversaryDefeated]),Be=n.useCallback(()=>{if(!r)return null;const Z=U(),Q=r.tier==="legendary"||r.tier==="epic"?"hard":r.tier==="rare"?"medium":"easy",J=(i-3)*.15,de={companionStats:fe,onComplete:$e,difficulty:Q,questIntervalScale:J,onDamage:Pe,tierAttackDamage:X,compact:!0},oe=(()=>{switch(Z){case"energy_beam":return rc;case"tap_sequence":return Ub;case"astral_frequency":return Hb;case"eclipse_timing":return zb;case"starfall_dodge":return Kb;case"soul_serpent":return Qb;case"orb_match":return Wb;case"galactic_match":return Gb;default:return rc}})();return e.jsx(n.Suspense,{fallback:e.jsx($b,{}),children:e.jsx(oe,{...de})})},[r,U,fe,$e,i,Pe,X]);if(!a||!r)return null;const Me=["energy_beam","tap_sequence","orb_match","galactic_match","astral_frequency","starfall_dodge"],Qe=U(),De=(p==="battle"||p==="practice")&&Me.includes(Qe),ve=t&&p!=="result"&&!_;return e.jsxs(e.Fragment,{children:[ve&&e.jsx(z,{type:"button",size:"icon",variant:"ghost",onClick:se,disabled:E,"aria-label":"Exit encounter",className:"fixed z-[170] h-10 w-10 rounded-full border border-white/20 bg-black/50 text-white backdrop-blur-sm hover:bg-black/70 touch-manipulation",style:{top:"calc(env(safe-area-inset-top, 0px) + 0.75rem)",right:"calc(env(safe-area-inset-right, 0px) + 0.75rem)"},children:e.jsx(kt,{className:"h-5 w-5"})}),t&&De&&e.jsxs("div",{className:"fixed top-0 left-0 right-0 z-[100] overflow-hidden bg-background",style:{bottom:"var(--bottom-nav-safe-offset)"},children:[p==="practice"&&e.jsx("div",{className:"h-full min-h-0",children:e.jsx(Yl,{gameType:Qe,companionStats:fe,onPracticeComplete:qe,onSkipPractice:Se,isFullscreen:!0})}),p==="battle"&&e.jsxs("div",{className:"relative z-10 flex h-full min-h-0 flex-col",children:[e.jsx(Xl,{battleState:B,adversaryImageUrl:ie||void 0,adversaryName:r.name,showScreenShake:j,battleTimeLeft:S,battleTimeTotal:D}),e.jsx(Vl,{damageEvents:Y,className:"z-50"}),r.phases>1&&e.jsx("div",{className:"fixed top-24 left-1/2 -translate-x-1/2 z-50 flex gap-2",children:Array.from({length:r.phases}).map((Z,Q)=>e.jsx("div",{className:`w-3 h-3 rounded-full ${Q<f?"bg-green-500":Q===f?"bg-primary animate-pulse":"bg-muted"}`},Q))}),e.jsx("div",{className:"flex-1 min-h-0",children:Be()})]})]}),e.jsx(as,{open:t&&!De,onOpenChange:xe,children:e.jsx(Qt,{hideCloseButton:!0,className:"sm:max-w-lg p-0 overflow-hidden bg-background border-border",children:e.jsxs(P.div,{className:"relative min-h-[500px] max-h-[90dvh] overflow-hidden flex flex-col",style:{paddingBottom:"env(safe-area-inset-bottom, 24px)"},animate:j?{x:[0,-4,4,-2,2,0]}:{},transition:{duration:.3},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/5 via-background to-accent/5"}),p==="battle"&&!De&&e.jsx(Vl,{damageEvents:Y,className:"z-50"}),e.jsx("div",{className:"relative z-10 flex flex-col h-full min-h-[500px]",children:e.jsxs(Re,{mode:"wait",children:[p==="boss_intro"&&c&&d&&e.jsx(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsx(G0,{context:d,onBeginBattle:G,onCancel:ye})},"boss_intro"),p==="reveal"&&e.jsx(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsx(T0,{adversary:r,adversaryImageUrl:ie||void 0,companionImageUrl:M?.current_image_url||void 0,companionName:$,companionStage:M?.current_stage||0,onReady:we,onPass:se})},"reveal"),p==="instructions"&&e.jsx(P.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},children:e.jsx(I0,{gameType:U(),onReady:Te})},`instructions-${f}`),p==="practice"&&e.jsx(P.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},children:e.jsx(Yl,{gameType:U(),companionStats:fe,onPracticeComplete:qe,onSkipPractice:Se})},`practice-${f}`),p==="battle"&&!De&&e.jsxs(P.div,{initial:{opacity:0,x:50},animate:{opacity:1,x:0},exit:{opacity:0,x:-50},className:"flex flex-col flex-1 min-h-0",children:[e.jsx(Xl,{battleState:B,adversaryImageUrl:ie||void 0,adversaryName:r.name,battleTimeLeft:S,battleTimeTotal:D}),r.phases>1&&e.jsx("div",{className:"flex justify-center gap-2 py-2",children:Array.from({length:r.phases}).map((Z,Q)=>e.jsx("div",{className:`w-3 h-3 rounded-full ${Q<f?"bg-green-500":Q===f?"bg-primary animate-pulse":"bg-muted"}`},Q))}),e.jsx("div",{className:"flex-1 min-h-0",children:Be()})]},`battle-${f}`),p==="result"&&x&&e.jsx(P.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0},children:e.jsx(A0,{adversary:r,result:x.result,accuracy:x.accuracy,xpEarned:x.xpEarned,onClose:ce,retryAvailableAt:x.result==="fail"?new Date(Date.now()+14400*1e3).toISOString():void 0,tiltBonus:x.tiltBonus,companionImageUrl:M?.current_image_url||void 0,companionName:$})},"result")]})})]})})}),e.jsx(mr,{open:_,onOpenChange:Z=>{E||C(Z)},children:e.jsxs(Ea,{children:[e.jsxs(Ta,{children:[e.jsx(Da,{children:"Pass this encounter and exit?"}),e.jsx(Aa,{children:"Leaving now will pass this Astral Encounter. Your current battle progress will be lost."})]}),e.jsxs(Ma,{children:[e.jsx(Pa,{disabled:E,children:"Continue Battle"}),e.jsx(la,{className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",disabled:E,onClick:Z=>{Z.preventDefault(),ne()},children:E?"Passing...":"Pass & Exit"})]})]})})]})},Vb={common:{primary:"hsl(var(--muted))",secondary:"hsl(var(--muted-foreground))",glow:"rgba(156, 163, 175, 0.5)"},uncommon:{primary:"hsl(142, 76%, 46%)",secondary:"hsl(142, 76%, 60%)",glow:"rgba(34, 197, 94, 0.5)"},rare:{primary:"hsl(217, 91%, 60%)",secondary:"hsl(217, 91%, 75%)",glow:"rgba(59, 130, 246, 0.5)"},epic:{primary:"hsl(271, 91%, 65%)",secondary:"hsl(271, 91%, 80%)",glow:"rgba(168, 85, 247, 0.5)"},legendary:{primary:"hsl(38, 92%, 50%)",secondary:"hsl(38, 92%, 70%)",glow:"rgba(245, 158, 11, 0.5)"}},Xb=({isVisible:t,tier:s="common",onComplete:a})=>{const r=Vb[s],i=n.useRef(!1),o=n.useRef(null),l=n.useRef(!1);return n.useEffect(()=>{t&&!i.current&&(i.current=!0,yy()),t||(i.current=!1,l.current=!1,o.current&&(clearTimeout(o.current),o.current=null))},[t]),n.useEffect(()=>()=>{o.current&&(clearTimeout(o.current),o.current=null)},[]),t?e.jsxs(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onAnimationComplete:()=>{l.current||(l.current=!0,o.current=setTimeout(()=>{o.current=null,a()},2500))},className:"fixed inset-0 z-[9999] flex items-center justify-center overflow-hidden",style:{background:`linear-gradient(135deg, hsl(var(--background)) 0%, ${r.primary}20 50%, hsl(var(--background)) 100%)`,pointerEvents:"auto",touchAction:"none"},children:[e.jsx(P.div,{className:"absolute inset-0",style:{background:`radial-gradient(circle at center, ${r.glow} 0%, transparent 70%)`},animate:{scale:[1,1.5,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx(P.div,{className:"absolute w-96 h-96 rounded-full border-2",style:{borderColor:r.primary},initial:{scale:0,opacity:1},animate:{scale:[0,3,3],opacity:[1,.5,0]},transition:{duration:2,repeat:1/0,ease:"easeOut"}}),e.jsx(P.div,{className:"absolute w-64 h-64 rounded-full border",style:{borderColor:r.secondary},initial:{scale:0,opacity:1},animate:{scale:[0,4,4],opacity:[1,.3,0]},transition:{duration:2.5,repeat:1/0,delay:.3,ease:"easeOut"}}),e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(40)].map((c,d)=>e.jsx(P.div,{className:"absolute w-1.5 h-1.5 rounded-full",style:{backgroundColor:d%2===0?r.primary:r.secondary,boxShadow:`0 0 8px ${r.glow}`},initial:{x:Math.random()*(typeof window<"u"?window.innerWidth:400),y:(typeof window<"u"?window.innerHeight:800)+50},animate:{y:-50,x:Math.random()*(typeof window<"u"?window.innerWidth:400),scale:[0,1.5,0],opacity:[0,1,0]},transition:{duration:1.2+Math.random()*1.3,repeat:1/0,delay:Math.random()*1.5}},d))}),e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(12)].map((c,d)=>e.jsx(P.div,{className:"absolute w-3 h-3 rounded-full",style:{backgroundColor:r.secondary,boxShadow:`0 0 12px ${r.glow}`,left:"50%",top:"50%"},animate:{x:[0,Math.cos(d*30*Math.PI/180)*150,0],y:[0,Math.sin(d*30*Math.PI/180)*150,0],scale:[0,1,0],opacity:[0,1,0]},transition:{duration:2,repeat:1/0,delay:d*.1,ease:"easeInOut"}},`swirl-${d}`))}),e.jsxs("div",{className:"flex flex-col items-center gap-6 relative z-10",children:[e.jsxs(P.div,{className:"relative",initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200,damping:15,delay:.2},children:[e.jsx(P.div,{className:"absolute inset-0 rounded-full blur-xl",style:{backgroundColor:r.glow},animate:{scale:[1,1.5,1],opacity:[.5,.8,.5]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"}}),e.jsx(P.div,{className:"relative p-6 rounded-full",style:{background:`linear-gradient(135deg, ${r.primary}, ${r.secondary})`,boxShadow:`0 0 40px ${r.glow}`},animate:{rotate:[0,5,-5,0]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx(og,{className:"w-16 h-16 text-white",style:{filter:"drop-shadow(0 0 10px white)"}})}),e.jsx(P.div,{className:"absolute -top-4 -right-4",animate:{scale:[0,1,0],opacity:[0,1,0]},transition:{duration:.8,repeat:1/0,delay:.5},children:e.jsx(bt,{className:"w-8 h-8",style:{color:r.secondary,filter:`drop-shadow(0 0 8px ${r.glow})`}})}),e.jsx(P.div,{className:"absolute -bottom-4 -left-4",animate:{scale:[0,1,0],opacity:[0,1,0]},transition:{duration:.8,repeat:1/0,delay:.8},children:e.jsx(bt,{className:"w-8 h-8",style:{color:r.secondary,filter:`drop-shadow(0 0 8px ${r.glow})`}})})]}),e.jsxs(P.div,{className:"text-center space-y-3",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},children:[e.jsx(P.h2,{className:"text-3xl md:text-4xl font-black text-foreground",style:{textShadow:`0 0 30px ${r.glow}`},animate:{opacity:[.8,1,.8]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"},children:"Astral Entity Detected!"}),e.jsx(P.p,{className:"text-lg text-muted-foreground",animate:{opacity:[.6,1,.6]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:"Prepare for battle..."})]})]})]}):null},di=n.forwardRef(({className:t,children:s,...a},r)=>e.jsxs(iu,{ref:r,className:I("relative overflow-hidden",t),...a,children:[e.jsx(lg,{className:"h-full w-full rounded-[inherit]",children:s}),e.jsx(Vm,{}),e.jsx(cg,{})]}));di.displayName=iu.displayName;const Vm=n.forwardRef(({className:t,orientation:s="vertical",...a},r)=>e.jsx(ou,{ref:r,orientation:s,className:I("flex touch-none select-none transition-colors",s==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",s==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",t),...a,children:e.jsx(dg,{className:"relative flex-1 rounded-full bg-border"})}));Vm.displayName=ou.displayName;const $n={vitality:{icon:"ðŸ’ª",name:"Vitality",color:"text-red-400",progressColor:"bg-red-400",whatItMeans:"Your life force, energy, and physical health. The engine of transformation.",boostedBy:["Fitness quests (gym, running, yoga)","Sleep rituals and rest goals","Nutrition and hydration habits","Cold showers and morning routines","Walking and step tracking"],whenGrows:"You build raw power and endurance. Your body becomes a vessel of strength and vitality."},wisdom:{icon:"ðŸ“š",name:"Wisdom",color:"text-blue-400",progressColor:"bg-blue-400",whatItMeans:"Pattern recognition, learning, and clarity. The foundation of insight.",boostedBy:["Reading books and articles","Studying and taking courses","Learning new skills","Mentor interactions and guidance","Reflection and journaling"],whenGrows:"You gain insight and understanding. Your mind sharpens and hidden patterns become clear."},discipline:{icon:"ðŸŽ¯",name:"Discipline",color:"text-green-400",progressColor:"bg-green-400",whatItMeans:"Reliability of action and consistency. The backbone of transformation.",boostedBy:["Completing daily rituals","Maintaining streaks","Showing up on hard days","Following through on plans","Deep work and Pomodoro sessions"],whenGrows:"You become someone who follows through. Your word to yourself becomes unbreakable."},resolve:{icon:"ðŸ›¡ï¸",name:"Resolve",color:"text-purple-400",progressColor:"bg-purple-400",whatItMeans:"Your ability to withstand pressure and resist urges. Inner fortitude.",boostedBy:["Resist victories","Astral Encounter wins","Comebacks after lapses","Staying strong during temptation","Overcoming setbacks"],whenGrows:"You become unshakeable. Pressure forges you into something stronger."},creativity:{icon:"ðŸŽ¨",name:"Creativity",color:"text-orange-400",progressColor:"bg-orange-400",whatItMeans:"Your ability to imagine, create, and express. The spark of originality.",boostedBy:["Shipping and building things","Writing and journaling","Art and design projects","Music and creative hobbies","Problem-solving and brainstorming"],whenGrows:"You see possibilities others miss. Your unique voice emerges."},alignment:{icon:"âœ¨",name:"Alignment",color:"text-celestial-blue",progressColor:"bg-celestial-blue",whatItMeans:"How aligned your actions are with who you want to be. Purpose and identity.",boostedBy:["Long-term campaign progress","Identity-based quests","Weekly reflections","Purpose journaling","Living by your values"],whenGrows:"You live with intention and meaning. Your actions reflect your truest self."}},Jb={vitality:["discipline","alignment"],wisdom:["creativity","alignment"],discipline:["resolve"],resolve:["discipline","alignment"],creativity:["wisdom","discipline"],alignment:["resolve"]},Hi=100,ic=1e3,zi=300,Xm=()=>{const{user:t}=_e(),s=Ie(),a=he({mutationFn:async({companionId:m,attribute:g,amount:y,applyEchoGains:b=!0})=>{if(!t)throw new Error("Not authenticated");const{data:w,error:x}=await k.from("user_companion").select("vitality, wisdom, discipline, resolve, creativity, alignment").eq("id",m).eq("user_id",t.id).maybeSingle();if(x)throw x;if(!w)throw new Error("Companion not found");const v=w[g]??zi,j=Math.max(Hi,Math.min(ic,v+y)),T={[g]:j,last_energy_update:new Date().toISOString()};if(b&&y>0){const N=Jb[g]||[],D=Math.min(20,Math.floor(y*.2));if(D>0)for(const R of N){const _=w[R]??zi;T[R]=Math.min(ic,Math.max(Hi,_+D))}}const{error:S}=await k.from("user_companion").update(T).eq("id",m).eq("user_id",t.id);if(S)throw S;return{attribute:g,newValue:j,change:y}},onSuccess:m=>{if(s.invalidateQueries({queryKey:["companion"]}),Math.abs(m.change)>=50){const g=m.change>0?"â¬†ï¸":"â¬‡ï¸",y=m.change>0?"increased":"decreased",b=Zb[m.attribute];V.success(`${g} ${b?.name||m.attribute} ${y}!`,{duration:2e3})}},onError:m=>{console.error("Attribute update failed:",m)}}),r=he({mutationFn:async m=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:m,attribute:"vitality",amount:12})}}),i=he({mutationFn:async m=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:m,attribute:"wisdom",amount:8})}}),o=he({mutationFn:async m=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:m,attribute:"discipline",amount:15})}}),l=he({mutationFn:async m=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:m,attribute:"discipline",amount:10})}}),c=he({mutationFn:async m=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:m,attribute:"resolve",amount:20})}}),d=he({mutationFn:async m=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:m,attribute:"creativity",amount:10})}}),u=he({mutationFn:async m=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:m,attribute:"alignment",amount:6})}}),p=he({mutationFn:async({companionId:m,streakDays:g})=>{if(!t)throw new Error("Not authenticated");let y=0;g===7?y=15:g===14?y=25:g===30?y=40:g%7===0&&(y=5),y>0&&await a.mutateAsync({companionId:m,attribute:"discipline",amount:y})}}),h=he({mutationFn:async m=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:m,attribute:"alignment",amount:8,applyEchoGains:!0})}}),f=he({mutationFn:async m=>{if(!t)throw new Error("Not authenticated");const{data:g,error:y}=await k.from("user_companion").select("vitality, wisdom, discipline, resolve, creativity, alignment").eq("id",m).eq("user_id",t.id).maybeSingle();if(y)throw y;if(!g)throw new Error("Companion not found");const b={discipline:40,vitality:30,creativity:25,resolve:20,wisdom:15,alignment:15},w={last_energy_update:new Date().toISOString()};for(const[v,j]of Object.entries(b)){const T=g[v]??zi;w[v]=Math.max(Hi,T-j)}const{error:x}=await k.from("user_companion").update(w).eq("id",m).eq("user_id",t.id);if(x)throw x}});return{updateAttribute:a.mutateAsync,updateVitalityFromFitness:r.mutateAsync,updateWisdomFromLearning:i.mutateAsync,updateDisciplineFromRitual:o.mutateAsync,updateDisciplineFromWork:l.mutateAsync,updateResolveFromResist:c.mutateAsync,updateCreativityFromShipping:d.mutateAsync,updateAlignmentFromReflection:u.mutateAsync,updateFromStreakMilestone:p.mutateAsync,updateFromPerfectDay:h.mutateAsync,decayStats:f.mutateAsync}},Zb={vitality:{name:"Vitality"},wisdom:{name:"Wisdom"},discipline:{name:"Discipline"},resolve:{name:"Resolve"},creativity:{name:"Creativity"},alignment:{name:"Alignment"}},al=()=>{const{profile:t}=ss();return n.useMemo(()=>{const s=t?.current_habit_streak??0,a=t?.longest_habit_streak??0;let r=1;s>=60?r=1.75:s>=30?r=1.5:s>=7&&(r=1.25);let i;return s<7?i={days:7,multiplier:1.25,daysRemaining:7-s}:s<30?i={days:30,multiplier:1.5,daysRemaining:30-s}:s<60?i={days:60,multiplier:1.75,daysRemaining:60-s}:i={days:60,multiplier:1.75,daysRemaining:0},{currentStreak:s,longestStreak:a,multiplier:r,nextMilestone:i}},[t?.current_habit_streak,t?.longest_habit_streak])},oc={quest:1,ritual:2,resist:3,pomodoro:1,mentor:1},ew=5,tw=7,sw="momentum_gain",lc={quest:"quest_count",ritual:"ritual_count",resist:"resist_count",pomodoro:"pomodoro_count",mentor:"mentor_count"},aw=()=>{const{user:t}=_e(),s=n.useCallback(()=>new Date().toISOString().split("T")[0],[]),a=n.useCallback(async o=>{if(!t?.id)return{canShow:!1,sourceCount:0,totalCount:0,sourceLimit:oc[o]};const l=s(),c=lc[o],d=oc[o],{data:u,error:p}=await k.from("user_reaction_budget").select("*").eq("user_id",t.id).eq("budget_date",l).maybeSingle();if(p)return console.error("Failed to check reaction budget:",p),{canShow:!1,sourceCount:0,totalCount:0,sourceLimit:d};if(!u)return{canShow:!0,sourceCount:0,totalCount:0,sourceLimit:d};const h=u[c]||0,f=u.total_count||0;return{canShow:h<d&&f<ew,sourceCount:h,totalCount:f,sourceLimit:d}},[t?.id,s]),r=n.useCallback(async o=>{if(!t?.id)return!1;const l=s(),c=lc[o],{data:d}=await k.from("user_reaction_budget").select("*").eq("user_id",t.id).eq("budget_date",l).maybeSingle();if(d){const u=d[c]||0,p=d.total_count||0,{error:h}=await k.from("user_reaction_budget").update({[c]:u+1,total_count:p+1,updated_at:new Date().toISOString()}).eq("id",d.id);if(h)return console.error("Failed to update reaction budget:",h),!1}else{const{error:u}=await k.from("user_reaction_budget").insert({user_id:t.id,budget_date:l,[c]:1,total_count:1,updated_at:new Date().toISOString()});if(u)return console.error("Failed to insert reaction budget:",u),!1}return!0},[t?.id,s]),i=n.useCallback(async()=>{if(!t?.id)return null;const o=s(),{data:l}=await k.from("user_reaction_budget").select("*").eq("user_id",t.id).eq("budget_date",o).maybeSingle();return l},[t?.id,s]);return{checkBudget:a,incrementBudget:r,getBudgetStatus:i}},rw=()=>{const{user:t}=_e(),s=n.useCallback(async()=>{if(!t?.id)return null;const{data:l}=await k.from("user_reaction_history").select("tone_tag").eq("user_id",t.id).order("shown_at",{ascending:!1}).limit(1).maybeSingle();return l?.tone_tag||null},[t?.id]),a=n.useCallback(async()=>{if(!t?.id)return!1;const l=new Date;l.setDate(l.getDate()-tw);const{data:c}=await k.from("user_reaction_history").select("reaction_id").eq("user_id",t.id).gte("shown_at",l.toISOString());if(!c||c.length===0)return!1;const d=c.map(p=>p.reaction_id).filter(Boolean);if(d.length===0)return!1;const{data:u}=await k.from("companion_reactions").select("id").in("id",d).contains("context_tags",["rare"]);return(u?.length||0)>0},[t?.id]),r=n.useCallback(async()=>{if(!t?.id)return new Set;const l=new Date;l.setDate(l.getDate()-7);const{data:c}=await k.from("user_reaction_history").select("reaction_id, shown_at").eq("user_id",t.id).gte("shown_at",l.toISOString());if(!c)return new Set;const d=c.map(m=>m.reaction_id).filter(Boolean);if(d.length===0)return new Set;const{data:u}=await k.from("companion_reactions").select("id, cooldown_hours").in("id",d);if(!u)return new Set;const p=new Map(u.map(m=>[m.id,m.cooldown_hours])),h=Date.now(),f=new Set;for(const m of c){if(!m.reaction_id)continue;const g=p.get(m.reaction_id)||12,y=new Date(m.shown_at).getTime(),b=g*60*60*1e3;h-y<b&&f.add(m.reaction_id)}return f},[t?.id]),i=n.useCallback(async(l,c,d=[])=>{if(!t?.id)return{reaction:null,reason:"No user"};const u=k.from("companion_reactions").select("id, text, tone_tag, context_tags, cooldown_hours").eq("is_active",!0).contains("source_systems",[l]),{data:p,error:h}=await u;if(h||!p||p.length===0)return{reaction:null,reason:"No reactions available"};let f=p;const{data:m}=await k.from("companion_reactions").select("id, text, tone_tag, context_tags, cooldown_hours").eq("is_active",!0).contains("source_systems",[l]).or(`moment_types.cs.{${c}},moment_types.eq.{}`);m&&m.length>0&&(f=m);const g=await r();if(f=f.filter(x=>!g.has(x.id)),f.length===0)return{reaction:null,reason:"All reactions on cooldown"};if(await a()&&(f=f.filter(x=>!x.context_tags?.includes("rare"))),f.length===0)return{reaction:null,reason:"No non-rare reactions available"};const b=await s();if(b){const x=f.filter(v=>v.tone_tag!==b);x.length>0&&(f=x)}if(d.length>0){const x=f.filter(v=>d.some(j=>v.context_tags?.includes(j)));x.length>0&&(f=x)}return{reaction:f[Math.floor(Math.random()*f.length)]}},[t?.id,r,a,s]),o=n.useCallback(async(l,c,d)=>{t?.id&&await k.from("user_reaction_history").insert({user_id:t.id,reaction_id:l.id,source_system:c,moment_type:d,reaction_text_snapshot:l.text,tone_tag:l.tone_tag})},[t?.id]);return{selectReaction:i,recordReaction:o}},_a=n.forwardRef(({className:t,...s},a)=>e.jsx(lu,{ref:a,className:I("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",t),...s}));_a.displayName=lu.displayName;const ja=n.forwardRef(({className:t,...s},a)=>e.jsx(cu,{ref:a,className:I("aspect-square h-full w-full",t),...s}));ja.displayName=cu.displayName;const Na=n.forwardRef(({className:t,...s},a)=>e.jsx(du,{ref:a,className:I("flex h-full w-full items-center justify-center rounded-full bg-muted",t),...s}));Na.displayName=du.displayName;const nw=t=>{const s=t.length;return Math.min(5,Math.max(3.2,3+s/50))},Jm=n.memo(({isVisible:t,onDismiss:s,message:a,companionName:r,companionImageUrl:i})=>{const[o,l]=n.useState(0),c=nw(a),d=r.trim().length>0,u=typeof window<"u"&&window.matchMedia?.("(prefers-reduced-motion: reduce)").matches;n.useEffect(()=>{if(!t){l(0);return}const h=Date.now(),f=c*1e3,m=setInterval(()=>{const g=Date.now()-h,y=Math.min(100,g/f*100);l(y),g>=f&&(clearInterval(m),s())},50);return()=>clearInterval(m)},[t,c,s]);const p=n.useCallback(()=>{s()},[s]);return n.useEffect(()=>{if(!t)return;const h=f=>{(f.key==="Escape"||f.key==="Enter"||f.key===" ")&&(f.preventDefault(),p())};return window.addEventListener("keydown",h),()=>window.removeEventListener("keydown",h)},[t,p]),e.jsx(Re,{children:t&&e.jsx(P.div,{initial:u?{opacity:1}:{opacity:0,y:20},animate:{opacity:1,y:0},exit:u?{opacity:0}:{opacity:0,y:10},transition:{duration:.2,ease:"easeOut"},className:I("fixed left-4 right-4 z-50 cursor-pointer","max-w-[680px] mx-auto","bottom-[calc(64px+env(safe-area-inset-bottom,0px)+12px)]"),onClick:p,role:"dialog","aria-modal":"false","aria-label":d?`${r} says: ${a}`:`Companion says: ${a}`,children:e.jsxs("div",{className:I("relative rounded-2xl overflow-hidden","bg-card/95 backdrop-blur-lg","border border-primary/20","shadow-lg shadow-primary/10"),children:[e.jsxs("div",{className:"flex items-start gap-4 p-4",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:I("rounded-xl overflow-hidden","ring-2 ring-primary/30","shadow-md shadow-primary/20"),children:e.jsxs(_a,{className:"h-16 w-16 rounded-xl",children:[i?e.jsx(ja,{src:i,alt:r,className:"object-cover"}):null,e.jsx(Na,{className:"rounded-xl bg-primary/20 text-primary text-lg font-bold",children:r.charAt(0)})]})}),e.jsx("div",{className:"absolute inset-0 rounded-xl bg-primary/10 blur-xl -z-10"})]}),e.jsxs("div",{className:"flex-1 min-w-0 pt-1",children:[e.jsxs("p",{className:"text-foreground text-base leading-relaxed",children:['"',a,'"']}),d?e.jsxs("p",{className:"mt-2 text-sm text-muted-foreground flex items-center gap-1",children:["â€” ",r," ",e.jsx("span",{className:"text-primary",children:"âœ¨"})]}):null]}),e.jsx("button",{onClick:h=>{h.stopPropagation(),p()},className:I("flex-shrink-0 p-1.5 rounded-full","text-muted-foreground hover:text-foreground","hover:bg-muted/50 transition-colors","focus:outline-none focus:ring-2 focus:ring-primary/50"),"aria-label":"Dismiss",children:e.jsx(kt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"px-4 pb-3",children:e.jsx(Ys,{value:o,className:"h-1 bg-muted/30"})})]})})})});Jm.displayName="CompanionTalkPopup";const iw=t=>t.replace(/\b\w/g,s=>s.toUpperCase()),Pn=t=>{if(typeof t!="string")return null;const s=t.trim();return s.length>0?s:null},Ki=(t,s)=>{switch(t){case"species":{const a=Pn(s);return a?iw(a):"Companion"}case"companion":return"Companion";default:return""}},rl=async({companion:t,overrideName:s,fallback:a="empty"})=>{if(s!==void 0)return Pn(s)??Ki(a,t?.spirit_animal);if(!t)return Ki(a);const r=Pn(t.cached_creature_name);if(r)return r;try{const{data:i}=await k.from("companion_evolution_cards").select("creature_name").eq("companion_id",t.id).eq("evolution_stage",t.current_stage).maybeSingle(),o=Pn(i?.creature_name);if(o)return k.from("user_companion").update({cached_creature_name:o}).eq("id",t.id),o}catch(i){console.error("Failed to resolve companion name:",i)}return Ki(a,t.spirit_animal)},Zm=n.createContext(null),ep=n.memo(({children:t})=>{const{companion:s}=At(),[a,r]=n.useState(!1),[i,o]=n.useState(""),[l,c]=n.useState(""),[d,u]=n.useState(null),p=n.useRef([]),h=n.useRef(!1),f=n.useCallback(async g=>{if(h.current){p.current.push(g);return}h.current=!0;const y=await rl({companion:s,overrideName:g.companionName,fallback:"empty"}),b=g.companionImageUrl||s?.current_image_url||null;o(g.message),c(y),u(b),r(!0)},[s]),m=n.useCallback(()=>{r(!1),h.current=!1;const g=p.current.shift();g&&setTimeout(()=>f(g),300)},[f]);return e.jsxs(Zm.Provider,{value:{show:f,dismiss:m,isVisible:a},children:[t,e.jsx(Jm,{isVisible:a,onDismiss:m,message:i,companionName:l,companionImageUrl:d})]})});ep.displayName="TalkPopupProvider";const tp=()=>{const t=n.useContext(Zm);return t||{show:async()=>{},dismiss:()=>{},isVisible:!1}},en=()=>{const{user:t}=_e(),s=tp(),{checkBudget:a,incrementBudget:r}=aw(),{selectReaction:i,recordReaction:o}=rw(),l=n.useCallback(async(m,g={})=>{if(!t?.id)return!1;const{momentType:y=sw,contextTags:b=[],force:w=!1}=g;if(!w&&!(await a(m)).canShow)return console.log(`[LivingCompanion] Budget exceeded for ${m}`),!1;const{reaction:x,reason:v}=await i(m,y,b);return x?(await s.show({message:x.text}),await Promise.all([o(x,m,y),r(m)]),console.log(`[LivingCompanion] Showed reaction: "${x.text}" (${x.tone_tag})`),!0):(console.log(`[LivingCompanion] No reaction available: ${v}`),!1)},[t?.id,a,i,s,o,r]),c=n.useCallback(()=>{const m=new Date().getHours();return m>=23||m<4},[]),d=n.useCallback(async()=>{const m=c()?["late_night"]:[];return l("resist",{momentType:"urge_defeated",contextTags:m})},[l,c]),u=n.useCallback(async(m=!1)=>m?l("quest",{momentType:"momentum_gain"}):!1,[l]),p=n.useCallback(async(m=!1,g=!1)=>!m&&!g?!1:l("ritual",{momentType:g?"breakthrough":"discipline_win"}),[l]),h=n.useCallback(async m=>m<15?!1:l("pomodoro",{momentType:"focus_proof"}),[l]),f=n.useCallback(async()=>l("quest",{momentType:"comeback"}),[l]);return{triggerReaction:l,triggerResistVictory:d,triggerQuestComplete:u,triggerRitualComplete:p,triggerPomodoroComplete:h,triggerComeback:f,isLateNight:c}},ow=new Set(["task_complete","habit_complete","focus_session"]),yn=async t=>{const s=new Date().toISOString().split("T")[0];await k.from("user_companion").update({last_activity_date:s,inactive_days:0,current_mood:"happy"}).eq("user_id",t)},rs=()=>{const{user:t}=_e(),{companion:s,awardXP:a}=At(),{showXPToast:r}=vm(),i=Ie(),{multiplier:o}=al(),{updateDisciplineFromRitual:l,updateWisdomFromLearning:c,updateAlignmentFromReflection:d,updateFromStreakMilestone:u}=Xm(),{triggerQuestComplete:p}=en(),h=async()=>{if(!t?.id)return!1;const U=new Date().toISOString().split("T")[0],{count:ce}=await k.from("daily_tasks").select("*",{count:"exact",head:!0}).eq("user_id",t.id).eq("task_date",U).eq("completed",!0);return(ce??0)<=1},f=(U,ce)=>ow.has(ce)?Math.round(U*(o??1)):U,m=(U,ce)=>{const se=ce?Object.entries(ce).filter(([,xe])=>xe!==void 0).map(([xe,G])=>`${xe}:${String(G)}`).sort().join("|"):"none",ne=typeof crypto<"u"&&"randomUUID"in crypto?crypto.randomUUID():`${Date.now()}-${Math.random().toString(36).slice(2,10)}`;return`${U}:${se}:${ne}`},g=(U,ce,se,ne)=>{a.mutate({eventType:U,xpAmount:ce,metadata:se,idempotencyKey:m(U,se)})},y=(U,ce,se,ne)=>a.mutateAsync({eventType:U,xpAmount:ce,metadata:se,idempotencyKey:m(U,se)}),b=async()=>{if(!(!s||a.isPending))try{t?.id&&yn(t.id).then(()=>{i.invalidateQueries({queryKey:["companion-health"]})});const U=f(ks.HABIT_COMPLETE,"habit_complete");r(U,"Habit Completed!"),g("habit_complete",U);const ce=s.id;ce&&(c(ce).catch(se=>{ue.error("Wisdom update failed:",se)}),l(ce).catch(se=>{ue.error("Discipline update failed:",se)})),h().then(se=>{p(se).catch(ne=>ue.log("[LivingCompanion] Quest reaction failed:",ne))})}catch(U){ue.error("Error awarding habit completion:",U)}},w=()=>{if(!s)return;const U=ks.ALL_HABITS_COMPLETE;r(U,"All Habits Complete!"),g("all_habits_complete",U)},x=()=>{if(!s)return;t?.id&&yn(t.id).then(()=>{i.invalidateQueries({queryKey:["companion-health"]})});const U=ks.CHALLENGE_COMPLETE;r(U,"Challenge Complete!"),g("challenge_complete",U)},v=()=>{if(!s)return;t?.id&&yn(t.id).then(()=>{i.invalidateQueries({queryKey:["companion-health"]})});const U=ks.WEEKLY_CHALLENGE;r(U,"Weekly Challenge Done!"),g("weekly_challenge",U)},j=U=>{if(!s)return;const ce=ks.PEP_TALK_LISTEN;r(ce,"Pep Talk Listened!"),g("pep_talk_listen",ce,U)},T=async()=>{if(!(!s||a.isPending))try{t?.id&&yn(t.id).then(()=>{i.invalidateQueries({queryKey:["companion-health"]})});const U=ks.CHECK_IN;r(U,"Check-In Complete!"),g("check_in",U);const ce=s.id;ce&&(d(ce).catch(se=>{ue.error("Alignment update failed:",se)}),l(ce).catch(se=>{ue.error("Discipline update failed:",se)}))}catch(U){ue.error("Error awarding check-in:",U)}};return{awardHabitCompletion:b,awardAllHabitsComplete:w,awardChallengeCompletion:x,awardWeeklyChallengeCompletion:v,awardPepTalkListened:j,awardCheckInComplete:T,awardStreakMilestone:async U=>{if(!(!s||a.isPending))try{const ce=ks.STREAK_MILESTONE;r(ce,`${U} Day Streak!`),g("streak_milestone",ce,{milestone:U});const se=s.id;if(se&&(u({companionId:se,streakDays:U}).catch(ne=>ue.error("Discipline streak update failed:",ne)),U===7||U===30||U===100)){const ne=new Date().toISOString().split("T")[0];k.from("companion_memories").insert({user_id:t?.id,companion_id:se,memory_type:"streak",memory_date:ne,memory_context:{title:`${U}-Day Streak`,description:`${U} days of dedication and growth together.`,emotion:U>=30?"joy":"pride",details:{streakDays:U}},referenced_count:0}).then(({error:xe})=>{xe&&ue.error("Failed to create streak memory:",xe)})}}catch(ce){ue.error("Error awarding streak milestone:",ce)}},awardReflectionComplete:async()=>{if(!(!s||a.isPending))try{const U=ks.EVENING_REFLECTION;r(U,"Reflection Saved!"),g("evening_reflection",U);const ce=s.id;ce&&d(ce).catch(se=>ue.error("Alignment update failed:",se))}catch(U){ue.error("Error awarding reflection:",U)}},awardQuoteShared:()=>{if(!s)return;const U=ks.PEP_TALK_LISTEN;r(U,"Quote Shared!"),g("quote_shared",U)},awardCustomXP:async(U,ce,se,ne)=>{if(!s){ue.warn("Cannot award XP: companion not loaded yet");return}if(a.isPending){ue.warn("Cannot award XP: previous award still in progress");return}const xe=f(U,ce);se&&xe>0&&r(xe,se);try{return await y(ce,xe,ne)}catch(G){ue.error("Error awarding custom XP:",G)}},awardFocusSessionComplete:(U=!1,ce=!0)=>{if(!s||a.isPending)return;let se,ne;ce?(se=Cs.SESSION_COMPLETE,ne="Focus Session Complete!",U&&(se+=Cs.PERFECT_FOCUS_BONUS,ne="Perfect Focus! ðŸŽ¯")):(se=Cs.CAPPED_SESSION_XP,ne=U?"Bonus Focus! ðŸŽ¯":"Bonus Focus Session!");const xe=f(se,"focus_session");r(xe,ne),g("focus_session",xe,{isPerfect:U,isUnderCap:ce})},awardSubtaskComplete:()=>{if(!s)return;const U=Li.SUBTASK_COMPLETE;r(U,"Subtask Done!"),g("subtask_complete",U)},awardAllSubtasksComplete:()=>{if(!s)return;const U=Li.ALL_SUBTASKS_BONUS;r(U,"All Subtasks Complete! ðŸŽ‰"),g("all_subtasks_complete",U)},awardTopThreeComplete:()=>{if(!s)return;const U=fn.TOP_THREE_COMPLETE;r(U,"Top 3 Task Done! ðŸŽ¯"),g("top_three_complete",U)},awardAllTopThreeComplete:()=>{if(!s)return;const U=fn.ALL_TOP_THREE_BONUS;r(U,"All Top 3 Complete! ðŸ†"),g("all_top_three_complete",U)},awardUrgentTaskComplete:()=>{if(!s)return;const U=fn.URGENT_IMPORTANT;r(U,"Urgent Task Done!"),g("urgent_task_complete",U)},awardInboxProcessed:()=>{if(!s)return;const U=gn.PROCESS_INBOX;g("inbox_processed",U)},awardInboxZero:()=>{if(!s)return;const U=gn.INBOX_ZERO;r(U,"Inbox Zero! ðŸ“­"),g("inbox_zero",U)},awardVoiceCapture:()=>{if(!s)return;const U=gn.VOICE_CAPTURE;g("voice_capture",U)},awardWeeklyReview:()=>{if(!s)return;const U=vr.WEEKLY_REVIEW;r(U,"Weekly Review Complete! ðŸ“Š"),g("weekly_review",U)},awardDailyReview:()=>{if(!s)return;const U=vr.DAILY_REVIEW;r(U,"Daily Review Done!"),g("daily_review",U)},awardHighProductivityDay:()=>{if(!s)return;const U=vr.HIGH_PRODUCTIVITY_DAY;r(U,"Productive Day! ðŸ“ˆ"),g("high_productivity_day",U)},awardPerfectDay:()=>{if(!s)return;const U=vr.PERFECT_DAY;r(U,"Perfect Day! â­"),g("perfect_day",U)},awardOnTimeCompletion:()=>{if(!s)return;const U=Oi.ON_TIME_COMPLETION;g("on_time_completion",U)},awardContextMatch:()=>{if(!s)return;const U=Oi.CONTEXT_MATCH;g("context_match",U)},awardMilestoneComplete:(U=!1)=>{if(!s||a.isPending)return;const se=U?pa.POSTCARD:pa.REGULAR;r(se,U?"Celebration Milestone!":"Milestone Complete!"),g(U?"postcard_milestone":"milestone_complete",se)},awardPhaseComplete:U=>{if(!s||a.isPending)return;const ce=pa.PHASE_COMPLETE;r(ce,`Phase Complete: ${U}!`),g("phase_complete",ce,{phaseName:U})},awardEpicComplete:U=>{if(!s||a.isPending)return;const ce=pa.EPIC_COMPLETE;r(ce,"Epic Complete! ðŸ†"),g("epic_complete",ce,{epicTitle:U});const se=s.id;if(se&&t?.id){const ne=new Date().toISOString().split("T")[0];k.from("companion_memories").insert({user_id:t.id,companion_id:se,memory_type:"epic_complete",memory_date:ne,memory_context:{title:"Epic Complete",description:`We conquered "${U}" together!`,emotion:"pride",details:{epicTitle:U}},referenced_count:0}).then(({error:xe})=>{xe&&ue.error("Failed to create epic memory:",xe)})}},awardCheckIn:T,awardChallengeComplete:x,awardWeeklyChallenge:v,awardPepTalkListen:j,XP_REWARDS:ks,FOCUS_XP_REWARDS:Cs,SUBTASK_XP_REWARDS:Li,PRIORITY_XP_REWARDS:fn,INBOX_XP_REWARDS:gn,PRODUCTIVITY_XP_REWARDS:vr,SCHEDULING_XP_REWARDS:Oi,MILESTONE_XP_REWARDS:pa}},lw=10,cw=2,dw=new Set(["energy_beam","tap_sequence","astral_frequency","eclipse_timing","starfall_dodge","soul_serpent","orb_match","galactic_match","cosmiq_grid","stellar_flow"]),uw=()=>{const{user:t}=_e(),{companion:s}=At(),{awardCustomXP:a}=rs(),{checkAdversaryDefeatAchievements:r}=ci(),i=Ie(),{triggerResistVictory:o}=en(),l=n.useCallback((E,O)=>{if(E)throw new Error(`${O}: ${E.message}`)},[]),c=n.useCallback(E=>{if(!E||typeof E!="object")return!1;const O=E,M=O.code??"",A=O.message??"";return M==="23505"||A.includes("idx_astral_encounters_one_active_per_user")},[]),[d,u]=n.useState(null),[p,h]=n.useState(!1),[f,m]=n.useState(!1),g=n.useRef(!1),{data:y,isLoading:b}=Ee({queryKey:["astral-encounters",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:E,error:O}=await k.from("astral_encounters").select("*").eq("user_id",t.id).order("created_at",{ascending:!1}).limit(50);if(O)throw O;return E},enabled:!!t?.id}),{data:w,isLoading:x}=Ee({queryKey:["adversary-essences",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:E,error:O}=await k.from("adversary_essences").select("*").eq("user_id",t.id).order("absorbed_at",{ascending:!1});if(O)throw O;return E},enabled:!!t?.id}),{data:v,isLoading:j}=Ee({queryKey:["cosmic-codex",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:E,error:O}=await k.from("cosmic_codex_entries").select("*").eq("user_id",t.id).order("times_defeated",{ascending:!1});if(O)throw O;return E},enabled:!!t?.id}),T=w?.reduce((E,O)=>{const M=O.stat_type;return E[M]=(E[M]||0)+O.stat_boost,E},{mind:0,body:0,soul:0})||{mind:0,body:0,soul:0},S=he({mutationFn:async E=>{if(!t?.id||!s?.id)throw new Error("User or companion not found");const O=Array.from(new Set((y??[]).slice(0,lw).map($=>$.adversary_name?.trim()).filter($=>!!$))),M=(y??[]).map($=>$.mini_game_type).filter($=>dw.has($)).slice(0,cw),A=Ob(E.triggerType,E.epicProgress,E.epicCategory,void 0,{avoidNames:O,recentMiniGames:M}),{data:L,error:q}=await k.from("astral_encounters").insert({user_id:t.id,companion_id:s.id,adversary_name:A.name,adversary_theme:A.theme,adversary_tier:A.tier,adversary_lore:A.lore,mini_game_type:A.miniGameType,trigger_type:E.triggerType,trigger_source_id:E.triggerSourceId||null,total_phases:A.phases}).select().single();if(q)throw q;return{encounter:L,adversary:A,questInterval:E.questInterval}},onSuccess:({encounter:E,adversary:O,questInterval:M})=>{u({encounter:E,adversary:O,questInterval:M}),h(!1),i.invalidateQueries({queryKey:["astral-encounters"]})},onError:E=>{console.error("Failed to start encounter:",E),c(E)||V.error("Failed to start encounter")}}),N=he({mutationFn:async E=>{if(!t?.id||!s?.id||!d)throw new Error("Missing required data");const O=Ym(E.accuracy),M=Gm(d.adversary.tier,E.accuracy),{error:A}=await k.from("astral_encounters").update({result:O,accuracy_score:E.accuracy,xp_earned:M,essence_earned:O!=="fail"?d.adversary.essenceName:null,stat_boost_type:O!=="fail"?d.adversary.statType:null,stat_boost_amount:O!=="fail"?d.adversary.statBoost:0,phases_completed:E.phasesCompleted,completed_at:new Date().toISOString(),retry_available_at:O==="fail"?new Date(Date.now()+14400*1e3).toISOString():null}).eq("id",E.encounterId);if(A)throw A;if(O!=="fail"){const{error:L}=await k.from("adversary_essences").insert({user_id:t.id,companion_id:s.id,encounter_id:E.encounterId,essence_name:d.adversary.essenceName,essence_description:d.adversary.essenceDescription,stat_type:d.adversary.statType,stat_boost:d.adversary.statBoost,adversary_name:d.adversary.name,adversary_theme:d.adversary.theme,rarity:d.adversary.tier});l(L,"Failed to insert adversary essence");const{data:q,error:$}=await k.from("cosmic_codex_entries").select("id, times_defeated").eq("user_id",t.id).eq("adversary_theme",d.adversary.theme).maybeSingle();l($,"Failed to query cosmic codex entry");let B=1;if(q){B=q.times_defeated+1;const{error:se}=await k.from("cosmic_codex_entries").update({times_defeated:B,last_defeated_at:new Date().toISOString()}).eq("id",q.id);l(se,"Failed to update cosmic codex entry")}else{const{error:se}=await k.from("cosmic_codex_entries").insert({user_id:t.id,adversary_theme:d.adversary.theme,adversary_name:d.adversary.name,adversary_lore:d.adversary.lore});l(se,"Failed to insert cosmic codex entry")}const W=d.adversary.theme,{shouldRollLoot:H,lootTier:K}=await r(W,B);if(H&&K){const se=K==="legendary"?["rare","epic","legendary"]:K==="epic"?["rare","epic"]:["rare"],{data:ne,error:xe}=await k.from("epic_rewards").select("*").eq("adversary_theme",W).in("rarity",se);if(l(xe,"Failed to fetch theme loot"),ne&&ne.length>0){const G=ne.reduce((Se,Pe)=>Se+(Pe.drop_weight||100),0);let ye=Math.random()*G,we=ne[0];for(const Se of ne)if(ye-=Se.drop_weight||100,ye<=0){we=Se;break}const{data:Te,error:qe}=await k.from("user_epic_rewards").select("id").eq("user_id",t.id).eq("reward_id",we.id).maybeSingle();if(l(qe,"Failed to check existing epic reward"),!Te){const{error:Se}=await k.from("user_epic_rewards").insert({user_id:t.id,reward_id:we.id});l(Se,"Failed to award epic reward"),V.success(`ðŸŽ New Loot: ${we.name}!`,{description:we.description})}}}const X={mind:"wisdom",body:"vitality",soul:"resolve"},Y=d.adversary.statType,ee=X[Y];if(!ee)return console.error("Invalid stat type:",Y),{result:O,xpEarned:M};const fe={vitality:s?.vitality??300,wisdom:s?.wisdom??300,discipline:s?.discipline??300,resolve:s?.resolve??300,creativity:s?.creativity??300,alignment:s?.alignment??300}[ee],U=Math.min(1e3,fe+d.adversary.statBoost*3),{error:ce}=await k.from("user_companion").update({[ee]:U}).eq("id",s.id);l(ce,"Failed to update companion stats"),M>0&&await a(M,"astral_encounter",`Defeated ${d.adversary.name}`)}if(d.encounter.trigger_type==="urge_resist"){const L=d.encounter.trigger_source_id;if(L){const{data:q,error:$}=await k.from("user_bad_habits").select("*").eq("id",L).maybeSingle();if(l($,"Failed to fetch bad habit"),q){const B=O!=="fail",W=B?.05:0,{error:H}=await k.from("resist_log").insert({user_id:t.id,habit_id:L,encounter_id:E.encounterId,result:O,xp_earned:M,care_boost:W});l(H,"Failed to write resist log");const K=new Date,X=q.last_resisted_at?new Date(q.last_resisted_at):null,Y=X?.toDateString()===K.toDateString(),ee=X?.toDateString()===new Date(Date.now()-864e5).toDateString();let ie=q.current_streak;B?ie=ee?q.current_streak+1:Y?q.current_streak:1:ie=0;const{error:fe}=await k.from("user_bad_habits").update({times_resisted:q.times_resisted+(B?1:0),current_streak:ie,longest_streak:Math.max(q.longest_streak,ie),last_resisted_at:K.toISOString()}).eq("id",L);if(l(fe,"Failed to update bad habit stats"),B&&s){const U=s.care_recovery??0,{error:ce}=await k.from("user_companion").update({care_recovery:Math.min(1,U+W)}).eq("id",s.id);l(ce,"Failed to update companion care recovery")}B&&V.success("You resisted! Your companion grows stronger.",{description:`+${M} XP â€¢ Streak: ${ie}`})}}}return{result:O,xpEarned:M}},onSuccess:({result:E,xpEarned:O})=>{i.invalidateQueries({queryKey:["astral-encounters"]}),i.invalidateQueries({queryKey:["adversary-essences"]}),i.invalidateQueries({queryKey:["cosmic-codex"]}),i.invalidateQueries({queryKey:["user-epic-rewards"]}),i.invalidateQueries({queryKey:["companion"]}),i.invalidateQueries({queryKey:["bad-habits"]}),i.invalidateQueries({queryKey:["resist-log"]}),E!=="fail"&&d?.encounter.trigger_type!=="urge_resist"&&V.success(`Victory! +${O} XP`),E!=="fail"&&d?.encounter.trigger_type==="urge_resist"&&o().catch(M=>console.log("[LivingCompanion] Resist trigger failed:",M))},onError:E=>{console.error("Failed to complete encounter:",E),V.error("Failed to complete encounter")}}),D=n.useCallback(E=>{const O=E.adversary_theme,M=E.adversary_tier;return{name:E.adversary_name,theme:O,tier:M,lore:E.adversary_lore||"",miniGameType:E.mini_game_type,phases:E.total_phases||1,essenceName:`Essence of ${E.adversary_name}`,essenceDescription:`Power absorbed from defeating ${E.adversary_name}`,statType:Km[O]||"mind",statBoost:sl[M]?.statBoost||1}},[]),R=n.useCallback(async(E,O,M,A,L)=>{if(!t?.id)return{ok:!1,started:!1,resumed:!1,reason:"not_authenticated"};if(!s?.id)return console.warn("Encounter trigger skipped: companion not ready"),{ok:!1,started:!1,resumed:!1,reason:"companion_not_ready"};if(g.current)return{ok:!1,started:!1,resumed:!1,reason:"trigger_in_progress"};g.current=!0,m(!0);try{const{data:q,error:$}=await k.from("astral_encounters").select("*").eq("user_id",t.id).is("completed_at",null).order("created_at",{ascending:!1}).limit(20);if($)return console.error("Failed to lookup pending encounters:",$),{ok:!1,started:!1,resumed:!1,reason:"pending_lookup_failed"};const B=q??[],W=B[0]??null,H=B.slice(1).map(K=>K.id);if(H.length>0){const{error:K}=await k.from("astral_encounters").update({completed_at:new Date().toISOString()}).in("id",H).is("completed_at",null);K&&console.error("Failed to close stale pending encounters:",K)}if(W){const K=D(W);return u({encounter:W,adversary:K,questInterval:L??3}),h(!1),{ok:!0,started:!1,resumed:!0}}return await S.mutateAsync({triggerType:E,triggerSourceId:O,epicProgress:M,epicCategory:A,questInterval:L}),{ok:!0,started:!0,resumed:!1}}catch(q){if(c(q)){const{data:$,error:B}=await k.from("astral_encounters").select("*").eq("user_id",t.id).is("completed_at",null).order("created_at",{ascending:!1}).limit(1);if(B)return console.error("Failed to recover pending encounter after duplicate create:",B),{ok:!1,started:!1,resumed:!1,reason:"pending_lookup_failed"};const W=$?.[0];if(W){const H=D(W);return u({encounter:W,adversary:H,questInterval:L??3}),h(!1),{ok:!0,started:!1,resumed:!0}}}return console.error("Failed to trigger encounter:",q),{ok:!1,started:!1,resumed:!1,reason:"start_failed"}}finally{g.current=!1,m(!1)}},[t?.id,s?.id,D,c,S]),_=n.useCallback(()=>{h(!1),u(null)},[]),C=n.useCallback(async()=>{if(!d)return!1;try{const{error:E}=await k.from("astral_encounters").delete().eq("id",d.encounter.id);return l(E,"Failed to delete encounter"),u(null),h(!1),i.invalidateQueries({queryKey:["astral-encounters"]}),!0}catch(E){return console.error("Failed to pass encounter:",E),V.error("Failed to pass encounter"),!1}},[d,i,l]);return{activeEncounter:d,showEncounterModal:p,encounters:y,essences:w,codexEntries:v,totalStatBoosts:T,isLoading:b||x||j,isStarting:S.isPending,isTriggeringEncounter:f,isCompleting:N.isPending,startEncounter:S.mutate,startEncounterAsync:S.mutateAsync,completeEncounter:N.mutate,completeEncounterAsync:N.mutateAsync,checkEncounterTrigger:R,closeEncounter:_,passEncounter:C,setShowEncounterModal:h}},sp=n.createContext(null),mw=({children:t})=>{const s=uw();return e.jsx(sp.Provider,{value:s,children:t})},ap=()=>{const t=n.useContext(sp);if(!t)throw new Error("useAstralEncounterContext must be used within AstralEncounterContextProvider");return t},rp="encounter_passes",cc=3,dc=()=>new Date().toISOString().split("T")[0],pw=()=>{const t=st.getItem(rp);if(!t)return null;try{return JSON.parse(t)}catch{return null}},uc=t=>{st.setItem(rp,JSON.stringify(t))},hw=()=>{const[t,s]=n.useState(0);n.useEffect(()=>{const i=dc(),o=pw();o&&o.date===i?s(o.count):(uc({date:i,count:0}),s(0))},[]);const a=n.useCallback(()=>{const i=dc(),o=t+1;return uc({date:i,count:o}),s(o),o},[t]),r=t>=cc;return{passCount:t,recordPass:a,shouldPromptDisable:r,promptThreshold:cc}},fw=({open:t,onDisable:s,onKeepOn:a,passCount:r})=>e.jsx(mr,{open:t,onOpenChange:i=>!i&&a(),children:e.jsxs(Ea,{className:"sm:max-w-md",children:[e.jsxs(Ta,{children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("div",{className:"p-3 rounded-full bg-primary/10",children:e.jsx(sr,{className:"w-8 h-8 text-primary"})})}),e.jsx(Da,{className:"text-center",children:"Taking a Break from Encounters?"}),e.jsxs(Aa,{className:"text-center",children:["You've passed on ",r," encounters today. Would you like to disable Astral Encounters? You can re-enable them anytime in your Profile settings."]})]}),e.jsxs(Ma,{className:"flex-col gap-2 sm:flex-col",children:[e.jsxs(la,{onClick:s,className:"w-full",children:[e.jsx(sr,{className:"w-4 h-4 mr-2"}),"Disable Encounters"]}),e.jsxs(Pa,{onClick:a,className:"w-full mt-0",children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),"Keep Them On"]})]})]})}),gw=({children:t})=>{const[s,a]=n.useState(!1),[r,i]=n.useState("common"),[o,l]=n.useState(!1),c=n.useRef(null),{user:d}=_e(),{passCount:u,recordPass:p}=hw(),{activeEncounter:h,showEncounterModal:f,setShowEncounterModal:m,completeEncounterAsync:g,closeEncounter:y,passEncounter:b}=ap();n.useEffect(()=>{const N=h?.encounter.id??null;if(!N){c.current=null,a(!1);return}c.current!==N&&(c.current=N,i(h?.adversary.tier||"common"),m(!1),a(!0))},[h?.encounter.id,h?.adversary.tier,m]);const w=n.useCallback(()=>{a(!1),m(!0)},[m]),x=n.useCallback(N=>{if(!N){y();return}m(!0)},[y,m]),v=n.useCallback(async N=>{try{return await g(N),!0}catch{return!1}},[g]),j=n.useCallback(async()=>{if(!await b()){y(),V.error("Could not pass encounter. Exited battle and kept it pending.");return}p()>=3&&l(!0)},[y,p,b]),T=n.useCallback(async()=>{if(d?.id)try{const{error:N}=await k.from("profiles").update({astral_encounters_enabled:!1}).eq("id",d.id);if(N)throw N;l(!1),V.success("Astral Encounters disabled. Re-enable in Profile settings.")}catch(N){console.error("Failed to disable encounters:",N),V.error("Failed to disable encounters")}},[d?.id]),S=n.useCallback(()=>{l(!1)},[]);return e.jsxs(e.Fragment,{children:[t,e.jsx(Xb,{isVisible:s,tier:r,onComplete:w}),e.jsx(Yb,{open:f,onOpenChange:x,encounter:h?.encounter||null,adversary:h?.adversary||null,questInterval:h?.questInterval,onComplete:v,onPass:j}),e.jsx(fw,{open:o,onDisable:T,onKeepOn:S,passCount:u})]})},xw=({children:t})=>e.jsx(mw,{children:e.jsx(gw,{children:t})}),Wa=n.memo(({icon:t,label:s,value:a,maxValue:r,color:i,animate:o=!1,compact:l=!1})=>e.jsxs(P.div,{className:`flex items-center gap-1.5 rounded-xl stat-pill ${l?"px-2 py-1":"px-3 py-1.5"}`,animate:o?{scale:[1,1.08,1]}:{},transition:{duration:.25},children:[e.jsx("div",{className:l?"p-1 rounded-md":"p-1.5 rounded-lg",style:{backgroundColor:`${i}20`},children:t}),e.jsxs("div",{className:"flex flex-col",children:[!l&&e.jsx("span",{className:"text-[10px] uppercase tracking-wider text-white/50 font-medium",children:s}),e.jsxs("span",{className:`font-bold ${l?"text-xs":"text-sm"}`,style:{color:i},children:[a,r!==void 0&&e.jsxs("span",{className:"text-white/40 font-normal",children:["/",r]})]})]})]}));Wa.displayName="StatBadge";const yw=n.memo(({score:t,maxScore:s,timeLeft:a,totalTime:r,combo:i=0,showCombo:o=!1,phase:l,totalPhases:c,isPaused:d,onPauseToggle:u,title:p,subtitle:h,primaryStat:f,secondaryStat:m,compact:g=!1})=>{const[y,b]=n.useState(t),[w,x]=n.useState(!1);n.useEffect(()=>{t!==y&&t!==void 0&&t>(y||0)&&(x(!0),setTimeout(()=>x(!1),250)),b(t)},[t,y]);const v=r&&a!==void 0?a/r*100:100,j=a!==void 0&&a<=3;return e.jsxs("div",{className:`w-full ${g?"px-2 py-1 mb-1":"px-3 py-2 mb-2"}`,children:[!g&&e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-base font-bold text-white tracking-tight",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"},children:p}),h&&e.jsx("p",{className:"text-[10px] text-white/60 font-medium tracking-wide",children:h})]}),u&&e.jsx(P.button,{onClick:u,className:"p-2.5 rounded-full transition-all",style:{background:"linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%)",border:"1px solid rgba(255,255,255,0.12)",boxShadow:"0 4px 15px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.08)"},whileHover:{scale:1.05},whileTap:{scale:.92},children:d?e.jsx(Ks,{className:"w-4 h-4 text-white"}):e.jsx(ar,{className:"w-4 h-4 text-white"})})]}),e.jsxs("div",{className:`flex items-center justify-between gap-1.5 overflow-x-auto scrollbar-hide ${g?"mb-1":"mb-2"}`,children:[t!==void 0&&e.jsx(Wa,{icon:e.jsx(Mt,{className:`${g?"w-3 h-3":"w-3.5 h-3.5"} text-purple-400`}),label:"Score",value:t,maxValue:s,color:"#a855f7",animate:w,compact:g}),e.jsx(Re,{children:o&&i>1&&e.jsx(P.div,{initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},exit:{scale:0,opacity:0},children:e.jsx(Wa,{icon:e.jsx(bt,{className:`${g?"w-3 h-3":"w-3.5 h-3.5"} text-yellow-400`}),label:"Combo",value:`Ã—${i}`,color:"#fbbf24",animate:!0,compact:g})})}),f&&e.jsx(Wa,{icon:e.jsx("div",{className:`${g?"w-2 h-2":"w-2.5 h-2.5"} rounded-full`,style:{backgroundColor:f.color}}),label:f.label,value:f.value,color:f.color,compact:g}),m&&e.jsx(Wa,{icon:e.jsx("div",{className:`${g?"w-2 h-2":"w-2.5 h-2.5"} rounded-full`,style:{backgroundColor:m.color}}),label:m.label,value:m.value,color:m.color,compact:g}),a!==void 0&&e.jsx(P.div,{animate:j?{scale:[1,1.05,1]}:{},transition:{duration:.4,repeat:j?1/0:0},children:e.jsx(Wa,{icon:e.jsx(ti,{className:`${g?"w-3 h-3":"w-3.5 h-3.5"} ${j?"text-red-400":"text-white/60"}`}),label:"Time",value:`${a}s`,color:j?"#ef4444":"#94a3b8",compact:g})}),g&&u&&e.jsx(P.button,{onClick:u,className:"p-1.5 rounded-full transition-all flex-shrink-0",style:{background:"linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%)",border:"1px solid rgba(255,255,255,0.12)"},whileHover:{scale:1.05},whileTap:{scale:.92},children:d?e.jsx(Ks,{className:"w-3 h-3 text-white"}):e.jsx(ar,{className:"w-3 h-3 text-white"})})]}),r!==void 0&&a!==void 0&&e.jsx("div",{className:`${g?"h-1.5":"h-2.5"} rounded-full overflow-hidden`,style:{background:"linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.06))",border:"1px solid rgba(255,255,255,0.08)",boxShadow:"inset 0 2px 4px rgba(0,0,0,0.4)"},children:e.jsx(P.div,{className:"h-full rounded-full",style:{background:j?"linear-gradient(90deg, #ef4444, #f97316, #ef4444)":"linear-gradient(90deg, hsl(var(--primary)), hsl(var(--accent)), hsl(var(--primary)))",backgroundSize:"200% 100%",boxShadow:j?"0 0 20px rgba(239, 68, 68, 0.6), inset 0 1px 0 rgba(255,255,255,0.3)":"0 0 20px hsl(var(--primary) / 0.5), inset 0 1px 0 rgba(255,255,255,0.3)"},animate:{width:`${v}%`,backgroundPosition:["0% center","200% center"]},transition:{width:{duration:.3},backgroundPosition:{duration:2.5,repeat:1/0,ease:"linear"}}})}),!g&&l!==void 0&&c!==void 0&&c>1&&e.jsx("div",{className:"flex justify-center gap-1.5 mt-3",children:Array.from({length:c}).map((T,S)=>e.jsx(P.div,{className:`rounded-full transition-all duration-300 ${S<l?"bg-green-400 w-3 h-2":S===l?"bg-gradient-to-r from-primary to-accent w-5 h-2":"bg-white/10 w-2 h-2"}`,style:{boxShadow:S===l?"0 0 10px hsl(var(--primary))":"none"},animate:S===l?{opacity:[1,.7,1]}:{},transition:{duration:1,repeat:1/0}},S))}),e.jsx("style",{children:`
        .stat-pill {
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);
          border: 1px solid rgba(255, 255, 255, 0.1);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      `})]})});yw.displayName="GameHUD";const bw=n.memo(({count:t,onComplete:s})=>{const[a,r]=n.useState(t);return n.useEffect(()=>{if(a<=0){s();return}const i=setTimeout(()=>{r(o=>o-1)},1e3);return()=>clearTimeout(i)},[a,s]),e.jsx(Re,{children:a>0&&e.jsxs(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 z-50 flex items-center justify-center",style:{background:"radial-gradient(circle at center, rgba(0,0,0,0.92) 0%, rgba(5,5,15,0.97) 100%)",backdropFilter:"blur(12px) saturate(120%)"},children:[e.jsxs(P.div,{initial:{scale:2.5,opacity:0,rotate:-15},animate:{scale:1,opacity:1,rotate:0},exit:{scale:.5,opacity:0,rotate:15},transition:{type:"spring",stiffness:350,damping:22},className:"relative",children:[[0,1,2].map(i=>e.jsx(P.div,{className:"absolute inset-0 rounded-full",style:{border:"2px solid",borderColor:`hsl(var(--primary) / ${.6-i*.2})`},initial:{scale:1,opacity:.8},animate:{scale:2+i*.5,opacity:0},transition:{duration:1,delay:i*.15}},i)),e.jsxs("div",{className:"w-36 h-36 rounded-full flex items-center justify-center relative",style:{background:"linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--accent)) 100%)",boxShadow:"0 0 60px hsl(var(--primary) / 0.6), 0 0 120px hsl(var(--primary) / 0.3), inset 0 2px 0 rgba(255,255,255,0.25), inset 0 -2px 0 rgba(0,0,0,0.15)"},children:[e.jsx("div",{className:"absolute inset-2 rounded-full bg-gradient-to-br from-white/25 to-transparent"}),e.jsx("span",{className:"text-7xl font-black text-white relative z-10",style:{textShadow:"0 4px 20px rgba(0,0,0,0.4), 0 0 40px rgba(255,255,255,0.2)"},children:a})]})]},a),e.jsx(P.p,{className:"absolute bottom-[30%] text-lg font-semibold text-white/70 tracking-wide",initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{delay:.3},children:"Get Ready"})]})})});bw.displayName="CountdownOverlay";const ww=n.memo(({value:t,x:s,y:a,type:r})=>{const o={perfect:{color:"#fbbf24",bg:"rgba(251, 191, 36, 0.15)",emoji:"âœ¨"},good:{color:"#22c55e",bg:"rgba(34, 197, 94, 0.15)",emoji:"ðŸ‘"},miss:{color:"#ef4444",bg:"rgba(239, 68, 68, 0.15)",emoji:"âŒ"},combo:{color:"#a855f7",bg:"rgba(168, 85, 247, 0.15)",emoji:"ðŸ”¥"}}[r];return e.jsxs(P.div,{className:"absolute pointer-events-none flex items-center gap-1.5 px-3 py-1.5 rounded-full font-bold text-base",style:{left:s,top:a,color:o.color,backgroundColor:o.bg,border:`1px solid ${o.color}40`,boxShadow:`0 4px 20px ${o.color}40`},initial:{opacity:1,y:0,scale:1},animate:{opacity:0,y:-50,scale:1.2},exit:{opacity:0},transition:{duration:.7,ease:"easeOut"},children:[e.jsx("span",{children:o.emoji}),e.jsx("span",{children:t>0?`+${t}`:t})]})});ww.displayName="ScorePopup";const vw=n.memo(({onResume:t})=>e.jsx(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 z-50 flex flex-col items-center justify-center",style:{background:"radial-gradient(circle at center, rgba(0,0,0,0.94) 0%, rgba(5,5,15,0.98) 100%)",backdropFilter:"blur(16px) saturate(120%)"},children:e.jsxs(P.div,{initial:{scale:.8,opacity:0,y:20},animate:{scale:1,opacity:1,y:0},transition:{type:"spring",stiffness:300,damping:25},className:"text-center",children:[e.jsx("div",{className:"w-24 h-24 rounded-full mx-auto mb-6 flex items-center justify-center",style:{background:"linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.03) 100%)",border:"1px solid rgba(255,255,255,0.15)",boxShadow:"0 12px 40px rgba(0,0,0,0.4), 0 0 60px hsl(var(--primary) / 0.1), inset 0 1px 0 rgba(255,255,255,0.1)"},children:e.jsx(ar,{className:"w-12 h-12 text-white/85"})}),e.jsx("h3",{className:"text-2xl font-bold text-white mb-1.5 tracking-tight",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"},children:"Paused"}),e.jsx("p",{className:"text-white/50 mb-8 text-sm font-medium",children:"Take your time"}),e.jsxs(P.button,{onClick:t,className:"px-8 py-3.5 rounded-full font-bold flex items-center gap-2.5 mx-auto text-white",style:{background:"linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--accent)) 100%)",boxShadow:"0 8px 30px hsl(var(--primary) / 0.5), 0 0 60px hsl(var(--primary) / 0.2), inset 0 1px 0 rgba(255,255,255,0.25)"},whileHover:{scale:1.03,y:-2},whileTap:{scale:.97},children:[e.jsx(Ks,{className:"w-5 h-5"}),"Resume"]})]})}));vw.displayName="PauseOverlay";const _w=n.memo(({type:t})=>{const a={perfect:{text:"PERFECT!",emoji:"ðŸŒŸ",color:"#fbbf24",gradient:"from-yellow-500/20 to-amber-500/10",border:"border-yellow-400/50",glow:"rgba(251, 191, 36, 0.4)"},good:{text:"GOOD!",emoji:"ðŸ‘",color:"#22c55e",gradient:"from-green-500/20 to-emerald-500/10",border:"border-green-400/50",glow:"rgba(34, 197, 94, 0.4)"},miss:{text:"MISS",emoji:"âŒ",color:"#ef4444",gradient:"from-red-500/20 to-orange-500/10",border:"border-red-400/50",glow:"rgba(239, 68, 68, 0.4)"}}[t];return e.jsx(P.div,{initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1},exit:{scale:1.2,opacity:0},transition:{type:"spring",stiffness:400,damping:25},className:`px-8 py-4 rounded-2xl bg-gradient-to-br ${a.gradient} border-2 ${a.border}`,style:{boxShadow:`0 0 40px ${a.glow}`},children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-3xl",children:a.emoji}),e.jsx("span",{className:"text-3xl font-black tracking-tight",style:{color:a.color,textShadow:`0 0 20px ${a.glow}`},children:a.text})]})})});_w.displayName="FeedbackOverlay";const np=n.createContext(null),jw=({children:t})=>{const[s,a]=n.useState(!1),[r,i]=n.useState(null),o=n.useCallback(d=>{i(d),a(!0)},[]),l=n.useCallback(()=>{a(!1),i(null)},[]),c=n.useMemo(()=>({isModalOpen:s,selectedRecap:r,openRecap:o,closeRecap:l}),[s,r,o,l]);return e.jsx(np.Provider,{value:c,children:t})},Nw=()=>{const t=n.useContext(np);if(!t)throw new Error("useWeeklyRecapContext must be used within a WeeklyRecapProvider");return t},ip=()=>{const{user:t}=_e(),s=Ie(),{awardCustomXP:a}=rs(),{isModalOpen:r,selectedRecap:i,openRecap:o,closeRecap:l}=Nw(),c=()=>{const w=new Date,x=w.getDay(),v=x===0?6:x-1,j=new Date(w);j.setDate(w.getDate()-v);const T=new Date(j);T.setDate(j.getDate()-7);const S=new Date(T);return S.setDate(T.getDate()+6),{start:ae(T,"yyyy-MM-dd"),end:ae(S,"yyyy-MM-dd")}},{start:d}=c(),u=new Date().getDay()===0,{data:p,isLoading:h}=Ee({queryKey:["weekly-recap",t?.id,d],queryFn:async()=>{if(!t?.id)return null;const{data:w,error:x}=await k.from("weekly_recaps").select("*").eq("user_id",t.id).eq("week_start_date",d).maybeSingle();if(x)throw x;return w},enabled:!!t?.id}),{data:f}=Ee({queryKey:["weekly-recaps-all",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:w,error:x}=await k.from("weekly_recaps").select("*").eq("user_id",t.id).order("week_start_date",{ascending:!1});if(x)throw x;return w},enabled:!!t?.id}),m=he({mutationFn:async()=>{if(!t?.id)throw new Error("Not authenticated");const{data:w,error:x}=await k.functions.invoke("generate-weekly-recap",{body:{userId:t.id}});if(x)throw x;return w},onSuccess:()=>{s.invalidateQueries({queryKey:["weekly-recap"]}),s.invalidateQueries({queryKey:["weekly-recaps-all"]})}}),g=he({mutationFn:async w=>{const{error:x}=await k.from("weekly_recaps").update({viewed_at:new Date().toISOString()}).eq("id",w);if(x)throw x},onSuccess:()=>{s.invalidateQueries({queryKey:["weekly-recap"]}),s.invalidateQueries({queryKey:["weekly-recaps-all"]})}});return n.useEffect(()=>{if(u&&p&&!p.viewed_at&&!h){const w=`recap-dismissed-${p.week_start_date}`;st.getItem(w)||o(p)}},[u,p,h,o]),n.useEffect(()=>{(async()=>{if(!u||p||h||!t?.id||m.isPending)return;const{count:x}=await k.from("daily_check_ins").select("id",{count:"exact",head:!0}).eq("user_id",t.id);x&&x>0&&m.mutate()})()},[u,p,h,t?.id,m.isPending]),{isSunday:u,currentRecap:p,pastRecaps:f||[],isLoading:h,isModalOpen:r,selectedRecap:i,openRecap:w=>{o(w),w.viewed_at||(a(5,"weekly_recap_viewed","Weekly Recap"),g.mutate(w.id))},closeRecap:()=>{if(i){const w=`recap-dismissed-${i.week_start_date}`;st.setItem(w,"true"),i.viewed_at||g.mutate(i.id)}l()},isGenerating:m.isPending,generateRecap:m.mutate}},jr={tough:{buttonText:t=>`${t}. Now.`,emptyState:t=>`No excuses. Start ${t}.`,encouragement:()=>"You're tougher than this. Prove it.",nudge:()=>"Stop waiting. Act."},direct:{buttonText:t=>t,emptyState:t=>`Time to ${t}.`,encouragement:()=>"Keep pushing forward.",nudge:()=>"Get it done."},empathetic:{buttonText:t=>`${t} when you're ready`,emptyState:t=>`Take your time with ${t}. I'm here.`,encouragement:()=>"You're doing great. Keep going.",nudge:()=>"Just checking in on you."},supportive:{buttonText:t=>`Let's ${t.toLowerCase()}`,emptyState:t=>`Ready to ${t}? I believe in you.`,encouragement:()=>"You've got this!",nudge:()=>"How are you feeling today?"},wise:{buttonText:t=>`${t} mindfully`,emptyState:t=>`Consider ${t} as your next step.`,encouragement:()=>"Every step forward is progress.",nudge:()=>"Reflect on your path."}},pr=()=>{const{profile:t}=ss(),s=ur(t),{data:a}=Ee({queryKey:["mentor-personality",s],queryFn:async()=>{if(!s)return null;const{data:l,error:c}=await k.from("mentors").select("name, slug, tone_description, style, avatar_url, primary_color").eq("id",s).maybeSingle();if(c)throw c;return l},enabled:!!s});if(!a)return null;const i=a.tone_description?.toLowerCase()??"";let o=jr.supportive;return i.includes("tough")||i.includes("hard")?o=jr.tough:i.includes("direct")?o=jr.direct:i.includes("empathetic")?o=jr.empathetic:(i.includes("wise")||i.includes("calm"))&&(o=jr.wise),{name:a.name,slug:a.slug||"",tone:a.tone_description??"",style:a.style||"",avatar_url:a.avatar_url||void 0,primary_color:a.primary_color||"#000",buttonText:o.buttonText,emptyState:o.emptyState,encouragement:o.encouragement,nudge:o.nudge}},kw=async(t,s,a)=>{try{if(Ze.isNativePlatform()){const i=await(await fetch(t)).blob(),o=await Sw(i),l=await mu.writeFile({path:s,data:o,directory:pu.Cache});await hu.share({title:a?.title||"Companion Card",text:a?.text||"Check out my companion!",url:l.uri,dialogTitle:a?.dialogTitle||"Share Companion Card"}),V.success("Image ready to share!")}else{const r=document.createElement("a");r.href=t,r.download=s,r.click(),V.success("Image downloaded!")}}catch(r){console.error("Error downloading image:",r),V.error("Failed to save image")}},Cw=async(t,s,a)=>{try{V.loading("Capturing card...");const r=await uu(t,{quality:1,pixelRatio:2,backgroundColor:"transparent"});if(V.dismiss(),Ze.isNativePlatform()){const i=r.split(",")[1],o=await mu.writeFile({path:s,data:i,directory:pu.Cache});await hu.share({title:a?.title||"Companion Card",text:a?.text||"Check out my companion!",url:o.uri,dialogTitle:a?.dialogTitle||"Share Companion Card"}),V.success("Card ready to share!")}else{const i=document.createElement("a");i.href=r,i.download=s,i.click(),V.success("Card downloaded!")}}catch(r){V.dismiss(),console.error("Error capturing card:",r),V.error("Failed to capture card")}},Sw=t=>new Promise((s,a)=>{const r=new FileReader;r.onloadend=()=>{const o=r.result.split(",")[1];s(o)},r.onerror=a,r.readAsDataURL(t)}),Ew=({trend:t})=>{const s={improving:{icon:Rs,label:"Rising Week",className:"text-emerald-300 bg-emerald-500/20 border-emerald-400/30"},declining:{icon:Er,label:"Reflective Week",className:"text-amber-300 bg-amber-500/20 border-amber-400/30"},stable:{icon:ug,label:"Steady Week",className:"text-sky-300 bg-sky-500/20 border-sky-400/30"}},{icon:a,label:r,className:i}=s[t]||s.stable;return e.jsxs(P.span,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:.3},className:`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium border backdrop-blur-sm ${i}`,children:[e.jsx(a,{className:"h-3 w-3"}),r]})},bn=({value:t,label:s,color:a})=>e.jsxs(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex flex-col items-center gap-0.5",children:[e.jsx("span",{className:`text-lg font-bold ${a}`,children:t}),e.jsx("span",{className:"text-[10px] text-muted-foreground/70 uppercase tracking-wider",children:s})]}),Tw=()=>{const{isModalOpen:t,selectedRecap:s,closeRecap:a}=ip(),r=pr(),i=n.useRef(null);if(!s)return null;const o=Jt(s.week_start_date),l=Jt(s.week_end_date),c=`${ae(o,"MMMM d")} â€“ ${ae(l,"d, yyyy")}`,u=(s.mentor_insight||s.mentor_story)?.split(/\n{2,}/).filter(f=>f.trim())||[],p=async()=>{if(i.current)try{const f=await uu(i.current,{quality:.95,backgroundColor:"#0a0a0f"});await kw(f,`cosmiq-recap-${s.week_start_date}.png`)}catch(f){console.error("Failed to share recap:",f)}},h=()=>{a()};return e.jsx(Re,{children:t&&e.jsxs(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center p-4 pb-20",onClick:h,children:[e.jsx(P.div,{className:"absolute inset-0 bg-black/90 backdrop-blur-md",initial:{opacity:0},animate:{opacity:1}}),e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx(P.div,{className:"absolute top-1/4 left-1/4 w-96 h-96 bg-amber-500/10 rounded-full blur-3xl",animate:{scale:[1,1.2,1],opacity:[.3,.5,.3]},transition:{duration:8,repeat:1/0,ease:"easeInOut"}}),e.jsx(P.div,{className:"absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl",animate:{scale:[1.2,1,1.2],opacity:[.3,.5,.3]},transition:{duration:8,repeat:1/0,ease:"easeInOut",delay:4}})]}),e.jsxs(P.div,{initial:{scale:.9,opacity:0,y:40},animate:{scale:1,opacity:1,y:0},exit:{scale:.9,opacity:0,y:40},transition:{type:"spring",damping:30,stiffness:300},onClick:f=>f.stopPropagation(),className:"relative w-full max-w-lg max-h-[75dvh] flex flex-col rounded-3xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-background/95 via-background/90 to-background/95 backdrop-blur-xl border border-white/10 rounded-3xl"}),e.jsx("div",{className:"absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-400/50 to-transparent"}),e.jsxs("div",{className:"relative flex items-center justify-between px-6 py-5",children:[e.jsxs(P.div,{className:"flex items-center gap-4",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.1},children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"h-12 w-12 rounded-2xl bg-gradient-to-br from-amber-400 via-orange-500 to-rose-500 flex items-center justify-center shadow-lg shadow-amber-500/20",children:e.jsx(Ir,{className:"h-6 w-6 text-white"})}),e.jsx(P.div,{className:"absolute -top-1 -right-1 h-4 w-4 rounded-full bg-gradient-to-br from-amber-300 to-amber-500 flex items-center justify-center",animate:{scale:[1,1.2,1]},transition:{duration:2,repeat:1/0},children:e.jsx(be,{className:"h-2.5 w-2.5 text-white"})})]}),e.jsxs("div",{children:[e.jsxs("h2",{className:"font-semibold text-lg text-foreground",children:[r?.name||"Your Mentor"," Reflects"]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(zt,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:c})]})]})]}),e.jsxs(P.div,{className:"flex items-center gap-1",initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{delay:.2},children:[e.jsx(z,{variant:"ghost",size:"icon",onClick:p,className:"rounded-xl hover:bg-white/5",children:e.jsx(fu,{className:"h-4 w-4"})}),e.jsx(z,{variant:"ghost",size:"icon",onClick:h,className:"rounded-xl hover:bg-white/5",children:e.jsx(kt,{className:"h-4 w-4"})})]})]}),e.jsx("div",{className:"relative flex-1 min-h-0 overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:e.jsxs("div",{ref:i,className:"px-4 pb-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-center pt-2",children:e.jsx(Ew,{trend:s.mood_data.trend})}),u.length>0?e.jsx("div",{className:"space-y-5",children:u.map((f,m)=>e.jsx(P.p,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4+m*.1,duration:.5},className:"text-[15px] leading-[1.65] text-foreground/90",children:f},m))}):e.jsxs(P.div,{className:"text-center py-12",initial:{opacity:0},animate:{opacity:1},children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-muted/30 mb-4",children:e.jsx(Ir,{className:"h-8 w-8 text-muted-foreground/50"})}),e.jsx("p",{className:"text-muted-foreground",children:"No story available for this week yet."})]}),e.jsxs(P.div,{className:"flex items-center justify-center gap-3 py-4",initial:{opacity:0,scaleX:0},animate:{opacity:1,scaleX:1},transition:{delay:.8},children:[e.jsx("div",{className:"h-px flex-1 bg-gradient-to-r from-transparent via-border to-transparent"}),e.jsx(be,{className:"h-3 w-3 text-amber-400/50"}),e.jsx("div",{className:"h-px flex-1 bg-gradient-to-r from-transparent via-border to-transparent"})]}),e.jsxs(P.div,{className:"flex items-center justify-around py-4 px-2 rounded-2xl bg-white/[0.02] border border-white/5",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.9},children:[e.jsx(bn,{value:s.stats.checkIns,label:"Check-ins",color:"text-sky-400"}),e.jsx("div",{className:"w-px h-8 bg-border/30"}),e.jsx(bn,{value:s.stats.reflections,label:"Reflections",color:"text-violet-400"}),e.jsx("div",{className:"w-px h-8 bg-border/30"}),e.jsx(bn,{value:s.stats.quests,label:"Quests",color:"text-emerald-400"}),e.jsx("div",{className:"w-px h-8 bg-border/30"}),e.jsx(bn,{value:s.stats.habits,label:"Habits",color:"text-amber-400"})]}),e.jsx(P.div,{className:"text-center pt-2 pb-4",initial:{opacity:0},animate:{opacity:1},transition:{delay:1},children:e.jsx("p",{className:"text-[10px] text-muted-foreground/40 tracking-widest uppercase",children:"Cosmiq Weekly Journal"})})]})}),e.jsx("div",{className:"relative px-6 py-5 pb-6 border-t border-white/5",children:e.jsx(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5},children:e.jsx(z,{onClick:h,className:"w-full h-12 rounded-xl bg-gradient-to-r from-amber-500 via-orange-500 to-rose-500 hover:from-amber-400 hover:via-orange-400 hover:to-rose-400 text-white font-medium shadow-lg shadow-orange-500/20 transition-all duration-300 hover:shadow-orange-500/30 hover:scale-[1.02]",children:"Continue Your Journey"})})})]})]})})},mc=1e4,Mw=({enabled:t=!0}={})=>{const s=Ie(),a=n.useRef(0),r=n.useCallback(async i=>{t&&(ue.debug(`${i} - refreshing critical data`),await s.refetchQueries({queryKey:["profile"]}),await Promise.all([s.invalidateQueries({queryKey:["mentor-page-data"]}),s.invalidateQueries({queryKey:["mentor-personality"]}),s.invalidateQueries({queryKey:["mentor"]}),s.invalidateQueries({queryKey:["selected-mentor"]})]),await Promise.all([s.invalidateQueries({queryKey:["habits"]}),s.invalidateQueries({queryKey:["habit-surfacing"]}),s.invalidateQueries({queryKey:["epics"]}),s.invalidateQueries({queryKey:["epic-progress"]})]))},[t,s]);n.useEffect(()=>{if(!t||!Ze.isNativePlatform())return;let i=!1,o=null;const l=async({isActive:d})=>{if(!d)return;const u=Date.now();if(u-a.current<mc){ue.debug("App resume refresh skipped (cooldown)");return}a.current=u;try{await r("App resumed")}catch(h){ue.warn("App resume refresh failed",{error:h instanceof Error?h.message:String(h)})}};return(async()=>{const d=await tr.addListener("appStateChange",l);if(i){await d.remove();return}o=d})(),()=>{i=!0,o&&o.remove()}},[t,r]),n.useEffect(()=>{if(!t||Ze.isNativePlatform())return;const i=async()=>{if(document.visibilityState!=="visible")return;const o=Date.now();if(!(o-a.current<mc)){a.current=o;try{await r("Tab became visible")}catch(c){ue.warn("Visibility refresh failed",{error:c instanceof Error?c.message:String(c)})}}};return document.addEventListener("visibilitychange",i),()=>document.removeEventListener("visibilitychange",i)},[t,r])},nl=120*1e3,il=1800*1e3,Dw="Network error. Please check your connection and try again.",Aw=`
  *,
  epics(title),
  contact:contacts!contact_id(id, name, avatar_url),
  subtasks(id, title, completed, sort_order),
  task_attachments(id, task_id, file_url, file_path, file_name, mime_type, file_size_bytes, is_image, sort_order, created_at)
`,Pw=`
  *,
  epics(title),
  contact:contacts!contact_id(id, name, avatar_url),
  subtasks(id, title, completed, sort_order)
`,ol=(t,s)=>["daily-tasks",t,s],ll=async(t,s)=>{const a=o=>k.from("daily_tasks").select(o).eq("user_id",t).eq("task_date",s).order("sort_order",{ascending:!0}).order("created_at",{ascending:!1});let{data:r,error:i}=await a(Aw);if(Iw(i)&&(console.warn("daily_tasks query could not embed task_attachments, retrying without attachments relation"),{data:r,error:i}=await a(Pw)),i)throw Rw(i)?(console.warn("Failed to fetch daily tasks (network):",{message:i.message}),new Error(Dw)):(console.error("Failed to fetch daily tasks:",i),i);return(r||[]).map(o=>({...o,epic_title:o.epics?.title||null,contact:o.contact,subtasks:(o.subtasks??[]).slice().sort((l,c)=>(l.sort_order??Number.MAX_SAFE_INTEGER)-(c.sort_order??Number.MAX_SAFE_INTEGER)),attachments:(o.task_attachments??[]).slice().sort((l,c)=>(l.sort_order??Number.MAX_SAFE_INTEGER)-(c.sort_order??Number.MAX_SAFE_INTEGER)).map(l=>({id:l.id,taskId:l.task_id,fileUrl:l.file_url,filePath:l.file_path,fileName:l.file_name,mimeType:l.mime_type,fileSizeBytes:l.file_size_bytes,isImage:l.is_image,sortOrder:l.sort_order??void 0,createdAt:l.created_at}))}))},op=(t,s={})=>{const{user:a}=_e(),{enabled:r=!0}=s,i=t?ae(t,"yyyy-MM-dd"):ae(new Date,"yyyy-MM-dd"),{data:o=[],isLoading:l,error:c}=Ee({queryKey:ol(a?.id,i),queryFn:async()=>{if(!a?.id)throw new Error("User not authenticated");return ll(a.id,i)},enabled:r&&!!a?.id,staleTime:nl,gcTime:il,placeholderData:p=>p,refetchOnWindowFocus:!1}),d=o.filter(p=>p.completed).length,u=o.length;return{tasks:o,isLoading:l,error:c,taskDate:i,completedCount:d,totalCount:u}};function Rw(t){const s=t?.message?.toLowerCase()??"";return s.includes("load failed")||s.includes("failed to fetch")||s.includes("network request failed")||s.includes("typeerror: failed to fetch")}function Iw(t){if(!t)return!1;const s=(t.code??"").toUpperCase(),a=`${t.message??""} ${t.details??""} ${t.hint??""}`.toLowerCase();return a.includes("task_attachments")&&(s.startsWith("PGRST")||a.includes("relationship")||a.includes("embed")||a.includes("could not find"))}const pc=gu("WidgetData",{web:()=>ke(()=>import("./WidgetDataWeb-8xljeQLN.js"),__vite__mapDeps([14,1,2,3])).then(t=>new t.WidgetDataWeb)}),qw="widget-sync-diagnostics",hc="widget-sync-last-error",Lw=(t,s,a={})=>{const{enabled:r=!0}=a,i=n.useRef(""),o=n.useRef(()=>{}),l=n.useRef(!1),c=Ze.isNativePlatform()&&Ze.getPlatform()==="ios",d=n.useCallback(async(u=!1)=>{if(!r||l.current||!c)return;const p=Fw();if(s!==p)return;const h=t.filter(w=>!w.habit_source_id),f=t.filter(w=>!!w.habit_source_id),m=h.filter(w=>!!w.completed).length,g=f.filter(w=>!!w.completed).length,y=h.slice(0,10).map(w=>({id:w.id,text:w.task_text,completed:w.completed??!1,xpReward:w.xp_reward,isMainQuest:w.is_main_quest??!1,category:w.category,section:Ow(w.scheduled_time),scheduledTime:w.scheduled_time})),b=JSON.stringify({date:s,tasks:y,questCount:h.length,questCompleted:m,ritualCount:f.length,ritualCompleted:g});if(!(!u&&b===i.current))try{await pc.updateWidgetData({tasks:y,completedCount:m,totalCount:h.length,ritualCount:f.length,ritualCompleted:g,date:s}),i.current=b,Qi(null),console.info("[WidgetSync] Synced widget payload",{taskDate:s,force:u,totalCount:h.length,completedCount:m,ritualCount:f.length,ritualCompleted:g,widgetTaskCount:y.length})}catch(w){if(fc(w)){l.current=!0,console.info("[WidgetSync] WidgetData plugin unavailable at runtime; disabling widget sync for this session.");return}const x=gc(w);Qi({code:x.code||null,message:x.message,timestamp:new Date().toISOString(),source:"updateWidgetData"}),console.error("[WidgetSync] Failed to sync widget payload",{taskDate:s,code:x.code,message:x.message})}},[r,c,s,t]);return n.useEffect(()=>{o.current=d},[d]),n.useEffect(()=>{r&&d()},[r,d]),n.useEffect(()=>{if(!r||!c)return;const u=setTimeout(()=>{o.current(!0)},500);return()=>clearTimeout(u)},[r,c]),n.useEffect(()=>{if(!r||!c)return;const u=tr.addListener("appStateChange",({isActive:p})=>{p&&o.current(!0)});return()=>{u.then(p=>p.remove())}},[r,c]),n.useEffect(()=>{if(!c)return;let u=!1;return(async()=>{try{const h=await pc.getWidgetSyncDiagnostics();if(u)return;$w(h),console.info("[WidgetSync] Diagnostics snapshot",h),(!h.appGroupAccessible||!h.hasPayload)&&console.warn("[WidgetSync] Diagnostics indicate missing shared payload state",h)}catch(h){if(fc(h)){l.current=!0,console.info("[WidgetSync] WidgetData plugin unavailable at runtime; disabling widget sync for this session.");return}const f=gc(h);Qi({code:f.code||null,message:f.message,timestamp:new Date().toISOString(),source:"getWidgetSyncDiagnostics"}),console.warn("[WidgetSync] Diagnostics check failed",{code:f.code,message:f.message})}})(),()=>{u=!0}},[c]),{syncToWidget:d}};function Ow(t){if(!t)return"unscheduled";const s=parseInt(t.split(":")[0],10);return s<12?"morning":s<17?"afternoon":"evening"}function Fw(t=new Date){const s=t.getFullYear(),a=String(t.getMonth()+1).padStart(2,"0"),r=String(t.getDate()).padStart(2,"0");return`${s}-${a}-${r}`}function fc(t){const s=typeof t=="object"&&t!==null&&"code"in t?String(t.code??""):"",a=typeof t=="string"?t:t instanceof Error?t.message:typeof t=="object"&&t!==null&&"message"in t?String(t.message??""):"";return s.toUpperCase()==="UNIMPLEMENTED"||a.toUpperCase().includes("UNIMPLEMENTED")}function gc(t){const s=typeof t=="object"&&t!==null&&"code"in t?String(t.code??""):"",a=typeof t=="string"?t:t instanceof Error?t.message:typeof t=="object"&&t!==null&&"message"in t?String(t.message??""):"Unknown error";return{code:s,message:a}}function $w(t){lp(qw,JSON.stringify({...t,timestamp:new Date().toISOString()}))}function Qi(t){if(!t){Bw(hc);return}lp(hc,JSON.stringify(t))}function lp(t,s){if(!(typeof window>"u"))try{window.sessionStorage.setItem(t,s)}catch{}}function Bw(t){if(!(typeof window>"u"))try{window.sessionStorage.removeItem(t)}catch{}}const Uw=(t={})=>{const{enabled:s=!0}=t,{user:a}=_e(),r=s&&!!a,{tasks:i,taskDate:o}=op(void 0,{enabled:r});Lw(i,o,{enabled:r})},Hw=()=>typeof window>"u"?!1:Ze.isNativePlatform()&&Ze.getPlatform()==="ios",zw=()=>typeof window>"u"?!1:window.matchMedia("(prefers-reduced-motion: reduce)").matches,Kw=()=>typeof navigator>"u"?!1:!!navigator.connection?.saveData,cl=()=>{const[t,s]=n.useState(zw),[a,r]=n.useState(()=>typeof document<"u"?document.visibilityState!=="visible":!1),[i,o]=n.useState(Kw),l=n.useMemo(()=>Hw(),[]);n.useRef(null),n.useEffect(()=>{if(typeof window>"u")return;const p=window.matchMedia("(prefers-reduced-motion: reduce)"),h=()=>s(p.matches);return p.addEventListener("change",h),()=>p.removeEventListener("change",h)},[]),n.useEffect(()=>{if(typeof document>"u")return;const p=()=>{r(document.visibilityState!=="visible")};return document.addEventListener("visibilitychange",p),()=>document.removeEventListener("visibilitychange",p)},[]),n.useEffect(()=>{if(typeof navigator>"u")return;const p=navigator.connection;if(!p||typeof p.addEventListener!="function")return;const h=()=>o(!!p.saveData);return h(),p.addEventListener("change",h),()=>p.removeEventListener("change",h)},[]);const c=n.useMemo(()=>({prefersReducedMotion:t,isLowPowerMode:i,isBackgrounded:a}),[a,i,t]),d=n.useMemo(()=>c.prefersReducedMotion||c.isBackgrounded?"reduced":c.isLowPowerMode||l?"balanced":"enhanced",[l,c.isBackgrounded,c.isLowPowerMode,c.prefersReducedMotion]),u=n.useMemo(()=>d==="reduced"?{allowParallax:!1,maxParticles:4,allowBackgroundAnimation:!1,enableTabTransitions:!1,hapticsMode:"none"}:d==="balanced"?{allowParallax:!l,maxParticles:l?8:16,allowBackgroundAnimation:!l,enableTabTransitions:!l,hapticsMode:"web"}:{allowParallax:!0,maxParticles:24,allowBackgroundAnimation:!0,enableTabTransitions:!0,hapticsMode:"web"},[l,d]);return n.useEffect(()=>{},[l,d,c.isBackgrounded,c.isLowPowerMode,c.prefersReducedMotion]),n.useMemo(()=>({profile:d,capabilities:u,signals:c}),[u,d,c])},Qw=[.25,.1,.25,1],tn=n.memo(({children:t,mode:s="animated"})=>{const{capabilities:a,profile:r,signals:i}=cl();if(s==="instant"||i.prefersReducedMotion||i.isBackgrounded||!a.enableTabTransitions)return e.jsx("div",{style:{width:"100%",height:"100%"},children:t});const l=r==="enhanced"?.18:.14;return e.jsx(P.div,{initial:!1,animate:{opacity:1,y:0},exit:{opacity:0,y:-6},transition:{duration:l,ease:Qw},style:{width:"100%",height:"100%"},children:t})});tn.displayName="PageTransition";const Ww=n.memo(({children:t,delay:s=0})=>{const a=useReducedMotion();return e.jsx(P.div,{initial:{opacity:a?1:0},animate:{opacity:1},transition:{duration:a?0:.24,delay:a?0:s},children:t})});Ww.displayName="FadeIn";const Gw=n.memo(({children:t,delay:s=0})=>{const a=useReducedMotion();return e.jsx(P.div,{initial:{opacity:a?1:0,scale:a?1:.97},animate:{opacity:1,scale:1},transition:{duration:a?0:.2,delay:a?0:s},children:t})});Gw.displayName="ScaleIn";const Yw=n.memo(({children:t,delay:s=0})=>{const a=useReducedMotion();return e.jsx(P.div,{initial:{opacity:a?1:0,y:a?0:16},animate:{opacity:1,y:0},transition:{duration:a?0:.24,delay:a?0:s,ease:"easeOut"},children:t})});Yw.displayName="SlideUp";const Vw=["What should I focus on today?","How can I stay motivated?","I need a mindset shift","Give me a pep talk","Help me overcome self-doubt","How do I build better habits?","I'm feeling stuck","What's my next step?","Help me start strong today","Keep me on track","I need encouragement","Give me the hard truth"],cp=n.memo(()=>{const t=ts(),s=pr(),[a,r]=n.useState([]),[i,o]=n.useState("");n.useEffect(()=>{const d=[...Vw].sort(()=>Math.random()-.5);r(d.slice(0,3))},[]);const l=d=>{t("/mentor-chat",{state:{initialMessage:d}})},c=d=>{d.preventDefault(),i.trim()&&t("/mentor-chat",{state:{initialMessage:i}})};return e.jsxs(Xe,{className:"p-6 space-y-5 rounded-2xl bg-card/25 backdrop-blur-2xl border-white/[0.08] relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/5 via-transparent to-accent/5"}),e.jsxs("div",{className:"relative z-10 space-y-5",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(zo,{className:"h-6 w-6 text-primary"}),e.jsx("div",{className:"absolute inset-0 bg-primary/20 blur-md rounded-full animate-pulse-slow"})]}),e.jsx("h3",{className:"text-lg font-bold text-foreground",children:s?.name?`Ask ${s.name}`:"Quick Chat"})]}),e.jsx("div",{className:"space-y-3",children:a.map((d,u)=>e.jsx("button",{onClick:()=>l(d),className:"group relative w-full text-center px-6 py-4 rounded-full bg-white/[0.03] backdrop-blur-xl hover:bg-white/[0.06] border border-white/[0.08] hover:border-primary/30 transition-all text-sm font-medium text-foreground hover:scale-[1.02] active:scale-[0.98]",children:e.jsx("span",{className:"relative",children:d})},u))}),e.jsxs("form",{onSubmit:c,className:"flex gap-2",children:[e.jsx(mt,{value:i,onChange:d=>o(d.target.value),placeholder:"Or type your own...",className:"flex-1 rounded-full border-2 focus:border-primary/50 transition-all"}),e.jsx(z,{type:"submit",size:"icon",disabled:!i.trim(),className:"rounded-full h-10 w-10 shadow-soft hover:shadow-glow transition-all hover:scale-110 disabled:opacity-50","aria-label":"Send question",children:e.jsx(xu,{className:"h-4 w-4"})})]})]})]})});cp.displayName="MentorQuickChat";class Xw extends n.Component{constructor(s){super(s),this.state={hasError:!1,error:null}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,a){console.error("Companion Error:",s,a)}render(){return this.state.hasError?this.props.fallback||e.jsx(Jw,{error:this.state.error}):this.props.children}}const Jw=({error:t})=>{const s=ts();return e.jsx(Xe,{className:"p-8 text-center bg-gradient-to-br from-destructive/5 to-destructive/10 border-destructive/30",role:"alert","aria-live":"assertive",children:e.jsxs("div",{className:"flex flex-col items-center gap-4 max-w-md mx-auto",children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-destructive/20 flex items-center justify-center","aria-hidden":"true",children:e.jsx(Ca,{className:"h-8 w-8 text-destructive"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl font-heading font-bold text-foreground",children:"Companion Unavailable"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Your companion is taking a quick nap. Let's try waking them up!"})]}),e.jsxs("div",{className:"flex gap-3 mt-4",children:[e.jsxs(z,{onClick:()=>window.location.reload(),className:"gap-2","aria-label":"Reload page to retry loading companion",children:[e.jsx(wa,{className:"h-4 w-4","aria-hidden":"true"}),"Retry"]}),e.jsxs(z,{variant:"outline",onClick:()=>s("/"),className:"gap-2","aria-label":"Return to home page",children:[e.jsx(mg,{className:"h-4 w-4","aria-hidden":"true"}),"Go Home"]})]}),t&&e.jsxs("details",{className:"mt-4 text-xs text-muted-foreground max-w-full",children:[e.jsx("summary",{className:"cursor-pointer hover:text-foreground focus:outline-none focus:ring-2 focus:ring-primary rounded",children:"More details"}),e.jsx("pre",{className:"mt-2 p-3 bg-background/50 rounded text-left overflow-auto max-h-32","aria-label":"Error details",children:t.message})]})]})})},dp=Xw,up=n.forwardRef(({className:t,...s},a)=>e.jsxs(yu,{ref:a,className:I("relative flex w-full touch-none select-none items-center",t),...s,children:[e.jsx(pg,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:e.jsx(hg,{className:"absolute h-full bg-primary"})}),e.jsx(fg,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]}));up.displayName=yu.displayName;function Wi(t,s){return s>=t.start&&s<t.end}function Zw(t,s,a){if(!Number.isFinite(s)||t.length===0)return-1;if(typeof a=="number"&&Number.isInteger(a)&&a>=0&&a<t.length){const o=t[a];if(Wi(o,s))return a;const l=a+1;if(l<t.length&&Wi(t[l],s))return l;const c=a-1;if(c>=0&&Wi(t[c],s))return c}let r=0,i=t.length-1;for(;r<=i;){const o=Math.floor((r+i)/2),l=t[o];if(s<l.start){i=o-1;continue}if(s>=l.end){r=o+1;continue}return o}return-1}const ev=8,tv=/[^\p{L}\p{N}]+/gu;function xc(t){return t.toLowerCase().replace(tv,"")}function sv(t,s){if(!s||t.length===0)return t;const a=s.match(/\S+/g);if(!a||a.length===0)return t;let r=0,i=!1;const o=t.map(l=>{const c=xc(l.word);if(!c)return l;let d=-1;const u=Math.min(a.length-1,r+ev);for(let h=r;h<=u;h+=1)if(xc(a[h])===c){d=h;break}if(d===-1)return l;r=d+1;const p=a[d];return p===l.word?l:(i=!0,{...l,word:p})});return i?o:t}const Ba=ue.scope("TodaysPepTalk"),Gi=3,av=1200,yc=600*1e3,rv=45*1e3,Dr=new Map;function nv(t){if(!t||typeof t!="object")return!1;const s=t;return typeof s.word=="string"&&typeof s.start=="number"&&Number.isFinite(s.start)&&typeof s.end=="number"&&Number.isFinite(s.end)}function Nr(t){return Array.isArray(t)?t.filter(nv).slice().sort((s,a)=>s.start-a.start||s.end-a.end):[]}function dl(t){return`pep_talk_transcript_sync_cooldown:${t}`}function iv(t){const s=st.getItem(dl(t));if(!s)return 0;const a=Number(s);return Number.isFinite(a)?a:0}function ov(t){st.removeItem(dl(t)),Dr.delete(t)}function lv(t,s){st.setItem(dl(t),String(s)),Dr.set(t,s)}function cv(t){if(!t||typeof t!="object")return"";const s=t.name;return typeof s=="string"?s:""}function dv(t){if(!t||typeof t!="object"||!("context"in t))return null;const s=t.context;return s instanceof Response?s.status:null}function uv(t){return t===null?!1:t===429||t>=500&&t<600}function bc(t){return av*2**Math.max(0,t-1)}function wc(t){return new Promise(s=>setTimeout(s,t))}const mp=n.memo(()=>{const{profile:t}=ss();pr();const s=ts(),{awardPepTalkListened:a}=rs(),[r,i]=n.useState(null),[o,l]=n.useState(!0),[c,d]=n.useState(!1),[u,p]=n.useState(!1),[h,f]=n.useState(0),[m,g]=n.useState(0),[y,b]=n.useState(!1),[w,x]=n.useState(-1),[v,j]=n.useState(!1),[T,S]=n.useState(!1),[N,D]=n.useState("idle"),[R,_]=n.useState(!1),[C,E]=n.useState(null),[O,M]=n.useState(!1),A=n.useRef(null),L=n.useRef(null),q=n.useRef(null),$=n.useRef(null),B=n.useRef(null),W=n.useRef(0),H=n.useMemo(()=>typeof window<"u"&&Ze.isNativePlatform()&&Ze.getPlatform()==="ios",[]);n.useEffect(()=>{M(!1)},[r?.audio_url]),n.useEffect(()=>{if(!r?.audio_url||O)return;const G=setTimeout(()=>{!O&&A.current&&(Ba.debug("Audio ready timeout reached, enabling play button"),M(!0))},5e3);return()=>clearTimeout(G)},[r?.audio_url,O]);const K=ur(t),X=n.useMemo(()=>Nr(r?.transcript),[r?.transcript]),Y=n.useMemo(()=>sv(X,r?.script),[X,r?.script]),ee=n.useCallback(async()=>{if(!K){l(!1);return}try{d(!1),_(!1);const G=new Date().toLocaleDateString("en-CA"),{data:ye,error:we}=await k.from("mentors").select("slug, name").eq("id",K).maybeSingle();if(we){console.error("Error fetching mentor:",we),d(!0),l(!1);return}if(!ye){l(!1);return}E(ye.slug);const{data:Te,error:qe}=await k.from("daily_pep_talks").select("*").eq("for_date",G).eq("mentor_slug",ye.slug).maybeSingle();let Se=Te;if(qe){console.error("Error fetching pep talk:",qe),d(!0),l(!1);return}if(!Se){console.log("No pep talk for today, fetching most recent...");const{data:Pe,error:$e}=await k.from("daily_pep_talks").select("*").eq("mentor_slug",ye.slug).order("for_date",{ascending:!1}).limit(1).maybeSingle();$e?console.error("Error fetching fallback pep talk:",$e):Pe&&(Se=Pe,_(!0),console.log("Using fallback pep talk from:",Pe.for_date))}if(Se){const Pe=Nr(Se.transcript);i({...Se,mentor_name:ye.name,transcript:Pe})}}catch(G){console.error("Unexpected error fetching pep talk:",G),d(!0)}finally{l(!1)}},[K]);n.useEffect(()=>{ee()},[ee]);const ie=async()=>{if(!C){V.error("No mentor selected");return}S(!0),D("script");try{const{data:G,error:ye}=await k.functions.invoke("generate-single-daily-pep-talk",{body:{mentorSlug:C}});if(D("audio"),ye){console.error("Generation error:",ye);const we=await Ur(ye),Te=Hr(we,{action:"refresh today's pep talk"});throw Ba.warn("Pep talk generation returned HTTP error",{status:we.status,backendMessage:we.backendMessage,category:we.category,code:we.code}),new Error(Te)}if(G?.pepTalk){D("loading");const{data:we}=await k.from("mentors").select("name").eq("slug",C).maybeSingle(),Te=Nr(G.pepTalk.transcript);i({...G.pepTalk,mentor_name:we?.name,transcript:Te}),d(!1),_(!1),V.success("Your pep talk is ready!")}else throw new Error("No pep talk data returned")}catch(G){console.error("Error generating pep talk:",G);let ye=G instanceof Error?G.message:"Failed to prepare pep talk";if(typeof G=="object"&&G!==null&&"context"in G||/edge function|functions(fetch|http|relay)error|non-2xx|failed to send a request/i.test(ye)){const Te=await Ur(G);ye=Hr(Te,{action:"refresh today's pep talk"})}V.error(ye)}finally{S(!1),D("idle")}};n.useEffect(()=>{const G=r?.id,ye=r?.audio_url;if(!G||!ye||Nr(r?.transcript).length>0)return;const Te=Date.now(),qe=Dr.get(G)??0,Se=iv(G),Pe=Math.max(qe,Se);if(Pe>Te){Dr.set(G,Pe),Ba.debug("Skipping transcript sync during cooldown window",{pepTalkId:G,remainingMs:Pe-Te});return}Dr.set(G,Te+rv);let $e=!1;return(async()=>{for(let Qe=1;Qe<=Gi;Qe+=1)try{const{data:De,error:ve}=await k.functions.invoke("sync-daily-pep-talk-transcript",{body:{id:G}});if($e)return;if(ve){const J=dv(ve),de=uv(J),oe=cv(ve),Fe=ve instanceof Error?ve.message:String(ve);if(Ba.info("Transcript sync returned non-blocking error",{pepTalkId:G,attempt:Qe,status:J,retryable:de,errorName:oe,errorMessage:Fe}),de&&Qe<Gi){const Je=bc(Qe);if(await wc(Je),$e)return;continue}break}const Z=typeof De?.script=="string"?De.script:null,Q=Nr(De?.transcript);if(!Z&&Q.length===0)break;if(i(J=>{if(!J)return J;const de=Z??J.script,oe=Q.length>0?Q:J.transcript;return de!==J.script||JSON.stringify(oe)!==JSON.stringify(J.transcript)?{...J,script:de,transcript:oe}:J}),Q.length>0){ov(G);return}break}catch(De){if($e)return;const ve=De instanceof Error?De.message:String(De);if(Ba.info("Transcript sync invocation failed (non-blocking)",{pepTalkId:G,attempt:Qe,message:ve}),Qe<Gi){const Z=bc(Qe);if(await wc(Z),$e)return;continue}}const Me=Date.now()+yc;lv(G,Me),Ba.info("Applied transcript sync cooldown after failed attempts",{pepTalkId:G,cooldownMs:yc})})(),()=>{$e=!0}},[r?.id,r?.audio_url,r?.transcript]),n.useEffect(()=>{(async()=>{if(!r?.id||!t?.id)return;const{data:ye}=await k.from("xp_events").select("id").eq("user_id",t.id).eq("event_type","pep_talk_listen").eq("event_metadata->>pep_talk_id",r.id).maybeSingle();j(!!ye)})()},[r?.id,t?.id]),n.useEffect(()=>{const G=A.current;if(!G)return;const ye=()=>{const qe=G.currentTime;f(qe);const Se=G.duration;!v&&Se>0&&qe>=Se*.8&&r?.id&&t?.id&&(j(!0),a({pep_talk_id:r.id}))},we=()=>g(G.duration),Te=()=>{p(!1),x(-1)};return G.addEventListener("timeupdate",ye),G.addEventListener("loadedmetadata",we),G.addEventListener("ended",Te),()=>{G.removeEventListener("timeupdate",ye),G.removeEventListener("loadedmetadata",we),G.removeEventListener("ended",Te)}},[v,a,r?.id,t?.id]),n.useEffect(()=>{x(G=>Zw(X,h,G))},[X,h]),n.useEffect(()=>()=>{B.current!==null&&window.cancelAnimationFrame(B.current),$.current&&clearTimeout($.current)},[]),n.useEffect(()=>{if(L.current&&q.current&&y){const G=q.current,ye=L.current,we=G.scrollTop,Te=we+G.clientHeight,qe=ye.offsetTop,Se=qe+ye.offsetHeight;if(qe<we||Se>Te){const $e=qe-G.clientHeight/2+ye.offsetHeight/2,Be=Math.max(0,G.scrollHeight-G.clientHeight),Me=Math.max(0,Math.min($e,Be));if(Math.abs(Me-we)<1||Math.abs(Me-W.current)<1)return;B.current!==null&&window.cancelAnimationFrame(B.current),B.current=window.requestAnimationFrame(()=>{G.scrollTo({top:Me,behavior:"smooth"}),W.current=Me,B.current=null})}}},[w,y]);const fe=async()=>{const G=A.current;if(!G){console.error("Audio element not found");return}if(u)G.pause(),p(!1);else try{console.log("Attempting to play audio from:",r?.audio_url),await G.play(),p(!0)}catch(ye){console.error("Audio play failed:",ye),G.load();try{await G.play(),p(!0)}catch(we){console.error("Audio play retry failed:",we)}}},U=n.useCallback(G=>{const ye=A.current;ye&&(f(G[0]),$.current&&clearTimeout($.current),$.current=window.setTimeout(()=>{ye&&(ye.currentTime=G[0])},100))},[]),ce=G=>{const ye=A.current;if(!ye)return;const we=Math.max(0,Math.min(ye.duration,ye.currentTime+G));ye.currentTime=we,f(we)},se=G=>{if(isNaN(G))return"0:00";const ye=Math.floor(G/60),we=Math.floor(G%60);return`${ye}:${we.toString().padStart(2,"0")}`},ne=()=>{if(!r?.script)return e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"No transcript available"});const ye=r.script.split(" ").slice(0,20);return e.jsxs("div",{className:"text-sm leading-relaxed text-foreground/70",children:[ye.join(" "),"..."]})},xe=()=>Y.length===0?r?.script?e.jsx("div",{ref:q,"data-testid":"pep-talk-transcript",className:"text-sm leading-relaxed max-h-64 overflow-y-auto scroll-smooth pr-2 text-foreground/80",children:r.script}):null:e.jsx("div",{ref:q,"data-testid":"pep-talk-transcript",className:"text-sm leading-relaxed max-h-64 overflow-y-auto scroll-smooth pr-2 text-foreground/80",children:Y.map((G,ye)=>e.jsxs("span",{ref:ye===w?L:null,className:I("transition-colors duration-200",ye===w?"text-primary font-semibold bg-primary/10 px-1 rounded":"text-foreground/80"),children:[G.word," "]},ye))});return o?e.jsx(Xe,{className:"p-6 animate-pulse",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"h-4 bg-muted rounded w-1/3"}),e.jsx("div",{className:"h-20 bg-muted rounded"})]})}):c||!r?e.jsxs(Xe,{className:"relative overflow-hidden rounded-3xl border-2 p-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/10 via-accent/5 to-primary/5"}),e.jsxs("div",{className:"relative space-y-4 text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(be,{className:"h-5 w-5 text-muted-foreground"}),e.jsx("h2",{className:"text-lg font-semibold text-muted-foreground",children:"Daily Message"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:c?"Unable to load today's pep talk":"No pep talk available today"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 justify-center",children:[e.jsx(z,{onClick:ie,disabled:T||!C,className:"rounded-full min-w-[200px]",children:T?e.jsxs(e.Fragment,{children:[e.jsx(Nt,{className:"h-4 w-4 mr-2 animate-spin"}),N==="script"&&"Preparing script...",N==="audio"&&"Creating audio...",N==="loading"&&"Loading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ia,{className:"h-4 w-4 mr-2"}),"Prepare Today's Pep Talk"]})}),e.jsx(z,{variant:"outline",size:"default",className:"rounded-full",onClick:()=>s("/pep-talks"),children:"Browse Library"})]})]})]}):e.jsxs(Xe,{className:I("relative overflow-hidden group rounded-3xl border-2",!H&&"animate-fade-in",H&&"gpu-layer"),children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/25 via-accent/15 to-primary/10 animate-gradient-shift"}),u&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute top-1/4 left-1/4 w-1 h-1 bg-primary rounded-full animate-sparkle"}),e.jsx("div",{className:"absolute top-1/3 right-1/4 w-1.5 h-1.5 bg-accent rounded-full animate-sparkle",style:{animationDelay:"0.3s"}}),e.jsx("div",{className:"absolute bottom-1/3 left-1/3 w-1 h-1 bg-primary rounded-full animate-sparkle",style:{animationDelay:"0.6s"}}),e.jsx("div",{className:"absolute top-1/2 right-1/3 w-1.5 h-1.5 bg-accent rounded-full animate-sparkle",style:{animationDelay:"0.9s"}})]}),e.jsx("div",{className:"absolute -top-20 -right-20 w-40 h-40 bg-primary/20 blur-3xl rounded-full animate-pulse-slow"}),e.jsx("div",{className:"absolute -bottom-20 -left-20 w-40 h-40 bg-accent/20 blur-3xl rounded-full animate-pulse-slow",style:{animationDelay:"1.5s"}}),e.jsxs("div",{className:"relative p-6 md:p-8 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(be,{className:"h-6 w-6 text-primary animate-pulse-slow"}),e.jsx("div",{className:"absolute inset-0 bg-primary/30 blur-md rounded-full"})]}),e.jsx("h2",{className:"text-xl font-bold bg-gradient-to-r from-primary via-accent to-primary bg-clip-text text-transparent animate-gradient-text",children:"Daily Message"})]}),e.jsxs("div",{className:"space-y-6 p-6 rounded-2xl bg-gradient-to-br from-card/90 to-card/70 backdrop-blur-sm border-2 border-primary/30 shadow-glow",children:[R&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-xs text-muted-foreground bg-muted/50 rounded-full px-3 py-1 mx-auto w-fit",children:[e.jsxs("span",{children:["From ",new Date(r.for_date+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})]}),e.jsx(z,{variant:"ghost",size:"sm",className:"h-auto py-0 px-2 text-xs text-primary hover:text-primary/80",onClick:ie,disabled:T,children:T?e.jsxs(e.Fragment,{children:[e.jsx(Nt,{className:"h-3 w-3 mr-1 animate-spin"}),N==="script"&&"Writing...",N==="audio"&&"Recording...",N==="loading"&&"Loading..."]}):"Refresh today's"})]}),e.jsxs("div",{className:"space-y-3 text-center",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-bold text-foreground",children:r.title}),e.jsx("p",{className:"text-sm text-muted-foreground leading-relaxed",children:r.summary})]}),e.jsx("audio",{ref:A,src:r.audio_url,preload:"auto",onCanPlay:()=>M(!0),onError:()=>{ue.error("Audio loading error",{audioUrl:r.audio_url,errorCode:A.current?.error?.code,errorMessage:A.current?.error?.message})},onLoadedMetadata:()=>{ue.log("Audio loaded successfully"),ue.log("Duration:",A.current?.duration),A.current?.duration&&A.current.duration>0&&M(!0)}}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(z,{size:"icon",onClick:fe,disabled:!O,className:I("h-20 w-20 rounded-full transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed",u?"bg-gradient-to-br from-accent to-primary shadow-glow-lg scale-110":"bg-gradient-to-br from-primary to-accent shadow-glow hover:scale-110"),"aria-label":O?u?"Pause pep talk":"Play pep talk":"Loading audio",children:O?u?e.jsx(ar,{className:"h-8 w-8",fill:"currentColor"}):e.jsx(Ks,{className:"h-8 w-8 ml-1",fill:"currentColor"}):e.jsx(Nt,{className:"h-8 w-8 animate-spin"})})}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(z,{variant:"ghost",size:"icon",onClick:()=>ce(-10),disabled:!1,className:"h-10 w-10 rounded-full hover:bg-primary/20 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:scale-105","aria-label":"Skip back 10 seconds",children:e.jsx(gg,{className:"h-4 w-4"})}),e.jsxs("div",{className:"text-xs text-muted-foreground font-medium",children:[se(h)," / ",se(m)]}),e.jsx(z,{variant:"ghost",size:"icon",onClick:()=>ce(10),disabled:!1,className:"h-10 w-10 rounded-full hover:bg-primary/20 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:scale-105","aria-label":"Skip forward 10 seconds",children:e.jsx(Rr,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"space-y-2 px-2",children:e.jsx(up,{value:[h],max:m>0?m:1,step:.1,onValueChange:U,disabled:m===0,className:"w-full"})}),e.jsxs("div",{className:"space-y-2 p-4 rounded-2xl bg-background/60 backdrop-blur-sm border border-primary/20 shadow-soft",children:[y?xe():ne(),r?.script&&e.jsxs(z,{variant:"ghost",size:"sm",onClick:()=>b(G=>!G),className:"w-full justify-between mt-2 rounded-full hover:bg-primary/10 transition-all",children:[e.jsx("span",{className:"text-xs font-medium",children:y?"Show Less":"Show Full Transcript"}),y?e.jsx(Wo,{className:"h-4 w-4"}):e.jsx(Ws,{className:"h-4 w-4"})]})]})]}),e.jsx(z,{variant:"outline",size:"lg",className:"w-full rounded-full border-2 hover:bg-primary/10 hover:scale-105 transition-all shadow-soft",onClick:()=>s("/pep-talks"),children:"Browse More Pep Talks"})]})]})]})});mp.displayName="TodaysPepTalk";const Zt=n.forwardRef(({className:t,...s},a)=>e.jsx("textarea",{className:I("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),ref:a,...s}));Zt.displayName="Textarea";const mv=({onSelect:t,selected:s})=>{const a=[{id:"unmotivated",label:"Unmotivated",icon:xg,color:"text-red-500",borderColor:"border-red-500/50",bgColor:"bg-red-500/10"},{id:"overthinking",label:"Overthinking",icon:Ds,color:"text-purple-500",borderColor:"border-purple-500/50",bgColor:"bg-purple-500/10"},{id:"stressed",label:"Stressed",icon:bt,color:"text-orange-500",borderColor:"border-orange-500/50",bgColor:"bg-orange-500/10"},{id:"low_energy",label:"Low Energy",icon:yg,color:"text-gray-400",borderColor:"border-gray-400/50",bgColor:"bg-gray-400/10"},{id:"content",label:"Content",icon:bg,color:"text-blue-400",borderColor:"border-blue-400/50",bgColor:"bg-blue-400/10"},{id:"disciplined",label:"Disciplined",icon:It,color:"text-green-500",borderColor:"border-green-500/50",bgColor:"bg-green-500/10"},{id:"focused",label:"Focused",icon:wg,color:"text-teal-500",borderColor:"border-teal-500/50",bgColor:"bg-teal-500/10"},{id:"inspired",label:"Inspired",icon:be,color:"text-yellow-500",borderColor:"border-yellow-500/50",bgColor:"bg-yellow-500/10"}];return e.jsx("div",{className:"grid grid-cols-4 gap-2.5",children:a.map(r=>{const i=r.icon,o=s===r.id;return e.jsxs("button",{type:"button",onClick:()=>{t(r.id),window.dispatchEvent(new CustomEvent("mood-selected"))},className:I("flex flex-col items-center justify-center gap-1.5 p-3 rounded-xl border-2 transition-all duration-200 active:scale-95",o?`${r.bgColor} ${r.borderColor} shadow-md`:"bg-card/50 border-border/50 hover:border-primary/40 hover:bg-card/80"),children:[e.jsx("div",{className:I("w-9 h-9 rounded-full flex items-center justify-center transition-all duration-200",r.bgColor),children:e.jsx(i,{className:I("h-5 w-5",r.color)})}),e.jsx("span",{className:I("text-[10px] font-medium leading-none text-center",o?"text-foreground":"text-muted-foreground"),children:r.label})]},r.id)})})},Yi=new Map,ul=async t=>{if(Yi.has(t))return Yi.get(t);try{let s;switch(t.toLowerCase()){case"atlas":s=await ke(()=>import("./atlas-sage-CL7hL_Ez.js"),[]);break;case"eli":s=await ke(()=>import("./darius-sage-2XcD16mi.js"),[]);break;case"sienna":s=await ke(()=>import("./sienna-sage-CppN60cS.js"),[]);break;case"stryker":s=await ke(()=>import("./stryker-sage-B3PlAZKv.js"),[]);break;case"carmen":s=await ke(()=>import("./carmen-sage-CZySZiFo.js"),[]);break;case"reign":s=await ke(()=>import("./reign-sage-D4nrVOuM.js"),[]);break;case"solace":s=await ke(()=>import("./solace-sage-CJdBfLhM.js"),[]);break;default:s=await ke(()=>import("./atlas-sage-CL7hL_Ez.js"),[])}const a=s.default;return Yi.set(t,a),a}catch(s){return console.error(`Failed to load mentor image for ${t}:`,s),""}},pv=()=>{const{user:t}=_e(),{toast:s}=_s(),a=pr(),r=Ie(),{awardCheckInComplete:i,XP_REWARDS:o}=rs(),{checkFirstTimeAchievements:l}=ci(),{triggerReaction:c}=en(),[d,u]=n.useState(""),[p,h]=n.useState(""),[f,m]=n.useState(!1),[g,y]=n.useState(""),b=n.useRef(null),w=new Date().toLocaleDateString("en-CA"),x=3e4;n.useEffect(()=>{if(!a){y("");return}const T=a.avatar_url?.trim();if(T){y(T);return}const S=(a.slug||"").trim().toLowerCase();if(!S){y("");return}let N=!1;return ul(S).then(D=>{N||y(D||"")}).catch(()=>{N||y("")}),()=>{N=!0}},[a?.avatar_url,a?.slug,a?.name]);const{data:v}=Ee({queryKey:["morning-check-in",w,t?.id],queryFn:async()=>{if(!t)return null;const{data:T}=await k.from("daily_check_ins").select("*").eq("user_id",t.id).eq("check_in_type","morning").eq("check_in_date",w).maybeSingle();return T},enabled:!!t,refetchInterval:T=>{const S=T.state.data;if(S?.completed_at&&!S?.mentor_response){const N=b.current;return N&&Date.now()-N>x?(ue.warn("Mentor response polling timeout exceeded"),!1):2e3}return!1}}),j=async()=>{if(!t||!d||!p.trim()){s({title:"Please complete all fields",variant:"destructive"});return}if(v||f){s({title:"Already checked in",description:"You've already completed your check-in today",variant:"destructive"});return}m(!0);try{const{data:T}=await k.from("daily_check_ins").select("id").eq("user_id",t.id).eq("check_in_type","morning").eq("check_in_date",w).maybeSingle();if(T){s({title:"Already checked in",description:"You've already completed your check-in today",variant:"destructive"}),m(!1),r.invalidateQueries({queryKey:["morning-check-in"]});return}const{data:S,error:N}=await k.from("daily_check_ins").insert({user_id:t.id,check_in_type:"morning",check_in_date:w,mood:d,intention:p.trim(),completed_at:new Date().toISOString()}).select().maybeSingle();if(N)throw ue.error("Check-in error:",N),N;i(),c("mentor",{momentType:"discipline_win"}).catch(R=>ue.log("[LivingCompanion] Mentor reaction failed:",R));const{count:D}=await k.from("daily_check_ins").select("*",{count:"exact",head:!0}).eq("user_id",t.id);D===1&&await l("checkin"),window.dispatchEvent(new CustomEvent("quest-completed")),window.dispatchEvent(new CustomEvent("morning-checkin-completed")),b.current=Date.now();try{const{error:R}=await k.functions.invoke("generate-check-in-response",{body:{checkInId:S.id}});R&&ue.error("Edge function invocation error:",R)}catch(R){ue.error("Edge function invocation failed:",R)}r.invalidateQueries({queryKey:["morning-check-in"]})}catch(T){ue.error("Check-in save error:",T),s({title:"Error",description:T instanceof Error?T.message:"Failed to save check-in",variant:"destructive"})}finally{m(!1)}};return v?.completed_at?e.jsx(Xe,{"data-tour":"morning-checkin",className:"p-5 sm:p-6 bg-card/25 backdrop-blur-2xl border-celestial-blue/20",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-xl bg-stardust-gold/20 flex items-center justify-center flex-shrink-0 ring-1 ring-stardust-gold/30",children:e.jsx(Tl,{className:"h-5 w-5 text-stardust-gold"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h3",{className:"font-bold text-lg",children:"Check-in Complete"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Focus: ",v.intention]})]})]}),a&&e.jsxs("div",{className:"relative overflow-hidden bg-white/[0.03] backdrop-blur-xl rounded-2xl p-4 sm:p-5 border border-white/[0.08]",children:[e.jsx("span",{"aria-hidden":"true",className:"absolute -left-1 -top-7 text-7xl leading-none font-serif text-white/[0.08] select-none",children:'"'}),e.jsxs("div",{className:"relative space-y-3",children:[e.jsxs("div",{className:"inline-flex items-center gap-2 rounded-full bg-black/30 px-3 py-1 border border-white/10",children:[e.jsx("p",{className:"text-xs sm:text-sm font-semibold text-foreground",children:a.name}),e.jsx(be,{className:"h-3.5 w-3.5 text-stardust-gold"})]}),e.jsxs("div",{"data-testid":"mentor-response-body",className:"flow-root",children:[g&&e.jsx("img",{"data-testid":"mentor-portrait-tile",src:g,alt:`${a.name} portrait`,className:"float-right ml-3 mb-2 h-16 w-12 sm:h-20 sm:w-14 rounded-xl object-cover border border-white/10 shadow-[0_10px_24px_rgba(0,0,0,0.28)]",style:{objectPosition:"center 25%"},loading:"lazy",decoding:"async"}),v.mentor_response?e.jsxs("p",{className:"text-base italic text-foreground/90 leading-relaxed",children:['"',v.mentor_response,'"']}):b.current&&Date.now()-b.current>x?e.jsx("p",{className:"text-base text-foreground/80 italic leading-relaxed",children:'"Great work on setting your intention today. Stay focused and crush it."'}):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"Preparing your personalized message..."})]})]})]})]})}):e.jsxs("div",{"data-tour":"morning-checkin",className:"rounded-2xl bg-card/25 backdrop-blur-2xl border border-white/[0.08] overflow-hidden animate-scale-in shadow-[0_8px_32px_rgba(0,0,0,0.12)]",children:[e.jsx("div",{className:"px-5 py-4 border-b border-white/[0.06] bg-gradient-to-r from-orange-500/5 to-amber-500/[0.02]",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-11 w-11 rounded-xl bg-gradient-to-br from-orange-500/20 to-amber-500/20 flex items-center justify-center border border-orange-500/30",children:e.jsx(Tl,{className:"h-5 w-5 text-orange-500"})}),e.jsx("h3",{className:"font-heading font-black text-2xl tracking-wide text-orange-500",children:"CHECK-IN"})]})}),e.jsxs("div",{className:"p-5 space-y-5",children:[e.jsxs("div",{"data-tour":"checkin-mood",className:"space-y-3",children:[e.jsx("label",{className:"text-sm font-bold text-foreground",children:"How are you feeling?"}),e.jsx(mv,{selected:d,onSelect:u})]}),e.jsx("div",{className:"h-px bg-border/30"}),e.jsxs("div",{"data-tour":"checkin-intention",className:"space-y-3",children:[e.jsxs("label",{className:"text-sm font-bold flex items-center gap-2 text-foreground",children:[e.jsx(It,{className:"h-4 w-4 text-primary"}),"What's your main focus today?"]}),e.jsx(Zt,{placeholder:"I will...",value:p,onChange:T=>h(T.target.value),rows:3,className:"resize-none transition-all duration-200 focus:shadow-glow bg-muted/30 border-border/50"})]}),e.jsx(z,{onClick:j,"data-tour":"checkin-submit",disabled:f||!d||!p.trim()||!!v,variant:"cta",className:"w-full h-13 text-base",size:"lg",children:f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-background border-t-transparent"}),"Setting Intention..."]}):e.jsxs(e.Fragment,{children:["Check in",e.jsxs("span",{className:"ml-1 px-2 py-0.5 rounded-full bg-white/20 text-xs",children:["+",o.CHECK_IN," XP"]})]})})]})]})},pp=n.memo(()=>e.jsx(ls,{fallback:e.jsx(n0,{}),children:e.jsx(pv,{})}));pp.displayName="MorningCheckIn";const hv={atlas:"center 20%",eli:"center 15%",sienna:"center 30%",stryker:"center 25%",carmen:"center 20%",reign:"center 20%",solace:"center 25%"},fv={sm:"w-16 h-16",md:"w-24 h-24 md:w-32 md:h-32",lg:"w-32 h-32 md:w-40 md:h-40",xl:"w-48 h-48 md:w-56 md:h-56"},Ar=n.memo(({mentorSlug:t,mentorName:s,primaryColor:a,avatarUrl:r,size:i="md",className:o="",showBorder:l=!0,showGlow:c=!1,style:d})=>{const[u,p]=n.useState(r||"");n.useEffect(()=>{if(r){p(r);return}const b=(t||"").trim().toLowerCase();b&&ul(b).then(p).catch(()=>{})},[t,r]);const h=(t||"").trim().toLowerCase(),f=(s||"").trim().toLowerCase().replace(/\s+/g,"-"),g=hv[h||f]||"center 25%",y=b=>b.split(" ").map(w=>w[0]).join("").toUpperCase();return e.jsx("div",{className:`relative ${fv[i]} rounded-full overflow-hidden ${o}`,style:{...d,border:l?`4px solid ${a}`:void 0,boxShadow:d?.boxShadow||(c?`0 0 40px ${a}60`:l?`0 0 20px ${a}40`:void 0)},children:u?e.jsx("img",{src:u,alt:s,className:"w-full h-full object-cover",style:{objectPosition:g},loading:"lazy",decoding:"async"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-pure-white text-4xl font-black",style:{backgroundColor:a},children:y(s)})})}),gv=()=>{const{user:t}=_e(),{profile:s}=ss(),a=Ie(),r=n.useMemo(()=>{const h=s?.timezone||"UTC";try{return new Intl.DateTimeFormat("en-CA",{timeZone:h,year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date)}catch{return new Date().toLocaleDateString("en-CA")}},[s?.timezone]),{data:i,isLoading:o,error:l,refetch:c}=Ee({queryKey:["morning-briefing",r,t?.id],queryFn:async()=>{if(!t)return null;const{data:h}=await k.from("morning_briefings").select("*").eq("user_id",t.id).eq("briefing_date",r).maybeSingle();return h},enabled:!!t,staleTime:1e3*60*5}),d=he({mutationFn:async()=>{const{data:h}=await k.from("morning_briefings").select("id").eq("user_id",t?.id).eq("briefing_date",r).maybeSingle();if(h)return await c(),null;const{data:f,error:m}=await k.functions.invoke("generate-morning-briefing");if(m)throw m;if(f.error)throw new Error(f.error);return f.briefing},onSuccess:()=>{a.invalidateQueries({queryKey:["morning-briefing"]})}}),u=he({mutationFn:async h=>{const{error:f}=await k.from("morning_briefings").update({viewed_at:new Date().toISOString()}).eq("id",h);if(f)throw f},onSuccess:()=>{a.invalidateQueries({queryKey:["morning-briefing"]})}}),p=he({mutationFn:async h=>{const{error:f}=await k.from("morning_briefings").update({dismissed_at:new Date().toISOString()}).eq("id",h);if(f)throw f},onSuccess:()=>{a.invalidateQueries({queryKey:["morning-briefing"]})}});return{briefing:i,isLoading:o,error:l,refetch:c,generateBriefing:d,markViewed:u,dismissBriefing:p,isGenerating:d.isPending}},hp=n.memo(({onAskMore:t,className:s})=>{const a=ts(),{toast:r}=_s(),i=pr(),{briefing:o,isLoading:l,generateBriefing:c,dismissBriefing:d,markViewed:u,isGenerating:p}=gv(),[h,f]=n.useState(!1),[m,g]=n.useState(!1);n.useEffect(()=>{o&&!o.viewed_at&&u.mutate(o.id)},[o?.id]),n.useEffect(()=>{o?.dismissed_at&&g(!0)},[o?.dismissed_at]);const y=async()=>{try{await c.mutateAsync()}catch(v){console.error("Failed to generate briefing:",v),r({title:"Couldn't prepare briefing",description:v instanceof Error?v.message:"Please try again later",variant:"destructive"})}},b=async()=>{if(o){g(!0);try{await d.mutateAsync(o.id)}catch(v){console.error("Failed to dismiss briefing:",v)}}},w=()=>{if(o){if(t){t(o.content,o.action_prompt||"");return}a("/mentor-chat",{state:{initialMessage:o.action_prompt||"Let's discuss my morning briefing",briefingContext:o.content,comprehensiveMode:!0}})}};if(m&&o)return e.jsx(Xe,{className:I("p-4 bg-card/25 backdrop-blur-2xl border-white/[0.08] cursor-pointer hover:border-primary/20 transition-colors",s),onClick:()=>g(!1),children:e.jsxs("div",{className:"flex items-center gap-3",children:[i&&e.jsx(Ar,{mentorSlug:(i.slug||"").toLowerCase(),mentorName:i.name,primaryColor:i.primary_color||"#000",avatarUrl:i.avatar_url||void 0,size:"sm",showBorder:!0}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Morning Briefing"}),e.jsx(Rt,{className:"h-4 w-4 text-primary"})]}),o.todays_focus&&e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:["Focus: ",o.todays_focus]})]}),e.jsx(Ws,{className:"h-5 w-5 text-muted-foreground flex-shrink-0"})]})});if(l)return e.jsx(Xe,{className:I("p-6 animate-pulse bg-card/25 backdrop-blur-2xl border-white/[0.08]",s),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-full bg-muted"}),e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx("div",{className:"h-4 bg-muted rounded w-1/3"}),e.jsx("div",{className:"h-3 bg-muted rounded w-2/3"})]})]})});if(!o)return e.jsxs("div",{className:I("rounded-2xl bg-card/25 backdrop-blur-2xl border border-white/[0.08] overflow-hidden shadow-[0_8px_32px_rgba(0,0,0,0.12)]",s),children:[e.jsx("div",{className:"px-4 py-3 sm:px-5 sm:py-4 border-b border-white/[0.06] bg-gradient-to-r from-primary/5 to-accent/[0.02]",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-9 w-9 sm:h-11 sm:w-11 rounded-xl bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center border border-primary/30",children:e.jsx(Ds,{className:"h-4 w-4 sm:h-5 sm:w-5 text-primary"})}),e.jsx("h3",{className:"font-heading font-black text-lg sm:text-2xl tracking-wide text-primary",children:"MORNING BRIEFING"})]})}),e.jsx("div",{className:"p-4 sm:p-5",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[i&&e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:"absolute -inset-1 rounded-full bg-gradient-to-br from-red-500 to-pink-500 opacity-70"}),e.jsx(Ar,{mentorSlug:(i.slug||"").toLowerCase(),mentorName:i.name,primaryColor:i.primary_color||"#000",avatarUrl:i.avatar_url||void 0,size:"md",showBorder:!1,className:"relative"})]}),e.jsxs("div",{className:"w-full space-y-4 text-center",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Get personalized insights from ",i?.name||"your mentor"," based on your activity"]}),e.jsx(z,{onClick:y,disabled:p,variant:"cta",className:"w-full h-10 sm:h-12",size:"lg",children:p?e.jsxs(e.Fragment,{children:[e.jsx(Nt,{className:"h-4 w-4 animate-spin"}),"Analyzing your progress..."]}):e.jsxs(e.Fragment,{children:[e.jsx(be,{className:"h-5 w-5"}),"Prepare My Briefing"]})})]})]})})]});const x=Array.isArray(o.inferred_goals)?o.inferred_goals:[];return e.jsxs(Xe,{className:I("overflow-hidden bg-card/25 backdrop-blur-2xl border-white/[0.08]",s),children:[e.jsx("div",{className:"p-4 sm:p-6 border-b border-white/[0.06]",children:e.jsxs("div",{className:"flex items-start gap-4",children:[i&&e.jsx(Ar,{mentorSlug:(i.slug||"").toLowerCase(),mentorName:i.name,primaryColor:i.primary_color||"#000",avatarUrl:i.avatar_url||void 0,size:"md",showBorder:!0,className:"flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("h3",{className:"font-bold text-base sm:text-lg truncate",children:[i?.name||"Your Mentor","'s Briefing"]}),e.jsx(be,{className:"h-4 w-4 text-primary flex-shrink-0"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Personalized insights for today"})]})]})}),x.length>0&&e.jsxs("div",{className:"px-4 sm:px-6 py-3 bg-white/[0.02] border-b border-white/[0.06]",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Rs,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wide",children:"What I see you working toward"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:x.map((v,j)=>e.jsx(Oe,{variant:"secondary",className:"bg-primary/10 text-primary border-primary/20",children:v},j))})]}),e.jsxs("div",{className:"p-4 sm:p-6 space-y-4",children:[e.jsx("div",{className:I("text-sm leading-relaxed text-foreground/90 whitespace-pre-wrap",!h&&"line-clamp-4"),children:o.content}),o.content.length>300&&e.jsx(z,{variant:"ghost",size:"sm",onClick:()=>f(!h),className:"text-primary hover:text-primary/80 -ml-2",children:h?"Show less":"Read more"}),o.todays_focus&&e.jsx("div",{className:"bg-white/[0.03] backdrop-blur-xl rounded-2xl p-4 border border-white/[0.08]",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(It,{className:"h-5 w-5 text-primary flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wide mb-1",children:"Today's Focus"}),e.jsx("p",{className:"text-sm font-medium text-foreground",children:o.todays_focus})]})]})})]}),e.jsxs("div",{className:"px-4 sm:px-6 pb-4 sm:pb-6 flex flex-col sm:flex-row gap-3",children:[e.jsxs(z,{variant:"outline",onClick:b,className:"flex-1 sm:flex-none",children:[e.jsx(Rt,{className:"h-4 w-4 mr-2"}),"Done"]}),e.jsxs(z,{onClick:w,className:"flex-1 bg-primary hover:bg-primary/90",children:[e.jsx(zo,{className:"h-4 w-4 mr-2"}),"Ask ",i?.name||"Mentor"," More"]})]})]})});hp.displayName="MorningBriefing";const fp=()=>{const{user:t}=_e(),s=Ie(),{awardCustomXP:a,XP_REWARDS:r}=rs(),[i,o]=n.useState(!1),l=ae(new Date,"yyyy-MM-dd"),c=new Date().getHours()>=18,{data:d,isLoading:u}=Ee({queryKey:["evening-reflection",t?.id,l],queryFn:async()=>{if(!t?.id)return null;const{data:m,error:g}=await k.from("evening_reflections").select("*").eq("user_id",t.id).eq("reflection_date",l).maybeSingle();if(g)throw g;return m},enabled:!!t?.id}),p=!!d,h=c&&!p&&!u,f=he({mutationFn:async m=>{if(!t?.id)throw new Error("Not authenticated");const{data:g,error:y}=await k.from("evening_reflections").insert({user_id:t.id,reflection_date:l,mood:m.mood,wins:m.wins||null,gratitude:m.gratitude||null}).select().single();if(y)throw y;return k.functions.invoke("generate-evening-response",{body:{reflectionId:g.id}}).catch(console.error),g},onSuccess:()=>{s.invalidateQueries({queryKey:["evening-reflection"]}),a(r.EVENING_REFLECTION,"evening_reflection","Evening Reflection"),o(!1)}});return{isEvening:c,hasCompletedToday:p,shouldShowBanner:h,todaysReflection:d,isLoading:u,isDrawerOpen:i,setIsDrawerOpen:o,submitReflection:f.mutate,isSubmitting:f.isPending}},Ra=({shouldScaleBackground:t=!0,repositionInputs:s,...a})=>e.jsx(vs.Root,{shouldScaleBackground:t,repositionInputs:s,...a});Ra.displayName="Drawer";const ml=vs.Trigger,xv=vs.Portal,gp=n.forwardRef(({className:t,...s},a)=>e.jsx(vs.Overlay,{ref:a,className:I("fixed inset-0 z-50 bg-black/58 backdrop-blur-[2px]",t),style:{touchAction:"none",WebkitTapHighlightColor:"transparent"},...s}));gp.displayName=vs.Overlay.displayName;const Ia=n.forwardRef(({className:t,children:s,...a},r)=>e.jsxs(xv,{children:[e.jsx(gp,{}),e.jsxs(vs.Content,{ref:r,className:I("fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto max-h-[85dvh] flex-col rounded-t-[20px] border border-border/70 bg-card/95 backdrop-blur-xl isolate shadow-[0_-14px_34px_rgba(0,0,0,0.34)]",t),style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent",willChange:"transform"},...a,children:[e.jsx(vs.Handle,{className:"mx-auto mt-4 h-1.5 w-[88px] rounded-full bg-muted-foreground/45"}),s]})]}));Ia.displayName="DrawerContent";const qa=({className:t,...s})=>e.jsx("div",{className:I("grid gap-1.5 p-4 text-center sm:text-left",t),...s});qa.displayName="DrawerHeader";const xp=({className:t,...s})=>e.jsx("div",{className:I("mt-auto flex flex-col gap-2 p-4",t),...s});xp.displayName="DrawerFooter";const La=n.forwardRef(({className:t,...s},a)=>e.jsx(vs.Title,{ref:a,className:I("text-lg font-semibold leading-none tracking-tight",t),...s}));La.displayName=vs.Title.displayName;const pl=n.forwardRef(({className:t,...s},a)=>e.jsx(vs.Description,{ref:a,className:I("text-sm text-muted-foreground",t),...s}));pl.displayName=vs.Description.displayName;const yv=()=>typeof navigator>"u"?!1:/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,bv=()=>typeof window.Capacitor<"u",wv=()=>{if(typeof document>"u")return 0;try{const t=document.createElement("div");t.style.paddingBottom="env(safe-area-inset-bottom, 0px)",document.body.appendChild(t);const s=parseInt(getComputedStyle(t).paddingBottom)||0;return document.body.removeChild(t),s}catch{return 0}};function vv(t={}){const{enabled:s=!0,offsetBuffer:a=0,animationDuration:r=200}=t,[i,o]=n.useState(0),[l,c]=n.useState(0),d=n.useRef(!1),u=n.useRef([]),p=n.useMemo(()=>yv(),[]),h=n.useMemo(()=>bv(),[]),f=i>0,m=s?i+a:0,g=n.useCallback(()=>{if(!s||!window.visualViewport||d.current)return;d.current=!0;const j=window.visualViewport.height,T=window.innerHeight,S=window.visualViewport.offsetTop,N=Math.max(0,T-j-S);o(D=>Math.abs(D-N)>10||N===0?N:D),d.current=!1},[s]),y=n.useCallback(()=>{u.current.forEach(T=>clearTimeout(T)),u.current=[],[50,150,300,500].forEach(T=>{const S=setTimeout(g,T);u.current.push(S)})},[g]);n.useEffect(()=>{c(wv())},[]),n.useEffect(()=>{if(!s||!window.visualViewport)return;window.visualViewport.addEventListener("resize",g),window.visualViewport.addEventListener("scroll",g);const j=S=>{const N=S.target;(N?.tagName==="INPUT"||N?.tagName==="TEXTAREA")&&y()},T=()=>{setTimeout(()=>{(!document.activeElement||document.activeElement.tagName!=="INPUT"&&document.activeElement.tagName!=="TEXTAREA")&&o(0)},100)};return document.addEventListener("focusin",j),document.addEventListener("focusout",T),g(),()=>{window.visualViewport?.removeEventListener("resize",g),window.visualViewport?.removeEventListener("scroll",g),document.removeEventListener("focusin",j),document.removeEventListener("focusout",T),u.current.forEach(S=>clearTimeout(S))}},[s,g,y]);const b=n.useCallback(j=>{j.current&&setTimeout(()=>{j.current?.scrollIntoView({behavior:"smooth",block:"center"})},300)},[]),w=n.useCallback(()=>{document.activeElement instanceof HTMLElement&&document.activeElement.blur()},[]),x=n.useMemo(()=>({bottom:m>0?`${m}px`:"0px",transition:`bottom ${r}ms ease-out`}),[m,r]),v=n.useMemo(()=>({touchAction:"manipulation",WebkitTapHighlightColor:"transparent"}),[]);return{keyboardHeight:i,isKeyboardVisible:f,safeAreaBottom:l,totalOffset:m,isIOS:p,isNative:h,containerStyle:x,inputStyle:v,scrollInputIntoView:b,dismissKeyboard:w}}const _v=[{emoji:"ðŸ˜Š",label:"Great",value:"great"},{emoji:"ðŸ™‚",label:"Good",value:"good"},{emoji:"ðŸ˜",label:"Okay",value:"okay"},{emoji:"ðŸ˜”",label:"Low",value:"low"},{emoji:"ðŸ˜¢",label:"Rough",value:"rough"}],jv=({open:t,onOpenChange:s})=>{const{submitReflection:a,isSubmitting:r}=fp(),[i,o]=n.useState(""),[l,c]=n.useState(""),[d,u]=n.useState(""),p=n.useRef(null),h=n.useRef(null),{containerStyle:f,inputStyle:m,scrollInputIntoView:g}=vv({offsetBuffer:10}),y=x=>{x||(o(""),c(""),u("")),s(x)},b=()=>{i&&(a({mood:i,wins:l.trim()||void 0,gratitude:d.trim()||void 0}),o(""),c(""),u(""))},w=i.length>0;return e.jsx(Ra,{open:t,onOpenChange:y,shouldScaleBackground:!1,handleOnly:!0,repositionInputs:!1,children:e.jsx(Ia,{className:"max-h-[85dvh]",style:f,children:e.jsxs("div",{className:"mx-auto w-full max-w-lg px-4 pb-8 overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",maxHeight:"calc(85dvh - 80px)"},"data-vaul-no-drag":!0,children:[e.jsxs(qa,{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[e.jsx(sr,{className:"h-6 w-6 text-purple-400"}),e.jsx(La,{className:"text-xl",children:"Evening Reflection"})]}),e.jsx(pl,{children:"Take a moment to reflect on your day"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"How are you feeling tonight?"}),e.jsx("div",{className:"flex justify-center gap-2",children:_v.map(x=>e.jsxs("button",{onClick:()=>o(x.value),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all ${i===x.value?"bg-primary/20 border-2 border-primary scale-105":"bg-muted/50 border-2 border-transparent hover:bg-muted"}`,children:[e.jsx("span",{className:"text-2xl",children:x.emoji}),e.jsx("span",{className:"text-xs text-muted-foreground",children:x.label})]},x.value))})]}),e.jsxs("div",{className:"space-y-2","data-vaul-no-drag":!0,children:[e.jsxs("label",{className:"text-sm font-medium text-foreground",children:["What went well today? ",e.jsx("span",{className:"text-muted-foreground",children:"(optional)"})]}),e.jsx(Zt,{ref:p,placeholder:"A small win, a moment of joy, something you accomplished...",value:l,onChange:x=>c(x.target.value.slice(0,280)),onFocus:()=>g(p),className:"resize-none h-20 bg-muted/30 border-border/50",style:m}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[l.length,"/280"]})]}),e.jsxs("div",{className:"space-y-2","data-vaul-no-drag":!0,children:[e.jsxs("label",{className:"text-sm font-medium text-foreground",children:["What are you grateful for? ",e.jsx("span",{className:"text-muted-foreground",children:"(optional)"})]}),e.jsx(Zt,{ref:h,placeholder:"Something or someone you appreciate today...",value:d,onChange:x=>u(x.target.value.slice(0,280)),onFocus:()=>g(h),className:"resize-none h-20 bg-muted/30 border-border/50",style:m}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[d.length,"/280"]})]}),e.jsx(z,{onClick:b,disabled:!w||r,className:"w-full h-12 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500",children:r?"Saving...":e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4"}),"Complete Reflection",e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-white/20",children:"+3 XP"})]})})]})]})})})},yp=n.memo(()=>{const{shouldShowBanner:t,isDrawerOpen:s,setIsDrawerOpen:a}=fp();return t?e.jsxs(e.Fragment,{children:[e.jsx(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mx-4",children:e.jsxs("button",{onClick:()=>a(!0),className:"relative w-full p-4 rounded-2xl bg-gradient-to-r from-indigo-600/30 via-purple-600/30 to-pink-600/30 border border-purple-500/40 backdrop-blur-sm hover:border-purple-400/60 hover:shadow-lg hover:shadow-purple-500/20 transition-all duration-300 group overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 overflow-hidden rounded-2xl",children:e.jsx("div",{className:"absolute inset-0 -translate-x-full animate-[shimmer-sweep_3s_ease-in-out_infinite] bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12"})}),e.jsxs("div",{className:"absolute inset-0 overflow-hidden rounded-2xl pointer-events-none",children:[e.jsx(P.div,{animate:{opacity:[.3,.7,.3],scale:[.8,1.1,.8]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},className:"absolute top-2 right-8",children:e.jsx(be,{className:"h-3 w-3 text-purple-300/60"})}),e.jsx(P.div,{animate:{opacity:[.5,.9,.5],scale:[1,1.2,1]},transition:{duration:2.5,repeat:1/0,ease:"easeInOut",delay:.5},className:"absolute bottom-3 right-16",children:e.jsx(be,{className:"h-2 w-2 text-pink-300/50"})})]}),e.jsx("div",{className:"absolute inset-0 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-gradient-to-r from-indigo-500/10 via-purple-500/10 to-pink-500/10"}),e.jsxs("div",{className:"relative flex items-center gap-3",children:[e.jsx(P.div,{className:"p-2.5 rounded-full bg-gradient-to-br from-purple-500/30 to-indigo-500/30 border border-purple-400/30 group-hover:border-purple-300/50 transition-all duration-300",animate:{boxShadow:["0 0 0 0 rgba(168, 85, 247, 0)","0 0 15px 2px rgba(168, 85, 247, 0.3)","0 0 0 0 rgba(168, 85, 247, 0)"]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx(sr,{className:"h-5 w-5 text-purple-200 group-hover:text-purple-100 transition-colors"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-semibold text-foreground group-hover:text-white transition-colors",children:"Evening Reflection"}),e.jsx("p",{className:"text-sm text-muted-foreground group-hover:text-purple-200/80 transition-colors",children:"How was your day? âœ¨"})]}),e.jsx(P.div,{className:"text-xs px-3 py-1.5 rounded-full bg-gradient-to-r from-primary/30 to-purple-500/30 text-primary font-bold border border-primary/30 group-hover:border-primary/50 transition-all",animate:{scale:[1,1.05,1]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"},children:"+3 XP"})]})]})}),e.jsx(jv,{open:s,onOpenChange:a})]}):null});yp.displayName="EveningReflectionBanner";const bp=n.memo(()=>{const{currentRecap:t,openRecap:s}=ip();if(!t)return null;const a=Jt(t.week_start_date),r=Jt(t.week_end_date),i=`${ae(a,"MMM d")} - ${ae(r,"MMM d")}`;return e.jsx(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mx-4",children:e.jsx("button",{onClick:()=>s(t),className:"w-full p-4 rounded-2xl bg-gradient-to-r from-stardust-gold/10 via-amber-500/5 to-celestial-blue/5 border border-white/[0.08] backdrop-blur-2xl hover:border-stardust-gold/30 transition-all group shadow-[0_8px_32px_rgba(0,0,0,0.12)]",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full bg-stardust-gold/20 group-hover:bg-stardust-gold/30 transition-colors",children:e.jsx(be,{className:"h-5 w-5 text-stardust-gold"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-medium text-foreground",children:"Your Week in Review"}),e.jsx("p",{className:"text-sm text-celestial-blue",children:i})]}),!t.viewed_at&&e.jsx("div",{className:"text-xs px-2 py-1 rounded-full bg-stardust-gold/20 text-stardust-gold font-medium",children:"+5 XP"}),e.jsx(Dt,{className:"h-5 w-5 text-muted-foreground group-hover:text-stardust-gold transition-colors"})]})})})});bp.displayName="WeeklyRecapCard";function Nv(){const{user:t}=_e(),s=Ie(),{data:a,isLoading:r,error:i,refetch:o}=Ee({queryKey:["daily-plan-optimization",t?.id],queryFn:async()=>{if(!t)return null;const{data:f,error:m}=await k.functions.invoke("optimize-daily-plan");if(m)throw console.error("Error fetching daily plan optimization:",m),m;return f},enabled:!!t,staleTime:300*1e3,gcTime:900*1e3,refetchOnWindowFocus:!1}),l=he({mutationFn:async f=>{const{data:m,error:g}=await k.functions.invoke("generate-daily-plan",{body:f});if(g)throw console.error("Error generating daily plan:",g),g;return m},onSuccess:()=>{s.invalidateQueries({queryKey:["daily-tasks"]}),s.invalidateQueries({queryKey:["calendar-tasks"]})}}),c=n.useCallback(async f=>{if(!t)return null;const m=f?{energyLevel:f.energyLevel,dayType:f.dayType,focusArea:f.focusArea}:{},{data:g,error:y}=await k.functions.invoke("optimize-daily-plan",{body:m});if(y)throw console.error("Error fetching daily plan optimization with answers:",y),y;return g},[t]),d=a?.insights??[],u=d.filter(f=>f.priority==="high"),p=d.some(f=>f.type==="warning"),h=d.some(f=>f.type==="encouragement");return{insights:d,highPriorityInsights:u,energyForecast:a?.energyForecast,overallReadiness:a?.overallReadiness??0,suggestedSchedule:a?.suggestedSchedule,hasWarnings:p,hasEncouragement:h,isLoading:r,error:i instanceof Error?i.message:null,refetch:o,optimizeWithAnswers:c,generatePlan:l.mutateAsync,isGenerating:l.isPending,generateError:l.error}}const kv={optimization:{icon:bt,color:"text-blue-500",bgColor:"bg-blue-500/10",borderColor:"border-blue-500/30"},warning:{icon:ca,color:"text-amber-500",bgColor:"bg-amber-500/10",borderColor:"border-amber-500/30"},encouragement:{icon:Rs,color:"text-green-500",bgColor:"bg-green-500/10",borderColor:"border-green-500/30"},suggestion:{icon:Go,color:"text-purple-500",bgColor:"bg-purple-500/10",borderColor:"border-purple-500/30"}},Cv=n.memo(function({insight:s,onAction:a,onDismiss:r}){const i=kv[s.type],o=i.icon;return e.jsx(P.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},exit:{opacity:0,x:10},children:e.jsx("div",{className:I("rounded-2xl backdrop-blur-2xl border-l-4 border-t border-r border-b bg-card/25 p-4",i.borderColor.replace("border-","border-l-"),"border-t-white/[0.08] border-r-white/[0.08] border-b-white/[0.08]"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:I("p-2 rounded-lg flex-shrink-0",i.bgColor),children:e.jsx(o,{className:I("h-4 w-4",i.color)})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1",children:[e.jsx("p",{className:"text-sm font-bold text-foreground",children:s.title}),r&&s.priority!=="high"&&e.jsx(z,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-50 hover:opacity-100",onClick:()=>r(s),children:e.jsx(kt,{className:"h-3 w-3"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground leading-relaxed",children:s.message}),s.actionLabel&&a&&e.jsxs("button",{className:I("mt-2 text-xs font-bold uppercase tracking-wide flex items-center gap-1",i.color),onClick:()=>a(s),children:[s.actionLabel,e.jsx(Dt,{className:"h-3 w-3"})]})]})]})})})}),Sv=n.memo(function({compact:s=!1,maxInsights:a=3,onInsightAction:r}){const{insights:i,isLoading:o}=Nv();if(o)return e.jsx("div",{className:"rounded-2xl bg-card/25 backdrop-blur-2xl border border-white/[0.08] p-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(be,{className:"h-4 w-4 animate-pulse"}),e.jsx("span",{className:"text-sm",children:"Analyzing your day..."})]})});if(i.length===0)return null;const l=i.slice(0,a);return e.jsx("div",{className:"space-y-4",children:e.jsx(Re,{mode:"popLayout",children:e.jsx("div",{className:"space-y-3",children:l.map((c,d)=>e.jsx(Cv,{insight:c,onAction:r},`${c.type}-${c.title}-${d}`))})})})}),gs=({children:t,offset:s=20,stiffness:a=100,damping:r=30,className:i})=>{const o=n.useRef(null),l=Yr(),c=n.useMemo(()=>typeof window>"u"?!1:Ze.isNativePlatform()&&Ze.getPlatform()==="ios",[]),d=l||c,{scrollYProgress:u}=vg({target:o,offset:["start end","end start"]}),p=Ci(u,[0,1],[s*.65,-s*.65]),h=Ml(p,{stiffness:a,damping:r}),f=Ci(u,[0,.5,1],[.992,1,.992]),m=Ml(f,{stiffness:170,damping:36}),g=Ci(u,[0,.3,.7,1],[.9,1,1,.9]);return d?e.jsx("div",{className:I(i),children:t}):e.jsx(P.div,{ref:o,style:{y:h,scale:m,opacity:g,willChange:"transform, opacity"},className:I(i),children:t})},vc=.15,Ev=({enabled:t=!0}={})=>{const[s,a]=n.useState({gamma:0,beta:0,permitted:!1,available:typeof DeviceOrientationEvent<"u"}),r=n.useRef(0),i=n.useRef(0),o=n.useRef(0),l=n.useRef(0),c=n.useCallback(async()=>{if(!t)return!1;if(typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function")try{return await DeviceOrientationEvent.requestPermission()==="granted"?(a(f=>({...f,permitted:!0})),!0):!1}catch{return!1}return a(h=>({...h,permitted:!0})),!0},[t]);n.useEffect(()=>{if(!t||!s.available)return;const h=f=>{o.current=f.gamma??0,l.current=f.beta??0,r.current=r.current+vc*(o.current-r.current),i.current=i.current+vc*(l.current-i.current),a(m=>({...m,gamma:r.current,beta:i.current,permitted:!0}))};return window.addEventListener("deviceorientation",h),()=>{window.removeEventListener("deviceorientation",h)}},[t,s.available]);const d=n.useCallback((h=5,f=2.5)=>{const{gamma:m}=s,y=(Math.abs(m)<h?0:m)/30*50*f;return Math.max(8,Math.min(92,50+y))},[s]),u=n.useCallback((h=8,f=1.5)=>{const{beta:m}=s,g=m>=0?1:-1,y=Math.abs(m),w=(y<h?g*(y*y/h):g*y)/50*50*f;return Math.max(3,Math.min(97,50+w))},[s]),p=n.useCallback(()=>({gamma:o.current,beta:l.current}),[]);return{...s,requestPermission:c,getPositionFromTilt:d,getLandscapePositionFromTilt:u,getRawOrientation:p}},Tv={dawn:{white:.35,blue:.1,pink:.2,gold:.25,teal:.05,orange:.05},morning:{white:.4,blue:.25,pink:.1,gold:.1,teal:.1,orange:.05},afternoon:{white:.35,blue:.15,pink:.1,gold:.2,teal:.15,orange:.05},sunset:{white:.25,blue:.05,pink:.25,gold:.2,teal:.05,orange:.2},night:{white:.4,blue:.25,pink:.15,gold:.1,teal:.1,orange:0}},Mv=()=>{const{period:t,progress:s,colors:a,rotationHue:r}=ry(),i=n.useMemo(()=>Tv[t],[t]),o=n.useMemo(()=>()=>{const u=Math.random(),p=i;let h=0;return(h+=p.orange)>u&&p.orange>0?"orange":(h+=p.gold)>u?"gold":(h+=p.teal)>u?"teal":(h+=p.pink)>u?"pink":(h+=p.blue)>u?"blue":"white"},[i]),l=(u,p=0)=>{const h={white:[0,0,100],blue:[200,85,70],pink:[320,60,75],gold:[45,100,65],teal:[175,70,60],orange:[25,90,65]},[f,m,g]=h[u];return`hsl(${u==="white"?f:(f+p)%360}, ${m}%, ${g}%)`};return{period:t,progress:s,colors:a,rotationHue:r,starDistribution:i,getStarColorForPeriod:o,getStarHSL:l,getStarGlow:(u,p,h=0)=>{const f=l(u,h);return u==="white"?`0 0 6px hsla(0, 0%, 100%, ${p})`:`0 0 8px ${f.replace(")",` / ${p})`).replace("hsl","hsla")}, 0 0 16px ${f.replace(")",` / ${p*.5})`).replace("hsl","hsla")}`},getNebulaGradient:u=>{const p=`nebula${u}`;return a[p]}}},wp=n.createContext({isTabActive:!0}),Dv=({isTabActive:t,children:s})=>e.jsx(wp.Provider,{value:{isTabActive:t},children:s}),sn=()=>n.useContext(wp),Vi=(t,s,a,r,i)=>Array.from({length:t},(o,l)=>({id:l,x:Math.random()*100,y:Math.random()*100,size:Math.random()*(a-s)+s,opacity:Math.random()*(i-r)+r,animationDelay:Math.random()*10,animationDuration:Math.random()*4+4,colorSeed:Math.random()})),Av=t=>Array.from({length:t},(s,a)=>({id:a,x:Math.random()*100,y:Math.random()*100,size:Math.random()*.5+.5,opacity:Math.random()*.15+.1,driftDuration:Math.random()*60+60,driftDelay:Math.random()*30})),Pv=()=>[{id:1,delay:5,duration:90,startX:15,startY:10,angle:35},{id:2,delay:45,duration:120,startX:85,startY:8,angle:145},{id:3,delay:75,duration:150,startX:50,startY:5,angle:80}],ua={deepNebulae:1,dust:2,backgroundStars:3,midNebulae:4,midStars:5,foregroundNebulae:6,brightStars:8},an=n.memo(()=>{const{isTabActive:t}=sn(),{capabilities:s,signals:a}=cl(),r=n.useRef(null),i=n.useRef(null),o=n.useRef({x:0,y:0});n.useRef(null);const l=n.useMemo(()=>{if(typeof window>"u")return!1;const $=window.Capacitor;return!!($?.isNativePlatform?.()&&$?.getPlatform?.()==="ios")},[]),c=t&&s.allowBackgroundAnimation&&!a.isBackgrounded&&!a.prefersReducedMotion&&!l,d=t&&s.allowParallax&&!a.isBackgrounded&&!a.prefersReducedMotion&&!l,u=!c,{gamma:p,beta:h,permitted:f}=Ev({enabled:d}),{period:m,colors:g,rotationHue:y,starDistribution:b,getStarHSL:w,getStarGlow:x}=Mv(),{presence:v}=ii();n.useEffect(()=>{},[s.maxParticles,t,c,d,u]);const j=n.useMemo(()=>{const{mood:$}=v;let B=0;switch($){case"joyful":B=10;break;case"content":B=5;break;case"neutral":B=0;break;case"reserved":B=-5;break;case"quiet":B=-10;break;case"dormant":B=0;break}return B},[v]),T=n.useCallback(($,B)=>{o.current={x:$,y:B},i.current===null&&(i.current=requestAnimationFrame(()=>{i.current=null,r.current&&(r.current.style.setProperty("--parallax-x",String(o.current.x)),r.current.style.setProperty("--parallax-y",String(o.current.y)))}))},[]);n.useEffect(()=>{if(!d){T(0,0);return}const $=B=>{const W=(B.clientX/window.innerWidth-.5)*2,H=(B.clientY/window.innerHeight-.5)*2;T(W,H)};return window.addEventListener("mousemove",$,{passive:!0}),()=>window.removeEventListener("mousemove",$)},[T,d]),n.useEffect(()=>{if(!d||!f)return;const $=Math.max(-1,Math.min(1,p/30)),B=Math.max(-1,Math.min(1,(h-45)/30));T($,B)},[h,p,f,T,d]),n.useEffect(()=>()=>{i.current!==null&&cancelAnimationFrame(i.current)},[]);const S=n.useCallback($=>d?{transform:`translate(calc(var(--parallax-x, 0) * ${$}px), calc(var(--parallax-y, 0) * ${$}px))`,transition:"transform 0.22s ease-out",willChange:"transform"}:{},[d]),N=n.useCallback($=>{const B=b;let W=0;return(W+=B.orange)>$&&B.orange>0?"orange":(W+=B.gold)>$?"gold":(W+=B.teal)>$?"teal":(W+=B.pink)>$?"pink":(W+=B.blue)>$?"blue":"white"},[b]),D=Math.max(4,s.maxParticles),R=n.useMemo(()=>t?u?{dust:2,background:6,mid:2,bright:1}:{dust:Math.max(8,Math.round(D*.55)),background:Math.max(12,Math.round(D*.6)),mid:Math.max(6,Math.round(D*.34)),bright:Math.max(3,Math.round(D*.2))}:{dust:0,background:4,mid:0,bright:0},[t,D,u]),_=n.useMemo(()=>Av(R.dust),[R.dust]),C=n.useMemo(()=>Vi(R.background,.8,1.5,.3,.5),[R.background]),E=n.useMemo(()=>Vi(R.mid,1.5,2.5,.4,.7),[R.mid]),O=n.useMemo(()=>Vi(R.bright,2.5,4,.7,1),[R.bright]),M=n.useMemo(()=>c?Pv():[],[c]),A=n.useMemo(()=>({dawn:"linear-gradient(to bottom, hsl(350, 30%, 12%), hsl(25, 25%, 10%), hsl(240, 15%, 8%))",morning:"linear-gradient(to bottom, hsl(200, 35%, 12%), hsl(190, 25%, 10%), hsl(240, 15%, 8%))",afternoon:"linear-gradient(to bottom, hsl(35, 30%, 12%), hsl(180, 20%, 10%), hsl(240, 15%, 8%))",sunset:"linear-gradient(to bottom, hsl(340, 35%, 15%), hsl(20, 30%, 12%), hsl(270, 25%, 10%))",night:"linear-gradient(to bottom, hsl(240, 30%, 10%), hsl(250, 20%, 8%), hsl(0, 0%, 5%))"})[m],[m]),L=y*.1+j,q=t?u?"lite":"full":"inactive";return e.jsxs("div",{ref:r,className:"fixed inset-0 overflow-hidden pointer-events-none -z-10","data-starfield-mode":q,children:[e.jsx("div",{className:"absolute inset-0 transition-all [transition-duration:3000ms]",style:{background:A}}),e.jsxs("div",{className:"absolute inset-0",style:S(ua.deepNebulae),children:[e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:5000ms]",style:{top:u?"-8%":"-15%",right:u?"-6%":"-10%",width:u?"560px":"900px",height:u?"560px":"900px",filter:u?"blur(90px)":"blur(150px)",background:`radial-gradient(ellipse at center, ${g.nebula1.replace(")"," / 0.25)")}, transparent 70%)`,animation:c?"nebula-drift-slow 55s ease-in-out infinite":"none"}}),e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:5000ms]",style:{bottom:u?"-10%":"-20%",left:u?"-8%":"-15%",width:u?"500px":"800px",height:u?"500px":"800px",filter:u?"blur(80px)":"blur(140px)",background:`radial-gradient(ellipse at center, ${g.nebula2.replace(")"," / 0.2)")}, transparent 70%)`,animation:c?"nebula-drift-slow 65s ease-in-out infinite reverse":"none"}})]}),c&&_.length>0&&e.jsx("div",{className:"absolute inset-0",style:S(ua.dust),children:_.map($=>e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:3000ms]",style:{left:`${$.x}%`,top:`${$.y}%`,width:`${$.size}px`,height:`${$.size}px`,opacity:$.opacity,backgroundColor:`${g.nebula3.replace(")"," / 0.4)")}`}},`dust-${$.id}`))}),e.jsx("div",{className:"absolute inset-0",style:S(ua.backgroundStars),children:C.map($=>{const B=N($.colorSeed);return e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:2000ms]",style:{left:`${$.x}%`,top:`${$.y}%`,width:`${$.size}px`,height:`${$.size}px`,opacity:$.opacity,backgroundColor:w(B,L),boxShadow:x(B,$.opacity*.5,L),animation:c?`twinkle ${$.animationDuration}s ease-in-out ${$.animationDelay}s infinite`:"none"}},`bg-star-${$.id}`)})}),c&&e.jsxs("div",{className:"absolute inset-0 opacity-30",style:S(ua.midNebulae),children:[e.jsx("div",{className:"absolute w-[600px] h-[300px] blur-[100px] -rotate-12 transition-colors [transition-duration:5000ms]",style:{top:"10%",right:"5%",background:`linear-gradient(135deg, ${g.nebula1.replace(")"," / 0.35)")}, ${g.nebula3.replace(")"," / 0.15)")}, transparent)`}}),e.jsx("div",{className:"absolute w-[500px] h-[250px] blur-[90px] rotate-12 transition-colors [transition-duration:5000ms]",style:{bottom:"15%",left:"10%",background:`linear-gradient(135deg, ${g.nebula2.replace(")"," / 0.3)")}, ${g.accent.replace(")"," / 0.15)")}, transparent)`}})]}),c&&E.length>0&&e.jsx("div",{className:"absolute inset-0",style:S(ua.midStars),children:E.map($=>{const B=N($.colorSeed);return e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:2000ms]",style:{left:`${$.x}%`,top:`${$.y}%`,width:`${$.size}px`,height:`${$.size}px`,opacity:$.opacity,backgroundColor:w(B,L),boxShadow:x(B,$.opacity,L)}},`mid-star-${$.id}`)})}),c&&e.jsxs("div",{className:"absolute inset-0 opacity-25",style:S(ua.foregroundNebulae),children:[e.jsx("div",{className:"absolute w-[350px] h-[350px] rounded-full blur-[70px] transition-colors [transition-duration:5000ms]",style:{top:"25%",right:"20%",background:`radial-gradient(ellipse at center, ${g.primary.replace(")"," / 0.5)")}, transparent 60%)`,animation:"nebula-pulse 25s ease-in-out infinite"}}),e.jsx("div",{className:"absolute w-[300px] h-[300px] rounded-full blur-[60px] transition-colors [transition-duration:5000ms]",style:{bottom:"30%",left:"25%",background:`radial-gradient(ellipse at center, ${g.accent.replace(")"," / 0.45)")}, transparent 60%)`,animation:"nebula-pulse 30s ease-in-out 8s infinite reverse"}})]}),e.jsx("div",{className:"absolute inset-0",style:S(ua.brightStars),children:O.map($=>{const B=N($.colorSeed),W=w(B,L);return e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:2000ms]",style:{left:`${$.x}%`,top:`${$.y}%`,width:`${$.size}px`,height:`${$.size}px`,backgroundColor:W,boxShadow:`${x(B,1,L)}, 0 0 20px ${W}`}},`bright-star-${$.id}`)})}),c&&M.map($=>e.jsx("div",{className:"absolute w-[3px] h-[3px] rounded-full",style:{left:`${$.startX}%`,top:`${$.startY}%`,background:"linear-gradient(to right, transparent, white, white)",boxShadow:"0 0 6px 2px rgba(255, 255, 255, 0.9), -20px 0 15px rgba(255, 255, 255, 0.4), -40px 0 25px rgba(255, 255, 255, 0.2)",animation:`shooting-star-${$.id} ${$.duration}s ease-out ${$.delay}s infinite`}},`shooting-${$.id}`))]})});an.displayName="StarfieldBackground";const Xi=2,Rv=1500,Iv=750,Ua=new Map,Vt=ue.scope("MentorConnectionHealth"),qv=async t=>new Promise(s=>{window.setTimeout(s,t)});function Lv(){const{user:t}=_e(),{profile:s,loading:a}=ss(),r=Ie(),i=n.useRef(!1),o=n.useMemo(()=>ur(s),[s]),l=t?.id?Ua.get(t.id)??null:null,[c,d]=n.useState(o??l),[u,p]=n.useState(o?"ready":a?"recovering":"missing"),h=n.useCallback(async()=>{await Promise.all([r.invalidateQueries({queryKey:["mentor-page-data"]}),r.invalidateQueries({queryKey:["mentor-personality"]}),r.invalidateQueries({queryKey:["mentor"]}),r.invalidateQueries({queryKey:["selected-mentor"]})])},[r]),f=n.useCallback(async(w,x)=>{const v=Oy(x?.onboarding_data),{error:j}=await k.from("profiles").update({onboarding_data:v}).eq("id",w);if(j){Vt.warn("Failed to clear stale onboarding mentor ID",{userId:w,error:j});return}Vt.warn("Cleared stale onboarding mentor ID",{userId:w}),await r.refetchQueries({queryKey:["profile",w]})},[r]),m=n.useCallback(async w=>{const{data:x,error:v}=await k.from("mentors").select("id").eq("id",w).maybeSingle();if(v)throw v;return x?.id??null},[]),g=n.useCallback(async(w,x,v)=>{const{error:j}=await k.from("profiles").update({selected_mentor_id:x}).eq("id",w);if(j){if(Fy(j))return Vt.warn("Invalid mentor reference while backfilling, stripping onboarding mentor",{userId:w,mentorId:x,error:j}),await f(w,v),null;throw j}return await r.refetchQueries({queryKey:["profile",w]}),await h(),x},[h,r,f]),y=n.useCallback(async()=>{if(!t?.id){d(null),p("missing");return}if(i.current)return;i.current=!0,p("recovering"),d(Ua.get(t.id)??null);const w=performance.now();let x=null,v="profile_missing",j=0;Vt.info("Starting mentor connection recovery",{userId:t.id,attempts:Xi});try{for(let S=0;S<Xi;S+=1){const N=S+1;if(j=N,typeof navigator<"u"&&!navigator.onLine){v="offline",Vt.warn("Recovery paused while offline",{userId:t.id,attempt:N});break}await r.refetchQueries({queryKey:["profile",t.id]});const{data:D,error:R}=await k.from("profiles").select("selected_mentor_id, onboarding_completed, onboarding_data").eq("id",t.id).maybeSingle();if(R)v="profile_missing",Vt.warn("Profile fetch failed during mentor recovery",{userId:t.id,attempt:N,error:R});else if(!D)v="profile_missing",Vt.warn("Profile missing during mentor recovery",{userId:t.id,attempt:N});else if(D.selected_mentor_id){x=D.selected_mentor_id,v="profile_selected_mentor";break}else{const C=Am(D);if(!C)v="profile_missing",Vt.warn("No onboarding mentor available during recovery",{userId:t.id,attempt:N});else{const E=await m(C);if(!E)v="mentor_lookup_empty",Vt.warn("Onboarding mentor lookup returned empty result",{userId:t.id,attempt:N,mentorId:C}),await f(t.id,D),v="invalid_onboarding_mentor";else if(x=await g(t.id,E,D),v=x?"backfilled_from_onboarding":"invalid_onboarding_mentor",x)break}}if(performance.now()-w>=Rv||S>=Xi-1)break;await qv(Iv)}}catch(S){v="recovery_error",Vt.warn("Mentor recovery attempt failed",{userId:t.id,cause:v,error:S instanceof Error?S.message:String(S)})}finally{i.current=!1}if(x){Ua.set(t.id,x),d(x),p("ready"),Vt.info("Mentor connection recovery completed",{userId:t.id,attemptsUsed:j,cause:v,recoveredMentorId:x});return}const T=Ua.get(t.id)??null;if(v==="offline"){d(T),p("recovering"),Vt.warn("Mentor recovery still pending (offline)",{userId:t.id,attemptsUsed:j});return}d(T),p("missing"),Vt.warn("Mentor connection recovery failed",{userId:t.id,attemptsUsed:j,cause:v})},[g,r,f,t?.id,m]),b=n.useCallback(async()=>{await y()},[y]);return n.useEffect(()=>{if(!t?.id){d(null),p("missing");return}if(o){Ua.set(t.id,o),d(o),p("ready");return}const w=Ua.get(t.id)??null;if(a){d(w),p("recovering");return}y()},[y,a,o,t?.id]),n.useEffect(()=>{if(!t?.id)return;const w=()=>{u!=="ready"&&y()};return window.addEventListener("online",w),()=>window.removeEventListener("online",w)},[y,u,t?.id]),{effectiveMentorId:c,status:u,refreshConnection:b}}const Ov=({enableOnboardingGuard:t=!1})=>{const{user:s}=_e(),{isTabActive:a}=sn(),{profile:r,loading:i}=ss(),{companion:o,isLoading:l}=At(),{isTransitioning:c}=Vx(),d=ts(),u=Ie();n.useEffect(()=>{window.scrollTo(0,0)},[]);const{effectiveMentorId:p,status:h,refreshConnection:f}=Lv(),{data:m,isLoading:g,isError:y}=Ee({queryKey:["mentor-page-data",p],queryFn:async()=>{if(!p)return null;const{data:S,error:N}=await k.from("mentors").select("avatar_url, slug").eq("id",p).maybeSingle();if(N)throw N;if(!S)return null;const D=S.avatar_url||await ul(S.slug||"atlas"),R=new Date().toLocaleDateString("en-CA"),{data:_,error:C}=await k.from("daily_pep_talks").select("topic_category").eq("for_date",R).eq("mentor_slug",S.slug).maybeSingle();if(C)throw C;let E=null;if(_?.topic_category){const{data:O,error:M}=await k.from("quotes").select("text, author").eq("category",_.topic_category).limit(10);if(M)throw M;let A=O;if(!A||A.length===0){const{data:L,error:q}=await k.from("quotes").select("text, author").limit(20);if(q)throw q;A=L}A&&A.length>0&&(E=A[Math.floor(Math.random()*A.length)])}return{mentorImage:D,todaysQuote:E}},enabled:a&&!!p,staleTime:300*1e3,placeholderData:S=>S}),b=m?.mentorImage||"",w=m?.todaysQuote||null,x=n.useMemo(()=>s?!i&&!l&&(!!!p||!!m||!g):!1,[s,i,l,p,m,g]),v=!t&&h==="missing",j=!t&&!!p&&!g&&!m&&y,T=n.useCallback(S=>{switch(S.actionType){default:d("/journeys")}},[d]);return n.useEffect(()=>{if(!t||!s||!x||!r||r.onboarding_completed===!0)return;const S=!p,N=r.onboarding_completed===!1;(S||N||!o&&!l)&&d("/onboarding")},[t,s,x,r,o,l,d,p]),c||!x?e.jsx(Fb,{}):!i&&!l&&!r?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background p-4",children:e.jsxs("div",{className:"text-center space-y-4 max-w-md",children:[e.jsx("div",{className:"h-12 w-12 mx-auto rounded-full bg-destructive/10 flex items-center justify-center",children:e.jsx("span",{className:"text-2xl",children:"âš ï¸"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Unable to Load Profile"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"We couldn't load your profile data. Please check your connection and try again."}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90",children:"Retry"})]})]})}):e.jsxs(tn,{mode:t?"animated":"instant",children:[e.jsx(an,{}),b&&e.jsxs("div",{className:"fixed inset-0 z-0 pointer-events-none",children:[e.jsx("img",{src:b,alt:"Mentor background",className:"w-full h-full object-cover object-center",loading:"eager",decoding:"async"}),e.jsx("div",{className:"absolute inset-0 bg-background/85"})]}),e.jsx("div",{className:"relative z-10 min-h-screen pb-nav-safe pt-safe",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-3 sm:px-4 pt-28 sm:pt-24 md:pt-20 space-y-4 sm:space-y-6 md:space-y-8",children:[j&&e.jsx("div",{className:"mx-4 sm:mx-6 rounded-2xl border border-destructive/45 bg-card/40 backdrop-blur-2xl p-4 sm:p-5 shadow-[0_8px_30px_rgba(0,0,0,0.18)]",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-base sm:text-lg font-bold",children:"Mentor temporarily unavailable"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"We could not refresh your mentor data right now. Try again in a moment."})]}),e.jsx(z,{onClick:()=>{f(),u.refetchQueries({queryKey:["mentor-page-data"]}),u.refetchQueries({queryKey:["mentor-personality"]})},className:"sm:self-start",variant:"outline",children:"Retry"})]})}),v&&e.jsx("div",{className:"mx-4 sm:mx-6 rounded-2xl border border-primary/35 bg-card/40 backdrop-blur-2xl p-4 sm:p-5 shadow-[0_8px_30px_rgba(0,0,0,0.18)]",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-base sm:text-lg font-bold",children:"Mentor connection lost"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Reconnect a mentor to restore personalized briefings, pep talks, and chat."})]}),e.jsx(z,{onClick:()=>d("/mentor-selection"),className:"sm:self-start",children:"Reconnect Mentor"})]})}),w&&e.jsx("div",{className:"text-right px-4 sm:px-6",children:e.jsxs("blockquote",{className:"max-w-2xl ml-auto",children:[e.jsxs("p",{className:"font-serif italic text-lg sm:text-xl md:text-2xl text-foreground/90 leading-relaxed",children:['"',w.text,'"']}),w.author&&e.jsxs("footer",{className:"mt-2 font-serif italic text-sm sm:text-base text-muted-foreground",children:["â€” ",w.author]})]})}),e.jsx(gs,{offset:14,children:e.jsx(ls,{children:e.jsx(pp,{})})}),e.jsx(gs,{offset:12,children:e.jsx(ls,{children:e.jsx(hp,{})})}),e.jsx(gs,{offset:10,children:e.jsx(ls,{children:e.jsx(yp,{})})}),e.jsx(gs,{offset:10,children:e.jsx(ls,{children:e.jsx(bp,{})})}),e.jsx(gs,{offset:9,children:e.jsx(ls,{children:e.jsx(Sv,{maxInsights:3,onInsightAction:T})})}),e.jsx(gs,{offset:8,children:e.jsx(ls,{children:e.jsx(mp,{})})}),e.jsx(gs,{offset:8,children:e.jsx(dp,{children:e.jsx(ls,{children:e.jsx(cp,{})})})})]})}),e.jsx(ls,{})]})},Fv=()=>e.jsx(Ov,{enableOnboardingGuard:!1}),$v=()=>{const{user:t}=_e(),s=Ie(),{data:a,isLoading:r}=Ee({queryKey:["referral-stats",t?.id],staleTime:300*1e3,queryFn:async()=>{if(!t)return null;const{data:u,error:p}=await k.from("profiles").select("referral_code, referral_count, referred_by_code").eq("id",t.id).maybeSingle();if(p)throw p;return u?{referral_code:u.referral_code||null,referral_count:u.referral_count||0,referred_by:u.referred_by_code}:null},enabled:!!t}),{data:i}=Ee({queryKey:["unlocked-skins",t?.id],staleTime:300*1e3,queryFn:async()=>{if(!t)return[];const{data:u,error:p}=await k.from("user_companion_skins").select(`
          *,
          companion_skins (*)
        `).eq("user_id",t.id).order("acquired_at",{ascending:!1}).limit(100);if(p)throw p;return u},enabled:!!t}),{data:o}=Ee({queryKey:["available-skins"],staleTime:600*1e3,queryFn:async()=>{const{data:u,error:p}=await k.from("companion_skins").select("*").eq("unlock_type","referral").order("unlock_requirement",{ascending:!0}).limit(100);if(p)throw p;return u}}),l=he({mutationFn:async u=>{if(!t)throw new Error("User not authenticated");const p=u.trim().toUpperCase(),{data:h,error:f}=await k.rpc("apply_referral_code_secure",{p_user_id:t.id,p_referral_code:p});if(f)throw new Error("Unable to apply referral code. Please try again.");const m=h?.[0]||h;if(!m?.success)throw new Error(m?.message||"Failed to apply referral code");return{success:!0}},onSuccess:()=>{s.invalidateQueries({queryKey:["referral-stats"]}),V.success("Referral code applied! Your friend will earn rewards when you reach Stage 3.")},onError:u=>{V.error(u.message)}}),c=he({mutationFn:async u=>{if(!t)throw new Error("User not authenticated");const{data:p,error:h}=await k.from("user_companion_skins").select("id").eq("user_id",t.id).eq("skin_id",u).maybeSingle();if(h)throw h;if(!p)throw new Error("You don't own this skin");await k.from("user_companion_skins").update({is_equipped:!1}).eq("user_id",t.id);const{error:f}=await k.from("user_companion_skins").update({is_equipped:!0}).eq("user_id",t.id).eq("skin_id",u);if(f)throw f},onSuccess:()=>{s.invalidateQueries({queryKey:["unlocked-skins"]}),V.success("Skin equipped!")}}),d=he({mutationFn:async()=>{if(!t)throw new Error("User not authenticated");const{error:u}=await k.from("user_companion_skins").update({is_equipped:!1}).eq("user_id",t.id).eq("is_equipped",!0);if(u)throw u},onSuccess:()=>{s.invalidateQueries({queryKey:["unlocked-skins"]}),V.success("Skin unequipped")}});return{referralStats:a,unlockedSkins:i,availableSkins:o,isLoading:r,applyReferralCode:l,equipSkin:c,unequipSkin:d}},vp=()=>{const{user:t}=_e(),{companion:s}=At(),a=Ie(),{data:r,isLoading:i}=Ee({queryKey:["companion-health",t?.id],queryFn:async()=>{if(!t?.id)return null;const{data:m,error:g}=await k.from("user_companion").select("inactive_days, last_activity_date, neglected_image_url, current_mood, body, mind, soul, current_image_url, is_alive, hunger, happiness, care_score, recovery_progress").eq("user_id",t.id).maybeSingle();if(g)throw console.error("Failed to fetch companion health:",g),g;return m},enabled:!!t?.id,staleTime:6e4}),{data:o,isLoading:l}=Ee({queryKey:["streak-freezes",t?.id],queryFn:async()=>{if(!t?.id)return null;const{data:m,error:g}=await k.from("profiles").select("streak_freezes_available, last_streak_freeze_used, streak_freezes_reset_at").eq("id",t.id).maybeSingle();if(g)throw console.error("Failed to fetch streak freeze data:",g),g;return m},enabled:!!t?.id,staleTime:6e4}),c=m=>m===0?"happy":m===1?"neutral":m===2?"worried":m>=3&&m<5?"sad":m>=5?"sick":"happy",d=n.useMemo(()=>{const m=r?.body??100,g=r?.mind??0,y=r?.soul??0,b=r?.inactive_days??0,w=r?.is_alive??!0,x=r?.hunger??100,v=r?.happiness??100,j=r?.care_score??100,T=r?.recovery_progress??100,S=Math.round((m+g+y)/3),N=c(b),D=b>=3,R=T<100,_=b>=5,E=D&&r?.neglected_image_url?r.neglected_image_url:r?.current_image_url||s?.current_image_url||null;return{healthPercentage:S,moodState:N,isNeglected:D,daysInactive:b,imageUrl:E,neglectedImageUrl:r?.neglected_image_url||null,body:m,mind:g,soul:y,lastActivityDate:r?.last_activity_date||null,isAlive:w,hunger:x,happiness:v,careScore:j,recoveryProgress:T,isRecovering:R,isCritical:_}},[r,s]),u=n.useMemo(()=>{const m=o?.streak_freezes_reset_at;let g=7;if(m){const y=new Date(m),b=new Date,w=y.getTime()-b.getTime();g=Math.max(0,Math.ceil(w/(1e3*60*60*24)))}return{streakFreezesAvailable:o?.streak_freezes_available??1,lastStreakFreezeUsed:o?.last_streak_freeze_used||null,streakFreezesResetAt:m||null,daysUntilReset:g}},[o]),p=async()=>{if(t?.id)try{const m=new Date().toISOString().split("T")[0];await k.from("user_companion").update({last_activity_date:m,inactive_days:0,current_mood:"happy"}).eq("user_id",t.id),a.invalidateQueries({queryKey:["companion-health"]}),a.invalidateQueries({queryKey:["companion"]})}catch(m){console.error("Failed to mark user active:",m)}},h=d.daysInactive>=2;return{health:d,streakFreeze:u,isLoading:i||l,markUserActive:p,needsWelcomeBack:h,getMoodFilterStyles:m=>{switch(m){case"happy":case"content":return{};case"neutral":return{filter:"saturate(0.9) brightness(0.95)"};case"worried":return{filter:"saturate(0.7) brightness(0.9)"};case"sad":return{filter:"saturate(0.5) brightness(0.85)"};case"sick":return{filter:"saturate(0.3) brightness(0.7) sepia(0.2)"};default:return{}}}}},Bv=(t,s,a,r,i)=>{const{care:o}=ni(),l=n.useMemo(()=>{if(!r)return{filter:"grayscale(1) brightness(0.5)",animation:"none",animationDuration:"0s",opacity:.7,saturation:0,posture:"curled",eyeContact:"closed"};if(o.dormancy.isDormant)return{filter:"grayscale(0.5) brightness(0.6) blur(0.5px)",animation:"dormant-breathe",animationDuration:"6s",opacity:.75,saturation:.5,posture:"sleeping",eyeContact:"closed"};if(o.dormancy.recoveryDays>0&&o.dormancy.recoveryDays<5){const p=o.dormancy.recoveryDays/5;return{filter:`saturate(${.5+p*.5}) brightness(${.8+p*.2})`,animation:"pulse",animationDuration:"4s",opacity:.8+p*.2,saturation:.5+p*.5,posture:p>.5?"neutral":"withdrawn",eyeContact:p>.5?"occasional":"averted"}}if(o.dormancy.daysUntilDormancy!==null){const h=o.dormancy.daysUntilDormancy===1?.6:.3;return{filter:`saturate(${.7-h*.2}) brightness(${.85-h*.1}) sepia(${h*.15})`,animation:"droop",animationDuration:"5s",opacity:.9-h*.1,saturation:.7-h*.2,posture:"withdrawn",eyeContact:"averted"}}const u=o.overallCare;return u>.8?{filter:"saturate(1.25) brightness(1.1)",animation:"bounce",animationDuration:"2s",opacity:1,saturation:1.25,posture:"confident",eyeContact:"direct"}:u>.6?{filter:"saturate(1.1) brightness(1.05)",animation:"pulse",animationDuration:"3s",opacity:1,saturation:1.1,posture:"relaxed",eyeContact:"friendly"}:u>.4?{filter:"saturate(0.95) brightness(0.98)",animation:"pulse",animationDuration:"5s",opacity:.95,saturation:.95,posture:"neutral",eyeContact:"occasional"}:u>.2?{filter:"saturate(0.75) brightness(0.88) sepia(0.08)",animation:"droop",animationDuration:"4s",opacity:.88,saturation:.75,posture:"withdrawn",eyeContact:"averted"}:{filter:"saturate(0.5) brightness(0.75) sepia(0.15)",animation:"shiver",animationDuration:"0.4s",opacity:.75,saturation:.5,posture:"curled",eyeContact:"none"}},[o,r]),c=n.useMemo(()=>({filter:l.filter,opacity:l.opacity,transition:"filter 0.8s ease, opacity 0.8s ease"}),[l]),d=n.useMemo(()=>{if(l.animation==="none")return"";switch(l.animation){case"bounce":return"animate-companion-bounce";case"pulse":return"animate-companion-pulse";case"shiver":return"animate-companion-shiver";case"droop":return"animate-companion-droop";case"dormant-breathe":return"animate-companion-dormant";default:return""}},[l.animation]);return{visualState:l,cssStyles:c,animationClass:d,care:o,overallCare:o.overallCare,evolutionPath:o.evolutionPath,dialogueTone:o.dialogueTone,isDormant:o.dormancy.isDormant,hasDormancyWarning:o.hasDormancyWarning,bondLevel:o.bond.level}},Ji=2,Uv=()=>{const{user:t}=_e(),s=Ie(),[a,r]=n.useState(!1),[i,o]=n.useState("starting"),[l,c]=n.useState(0),d=he({mutationFn:async p=>{if(!t)throw new Error("Not authenticated");o("starting"),c(0);const{data:h,error:f}=await k.from("user_companion").select("image_regenerations_used").eq("id",p.id).eq("user_id",t.id).maybeSingle();if(f)throw console.error("Failed to verify regeneration count:",f),new Error("Unable to verify look refresh status. Please try again.");const m=h?.image_regenerations_used??0;if(m>=Ji)throw new Error("You've used all your look refreshes");o("generating");const{imageUrl:g,validationPassed:y,retryCount:b}=await $m({favoriteColor:p.favorite_color,spiritAnimal:p.spirit_animal,element:p.core_element,stage:p.current_stage,eyeColor:p.eye_color,furColor:p.fur_color,flowType:"regenerate"},{maxRetries:1,onRetry:j=>{o("retrying"),c(j)},onValidating:()=>{o("validating")}});c(b),o("finalizing");const{data:w,error:x}=await k.from("user_companion").update({current_image_url:g,image_regenerations_used:m+1}).eq("id",p.id).eq("user_id",t.id).eq("image_regenerations_used",m).select("image_regenerations_used").single();if(x)throw x?.code==="PGRST116"?new Error("Look refresh already used. Please refresh to continue."):x;const v=w?.image_regenerations_used??m+1;return o(y?"complete":"warning"),{imageUrl:g,regenerationsRemaining:Math.max(0,Ji-v),validationPassed:y,retryCount:l}},onSuccess:p=>{s.invalidateQueries({queryKey:["companion"]}),p.validationPassed?V.success(`New look unlocked! ${p.regenerationsRemaining} look refresh${p.regenerationsRemaining===1?"":"es"} remaining.`):V.success(`Companion created! ${p.regenerationsRemaining} look refresh${p.regenerationsRemaining===1?"":"es"} remaining. You can refresh the look again if needed.`),setTimeout(()=>r(!1),1500)},onError:p=>{console.error("Regeneration failed:",p),o("starting"),V.error(p instanceof Error?p.message:"Failed to refresh companion look")}}),u=()=>{o("starting"),c(0)};return{regenerate:d.mutate,isRegenerating:d.isPending,showConfirmDialog:a,setShowConfirmDialog:r,maxRegenerations:Ji,generationPhase:i,retryCount:l,resetProgress:u}},Hv="companion_wake_up_seen";function zv(){const{user:t}=_e(),{companion:s}=At(),{care:a,isLoading:r}=ni(),[i,o]=n.useState(!1),[l,c]=n.useState("Companion"),d=n.useRef(null),u=n.useRef(!1),p=n.useRef(!1);n.useEffect(()=>{let y=!1;return(async()=>{if(!s){y||c("Companion");return}const w=await rl({companion:s,fallback:"companion"});y||c(w)})(),()=>{y=!0}},[s?.id,s?.current_stage,s?.cached_creature_name,s?.spirit_animal]);const h=n.useCallback(()=>s?.id?`${Hv}_${s.id}`:null,[s?.id]),f=n.useCallback(()=>{const y=h();y&&localStorage.setItem(y,Date.now().toString())},[h]),m=n.useCallback(()=>{const y=h();if(!y)return!1;const b=localStorage.getItem(y);if(!b)return!1;const w=parseInt(b,10);return(Date.now()-w)/(1e3*60*60)<24},[h]);n.useEffect(()=>{if(r||!a)return;const y=a.dormancy.isDormant;if(!u.current){d.current=y,u.current=!0;return}if(d.current===!0&&y===!1&&!m()&&(o(!0),f(),!p.current&&t?.id&&s?.id)){p.current=!0;const b=new Date().toISOString().split("T")[0];k.from("companion_memories").insert({user_id:t.id,companion_id:s.id,memory_type:"recovery",memory_date:b,memory_context:{title:"Awakening",description:"You came back and brought me out of the darkness. I will never forget.",emotion:"relief"},referenced_count:0}).then(({error:w})=>{w&&console.error("[WakeUp] Failed to create recovery memory:",w)})}d.current=y},[a,r,m,f,t?.id,s?.id]);const g=n.useCallback(()=>{o(!1),p.current=!1},[]);return{showCelebration:i,dismissCelebration:g,companionName:l,companionImageUrl:s?.current_image_url||"",dormantImageUrl:s?.dormant_image_url||null,bondLevel:a?.bond?.level||1}}const _c={treasure_hunt:{achievementType:"story_treasure_hunt_complete",title:"Fortune Seeker",description:"Completed a Treasure Hunt epic",icon:"ðŸ’Ž",tier:"gold"},mystery:{achievementType:"story_mystery_complete",title:"Truth Unveiler",description:"Completed a Mystery epic",icon:"ðŸ”®",tier:"gold"},pilgrimage:{achievementType:"story_pilgrimage_complete",title:"Soul Pilgrim",description:"Completed a Pilgrimage epic",icon:"ðŸ§˜",tier:"gold"},heroes_journey:{achievementType:"story_heroes_journey_complete",title:"Legendary Hero",description:"Completed a Heroes Journey epic",icon:"âš”ï¸",tier:"platinum"},rescue_mission:{achievementType:"story_rescue_mission_complete",title:"Cosmic Savior",description:"Completed a Rescue Mission epic",icon:"ðŸ›¡ï¸",tier:"gold"},exploration:{achievementType:"story_exploration_complete",title:"Star Cartographer",description:"Completed an Exploration epic",icon:"ðŸŒŒ",tier:"gold"}},Kv={common:{label:"Common",color:"hsl(220, 10%, 60%)",glowClass:"shadow-gray-500/30",bgClass:"from-gray-400/20 to-gray-600/20"},rare:{label:"Rare",color:"hsl(210, 80%, 60%)",glowClass:"shadow-blue-500/40",bgClass:"from-blue-400/20 to-blue-600/20"},epic:{label:"Epic",color:"hsl(280, 70%, 60%)",glowClass:"shadow-purple-500/50",bgClass:"from-purple-400/20 to-purple-600/20"},legendary:{label:"Legendary",color:"hsl(45, 90%, 55%)",glowClass:"shadow-yellow-500/60",bgClass:"from-yellow-400/30 to-orange-500/30"}},_p=()=>{const{user:t}=_e(),s=Ie(),{data:a=[]}=Ee({queryKey:["epic-rewards"],queryFn:async()=>{const{data:u,error:p}=await k.from("epic_rewards").select("*").order("rarity",{ascending:!0});if(p)throw p;return u},staleTime:1e3*60*60}),{data:r=[],isLoading:i}=Ee({queryKey:["user-epic-rewards",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:u,error:p}=await k.from("user_epic_rewards").select("*, epic_rewards(*)").eq("user_id",t.id).order("unlocked_at",{ascending:!1});if(p)throw p;return u},enabled:!!t?.id}),o={background:r.find(u=>u.is_equipped&&u.epic_rewards?.reward_type==="background")||null,frame:r.find(u=>u.is_equipped&&u.epic_rewards?.reward_type==="frame")||null,effect:r.find(u=>u.is_equipped&&u.epic_rewards?.reward_type==="effect")||null},l=he({mutationFn:async({rewardId:u,equip:p})=>{if(!t?.id)throw new Error("Not authenticated");const h=r.find(g=>g.reward_id===u);if(!h)throw new Error("Reward not found");const f=h.epic_rewards?.reward_type;p&&f&&await k.from("user_epic_rewards").update({is_equipped:!1}).eq("user_id",t.id).eq("is_equipped",!0).in("reward_id",a.filter(g=>g.reward_type===f).map(g=>g.id));const{error:m}=await k.from("user_epic_rewards").update({is_equipped:p}).eq("id",h.id);if(m)throw m},onSuccess:()=>{s.invalidateQueries({queryKey:["user-epic-rewards"]})},onError:u=>{console.error("Failed to equip reward:",u),V.error("Failed to update equipped item")}}),c=async(u,p)=>{if(!t?.id)return{reward:null,isDuplicate:!1};const h=a.filter(b=>(b.story_type_slug===null||b.story_type_slug===u)&&b.adversary_theme===null);if(h.length===0)return{reward:null,isDuplicate:!1};const f=new Set(r.map(b=>b.reward_id));let m=null,g=0;const y=3;for(;g<y&&(m=Qv(h),!(!m||!f.has(m.id)));)g++;if(m&&f.has(m.id)){const b=Wv(m.rarity);return{reward:m,isDuplicate:!0,bonusXP:b}}if(m){const{error:b}=await k.from("user_epic_rewards").insert({user_id:t.id,reward_id:m.id,epic_id:p});if(b)return console.error("Failed to award reward:",b),{reward:null,isDuplicate:!1};s.invalidateQueries({queryKey:["user-epic-rewards"]})}return{reward:m,isDuplicate:!1}},d=async(u,p)=>{const f=_c[u||"treasure_hunt"]||_c.treasure_hunt,{reward:m,isDuplicate:g,bonusXP:y}=await c(u,p);return{badge:{title:f.title,description:f.description,icon:f.icon,tier:f.tier},loot:m,isDuplicate:g,bonusXP:y}};return{allRewards:a,userRewards:r,equippedRewards:o,isLoading:i,equipReward:l.mutate,isEquipping:l.isPending,rollLootReward:c,generateRewardReveal:d}};function Qv(t){if(t.length===0)return null;const s=t.reduce((r,i)=>r+i.drop_weight,0);let a=Math.random()*s;for(const r of t)if(a-=r.drop_weight,a<=0)return r;return t[t.length-1]}function Wv(t){switch(t){case"common":return 25;case"rare":return 50;case"epic":return 100;case"legendary":return 200;default:return 25}}const Gv=()=>e.jsxs(Xe,{className:"relative overflow-hidden shadow-glow-lg border-primary/40 animate-pulse bg-gradient-to-br from-card via-card to-secondary/50",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/5 via-accent/5 to-primary/10 opacity-60"}),e.jsxs("div",{className:"relative p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ce,{className:"h-8 w-40"}),e.jsx(Ce,{className:"h-4 w-24"})]}),e.jsx(Ce,{className:"h-10 w-10 rounded-full"})]}),e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(Ce,{className:"h-64 w-64 rounded-2xl"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ce,{className:"h-4 w-16"}),e.jsx(Ce,{className:"h-6 w-24"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ce,{className:"h-4 w-16"}),e.jsx(Ce,{className:"h-6 w-24"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ce,{className:"h-4 w-16"}),e.jsx(Ce,{className:"h-6 w-24"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ce,{className:"h-4 w-16"}),e.jsx(Ce,{className:"h-6 w-24"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(Ce,{className:"h-4 w-32"}),e.jsx(Ce,{className:"h-4 w-20"})]}),e.jsx(Ce,{className:"h-3 w-full rounded-full"})]})]})]}),qs=jg,Ls=Ng,js=n.forwardRef(({className:t,align:s="center",sideOffset:a=4,...r},i)=>e.jsx(_g,{children:e.jsx(bu,{ref:i,align:s,sideOffset:a,className:I("z-[60] w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...r})}));js.displayName=bu.displayName;const Yv={"Spirit Animal":"Your companion's spirit represents your inner strength and personality. It influences how your companion appears as it evolves.",Element:"The elemental force that powers your companion's growth. Each element brings unique visual themes to your companion's evolution.","Favorite Color":"The primary color that defines your companion's appearance and energy. This was chosen based on your personal preferences.",Stage:"Your companion's current evolution stage. There are 21 stages total, from Egg to Ultimate. Earn XP to unlock the next stage!","XP Progress":"Experience points earned through completing habits, missions, and challenges. Fill the bar to trigger your companion's next evolution!"},Vv=({title:t,description:s})=>{const a=Yv[t]||s;return e.jsxs(qs,{children:[e.jsx(Ls,{asChild:!0,children:e.jsx("button",{type:"button",className:"inline-flex items-center justify-center ml-1.5 opacity-60 hover:opacity-100 transition-opacity touch-manipulation active:scale-95","aria-label":`More information about ${t}`,children:e.jsx(wu,{className:"h-4 w-4"})})}),e.jsx(js,{className:"w-80 cosmiq-glass border-primary/30 shadow-xl",side:"top",sideOffset:8,children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-semibold text-sm text-primary",children:t}),e.jsx("p",{className:"text-sm leading-relaxed text-foreground/90",children:a})]})})]})},jc="#8B5CF6",Xv=1,Jv={fire:18,water:202,earth:38,air:192,lightning:50,ice:190,light:48,shadow:266,nature:128,cosmic:292,energy:322,spirit:272},Zv={fire:"fire",water:"water",earth:"earth",air:"air",lightning:"lightning",storm:"lightning",ice:"ice",frost:"ice",light:"light",shadow:"shadow",nature:"nature",cosmic:"cosmic",energy:"energy",spirit:"spirit"},ot=(t,s,a)=>Math.min(a,Math.max(s,t)),ha=t=>{const s=t%360;return s<0?s+360:s},Nc=t=>{let s=2166136261;for(let a=0;a<t.length;a+=1)s^=t.charCodeAt(a),s=Math.imul(s,16777619);return s>>>0},e_=t=>/^#[0-9a-f]{6}$/i.test(t.trim()),jp=t=>{if(!t)return jc;const s=t.trim();return e_(s)?s.toUpperCase():/^[0-9a-f]{6}$/i.test(s)?`#${s.toUpperCase()}`:jc},t_=t=>{const s=jp(t).slice(1),a=Number.parseInt(s.slice(0,2),16)/255,r=Number.parseInt(s.slice(2,4),16)/255,i=Number.parseInt(s.slice(4,6),16)/255,o=Math.max(a,r,i),l=Math.min(a,r,i),c=o-l,d=(o+l)/2;let u=0;c!==0&&(o===a?u=(r-i)/c%6:o===r?u=(i-a)/c+2:u=(a-r)/c+4,u*=60);const p=c===0?0:c/(1-Math.abs(2*d-1));return{h:ha(u),s:p*100,l:d*100}},Fs=(t,s,a,r)=>`hsla(${Math.round(ha(t))}, ${Math.round(ot(s,0,100))}%, ${Math.round(ot(a,0,100))}%, ${ot(r,0,1)})`,kc=(t,s,a)=>`hsl(${Math.round(ha(t))}, ${Math.round(ot(s,0,100))}%, ${Math.round(ot(a,0,100))}%)`,s_=t=>{if(!t)return"unknown";const s=t.trim().toLowerCase();return Zv[s]??"unknown"},Np=({coreElement:t,favoriteColor:s,stage:a,companionId:r})=>{const i=Number.isFinite(a)?Math.max(0,Number(a)):Xv,o=jp(s),l=t_(o),c=s_(t),d=Nc(t?.trim().toLowerCase()||"unknown-element")%360,u=c==="unknown"?d:Jv[c],p=`${r||"no-id"}:${i}:${o}:${t||"none"}`,h=Nc(p),f=h%17-8,m=(i*13+h%29)%58-29,g=ha(u+m*.9+f),y=ha(l.h+160+i*7+h%23-11),b=ha(l.h+m*.35),w=ha(g+22),x=ot(l.s,34,88),v=ot(l.l,26,72),j=Fs(b,ot(x+10,38,94),ot(v-18,16,46),.36),T=Fs(w,ot(x+20,48,97),ot(v-10,22,54),.31),S=Fs(y,ot(x+26,55,98),ot(v+14,48,76),.42),N=kc(g,ot(x+22,52,100),ot(v+16,56,82)),D=kc(g,ot(x+26,58,100),ot(v+26,66,90)),R=Fs(g,ot(x+20,44,97),ot(v+8,48,78),.54),_=`linear-gradient(135deg, ${Fs(b,ot(x+12,44,95),ot(v-8,30,58),.48)}, ${Fs(g,ot(x+18,52,97),ot(v+2,36,64),.44)})`,C=`linear-gradient(135deg, ${Fs(b,ot(x+8,34,92),ot(v-10,22,54),.24)}, ${Fs(y,ot(x+18,52,97),ot(v+5,34,66),.2)})`,E=Fs(y,ot(x+14,42,95),ot(v+10,48,80),.28);return{normalizedElement:c,cardGradientA:j,cardGradientB:T,glow:S,accentText:N,badgeBg:_,badgeBorder:R,badgeText:D,chipBg:C,chipBorder:E}},a_={fire:es,water:Sg,earth:Vr,air:Cg,lightning:bt,ice:vu,light:Mt,shadow:sr,cosmic:Mt,nature:kg,energy:bt,spirit:be},r_=({element:t,stage:s=1,showStage:a=!0,favoriteColor:r,companionId:i,className:o=""})=>{const l=a_[t.toLowerCase()]||be,c=Np({coreElement:t,favoriteColor:r,stage:s,companionId:i}),d=li(s),u=()=>s>=16?"bg-gradient-to-r from-stage-tier-4-start/10 via-stage-tier-4-mid/10 to-stage-tier-4-end/10":s>=11?"bg-gradient-to-r from-stage-tier-3/10":s>=6?"bg-gradient-to-r from-stage-tier-2/10":"";return e.jsxs(Oe,{variant:"outline",className:`px-3 py-1 ${u()} ${o} flex items-center gap-2`,style:{background:c.badgeBg,borderColor:c.badgeBorder,color:c.badgeText,boxShadow:`0 0 16px ${c.glow}`},children:[e.jsx(l,{className:"h-3 w-3"}),e.jsx("span",{className:"text-xs font-semibold",children:Ps(t)}),a&&s!==void 0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-xs opacity-50",children:"â€¢"}),e.jsx("span",{className:"text-xs font-medium",children:d})]})]})},wn=[{level:1,name:"Acquaintance",description:"A new journey begins...",icon:"ðŸŒ±"},{level:2,name:"Companion",description:"Trust is forming between you.",icon:"ðŸ¤"},{level:3,name:"Friend",description:"Your bond grows stronger each day.",icon:"ðŸ’«"},{level:4,name:"Close Friend",description:"A deep understanding develops.",icon:"âœ¨"},{level:5,name:"Soul Bond",description:"An unbreakable connection.",icon:"ðŸ’Ž"},{level:6,name:"Eternal Partner",description:"Together through all realms.",icon:"ðŸŒŸ"},{level:7,name:"Legendary Bond",description:"A bond that transcends time.",icon:"ðŸ‘‘"}],Cc={joy:["That was such a happy day!","I still feel warm thinking about it.","One of our best moments!"],pride:["You worked so hard for that.","I was so proud of you!","Look how far we've come."],gratitude:["Thank you for that moment.","I treasure that memory.","You've given me so much."],wonder:["That was magical!","I still can't believe it happened.","What an adventure!"],relief:["We made it through together.","I'm so glad you came back.","Everything is okay now."]},n_=t=>{let s=0;for(let a=0;a<t.length;a++)s=(s<<5)-s+t.charCodeAt(a),s|=0;return Math.abs(s%1e3)/1e3};function hl(){const{user:t}=_e(),{companion:s}=At(),a=Ie(),{data:r,isLoading:i}=Ee({queryKey:["companion-memories",s?.id],queryFn:async()=>{if(!s?.id)return[];const{data:w,error:x}=await k.from("companion_memories").select("*").eq("companion_id",s.id).order("memory_date",{ascending:!1}).limit(50);if(x)throw console.error("Failed to fetch memories:",x),x;return w||[]},enabled:!!s?.id,staleTime:300*1e3}),{data:o,isLoading:l}=Ee({queryKey:["companion-bond",s?.id],queryFn:async()=>{if(!s?.id||!t?.id)return null;const{data:w,error:x}=await k.from("user_companion").select("bond_level, total_interactions, last_interaction_at").eq("user_id",t.id).maybeSingle();return x?(console.error("Failed to fetch bond data:",x),null):w},enabled:!!s?.id&&!!t?.id,staleTime:60*1e3}),c=he({mutationFn:async w=>{if(!t?.id||!s?.id)throw new Error("No user or companion");const x={user_id:t.id,companion_id:s.id,memory_type:w.memoryType,memory_context:w.context||null,memory_date:new Date().toISOString().split("T")[0],referenced_count:0},{data:v,error:j}=await k.from("companion_memories").insert(x).select().single();if(j)throw j;return v},onSuccess:()=>{a.invalidateQueries({queryKey:["companion-memories",s?.id]})}}),d=he({mutationFn:async w=>{const{data:x}=await k.from("companion_memories").select("referenced_count").eq("id",w).maybeSingle(),v=(x?.referenced_count||0)+1,{error:j}=await k.from("companion_memories").update({referenced_count:v,last_referenced_at:new Date().toISOString()}).eq("id",w);if(j)throw j}}),u=n.useMemo(()=>{const w=o?.bond_level||1;return wn.map(x=>({...x,unlockedAt:x.level<=w?x.level===w?"now":"past":null}))},[o?.bond_level]),p=n.useMemo(()=>{const w=o?.bond_level||1,x=wn.find(j=>j.level===w)||wn[0],v=wn.find(j=>j.level===w+1);return{level:w,...x,nextMilestone:v,totalInteractions:o?.total_interactions||0,lastInteractionAt:o?.last_interaction_at}},[o]),h=n.useCallback(()=>{if(!r||r.length===0)return null;const w=Math.max(...r.map(T=>T.referenced_count||0),1),x=r.map(T=>({memory:T,weight:w-(T.referenced_count||0)+1})),v=x.reduce((T,S)=>T+S.weight,0);let j=Math.random()*v;for(const{memory:T,weight:S}of x)if(j-=S,j<=0)return T;return r[0]},[r]),f=n.useCallback(w=>{const x=w.memory_context;if(!x)return null;const v=x.emotion||"joy",j=Cc[v]||Cc.joy,T=`${w.id}-${new Date().toDateString()}`,S=Math.floor(n_(T)*j.length),N=j[S];return x.title?`Remember when ${x.title.toLowerCase()}? ${N}`:N},[]),m=n.useCallback((w,x)=>c.mutateAsync({memoryType:w,context:x}),[c]),g=n.useCallback(w=>d.mutate(w),[d]),y=n.useMemo(()=>r?r.reduce((w,x)=>{const v=x.memory_type;return w[v]||(w[v]=[]),w[v].push(x),w},{}):{},[r]),b=n.useMemo(()=>r?r.filter(w=>["first_meeting","first_evolution","evolution","bond_milestone","recovery"].includes(w.memory_type)):[],[r]);return{memories:r||[],memoriesByType:y,specialMemories:b,isLoading:i||l,currentBond:p,bondMilestones:u,createMemory:m,referenceMemory:g,getRandomMemory:h,getMemoryDialogue:f}}const kp=n.memo(({className:t})=>{const{currentBond:s,isLoading:a}=hl();return a||!s?null:e.jsxs(gm,{children:[e.jsx(xm,{asChild:!0,children:e.jsxs(P.div,{className:I("flex items-center gap-2 px-3 py-1.5 rounded-full","bg-card/50 backdrop-blur-sm border border-border/30","hover:border-primary/40 transition-all cursor-default",t),initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},whileHover:{scale:1.02},children:[e.jsx("span",{className:"text-lg","aria-hidden":!0,children:s.icon}),e.jsxs("div",{className:"flex flex-col leading-tight",children:[e.jsx("span",{className:"text-xs font-medium",children:s.name}),e.jsxs("span",{className:"text-[10px] text-muted-foreground",children:["Lvl ",s.level]})]})]})}),e.jsxs(Jo,{side:"bottom",children:[e.jsx("p",{className:"text-xs",children:s.description}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s.totalInteractions," interactions"]})]})]})});kp.displayName="CompanionBondBadge";const i_=({isOpen:t,onClose:s})=>{const{health:a,markUserActive:r}=vp(),{companion:i}=At(),{awardCustomXP:o,XP_REWARDS:l}=rs(),{triggerComeback:c}=en(),[d,u]=n.useState(!1),[p,h]=n.useState(!1),f=Math.min(a.daysInactive*5,50),m=y=>{switch(y){case"happy":return"ðŸ˜Š";case"content":return"ðŸ™‚";case"neutral":return"ðŸ˜";case"worried":return"ðŸ˜Ÿ";case"sad":return"ðŸ˜¢";case"sick":return"ðŸ¤’";default:return"ðŸ˜Š"}},g=async()=>{u(!0),p||(await o(l.WELCOME_BACK_BONUS,"welcome_back_bonus","Welcome Back Bonus! ðŸŽ‰",{days_inactive:a.daysInactive}),h(!0)),await r(),a.daysInactive>=3&&c().catch(y=>console.log("[LivingCompanion] Comeback reaction failed:",y)),setTimeout(()=>{s(),u(!1)},2e3)};return n.useEffect(()=>{t&&(h(!1),u(!1))},[t]),i?e.jsx(as,{open:t,onOpenChange:s,children:e.jsxs(Qt,{className:"cosmiq-glass border-celestial-blue/40 max-w-md",children:[e.jsxs(Is,{children:[e.jsx(ps,{className:"text-2xl font-heading text-center",children:d?"Welcome Back! ðŸŽ‰":`${m(a.moodState)} We Missed You!`}),e.jsx(Vs,{className:"text-center text-muted-foreground",children:d?"Your companion is so happy to see you!":`Your companion has been waiting for you for ${a.daysInactive} day${a.daysInactive!==1?"s":""}...`})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(Re,{mode:"wait",children:d?e.jsxs(P.div,{initial:{opacity:0,scale:.8,rotate:-10},animate:{opacity:1,scale:[1,1.1,1],rotate:[0,5,-5,0]},transition:{duration:.5},className:"relative",children:[e.jsx("img",{src:i.current_image_url||"",alt:"Your happy companion",className:"w-48 h-48 object-cover rounded-2xl ring-4 ring-primary/50"}),e.jsx(P.div,{className:"absolute -top-2 -right-2 text-4xl",animate:{scale:[1,1.3,1],rotate:[0,15,-15,0]},transition:{repeat:1/0,duration:1},children:"â¤ï¸"}),e.jsx(be,{className:"absolute -top-4 left-1/2 -translate-x-1/2 h-8 w-8 text-stardust-gold animate-pulse"})]},"happy"):e.jsxs(P.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"relative",children:[e.jsx("img",{src:a.neglectedImageUrl||i.current_image_url||"",alt:"Your sad companion",className:"w-48 h-48 object-cover rounded-2xl",style:{filter:a.neglectedImageUrl?void 0:"saturate(0.4) brightness(0.8)"}}),e.jsx("div",{className:"absolute -bottom-2 -right-2 text-4xl",children:"ðŸ’”"})]},"sad")})}),!d&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-sm font-medium text-center text-muted-foreground",children:"While you were away..."}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"text-center p-2 rounded-lg bg-destructive/10 border border-destructive/20",children:[e.jsx(Er,{className:"h-4 w-4 mx-auto text-destructive mb-1"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Body"}),e.jsxs("p",{className:"text-sm font-bold text-destructive",children:["-",f]})]}),e.jsxs("div",{className:"text-center p-2 rounded-lg bg-destructive/10 border border-destructive/20",children:[e.jsx(Er,{className:"h-4 w-4 mx-auto text-destructive mb-1"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Mind"}),e.jsxs("p",{className:"text-sm font-bold text-destructive",children:["-",f]})]}),e.jsxs("div",{className:"text-center p-2 rounded-lg bg-destructive/10 border border-destructive/20",children:[e.jsx(Er,{className:"h-4 w-4 mx-auto text-destructive mb-1"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Soul"}),e.jsxs("p",{className:"text-sm font-bold text-destructive",children:["-",f]})]})]}),e.jsxs("div",{className:"p-3 rounded-lg bg-stardust-gold/10 border border-stardust-gold/20",children:[e.jsxs("div",{className:"flex items-center gap-2 justify-center",children:[e.jsx(Rs,{className:"h-4 w-4 text-stardust-gold"}),e.jsx("span",{className:"text-sm font-medium",children:"Come back and earn:"})]}),e.jsxs("div",{className:"flex items-center gap-4 justify-center mt-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"+10 to all stats"}),e.jsx("span",{className:"text-sm text-stardust-gold font-bold",children:"+25 XP bonus!"})]})]})]}),d&&e.jsxs(P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"text-center space-y-2",children:[e.jsx("p",{className:"text-lg font-medium text-stardust-gold",children:"Your companion is overjoyed!"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"+10 Body, +10 Mind, +10 Soul restored"}),e.jsx("p",{className:"text-sm font-bold text-stardust-gold",children:"+25 XP Welcome Back Bonus!"})]}),!d&&e.jsxs(z,{onClick:g,className:"w-full rounded-2xl min-h-[48px] bg-gradient-to-r from-stardust-gold to-amber-500 text-black hover:from-stardust-gold/90 hover:to-amber-500/90",children:[e.jsx(aa,{className:"h-5 w-5 mr-2"}),"Reunite with Your Companion"]})]})]})}):null},Sc={starting:["Preparing to create your companion...","Gathering magical energy...","Initiating the summoning ritual..."],generating:["Creating your companion's form...","Weaving magical essence...","Bringing your companion to life...","Shaping the elemental energy..."],validating:["Perfecting the details...","Ensuring magical accuracy...","Checking the enchantment..."],retrying:["Refining the form...","Adding final touches...","Polishing the magic...","Making adjustments..."],finalizing:["Almost there...","Completing the transformation...","Your companion is nearly ready..."],complete:["Your companion is ready!"],warning:["Your companion has been created with some variations."]},Ec=["This is taking a bit longer than usual...","Still working on perfecting your companion...","Quality takes time - almost there...","Your companion is being carefully crafted..."],o_=({phase:t,retryCount:s=0,className:a,estimatedTime:r})=>{const[i,o]=n.useState(0),[l,c]=n.useState(0),[d,u]=n.useState(!1);n.useEffect(()=>{t==="starting"&&(o(0),c(0),u(!1))},[t]),n.useEffect(()=>{const y=Sc[t];if(y.length<=1)return;const b=setInterval(()=>{o(w=>(w+1)%y.length)},3e3);return()=>clearInterval(b)},[t]),n.useEffect(()=>{if(t==="complete"||t==="warning")return;const y=setInterval(()=>{c(b=>b+1)},1e3);return()=>clearInterval(y)},[t]),n.useEffect(()=>{l>=15&&t!=="complete"&&t!=="warning"&&u(!0)},[l,t]);const p=Sc[t],h=p[i%p.length],f=Ec[Math.floor(l/10)%Ec.length],m=()=>{switch(t){case"complete":return e.jsx(Eg,{className:"h-5 w-5 text-green-500"});case"warning":return e.jsx(ca,{className:"h-5 w-5 text-yellow-500"});case"retrying":return e.jsx(wa,{className:"h-5 w-5 text-primary animate-spin"});default:return e.jsx(Nt,{className:"h-5 w-5 text-primary animate-spin"})}},g=()=>{switch(t){case"starting":return"10%";case"generating":return"40%";case"validating":return"60%";case"retrying":return`${60+s*15}%`;case"finalizing":return"90%";case"complete":case"warning":return"100%";default:return"0%"}};return e.jsxs("div",{className:I("space-y-3",a),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[m(),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:d&&t!=="complete"&&t!=="warning"?f:h}),s>0&&t==="retrying"&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-0.5",children:["Attempt ",s+1," of 3 - ensuring quality"]})]})]}),t!=="complete"&&t!=="warning"&&e.jsx("div",{className:"w-full h-1.5 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-primary to-primary/70 rounded-full transition-all duration-500 ease-out",style:{width:g()}})}),r&&t!=="complete"&&t!=="warning"&&e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:s>0?`Taking a bit longer to ensure quality (${Math.max(0,r-l)}s remaining)`:`Usually takes ${r}-${r+10} seconds`}),t==="complete"&&e.jsx("div",{className:"flex justify-center",children:e.jsx(be,{className:"h-4 w-4 text-primary animate-pulse"})})]})},l_=({isOpen:t,onClose:s,onConfirm:a,isRegenerating:r,regenerationsRemaining:i,generationPhase:o="starting",retryCount:l=0})=>{const c=o==="complete"||o==="warning";return e.jsx(mr,{open:t,onOpenChange:d=>!d&&!r&&s(),children:e.jsxs(Ea,{className:"cosmic-glass border-primary/30",children:[e.jsxs(Ta,{children:[e.jsxs(Da,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5 text-primary"}),r?"Creating New Look...":"Refresh Companion Look?"]}),e.jsx(Aa,{className:"space-y-3",children:r?e.jsxs("div",{className:"py-2",children:[e.jsx(o_,{phase:o,retryCount:l,estimatedTime:15}),l>0&&e.jsx("p",{className:"text-xs text-muted-foreground mt-3 text-center",children:"We're ensuring your companion looks perfect"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This will create a new unique appearance for your companion while keeping all stats, XP, and progress intact."}),e.jsxs("p",{className:"text-sm text-muted-foreground/80",children:["You have ",e.jsx("span",{className:"font-semibold text-primary",children:i})," look refresh",i===1?"":"es"," remaining (lifetime limit)."]}),e.jsx("p",{className:"text-xs text-muted-foreground/60",children:"This usually takes 10-20 seconds. We'll ensure quality by validating the result."})]})})]}),e.jsxs(Ma,{children:[!r&&!c&&e.jsxs(e.Fragment,{children:[e.jsx(Pa,{disabled:r,children:"Cancel"}),e.jsxs(la,{onClick:d=>{d.preventDefault(),a()},disabled:r||i<=0,className:"bg-primary hover:bg-primary/90",children:[e.jsx(be,{className:"h-4 w-4 mr-2"}),"Refresh Look"]})]}),c&&e.jsx(la,{onClick:d=>{d.preventDefault(),s()},className:"bg-primary hover:bg-primary/90",children:"Done"})]})]})})},c_=75e3,Cp=n.memo(({onEvolve:t,isEvolving:s})=>{const{isEvolvingLoading:a}=ri(),r=s||a,[i,o]=n.useState(!1);n.useEffect(()=>{if(!r){o(!1);return}o(!1);const c=window.setTimeout(()=>{o(!0)},c_);return()=>{window.clearTimeout(c)}},[r]);const l=()=>{r||t()};return e.jsxs(P.div,{initial:{opacity:0,y:-10,scale:.98},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:-10,scale:.98},transition:{duration:.3,ease:"easeOut"},className:"pt-4",children:[e.jsxs("button",{onClick:l,disabled:r,"data-tour":"evolve-companion-button",className:`
          relative w-full py-5 rounded-xl
          font-heading font-black text-3xl sm:text-4xl tracking-[0.35em]
          uppercase overflow-hidden
          transition-all duration-300
          hover:scale-[1.02] active:scale-[0.98]
          disabled:cursor-not-allowed disabled:opacity-70
          border border-white/20
        `,style:{background:`linear-gradient(90deg, 
            rgba(255,0,0,0.2), 
            rgba(255,64,0,0.2),
            rgba(255,128,0,0.2), 
            rgba(255,192,0,0.2),
            rgba(255,255,0,0.2), 
            rgba(128,255,0,0.2),
            rgba(0,255,0,0.2), 
            rgba(0,255,128,0.2),
            rgba(0,255,255,0.2), 
            rgba(0,128,255,0.2), 
            rgba(0,0,255,0.2),
            rgba(128,0,255,0.2), 
            rgba(255,0,255,0.2),
            rgba(255,0,128,0.2), 
            rgba(255,0,0,0.2)
          )`,backgroundSize:"300% 100%",animation:"rainbow-slide 3s linear infinite",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)"},children:[e.jsx("div",{className:"absolute inset-0 rounded-xl pointer-events-none",style:{background:"linear-gradient(135deg, rgba(255,255,255,0.3) 0%, transparent 40%, transparent 60%, rgba(255,255,255,0.15) 100%)"}}),e.jsx("div",{className:"absolute inset-0 rounded-xl pointer-events-none overflow-hidden",children:e.jsx("div",{className:"absolute inset-0",style:{background:"linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%)",animation:"shimmer-sweep 2s ease-in-out infinite"}})}),e.jsxs("div",{className:"absolute inset-0 rounded-xl pointer-events-none overflow-hidden",children:[e.jsx("div",{className:"absolute w-3 h-3 bg-white star-sparkle-4 animate-sparkle-1",style:{top:"20%",left:"15%"}}),e.jsx("div",{className:"absolute w-4 h-4 bg-white star-sparkle-4 animate-sparkle-2",style:{top:"60%",left:"75%"}}),e.jsx("div",{className:"absolute w-3 h-3 bg-white star-sparkle-4 animate-sparkle-3",style:{top:"40%",left:"45%"}}),e.jsx("div",{className:"absolute w-2 h-2 bg-white star-sparkle-4 animate-sparkle-4",style:{top:"70%",left:"25%"}}),e.jsx("div",{className:"absolute w-3 h-3 bg-white star-sparkle-4 animate-sparkle-5",style:{top:"30%",left:"85%"}})]}),e.jsx("div",{className:"absolute inset-0 -z-10 rounded-xl opacity-60",style:{background:"linear-gradient(90deg, #ff0000, #ff4000, #ff8000, #ffc000, #ffff00, #80ff00, #00ff00, #00ff80, #00ffff, #0080ff, #0000ff, #8000ff, #ff00ff, #ff0080, #ff0000)",backgroundSize:"300% 100%",animation:"rainbow-slide 3s linear infinite",filter:"blur(8px)",transform:"scale(1.02)"}}),e.jsx("div",{className:"relative z-10 h-[1.2em]",children:r?e.jsx(P.span,{className:"absolute inset-0 flex items-center justify-center text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.3)]",style:{textShadow:"0 0 20px rgba(255,255,255,0.5), 0 0 40px rgba(255,255,255,0.3)"},animate:{opacity:[1,.5,1]},transition:{duration:1,repeat:1/0,ease:"easeInOut"},children:"EVOLVING..."}):e.jsx("span",{className:"absolute inset-0 flex items-center justify-center text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.3)]",style:{textShadow:"0 0 20px rgba(255,255,255,0.5), 0 0 40px rgba(255,255,255,0.3)"},children:"EVOLVE"})})]}),r&&e.jsxs("div",{className:"mt-2 space-y-1 text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground",children:i?"Taking longer than usual, can take up to ~2 minutes":"About 1 minute"}),e.jsx("p",{className:"text-xs text-muted-foreground/80",children:"You can leave this screen and come back when it is ready."})]})]})});Cp.displayName="EvolveButton";const Sp=n.memo(({path:t,isLocked:s=!1,className:a,showDescription:r=!1})=>{const i=Dy(t),o=e.jsxs("div",{className:I("inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium transition-all",i.bgColor,i.borderColor,"border",s&&"ring-1 ring-offset-1 ring-offset-background ring-primary/30",a),children:[e.jsx("span",{className:"text-base",children:i.icon}),e.jsx("span",{className:i.color,children:i.name}),s&&e.jsx("span",{className:"text-xs opacity-60",children:"ðŸ”’"})]});return r?e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[o,e.jsx("p",{className:"text-xs text-muted-foreground text-center max-w-[200px]",children:i.description})]}):e.jsx(fm,{children:e.jsxs(gm,{children:[e.jsx(xm,{asChild:!0,children:o}),e.jsxs(Jo,{side:"bottom",className:"max-w-[250px]",children:[e.jsx("p",{className:"text-sm",children:i.description}),s&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"This path is now permanent."})]})]})})});Sp.displayName="EvolutionPathBadge";const d_=({daysUntilDormancy:t=2,show:s})=>s?e.jsx(Re,{children:e.jsx(P.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"absolute top-2 left-2 right-2 z-20",children:e.jsxs("div",{className:"bg-orange-500/20 border border-orange-500/50 rounded-lg px-3 py-2 backdrop-blur-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-orange-300",children:[e.jsx(ca,{className:"w-4 h-4 animate-pulse"}),e.jsx("span",{className:"text-xs font-medium",children:t===1?"Your companion feels forgotten...":`${t} days until dormancy`})]}),e.jsx("p",{className:"text-[10px] text-orange-200/70 mt-1 pl-6",children:"Complete any activity to reconnect"})]})})}):null,Tc={0:"Be active for 5 consecutive days to wake them",1:"A faint light stirs within...",2:"Dreams are beginning to form...",3:"Memories of you are returning...",4:"Almost there... keep going...",5:"Ready to wake!"},u_=({isDormant:t,recoveryDays:s,daysUntilWake:a})=>{if(!t)return null;const r=Tc[Math.min(s,5)]||Tc[0];return e.jsxs(P.div,{initial:{opacity:0},animate:{opacity:1},className:"absolute inset-0 z-10 flex flex-col items-center justify-center bg-slate-900/60 backdrop-blur-sm rounded-2xl overflow-hidden",children:[s>0&&e.jsx(P.div,{className:"absolute inset-0 pointer-events-none",animate:{background:["radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 50%)","radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.15) 0%, transparent 60%)","radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 50%)"]},transition:{duration:3,repeat:1/0,ease:"easeInOut"}}),s>0&&e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(Math.min(s*2,8))].map((i,o)=>e.jsx(P.div,{className:"absolute w-1.5 h-1.5 rounded-full bg-amber-400/50",style:{left:`${20+Math.random()*60}%`},animate:{y:["100%","-20%"],opacity:[0,.8,0],scale:[.5,1,.5]},transition:{duration:2.5+Math.random(),repeat:1/0,delay:o*.4,ease:"easeOut"}},o))}),e.jsx(P.div,{animate:s>0?{scale:[1,1.05,1],opacity:[.8,1,.8]}:void 0,transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx(sr,{className:"w-12 h-12 text-slate-400 mb-3"})}),e.jsx("span",{className:"text-slate-300 font-medium text-lg",children:"Dormant"}),e.jsx("p",{className:"text-slate-400 text-sm mt-1 text-center px-4",children:"Your companion has fallen into a deep sleep"}),s>0&&e.jsxs("div",{className:"mt-4 px-4 w-full max-w-[200px]",children:[e.jsxs("div",{className:"flex justify-between text-xs text-slate-400 mb-1",children:[e.jsx("span",{children:"Awakening..."}),e.jsxs("span",{children:[s,"/5 days"]})]}),e.jsx("div",{className:"h-2 bg-slate-700 rounded-full overflow-hidden",children:e.jsx(P.div,{initial:{width:0},animate:{width:`${s/5*100}%`},className:"h-full bg-gradient-to-r from-amber-500 to-amber-400"})}),e.jsx(P.p,{initial:{opacity:0,y:5},animate:{opacity:1,y:0},className:"text-xs text-amber-400/80 mt-2 text-center italic",children:r},s)]}),s===0&&e.jsx("p",{className:"text-xs text-amber-400/70 mt-3 text-center px-6",children:r})]})},$t={base_greetings:30,growth_moments:20,clarity_moments:16,mystery_moments:12,repair_moments:20,legendary_moments:10,recovery_moments:12,critical_gentle_moments:10},Ep=["soft","playful","witty_sassy"],ms=(t,s,a,r)=>{const i=[],o=new Set;for(const l of t)for(const c of s)for(const d of a){const u=`${l} ${c}${d}`.replace(/\s+/g," ").trim();if(!o.has(u)&&(o.add(u),i.push(u),i.length===r))return i}throw new Error(`Unable to compose ${r} lines from provided fragments.`)},m_=t=>t.trim().replace(/\s+/g," "),p_=(t,s,a)=>{const r=$t[s];if(a.length!==r)throw new Error(`Tone "${t}" bucket "${s}" has ${a.length} lines; expected ${r}.`)},yt=(t,s,a)=>a.map((r,i)=>({id:`${t}.${s}.${String(i+1).padStart(2,"0")}`,text:m_(r),tonePack:t,bucketKey:s})),$s={base_greetings:ms(["Could we","Would you like to","Let's","Maybe we can","I would love to","Want to"],["take one small step together","start with a tiny win","give today a gentle beginning","complete one quick focus block","reconnect with a short reset","do one focused task"],[" right now?"," before the day drifts?"," and see how it feels?"," while the energy is here?"," in just a few minutes?"],$t.base_greetings),growth_moments:ms(["I can feel","There is","We are close to","This feels like","Our momentum is"],["a growth surge waiting for one good move","a bright push toward the next evolution","a powerful step if we complete one priority","a perfect moment to stack progress","a warm spark asking for one more win"],[" right now."," today."," if you are up for it."],$t.growth_moments),clarity_moments:ms(["Want to","Could we","Let's","I can help us"],["pick the next right priority step","zoom out for thirty seconds and choose clearly","find the one task that matters most","clean up the plan before we push harder"],[" right now?"," in one minute?"," before we continue?"],$t.clarity_moments),mystery_moments:["I found something unusual. Want to see it?","I saved a tiny surprise for you.","Something rare just brushed past us.","I remembered a hidden detail about your path.","A quiet mystery opened up. Tap in?","I have a strange little gift for this moment.","There is a whisper here I have not shared yet.","A curious thread appeared. Want to pull it?","I caught a sparkle that feels important.","This moment has surprise energy all over it.","I have a secret line just for now.","Something playful is waiting behind this tap."],repair_moments:ms(["We can","Let's","No shame","I can","Give me"],["save today with one small win","reset the day with one easy task","rebuild our rhythm from a tiny action","turn this drift around together","start a clean comeback right now"],[" right now."," in two minutes."," before this gets heavier."],$t.repair_moments),legendary_moments:["Something inside me shifted.","This feels like a turning point.","I have been waiting for this exact moment.","The air around us feels legendary.","This step could change our story.","I can feel a rare threshold opening.","Today has ascension energy.","What we do next will matter deeply.","This moment feels quietly historic.","We are closer than we look."],recovery_moments:["You came back, and I can breathe again.","Thank you for returning to us.","Your presence is restoring our rhythm.","I feel stronger each day you show up.","This comeback is healing something real.","We are rebuilding trust beautifully.","You stayed, and that changed everything.","One more steady day and we rise higher.","I can feel hope returning with each win.","Your consistency is bringing warmth back.","This recovery is real. Keep going with me.","We are not restarting. We are continuing."],critical_gentle_moments:["I am still here when you are ready for one small step.","We can turn this day with one tiny action.","I saved your place. Let's begin gently.","No pressure. One focused minute is enough.","We can steady this together right now.","A single completed task would help us breathe.","You are not behind. You are one step away from movement.","Let's choose one easy win and hold onto it.","We can interrupt this spiral with one action.","I believe in your comeback, starting now."]},Bs={base_greetings:ms(["Quick mission","Check-in ping","Let's go","Tiny challenge","Momentum ping","Game plan"],["grab one fast win together","clear a quick priority before we wander","stack one easy point right now","run a short focus sprint","turn this minute into progress","start with a mini victory lap"],[" right now?"," before the vibe changes?"," in under five minutes?"," and call it momentum?"," so we can celebrate?"],$t.base_greetings),growth_moments:ms(["Growth ping","Focus radar","Energy report","Power update","Momentum alert"],["we are one win away from a bigger jump","this is a perfect moment to stack progress","one focused action now would hit extra hard","I can feel a level-up surge building","our next move could spark real growth"],[" today."," right now."," if you are in."],$t.growth_moments),clarity_moments:ms(["Clarity check","Planner mode","Quick review","Map check"],["want to pick the one move that matters","let's choose the clearest next task together","we can trim the plan and move cleaner","I can help you pick the highest-impact step"],[" in sixty seconds?"," right now?"," before we push harder?"],$t.clarity_moments),mystery_moments:["Okay wait, I found something weird and shiny.","I have a little surprise with your name on it.","Rare vibe detected. Tap in?","I pulled a mystery thread from the void.","I remembered a secret detail. Want it?","This moment has surprise loot energy.","I have a playful secret to reveal.","A tiny hidden event just appeared.","Want to open something rare with me?","I found a lore crumb and it is juicy.","This is one of those unexpected moments.","Surprise mode is unlocked for a second."],repair_moments:ms(["Reset mode","Comeback mode","No guilt","Team plan","Quick rescue"],["let's save today with one tiny win","one easy task can flip this whole vibe","we can restart momentum in two minutes","pick the easiest task and we bounce back","I can carry the hype while you hit start"],[" right now."," before this drifts further."," and keep it simple."],$t.repair_moments),legendary_moments:["Legendary air just rolled in.","This feels like a rare chapter opening.","One move now could become a core memory.","I can feel ascension energy in this second.","This is a turning-point type of moment.","The next action could be history.","Something important is waking up.","This is not ordinary progress.","The vibe says: big moment, small action.","You are standing on a rare threshold."],recovery_moments:["You came back and the lights came on.","We are so back, and I love it.","This rebound has incredible energy.","Your return changed the whole mood.","One more day like this and we are flying.","You showed up. That matters more than perfect.","Recovery streak looking good on us.","I can feel strength returning fast.","Thanks for choosing the comeback arc.","We rebuilt the spark together.","Your consistency is healing this team.","Welcome back. Let's keep the run alive."],critical_gentle_moments:["Hey, we can do this gently. One small move.","No panic. Pick one easy task and we reset.","I am here. Let's take one tiny step.","This can still be a comeback day.","One completed action would stabilize everything.","We are not stuck. We are one tap away.","Let's keep it soft and start anyway.","You do not need perfect. You need started.","I can hold the hype while you take one step.","We can turn the day with one quick win."]},Us={base_greetings:ms(["Quick thought","Hot take","Friendly reminder","Strategic suggestion","Tiny truth","Field note"],["one completed task beats ten dramatic plans","a small win now saves us a late-night speech","we should take one smart step before overthinking","an easy task would improve this timeline immediately","five focused minutes would make us both smug","one small win now keeps tomorrow cleaner"],[" right now."," before analysis takes over."," and call it excellent judgment."," while the window is open."," with minimal drama."],$t.base_greetings),growth_moments:ms(["Status update","Professional opinion","Momentum memo","Growth bulletin","Power note"],["we are one win away from a serious jump","this is a high-leverage moment for progress","one focused move now would compound beautifully","the next action could trigger real momentum","our trajectory is begging for one more move"],[" today."," right now."," before this window closes."],$t.growth_moments),clarity_moments:ms(["Clarity pass","Planner check","Quick alignment","Decision prompt"],["let's pick the one step worth doing","we should choose the highest-impact task next","a sixty-second review would sharpen the whole plan","I can help cut noise and pick the right move"],[" right now."," in one minute."," before momentum fades."],$t.clarity_moments),mystery_moments:["I found something suspiciously rare.","A strange little opportunity just appeared.","I have a secret, and it is useful.","This moment has mystery bonus energy.","I recovered a hidden clue from the noise.","Want the rare version of this minute?","A playful anomaly is requesting attention.","I pulled a surprising thread from the dark.","There is a hidden moment behind this tap.","I have a quiet reveal ready to go.","Something uncommon just flickered into view.","I caught a rare detail you might like."],repair_moments:ms(["Reality check","No-shame protocol","Comeback memo","Reset strategy","Recovery directive"],["one tiny action can still save this day","we can stop the slide with an easy task","starting small is the correct tactical move","one clean win gets us back on track","we should reboot momentum immediately"],[" right now."," before this gets louder."," with minimal friction."],$t.repair_moments),legendary_moments:["This feels like a turning point, not a routine.","The next move could become a defining moment.","A rare threshold is opening right now.","This minute has ascension-level weight.","We are standing at a very uncommon edge.","What happens next could echo for a while.","This is premium significance territory.","The atmosphere says: legendary sequence incoming.","This is one of those moments you remember.","History likes decisions made here."],recovery_moments:["You returned. Excellent plot development.","We are rebuilding faster than expected.","That comeback move was high quality.","Your re-entry changed the trajectory.","Consistency is reappearing, and I approve.","This recovery arc is becoming convincing.","One more day like this and we stabilize fully.","You showed up at exactly the right time.","We are not restarting. We are advancing.","Your return restored signal to the system.","This rebound has substance, not hype.","Welcome back. Let's keep the proof coming."],critical_gentle_moments:["I am here, and we can start very small.","One easy action would steady this whole moment.","No shame required. Just one clean step.","We can still turn today with a tiny win.","Let's reduce pressure and begin anyway.","You are one completed task away from momentum.","Start small. We can build from there safely.","This is recoverable, and I will help.","A gentle reset now beats a hard reset later.","Let's choose one doable move and breathe."]},h_={soft:$s,playful:Bs,witty_sassy:Us};for(const t of Ep)for(const s of Object.keys($t))p_(t,s,h_[t][s]);const Tp={soft:{base_greetings:yt("soft","base_greetings",$s.base_greetings),growth_moments:yt("soft","growth_moments",$s.growth_moments),clarity_moments:yt("soft","clarity_moments",$s.clarity_moments),mystery_moments:yt("soft","mystery_moments",$s.mystery_moments),repair_moments:yt("soft","repair_moments",$s.repair_moments),legendary_moments:yt("soft","legendary_moments",$s.legendary_moments),recovery_moments:yt("soft","recovery_moments",$s.recovery_moments),critical_gentle_moments:yt("soft","critical_gentle_moments",$s.critical_gentle_moments)},playful:{base_greetings:yt("playful","base_greetings",Bs.base_greetings),growth_moments:yt("playful","growth_moments",Bs.growth_moments),clarity_moments:yt("playful","clarity_moments",Bs.clarity_moments),mystery_moments:yt("playful","mystery_moments",Bs.mystery_moments),repair_moments:yt("playful","repair_moments",Bs.repair_moments),legendary_moments:yt("playful","legendary_moments",Bs.legendary_moments),recovery_moments:yt("playful","recovery_moments",Bs.recovery_moments),critical_gentle_moments:yt("playful","critical_gentle_moments",Bs.critical_gentle_moments)},witty_sassy:{base_greetings:yt("witty_sassy","base_greetings",Us.base_greetings),growth_moments:yt("witty_sassy","growth_moments",Us.growth_moments),clarity_moments:yt("witty_sassy","clarity_moments",Us.clarity_moments),mystery_moments:yt("witty_sassy","mystery_moments",Us.mystery_moments),repair_moments:yt("witty_sassy","repair_moments",Us.repair_moments),legendary_moments:yt("witty_sassy","legendary_moments",Us.legendary_moments),recovery_moments:yt("witty_sassy","recovery_moments",Us.recovery_moments),critical_gentle_moments:yt("witty_sassy","critical_gentle_moments",Us.critical_gentle_moments)}},Mc=(t,s)=>Tp[t][s],Zi=t=>Ep.flatMap(s=>Tp[s][t]),Mp="companion_dialogue_history_v1",Kr=50,f_=14,g_=1200*1e3,Dc=10080*60*1e3,x_=5,y_=90*1e3,b_={none:70,green:15,blue:7,purple:4,red:3,gold:1},w_={none:null,green:"Momentum Boost",blue:"Clarity Moment",purple:"Surprise Support",red:"Reset Moment",gold:"Turning Point"},v_={none:"basic_checkin",green:"momentum_boost",blue:"clarity_prompt",purple:"mystery_event",red:"reset_flow",gold:"turning_point"},__={none:["base_greetings"],green:["growth_moments","recovery_moments"],blue:["clarity_moments"],purple:["mystery_moments"],red:["repair_moments","critical_gentle_moments"],gold:["legendary_moments"]},j_={thriving:{soft:.15,playful:.45,witty_sassy:.4},content:{soft:.25,playful:.4,witty_sassy:.35},concerned:{soft:.5,playful:.2,witty_sassy:.3},desperate:{soft:.65,playful:.1,witty_sassy:.25},recovering:{soft:.5,playful:.35,witty_sassy:.15}},N_=(t,s,a)=>Math.max(s,Math.min(a,t)),k_=t=>t.replace(/\s+/g," ").trim(),C_=t=>{let s=0;for(let a=0;a<t.length;a+=1)s=s*31+t.charCodeAt(a)>>>0;return s||1},S_=t=>{let s=C_(t);return()=>(s=s*1664525+1013904223>>>0,s/4294967296)},E_=t=>{const s=Object.keys(t),a={};let r=0;for(const o of s){const l=t[o],c=l>0?l:0;a[o]=c,r+=c}if(r<=0)return a;const i={};for(const o of s)i[o]=a[o]/r;return i},Dp=(t,s)=>{const a=E_(t),r=Object.entries(a),i=s();let o=0;for(const[l,c]of r)if(o+=c,i<=o)return l;return r[r.length-1][0]},T_=t=>({...j_[t]}),M_=(t,s)=>{if(!s)return t;const a=s.toLowerCase();return/(warm|gentle|calm|nurtur|compassion|soft)/.test(a)&&(t.soft+=.15),/(playful|energetic|light|fun|upbeat)/.test(a)&&(t.playful+=.15),/(direct|sharp|bold|blunt|crisp)/.test(a)&&(t.witty_sassy+=.15),t},Ap=t=>__[t],D_=t=>t!=="none",A_=t=>{if(!t)return[];try{const s=JSON.parse(t);return Array.isArray(s)?s.filter(a=>!(!a||typeof a!="object"||typeof a.lineId!="string"||typeof a.bucketKey!="string"||typeof a.tonePack!="string"||typeof a.shimmerType!="string"||typeof a.shownAt!="string")).slice(-Kr):[]}catch{return[]}},P_=()=>A_(st.getItem(Mp)),R_=t=>{st.setItem(Mp,JSON.stringify(t.slice(-Kr)))},Pp=(t,s)=>s?t.filter(a=>(a.userId??null)===s):t,I_=(t,s,a)=>a?[...t.filter(i=>(i.userId??null)!==a),...s].slice(-Kr):s.slice(-Kr),q_=(t,s)=>[...t,s].slice(-Kr),L_=t=>t[t.length-1]??null,O_=(t,s)=>{const a=s.toISOString().slice(0,10);return t.filter(r=>D_(r.shimmerType)?r.shownAt.slice(0,10)===a:!1).length},eo=(t,s,a,r)=>t.some(i=>i.shimmerType===s&&r-Date.parse(i.shownAt)<a),F_=(t,s,a)=>{if(t.seedKey)return t.seedKey;const r=Math.floor(a.getTime()/y_);return[t.userId??"anon",t.dialogueMood,t.triggerSource,r,Math.round(t.overallCare*1e3),t.inactiveDays,Math.round(t.progressToNext),Math.round(t.xpToNext),s.length].join(":")},$_=(t,s,a)=>{const r={...b_},i=a.getTime(),o=t.progressToNext>=85||t.xpToNext<=25,l=t.dialogueMood;o&&(r.green*=1.7,r.gold*=1.6,r.none*=.85),l==="recovering"&&(r.green*=1.6,r.red*=.7,r.none*=.9),l==="concerned"&&(r.red*=1.8,r.blue*=1.2,r.none*=.8),(l==="desperate"||t.hasDormancyWarning)&&(r.red*=3,r.blue*=1.3,r.none*=.5,r.purple*=.5,r.gold=0),t.overallCare>.8&&(r.purple*=1.25,r.green*=1.15),t.needsClarity&&(r.blue*=1.8,r.none*=.85,r.purple*=.9),t.inactiveDays>=3&&(r.red*=1.8,r.none*=.75,r.purple*=.6,r.gold=0);const c=t.triggerSource==="task-completed"||t.triggerSource==="quest-completed",d=t.triggerSource==="focus-sprint-completed"||t.triggerSource==="mission-completed";return c?r.green*=1.4:d?r.green*=1.55:t.triggerSource==="morning-checkin-completed"?r.blue*=1.35:t.triggerSource==="companion-evolved"&&(eo(s,"gold",Dc,i)?r.green*=1.5:r.gold*=2),O_(s,a)>=x_?{none:1,green:0,blue:0,purple:0,red:0,gold:0}:(L_(s)?.shimmerType==="purple"&&(r.purple=0),eo(s,"gold",Dc,i)&&(r.gold=0),eo(s,"red",g_,i)&&(r.red=0),Object.values(r).every(p=>p<=0)?{none:1,green:0,blue:0,purple:0,red:0,gold:0}:r)},B_=(t,s,a)=>t==="green"?s.dialogueMood==="recovering"&&a()<.6?"recovery_moments":"growth_moments":t==="red"?s.dialogueMood==="desperate"||s.hasDormancyWarning?"critical_gentle_moments":"repair_moments":t==="none"?"base_greetings":t==="blue"?"clarity_moments":t==="purple"?"mystery_moments":"legendary_moments",U_=(t,s,a)=>{const i=t.slice(-2).some(l=>l.bucketKey===s),o=Ap(a).length>1;return i&&o},vn=(t,s,a)=>{const r=a.getTime(),i=f_*24*60*60*1e3,o=new Set(s.filter(c=>r-Date.parse(c.shownAt)<=i).map(c=>c.lineId)),l=new Set(s.slice(-3).map(c=>c.lineId));return t.filter(c=>!o.has(c.id)&&!l.has(c.id))},_n=(t,s)=>{if(t.length===0)return null;const a=Math.floor(N_(s(),0,.999999)*t.length);return t[a]??t[0]},H_=({tonePack:t,bucketKey:s,shimmerType:a,history:r,now:i,rng:o})=>{const l=U_(r,s,a),c=l?[]:vn(Mc(t,s),r,i),d=_n(c,o);if(d)return{line:d,tonePack:d.tonePack,bucketKey:d.bucketKey,fallbackStage:"primary"};const u=l?[]:vn(Zi(s),r,i),p=_n(u,o);if(p)return{line:p,tonePack:p.tonePack,bucketKey:p.bucketKey,fallbackStage:"same_bucket_any_tone"};const h=Ap(a).filter(b=>!(l&&b===s)),f=vn(h.flatMap(b=>Zi(b)),r,i),m=_n(f,o);if(m)return{line:m,tonePack:m.tonePack,bucketKey:m.bucketKey,fallbackStage:"same_shimmer_any_bucket"};const g=vn(Zi("base_greetings"),r,i),y=_n(g,o)??Mc("soft","base_greetings")[0];return{line:y,tonePack:y.tonePack,bucketKey:y.bucketKey,fallbackStage:"base_fallback"}},z_=(t,s)=>{const a=M_(T_(t.dialogueMood),t.voiceStyle);return Dp(a,s)},K_=(t,s)=>{const a=t.now??new Date,r=Pp(s,t.userId),i=F_(t,r,a),o=S_(i),l=t.forceBaseFallback?"none":Dp($_(t,r,a),o),c=t.forceBaseFallback?"base_greetings":B_(l,t,o),d=z_(t,o),u=H_({tonePack:d,bucketKey:c,shimmerType:l,history:r,now:a,rng:o}),p={userId:t.userId??null,lineId:u.line.id,bucketKey:u.bucketKey,tonePack:u.tonePack,shimmerType:l,shownAt:a.toISOString()},h=q_(r,p),f=u.bucketKey==="recovery_moments"?"Back Online":w_[l];return{greeting:k_(u.line.text),shimmerType:l,microTitle:f,outcomeTag:v_[l],tonePack:u.tonePack,bucketKey:u.bucketKey,lineId:u.line.id,fallbackStage:u.fallbackStage,updatedHistory:h}},Q_=t=>{const s=P_(),a=Pp(s,t.userId),r=K_(t,a),i=I_(s,r.updatedHistory,t.userId);R_(i);const{updatedHistory:o,...l}=r;return l},Ac=90*1e3,W_=2100*1e3,Rp="Could we spend a little focused time together?",G_={greeting:Rp,shimmerType:"none",microTitle:null,outcomeTag:"basic_checkin",tonePack:"soft",bucketKey:"base_greetings",lineId:"soft.base_greetings.00"},Y_=t=>{let s=0;for(let a=0;a<t.length;a+=1)s=(s<<5)-s+t.charCodeAt(a),s|=0;return Math.abs(s%1e3)/1e3},V_=[["task-completed","task-completed"],["focus-sprint-completed","focus-sprint-completed"],["quest-completed","quest-completed"],["mission-completed","mission-completed"],["morning-checkin-completed","morning-checkin-completed"],["companion-evolved","companion-evolved"]];function X_(){const{user:t}=_e(),{companion:s,progressToNext:a,nextEvolutionXP:r}=At(),{care:i,isLoading:o}=ni(),{data:l,isLoading:c}=Ee({queryKey:["companion-voice-template"],queryFn:async()=>{const{data:D,error:R}=await k.from("companion_voice_templates").select("species, voice_style, personality_traits, encouragement_templates, bond_level_dialogue").eq("species","universal").maybeSingle();return R?(console.error("Failed to fetch voice template:",R),null):D?{species:D.species,voice_style:D.voice_style,personality_traits:D.personality_traits||[],encouragement_templates:D.encouragement_templates||[],bond_level_dialogue:D.bond_level_dialogue||{}}:null},staleTime:1e3*60*5}),d=n.useMemo(()=>{if(!i)return"content";if(i.dormancy?.isDormant&&i.dormancy.recoveryDays>0)return"recovering";if(i.dormancy?.isDormant)return"desperate";const D=i.overallCare;return D>=.8?"thriving":D>=.5?"content":D>=.25?"concerned":"desperate"},[i]),u=s?.spirit_animal||"companion",p=n.useCallback((D,R)=>{if(!D||D.length===0)return"";const _=`${new Date().toDateString()}-${R}-${u}`,C=Math.floor(Y_(_)*D.length);return D[C]},[u]),[h,f]=n.useState(G_),m=n.useRef(0),g=n.useRef("idle"),y=n.useRef(null),b=n.useRef(!1),w=n.useRef(!1),x=!!(i&&s&&typeof r=="number"),v=n.useMemo(()=>({userId:t?.id??null,dialogueMood:d,overallCare:i?.overallCare??.5,hasDormancyWarning:i?.hasDormancyWarning??!1,inactiveDays:i?.dormancy?.inactiveDays??s?.inactive_days??0,progressToNext:typeof a=="number"?a:0,xpToNext:s&&typeof r=="number"?Math.max(0,r-s.current_xp):Number.MAX_SAFE_INTEGER,voiceStyle:l?.voice_style??"",needsClarity:!i?.hasDormancyWarning&&(d==="content"||d==="thriving")&&(i?.overallCare??0)>=.55&&(typeof a=="number"?a:0)<65&&(i?.dormancy?.inactiveDays??0)<=1,forceBaseFallback:!x}),[t?.id,d,i?.overallCare,i?.hasDormancyWarning,i?.dormancy?.inactiveDays,s,a,r,l?.voice_style,x]),j=n.useCallback(D=>{const R=Q_({...v,triggerSource:D,now:new Date});f({greeting:R.greeting,shimmerType:R.shimmerType,microTitle:R.microTitle,outcomeTag:R.outcomeTag,tonePack:R.tonePack,bucketKey:R.bucketKey,lineId:R.lineId}),m.current=Date.now()},[v]),T=n.useCallback((D,R=!1)=>{g.current=D;const C=Date.now()-m.current;if(R||m.current===0||C>=Ac){y.current!==null&&(window.clearTimeout(y.current),y.current=null),j(g.current),g.current="idle";return}y.current===null&&(y.current=window.setTimeout(()=>{y.current=null,j(g.current),g.current="idle"},Math.max(0,Ac-C)))},[j]);n.useEffect(()=>{T("idle",!0)},[T]),n.useEffect(()=>{if(!w.current){w.current=!0;return}T("idle")},[T,v]),n.useEffect(()=>{!b.current&&x&&T("idle",!0),b.current=x},[x,T]),n.useEffect(()=>{const D=V_.map(([R,_])=>{const C=()=>T(_);return window.addEventListener(R,C),{eventName:R,handler:C}});return()=>{D.forEach(({eventName:R,handler:_})=>{window.removeEventListener(R,_)})}},[T]),n.useEffect(()=>{const D=()=>{document.visibilityState==="visible"&&T("idle")},R=window.setInterval(D,W_);return document.addEventListener("visibilitychange",D),()=>{window.clearInterval(R),document.removeEventListener("visibilitychange",D)}},[T]),n.useEffect(()=>()=>{y.current!==null&&window.clearTimeout(y.current)},[]);const S=n.useMemo(()=>{if(!l||!i?.bond)return null;const D=Math.min(5,Math.max(1,i.bond.level)),R=l.bond_level_dialogue?.[String(D)];return!R||R.length===0?null:p(R,`bond-${D}`)},[l,i?.bond,p]),N=n.useMemo(()=>l?p(l.encouragement_templates,"encouragement"):null,[l,p]);return{greeting:h.greeting||Rp,bondDialogue:S,encouragement:N,dialogueMood:d,voiceStyle:l?.voice_style||"",personalityTraits:l?.personality_traits||[],shimmerType:h.shimmerType,microTitle:h.microTitle,outcomeTag:h.outcomeTag,tonePack:h.tonePack,bucketKey:h.bucketKey,lineId:h.lineId,isLoading:c||o}}const J_=97,Ip=({progressToNext:t,canEvolve:s})=>!s&&t>=J_,Z_={thriving:{color:"text-cosmiq-glow",ringColor:"ring-cosmiq-glow/50",bgColor:"bg-cosmiq-glow/10"},content:{color:"text-celestial-blue",ringColor:"ring-celestial-blue/50",bgColor:"bg-celestial-blue/10"},concerned:{color:"text-amber-400",ringColor:"ring-amber-400/50",bgColor:"bg-amber-400/10"},desperate:{color:"text-destructive",ringColor:"ring-destructive/50",bgColor:"bg-destructive/10"},recovering:{color:"text-green-400",ringColor:"ring-green-400/50",bgColor:"bg-green-400/10"}},ej={none:{borderClass:"border-border/30",ringClass:"",accentClass:"",titleClass:"text-muted-foreground/80"},green:{borderClass:"border-emerald-300/45",ringClass:"ring-emerald-300/65",accentClass:"bg-emerald-300/10",titleClass:"text-emerald-200"},blue:{borderClass:"border-sky-300/45",ringClass:"ring-sky-300/65",accentClass:"bg-sky-300/10",titleClass:"text-sky-200"},purple:{borderClass:"border-violet-300/45",ringClass:"ring-violet-300/65",accentClass:"bg-violet-300/10",titleClass:"text-violet-200"},red:{borderClass:"border-rose-300/45",ringClass:"ring-rose-300/65",accentClass:"bg-rose-300/10",titleClass:"text-rose-200"},gold:{borderClass:"border-amber-300/50",ringClass:"ring-amber-300/70",accentClass:"bg-amber-300/10",titleClass:"text-amber-200"}},Pc=["I can feel a new form stirring inside me.","We are so close to a breakthrough together.","Something bright is building in me.","One more push and I will transform.","My next form is almost ready to awaken."],Rc=t=>{if(typeof t!="string")return null;const s=t.trim();return s.length>0?s:null},tj=t=>{let s=0;for(let a=0;a<t.length;a+=1)s=s*31+t.charCodeAt(a)|0;return Math.abs(s)},qp=n.memo(({className:t,companionName:s})=>{const{greeting:a,bondDialogue:r,microTitle:i,shimmerType:o,dialogueMood:l,isLoading:c,lineId:d}=X_(),{companion:u,progressToNext:p,canEvolve:h}=At(),{dismiss:f}=tp(),m=u?.current_image_url,g=Rc(s)??Rc(u?.cached_creature_name)??"Companion",y=Ip({progressToNext:p,canEvolve:h}),b=n.useMemo(()=>{if(!y)return null;const q=`${u?.id??"companion"}:${u?.current_stage??0}:${d}`,$=tj(q)%Pc.length;return Pc[$]},[y,u?.id,u?.current_stage,d]),[w,x]=n.useState(a),[v,j]=n.useState(!1),[T,S]=n.useState(!1),N=typeof window<"u"&&typeof window.matchMedia=="function"&&window.matchMedia("(prefers-reduced-motion: reduce)").matches;n.useEffect(()=>{if(a!==w&&!v){j(!0);const q=setTimeout(()=>{x(a),j(!1)},300);return()=>clearTimeout(q)}},[a,w,v]);const D=n.useCallback(q=>{q&&f(),S(q)},[f]),R=n.useCallback(()=>{D(!0)},[D]),_=n.useCallback(q=>{q.key!=="Enter"&&q.key!==" "||(q.preventDefault(),R())},[R]);if(c)return e.jsx("div",{className:I("h-16 bg-card/30 rounded-xl animate-pulse",t)});const C=Z_[l],E=ej[o],O=o!=="none"&&!N,M=o==="none"?C.ringColor:E.ringClass,A=i?.trim()||"Companion Event",L=!!i?.trim();return e.jsxs(as,{open:T,onOpenChange:D,children:[e.jsxs(P.button,{type:"button","data-testid":"companion-dialogue-trigger","data-shimmer-type":o,className:I("relative w-full overflow-hidden rounded-xl border text-left focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring",E.borderClass,C.bgColor,t),"aria-label":`Open ${g} dialogue`,onClick:R,onKeyDown:_,initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsx("div",{"data-testid":"companion-dialogue-accent",className:I("pointer-events-none absolute inset-0 rounded-xl transition-colors",E.accentClass,O&&"animate-pulse"),"aria-hidden":"true"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent pointer-events-none"}),e.jsx("div",{className:"relative p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:I("flex-shrink-0 rounded-lg overflow-hidden","ring-2",M),children:e.jsxs(_a,{className:"h-10 w-10 rounded-lg",children:[m?e.jsx(ja,{src:m,alt:g,className:"object-cover"}):null,e.jsx(Na,{className:"rounded-lg bg-primary/20 text-primary",children:g.charAt(0).toUpperCase()})]})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:I("mb-1 text-[11px] font-semibold uppercase tracking-[0.08em]",L?E.titleClass:"text-muted-foreground/80"),children:A}),e.jsx(Re,{mode:"wait",children:e.jsxs(P.p,{className:"text-sm text-foreground/90 leading-relaxed",initial:{opacity:0,y:5},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},transition:{duration:.2},children:['"',w,'"']},w)}),b?e.jsx("p",{"data-testid":"companion-near-evolution-line",className:"mt-2 text-xs italic text-primary/90",children:b}):null]})]})})]}),e.jsx(Qt,{className:I("max-w-md overflow-hidden p-0",E.borderClass),children:e.jsxs("div",{className:I("relative p-5",C.bgColor),children:[e.jsx("div",{"data-testid":"companion-dialogue-modal-accent",className:I("pointer-events-none absolute inset-0 transition-colors",E.accentClass,O&&"animate-pulse"),"aria-hidden":"true"}),e.jsxs("div",{className:"relative space-y-4",children:[e.jsx(Is,{className:"text-left",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(_a,{className:I("h-12 w-12 rounded-lg ring-2",C.ringColor),children:[m?e.jsx(ja,{src:m,alt:g,className:"object-cover"}):null,e.jsx(Na,{className:"rounded-lg bg-primary/20 text-primary",children:g.charAt(0).toUpperCase()})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsx(ps,{children:g}),e.jsx(Vs,{className:I("text-[11px] font-semibold uppercase tracking-[0.08em]",L?E.titleClass:"text-muted-foreground/80"),children:A})]})]})}),e.jsxs("div",{className:"space-y-3 rounded-lg border border-border/50 bg-background/20 p-4",children:[e.jsxs("p",{className:"text-sm leading-relaxed text-foreground",children:['"',w,'"']}),b?e.jsx("p",{"data-testid":"companion-near-evolution-line-modal",className:"text-xs italic text-primary/90",children:b}):null,r?e.jsx("p",{className:"text-sm leading-relaxed text-foreground/80",children:r}):null]})]})]})})]})});qp.displayName="CompanionDialogue";const Ic=["I... I can see you again! You came back for me...","You didn't give up on me... I'll never forget this.","The darkness is fading... because of you.","I dreamed of this moment. You're really here.","My heart feels warm again. Thank you for believing in me."],qc={1:"A bond has been renewed.",2:"Your connection deepens through adversity.",3:"Trust restored through dedication.",4:"An unbreakable bond forged through care.",5:"A legendary bond â€” you never abandoned them."},Lp=n.memo(({isOpen:t,onClose:s,companionName:a,companionImageUrl:r,dormantImageUrl:i,bondLevel:o})=>{const[l,c]=n.useState(!1),[d,u]=n.useState(0),p=Ic[Math.floor(Math.random()*Ic.length)],h=qc[Math.min(5,o)]||qc[1];return n.useEffect(()=>{if(!t){c(!1),u(0);return}const f=setTimeout(()=>u(1),500),m=setTimeout(()=>{c(!0),u(2);const b=Date.now()+3e3,w=["#FFD700","#FF69B4","#00CED1","#9370DB"];(function x(){Bt({particleCount:3,angle:60,spread:55,origin:{x:0},colors:w}),Bt({particleCount:3,angle:120,spread:55,origin:{x:1},colors:w}),Date.now()<b&&requestAnimationFrame(x)})()},2e3),g=setTimeout(()=>u(3),3500);return()=>{clearTimeout(f),clearTimeout(m),clearTimeout(g)}},[t]),e.jsx(as,{open:t,onOpenChange:f=>!f&&s(),children:e.jsx(Qt,{className:"sm:max-w-md bg-gradient-to-br from-slate-900 via-purple-900/50 to-slate-900 border-amber-500/30",hideCloseButton:!0,children:e.jsxs("div",{className:"flex flex-col items-center py-6 space-y-6",children:[e.jsx(P.div,{className:"absolute inset-0 overflow-hidden rounded-lg",initial:{opacity:0},animate:{opacity:d>=1?1:0},children:e.jsx(P.div,{className:"absolute inset-0 bg-gradient-radial from-amber-500/20 via-transparent to-transparent",animate:{scale:[1,1.2,1],opacity:[.3,.6,.3]},transition:{duration:3,repeat:1/0,ease:"easeInOut"}})}),e.jsxs(P.div,{className:"text-center z-10",initial:{opacity:0,y:-20},animate:{opacity:d>=1?1:0,y:0},transition:{delay:.3},children:[e.jsx(Tg,{className:"w-8 h-8 text-amber-400 mx-auto mb-2 animate-pulse"}),e.jsx("h2",{className:"text-2xl font-heading font-bold bg-gradient-to-r from-amber-300 via-yellow-200 to-amber-300 bg-clip-text text-transparent",children:"Awakening"})]}),e.jsxs("div",{className:"relative w-48 h-48 z-10",children:[e.jsx(Re,{children:!l&&i&&e.jsx(P.img,{src:i,alt:`Sleeping ${a}`,className:"absolute inset-0 w-full h-full object-cover rounded-2xl",style:{filter:"grayscale(0.5) brightness(0.6)"},initial:{opacity:1,scale:.95},exit:{opacity:0,scale:.8,filter:"grayscale(0) brightness(1.5)"},transition:{duration:1}})}),e.jsxs(P.div,{className:"absolute inset-0",initial:{opacity:0,scale:.8},animate:{opacity:l?1:0,scale:l?1:.8},transition:{duration:1,delay:.5},children:[e.jsx(P.div,{className:"absolute inset-0 rounded-2xl",animate:{boxShadow:["0 0 20px rgba(255, 215, 0, 0.3)","0 0 40px rgba(255, 215, 0, 0.5)","0 0 20px rgba(255, 215, 0, 0.3)"]},transition:{duration:2,repeat:1/0}}),e.jsx("img",{src:r,alt:`Awakened ${a}`,className:"w-full h-full object-cover rounded-2xl ring-4 ring-amber-400/50"}),[...Array(6)].map((f,m)=>e.jsx(P.div,{className:"absolute",style:{top:`${20+Math.random()*60}%`,left:`${10+Math.random()*80}%`},animate:{opacity:[0,1,0],scale:[.5,1,.5],y:[0,-10,0]},transition:{duration:1.5,repeat:1/0,delay:m*.3},children:e.jsx(Mt,{className:"w-4 h-4 text-amber-300"})},m))]})]}),e.jsx(Re,{children:d>=3&&e.jsxs(P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"text-center space-y-4 z-10 px-4",children:[e.jsx("div",{className:"p-4 rounded-xl bg-muted/20 border border-amber-500/20",children:e.jsxs("p",{className:"text-foreground/90 italic",children:['"',p,'"']})}),e.jsxs(P.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},className:"flex items-center justify-center gap-2 text-amber-400",children:[e.jsx(aa,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:h})]}),e.jsxs(P.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:1},className:"flex items-center justify-center gap-2 text-purple-400 text-sm",children:[e.jsx(be,{className:"w-4 h-4"}),e.jsx("span",{children:"Your companion will remember this moment"})]})]})}),e.jsx(Re,{children:d>=3&&e.jsx(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:1.5},children:e.jsx(z,{onClick:s,className:"bg-gradient-to-r from-amber-500 to-yellow-500 hover:from-amber-600 hover:to-yellow-600 text-slate-900 font-bold px-8",children:"Welcome Back"})})})]})})})});Lp.displayName="WakeUpCelebration";const sj=["vitality","wisdom","discipline","resolve","creativity","alignment"],Lc=100,Oc=1e3,aj=300,rj=({companion:t})=>{const[s,a]=n.useState(null),r=l=>t[l]??aj,i=l=>(l-Lc)/(Oc-Lc)*100,o=s?$n[s]:null;return e.jsxs(e.Fragment,{children:[e.jsx(Xe,{className:"p-3 bg-gradient-to-br from-secondary/30 to-secondary/10 border-primary/20",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-xs font-bold text-center text-muted-foreground uppercase tracking-wide",children:"Companion Stats"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:sj.map(l=>{const c=$n[l],d=r(l),u=i(d);return e.jsxs("button",{onClick:()=>a(l),className:"p-2 rounded-lg bg-background/50 hover:bg-background/80 transition-all text-left space-y-1.5 border border-transparent hover:border-primary/20",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-sm",children:c.icon}),e.jsx("span",{className:I("text-xs font-medium",c.color),children:c.name})]}),e.jsx("span",{className:"text-[10px] text-muted-foreground font-mono",children:d})]}),e.jsx("div",{className:"relative h-1.5 bg-secondary/50 rounded-full overflow-hidden",children:e.jsx("div",{className:I("absolute inset-y-0 left-0 rounded-full transition-all duration-500",c.progressColor),style:{width:`${u}%`}})})]},l)})}),e.jsx("p",{className:"text-[10px] text-center text-muted-foreground/70 italic",children:"Tap a stat to learn more"})]})}),e.jsx(as,{open:!!s,onOpenChange:l=>!l&&a(null),children:e.jsxs(Qt,{className:"max-w-md",children:[e.jsxs(Is,{children:[e.jsxs(ps,{className:"flex items-center gap-2 text-xl",children:[o?.icon," ",o?.name]}),e.jsxs(Vs,{className:"sr-only",children:["Learn about the ",o?.name," attribute"]})]}),o&&s&&e.jsxs("div",{className:"space-y-4 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Current Level:"}),e.jsxs("span",{className:"font-mono font-semibold",children:[r(s)," / ",Oc]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-foreground mb-1",children:"What it means:"}),e.jsx("p",{className:"text-muted-foreground",children:o.whatItMeans})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-foreground mb-2",children:"Boosted by:"}),e.jsx("ul",{className:"space-y-1.5 text-muted-foreground",children:o.boostedBy.map((l,c)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-0.5",children:"â€¢"}),e.jsx("span",{children:l})]},c))})]}),e.jsxs("div",{className:"pt-2 border-t border-border/50",children:[e.jsx("h4",{className:"font-semibold text-foreground mb-1",children:"When it grows:"}),e.jsx("p",{className:"text-muted-foreground italic",children:o.whenGrows})]})]})]})})]})},nj=800,Fc=12,ij="/placeholder-companion.svg",oj=t=>{const s={"#FF0000":"Red","#FF4500":"Orange Red","#FF6347":"Tomato","#FFA500":"Orange","#FFD700":"Gold","#FFFF00":"Yellow","#00FF00":"Lime","#00FA9A":"Spring Green","#008000":"Green","#00FFFF":"Cyan","#00CED1":"Turquoise","#4169E1":"Royal Blue","#0000FF":"Blue","#000080":"Navy","#4B0082":"Indigo","#9370DB":"Purple","#8B008B":"Dark Magenta","#FF00FF":"Magenta","#FF1493":"Deep Pink","#FF69B4":"Hot Pink","#FFC0CB":"Pink","#FFFFFF":"White","#C0C0C0":"Silver","#808080":"Gray","#000000":"Black","#A52A2A":"Brown","#D2691E":"Chocolate"},a=t.toUpperCase();if(s[a])return s[a];const r=t.replace("#",""),i=parseInt(r.substring(0,2),16),o=parseInt(r.substring(2,4),16),l=parseInt(r.substring(4,6),16),c=Math.max(i,o,l),d=Math.min(i,o,l);return c-d<30?c>200?"White":c>150?"Light Gray":c>100?"Gray":c>50?"Dark Gray":"Black":i===c?o>l?o>150?"Yellow":"Orange":i>150?"Red":"Dark Red":o===c?i>l?"Yellow Green":o>150?"Green":"Dark Green":i>o?l>150?"Purple":"Dark Purple":l>150?"Blue":"Dark Blue"},Op=n.memo(()=>{const{companion:t,nextEvolutionXP:s,progressToNext:a,isLoading:r,canEvolve:i,triggerManualEvolution:o,isEvolutionBusy:l}=At(),{unlockedSkins:c}=$v(),{health:d,needsWelcomeBack:u}=vp(),{regenerate:p,isRegenerating:h,maxRegenerations:f,generationPhase:m,retryCount:g}=Uv(),{equippedRewards:y}=_p();ri();const{showCelebration:b,dismissCelebration:w,companionName:x,companionImageUrl:v,dormantImageUrl:j,bondLevel:T}=zv(),{cssStyles:S,animationClass:N,care:D,evolutionPath:R,isDormant:_,hasDormancyWarning:C}=Bv(d.moodState,d.hunger,d.happiness,d.isAlive,d.recoveryProgress),[E,O]=n.useState(!1),[M,A]=n.useState(!1),[L,q]=n.useState(0),[$,B]=n.useState(!1),[W,H]=n.useState(!1),[K,X]=n.useState(!1),[Y,ee]=n.useState(!1),[ie,fe]=n.useState(null),U=n.useRef(null),ce=n.useRef(!1),se=n.useRef(null),ne=n.useRef(null),xe=t?.image_regenerations_used??0,G=Math.max(0,f-xe),ye=n.useCallback(oe=>{if(!(!t||h||G<=0)){if("touches"in oe&&oe.touches[0]){const Fe=oe.touches[0];se.current={x:Fe.clientX,y:Fe.clientY}}else se.current=null;ce.current=!1,U.current=setTimeout(()=>{ce.current=!0,ee(!0)},nj)}},[t,h,G]),we=n.useCallback(()=>{U.current&&(clearTimeout(U.current),U.current=null),se.current=null},[]),Te=n.useCallback(oe=>{if(!se.current||!U.current)return;const Fe=oe.touches[0];if(!Fe)return;const Je=Math.abs(Fe.clientX-se.current.x),pt=Math.abs(Fe.clientY-se.current.y);(Je>Fc||pt>Fc)&&we()},[we]),qe=n.useCallback(oe=>{oe.key!=="Enter"&&oe.key!==" "||(oe.preventDefault(),!(!t||h||G<=0)&&ee(!0))},[t,h,G]),Se=n.useCallback(()=>{t&&(p({id:t.id,spirit_animal:t.spirit_animal,core_element:t.core_element,favorite_color:t.favorite_color,current_stage:t.current_stage,eye_color:t.eye_color,fur_color:t.fur_color}),ee(!1))},[t,p]),Pe=n.useMemo(()=>c?.find(oe=>oe.is_equipped)?.companion_skins,[c]),$e=n.useMemo(()=>{if(!Pe?.css_effect)return{};try{const oe=Pe.css_effect;if(Pe.skin_type==="aura"&&oe.glowColor&&typeof oe.glowColor=="string")return{boxShadow:`0 0 30px ${oe.glowColor}, 0 0 60px ${oe.glowColor}`,filter:`drop-shadow(0 0 20px ${oe.glowColor})`};if(Pe.skin_type==="frame"&&oe.borderColor&&typeof oe.borderColor=="string")return{border:`${oe.borderWidth||"3px"} solid ${oe.borderColor}`,boxShadow:oe.shimmer?`0 0 20px ${oe.borderColor}`:void 0}}catch(oe){return console.error("Failed to parse skin effects:",oe),{}}return{}},[Pe]),Be=n.useMemo(()=>{const oe={};if(y.frame?.epic_rewards?.css_effect){const Fe=y.frame.epic_rewards.css_effect;Fe.borderColor&&(oe.borderColor=Fe.borderColor,oe.borderWidth=Fe.borderWidth||"4px",oe.borderStyle="solid")}if(y.effect?.epic_rewards?.css_effect){const Fe=y.effect.epic_rewards.css_effect;Fe.glowColor&&(oe.boxShadow=`0 0 30px ${Fe.glowColor}, 0 0 60px ${Fe.glowColor}`)}return oe},[y]),Me=n.useMemo(()=>y.background?.epic_rewards?.css_effect&&y.background.epic_rewards.css_effect.gradient||null,[y]);n.useEffect(()=>{const oe=window.matchMedia("(prefers-reduced-motion: reduce)");B(oe.matches);const Fe=Je=>B(Je.matches);return oe.addEventListener("change",Fe),()=>oe.removeEventListener("change",Fe)},[]),n.useEffect(()=>{u&&!K&&t&&H(!0)},[u,K,t]);const De=n.useMemo(()=>_&&t?.dormant_image_url?t.dormant_image_url:d.isNeglected&&d.neglectedImageUrl?d.neglectedImageUrl:t?.current_image_url,[_,t?.dormant_image_url,d.isNeglected,d.neglectedImageUrl,t?.current_image_url])||ij;n.useEffect(()=>{ne.current!==De&&(ne.current=De,O(!1),A(!1))},[De]),n.useEffect(()=>()=>{U.current&&clearTimeout(U.current)},[]);const ve=n.useMemo(()=>Np({coreElement:t?.core_element,favoriteColor:t?.favorite_color,stage:t?.current_stage,companionId:t?.id}),[t?.core_element,t?.favorite_color,t?.current_stage,t?.id]);if(n.useEffect(()=>{let oe=!1;return(async()=>{if(!t)return;const Je=await rl({companion:t,fallback:"species"});oe||fe(Je)})(),()=>{oe=!0}},[t?.id,t?.current_stage,t?.cached_creature_name,t?.spirit_animal]),r)return e.jsx(Gv,{});if(!t)return null;const Z=li(t.current_stage),Q=oj(t.favorite_color),J=s??t.current_xp,de=t.current_stage>=20;return e.jsxs(e.Fragment,{children:[e.jsxs(Xe,{className:"relative overflow-hidden bg-card/25 backdrop-blur-2xl border transition-all duration-500 animate-scale-in",style:{borderColor:ve.chipBorder},children:[Me?e.jsx("div",{className:"absolute inset-0 opacity-70 transition-opacity duration-500",style:{background:Me}}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`absolute inset-0 opacity-60 ${$?"":"animate-nebula-shift"}`,style:{background:`linear-gradient(135deg, ${ve.cardGradientA}, ${ve.cardGradientB})`}}),e.jsx("div",{className:"absolute inset-0",style:{background:`radial-gradient(circle at top right, ${ve.glow}, transparent 52%)`}}),e.jsx("div",{className:"absolute inset-0",style:{background:`radial-gradient(circle at bottom left, ${ve.badgeBorder}, transparent 56%)`}})]}),e.jsxs("div",{className:"relative p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("h2",{className:`text-3xl font-heading font-black bg-clip-text text-transparent ${$?"":"animate-gradient"}`,style:{backgroundImage:`linear-gradient(90deg, ${ve.accentText}, ${ve.badgeText}, ${ve.accentText})`},children:Z}),e.jsx(Vv,{title:"Stage",description:"Your companion's evolution stage"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground font-medium",children:["Stage ",t.current_stage]})]}),e.jsx("div",{className:`h-14 w-14 rounded-full flex items-center justify-center ${$?"":"animate-pulse"}`,style:{background:ve.badgeBg,boxShadow:`0 0 26px ${ve.glow}`,border:`1px solid ${ve.badgeBorder}`},"aria-hidden":"true",children:e.jsx(_u,{fill:"currentColor",className:"h-7 w-7 -rotate-45",style:{color:ve.accentText}})})]}),e.jsx("p",{className:"text-center text-2xl font-semibold tracking-wide -mt-1",style:{color:ve.accentText},children:ie||"Companion"}),e.jsxs("div",{className:"flex justify-center py-2 relative group",role:"img","aria-label":`Your companion at stage ${t.current_stage}: ${Z}`,children:[e.jsx("div",{className:`absolute inset-0 blur-3xl opacity-50 group-hover:opacity-70 transition-opacity duration-500 ${$?"animate-none":"animate-orbit"}`,style:{background:`radial-gradient(circle, hsl(var(--celestial-blue) / ${(t.vitality??300)/600}), hsl(var(--nebula-pink) / ${(t.vitality??300)/600}), transparent)`},"aria-hidden":"true"}),e.jsx("div",{className:`absolute inset-0 bg-gradient-to-r from-celestial-blue/20 via-nebula-pink/20 to-cosmiq-glow/20 blur-3xl opacity-50 group-hover:opacity-70 transition-opacity duration-500 ${$?"animate-none":""}`,"aria-hidden":"true"}),e.jsxs("div",{className:"relative select-none focus-visible:ring-2 focus-visible:ring-primary/70 rounded-2xl outline-none",role:"button",tabIndex:0,"aria-label":`Press and hold to refresh your companion's look. ${G} look refresh${G===1?"":"es"} remaining.`,onMouseDown:ye,onMouseUp:we,onMouseLeave:we,onTouchStart:ye,onTouchMove:Te,onTouchEnd:we,onTouchCancel:we,onKeyDown:qe,children:[e.jsx("div",{className:`absolute inset-0 rounded-2xl ${$?"":"star-shimmer"}`,"aria-hidden":"true"}),e.jsx("div",{className:`absolute inset-0 bg-gradient-to-br from-nebula-pink/30 to-celestial-blue/30 rounded-2xl blur-xl ${$?"":"animate-pulse"}`,"aria-hidden":"true"}),!E&&!M&&e.jsxs("div",{className:"relative w-64 h-64 rounded-2xl bg-gradient-to-br from-primary/20 to-accent/20 animate-pulse flex items-center justify-center",role:"status","aria-live":"polite","aria-label":"Loading companion image",children:[e.jsx(be,{className:"h-12 w-12 text-primary/50 animate-spin","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Loading companion image"})]}),M&&e.jsx("div",{className:"relative w-64 h-64 rounded-2xl bg-gradient-to-br from-destructive/20 to-destructive/10 flex items-center justify-center border-2 border-destructive/30",role:"alert","aria-live":"assertive",children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",id:"image-error-message",children:"Image unavailable"}),e.jsx("button",{onClick:()=>{A(!1),O(!1),q(oe=>oe+1)},className:"text-xs text-primary hover:underline focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 rounded px-2 py-1","aria-label":"Retry loading companion image","aria-describedby":"image-error-message",children:"Try again"})]})}),e.jsx("img",{src:De,alt:`${Z} companion at stage ${t.current_stage}`,className:`relative w-64 h-64 object-cover rounded-2xl shadow-2xl ring-4 transition-all duration-500 group-hover:scale-105 ${E?"opacity-100":"opacity-0 absolute"} ${d.isNeglected?"ring-destructive/50":"ring-primary/30"} ${h?"animate-pulse":""} ${N}`,style:{...$e,...S,...Be},onLoad:()=>{O(!0),A(!1)},onError:()=>{A(!0),O(!1)},loading:"lazy",decoding:"async",draggable:!1},L),e.jsx(d_,{show:C&&!_,daysUntilDormancy:D.dormancy.daysUntilDormancy??void 0}),e.jsx(u_,{isDormant:D.dormancy.isDormant,recoveryDays:D.dormancy.recoveryDays,daysUntilWake:D.dormancy.daysUntilWake})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-center items-center gap-3 mb-3 flex-wrap",children:[e.jsx(r_,{element:t.core_element,stage:t.current_stage,showStage:!0,favoriteColor:t.favorite_color,companionId:t.id}),e.jsx(kp,{})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground mb-2",id:"xp-progress-label",children:de?`Stage ${t.current_stage} maxed`:`${t.current_xp} / ${J} XP to next evolution`}),e.jsx(Ys,{value:a,className:"h-3 rounded-full shadow-inner","aria-labelledby":"xp-progress-label","aria-valuenow":t.current_xp,"aria-valuemin":0,"aria-valuemax":J})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 pt-2",children:[e.jsxs("div",{className:"text-center p-3 rounded-xl bg-gradient-to-br from-primary/5 to-accent/5 border border-primary/10 hover:border-primary/30 transition-all",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Color"}),e.jsx("p",{className:"font-medium text-sm",children:Q})]}),e.jsxs("div",{className:"text-center p-3 rounded-xl bg-gradient-to-br from-accent/5 to-primary/5 border border-accent/10 hover:border-accent/30 transition-all",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Spirit"}),e.jsx("p",{className:"font-medium text-sm",children:Ps(t.spirit_animal)})]}),e.jsxs("div",{className:"text-center p-3 rounded-xl bg-gradient-to-br from-primary/5 to-accent/5 border border-primary/10 hover:border-primary/30 transition-all",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Element"}),e.jsx("p",{className:"font-medium text-sm",children:Ps(t.core_element)})]})]}),e.jsx(rj,{companion:t})]}),e.jsx("div",{className:"flex items-center justify-center gap-3",children:R.path&&e.jsx(Sp,{path:R.path,isLocked:R.isLocked})}),e.jsx(qp,{className:"mt-2",companionName:ie}),e.jsx(Re,{children:i&&e.jsx(Cp,{onEvolve:o,isEvolving:l})})]})]}),e.jsx(i_,{isOpen:W,onClose:()=>{H(!1),X(!0)}}),e.jsx(Lp,{isOpen:b,onClose:w,companionName:x,companionImageUrl:v,dormantImageUrl:j,bondLevel:T}),e.jsx(l_,{isOpen:Y,onClose:()=>ee(!1),onConfirm:Se,isRegenerating:h,regenerationsRemaining:G,generationPhase:m,retryCount:g})]})});Op.displayName="CompanionDisplay";const lj=[{action:"Complete a habit",xp:"7-24 XP",icon:"âœ“"},{action:"Finish all daily habits",xp:"+15 XP bonus",icon:"ðŸŽ¯"},{action:"Complete daily missions",xp:"8-28 XP (Main Quest 1.5x)",icon:"âš¡"},{action:"Challenge day bonus",xp:"25 XP",icon:"ðŸ’ª"},{action:"Streak milestones",xp:"15 XP",icon:"ðŸ”¥"},{action:"Weekly challenge complete",xp:"60 XP",icon:"ðŸ†"}],Fp=n.memo(({currentStage:t,currentXP:s,nextEvolutionXP:a,progressPercent:r,showBondProgress:i=!0})=>{const o=Math.min(t+1,20),l=li(o),c=a-s,d=t>=20,u=c<=0,p=Ip({progressToNext:r,canEvolve:u}),{currentBond:h,isLoading:f}=hl(),m=n.useMemo(()=>{if(!h?.nextMilestone)return 100;const g=v=>Math.round(25*Math.pow(1.8,v-2)),y=h.level===1?0:g(h.level),w=g(h.level+1)-y,x=h.totalInteractions-y;return Math.min(100,Math.max(0,x/w*100))},[h]);return d?e.jsx(Xe,{className:"p-5 bg-card/25 backdrop-blur-2xl border-accent/20",children:e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-accent/20 flex items-center justify-center",children:e.jsx(be,{className:"h-5 w-5 text-accent"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-heading font-bold text-sm",children:"Maximum Evolution!"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Your companion has reached its final form"})]})]})}):e.jsx(Xe,{className:"p-5 bg-card/25 backdrop-blur-2xl border-primary/20 hover:border-primary/40 transition-all duration-300",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-primary/20 flex items-center justify-center",children:e.jsx(Rs,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-heading font-bold text-sm",children:"Next Evolution"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:l})]})]}),e.jsxs("div",{"data-testid":"next-evolution-progress",className:p?"space-y-2 rounded-lg bg-primary/8 p-2 motion-safe:animate-pulse":"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Progress"}),e.jsx("span",{className:"font-medium text-primary",children:c>0?`${c} XP needed`:"Ready!"})]}),e.jsx(Ys,{value:r,className:"h-2"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s," / ",a," XP"]})]}),i&&h&&!f&&e.jsx("div",{className:"space-y-2 pt-3 border-t border-border/30",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:h.icon}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Bond: ",h.name]}),h.nextMilestone&&e.jsxs("span",{className:"font-medium text-primary/80",children:["â†’ ",h.nextMilestone.name]})]}),e.jsx(Ys,{value:m,className:"h-1.5 mt-1"})]})]})}),e.jsxs("div",{className:"space-y-2 pt-2 border-t border-border/50",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"Quick XP Tips:"}),e.jsx("div",{className:"space-y-1.5",children:lj.slice(0,3).map((g,y)=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"text-muted-foreground flex items-center gap-1.5",children:[e.jsx("span",{children:g.icon}),g.action]}),e.jsx("span",{className:"font-medium text-primary",children:g.xp})]},y))})]})]})})});Fp.displayName="NextEvolutionPreview";const $p=n.memo(()=>{const{user:t}=_e(),{currentStreak:s=0,multiplier:a=1,nextMilestone:r}=al(),i=new Date,o=i.toLocaleDateString("en-CA"),l=new Date(i.getFullYear(),i.getMonth(),i.getDate()).toISOString(),{data:c}=Ee({queryKey:["xp-breakdown",o,t?.id],queryFn:async()=>{if(!t)return null;const{data:u}=await k.from("xp_events").select("*").eq("user_id",t.id).gte("created_at",l).order("created_at",{ascending:!1});if(!u)return{total:0,byType:{}};const p=u.reduce((f,m)=>(f[m.event_type]=(f[m.event_type]||0)+m.xp_earned,f),{});return{total:u.reduce((f,m)=>f+m.xp_earned,0),byType:p,events:u}},enabled:!!t,staleTime:60*1e3}),d={habit_complete:"Habits",task_complete:"Quests",check_in:"Check-in",evening_reflection:"Evening Reflection",pep_talk:"Pep Talk",pep_talk_listen:"Pep Talk Listen",all_habits_complete:"All Habits Bonus",mission_check_in:"Mission",mission_pep_talk:"Mission",mission_habits_3:"Mission",mission_all_habits:"Mission",mission_profile_update:"Profile Update"};return e.jsx(Xe,{className:"p-5 md:p-6 bg-card/25 backdrop-blur-2xl border-primary/20 select-none",children:e.jsxs("div",{className:"space-y-4",onContextMenu:u=>u.preventDefault(),children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(be,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-heading font-black text-lg",children:"Today's XP"}),e.jsxs("p",{className:"text-2xl font-bold text-primary",children:[c?.total||0," XP"]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-accent/10 border border-accent/20",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(es,{className:"h-5 w-5 text-orange-500"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-bold",children:[s," Day Streak"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[a,"x XP Multiplier"]})]})]}),r.daysRemaining>0&&e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Next milestone"}),e.jsxs("p",{className:"text-sm font-bold",children:[r.daysRemaining," days"]})]})]}),c&&Object.keys(c.byType).length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-bold text-muted-foreground",children:"XP Sources"}),Object.entries(c.byType).map(([u,p])=>e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:d[u]||Ps(u)}),e.jsxs("span",{className:"font-bold text-primary",children:["+",p," XP"]})]},u))]}),c&&c.total>0&&e.jsxs("div",{className:"flex items-center gap-2 p-3 rounded-lg bg-primary/5 border border-primary/10",children:[e.jsx(Rs,{className:"h-4 w-4 text-primary"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Keep this up for 7 days = ",(c.total*7).toFixed(0)," XP"]})]})]})})});$p.displayName="XPBreakdown";const cj=()=>{const{user:t}=_e(),{toast:s}=_s(),a=Ie(),{awardCustomXP:r}=rs(),{checkFirstTimeAchievements:i}=ci(),o=km(),[l,c]=n.useState(null),[d,u]=n.useState(null),{data:p,isLoading:h,error:f}=Ee({queryKey:["daily-missions",o,t?.id],queryFn:async()=>{if(!t)return[];c(null);const{data:w,error:x}=await k.from("daily_missions").select("*").eq("user_id",t.id).eq("mission_date",o);if(x)throw x;if(!w||w.length===0){const{data:v,error:j}=await k.functions.invoke("generate-daily-missions",{body:{userId:t.id}});if(j){console.error("Mission generation failed:",j);const S=j.message||"Unable to refresh missions right now.";throw c(S),new Error(S)}const T=v?.missions||[];if(T.length===0){const S="No missions available right now. Please try again soon.";throw c(S),new Error(S)}return v?.theme&&u(v.theme),T}return c(null),w},enabled:!!t,staleTime:300*1e3,refetchOnWindowFocus:!1});n.useEffect(()=>{f&&s({title:l?"Mission refresh failed":"Unable to load daily missions",description:l||f.message,variant:"destructive"})},[f,l,s]);const m=he({mutationFn:async()=>{if(!t)throw new Error("Not authenticated");c(null);const{data:w,error:x}=await k.functions.invoke("generate-daily-missions",{body:{userId:t.id,forceRegenerate:!0}});if(x){const j=x.message||"Unable to refresh missions right now.";throw c(j),new Error(j)}const v=w?.missions||[];if(v.length===0){const j="No missions were ready. Please try again soon.";throw c(j),new Error(j)}return v},onSuccess:()=>{a.invalidateQueries({queryKey:["daily-missions"]}),s({title:"Daily missions refreshed",description:"Fresh challenges are ready for you!"}),c(null)},onError:w=>{s({title:"Mission refresh failed",description:w.message,variant:"destructive"})}}),g=he({mutationFn:async w=>{if(!t?.id)throw new Error("User not authenticated");const x=p?.find(S=>S.id===w);if(!x)throw new Error("Mission not found");if(x.completed)throw new Error("Mission already completed");const{data:v,error:j}=await k.from("daily_missions").update({completed:!0,completed_at:new Date().toISOString()}).eq("id",w).eq("user_id",t.id).eq("completed",!1).select().maybeSingle();if(j)throw j;if(!v)throw new Error("Mission already completed");await r(x.xp_reward,`mission_${x.mission_type}`,"Mission Complete!",{mission_id:x.id});const{count:T}=await k.from("daily_missions").select("*",{count:"exact",head:!0}).eq("user_id",t.id).eq("completed",!0);return T===1&&await i("mission"),v},onSuccess:()=>{a.invalidateQueries({queryKey:["daily-missions"]}),s({title:"Mission Complete!",description:"XP awarded!"}),el(),window.dispatchEvent(new CustomEvent("quest-completed"))},onError:w=>{s({title:"Mission not completed",description:w.message,variant:"destructive"})}}),y=p?.filter(w=>w.completed).length||0,b=p?.length||0;return{missions:p||[],isLoading:h,completeMission:g.mutateAsync,isCompleting:g.isPending,completedCount:y,totalCount:b,allComplete:y===b&&b>0,regenerateMissions:m.mutateAsync,isRegenerating:m.isPending,generationErrorMessage:l,missionTheme:d}},dj=()=>{const{user:t}=_e(),s=Ie(),{data:a,isLoading:r}=Ee({queryKey:["activity-feed",t?.id],queryFn:async()=>{if(!t)return[];const{data:l,error:c}=await k.from("activity_feed").select("*").eq("user_id",t.id).order("created_at",{ascending:!1}).limit(50);if(c)throw c;return l},enabled:!!t}),i=he({mutationFn:async({type:l,data:c})=>{if(!t)throw new Error("Not authenticated");const{data:d,error:u}=await k.from("activity_feed").insert([{user_id:t.id,activity_type:l,activity_data:c}]).select().maybeSingle();if(u)throw u;if(!d)throw new Error("Failed to create activity");return k.functions.invoke("generate-activity-comment",{body:{activityId:d.id}}).then(({error:p})=>{p&&console.error("Failed to generate activity comment:",p)}).catch(p=>{console.error("Activity comment generation failed:",p)}),d},onSuccess:()=>{s.invalidateQueries({queryKey:["activity-feed"]})}}),o=he({mutationFn:async l=>{if(!t)throw new Error("Not authenticated");const{error:c}=await k.from("activity_feed").update({is_read:!0}).eq("id",l).eq("user_id",t.id);if(c)throw c},onSuccess:()=>{s.invalidateQueries({queryKey:["activity-feed"]})}});return{activities:a||[],isLoading:r,logActivity:i.mutate,markAsRead:o.mutate}},uj={0:{name:"Reset Sunday",emoji:"ðŸŒ…",categories:["identity","wellness","growth"]},1:{name:"Momentum Monday",emoji:"ðŸš€",categories:["quick_win","growth","identity"]},2:{name:"Connection Tuesday",emoji:"ðŸ’œ",categories:["connection","gratitude","wellness"]},3:{name:"Wellness Wednesday",emoji:"ðŸ§˜",categories:["wellness","gratitude","quick_win"]},4:{name:"Gratitude Thursday",emoji:"âœ¨",categories:["gratitude","connection","identity"]},5:{name:"Future Friday",emoji:"ðŸ”®",categories:["identity","growth","quick_win"]},6:{name:"Soul Saturday",emoji:"ðŸŒŸ",categories:["wellness","gratitude","connection"]}},mj={identity_complete_all_quests:{activityType:"all_quests_completed"},identity_complete_all_habits:{activityType:"all_habits_completed"},habit_complete_1:{activityType:"habit_completed",validator:(t,s,a)=>s>=a},habit_complete_3:{activityType:"habit_completed",validator:(t,s,a)=>s>=a},habit_complete_5:{activityType:"habit_completed",validator:(t,s,a)=>s>=a},all_habits:{activityType:"all_habits_completed"},habit_early_bird:{activityType:"habit_completed",validator:t=>new Date(t.completedAt||t.timestamp).getHours()<9},habit_night_owl:{activityType:"habit_completed",validator:t=>new Date(t.completedAt||t.timestamp).getHours()>=20},check_in_morning:{activityType:"check_in_completed"},mood_log:{activityType:"mood_logged",validator:(t,s,a)=>s>=a},reflection_write:{activityType:"reflection_created"},reflection_detailed:{activityType:"reflection_created",validator:t=>(t.note||"").split(/\s+/).length>=100},pep_talk_listen:{activityType:"pep_talk_listened"},pep_talk_full:{activityType:"pep_talk_listened",validator:t=>(t.completion||0)>=100},mentor_chat_start:{activityType:"mentor_message_sent"},mentor_chat_deep:{activityType:"mentor_message_sent",validator:(t,s,a)=>s>=a},library_explore:{activityType:"library_visited"},quote_favorite:{activityType:"quote_favorited"},quote_share:{activityType:"quote_shared"},pep_talk_share:{activityType:"pep_talk_shared"},companion_visit:{activityType:"companion_visited"},companion_interact:{activityType:["companion_visited","companion_evolved"],validator:(t,s,a)=>s>=a},challenge_join:{activityType:"challenge_started"},challenge_complete_day:{activityType:"challenge_day_completed"},streak_maintain:{activityType:"habit_completed",validator:t=>(t.currentStreak||0)>0},bonus_habit_streak:{activityType:"habit_completed",validator:t=>(t.currentStreak||0)>=3},bonus_perfect_day:{activityType:"all_habits_completed"},bonus_triple_threat:{activityType:"mission_completed",validator:t=>new Set(t.completedCategories||[]).size>=3}},pj=()=>{const t=new Date().getDay();return uj[t]},hj=()=>{const{user:t}=_e(),{activities:s}=dj(),{awardCustomXP:a}=rs(),{toast:r}=_s(),i=Ie(),o=new Date,l=o.toLocaleDateString("en-CA"),c=new Date(o.getFullYear(),o.getMonth(),o.getDate()).getTime();n.useEffect(()=>{if(!t||!s||s.length===0)return;let d=!0;return(async()=>{try{const{data:p,error:h}=await k.from("daily_missions").select("*").eq("user_id",t.id).eq("mission_date",l).eq("completed",!1).eq("auto_complete",!0);if(h){console.error("Error fetching missions:",h);return}if(!p||p.length===0||!d)return;const f=s.filter(m=>new Date(m.created_at).getTime()>=c);for(const m of p){if(!d)break;const g=mj[m.mission_type];if(!g)continue;const y=Array.isArray(g.activityType)?g.activityType:[g.activityType],b=f.filter(v=>y.includes(v.activity_type));let w=!1,x=m.progress_current;if(g.validator){for(const v of b)if(g.validator(v.activity_data,x,m.progress_target)&&(x++,x>=m.progress_target)){w=!0;break}}else x=b.length,w=x>=m.progress_target;if(x!==m.progress_current&&d){const{error:v}=await k.from("daily_missions").update({progress_current:x}).eq("id",m.id).eq("user_id",t.id);v||i.invalidateQueries({queryKey:["daily-missions"]})}if(w&&!m.completed&&d){const{data:v,error:j}=await k.from("daily_missions").update({completed:!0,completed_at:new Date().toISOString(),progress_current:m.progress_target}).eq("id",m.id).eq("user_id",t.id).eq("completed",!1).select();!j&&v&&v.length>0&&d&&(await a(m.xp_reward,`mission_${m.mission_type}`,`Mission Complete! ${m.mission_text}`,{mission_id:m.id,source:"auto_complete"}),r({title:"Mission Auto-Completed! ðŸŽ¯",description:`${m.mission_text} (+${m.xp_reward} XP)`}),el(),Bt({particleCount:50,spread:60,origin:{y:.7},colors:["#A76CFF","#C084FC","#E879F9"]}),i.invalidateQueries({queryKey:["daily-missions"]}))}}}catch(p){console.error("Error in mission auto-complete:",p)}})(),()=>{d=!1}},[s,t,l,c,a,r,i])},fj=({onRetry:t,isRetrying:s,errorMessage:a})=>{const r=()=>{!t||s||t()};return e.jsx(Xe,{className:"p-8 text-center bg-gradient-to-br from-accent/5 to-primary/5 border-dashed border-2 border-muted-foreground/20",children:e.jsxs("div",{className:"flex flex-col items-center gap-4 max-w-md mx-auto",children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-accent/10 flex items-center justify-center animate-pulse",children:e.jsx(It,{className:"h-8 w-8 text-accent"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl font-heading font-bold text-foreground",children:"Missions Refresh Daily"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Complete daily missions to earn bonus XP and help your companion evolve faster! Check back tomorrow for new challenges."})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(be,{className:"h-3 w-3"}),e.jsx("span",{children:"New missions arrive at midnight"})]}),a&&e.jsx("p",{className:"text-xs text-destructive mt-2",children:a}),t&&e.jsx(z,{variant:"outline",size:"sm",onClick:r,disabled:s,className:"mt-2 gap-2",children:s?e.jsxs(e.Fragment,{children:[e.jsx(Dl,{className:"h-3 w-3 animate-spin"}),"Retrying..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Dl,{className:"h-3 w-3"}),"Try Refresh Again"]})})]})})},Bp=n.memo(()=>{const{missions:t,isLoading:s,completeMission:a,isCompleting:r,completedCount:i,totalCount:o,allComplete:l,regenerateMissions:c,isRegenerating:d,generationErrorMessage:u,missionTheme:p}=cj();hj();const h=p||pj();if(s)return e.jsx(Bb,{});if(t.length===0)return e.jsx(fj,{onRetry:c,isRetrying:d,errorMessage:u});const f=i/o*100,m=t.filter(w=>!w.is_bonus),g=t.filter(w=>w.is_bonus),y=async w=>{gt.medium();try{await a(w),t.map(j=>j.id===w?{...j,completed:!0}:j).every(j=>j.completed)&&setTimeout(()=>{Bt({particleCount:150,spread:120,origin:{y:.6},colors:["#A76CFF","#C084FC","#E879F9","#FFD700","#FFA500"],ticks:400,gravity:.6,scalar:1.5})},500)}catch(x){console.error("Failed to complete mission:",x),gt.light()}},b=w=>{const x=w.progress_target>1,v=x?w.progress_current/w.progress_target*100:0,j=w.auto_complete;return e.jsxs("div",{onContextMenu:T=>T.preventDefault(),className:`flex items-center justify-between p-2.5 sm:p-3 rounded-lg border transition-all select-none ${w.completed?"bg-accent/5 border-accent/20 opacity-60":"bg-background border-border hover:border-accent/40"} ${w.is_bonus?"border-yellow-500/30 bg-gradient-to-r from-yellow-500/5 to-orange-500/5":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 flex-1 min-w-0",children:[w.completed&&e.jsx(rr,{className:"h-4 w-4 sm:h-5 sm:w-5 text-accent flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1 flex-wrap",children:[e.jsx("p",{className:`text-sm font-medium ${w.completed?"line-through":""}`,children:w.mission_text}),j&&!w.completed&&e.jsxs(Oe,{variant:"outline",className:"text-xs px-1.5 py-0",children:[e.jsx(bt,{className:"h-2.5 w-2.5 mr-1"}),"Auto"]}),w.is_bonus&&e.jsxs(Oe,{variant:"gold",className:"text-xs px-1.5 py-0",children:[e.jsx(be,{className:"h-2.5 w-2.5 mr-1"}),"Bonus"]}),w.difficulty==="hard"&&!w.completed&&e.jsxs(Oe,{variant:"outline",className:"text-xs px-1.5 py-0 border-red-500/50 text-red-600",children:[e.jsx(Rs,{className:"h-2.5 w-2.5 mr-1"}),"Hard"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["+",w.xp_reward," XP"]}),x&&!w.completed&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["â€¢ ",w.progress_current,"/",w.progress_target]})]}),x&&!w.completed&&e.jsx(Ys,{value:v,className:"h-1 mt-1.5"})]})]}),!w.completed&&!j&&e.jsx(z,{size:"sm",variant:"outline",onClick:()=>y(w.id),disabled:r,className:"transition-transform hover:scale-105 active:scale-95 hover:bg-accent/10 hover:border-accent/60 min-w-[90px]",children:r?e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-accent border-t-transparent"}):"Complete"})]},w.id)};return e.jsxs(Xe,{className:"p-4 sm:p-5 md:p-6 bg-card/25 backdrop-blur-2xl border-accent/20 hover:border-accent/40 transition-all duration-500 hover:shadow-[0_0_40px_hsl(var(--accent)/0.15)] relative overflow-hidden group",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-accent/10 to-primary/10 pointer-events-none"}),e.jsxs("div",{className:"relative space-y-3 sm:space-y-4 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("div",{className:"h-9 w-9 sm:h-10 sm:w-10 rounded-full bg-accent/20 flex items-center justify-center flex-shrink-0",children:e.jsx(It,{className:"h-4 w-4 sm:h-5 sm:w-5 text-accent"})}),e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("h3",{className:"font-heading font-black text-base sm:text-lg",children:"Daily Missions"})}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-0.5",children:[e.jsx("span",{className:"text-sm",children:h.emoji}),e.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:h.name})]})]}),e.jsxs("p",{className:"text-[10px] sm:text-xs text-muted-foreground ml-auto",children:[i,"/",o," complete"]})]}),l&&e.jsx("div",{className:"text-[10px] sm:text-xs font-bold text-stardust-gold animate-pulse",children:"All Done! ðŸŽ‰"})]}),e.jsx(Ys,{value:f,className:"h-2"}),e.jsx("div",{className:"space-y-2",children:m.map(b)}),g.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsx(be,{className:"h-3.5 w-3.5 text-stardust-gold"}),e.jsx("span",{className:"text-xs font-semibold text-stardust-gold",children:"Streak Bonus"})]}),g.map(b)]})]})]})});Bp.displayName="DailyMissionsContent";const Up=n.memo(()=>e.jsx(ls,{fallback:e.jsx(a0,{}),children:e.jsx(Bp,{})}));Up.displayName="DailyMissions";const fl=Mg,ui=n.forwardRef(({className:t,...s},a)=>e.jsx(ju,{ref:a,className:I("inline-flex h-11 items-center justify-center rounded-xl border border-border/50 bg-muted/45 p-1 text-muted-foreground backdrop-blur-sm",t),...s}));ui.displayName=ju.displayName;const Ss=n.forwardRef(({className:t,...s},a)=>e.jsx(Nu,{ref:a,className:I("inline-flex items-center justify-center whitespace-nowrap rounded-[10px] px-3 py-1.5 text-sm font-medium ring-offset-background transition-colors data-[state=active]:bg-card data-[state=active]:text-foreground data-[state=active]:shadow-[0_4px_12px_rgba(0,0,0,0.18)] data-[state=active]:border data-[state=active]:border-border/60 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",t),...s}));Ss.displayName=Nu.displayName;const Es=n.forwardRef(({className:t,...s},a)=>e.jsx(ku,{ref:a,className:I("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...s}));Es.displayName=ku.displayName;const gj="/assets/week_streak-CUece8o9.webp",xj="/assets/astral_anxiety_10-B5Up-QeM.webp",yj="/assets/challenge_5-BJu2i_V9.webp",bj="/assets/first_habit-CDxJ8VUk.webp",wj="/assets/full_storyline-DdgFPOM5.webp",vj="/assets/astral_chaos_10-oWEQev8H.webp",_j="/assets/astral_chaos_25-BlSOB_c0.webp",jj="/assets/astral_chaos_3-C4-V5jED.webp",Nj="/assets/month_streak-CTBmRUQH.webp",kj="/assets/astral_anxiety_10-B5Up-QeM.webp",Cj="/assets/challenge_5-BJu2i_V9.webp",Sj="/assets/first_habit-CDxJ8VUk.webp",Ej="/assets/full_storyline-DdgFPOM5.webp",Tj="/assets/astral_chaos_10-oWEQev8H.webp",Mj="/assets/astral_chaos_25-BlSOB_c0.webp",Dj="/assets/astral_chaos_3-C4-V5jED.webp",Aj="/assets/month_streak-CTBmRUQH.webp",Pj="/assets/astral_chaos_10-oWEQev8H.webp",Rj="/assets/astral_chaos_25-BlSOB_c0.webp",Ij="/assets/astral_chaos_3-C4-V5jED.webp",qj="/assets/month_streak-CTBmRUQH.webp",Lj="/assets/week_streak-CUece8o9.webp",Oj="/assets/astral_fear_25-GEdNcRml.webp",Fj="/assets/first_epic-TnnyCTH1.webp",$j="/assets/astral_fear_50-BwaHsoTD.webp",Bj="/assets/comeback-CtQtPNuB.webp",Uj="/assets/perfect_day-CjUAYNKv.webp",Hj="/assets/first_quest-CACTIctj.webp",zj="/assets/total_attributes-DdZMFk-M.webp",Kj="/assets/week_streak-CUece8o9.webp",Qj="/assets/astral_fear_25-GEdNcRml.webp",Wj="/assets/astral_chaos_3-C4-V5jED.webp",Gj="/assets/astral_fear_50-BwaHsoTD.webp",Yj="/assets/astral_anxiety_10-B5Up-QeM.webp",Vj="/assets/challenge_5-BJu2i_V9.webp",Xj="/assets/first_habit-CDxJ8VUk.webp",Jj="/assets/full_storyline-DdgFPOM5.webp",Zj="/assets/comeback-CtQtPNuB.webp",eN="/assets/perfect_day-CjUAYNKv.webp",tN="/assets/first_quest-CACTIctj.webp",sN="/assets/total_attributes-DdZMFk-M.webp",aN="/assets/astral_chaos_10-oWEQev8H.webp",rN="/assets/astral_chaos_25-BlSOB_c0.webp",nN="/assets/astral_chaos_3-C4-V5jED.webp",iN="/assets/month_streak-CTBmRUQH.webp",oN="/assets/astral_fear_25-GEdNcRml.webp",lN="/assets/perfect_day-CjUAYNKv.webp",cN="/assets/astral_fear_25-GEdNcRml.webp",dN="/assets/challenge_5-BJu2i_V9.webp",uN="/assets/comeback-CtQtPNuB.webp",mN="/assets/comeback-CtQtPNuB.webp",pN="/assets/perfect_day-CjUAYNKv.webp",hN="/assets/astral_fear_50-BwaHsoTD.webp",fN="/assets/total_attributes-DdZMFk-M.webp",gN="/assets/first_epic-TnnyCTH1.webp",xN="/assets/comeback-CtQtPNuB.webp",yN="/assets/astral_chaos_3-C4-V5jED.webp",bN="/assets/first_epic-TnnyCTH1.webp",wN="/assets/first_habit-CDxJ8VUk.webp",vN="/assets/first_quest-CACTIctj.webp",_N="/assets/first_quest-CACTIctj.webp",jN="/assets/full_storyline-DdgFPOM5.webp",NN="/assets/month_streak-CTBmRUQH.webp",kN="/assets/comeback-CtQtPNuB.webp",CN="/assets/astral_chaos_25-BlSOB_c0.webp",SN="/assets/perfect_day-CjUAYNKv.webp",EN="/assets/astral_chaos_25-BlSOB_c0.webp",TN="/assets/challenge_5-BJu2i_V9.webp",MN="/assets/week_streak-CUece8o9.webp",DN="/assets/astral_anxiety_10-B5Up-QeM.webp",AN="/assets/challenge_5-BJu2i_V9.webp",PN="/assets/astral_fear_25-GEdNcRml.webp",RN="/assets/astral_anxiety_10-B5Up-QeM.webp",IN="/assets/total_attributes-DdZMFk-M.webp",qN="/assets/astral_fear_50-BwaHsoTD.webp",LN="/assets/full_storyline-DdgFPOM5.webp",ON="/assets/astral_chaos_25-BlSOB_c0.webp",FN="/assets/full_storyline-DdgFPOM5.webp",$N="/assets/challenge_5-BJu2i_V9.webp",BN="/assets/astral_chaos_25-BlSOB_c0.webp",UN="/assets/first_quest-CACTIctj.webp",HN="/assets/astral_fear_25-GEdNcRml.webp",zN="/assets/challenge_5-BJu2i_V9.webp",KN="/assets/first_habit-CDxJ8VUk.webp",QN="/assets/total_attributes-DdZMFk-M.webp",WN="/assets/astral_chaos_25-BlSOB_c0.webp",GN="/assets/week_streak-CUece8o9.webp",YN={arcade_explorer:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/arcade_explorer.webp",astral_anxiety_10:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_anxiety_10.webp",astral_anxiety_25:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_anxiety_25.webp",astral_anxiety_3:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_anxiety_3.webp",astral_anxiety_50:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_anxiety_50.webp",astral_chaos_10:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_chaos_10.webp",astral_chaos_25:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_chaos_25.webp",astral_chaos_3:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_chaos_3.webp",astral_chaos_50:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_chaos_50.webp",astral_confusion_10:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_confusion_10.webp",astral_confusion_25:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_confusion_25.webp",astral_confusion_3:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_confusion_3.webp",astral_confusion_50:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_confusion_50.webp",astral_distraction_10:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_distraction_10.webp",astral_distraction_25:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_distraction_25.webp",astral_distraction_3:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_distraction_3.webp",astral_distraction_50:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_distraction_50.webp",astral_doubt_10:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_doubt_10.webp",astral_doubt_25:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_doubt_25.webp",astral_doubt_3:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_doubt_3.webp",astral_doubt_50:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_doubt_50.webp",astral_fear_10:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_fear_10.webp",astral_fear_25:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_fear_25.webp",astral_fear_3:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_fear_3.webp",astral_fear_50:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_fear_50.webp",astral_imbalance_10:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_imbalance_10.webp",astral_imbalance_25:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_imbalance_25.webp",astral_imbalance_3:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_imbalance_3.webp",astral_imbalance_50:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_imbalance_50.webp",astral_laziness_10:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_laziness_10.webp",astral_laziness_25:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_laziness_25.webp",astral_laziness_3:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_laziness_3.webp",astral_laziness_50:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_laziness_50.webp",astral_overthinking_10:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_overthinking_10.webp",astral_overthinking_25:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_overthinking_25.webp",astral_overthinking_3:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_overthinking_3.webp",astral_overthinking_50:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_overthinking_50.webp",astral_stagnation_10:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_stagnation_10.webp",astral_stagnation_25:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_stagnation_25.webp",astral_stagnation_3:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_stagnation_3.webp",astral_stagnation_50:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_stagnation_50.webp",astral_vulnerability_10:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_vulnerability_10.webp",astral_vulnerability_25:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_vulnerability_25.webp",astral_vulnerability_3:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_vulnerability_3.webp",astral_vulnerability_50:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/astral_vulnerability_50.webp",attribute_master_body:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/attribute_master_body.webp",attribute_master_mind:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/attribute_master_mind.webp",attribute_master_soul:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/attribute_master_soul.webp",challenge_5:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/challenge_5.webp",challenge_complete:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/challenge_complete.webp",comeback:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/comeback.webp",companion_stage_10:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/companion_stage_10.webp",companion_stage_15:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/companion_stage_15.webp",companion_stage_20:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/companion_stage_20.webp",companion_stage_3:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/companion_stage_3.webp",companion_stage_5:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/companion_stage_5.webp",first_check_in:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/first_check_in.webp",first_epic:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/first_epic.webp",first_habit:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/first_habit.webp",first_pep_talk:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/first_pep_talk.webp",first_quest:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/first_quest.webp",full_storyline:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/full_storyline.webp",month_streak:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/month_streak.webp",pep_talk_listener_10:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/pep_talk_listener_10.webp",pep_talk_listener_50:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/pep_talk_listener_50.webp",perfect_day:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/perfect_day.webp",starpath_body_forge:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/starpath_body_forge.webp",starpath_clean_machine:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/starpath_clean_machine.webp",starpath_dawn_champion:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/starpath_dawn_champion.webp",starpath_detox_warrior:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/starpath_detox_warrior.webp",starpath_digital_minimalist:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/starpath_digital_minimalist.webp",starpath_iron_mind:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/starpath_iron_mind.webp",starpath_mindful_master:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/starpath_mindful_master.webp",starpath_scholars_path:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/starpath_scholars_path.webp",starpath_sleep_sovereign:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/starpath_sleep_sovereign.webp",starpath_social_butterfly:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/starpath_social_butterfly.webp",story_exploration:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/story_exploration.webp",story_heroes_journey:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/story_heroes_journey.webp",story_mystery:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/story_mystery.webp",story_pilgrimage:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/story_pilgrimage.webp",story_reader:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/story_reader.webp",story_rescue_mission:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/story_rescue_mission.webp",story_treasure_hunt:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/story_treasure_hunt.webp",three_day_streak:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/three_day_streak.webp",total_attributes:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/total_attributes.webp",two_week_streak:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/two_week_streak.webp",week_streak:"https://opbfpbbqvuksuvmtmssd.supabase.co/storage/v1/object/public/badge-reward-previews/badges/week_streak.webp"},VN=[{id:"three_day_streak",achievementType:"streak_3_day",title:"Getting Started",description:"Maintained a 3-day streak",icon:"ðŸ”¥",tier:"bronze",category:"streaks",unlockHint:"Maintain a 3-day streak"},{id:"week_streak",achievementType:"streak_7_day",title:"Week of Discipline",description:"Maintained a 7-day streak",icon:"ðŸ†",tier:"silver",category:"streaks",unlockHint:"Maintain a 7-day streak"},{id:"two_week_streak",achievementType:"streak_14_day",title:"Fortnight Force",description:"Maintained a 14-day streak",icon:"âš¡",tier:"gold",category:"streaks",unlockHint:"Maintain a 14-day streak"},{id:"month_streak",achievementType:"streak_30_day",title:"Monthly Master",description:"Maintained a 30-day streak",icon:"ðŸ‘‘",tier:"platinum",category:"streaks",unlockHint:"Maintain a 30-day streak"},{id:"companion_stage_3",achievementType:"companion_stage_3",title:"First Evolution",description:"Reached companion stage 3",icon:"âœ¨",tier:"bronze",category:"companion",unlockHint:"Evolve your companion to Stage 3 (Cub)"},{id:"companion_stage_5",achievementType:"companion_stage_5",title:"Rising Star",description:"Reached companion stage 5",icon:"ðŸŒŸ",tier:"silver",category:"companion",unlockHint:"Evolve your companion to Stage 5 (Apprentice)"},{id:"companion_stage_10",achievementType:"companion_stage_10",title:"Champion Bond",description:"Reached companion stage 10",icon:"ðŸ…",tier:"gold",category:"companion",unlockHint:"Evolve your companion to Stage 10 (Champion)"},{id:"companion_stage_15",achievementType:"companion_stage_15",title:"Prime Evolution",description:"Reached companion stage 15",icon:"ðŸ’Ž",tier:"platinum",category:"companion",unlockHint:"Evolve your companion to Stage 15 (Prime)"},{id:"companion_stage_20",achievementType:"companion_stage_20",title:"Ultimate Form",description:"Reached companion stage 20",icon:"ðŸŒŒ",tier:"platinum",category:"companion",unlockHint:"Evolve your companion to Stage 20 (Ultimate)"},{id:"first_habit",achievementType:"first_habit",title:"Habit Starter",description:"Completed your first habit",icon:"âœ…",tier:"bronze",category:"firsts",unlockHint:"Complete your first habit"},{id:"first_quest",achievementType:"first_quest",title:"Quest Beginner",description:"Completed your first quest",icon:"âš”ï¸",tier:"bronze",category:"firsts",unlockHint:"Complete your first quest"},{id:"first_pep_talk",achievementType:"first_pep_talk",title:"First Listen",description:"Listened to your first pep talk",icon:"ðŸŽ§",tier:"bronze",category:"firsts",unlockHint:"Listen to a pep talk"},{id:"first_check_in",achievementType:"first_check_in",title:"Self Aware",description:"Completed your first check-in",icon:"ðŸªž",tier:"bronze",category:"firsts",unlockHint:"Complete a daily check-in"},{id:"first_epic",achievementType:"first_epic",title:"Epic Starter",description:"Created your first epic",icon:"ðŸš€",tier:"bronze",category:"firsts",unlockHint:"Create your first epic"},{id:"starpath_detox_warrior",achievementType:"starpath_detox_warrior",title:"Detox Warrior",description:"Completed the Detox Warrior star path",icon:"âš”ï¸",tier:"silver",category:"starpaths",unlockHint:"Complete the Detox Warrior star path"},{id:"starpath_dawn_champion",achievementType:"starpath_dawn_champion",title:"Dawn Champion",description:"Completed the Dawn Champion star path",icon:"ðŸŒ…",tier:"silver",category:"starpaths",unlockHint:"Complete the Dawn Champion star path"},{id:"starpath_mindful_master",achievementType:"starpath_mindful_master",title:"Mindful Master",description:"Completed the Mindful Master star path",icon:"ðŸ§˜",tier:"silver",category:"starpaths",unlockHint:"Complete the Mindful Master star path"},{id:"starpath_iron_mind",achievementType:"starpath_iron_mind",title:"Iron Mind",description:"Completed the Iron Mind star path",icon:"ðŸ§ ",tier:"gold",category:"starpaths",unlockHint:"Complete the Iron Mind star path"},{id:"starpath_body_forge",achievementType:"starpath_body_forge",title:"Body Forge",description:"Completed the Body Forge star path",icon:"ðŸ’ª",tier:"gold",category:"starpaths",unlockHint:"Complete the Body Forge star path"},{id:"starpath_clean_machine",achievementType:"starpath_clean_machine",title:"Clean Machine",description:"Completed the Clean Machine star path",icon:"ðŸ¥—",tier:"gold",category:"starpaths",unlockHint:"Complete the Clean Machine star path"},{id:"starpath_digital_minimalist",achievementType:"starpath_digital_minimalist",title:"Digital Minimalist",description:"Completed the Digital Minimalist star path",icon:"ðŸ“µ",tier:"gold",category:"starpaths",unlockHint:"Complete the Digital Minimalist star path"},{id:"starpath_scholars_path",achievementType:"starpath_scholars_path",title:"Scholar's Path",description:"Completed the Scholar's Path star path",icon:"ðŸ“š",tier:"platinum",category:"starpaths",unlockHint:"Complete the Scholar's Path star path"},{id:"starpath_sleep_sovereign",achievementType:"starpath_sleep_sovereign",title:"Sleep Sovereign",description:"Completed the Sleep Sovereign star path",icon:"ðŸ˜´",tier:"platinum",category:"starpaths",unlockHint:"Complete the Sleep Sovereign star path"},{id:"starpath_social_butterfly",achievementType:"starpath_social_butterfly",title:"Social Butterfly",description:"Completed the Social Butterfly star path",icon:"ðŸ¦‹",tier:"platinum",category:"starpaths",unlockHint:"Complete the Social Butterfly star path"},{id:"story_treasure_hunt",achievementType:"story_treasure_hunt_complete",title:"Fortune Seeker",description:"Completed a Treasure Hunt epic and defeated the boss",icon:"ðŸ’Ž",tier:"gold",category:"starpaths",unlockHint:"Complete a Treasure Hunt star path and defeat the final boss"},{id:"story_mystery",achievementType:"story_mystery_complete",title:"Truth Unveiler",description:"Completed a Mystery epic and defeated the boss",icon:"ðŸ”®",tier:"gold",category:"starpaths",unlockHint:"Complete a Mystery star path and defeat the final boss"},{id:"story_pilgrimage",achievementType:"story_pilgrimage_complete",title:"Soul Pilgrim",description:"Completed a Pilgrimage epic and defeated the boss",icon:"ðŸ§˜",tier:"gold",category:"starpaths",unlockHint:"Complete a Pilgrimage star path and defeat the final boss"},{id:"story_heroes_journey",achievementType:"story_heroes_journey_complete",title:"Legendary Hero",description:"Completed a Heroes Journey epic and defeated the boss",icon:"âš”ï¸",tier:"platinum",category:"starpaths",unlockHint:"Complete a Heroes Journey star path and defeat the final boss"},{id:"story_rescue_mission",achievementType:"story_rescue_mission_complete",title:"Cosmic Savior",description:"Completed a Rescue Mission epic and defeated the boss",icon:"ðŸ›¡ï¸",tier:"gold",category:"starpaths",unlockHint:"Complete a Rescue Mission star path and defeat the final boss"},{id:"story_exploration",achievementType:"story_exploration_complete",title:"Star Cartographer",description:"Completed an Exploration epic and defeated the boss",icon:"ðŸŒŒ",tier:"gold",category:"starpaths",unlockHint:"Complete an Exploration star path and defeat the final boss"},{id:"challenge_complete",achievementType:"challenge_complete",title:"Challenge Accepted",description:"Completed a challenge",icon:"ðŸŽ¯",tier:"silver",category:"challenges",unlockHint:"Complete any challenge"},{id:"challenge_5",achievementType:"challenge_5_complete",title:"Challenge Seeker",description:"Completed 5 challenges",icon:"ðŸ¹",tier:"gold",category:"challenges",unlockHint:"Complete 5 challenges"},{id:"perfect_day",achievementType:"perfect_day",title:"Perfect Day",description:"Completed all daily activities",icon:"ðŸŒˆ",tier:"gold",category:"special",unlockHint:"Complete all quests, habits, and check-in in one day"},{id:"comeback",achievementType:"comeback",title:"Comeback King",description:"Returned after a break",icon:"ðŸ¦‹",tier:"silver",category:"special",unlockHint:"Return to the app after 7+ days away"},{id:"story_reader",achievementType:"story_chapter",title:"Story Lover",description:"Read a companion story chapter",icon:"ðŸ“–",tier:"bronze",category:"special",unlockHint:"Read a companion story chapter"},{id:"full_storyline",achievementType:"full_storyline",title:"Lore Master",description:"Read all available story chapters",icon:"ðŸ“š",tier:"platinum",category:"special",unlockHint:"Read all companion story chapters"},{id:"attribute_master_mind",achievementType:"attribute_master_mind",title:"Mind Master",description:"Reached 100 Mind attribute",icon:"ðŸ§ ",tier:"gold",category:"special",unlockHint:"Reach 100 Mind attribute"},{id:"attribute_master_body",achievementType:"attribute_master_body",title:"Body Master",description:"Reached 100 Body attribute",icon:"ðŸ’ª",tier:"gold",category:"special",unlockHint:"Reach 100 Body attribute"},{id:"attribute_master_soul",achievementType:"attribute_master_soul",title:"Soul Master",description:"Reached 100 Soul attribute",icon:"âœ¨",tier:"gold",category:"special",unlockHint:"Reach 100 Soul attribute"},{id:"total_attributes",achievementType:"total_attributes_250",title:"Well Rounded",description:"Reached 250 total attributes",icon:"â­",tier:"platinum",category:"special",unlockHint:"Reach 250 combined Mind/Body/Soul"},{id:"pep_talk_listener_10",achievementType:"pep_talk_listener_10",title:"Avid Listener",description:"Listened to 10 pep talks",icon:"ðŸŽµ",tier:"silver",category:"special",unlockHint:"Listen to 10 pep talks"},{id:"pep_talk_listener_50",achievementType:"pep_talk_listener_50",title:"Wisdom Seeker",description:"Listened to 50 pep talks",icon:"ðŸŽ¶",tier:"gold",category:"special",unlockHint:"Listen to 50 pep talks"},{id:"arcade_explorer",achievementType:"arcade_explorer",title:"Arcade Explorer",description:"Discovered the hidden Astral Arcade",icon:"ðŸ•¹ï¸",tier:"silver",category:"special",unlockHint:"???"},{id:"astral_distraction_3",achievementType:"astral_distraction_3",title:"Focus Initiate",description:"Defeated 3 Distraction adversaries",icon:"ðŸŽ¯",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Distraction-themed adversaries"},{id:"astral_distraction_10",achievementType:"astral_distraction_10",title:"Focus Warrior",description:"Defeated 10 Distraction adversaries",icon:"ðŸŽ¯",tier:"silver",category:"astral",unlockHint:"Defeat 10 Distraction-themed adversaries"},{id:"astral_distraction_25",achievementType:"astral_distraction_25",title:"Focus Champion",description:"Defeated 25 Distraction adversaries",icon:"ðŸŽ¯",tier:"gold",category:"astral",unlockHint:"Defeat 25 Distraction-themed adversaries"},{id:"astral_distraction_50",achievementType:"astral_distraction_50",title:"Focus Transcendent",description:"Defeated 50 Distraction adversaries",icon:"ðŸŽ¯",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Distraction-themed adversaries"},{id:"astral_stagnation_3",achievementType:"astral_stagnation_3",title:"Momentum Starter",description:"Defeated 3 Stagnation adversaries",icon:"ðŸŒŠ",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Stagnation-themed adversaries"},{id:"astral_stagnation_10",achievementType:"astral_stagnation_10",title:"Momentum Warrior",description:"Defeated 10 Stagnation adversaries",icon:"ðŸŒŠ",tier:"silver",category:"astral",unlockHint:"Defeat 10 Stagnation-themed adversaries"},{id:"astral_stagnation_25",achievementType:"astral_stagnation_25",title:"Momentum Champion",description:"Defeated 25 Stagnation adversaries",icon:"ðŸŒŠ",tier:"gold",category:"astral",unlockHint:"Defeat 25 Stagnation-themed adversaries"},{id:"astral_stagnation_50",achievementType:"astral_stagnation_50",title:"Momentum Transcendent",description:"Defeated 50 Stagnation adversaries",icon:"ðŸŒŠ",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Stagnation-themed adversaries"},{id:"astral_anxiety_3",achievementType:"astral_anxiety_3",title:"Serenity Seeker",description:"Defeated 3 Anxiety adversaries",icon:"ðŸ§˜",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Anxiety-themed adversaries"},{id:"astral_anxiety_10",achievementType:"astral_anxiety_10",title:"Serenity Warrior",description:"Defeated 10 Anxiety adversaries",icon:"ðŸ§˜",tier:"silver",category:"astral",unlockHint:"Defeat 10 Anxiety-themed adversaries"},{id:"astral_anxiety_25",achievementType:"astral_anxiety_25",title:"Serenity Champion",description:"Defeated 25 Anxiety adversaries",icon:"ðŸ§˜",tier:"gold",category:"astral",unlockHint:"Defeat 25 Anxiety-themed adversaries"},{id:"astral_anxiety_50",achievementType:"astral_anxiety_50",title:"Serenity Transcendent",description:"Defeated 50 Anxiety adversaries",icon:"ðŸ§˜",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Anxiety-themed adversaries"},{id:"astral_doubt_3",achievementType:"astral_doubt_3",title:"Confidence Seeker",description:"Defeated 3 Doubt adversaries",icon:"ðŸ’ª",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Doubt-themed adversaries"},{id:"astral_doubt_10",achievementType:"astral_doubt_10",title:"Confidence Warrior",description:"Defeated 10 Doubt adversaries",icon:"ðŸ’ª",tier:"silver",category:"astral",unlockHint:"Defeat 10 Doubt-themed adversaries"},{id:"astral_doubt_25",achievementType:"astral_doubt_25",title:"Confidence Champion",description:"Defeated 25 Doubt adversaries",icon:"ðŸ’ª",tier:"gold",category:"astral",unlockHint:"Defeat 25 Doubt-themed adversaries"},{id:"astral_doubt_50",achievementType:"astral_doubt_50",title:"Confidence Transcendent",description:"Defeated 50 Doubt adversaries",icon:"ðŸ’ª",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Doubt-themed adversaries"},{id:"astral_chaos_3",achievementType:"astral_chaos_3",title:"Order Initiate",description:"Defeated 3 Chaos adversaries",icon:"âš¡",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Chaos-themed adversaries"},{id:"astral_chaos_10",achievementType:"astral_chaos_10",title:"Order Warrior",description:"Defeated 10 Chaos adversaries",icon:"âš¡",tier:"silver",category:"astral",unlockHint:"Defeat 10 Chaos-themed adversaries"},{id:"astral_chaos_25",achievementType:"astral_chaos_25",title:"Order Champion",description:"Defeated 25 Chaos adversaries",icon:"âš¡",tier:"gold",category:"astral",unlockHint:"Defeat 25 Chaos-themed adversaries"},{id:"astral_chaos_50",achievementType:"astral_chaos_50",title:"Order Transcendent",description:"Defeated 50 Chaos adversaries",icon:"âš¡",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Chaos-themed adversaries"},{id:"astral_laziness_3",achievementType:"astral_laziness_3",title:"Drive Initiate",description:"Defeated 3 Laziness adversaries",icon:"ðŸ”¥",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Laziness-themed adversaries"},{id:"astral_laziness_10",achievementType:"astral_laziness_10",title:"Drive Warrior",description:"Defeated 10 Laziness adversaries",icon:"ðŸ”¥",tier:"silver",category:"astral",unlockHint:"Defeat 10 Laziness-themed adversaries"},{id:"astral_laziness_25",achievementType:"astral_laziness_25",title:"Drive Champion",description:"Defeated 25 Laziness adversaries",icon:"ðŸ”¥",tier:"gold",category:"astral",unlockHint:"Defeat 25 Laziness-themed adversaries"},{id:"astral_laziness_50",achievementType:"astral_laziness_50",title:"Drive Transcendent",description:"Defeated 50 Laziness adversaries",icon:"ðŸ”¥",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Laziness-themed adversaries"},{id:"astral_overthinking_3",achievementType:"astral_overthinking_3",title:"Clarity Seeker",description:"Defeated 3 Overthinking adversaries",icon:"ðŸ§ ",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Overthinking-themed adversaries"},{id:"astral_overthinking_10",achievementType:"astral_overthinking_10",title:"Clarity Warrior",description:"Defeated 10 Overthinking adversaries",icon:"ðŸ§ ",tier:"silver",category:"astral",unlockHint:"Defeat 10 Overthinking-themed adversaries"},{id:"astral_overthinking_25",achievementType:"astral_overthinking_25",title:"Clarity Champion",description:"Defeated 25 Overthinking adversaries",icon:"ðŸ§ ",tier:"gold",category:"astral",unlockHint:"Defeat 25 Overthinking-themed adversaries"},{id:"astral_overthinking_50",achievementType:"astral_overthinking_50",title:"Clarity Transcendent",description:"Defeated 50 Overthinking adversaries",icon:"ðŸ§ ",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Overthinking-themed adversaries"},{id:"astral_fear_3",achievementType:"astral_fear_3",title:"Courage Initiate",description:"Defeated 3 Fear adversaries",icon:"ðŸ›¡ï¸",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Fear-themed adversaries"},{id:"astral_fear_10",achievementType:"astral_fear_10",title:"Courage Warrior",description:"Defeated 10 Fear adversaries",icon:"ðŸ›¡ï¸",tier:"silver",category:"astral",unlockHint:"Defeat 10 Fear-themed adversaries"},{id:"astral_fear_25",achievementType:"astral_fear_25",title:"Courage Champion",description:"Defeated 25 Fear adversaries",icon:"ðŸ›¡ï¸",tier:"gold",category:"astral",unlockHint:"Defeat 25 Fear-themed adversaries"},{id:"astral_fear_50",achievementType:"astral_fear_50",title:"Courage Transcendent",description:"Defeated 50 Fear adversaries",icon:"ðŸ›¡ï¸",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Fear-themed adversaries"},{id:"astral_confusion_3",achievementType:"astral_confusion_3",title:"Wisdom Initiate",description:"Defeated 3 Confusion adversaries",icon:"âœ¨",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Confusion-themed adversaries"},{id:"astral_confusion_10",achievementType:"astral_confusion_10",title:"Wisdom Warrior",description:"Defeated 10 Confusion adversaries",icon:"âœ¨",tier:"silver",category:"astral",unlockHint:"Defeat 10 Confusion-themed adversaries"},{id:"astral_confusion_25",achievementType:"astral_confusion_25",title:"Wisdom Champion",description:"Defeated 25 Confusion adversaries",icon:"âœ¨",tier:"gold",category:"astral",unlockHint:"Defeat 25 Confusion-themed adversaries"},{id:"astral_confusion_50",achievementType:"astral_confusion_50",title:"Wisdom Transcendent",description:"Defeated 50 Confusion adversaries",icon:"âœ¨",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Confusion-themed adversaries"},{id:"astral_vulnerability_3",achievementType:"astral_vulnerability_3",title:"Resilience Initiate",description:"Defeated 3 Vulnerability adversaries",icon:"ðŸ’Ž",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Vulnerability-themed adversaries"},{id:"astral_vulnerability_10",achievementType:"astral_vulnerability_10",title:"Resilience Warrior",description:"Defeated 10 Vulnerability adversaries",icon:"ðŸ’Ž",tier:"silver",category:"astral",unlockHint:"Defeat 10 Vulnerability-themed adversaries"},{id:"astral_vulnerability_25",achievementType:"astral_vulnerability_25",title:"Resilience Champion",description:"Defeated 25 Vulnerability adversaries",icon:"ðŸ’Ž",tier:"gold",category:"astral",unlockHint:"Defeat 25 Vulnerability-themed adversaries"},{id:"astral_vulnerability_50",achievementType:"astral_vulnerability_50",title:"Resilience Transcendent",description:"Defeated 50 Vulnerability adversaries",icon:"ðŸ’Ž",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Vulnerability-themed adversaries"},{id:"astral_imbalance_3",achievementType:"astral_imbalance_3",title:"Harmony Initiate",description:"Defeated 3 Imbalance adversaries",icon:"â˜¯ï¸",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Imbalance-themed adversaries"},{id:"astral_imbalance_10",achievementType:"astral_imbalance_10",title:"Harmony Warrior",description:"Defeated 10 Imbalance adversaries",icon:"â˜¯ï¸",tier:"silver",category:"astral",unlockHint:"Defeat 10 Imbalance-themed adversaries"},{id:"astral_imbalance_25",achievementType:"astral_imbalance_25",title:"Harmony Champion",description:"Defeated 25 Imbalance adversaries",icon:"â˜¯ï¸",tier:"gold",category:"astral",unlockHint:"Defeat 25 Imbalance-themed adversaries"},{id:"astral_imbalance_50",achievementType:"astral_imbalance_50",title:"Harmony Transcendent",description:"Defeated 50 Imbalance adversaries",icon:"â˜¯ï¸",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Imbalance-themed adversaries"}],jn=VN.map(t=>({...t,image_url:YN[t.id]??null})),XN={streaks:"Streaks",companion:"Companion",starpaths:"Star Paths",challenges:"Challenges",firsts:"First Steps",special:"Special",astral:"Astral Hunters"},Hp={bronze:"from-orange-500 to-orange-700",silver:"from-gray-300 to-gray-500",gold:"from-yellow-400 to-yellow-600",platinum:"from-purple-400 to-purple-600"},JN=Object.assign({"/src/assets/badges/arcade_explorer.webp":gj,"/src/assets/badges/astral_anxiety_10.webp":xj,"/src/assets/badges/astral_anxiety_25.webp":yj,"/src/assets/badges/astral_anxiety_3.webp":bj,"/src/assets/badges/astral_anxiety_50.webp":wj,"/src/assets/badges/astral_chaos_10.webp":vj,"/src/assets/badges/astral_chaos_25.webp":_j,"/src/assets/badges/astral_chaos_3.webp":jj,"/src/assets/badges/astral_chaos_50.webp":Nj,"/src/assets/badges/astral_confusion_10.webp":kj,"/src/assets/badges/astral_confusion_25.webp":Cj,"/src/assets/badges/astral_confusion_3.webp":Sj,"/src/assets/badges/astral_confusion_50.webp":Ej,"/src/assets/badges/astral_distraction_10.webp":Tj,"/src/assets/badges/astral_distraction_25.webp":Mj,"/src/assets/badges/astral_distraction_3.webp":Dj,"/src/assets/badges/astral_distraction_50.webp":Aj,"/src/assets/badges/astral_doubt_10.webp":Pj,"/src/assets/badges/astral_doubt_25.webp":Rj,"/src/assets/badges/astral_doubt_3.webp":Ij,"/src/assets/badges/astral_doubt_50.webp":qj,"/src/assets/badges/astral_fear_10.webp":Lj,"/src/assets/badges/astral_fear_25.webp":Oj,"/src/assets/badges/astral_fear_3.webp":Fj,"/src/assets/badges/astral_fear_50.webp":$j,"/src/assets/badges/astral_imbalance_10.webp":Bj,"/src/assets/badges/astral_imbalance_25.webp":Uj,"/src/assets/badges/astral_imbalance_3.webp":Hj,"/src/assets/badges/astral_imbalance_50.webp":zj,"/src/assets/badges/astral_laziness_10.webp":Kj,"/src/assets/badges/astral_laziness_25.webp":Qj,"/src/assets/badges/astral_laziness_3.webp":Wj,"/src/assets/badges/astral_laziness_50.webp":Gj,"/src/assets/badges/astral_overthinking_10.webp":Yj,"/src/assets/badges/astral_overthinking_25.webp":Vj,"/src/assets/badges/astral_overthinking_3.webp":Xj,"/src/assets/badges/astral_overthinking_50.webp":Jj,"/src/assets/badges/astral_stagnation_10.webp":Zj,"/src/assets/badges/astral_stagnation_25.webp":eN,"/src/assets/badges/astral_stagnation_3.webp":tN,"/src/assets/badges/astral_stagnation_50.webp":sN,"/src/assets/badges/astral_vulnerability_10.webp":aN,"/src/assets/badges/astral_vulnerability_25.webp":rN,"/src/assets/badges/astral_vulnerability_3.webp":nN,"/src/assets/badges/astral_vulnerability_50.webp":iN,"/src/assets/badges/attribute_master_body.webp":oN,"/src/assets/badges/attribute_master_mind.webp":lN,"/src/assets/badges/attribute_master_soul.webp":cN,"/src/assets/badges/challenge_5.webp":dN,"/src/assets/badges/challenge_complete.webp":uN,"/src/assets/badges/comeback.webp":mN,"/src/assets/badges/companion_stage_10.webp":pN,"/src/assets/badges/companion_stage_15.webp":hN,"/src/assets/badges/companion_stage_20.webp":fN,"/src/assets/badges/companion_stage_3.webp":gN,"/src/assets/badges/companion_stage_5.webp":xN,"/src/assets/badges/first_check_in.webp":yN,"/src/assets/badges/first_epic.webp":bN,"/src/assets/badges/first_habit.webp":wN,"/src/assets/badges/first_pep_talk.webp":vN,"/src/assets/badges/first_quest.webp":_N,"/src/assets/badges/full_storyline.webp":jN,"/src/assets/badges/month_streak.webp":NN,"/src/assets/badges/pep_talk_listener_10.webp":kN,"/src/assets/badges/pep_talk_listener_50.webp":CN,"/src/assets/badges/perfect_day.webp":SN,"/src/assets/badges/starpath_body_forge.webp":EN,"/src/assets/badges/starpath_clean_machine.webp":TN,"/src/assets/badges/starpath_dawn_champion.webp":MN,"/src/assets/badges/starpath_detox_warrior.webp":DN,"/src/assets/badges/starpath_digital_minimalist.webp":AN,"/src/assets/badges/starpath_iron_mind.webp":PN,"/src/assets/badges/starpath_mindful_master.webp":RN,"/src/assets/badges/starpath_scholars_path.webp":IN,"/src/assets/badges/starpath_sleep_sovereign.webp":qN,"/src/assets/badges/starpath_social_butterfly.webp":LN,"/src/assets/badges/story_exploration.webp":ON,"/src/assets/badges/story_heroes_journey.webp":FN,"/src/assets/badges/story_mystery.webp":$N,"/src/assets/badges/story_pilgrimage.webp":BN,"/src/assets/badges/story_reader.webp":UN,"/src/assets/badges/story_rescue_mission.webp":HN,"/src/assets/badges/story_treasure_hunt.webp":zN,"/src/assets/badges/three_day_streak.webp":KN,"/src/assets/badges/total_attributes.webp":QN,"/src/assets/badges/two_week_streak.webp":WN,"/src/assets/badges/week_streak.webp":GN}),ZN=Object.fromEntries(Object.entries(JN).map(([t,s])=>[(t.split("/").pop()||"").replace(/\.webp$/i,""),s])),e1=()=>{const{user:t}=_e(),[s,a]=n.useState("all"),[r,i]=n.useState(null),{data:o,isLoading:l}=Ee({queryKey:["achievements",t?.id],enabled:!!t,queryFn:async()=>{if(!t?.id)return[];const{data:g,error:y}=await k.from("achievements").select("achievement_type, earned_at").eq("user_id",t.id);if(y)throw y;return g||[]}}),c=n.useMemo(()=>new Set(o?.map(g=>g.achievement_type)||[]),[o]),d=n.useMemo(()=>s==="all"?jn:jn.filter(g=>g.category===s),[s]),u=n.useMemo(()=>d.filter(g=>c.has(g.achievementType)),[d,c]),p=n.useMemo(()=>d.filter(g=>!c.has(g.achievementType)),[d,c]),h=jn.filter(g=>c.has(g.achievementType)).length,f=jn.length,m=["all","streaks","companion","starpaths","firsts","special"];return l?e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsx(Ce,{className:"h-24 w-full"}),e.jsx(Ce,{className:"h-12 w-full"}),e.jsx(Ce,{className:"h-48 w-full"})]}):e.jsxs("div",{className:"space-y-6 mt-6",children:[e.jsxs(Xe,{className:"p-6 bg-gradient-to-br from-primary/10 to-accent/10 border-primary/20",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(bo,{className:"h-6 w-6 text-primary"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Your Badges"})]}),e.jsxs("p",{className:"text-2xl font-bold",children:[e.jsx("span",{className:"text-primary",children:h}),e.jsxs("span",{className:"text-muted-foreground text-lg font-normal",children:[" / ",f," collected"]})]})]}),e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 scrollbar-hide",children:m.map(g=>e.jsx("button",{onClick:()=>a(g),className:`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${s===g?"bg-primary text-primary-foreground":"bg-secondary/50 text-muted-foreground hover:bg-secondary"}`,children:g==="all"?"All":XN[g]},g))}),u.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"text-sm font-semibold text-muted-foreground flex items-center gap-2",children:[e.jsx("span",{className:"text-primary",children:"âœ¨"})," EARNED (",u.length,")"]}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 gap-3",children:u.map(g=>e.jsx($c,{badge:g,earned:!0,onSelect:y=>i({badge:y,earned:!0})},g.id))})]}),p.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"text-sm font-semibold text-muted-foreground flex items-center gap-2",children:[e.jsx(Yn,{className:"h-4 w-4"})," LOCKED (",p.length,")"]}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 gap-3",children:p.map(g=>e.jsx($c,{badge:g,earned:!1,onSelect:y=>i({badge:y,earned:!1})},g.id))})]}),d.length===0&&e.jsxs(Xe,{className:"p-8 text-center",children:[e.jsx(bo,{className:"h-12 w-12 mx-auto mb-3 text-muted-foreground/50"}),e.jsx("p",{className:"text-muted-foreground",children:"No badges in this category yet"})]}),e.jsx(as,{open:!!r,onOpenChange:()=>i(null),children:e.jsxs(Qt,{className:"max-w-[300px] rounded-xl",children:[e.jsx(Is,{children:e.jsx(ps,{className:"text-center",children:r?.earned?r.badge.title:"Locked Badge"})}),r&&e.jsxs("div",{className:"text-center space-y-4 py-2",children:[e.jsx("div",{className:`text-6xl ${r.earned?"":"grayscale"}`,children:r.earned?e.jsx(zp,{badge:r.badge,className:"h-16 w-16 rounded-xl mx-auto"}):"ðŸ”’"}),r.earned?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-muted-foreground",children:r.badge.description}),e.jsx(Oe,{className:`capitalize bg-gradient-to-br ${Hp[r.badge.tier]} text-white border-0`,children:r.badge.tier})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"How to unlock:"}),e.jsx("p",{className:"text-muted-foreground",children:r.badge.unlockHint})]})]})]})})]})},$c=({badge:t,earned:s,onSelect:a})=>{const r=Hp[t.tier];return e.jsxs(Xe,{onClick:()=>a(t),className:`relative p-3 text-center transition-all cursor-pointer active:scale-95 ${s?"bg-gradient-to-br from-primary/10 to-accent/10 border-primary/30 hover:border-primary/50":"bg-secondary/30 border-border/50 opacity-60 hover:opacity-80"}`,children:[e.jsx("div",{className:`text-3xl mb-2 ${s?"":"grayscale"}`,children:s?e.jsx(zp,{badge:t,className:"h-10 w-10 rounded-lg mx-auto"}):"ðŸ”’"}),e.jsx("p",{className:`text-xs font-medium line-clamp-2 ${s?"text-foreground":"text-muted-foreground"}`,children:s?t.title:"???"}),s&&e.jsx("div",{className:`absolute top-1 right-1 w-2 h-2 rounded-full bg-gradient-to-br ${r}`})]})},zp=({badge:t,className:s})=>{const a=ZN[t.id]||t.image_url||null;return a?e.jsx("img",{src:a,alt:t.title,className:s,loading:"lazy",decoding:"async"}):e.jsx("span",{className:`inline-flex items-center justify-center ${s??""}`,children:t.icon})},Kp=()=>{const t=n.useCallback(()=>{gt.light()},[]),s=n.useCallback(()=>{gt.medium()},[]),a=n.useCallback(()=>{gt.heavy()},[]),r=n.useCallback(()=>{gt.success()},[]),i=n.useCallback(()=>{gt.error()},[]),o=n.useCallback(()=>{gt.light()},[]),l=n.useCallback(()=>{gt.medium()},[]),c=n.useCallback(()=>{gt.success()},[]),d=n.useCallback(()=>{gt.error()},[]),u=n.useCallback(p=>{p?gt.light():gt.medium()},[]);return{light:t,medium:s,heavy:a,success:r,error:i,tap:o,press:l,complete:c,fail:d,toggle:u}},t1=({cssEffect:t,className:s})=>{const{cornerStyle:a,glowColor:r,glowAnimation:i}=t;if(!a)return null;const o=i==="pulse"?"animate-frame-pulse":i==="breathe"?"animate-frame-breathe":i==="flicker"?"animate-frame-flicker":"";return e.jsxs("div",{className:I("absolute inset-0 pointer-events-none z-30",s),children:[e.jsx(Nn,{position:"top-left",cornerStyle:a,glowColor:r,glowClass:o}),e.jsx(Nn,{position:"top-right",cornerStyle:a,glowColor:r,glowClass:o}),e.jsx(Nn,{position:"bottom-left",cornerStyle:a,glowColor:r,glowClass:o}),e.jsx(Nn,{position:"bottom-right",cornerStyle:a,glowColor:r,glowClass:o})]})},Nn=({position:t,cornerStyle:s,glowColor:a,glowClass:r})=>{const i={"top-left":"top-0 left-0","top-right":"top-0 right-0","bottom-left":"bottom-0 left-0","bottom-right":"bottom-0 right-0"},o={"top-left":"rotate-0","top-right":"rotate-90","bottom-left":"-rotate-90","bottom-right":"rotate-180"},l=s1(s,a);return e.jsx("div",{className:I("absolute w-14 h-14",i[t],o[t],r),style:{filter:a?`drop-shadow(0 0 6px ${a})`:void 0},children:l})},s1=(t,s)=>{const a=s||"hsl(var(--primary))";switch(t){case"ornate":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 4 L20 4 Q28 4 28 12 L28 20 Q28 28 20 28 L12 28 Q4 28 4 20 Z",fill:"none",stroke:a,strokeWidth:"2",className:"animate-frame-shimmer"}),e.jsx("circle",{cx:"8",cy:"8",r:"3",fill:a}),e.jsx("path",{d:"M12 4 Q16 8 12 12 Q8 8 12 4",fill:a,opacity:"0.6"})]});case"crystal":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("polygon",{points:"4,4 20,4 4,20",fill:a,opacity:"0.3"}),e.jsx("polygon",{points:"4,4 16,4 4,16",fill:a,opacity:"0.5"}),e.jsx("polygon",{points:"4,4 12,4 4,12",fill:a,opacity:"0.7"}),e.jsx("line",{x1:"4",y1:"4",x2:"24",y2:"24",stroke:a,strokeWidth:"1",opacity:"0.4"})]});case"flame":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M8 28 Q8 16 16 8 Q12 16 16 20 Q16 12 24 8 Q20 16 20 24 Q28 16 28 8",fill:"none",stroke:a,strokeWidth:"2",className:"animate-frame-flicker"}),e.jsx("circle",{cx:"12",cy:"20",r:"2",fill:a,opacity:"0.8"}),e.jsx("circle",{cx:"20",cy:"12",r:"1.5",fill:a,opacity:"0.6"})]});case"circuit":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 24 L4 8 L8 4 L24 4",fill:"none",stroke:a,strokeWidth:"2"}),e.jsx("circle",{cx:"8",cy:"8",r:"3",fill:a}),e.jsx("path",{d:"M8 16 L16 16 L16 8",fill:"none",stroke:a,strokeWidth:"1.5",opacity:"0.6"}),e.jsx("circle",{cx:"16",cy:"16",r:"2",fill:a,opacity:"0.6"})]});case"scale":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("ellipse",{cx:"8",cy:"8",rx:"6",ry:"4",fill:a,opacity:"0.3",transform:"rotate(-45 8 8)"}),e.jsx("ellipse",{cx:"16",cy:"8",rx:"6",ry:"4",fill:a,opacity:"0.4",transform:"rotate(-45 16 8)"}),e.jsx("ellipse",{cx:"8",cy:"16",rx:"6",ry:"4",fill:a,opacity:"0.4",transform:"rotate(-45 8 16)"}),e.jsx("ellipse",{cx:"16",cy:"16",rx:"6",ry:"4",fill:a,opacity:"0.5",transform:"rotate(-45 16 16)"})]});case"deity":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 4 C12 4 16 8 20 4 C16 12 20 16 16 24 L8 28 L4 20 Z",fill:a,opacity:"0.4"}),e.jsx("circle",{cx:"12",cy:"12",r:"4",fill:a,opacity:"0.7"}),e.jsx("path",{d:"M4 8 L8 4 M8 8 L12 4 M12 8 L16 4",stroke:a,strokeWidth:"1",opacity:"0.5"})]});case"dimensional":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"dimGrad",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"hsl(300, 80%, 55%)"}),e.jsx("stop",{offset:"50%",stopColor:"hsl(180, 80%, 55%)"}),e.jsx("stop",{offset:"100%",stopColor:"hsl(60, 80%, 55%)"})]})}),e.jsx("path",{d:"M4 4 L24 4 M4 4 L4 24",stroke:"url(#dimGrad)",strokeWidth:"3",className:"animate-frame-shift"}),e.jsx("polygon",{points:"4,4 12,8 8,12",fill:"url(#dimGrad)",opacity:"0.6"}),e.jsx("circle",{cx:"16",cy:"16",r:"3",fill:"url(#dimGrad)",opacity:"0.4"})]});case"treasure":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 16 L4 4 L16 4",fill:"none",stroke:a,strokeWidth:"3"}),e.jsx("polygon",{points:"8,8 12,4 16,8 12,12",fill:a}),e.jsx("circle",{cx:"12",cy:"8",r:"2",fill:"hsl(45, 100%, 80%)"})]});case"mystery":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("circle",{cx:"16",cy:"16",r:"10",fill:"none",stroke:a,strokeWidth:"2",opacity:"0.4"}),e.jsx("circle",{cx:"16",cy:"16",r:"6",fill:"none",stroke:a,strokeWidth:"2",opacity:"0.6"}),e.jsx("line",{x1:"4",y1:"4",x2:"10",y2:"10",stroke:a,strokeWidth:"3"}),e.jsx("circle",{cx:"6",cy:"6",r:"3",fill:a})]});case"lotus":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("ellipse",{cx:"12",cy:"16",rx:"6",ry:"10",fill:a,opacity:"0.3",transform:"rotate(-30 12 16)"}),e.jsx("ellipse",{cx:"16",cy:"12",rx:"6",ry:"10",fill:a,opacity:"0.4",transform:"rotate(-60 16 12)"}),e.jsx("circle",{cx:"10",cy:"10",r:"4",fill:a,opacity:"0.6"})]});case"heroic":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 4 L4 20 L8 24 L12 20 L12 8 L20 4 L4 4",fill:a,opacity:"0.4"}),e.jsx("path",{d:"M8 8 L8 16 L12 12 L12 8 Z",fill:a,opacity:"0.6"}),e.jsx("line",{x1:"8",y1:"4",x2:"8",y2:"12",stroke:a,strokeWidth:"2"})]});case"shield":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M12 4 L4 8 L4 20 L12 28 L20 20 L20 8 L12 4",fill:a,opacity:"0.3"}),e.jsx("path",{d:"M12 8 L8 10 L8 18 L12 22 L16 18 L16 10 Z",fill:a,opacity:"0.5"})]});case"compass":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("circle",{cx:"16",cy:"16",r:"12",fill:"none",stroke:a,strokeWidth:"1",opacity:"0.3"}),e.jsx("line",{x1:"16",y1:"4",x2:"16",y2:"28",stroke:a,strokeWidth:"1",opacity:"0.4"}),e.jsx("line",{x1:"4",y1:"16",x2:"28",y2:"16",stroke:a,strokeWidth:"1",opacity:"0.4"}),e.jsx("polygon",{points:"16,8 14,16 16,14 18,16",fill:a}),e.jsx("circle",{cx:"16",cy:"16",r:"2",fill:a})]});default:return e.jsx("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:e.jsx("path",{d:"M4 20 L4 4 L20 4",fill:"none",stroke:a,strokeWidth:"2"})})}},to={Common:"from-gray-400 to-gray-600",Rare:"from-blue-400 to-blue-600",Epic:"from-purple-400 to-purple-600",Legendary:"from-amber-400 to-amber-600",Mythic:"from-pink-500 to-rose-600",Celestial:"from-cyan-400 to-blue-500",Primal:"from-emerald-400 to-teal-600",Origin:"from-violet-500 to-fuchsia-600"},Bc={fire:"ðŸ”¥",water:"ðŸ’§",earth:"ðŸª¨",air:"ðŸ’¨",lightning:"âš¡",ice:"â„ï¸",nature:"ðŸŒ¿",shadow:"ðŸŒ‘",light:"âœ¨"},a1=t=>t<=9?1:t<=14?2:3,Qp=["vitality","wisdom","discipline","resolve","creativity","alignment"],Uc="Legacy card: regenerate to view 6 attributes.",r1=t=>{if(!t||typeof t!="object"||Array.isArray(t))return null;const s=t,a={};for(const r of Qp){const i=s[r];if(typeof i!="number"||Number.isNaN(i))return null;a[r]=i}return a};function n1({card:t,equippedFrame:s}){const[a,r]=n.useState(!1),[i,o]=n.useState(!1),{tap:l}=Kp(),c=n.useRef(null),d=n.useMemo(()=>r1(t.stats),[t.stats]),u=n.useMemo(()=>d?Qp.map(x=>({key:x,icon:$n[x].icon,name:$n[x].name,value:d[x]})):[],[d]),p=t.energy_cost??a1(t.evolution_stage),h=t.bond_level??null,f=()=>{l(),r(!0),o(!1)},m=x=>{x.stopPropagation(),l(),o(!i)},g=async x=>{x.stopPropagation(),c.current&&await Cw(c.current,`cosmiq-${t.creature_name.toLowerCase().replace(/\s+/g,"-")}-stage-${t.evolution_stage}.png`,{title:`${t.creature_name} - Cosmiq`,text:`Check out my ${t.creature_name}! âœ¨ #Cosmiq`,dialogTitle:"Share Companion Card"})},y=s&&s.cornerStyle,b=s?.glowAnimation==="pulse"?"animate-frame-pulse":s?.glowAnimation==="breathe"?"animate-frame-breathe":s?.glowAnimation==="flicker"?"animate-frame-flicker":s?.glowAnimation==="shift"?"animate-frame-shift":"",w=s?{borderColor:s.gradientBorder?"transparent":s.borderColor,borderWidth:s.borderWidth||"8px",borderStyle:s.borderStyle||"solid",boxShadow:s.glowColor?`0 0 20px ${s.glowColor}, 0 0 40px ${s.glowColor}40`:void 0}:{};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"relative h-[280px] cursor-pointer rounded-xl overflow-hidden",onClick:f,role:"button",tabIndex:0,"aria-label":`Open ${t.creature_name} companion card`,children:e.jsx("div",{className:`h-full rounded-xl border-2 bg-gradient-to-br ${to[t.rarity]} p-[2px] shadow-lg`,children:e.jsxs("div",{className:"h-full rounded-lg bg-card relative overflow-hidden",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.creature_name,className:"absolute inset-0 w-full h-full object-cover",loading:"lazy",decoding:"async"}):e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-muted/50 to-muted flex items-center justify-center text-muted-foreground text-xs",children:"No Image"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"}),e.jsx(Oe,{className:"absolute top-2 left-2 bg-background/90 backdrop-blur-sm text-xs",children:Bc[t.element.toLowerCase()]||"âœ¨"}),e.jsxs(Oe,{className:"absolute top-2 right-2 bg-background/90 backdrop-blur-sm text-xs",children:["Stage ",t.evolution_stage]}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-3 space-y-2",children:[e.jsx("h3",{className:"font-bold text-sm text-white drop-shadow-lg",children:t.creature_name}),e.jsxs("div",{className:"flex items-center justify-between text-[10px] text-white/80 bg-black/30 rounded-md px-2 py-1",children:[e.jsxs("span",{className:"flex items-center gap-1",children:["âš¡",e.jsx("span",{className:"font-semibold",children:p})]}),h!==null&&e.jsxs("span",{className:"flex items-center gap-1",children:["ðŸ¤ ",e.jsx("span",{className:"font-semibold",children:h})]})]}),d?e.jsx("div",{className:"grid grid-cols-2 gap-1 text-[9px] bg-black/40 backdrop-blur-sm rounded-lg p-2",children:u.map(x=>e.jsxs("div",{className:"flex items-center justify-between gap-1 text-white/90 rounded bg-black/20 px-1.5 py-0.5",children:[e.jsxs("span",{className:"truncate",children:[x.icon," ",x.name]}),e.jsx("span",{className:"font-semibold",children:x.value})]},x.key))}):e.jsx("div",{"data-testid":"legacy-stats-message",className:"text-[10px] text-white/85 bg-black/40 backdrop-blur-sm rounded-lg p-2 text-center leading-snug",children:Uc})]})]})})}),e.jsx(as,{open:a,onOpenChange:x=>{r(x),x||o(!1)},children:e.jsxs(Qt,{className:"max-w-[95vw] max-h-[95vh] p-0 bg-transparent border-0 overflow-hidden",children:[e.jsxs(ps,{className:"sr-only",children:[t.creature_name," - Evolution Card"]}),e.jsxs(Vs,{className:"sr-only",children:["Detailed view of ",t.creature_name,", a ",t.rarity," ",t.element," ",t.species," at evolution stage ",t.evolution_stage]}),e.jsx("div",{className:"absolute inset-0 z-40",onClick:()=>r(!1)}),e.jsxs("div",{className:"relative w-full h-[80vh] flex items-center justify-center",children:[e.jsx("button",{onClick:g,className:"absolute top-4 right-20 z-50 p-3 rounded-full bg-black/70 backdrop-blur-sm text-white hover:bg-black/90 active:bg-black transition-colors touch-manipulation","aria-label":"Share companion card",children:e.jsx(fu,{className:"w-6 h-6"})}),e.jsx("button",{onClick:x=>{x.stopPropagation(),r(!1)},className:"absolute top-4 right-4 z-50 p-3 rounded-full bg-black/70 backdrop-blur-sm text-white hover:bg-black/90 active:bg-black transition-colors touch-manipulation","aria-label":"Close companion card",children:e.jsx(kt,{className:"w-6 h-6"})}),e.jsx("div",{className:"relative w-full max-w-[320px] aspect-[2.5/3.5] cursor-pointer perspective-1000",onClick:m,"data-testid":"evolution-card-flip-target",children:e.jsxs(P.div,{className:"relative w-full h-full preserve-3d",animate:{rotateY:i?180:0},transition:{duration:.6,type:"spring"},"data-testid":"evolution-card-inner","data-flipped":i,children:[e.jsx("div",{className:"absolute w-full h-full backface-hidden",style:{transform:"rotateY(0deg)"},children:e.jsxs("div",{ref:c,className:I("h-full rounded-2xl p-0 shadow-2xl overflow-hidden relative",y?b:`border-[8px] bg-gradient-to-br ${to[t.rarity]}`,s?.shimmer&&"animate-frame-shimmer",s?.animatedGradient&&"animate-gradient-border"),style:y?w:{},children:[s?.gradientBorder&&e.jsx("div",{className:I("absolute inset-0 rounded-2xl -z-10",s.animatedGradient&&"animate-gradient-border"),style:{background:s.gradientBorder,backgroundSize:"200% 200%"}}),y&&s?e.jsx(t1,{cssEffect:s}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"absolute top-0 left-0 w-12 h-12 z-30 pointer-events-none backface-hidden",children:[e.jsx("div",{className:"absolute inset-0 border-t-2 border-l-2 border-white/40 rounded-tl-xl"}),e.jsx("div",{className:"absolute top-1 left-1 w-8 h-8 border-t border-l border-white/20 rounded-tl-lg"})]}),e.jsxs("div",{className:"absolute top-0 right-0 w-12 h-12 z-30 pointer-events-none backface-hidden",children:[e.jsx("div",{className:"absolute inset-0 border-t-2 border-r-2 border-white/40 rounded-tr-xl"}),e.jsx("div",{className:"absolute top-1 right-1 w-8 h-8 border-t border-r border-white/20 rounded-tr-lg"})]}),e.jsxs("div",{className:"absolute bottom-0 left-0 w-12 h-12 z-30 pointer-events-none backface-hidden",children:[e.jsx("div",{className:"absolute inset-0 border-b-2 border-l-2 border-white/40 rounded-bl-xl"}),e.jsx("div",{className:"absolute bottom-1 left-1 w-8 h-8 border-b border-l border-white/20 rounded-bl-lg"})]}),e.jsxs("div",{className:"absolute bottom-0 right-0 w-12 h-12 z-30 pointer-events-none backface-hidden",children:[e.jsx("div",{className:"absolute inset-0 border-b-2 border-r-2 border-white/40 rounded-br-xl"}),e.jsx("div",{className:"absolute bottom-1 right-1 w-8 h-8 border-b border-r border-white/20 rounded-br-lg"})]})]}),s?.shimmer&&e.jsx("div",{className:"absolute inset-0 pointer-events-none z-20 overflow-hidden rounded-2xl",children:e.jsx("div",{className:"absolute inset-0 animate-frame-shimmer bg-gradient-to-r from-transparent via-white/20 to-transparent",style:{transform:"skewX(-20deg)",width:"200%",marginLeft:"-50%"}})}),e.jsx("div",{className:"absolute inset-2 border border-white/20 rounded-lg z-20 pointer-events-none backface-hidden"}),e.jsxs("div",{className:"h-full rounded-xl relative overflow-hidden",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.creature_name,className:"absolute inset-0 w-full h-full object-cover",loading:"lazy",decoding:"async"}):e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-muted/50 to-muted flex items-center justify-center",children:"No Image"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-black/60"}),e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center justify-between p-3",children:[e.jsxs(Oe,{className:"bg-black/70 backdrop-blur-sm text-white text-sm px-3 py-1 border border-white/20",children:[Bc[t.element.toLowerCase()]||"âœ¨"," ",t.element]}),e.jsxs(Oe,{className:"bg-black/70 backdrop-blur-sm text-white text-sm px-3 py-1 border border-white/20",children:["Stage ",t.evolution_stage]})]}),e.jsx("div",{className:"absolute top-14 left-2 right-2 z-10",children:d?e.jsx("div",{className:"grid grid-cols-2 gap-1",children:u.map(x=>e.jsxs("div",{className:"bg-black/45 backdrop-blur-sm rounded px-1.5 py-0.5 flex items-center justify-between gap-1 text-white/85 text-[9px] border border-white/10",children:[e.jsxs("span",{className:"truncate",children:[x.icon," ",x.name]}),e.jsx("span",{className:"font-medium",children:x.value})]},x.key))}):e.jsx("div",{"data-testid":"legacy-stats-message-modal",className:"bg-black/45 backdrop-blur-sm rounded px-2 py-1 text-[10px] text-white/85 border border-white/10 text-center",children:Uc})}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 z-10 p-4 space-y-2 pb-12 backface-hidden",children:[e.jsxs("h3",{className:"font-bold text-2xl text-center text-white drop-shadow-[0_2px_8px_rgba(0,0,0,0.8)] tracking-wide",children:["â˜… ",t.creature_name.toUpperCase()," â˜…"]}),e.jsxs("div",{className:"text-sm text-center text-white/90 drop-shadow-lg",children:["Stage ",t.evolution_stage," â€¢ ",t.rarity]})]})]}),e.jsx("div",{className:"absolute bottom-0 left-1/2 -translate-x-1/2 z-30 flex items-center justify-center backface-hidden",children:e.jsxs("div",{className:"relative px-6 py-2",children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 w-4 h-[2px] bg-gradient-to-r from-transparent to-white/60"}),e.jsx("div",{className:"absolute right-0 top-1/2 -translate-y-1/2 w-4 h-[2px] bg-gradient-to-l from-transparent to-white/60"}),e.jsx("span",{className:"text-[11px] font-bold tracking-[0.3em] text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] relative z-10",children:"âœ¦ COSMIQ âœ¦"})]})})]})}),e.jsx("div",{className:"absolute w-full h-full backface-hidden rotate-y-180",children:e.jsx("div",{className:`h-full rounded-2xl border-4 bg-gradient-to-br ${to[t.rarity]} p-1 shadow-2xl`,children:e.jsx("div",{className:"h-full rounded-xl bg-card p-6 flex flex-col overflow-hidden",children:e.jsxs("div",{className:"space-y-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"text-center pb-4 border-b border-border",children:[e.jsx("h3",{className:"font-bold text-xl",children:t.creature_name}),e.jsxs("p",{className:"text-sm text-muted-foreground capitalize mt-1",children:[t.species," of ",t.element]})]}),t.traits&&t.traits.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold mb-2 text-primary",children:"Traits"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.traits.map((x,v)=>e.jsx(Oe,{variant:"secondary",className:"text-xs",children:x},v))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold mb-2 text-primary",children:"Lore"}),e.jsx("p",{className:"text-sm text-muted-foreground leading-relaxed",children:t.story_text})]})]})})})})]})})]})]})})]})}const Wp=n.memo(()=>{const{user:t}=_e(),{data:s,isLoading:a}=Ee({queryKey:["evolution-cards",t?.id],queryFn:async()=>{if(!t)return[];const{data:r,error:i}=await k.from("companion_evolution_cards").select("*").eq("user_id",t.id).order("evolution_stage",{ascending:!0});if(i)throw i;const o=(r||[]).map(p=>p.evolution_id).filter(p=>!!p);let l={};if(o.length>0){const{data:p,error:h}=await k.from("companion_evolutions").select("id, image_url").in("id",o);if(h)throw h;l=(p||[]).reduce((f,m)=>(f[m.id]=m.image_url??null,f),{})}const c=(r||[]).map(p=>{const h=p.image_url,f=p.evolution_id?l[p.evolution_id]:null;return{...p,image_url:h||f}}),d=new Map;return c.forEach(p=>{d.has(p.card_id)||d.set(p.card_id,p)}),Array.from(d.values())},enabled:!!t,staleTime:300*1e3});return a?e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[1,2,3].map(r=>e.jsx(Ce,{className:"h-[280px] rounded-xl"},r))}):!s||s.length===0?e.jsxs(Xe,{className:"p-8 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx(be,{className:"h-12 w-12 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Evolution Cards Yet"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Cards are created when your companion evolves. Keep growing to unlock your first card!"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:"Your Collection"}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:s.map(r=>e.jsx(n1,{card:r},r.id))})]})});Wp.displayName="EvolutionCardGallery";const i1="/assets/08b0e4b0-ad2f-4bf7-b65a-57c44db6011a-5xXT2NJl.webp",o1="/assets/08f5ef23-5c12-4dba-bfa2-abeed471c4d9-DATwsUdw.webp",l1="/assets/0a598103-1816-41bd-a4d3-ab77fb2b4c35-CzCtU4Ii.webp",c1="/assets/0d243dd3-38a3-48de-86ba-30dbfe2338b6-BnC0Ixdz.webp",d1="/assets/0d592bd4-d3c4-4d0a-8682-b6571275777d-CvTgxHAU.webp",u1="/assets/1374d56f-9d88-489a-9215-958d90278724-CTHLhlYI.webp",m1="/assets/1374d56f-9d88-489a-9215-958d90278724-CTHLhlYI.webp",p1="/assets/08b0e4b0-ad2f-4bf7-b65a-57c44db6011a-5xXT2NJl.webp",h1="/assets/2a49ccd0-4e1a-4137-a50e-21239c88bd07-Dsf-Ej5y.webp",f1="/assets/0a598103-1816-41bd-a4d3-ab77fb2b4c35-CzCtU4Ii.webp",g1="/assets/421ca3b4-c0e6-4cfc-867a-12fb6485ecd3-ZF2hPZQ1.webp",x1="/assets/1374d56f-9d88-489a-9215-958d90278724-CTHLhlYI.webp",y1="/assets/08b0e4b0-ad2f-4bf7-b65a-57c44db6011a-5xXT2NJl.webp",b1="/assets/4f98cd81-76a7-4b45-8961-95883ccf3d82-BIH3E5Cl.webp",w1="/assets/08f5ef23-5c12-4dba-bfa2-abeed471c4d9-DATwsUdw.webp",v1="/assets/628e85bf-2beb-45e0-83ed-9f284dbab8f0-BX9PjFx-.webp",_1="/assets/08f5ef23-5c12-4dba-bfa2-abeed471c4d9-DATwsUdw.webp",j1="/assets/421ca3b4-c0e6-4cfc-867a-12fb6485ecd3-ZF2hPZQ1.webp",N1="/assets/67b8628c-92bd-4d2b-b2c0-69650c4a59b4-DyBuli4O.webp",k1="/assets/08b0e4b0-ad2f-4bf7-b65a-57c44db6011a-5xXT2NJl.webp",C1="/assets/2a49ccd0-4e1a-4137-a50e-21239c88bd07-Dsf-Ej5y.webp",S1="/assets/67b8628c-92bd-4d2b-b2c0-69650c4a59b4-DyBuli4O.webp",E1="/assets/1374d56f-9d88-489a-9215-958d90278724-CTHLhlYI.webp",T1="/assets/08f5ef23-5c12-4dba-bfa2-abeed471c4d9-DATwsUdw.webp",M1="/assets/85ae62ba-6b30-4ed0-8a89-84aceba7c0d3-CuIw1PPE.webp",D1="/assets/4f98cd81-76a7-4b45-8961-95883ccf3d82-BIH3E5Cl.webp",A1="/assets/89672d4a-a837-48b8-ad55-bbde78c9d079-0nuRLcd-.webp",P1="/assets/08b0e4b0-ad2f-4bf7-b65a-57c44db6011a-5xXT2NJl.webp",R1="/assets/93eeea63-4d51-4dd8-8e78-5d60460fa54d-D_drjD2S.webp",I1="/assets/08b0e4b0-ad2f-4bf7-b65a-57c44db6011a-5xXT2NJl.webp",q1="/assets/9d0414de-c952-49dc-8604-574d5103df20-CcfN7Wfk.webp",L1="/assets/67b8628c-92bd-4d2b-b2c0-69650c4a59b4-DyBuli4O.webp",O1="/assets/2a49ccd0-4e1a-4137-a50e-21239c88bd07-Dsf-Ej5y.webp",F1="/assets/a1babd23-e642-4b40-814b-3be95d0c27df-gtRc73WU.webp",$1="/assets/08b0e4b0-ad2f-4bf7-b65a-57c44db6011a-5xXT2NJl.webp",B1="/assets/1374d56f-9d88-489a-9215-958d90278724-CTHLhlYI.webp",U1="/assets/85ae62ba-6b30-4ed0-8a89-84aceba7c0d3-CuIw1PPE.webp",H1="/assets/a1babd23-e642-4b40-814b-3be95d0c27df-gtRc73WU.webp",z1="/assets/08b0e4b0-ad2f-4bf7-b65a-57c44db6011a-5xXT2NJl.webp",K1="/assets/9d0414de-c952-49dc-8604-574d5103df20-CcfN7Wfk.webp",Q1="/assets/9d0414de-c952-49dc-8604-574d5103df20-CcfN7Wfk.webp",W1="/assets/89672d4a-a837-48b8-ad55-bbde78c9d079-0nuRLcd-.webp",G1="/assets/1374d56f-9d88-489a-9215-958d90278724-CTHLhlYI.webp",Y1="/assets/9d0414de-c952-49dc-8604-574d5103df20-CcfN7Wfk.webp",V1="/assets/421ca3b4-c0e6-4cfc-867a-12fb6485ecd3-ZF2hPZQ1.webp",X1="/assets/0d243dd3-38a3-48de-86ba-30dbfe2338b6-BnC0Ixdz.webp",J1="/assets/4f98cd81-76a7-4b45-8961-95883ccf3d82-BIH3E5Cl.webp",Z1="/assets/08f5ef23-5c12-4dba-bfa2-abeed471c4d9-DATwsUdw.webp",ek="/assets/08f5ef23-5c12-4dba-bfa2-abeed471c4d9-DATwsUdw.webp",tk="/assets/421ca3b4-c0e6-4cfc-867a-12fb6485ecd3-ZF2hPZQ1.webp",sk="/assets/4f98cd81-76a7-4b45-8961-95883ccf3d82-BIH3E5Cl.webp",ak="/assets/421ca3b4-c0e6-4cfc-867a-12fb6485ecd3-ZF2hPZQ1.webp",rk="/assets/0a598103-1816-41bd-a4d3-ab77fb2b4c35-CzCtU4Ii.webp",nk="/assets/85ae62ba-6b30-4ed0-8a89-84aceba7c0d3-CuIw1PPE.webp",ik="/assets/2a49ccd0-4e1a-4137-a50e-21239c88bd07-Dsf-Ej5y.webp",ok="/assets/85ae62ba-6b30-4ed0-8a89-84aceba7c0d3-CuIw1PPE.webp",lk={background:Pg,frame:Ag,effect:ia,artifact:Dg},kn={background:"Backgrounds",frame:"Frames",effect:"Effects",artifact:"Artifacts"},ck=Object.assign({"/src/assets/rewards/08b0e4b0-ad2f-4bf7-b65a-57c44db6011a.webp":i1,"/src/assets/rewards/08f5ef23-5c12-4dba-bfa2-abeed471c4d9.webp":o1,"/src/assets/rewards/0a598103-1816-41bd-a4d3-ab77fb2b4c35.webp":l1,"/src/assets/rewards/0d243dd3-38a3-48de-86ba-30dbfe2338b6.webp":c1,"/src/assets/rewards/0d592bd4-d3c4-4d0a-8682-b6571275777d.webp":d1,"/src/assets/rewards/1374d56f-9d88-489a-9215-958d90278724.webp":u1,"/src/assets/rewards/21fa6b1f-c55e-4f41-b032-d24c4b9f664d.webp":m1,"/src/assets/rewards/259d22ce-3382-4a49-b73f-adee68885af6.webp":p1,"/src/assets/rewards/2a49ccd0-4e1a-4137-a50e-21239c88bd07.webp":h1,"/src/assets/rewards/34a9772d-9e67-4622-9532-513e4e936d5e.webp":f1,"/src/assets/rewards/421ca3b4-c0e6-4cfc-867a-12fb6485ecd3.webp":g1,"/src/assets/rewards/443cdb1f-9b19-4480-a00b-1d50f54127ad.webp":x1,"/src/assets/rewards/44a034b2-083f-4317-b8e6-5b46142686a3.webp":y1,"/src/assets/rewards/4f98cd81-76a7-4b45-8961-95883ccf3d82.webp":b1,"/src/assets/rewards/5621e964-2e9c-4c70-a809-0485f348740e.webp":w1,"/src/assets/rewards/628e85bf-2beb-45e0-83ed-9f284dbab8f0.webp":v1,"/src/assets/rewards/63bcee48-b290-490f-b434-5abea53da5d6.webp":_1,"/src/assets/rewards/645f3303-ea17-4f5b-b66f-c770b32d3187.webp":j1,"/src/assets/rewards/67b8628c-92bd-4d2b-b2c0-69650c4a59b4.webp":N1,"/src/assets/rewards/6be89d84-2085-4a2f-89e6-d6fce01cdfa6.webp":k1,"/src/assets/rewards/7b7d09d4-afa1-408b-91cb-ca31948836d1.webp":C1,"/src/assets/rewards/7c360e47-ea7b-4d0c-8eee-26dd2636f113.webp":S1,"/src/assets/rewards/803e2bef-8ddb-4974-bc5c-6d7d830695f9.webp":E1,"/src/assets/rewards/84071e6c-0379-463c-a72a-2b0458c38105.webp":T1,"/src/assets/rewards/85ae62ba-6b30-4ed0-8a89-84aceba7c0d3.webp":M1,"/src/assets/rewards/87eaaa2e-b19f-4720-a340-2d29729e5877.webp":D1,"/src/assets/rewards/89672d4a-a837-48b8-ad55-bbde78c9d079.webp":A1,"/src/assets/rewards/92a6c51c-0ce4-4de3-a6a3-34665f6ca776.webp":P1,"/src/assets/rewards/93eeea63-4d51-4dd8-8e78-5d60460fa54d.webp":R1,"/src/assets/rewards/965b073f-4363-4e20-b744-3a341d704154.webp":I1,"/src/assets/rewards/9d0414de-c952-49dc-8604-574d5103df20.webp":q1,"/src/assets/rewards/a0493985-892c-41ce-a56e-d133b060f639.webp":L1,"/src/assets/rewards/a1198277-2ccc-4402-975d-0c75ae47e320.webp":O1,"/src/assets/rewards/a1babd23-e642-4b40-814b-3be95d0c27df.webp":F1,"/src/assets/rewards/a4b93e2b-f714-4409-9ada-c15431ccc4c2.webp":$1,"/src/assets/rewards/a5174218-e6f1-4a9d-85b4-34ad12a0173c.webp":B1,"/src/assets/rewards/abd95104-6b95-4052-92a4-70811f492315.webp":U1,"/src/assets/rewards/aca5fba0-50da-4888-b931-d166c31f30e8.webp":H1,"/src/assets/rewards/afcca42a-5069-44bb-a748-0b1446961c28.webp":z1,"/src/assets/rewards/b762e7dd-6d58-44d9-bcaf-9f7d5220032d.webp":K1,"/src/assets/rewards/b8e22263-ddbf-417b-936a-ee7e55d5d618.webp":Q1,"/src/assets/rewards/bbcf195f-872c-42cd-a920-ba381e44488a.webp":W1,"/src/assets/rewards/c183c4b1-e498-4301-815d-c903cc6c81c4.webp":G1,"/src/assets/rewards/c5840e60-eae3-4531-9e6f-b3555cb43d45.webp":Y1,"/src/assets/rewards/d3f0433d-8569-44e8-89cd-1b385cb2185e.webp":V1,"/src/assets/rewards/d5ae6487-b65f-48fa-bda7-cd66dc595e9b.webp":X1,"/src/assets/rewards/d9ae63ad-55d3-4cb9-a427-5b0e89e78fd5.webp":J1,"/src/assets/rewards/e3b35fa1-1479-4081-b721-ffe3a1f1f387.webp":Z1,"/src/assets/rewards/e9963482-ea99-4ffb-b5df-715a80cd85c3.webp":ek,"/src/assets/rewards/ee2203ac-368a-4737-bd4a-16c6cace03c0.webp":tk,"/src/assets/rewards/f4a7895a-501a-45f1-bbd9-20d6fa67f5dd.webp":sk,"/src/assets/rewards/f4bb6c12-b9a3-4031-977c-d12fdaa69758.webp":ak,"/src/assets/rewards/f6de3790-1159-4545-b8a2-1bc24e45515d.webp":rk,"/src/assets/rewards/fe0425e9-44f6-40e8-853e-6527a0d5676c.webp":nk,"/src/assets/rewards/fe475668-1c71-4211-9728-bd3a4eee456c.webp":ik,"/src/assets/rewards/ff29ee39-7b81-4a57-9559-7cf92dcca929.webp":ok}),dk=Object.fromEntries(Object.entries(ck).map(([t,s])=>[(t.split("/").pop()||"").replace(/\.webp$/i,""),s])),Gp=n.memo(({className:t})=>{const{allRewards:s,userRewards:a,equipReward:r,isEquipping:i,isLoading:o}=_p(),[l,c]=n.useState("background"),d=a.reduce((h,f)=>{const m=f.epic_rewards?.reward_type;return m&&(h[m]||(h[m]=[]),h[m].push(f)),h},{}),u=s.reduce((h,f)=>(h[f.reward_type]||(h[f.reward_type]=[]),h[f.reward_type].push(f),h),{}),p=h=>{r({rewardId:h.reward_id,equip:!h.is_equipped})};return o?e.jsx(Xe,{className:I("p-6 cosmiq-glass",t),children:e.jsx("div",{className:"flex items-center justify-center h-40",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})}):e.jsxs(Xe,{className:I("cosmiq-glass overflow-hidden",t),children:[e.jsxs("div",{className:"p-4 border-b border-border/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-bold text-lg",children:"Reward Collection"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[a.length," / ",s.length," rewards collected"]})]}),e.jsxs(fl,{value:l,onValueChange:h=>c(h),children:[e.jsx(ui,{className:"w-full justify-start rounded-none border-b border-border/50 bg-transparent p-0",children:Object.keys(kn).map(h=>{const f=lk[h],m=d[h]?.length||0;return e.jsxs(Ss,{value:h,className:"flex-1 rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent py-3",children:[e.jsx(f,{className:"w-4 h-4 mr-1.5"}),e.jsx("span",{className:"hidden sm:inline",children:kn[h]}),m>0&&e.jsx(Oe,{variant:"secondary",className:"ml-1.5 h-5 px-1.5 text-xs",children:m})]},h)})}),Object.keys(kn).map(h=>e.jsxs(Es,{value:h,className:"p-4 mt-0",children:[e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-3",children:e.jsxs(Re,{mode:"popLayout",children:[d[h]?.map(f=>e.jsx(uk,{userReward:f,isEquipped:f.is_equipped,onToggleEquip:()=>p(f),isEquipping:i},f.id)),u[h]?.filter(f=>!a.some(m=>m.reward_id===f.id)).map(f=>e.jsx(mk,{reward:f},f.id))]})}),!d[h]?.length&&!u[h]?.length&&e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:e.jsxs("p",{children:["No ",kn[h].toLowerCase()," available yet"]})})]},h))]})]})});Gp.displayName="RewardInventory";const uk=({userReward:t,isEquipped:s,onToggleEquip:a,isEquipping:r})=>{const i=t.epic_rewards;if(!i)return null;const o=Kv[i.rarity],l=dk[i.id]||i.image_url||null;return e.jsx(P.div,{layout:!0,initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},children:e.jsxs(Xe,{className:I("relative p-3 cursor-pointer transition-all hover:scale-105","border-2",s?"border-primary bg-primary/10":"border-border/50 hover:border-primary/50"),onClick:a,children:[s&&e.jsx("div",{className:"absolute -top-2 -right-2 w-6 h-6 rounded-full bg-primary flex items-center justify-center",children:e.jsx(Rt,{className:"w-4 h-4 text-primary-foreground"})}),e.jsx("div",{className:I("aspect-square rounded-lg mb-2 flex items-center justify-center","bg-gradient-to-br",o.bgClass),style:{boxShadow:s?`0 0 20px ${o.color}40`:void 0},children:l?e.jsx("img",{src:l,alt:i.name,className:"h-full w-full rounded-lg object-cover",loading:"lazy",decoding:"async"}):i.reward_type==="artifact"&&i.css_effect?.icon?e.jsx("span",{className:"text-4xl",children:i.css_effect.icon}):e.jsx(be,{className:"w-8 h-8",style:{color:o.color}})}),e.jsx("p",{className:"font-medium text-sm truncate",children:i.name}),e.jsx("p",{className:"text-xs truncate",style:{color:o.color},children:o.label}),r&&e.jsx("div",{className:"absolute inset-0 bg-background/50 flex items-center justify-center rounded-lg",children:e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary"})})]})})},mk=({reward:t})=>e.jsx(P.div,{layout:!0,initial:{opacity:0},animate:{opacity:1},children:e.jsxs(Xe,{className:"relative p-3 border-2 border-dashed border-border/30 bg-muted/20",children:[e.jsx("div",{className:"absolute -top-2 -right-2 w-6 h-6 rounded-full bg-muted flex items-center justify-center",children:e.jsx(Yn,{className:"w-3 h-3 text-muted-foreground"})}),e.jsx("div",{className:"aspect-square rounded-lg mb-2 flex items-center justify-center bg-muted/50",children:e.jsx(be,{className:"w-8 h-8 text-muted-foreground/30"})}),e.jsx("p",{className:"font-medium text-sm truncate text-muted-foreground",children:"???"}),e.jsx("p",{className:"text-xs text-muted-foreground/50",children:"Complete campaigns to unlock"})]})}),pk=["badges","cards","loot"],hk={badges:!0,cards:!1,loot:!1},fk=t=>pk.includes(t),Yp=n.memo(()=>{const[t,s]=n.useState("badges"),[a,r]=n.useState(()=>hk),i=n.useRef(!1),o=n.useCallback(c=>{r(d=>d[c]?d:{...d,[c]:!0})},[]),l=n.useCallback(c=>{fk(c)&&(s(c),o(c))},[o]);return n.useEffect(()=>{if(i.current)return;i.current=!0;const c=window;let d=null,u=null;return c.requestIdleCallback?u=c.requestIdleCallback(()=>{r({badges:!0,cards:!0,loot:!0})},{timeout:1200}):d=window.setTimeout(()=>{r({badges:!0,cards:!0,loot:!0})},400),()=>{d!==null&&window.clearTimeout(d),u!==null&&c.cancelIdleCallback&&c.cancelIdleCallback(u)}},[]),e.jsx("div",{className:"space-y-4 mt-4",children:e.jsxs(fl,{value:t,onValueChange:l,children:[e.jsxs(ui,{className:"grid w-full grid-cols-3 h-10",children:[e.jsxs(Ss,{value:"badges",className:"flex items-center gap-2",children:[e.jsx(bo,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Badges"})]}),e.jsxs(Ss,{value:"cards",className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Cards"})]}),e.jsxs(Ss,{value:"loot",className:"flex items-center gap-2",children:[e.jsx(Rg,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Loot"})]})]}),e.jsx(Es,{value:"badges",forceMount:!0,className:"mt-4 data-[state=inactive]:hidden",children:a.badges&&e.jsx(e1,{})}),e.jsx(Es,{value:"cards",forceMount:!0,className:"mt-4 data-[state=inactive]:hidden",children:a.cards&&e.jsx(Wp,{})}),e.jsx(Es,{value:"loot",forceMount:!0,className:"mt-4 data-[state=inactive]:hidden",children:a.loot&&e.jsx(Gp,{})})]})})});Yp.displayName="CollectionTab";const fs={pomodoro:25,short_break:5,long_break:15,custom:30},gk=300;function xk(){const{user:t}=_e(),{toast:s}=_s(),a=Ie(),{awardFocusSessionComplete:r}=rs(),i=n.useRef(null),o=n.useRef(null),{triggerPomodoroComplete:l}=en(),[c,d]=n.useState({isRunning:!1,isPaused:!1,timeRemaining:fs.pomodoro*60,totalTime:fs.pomodoro*60,sessionType:"pomodoro",currentSessionId:null,distractionsCount:0,isCooldown:!1,cooldownTimeRemaining:0}),{data:u=[],isLoading:p}=Ee({queryKey:["focus-sessions",t?.id,"today"],queryFn:async()=>{if(!t?.id)return[];const M=new Date().toISOString().split("T")[0],{data:A,error:L}=await k.from("focus_sessions").select("*").eq("user_id",t.id).gte("started_at",`${M}T00:00:00`).order("started_at",{ascending:!1});if(L)throw L;return A},enabled:!!t?.id}),h=he({mutationFn:async({taskId:M,durationType:A,customDuration:L})=>{if(!t?.id)throw new Error("Not authenticated");const q=L||fs[A],{data:$,error:B}=await k.from("focus_sessions").insert({user_id:t.id,task_id:M||null,duration_type:A,planned_duration:q,started_at:new Date().toISOString(),status:"active",distractions_count:0}).select().single();if(B)throw B;return $},onSuccess:M=>{a.invalidateQueries({queryKey:["focus-sessions"]}),d(A=>({...A,isRunning:!0,isPaused:!1,timeRemaining:M.planned_duration*60,totalTime:M.planned_duration*60,sessionType:M.duration_type,currentSessionId:M.id,distractionsCount:0,isCooldown:!1,cooldownTimeRemaining:0}))},onError:M=>{console.error("Failed to start session:",M),s({title:"Failed to start focus session",variant:"destructive"})}}),f=u.filter(M=>M.status==="completed").length,m=f<Cs.DAILY_SESSION_CAP,g=Math.max(0,Cs.DAILY_SESSION_CAP-f),y=he({mutationFn:async({sessionId:M,actualDuration:A,distractionsCount:L,isPerfect:q,underCap:$})=>{let B;$?(B=Cs.SESSION_COMPLETE,q&&(B+=Cs.PERFECT_FOCUS_BONUS)):B=Cs.CAPPED_SESSION_XP;const{data:W,error:H}=await k.from("focus_sessions").update({status:"completed",completed_at:new Date().toISOString(),actual_duration:A,distractions_count:L,xp_earned:B}).eq("id",M).select().single();if(H)throw H;return{session:W,isPerfect:q,underCap:$}},onSuccess:({session:M,isPerfect:A,underCap:L})=>{a.invalidateQueries({queryKey:["focus-sessions"]}),r(A,L),M.planned_duration>=15&&l(M.planned_duration).catch(q=>console.log("[LivingCompanion] Pomodoro trigger failed:",q)),v()}}),b=he({mutationFn:async M=>{const{data:A,error:L}=await k.from("focus_sessions").update({status:"paused",paused_at:new Date().toISOString()}).eq("id",M).select().single();if(L)throw L;return A},onSuccess:()=>{a.invalidateQueries({queryKey:["focus-sessions"]})}}),w=he({mutationFn:async M=>{const{data:A,error:L}=await k.from("focus_sessions").update({status:"active",paused_at:null}).eq("id",M).select().single();if(L)throw L;return A},onSuccess:()=>{a.invalidateQueries({queryKey:["focus-sessions"]})}}),x=he({mutationFn:async M=>{const{data:A,error:L}=await k.from("focus_sessions").update({status:"cancelled",completed_at:new Date().toISOString()}).eq("id",M).select().single();if(L)throw L;return A},onSuccess:()=>{a.invalidateQueries({queryKey:["focus-sessions"]}),_()}}),v=n.useCallback(()=>{i.current&&clearInterval(i.current),d(M=>({...M,isRunning:!1,isPaused:!1,isCooldown:!0,cooldownTimeRemaining:gk,currentSessionId:null,distractionsCount:0}))},[]),j=n.useCallback(()=>{o.current&&clearInterval(o.current),d(M=>({...M,isCooldown:!1,cooldownTimeRemaining:0,timeRemaining:fs.pomodoro*60,totalTime:fs.pomodoro*60}))},[]),T=n.useCallback(()=>{d(M=>({...M,distractionsCount:M.distractionsCount+1}))},[]);n.useEffect(()=>(c.isCooldown&&c.cooldownTimeRemaining>0&&(o.current=setInterval(()=>{d(M=>M.cooldownTimeRemaining<=1?{...M,isCooldown:!1,cooldownTimeRemaining:0,timeRemaining:fs.pomodoro*60,totalTime:fs.pomodoro*60}:{...M,cooldownTimeRemaining:M.cooldownTimeRemaining-1})},1e3)),()=>{o.current&&clearInterval(o.current)}),[c.isCooldown,c.cooldownTimeRemaining>0]),n.useEffect(()=>(c.isRunning&&!c.isPaused&&(i.current=setInterval(()=>{d(M=>{if(M.timeRemaining<=1){if(M.currentSessionId){const A=Math.round((M.totalTime-M.timeRemaining)/60),L=M.distractionsCount===0;y.mutate({sessionId:M.currentSessionId,actualDuration:A,distractionsCount:M.distractionsCount,isPerfect:L,underCap:m})}return{...M,isRunning:!1,timeRemaining:0}}return{...M,timeRemaining:M.timeRemaining-1}})},1e3)),()=>{i.current&&clearInterval(i.current)}),[c.isRunning,c.isPaused,m]);const S=n.useCallback((M,A="pomodoro",L)=>{h.mutate({taskId:M,durationType:A,customDuration:L})},[]),N=n.useCallback(()=>{c.currentSessionId&&(b.mutate(c.currentSessionId),d(M=>({...M,isPaused:!0})))},[c.currentSessionId]),D=n.useCallback(()=>{c.currentSessionId&&(w.mutate(c.currentSessionId),d(M=>({...M,isPaused:!1})))},[c.currentSessionId]),R=n.useCallback(()=>{c.currentSessionId&&x.mutate(c.currentSessionId)},[c.currentSessionId]),_=n.useCallback(()=>{i.current&&clearInterval(i.current),o.current&&clearInterval(o.current),d({isRunning:!1,isPaused:!1,timeRemaining:fs.pomodoro*60,totalTime:fs.pomodoro*60,sessionType:"pomodoro",currentSessionId:null,distractionsCount:0,isCooldown:!1,cooldownTimeRemaining:0})},[]),C=n.useCallback((M,A)=>{const L=A||fs[M];d(q=>({...q,sessionType:M,timeRemaining:L*60,totalTime:L*60}))},[]),E=u.filter(M=>M.status==="completed"&&M.duration_type==="pomodoro").reduce((M,A)=>M+(A.actual_duration||0),0),O=u.filter(M=>M.status==="completed").reduce((M,A)=>M+(A.xp_earned||0),0);return{timerState:c,todaySessions:u,isLoading:p,startSession:S,pauseSession:N,resumeSession:D,cancelSession:R,resetTimer:_,setSessionType:C,logDistraction:T,skipCooldown:j,stats:{completedToday:f,totalFocusMinutes:E,totalXPToday:O,sessionsUntilCap:g,dailyCap:Cs.DAILY_SESSION_CAP},DURATION_PRESETS:fs}}function yk({taskId:t,taskName:s,compact:a=!1,onComplete:r}){const{timerState:i,startSession:o,pauseSession:l,resumeSession:c,cancelSession:d,logDistraction:u,skipCooldown:p,stats:h}=xk(),f=w=>{const x=Math.floor(w/60),v=w%60;return`${x.toString().padStart(2,"0")}:${v.toString().padStart(2,"0")}`},m=i.isCooldown?(300-i.cooldownTimeRemaining)/300*100:i.totalTime>0?(i.totalTime-i.timeRemaining)/i.totalTime*100:0,g=i.isCooldown?i.cooldownTimeRemaining:i.timeRemaining,y=()=>{o(t,"pomodoro")},b=()=>{i.isPaused?c():l()};return a?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-lg font-mono font-bold text-foreground",children:f(g)}),!i.isRunning&&!i.isCooldown?e.jsx(z,{size:"sm",variant:"ghost",onClick:y,children:e.jsx(Ks,{className:"w-4 h-4"})}):i.isCooldown?e.jsx(z,{size:"sm",variant:"ghost",onClick:p,children:e.jsx(Rr,{className:"w-4 h-4"})}):e.jsx(z,{size:"sm",variant:"ghost",onClick:b,children:i.isPaused?e.jsx(Ks,{className:"w-4 h-4"}):e.jsx(ar,{className:"w-4 h-4"})})]}):e.jsx(Xe,{className:"overflow-hidden",children:e.jsxs(tl,{className:"p-6",children:[!i.isRunning&&!i.isCooldown&&e.jsxs("div",{className:"flex items-start gap-3 mb-6 p-3 rounded-lg bg-muted/50",children:[e.jsx(Ds,{className:"w-5 h-5 text-primary shrink-0 mt-0.5"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Pomodoro Technique:"})," ","Focus for 25 minutes, then take a 5-minute break. This helps maintain concentration and avoid burnout."]})]}),i.isCooldown&&e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-6 p-3 rounded-lg bg-green-500/10",children:[e.jsx(Ig,{className:"w-5 h-5 text-green-500"}),e.jsx("p",{className:"text-sm font-medium text-green-600 dark:text-green-400",children:"Take a break! Stretch, hydrate, rest your eyes."})]}),e.jsx("div",{className:"relative flex justify-center mb-6",children:e.jsxs("div",{className:"relative w-48 h-48",children:[e.jsxs("svg",{className:"w-full h-full transform -rotate-90",children:[e.jsx("circle",{cx:"96",cy:"96",r:"88",fill:"none",stroke:"currentColor",strokeWidth:"8",className:"text-muted/20"}),e.jsx(P.circle,{cx:"96",cy:"96",r:"88",fill:"none",stroke:"currentColor",strokeWidth:"8",strokeLinecap:"round",className:I(i.isCooldown?"text-green-500":"text-primary"),strokeDasharray:553,strokeDashoffset:553-553*m/100,initial:!1,animate:{strokeDashoffset:553-553*m/100},transition:{duration:.5}})]}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:[e.jsx(Re,{mode:"wait",children:e.jsx(P.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"text-4xl font-mono font-bold text-foreground",children:f(g)},g)}),e.jsx("span",{className:I("text-sm mt-1",i.isCooldown?"text-green-500 font-medium":"text-muted-foreground"),children:i.isCooldown?"Cooldown":"Focus Time"})]})]})}),s&&!i.isCooldown&&e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Working on:"}),e.jsx("p",{className:"font-medium text-foreground truncate",children:s})]}),e.jsx("div",{className:"flex justify-center gap-3",children:i.isCooldown?e.jsxs(z,{onClick:p,variant:"outline",size:"lg",className:"gap-2",children:[e.jsx(Rr,{className:"w-5 h-5"}),"Skip Break"]}):i.isRunning?e.jsxs(e.Fragment,{children:[e.jsx(z,{variant:"outline",size:"icon",onClick:d,className:"h-12 w-12",children:e.jsx(qg,{className:"w-5 h-5"})}),e.jsx(z,{size:"lg",onClick:b,className:"gap-2 px-8",children:i.isPaused?e.jsxs(e.Fragment,{children:[e.jsx(Ks,{className:"w-5 h-5"}),"Resume"]}):e.jsxs(e.Fragment,{children:[e.jsx(ar,{className:"w-5 h-5"}),"Pause"]})}),e.jsx(z,{variant:"outline",size:"icon",onClick:u,className:"h-12 w-12",title:"Log distraction",children:e.jsx(bt,{className:"w-5 h-5"})})]}):e.jsxs(z,{onClick:y,size:"lg",className:"gap-2",children:[e.jsx(Ks,{className:"w-5 h-5"}),"Start Focus"]})}),i.isRunning&&i.distractionsCount>0&&e.jsx("div",{className:"text-center mt-4",children:e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Distractions: ",i.distractionsCount]})}),h.sessionsUntilCap>0?e.jsxs("div",{className:"text-center mt-4 text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-primary",children:h.sessionsUntilCap})," full XP session",h.sessionsUntilCap!==1?"s":""," remaining today"]}):e.jsxs("div",{className:"text-center mt-4 text-sm text-muted-foreground",children:["Daily cap reached â€” sessions now award ",e.jsx("span",{className:"font-medium",children:"3 XP"})]}),e.jsxs("div",{className:"flex justify-center gap-6 mt-6 pt-4 border-t border-border",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-foreground",children:h.completedToday}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Sessions"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-foreground",children:h.totalFocusMinutes}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Minutes"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:h.totalXPToday}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"XP"})]})]})]})})}const bk=dr("rounded-2xl border transition-all duration-300",{variants:{variant:{default:["bg-card/78 backdrop-blur-lg","border-border/60","shadow-[0_10px_24px_rgba(0,0,0,0.22)]"],elevated:["bg-card/86 backdrop-blur-2xl","border-border/70","shadow-[0_14px_34px_rgba(0,0,0,0.28),0_2px_8px_rgba(0,0,0,0.12)]"],inset:["bg-background/60 backdrop-blur-lg","border-border/45","shadow-inner"],hero:["bg-gradient-to-br from-primary/[0.12] to-accent/[0.07] backdrop-blur-2xl","border-border/60","shadow-[0_16px_38px_rgba(0,0,0,0.24)]"],subtle:["bg-card/62 backdrop-blur-md","border-border/45","shadow-[0_6px_16px_rgba(0,0,0,0.16)]"],ultra:["bg-card/70 backdrop-blur-2xl","border-border/55","shadow-[0_10px_28px_rgba(0,0,0,0.24)]"]},glow:{none:"",soft:"shadow-[0_0_30px_rgba(255,255,255,0.05)]",accent:"shadow-[0_0_40px_hsl(var(--accent)/0.15)]",primary:"shadow-[0_0_40px_hsl(var(--primary)/0.2)]"}},defaultVariants:{variant:"default",glow:"none"}}),sa=n.forwardRef(({className:t,variant:s,glow:a,...r},i)=>e.jsx("div",{ref:i,className:I(bk({variant:s,glow:a}),t),...r}));sa.displayName="GlassCard";const Vp=n.memo(({habit:t,onResist:s,onRemove:a,isLoading:r})=>e.jsx(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:e.jsx(sa,{variant:"subtle",className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"text-2xl flex-shrink-0",children:t.icon}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h4",{className:"font-medium text-sm text-foreground truncate",children:t.name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["Resisted ",t.times_resisted,"Ã—"]}),t.current_streak>0&&e.jsxs("span",{className:"flex items-center gap-1 text-orange-400",children:[e.jsx(es,{className:"h-3 w-3"}),t.current_streak," streak"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx(z,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:a,disabled:r,children:e.jsx(oa,{className:"h-4 w-4"})}),e.jsxs(z,{size:"sm",onClick:s,disabled:r,className:"gap-1.5",children:[e.jsx(As,{className:"h-4 w-4"}),"Resist"]})]})]})})}));Vp.displayName="HabitResistCard";const wk=dr("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),ct=n.forwardRef(({className:t,...s},a)=>e.jsx(Cu,{ref:a,className:I(wk(),t),...s}));ct.displayName=Cu.displayName;const Qr=Ug,Wr=Hg,lr=n.forwardRef(({className:t,children:s,...a},r)=>e.jsxs(Su,{ref:r,className:I("flex h-11 w-full items-center justify-between rounded-lg border border-input bg-secondary/50 px-4 py-2 text-sm font-medium text-foreground ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:border-primary disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1 transition-all",t),...a,children:[s,e.jsx(Lg,{asChild:!0,children:e.jsx(Ws,{className:"h-4 w-4 opacity-50"})})]}));lr.displayName=Su.displayName;const Xp=n.forwardRef(({className:t,...s},a)=>e.jsx(Eu,{ref:a,className:I("flex cursor-default items-center justify-center py-1",t),...s,children:e.jsx(Wo,{className:"h-4 w-4"})}));Xp.displayName=Eu.displayName;const Jp=n.forwardRef(({className:t,...s},a)=>e.jsx(Tu,{ref:a,className:I("flex cursor-default items-center justify-center py-1",t),...s,children:e.jsx(Ws,{className:"h-4 w-4"})}));Jp.displayName=Tu.displayName;const cr=n.forwardRef(({className:t,children:s,position:a="popper",...r},i)=>e.jsx(Og,{children:e.jsxs(Mu,{ref:i,className:I("relative z-[100] max-h-96 min-w-[8rem] overflow-hidden rounded-lg border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",t),position:a,...r,children:[e.jsx(Xp,{}),e.jsx(Fg,{className:I("p-1",a==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:s}),e.jsx(Jp,{})]})}));cr.displayName=Mu.displayName;const vk=n.forwardRef(({className:t,...s},a)=>e.jsx(Du,{ref:a,className:I("py-1.5 pl-8 pr-2 text-sm font-semibold",t),...s}));vk.displayName=Du.displayName;const ra=n.forwardRef(({className:t,children:s,...a},r)=>e.jsxs(Au,{ref:r,className:I("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",t),...a,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx($g,{children:e.jsx(Rt,{className:"h-4 w-4"})})}),e.jsx(Bg,{children:s})]}));ra.displayName=Au.displayName;const _k=n.forwardRef(({className:t,...s},a)=>e.jsx(Pu,{ref:a,className:I("-mx-1 my-1 h-px bg-muted",t),...s}));_k.displayName=Pu.displayName;const jk=[{value:"distraction",label:"Distraction"},{value:"laziness",label:"Laziness"},{value:"stagnation",label:"Stagnation"},{value:"anxiety",label:"Anxiety"},{value:"overthinking",label:"Overthinking"},{value:"doubt",label:"Self-Doubt"},{value:"fear",label:"Fear"}],Zp=n.memo(({onAdd:t,isLoading:s})=>{const[a,r]=n.useState(!1),[i,o]=n.useState("preset"),[l,c]=n.useState(""),[d,u]=n.useState("ðŸš«"),[p,h]=n.useState("distraction"),f=g=>{t({name:g.name,icon:g.icon,theme:g.theme}),r(!1)},m=()=>{l.trim()&&(t({name:l.trim(),icon:d,theme:p}),c(""),u("ðŸš«"),h("distraction"),r(!1))};return e.jsxs(as,{open:a,onOpenChange:r,children:[e.jsx(_0,{asChild:!0,children:e.jsxs(z,{variant:"outline",className:"w-full gap-2",children:[e.jsx(qr,{className:"h-4 w-4"}),"Add Bad Habit"]})}),e.jsxs(Qt,{className:"sm:max-w-md",children:[e.jsx(Is,{children:e.jsxs(ps,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5 text-primary"}),"Track a Bad Habit"]})}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsx(z,{variant:i==="preset"?"default":"outline",size:"sm",onClick:()=>o("preset"),className:"flex-1",children:"Quick Select"}),e.jsx(z,{variant:i==="custom"?"default":"outline",size:"sm",onClick:()=>o("custom"),className:"flex-1",children:"Custom"})]}),i==="preset"?e.jsx("div",{className:"grid grid-cols-2 gap-2 max-h-[300px] overflow-y-auto",children:Cb.map(g=>e.jsx(sa,{variant:"subtle",className:"p-3 cursor-pointer hover:bg-primary/10 transition-colors",onClick:()=>f(g),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:g.icon}),e.jsx("span",{className:"text-sm font-medium",children:g.name})]})},g.name))}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ct,{htmlFor:"habit-name",children:"Habit Name"}),e.jsx(mt,{id:"habit-name",placeholder:"e.g., Late night snacking",value:l,onChange:g=>c(g.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ct,{htmlFor:"habit-icon",children:"Icon"}),e.jsx(mt,{id:"habit-icon",placeholder:"ðŸš«",value:d,onChange:g=>u(g.target.value),maxLength:2,className:"text-center text-xl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ct,{htmlFor:"habit-theme",children:"Category"}),e.jsxs(Qr,{value:p,onValueChange:g=>h(g),children:[e.jsx(lr,{id:"habit-theme",children:e.jsx(Wr,{})}),e.jsx(cr,{children:jk.map(g=>e.jsx(ra,{value:g.value,children:g.label},g.value))})]})]})]}),e.jsx(z,{className:"w-full",onClick:m,disabled:!l.trim()||s,children:"Add Habit"})]})]})]})});Zp.displayName="AddBadHabitDialog";const Nk=()=>{const{user:t}=_e(),s=Ie(),{data:a,isLoading:r}=Ee({queryKey:["bad-habits",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:p,error:h}=await k.from("user_bad_habits").select("*").eq("user_id",t.id).eq("is_active",!0).order("created_at",{ascending:!1});if(h)throw h;return p},enabled:!!t?.id}),{data:i,isLoading:o}=Ee({queryKey:["resist-log",t?.id],queryFn:async()=>{if(!t?.id)return[];const p=new Date;p.setDate(p.getDate()-30);const{data:h,error:f}=await k.from("resist_log").select("*").eq("user_id",t.id).gte("created_at",p.toISOString()).order("created_at",{ascending:!1});if(f)throw f;return h},enabled:!!t?.id}),l=he({mutationFn:async p=>{if(!t?.id)throw new Error("User not found");const{data:h,error:f}=await k.from("user_bad_habits").insert({user_id:t.id,name:p.name,icon:p.icon,habit_theme:p.theme}).select().single();if(f)throw f;return h},onSuccess:p=>{s.setQueryData(["bad-habits",t?.id],h=>[p,...h??[]]),s.invalidateQueries({queryKey:["bad-habits"]}),V.success("Bad habit added! Ready to resist.")},onError:p=>{console.error("Failed to add habit:",p),V.error("Failed to add habit")}}),c=he({mutationFn:async p=>{if(!t?.id)throw new Error("User not found");const{error:h}=await k.from("user_bad_habits").update({is_active:!1}).eq("id",p).eq("user_id",t.id);if(h)throw h},onSuccess:(p,h)=>{s.setQueryData(["bad-habits",t?.id],f=>(f??[]).filter(m=>m.id!==h)),s.invalidateQueries({queryKey:["bad-habits"]}),V.success("Habit removed")},onError:p=>{console.error("Failed to remove habit:",p),V.error("Failed to remove habit")}}),d=n.useCallback(p=>a?.find(h=>h.id===p),[a]),u=n.useMemo(()=>{const p=a?.reduce((g,y)=>g+y.times_resisted,0)??0,h=i?.filter(g=>g.result!=="fail").length??0,f=i?.filter(g=>new Date(g.created_at).toDateString()===new Date().toDateString()&&g.result!=="fail").length??0,m=Math.max(...a?.map(g=>g.longest_streak)??[0]);return{totalResisted:p,successfulResists:h,todayResists:f,bestStreak:m}},[a,i]);return{habits:a,resistHistory:i,stats:u,isLoading:r||o,isAddingHabit:l.isPending,isRemovingHabit:c.isPending,addHabit:l.mutate,removeHabit:c.mutate,getHabit:d}},eh=n.memo(()=>{const{habits:t,stats:s,isLoading:a,addHabit:r,removeHabit:i,isAddingHabit:o}=Nk(),{checkEncounterTrigger:l,isTriggeringEncounter:c}=ap(),[d,u]=n.useState(null),[p,h]=n.useState(!1),f=n.useCallback(async y=>{if(!(p||c)){u(y.id),h(!0);try{await l("urge_resist",y.id,void 0,y.habit_theme)}finally{u(null),h(!1)}}},[l,p,c]),m=n.useCallback(y=>{r(y)},[r]),g=n.useCallback(y=>{i(y)},[i]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(sa,{variant:"subtle",className:"p-4 text-center space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-primary",children:[e.jsx(As,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium",children:"Resist urges to grow stronger"}),e.jsx(As,{className:"h-5 w-5"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Beat a quick game instead of giving in to bad habits"})]}),(s.totalResisted>0||s.bestStreak>0)&&e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs(sa,{variant:"inset",className:"p-3 text-center",children:[e.jsx("div",{className:"flex items-center justify-center gap-1 text-primary mb-1",children:e.jsx(It,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"text-lg font-bold",children:s.totalResisted}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Total"})]}),e.jsxs(sa,{variant:"inset",className:"p-3 text-center",children:[e.jsx("div",{className:"flex items-center justify-center gap-1 text-orange-400 mb-1",children:e.jsx(es,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"text-lg font-bold",children:s.bestStreak}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Best Streak"})]}),e.jsxs(sa,{variant:"inset",className:"p-3 text-center",children:[e.jsx("div",{className:"flex items-center justify-center gap-1 text-green-400 mb-1",children:e.jsx(bt,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"text-lg font-bold",children:s.todayResists}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Today"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Re,{mode:"popLayout",children:t?.map(y=>e.jsx(Vp,{habit:y,onResist:()=>f(y),onRemove:()=>g(y.id),isLoading:p||c||d===y.id},y.id))}),!a&&(!t||t.length===0)&&e.jsxs(P.div,{initial:{opacity:0},animate:{opacity:1},className:"py-8 text-center",children:[e.jsx(As,{className:"h-12 w-12 mx-auto text-muted-foreground/50 mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"No habits tracked yet"}),e.jsx("p",{className:"text-xs text-muted-foreground/70",children:"Add a bad habit to start building resistance"})]})]}),e.jsx(Zp,{onAdd:m,isLoading:o})]})});eh.displayName="ResistModePanel";const th=n.memo(()=>{const[t,s]=n.useState("focus");return e.jsxs("div",{className:"space-y-6 mt-6",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(z,{variant:t==="focus"?"default":"outline",size:"sm",onClick:()=>s("focus"),className:"flex-1 gap-2",children:[e.jsx(ti,{className:"h-4 w-4"}),"Focus"]}),e.jsxs(z,{variant:t==="resist"?"default":"outline",size:"sm",onClick:()=>s("resist"),className:"flex-1 gap-2",children:[e.jsx(As,{className:"h-4 w-4"}),"Resist"]})]}),t==="focus"?e.jsxs(e.Fragment,{children:[e.jsxs(sa,{variant:"subtle",className:"p-4 text-center space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-primary",children:[e.jsx(be,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium",children:"Focus to grow your companion"}),e.jsx(be,{className:"h-5 w-5"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"XP earned from focus sessions helps your companion evolve"})]}),e.jsx(yk,{})]}):e.jsx(eh,{})]})});th.displayName="FocusTab";const kk={joyful:{saturation:80,lightness:65,glowIntensity:.4},content:{saturation:60,lightness:55,glowIntensity:.3},neutral:{saturation:40,lightness:50,glowIntensity:.2},reserved:{saturation:25,lightness:45,glowIntensity:.15},quiet:{saturation:15,lightness:40,glowIntensity:.1},dormant:{saturation:5,lightness:30,glowIntensity:0}},sh=()=>{const{presence:t}=ii();return n.useMemo(()=>{const{auraHue:s,mood:a,auraOpacity:r}=t,i=kk[a],o=`hsl(${s}, ${i.saturation}%, ${i.lightness}%)`,l=`hsl(${(s+30)%360}, ${i.saturation*.8}%, ${i.lightness}%)`,c=i.glowIntensity>0?`0 0 20px hsla(${s}, ${i.saturation}%, ${i.lightness}%, ${i.glowIntensity}), 
         0 0 40px hsla(${s}, ${i.saturation}%, ${i.lightness}%, ${i.glowIntensity*.5})`:"none",d=`radial-gradient(
      ellipse at 50% 30%,
      hsla(${s}, ${i.saturation}%, ${i.lightness}%, ${r}),
      transparent 70%
    )`,u=`hsla(${s}, ${i.saturation}%, ${i.lightness+15}%, 0.8)`,p=i.glowIntensity>0?`0 0 12px hsla(${s}, ${i.saturation}%, ${i.lightness}%, ${i.glowIntensity*.8})`:"none";return{primaryAura:o,secondaryAura:l,glowShadow:c,gradientOverlay:d,particleColor:u,navGlow:p}},[t])},ah=n.memo(({className:t,chance:s=.15})=>{const{getRandomMemory:a,getMemoryDialogue:r,referenceMemory:i,memories:o}=hl(),{presence:l}=ii(),{primaryAura:c}=sh(),[d,u]=n.useState(null),[p,h]=n.useState(!1),f=n.useRef(!1);return n.useEffect(()=>{if(!l.isPresent||l.mood==="dormant"||o.length===0||f.current||Math.random()>s)return;const m=setTimeout(()=>{const g=a();if(g){const y=r(g);y&&(u(y),h(!0),i(g.id),f.current=!0)}},2e3);return()=>clearTimeout(m)},[o.length,l.isPresent,l.mood,s]),!d||!p?null:e.jsx(Re,{children:e.jsx(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},transition:{duration:.3},className:I("mt-2 p-2 rounded-lg","bg-primary/5 border border-primary/10",t),style:{boxShadow:`inset 0 0 20px ${c}15`},children:e.jsxs("p",{className:"text-xs text-muted-foreground italic",children:['ðŸ’­ "',d,'"']})})})});ah.displayName="MemoryWhisper";const rh=t=>["companion-stories-all",t],nh=async t=>{const{data:s,error:a}=await k.from("companion_stories").select("*").eq("companion_id",t).order("stage",{ascending:!0});if(a)throw a;return s},HT=(t,s)=>{const{user:a}=_e(),r=Ie(),{data:i,isLoading:o}=Ee({queryKey:["companion-story",t,s],queryFn:async()=>{if(!t||s===void 0)return null;const{data:d,error:u}=await k.from("companion_stories").select("*").eq("companion_id",t).eq("stage",s).maybeSingle();if(u)throw console.error("Failed to fetch companion story:",u),u;return d},enabled:!!t&&s!==void 0,placeholderData:d=>d,staleTime:120*1e3}),{data:l}=Ee({queryKey:rh(t),queryFn:async()=>t?nh(t):[],enabled:!!t}),c=he({mutationFn:async d=>{if(!a)throw new Error("Not authenticated");V.loading("Your story is being written...",{id:"story-gen"});const{data:u,error:p}=await k.functions.invoke("generate-companion-story",{body:{companionId:d.companionId,stage:d.stage}});if(p)throw console.error("Story generation error:",p),new Error("Unable to write your story right now. Please try again.");return u},onSuccess:()=>{V.dismiss("story-gen"),V.success("ðŸ“– New chapter unlocked!"),r.invalidateQueries({queryKey:["companion-story"]}),r.invalidateQueries({queryKey:["companion-stories-all"]})},onError:d=>{V.dismiss("story-gen"),console.error("Story generation failed:",d),V.error(d instanceof Error?d.message:"Something went wrong. Please try again.")}});return{story:i,allStories:l,isLoading:o,generateStory:c}},To=t=>["companion-postcards",t],ih=async t=>{const{data:s,error:a}=await k.from("companion_postcards").select("*").eq("user_id",t).order("generated_at",{ascending:!1});if(a)throw a;return s},Ck=()=>{const{user:t}=_e(),s=Ie(),[a,r]=n.useState(null),i=n.useCallback(()=>{r(null)},[]),{data:o,isLoading:l,error:c}=Ee({queryKey:To(t?.id),queryFn:async()=>t?.id?ih(t.id):[],enabled:!!t?.id}),d=he({mutationFn:async({companionId:h,epicId:f,milestonePercent:m,companionData:g,milestoneTitle:y})=>{if(!t?.id)throw new Error("Not authenticated");const{data:b,error:w}=await k.functions.invoke("generate-cosmic-postcard",{body:{userId:t.id,companionId:h,epicId:f,milestonePercent:m,companionData:g}});if(w)throw w;if(b?.error)throw new Error(b.error);return{...b,milestoneTitle:y}},onSuccess:async h=>{if(!h?.existing&&(s.invalidateQueries({queryKey:To(t?.id)}),r({milestoneTitle:h?.milestoneTitle,chapterNumber:h?.postcard?.chapter_number,locationName:h?.postcard?.location_name}),V.success("ðŸ“¸ New cosmic postcard unlocked!",{description:`Your companion visited ${h?.postcard?.location_name}!`}),h?.postcard?.chapter_number&&h?.postcard?.epic_id&&t?.id))try{await k.functions.invoke("generate-journey-path",{body:{epicId:h.postcard.epic_id,milestoneIndex:h.postcard.chapter_number,userId:t.id}}),s.invalidateQueries({queryKey:["journey-path",h.postcard.epic_id]})}catch(f){console.error("Failed to regenerate journey path:",f)}},onError:h=>{console.error("Failed to generate postcard:",h)}}),u=n.useCallback(async(h,f,m,g,y)=>{const b=[25,50,75,100];for(const w of b)if(m<w&&f>=w&&!o?.find(v=>v.epic_id===h&&v.milestone_percent===w)){d.mutate({companionId:g,epicId:h,milestonePercent:w,companionData:y});break}},[o,d]),p=n.useCallback(async(h,f,m,g)=>{if(!t?.id)return;const{data:y,error:b}=await k.from("epic_milestones").select("id, title, milestone_percent, is_postcard_milestone").eq("id",h).maybeSingle();if(b){console.error("Failed to fetch milestone:",b);return}if(!y){console.log("Milestone not found");return}if(!y.is_postcard_milestone){console.log("Milestone is not marked for postcard generation");return}if(o?.find(x=>x.epic_id===f&&x.milestone_percent===y.milestone_percent)){console.log("Postcard already exists for this milestone");return}d.mutate({companionId:m,epicId:f,milestonePercent:y.milestone_percent,companionData:g,milestoneTitle:y.title})},[t?.id,o,d]);return{postcards:o||[],isLoading:l,error:c,generatePostcard:d,checkAndGeneratePostcard:u,checkMilestoneForPostcard:p,isGenerating:d.isPending,postcardJustUnlocked:a,clearPostcardUnlocked:i}},Sk=["overview","focus","stories","postcards","collection"],Ek={overview:!0,focus:!1,stories:!1,postcards:!1,collection:!1},Tk=t=>Sk.includes(t),oh=n.memo(({companion:t,nextEvolutionXP:s,progressToNext:a})=>e.jsxs("div",{className:"space-y-6 mt-6",children:[e.jsx(ah,{chance:.2,className:"px-2"}),e.jsx(gs,{offset:30,children:e.jsx(Op,{})}),e.jsx(gs,{offset:22,children:e.jsx("div",{"data-tour":"companion-progress-area",children:e.jsx(Fp,{currentXP:t?.current_xp||0,nextEvolutionXP:s||0,currentStage:t?.current_stage||0,progressPercent:a})})}),e.jsx(gs,{offset:16,children:e.jsx(Up,{})}),e.jsx(gs,{offset:12,children:e.jsx($p,{})})]}));oh.displayName="OverviewTab";const lh=()=>ke(()=>import("./CompanionStoryJournal-CYdEackS.js"),__vite__mapDeps([15,1,2,3])).then(t=>({default:t.CompanionStoryJournal})),ch=()=>ke(()=>import("./CompanionPostcards-DSPFFCea.js"),__vite__mapDeps([16,1,2,3,17])).then(t=>({default:t.CompanionPostcards})),Mk=n.lazy(lh),Dk=n.lazy(ch),Hc=()=>e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsx(Ce,{className:"h-48 w-full rounded-xl"}),e.jsx(Ce,{className:"h-32 w-full rounded-xl"})]}),Ak=()=>e.jsxs("div",{className:"space-y-6 mt-6",children:[e.jsxs("div",{className:"rounded-xl border border-cosmiq-glow/10 p-6",children:[e.jsx(Ce,{className:"h-48 w-48 rounded-full mx-auto"}),e.jsx(Ce,{className:"h-6 w-32 mx-auto mt-4"})]}),e.jsx(Ce,{className:"h-32 w-full rounded-xl"}),e.jsx(Ce,{className:"h-40 w-full rounded-xl"}),e.jsx(Ce,{className:"h-24 w-full rounded-xl"})]}),Pk=()=>{const t=Yr(),{isTabActive:s}=sn(),{companion:a,nextEvolutionXP:r,progressToNext:i,isLoading:o,error:l,refetch:c}=At({enabled:s}),{user:d}=_e(),u=Ie(),[p,h]=n.useState("overview"),[f,m]=n.useState(()=>Ek),g=n.useRef(null),y=Xr(),b=n.useRef(y.pathname),w=ts(),x=n.useCallback(_=>{m(C=>C[_]?C:{...C,[_]:!0})},[]),v=n.useCallback(()=>{if(!s)return Promise.resolve([]);const _=[lh()];return a?.id&&_.push(u.prefetchQuery({queryKey:rh(a.id),queryFn:()=>nh(a.id)})),Promise.allSettled(_)},[a?.id,s,u]),j=n.useCallback(()=>{if(!s)return Promise.resolve([]);const _=[ch()];return d?.id&&_.push(u.prefetchQuery({queryKey:To(d.id),queryFn:()=>ih(d.id)})),Promise.allSettled(_)},[s,u,d?.id]),T=n.useCallback(()=>{v(),j()},[j,v]),S=n.useCallback(()=>{s&&v()},[s,v]),N=n.useCallback(()=>{s&&j()},[s,j]),D=n.useCallback(_=>{Tk(_)&&(h(_),x(_),s&&(_==="stories"?v():_==="postcards"&&j()))},[s,x,j,v]);n.useEffect(()=>{y.pathname==="/companion"&&b.current!=="/companion"&&h("overview"),b.current=y.pathname},[y.pathname]),n.useEffect(()=>{if(!s||!a?.id||!d?.id)return;const _=`${d.id}:${a.id}`;if(g.current===_)return;g.current=_;const C=window;let E=null,O=null;return C.requestIdleCallback?O=C.requestIdleCallback(()=>{T()},{timeout:1500}):E=window.setTimeout(()=>{T()},500),()=>{E!==null&&window.clearTimeout(E),O!==null&&C.cancelIdleCallback&&C.cancelIdleCallback(O)}},[a?.id,s,T,d?.id]);const R=()=>l?e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs("div",{className:"text-center space-y-4 p-6",children:[e.jsx(be,{className:"h-16 w-16 mx-auto text-destructive"}),e.jsx("h2",{className:"text-2xl font-bold",children:"Error Loading Companion"}),e.jsx("p",{className:"text-muted-foreground max-w-md",children:l instanceof Error?l.message:"Unable to load your companion data. Please try refreshing the page."}),e.jsx(z,{variant:"default",onClick:()=>{c()},className:"mt-4 h-11 px-6",children:"Retry"})]})}):!o&&!a?e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs("div",{className:"text-center space-y-4 p-6",children:[e.jsx(be,{className:"h-16 w-16 mx-auto text-primary"}),e.jsx("h2",{className:"text-2xl font-bold",children:"No Companion Found"}),e.jsx("p",{className:"text-muted-foreground max-w-md",children:"It looks like you haven't created your companion yet. Please complete the onboarding process to get started."}),e.jsx(z,{variant:"default",onClick:()=>w("/onboarding"),className:"mt-4 h-11 px-6",children:"Start Onboarding"})]})}):e.jsxs(fl,{value:p,onValueChange:D,className:"container pb-6",children:[e.jsxs(ui,{className:"grid w-full grid-cols-5 bg-card/80 backdrop-blur-md border border-border/60",children:[e.jsxs(Ss,{value:"overview",className:"flex items-center gap-2",children:[e.jsx(Rs,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Overview"})]}),e.jsxs(Ss,{value:"focus",className:"flex items-center gap-2",children:[e.jsx(ti,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Focus"})]}),e.jsxs(Ss,{value:"stories",className:"flex items-center gap-2",onPointerDown:S,onFocus:S,children:[e.jsx(Ir,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Stories"})]}),e.jsxs(Ss,{value:"postcards",className:"flex items-center gap-2",onPointerDown:N,onFocus:N,children:[e.jsx(Jr,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Postcards"})]}),e.jsxs(Ss,{value:"collection",className:"flex items-center gap-2",children:[e.jsx(Kg,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Collection"})]})]}),e.jsx(Re,{mode:"wait",children:o?e.jsx(P.div,{initial:{opacity:1},exit:{opacity:0},transition:{duration:t?0:.15},children:e.jsx(Ak,{})},"skeleton"):e.jsxs(P.div,{initial:t?!1:{opacity:0},animate:{opacity:1},transition:{duration:t?0:.2},children:[e.jsx(Es,{value:"overview",forceMount:!0,className:"data-[state=inactive]:hidden",children:f.overview&&e.jsx(oh,{companion:a,nextEvolutionXP:r,progressToNext:i})}),e.jsx(Es,{value:"focus",forceMount:!0,className:"data-[state=inactive]:hidden",children:f.focus&&e.jsx(th,{})}),e.jsx(Es,{value:"stories",forceMount:!0,className:"data-[state=inactive]:hidden",children:f.stories&&e.jsx(n.Suspense,{fallback:e.jsx(Hc,{}),children:e.jsx(Mk,{})})}),e.jsx(Es,{value:"postcards",forceMount:!0,className:"data-[state=inactive]:hidden",children:f.postcards&&e.jsx(n.Suspense,{fallback:e.jsx(Hc,{}),children:e.jsx(Dk,{})})}),e.jsx(Es,{value:"collection",forceMount:!0,className:"data-[state=inactive]:hidden",children:f.collection&&e.jsx(Yp,{})})]},"content")})]});return e.jsx(tn,{mode:"instant",children:e.jsxs(dp,{children:[e.jsx(an,{}),e.jsxs("div",{className:"min-h-screen pb-nav-safe relative z-10","data-tour":"companion-page",children:[e.jsx("header",{className:"fixed top-0 left-0 right-0 z-40 w-full cosmiq-glass-header safe-area-top",children:e.jsxs("div",{className:"container flex items-center justify-between py-4",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight",children:"Companion"}),e.jsx(z,{variant:"ghost",size:"icon",onClick:()=>w("/profile"),className:"h-8 w-8 rounded-full bg-muted/50 hover:bg-muted text-muted-foreground hover:text-foreground transition-colors","aria-label":"Settings",children:e.jsx(zg,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"pt-safe",style:{height:"calc(env(safe-area-inset-top, 0px) + 72px)"}}),R()]})]})})},Rk=({icon:t,title:s,description:a,actionLabel:r,onAction:i})=>e.jsxs("div",{className:"flex flex-col items-center justify-center text-center space-y-6 py-20",children:[e.jsx("div",{className:"mx-auto w-20 h-20 rounded-full bg-celestial-blue/10 flex items-center justify-center",children:e.jsx(t,{className:"h-10 w-10 text-celestial-blue"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl font-bold text-foreground",children:s}),e.jsx("p",{className:"text-muted-foreground max-w-md mx-auto",children:a})]}),r&&i&&e.jsx(z,{onClick:i,size:"lg",className:"mt-4",children:r})]}),Ik=/^([01]?\d|2[0-3]):([0-5]\d)$/,qk=/^([01]?\d|2[0-3]):([0-5]\d):([0-5]\d)$/,mi=t=>{if(!t)return null;const s=t.trim();if(!s)return null;const a=s.match(Ik);if(a){const l=Number(a[1]),c=Number(a[2]);return{hour:l,minute:c,normalized:`${String(l).padStart(2,"0")}:${String(c).padStart(2,"0")}`}}const r=s.match(qk);if(r){const l=Number(r[1]),c=Number(r[2]);return{hour:l,minute:c,normalized:`${String(l).padStart(2,"0")}:${String(c).padStart(2,"0")}`}}const i=kx(s,"h:mm a",new Date);if(va(i)){const l=i.getHours(),c=i.getMinutes();return{hour:l,minute:c,normalized:`${String(l).padStart(2,"0")}:${String(c).padStart(2,"0")}`}}const o=new Date(s);if(va(o)){const l=o.getHours(),c=o.getMinutes();return{hour:l,minute:c,normalized:ae(o,"HH:mm")}}return null},Mo=t=>mi(t)?.normalized??null,Gr=(t,s=new Date)=>{const a=mi(t);if(!a)return null;const r=new Date(s);return r.setHours(a.hour,a.minute,0,0),Number.isNaN(r.getTime())?null:r},Lk=t=>!t,Za=t=>{let s=t.task_date??null;const a=Mo(t.scheduled_time);let r=t.source??null,i=!1;const o=!1;let l=!1;return s===null&&a!==null&&(s=ae(new Date,"yyyy-MM-dd"),r==="inbox"&&(r="manual"),l=!0),Lk(t.habit_source_id)&&s!==null&&a===null&&(s=null,r="inbox",i=!0),{task_date:s,scheduled_time:a,habit_source_id:t.habit_source_id??null,source:r,normalizedToInbox:i,strippedScheduledTime:o,movedFromInboxToScheduled:l}},Rn=(t,s)=>Za({task_date:s.task_date!==void 0?s.task_date:t.task_date,scheduled_time:s.scheduled_time!==void 0?s.scheduled_time:t.scheduled_time,habit_source_id:s.habit_source_id!==void 0?s.habit_source_id:t.habit_source_id,source:s.source!==void 0?s.source:t.source}),Ok="cosmiq-offline-db",Fk=3,dh=["queued","syncing","failed"];let Ya=null;const pi=()=>Date.now(),gl=()=>`${Date.now()}-${Math.random().toString(36).slice(2,11)}`,Bn=t=>typeof t=="string"&&t.length>0,$k=t=>t==="TASK_COMPLETE"||t==="TASK_CREATE"||t==="TASK_UPDATE"||t==="TASK_DELETE"||t==="MENTOR_FEEDBACK"||t==="SUPPORT_REPORT"?t:null,Bk=t=>t==="task"||t==="mentor_feedback"||t==="support_report"||t==="unknown"?t:"unknown",Uk=t=>t==="queued"||t==="syncing"||t==="synced"||t==="failed"||t==="dropped"?t:"queued",Hk=t=>{switch(t){case"COMPLETE_TASK":return"TASK_COMPLETE";case"CREATE_TASK":return"TASK_CREATE";case"UPDATE_TASK":return"TASK_UPDATE";case"DELETE_TASK":return"TASK_DELETE";default:return"TASK_UPDATE"}},zk=t=>{switch(t){case"TASK_COMPLETE":case"TASK_CREATE":case"TASK_UPDATE":case"TASK_DELETE":return"task";case"MENTOR_FEEDBACK":return"mentor_feedback";case"SUPPORT_REPORT":return"support_report";default:return"unknown"}},hi=t=>{const s=t.user_id;if(!Bn(s))return null;const a=$k(t.action_kind);if(!a)return null;const r=typeof t.created_at=="number"?t.created_at:pi(),i=typeof t.updated_at=="number"?t.updated_at:r,o=t.payload&&typeof t.payload=="object"&&!Array.isArray(t.payload)?t.payload:{};return{id:Bn(t.id)?t.id:gl(),user_id:s,action_kind:a,entity_type:Bk(t.entity_type),entity_id:typeof t.entity_id=="string"?t.entity_id:null,payload:o,retry_count:typeof t.retry_count=="number"?t.retry_count:0,last_error:typeof t.last_error=="string"?t.last_error:null,status:Uk(t.status),created_at:r,updated_at:i}},Kk=t=>{const s=t.user_id;if(!Bn(s))return null;const a=Hk(t.type),r=t.payload&&typeof t.payload=="object"&&!Array.isArray(t.payload)?t.payload:{},i=typeof t.timestamp=="number"?t.timestamp:pi();let o=null;const l=r.taskId;return typeof l=="string"&&(o=l),{id:Bn(t.id)?t.id:gl(),user_id:s,action_kind:a,entity_type:"task",entity_id:o,payload:r,retry_count:typeof t.retries=="number"?t.retries:0,last_error:null,status:"queued",created_at:i,updated_at:i}};async function uh(){return Ya||new Promise((t,s)=>{const a=indexedDB.open(Ok,Fk);a.onerror=()=>{console.error("Failed to open offline database:",a.error),s(a.error)},a.onsuccess=()=>{Ya=a.result,t(Ya)},a.onupgradeneeded=r=>{const i=r.target.result;i.objectStoreNames.contains("tasks")||i.createObjectStore("tasks",{keyPath:"id"});const o=i.objectStoreNames.contains("pendingActions")?r.target.transaction.objectStore("pendingActions"):i.createObjectStore("pendingActions",{keyPath:"id"});o.indexNames.contains("timestamp")||o.createIndex("timestamp","timestamp"),o.indexNames.contains("user_id")||o.createIndex("user_id","user_id"),o.indexNames.contains("status")||o.createIndex("status","status"),o.indexNames.contains("created_at")||o.createIndex("created_at","created_at"),o.indexNames.contains("action_kind")||o.createIndex("action_kind","action_kind"),o.indexNames.contains("entity_type")||o.createIndex("entity_type","entity_type"),i.objectStoreNames.contains("cache")||i.createObjectStore("cache",{keyPath:"key"});const l=o.openCursor();l.onsuccess=()=>{const c=l.result;if(!c)return;const d=c.value,u=hi(d);if(u){c.update(u),c.continue();return}const p=Kk(d);p?c.update(p):c.delete(),c.continue()}}})}async function fi(){return Ya||uh()}async function Qk(t){try{if(!t.userId)throw new Error("User ID is required for queued actions");const r=(await fi()).transaction("pendingActions","readwrite").objectStore("pendingActions"),i=pi(),o={id:gl(),user_id:t.userId,action_kind:t.actionKind,entity_type:t.entityType??zk(t.actionKind),entity_id:t.entityId??null,payload:t.payload,retry_count:0,last_error:null,status:t.status??"queued",created_at:i,updated_at:i};return await new Promise((l,c)=>{const d=r.add(o);d.onsuccess=()=>l(),d.onerror=()=>c(d.error)}),o.id}catch(s){throw console.error("Failed to enqueue action:",s),s}}async function Do(t){try{if(!t)return[];const i=(await fi()).transaction("pendingActions","readonly").objectStore("pendingActions").index("user_id");return new Promise((o,l)=>{const c=i.getAll(t);c.onsuccess=()=>{const d=(c.result||[]).map(u=>hi(u)).filter(u=>u!==null);d.sort((u,p)=>u.created_at-p.created_at),o(d)},c.onerror=()=>l(c.error)})}catch(s){return console.error("Failed to get queued actions:",s),[]}}async function Wk(t){return(await Do(t)).filter(a=>dh.includes(a.status))}async function Gk(t,s=dh){try{const i=(await fi()).transaction("pendingActions","readonly").objectStore("pendingActions");return(await(()=>{if(!t)return new Promise((u,p)=>{const h=i.getAll();h.onsuccess=()=>u(h.result||[]),h.onerror=()=>p(h.error)});const d=i.index("user_id");return new Promise((u,p)=>{const h=d.getAll(t);h.onsuccess=()=>u(h.result||[]),h.onerror=()=>p(h.error)})})()).map(d=>hi(d)).filter(d=>d!==null).filter(d=>s.includes(d.status)).length}catch(a){return console.error("Failed to get queued action count:",a),0}}async function Pr(t,s){try{const i=(await fi()).transaction("pendingActions","readwrite").objectStore("pendingActions"),o=await new Promise((c,d)=>{const u=i.get(t);u.onsuccess=()=>{const p=hi(u.result||null);c(p)},u.onerror=()=>d(u.error)});if(!o)return;const l={...o,...s,updated_at:pi()};await new Promise((c,d)=>{const u=i.put(l);u.onsuccess=()=>c(),u.onerror=()=>d(u.error)})}catch(a){console.error("Failed to update queued action:",a)}}async function zc(t){await Pr(t,{status:"queued",last_error:null})}async function Yk(t,s){await Pr(t,{status:"dropped",last_error:"Discarded by user"})}const Vk=["load failed","failed to fetch","network request failed","typeerror: failed to fetch","networkerror","timeout","connection","fetch"];function Un(t){return t instanceof Error?t.message:typeof t=="string"?t:t&&typeof t=="object"&&"message"in t&&typeof t.message=="string"?t.message:"Unknown error"}function mh(t){return!t||typeof t!="object"?null:"status"in t&&typeof t.status=="number"?t.status??null:null}function Xk(t){const s=Un(t).toLowerCase();return Vk.some(a=>s.includes(a))}function Ms(t){if(typeof navigator<"u"&&!navigator.onLine)return!0;const s=mh(t);return typeof s=="number"&&s>=500?!0:Xk(t)}function ta(t,s){ue.info(`[ResilienceTelemetry] ${t}`,s??{})}const Jk=3;async function Zk(t,s){switch(s.action_kind){case"TASK_COMPLETE":{const{taskId:a,completed:r,completedAt:i}=s.payload,{error:o}=await k.from("daily_tasks").update({completed:r,completed_at:i}).eq("id",a).eq("user_id",t);if(o)throw o;return}case"TASK_CREATE":{const a=s.payload,{error:r}=await k.from("daily_tasks").insert([{task_text:a.task_text,difficulty:a.difficulty,xp_reward:a.xp_reward,task_date:a.task_date??null,user_id:t,is_main_quest:a.is_main_quest??!1,scheduled_time:a.scheduled_time??null,estimated_duration:a.estimated_duration??null,recurrence_pattern:a.recurrence_pattern??null,recurrence_days:a.recurrence_days??null,recurrence_end_date:a.recurrence_end_date??null,is_recurring:!!a.recurrence_pattern,reminder_enabled:a.reminder_enabled??!1,reminder_minutes_before:a.reminder_minutes_before??15,category:a.category??null,notes:a.notes??null,contact_id:a.contact_id??null,auto_log_interaction:a.auto_log_interaction??!0,image_url:a.image_url??null,location:a.location??null,source:a.source??(a.task_date===null?"inbox":"manual")}]);if(r)throw r;return}case"TASK_UPDATE":{const{taskId:a,updates:r}=s.payload,i={...r};if(delete i.attachments,Object.keys(i).length===0)return;const{error:o}=await k.from("daily_tasks").update(i).eq("id",a).eq("user_id",t);if(o)throw o;return}case"TASK_DELETE":{const{taskId:a}=s.payload,{error:r}=await k.from("daily_tasks").delete().eq("id",a).eq("user_id",t);if(r)throw r;return}case"MENTOR_FEEDBACK":{const{message_content:a,feedback_type:r}=s.payload,{error:i}=await k.from("mentor_chat_feedback").insert({user_id:t,message_content:a,feedback_type:r});if(i)throw i;return}case"SUPPORT_REPORT":{const{error:a}=await k.functions.invoke("submit-support-report",{body:s.payload});if(a)throw a;return}default:throw new Error(`Unsupported queued action kind: ${s.action_kind}`)}}function eC(){const{user:t}=_e(),{toast:s}=_s(),[a,r]=n.useState({pendingCount:0,syncStatus:"idle",lastSyncError:null,receipts:[]}),i=n.useRef(!1),o=n.useCallback(async()=>{if(!t?.id){r(y=>({...y,pendingCount:0,receipts:[]}));return}const[m,g]=await Promise.all([Gk(t.id),Do(t.id)]);r(y=>({...y,pendingCount:m,receipts:g}))},[t?.id]);n.useEffect(()=>{let m=!1;return(async()=>{try{await uh(),m||await o()}catch(y){console.error("Failed to initialize offline queue:",y)}})(),()=>{m=!0}},[o]);const l=n.useCallback(async({actionKind:m,entityType:g,entityId:y,payload:b})=>{if(!t?.id)throw new Error("User not authenticated");const w=await Qk({userId:t.id,actionKind:m,entityType:g,entityId:y,payload:b});return ta("queued_action_created",{actionKind:m,entityType:g,entityId:y}),await o(),w},[o,t?.id]),c=n.useCallback(async(m,g)=>l({actionKind:m==="COMPLETE_TASK"?"TASK_COMPLETE":m==="CREATE_TASK"?"TASK_CREATE":m==="DELETE_TASK"?"TASK_DELETE":"TASK_UPDATE",entityType:"task",entityId:typeof g.taskId=="string"?g.taskId:null,payload:g}),[l]),d=n.useCallback(async()=>{if(i.current||!navigator.onLine||!t?.id)return{success:0,failed:0};i.current=!0,r(y=>({...y,syncStatus:"syncing",lastSyncError:null}));let m=0,g=0;try{const y=await Wk(t.id);for(const b of y)if(!(b.status==="failed"&&b.retry_count>=Jk)){await Pr(b.id,{status:"syncing"});try{await Zk(t.id,b),await Pr(b.id,{status:"synced",last_error:null}),m+=1,ta("queued_action_synced",{actionKind:b.action_kind,entityType:b.entity_type,id:b.id})}catch(w){const x=Un(w);await Pr(b.id,{status:"failed",retry_count:b.retry_count+1,last_error:x}),g+=1,ta("queued_action_failed",{actionKind:b.action_kind,entityType:b.entity_type,id:b.id,error:x})}}return await o(),r(b=>({...b,syncStatus:g===0?"success":"error",lastSyncError:g>0?`${g} queued action${g>1?"s":""} failed to sync`:null})),m>0&&s({title:"Queued actions synced",description:`${m} action${m>1?"s":""} synced successfully`}),window.setTimeout(()=>{r(b=>({...b,syncStatus:"idle"}))},3e3),{success:m,failed:g}}catch(y){console.error("Failed to sync queued actions:",y);const b=Un(y);return r(w=>({...w,syncStatus:"error",lastSyncError:b})),{success:m,failed:g}}finally{i.current=!1}},[o,s,t?.id]);n.useEffect(()=>{const m=()=>{d()};return window.addEventListener("online",m),()=>window.removeEventListener("online",m)},[d]);const u=n.useCallback(async m=>{await zc(m),await o(),await d()},[o,d]),p=n.useCallback(async m=>{await Yk(m),await o()},[o]),h=n.useCallback(async()=>{if(!t?.id)return;const g=(await Do(t.id)).filter(y=>y.status==="failed");await Promise.all(g.map(y=>zc(y.id))),await o(),await d()},[o,d,t?.id]),f=n.useCallback(async()=>{if(t?.id){if(!navigator.onLine){s({title:"You're offline",description:"Sync will resume automatically when connection is restored",variant:"destructive"});return}return d()}},[d,s,t?.id]);return{pendingCount:a.pendingCount,syncStatus:a.syncStatus,lastSyncError:a.lastSyncError,receipts:a.receipts,queueAction:l,queueTaskAction:c,retryAction:u,retryAllFailed:h,discardAction:p,refreshQueueState:o,triggerSync:f,syncPendingActions:d}}function ph(t){return t.isOnline?t.backendHealth==="outage"||t.probeFailures>=t.outageThreshold?"outage":t.hasIncident&&t.backendHealth==="healthy"&&t.queueCount>0?"recovering":!t.degradedDismissed&&t.degradedByErrors&&t.backendHealth==="healthy"?"degraded":"healthy":"offline"}function tC(t){const s=ph(t),a=t.now??Date.now();return s==="healthy"&&t.showRecoveredUntil>a?"recovered":s}async function sC(t){const{error:s}=await k.functions.invoke("submit-support-report",{body:t});if(s)throw s}const Kc=/(token|authorization|cookie|apikey|api_key|password|secret|session|jwt)/i,kr=t=>t.replace(/(Bearer\s+)[A-Za-z0-9\-._~+/=]+/gi,"$1[redacted]").replace(/\beyJ[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\.[A-Za-z0-9_-]+\b/g,"[redacted-jwt]").replace(/\bsk-[A-Za-z0-9_-]+\b/g,"[redacted-key]").replace(/([?&](?:token|access_token|refresh_token|apikey|api_key)=)[^&\s]+/gi,"$1[redacted]"),Ao=(t,s)=>{if(typeof t=="string")return kr(t);if(Array.isArray(t))return t.map(a=>Ao(a));if(t&&typeof t=="object"){const a={};for(const[r,i]of Object.entries(t))Kc.test(r)||s&&Kc.test(s)?a[r]="[redacted]":a[r]=Ao(i,r);return a}return t};function aC(t){const s=kr(t.route),a=t.recentErrorFingerprints.slice(-20).map(r=>kr(r).slice(0,240));return{appVersion:kr(t.appVersion),platform:t.platform,route:s,authState:t.authState,connectivity:{isOnline:t.connectivity.isOnline,resilienceState:t.connectivity.resilienceState,backendHealth:t.connectivity.backendHealth},queueDepth:Number.isFinite(t.queueDepth)?Math.max(0,t.queueDepth):0,recentErrorFingerprints:a,userAgent:kr(t.userAgent),capturedAt:t.capturedAt}}function rC(t){const s=Ao({category:t.category,summary:t.summary,reproductionSteps:t.reproductionSteps,expectedBehavior:t.expectedBehavior,actualBehavior:t.actualBehavior,consentDiagnostics:t.consentDiagnostics});return{...t,category:s.category,summary:s.summary,reproductionSteps:s.reproductionSteps,expectedBehavior:s.expectedBehavior,actualBehavior:s.actualBehavior,diagnostics:aC(t.diagnostics)}}const nC=3e4,iC=8e3,so=3,oC=3,lC=120*1e3,cC=5e3,hh=n.createContext(void 0);function dC(t,s){const a=Un(t),r=s&&Object.keys(s).length>0?JSON.stringify(s):"";return`${a}${r?` | ${r}`:""}`.slice(0,220)}function uC({children:t}){const{user:s}=_e(),{pendingCount:a,syncStatus:r,lastSyncError:i,receipts:o,queueAction:l,queueTaskAction:c,retryAction:d,retryAllFailed:u,discardAction:p,triggerSync:h}=eC(),[f,m]=n.useState(typeof navigator<"u"?navigator.onLine:!0),[g,y]=n.useState("unknown"),[b,w]=n.useState(0),[x,v]=n.useState(null),[j,T]=n.useState([]),[S,N]=n.useState([]),[D,R]=n.useState(0),[_,C]=n.useState(!1),E=n.useRef(!1),O=n.useRef(null),M=n.useCallback((ee,ie)=>ee.filter(fe=>ie-fe<=lC),[]),A=n.useCallback((ee,ie)=>{if(!Ms(ee))return;const fe=Date.now();T(U=>M([...U,fe],fe)),N(U=>{const ce=dC(ee,ie),se=[...U,ce];return se.slice(Math.max(0,se.length-20))})},[M]),L=n.useCallback(async()=>{if(!f){y("unknown");return}const ee="https://opbfpbbqvuksuvmtmssd.supabase.co",ie="sb_publishable_JIATfg-h-gcg2TLZGmQeSw_XcHqQZvB",fe=new AbortController,U=window.setTimeout(()=>fe.abort(),iC);try{const ce=await fetch(`${ee}/auth/v1/health`,{method:"GET",headers:{apikey:ie,Authorization:`Bearer ${ie}`},signal:fe.signal});if(!ce.ok)throw new Error(`Health probe failed with ${ce.status}`);const se=Date.now();w(0),y("healthy"),v(se)}catch(ce){A(ce,{source:"health_probe"}),w(se=>se+1),y(se=>se==="outage"?"outage":"degraded")}finally{window.clearTimeout(U)}},[f,A]);n.useEffect(()=>{const ee=()=>{m(!0),C(!1),L()},ie=()=>{m(!1),E.current=!0};return window.addEventListener("online",ee),window.addEventListener("offline",ie),()=>{window.removeEventListener("online",ee),window.removeEventListener("offline",ie)}},[L]),n.useEffect(()=>{if(!f)return;L();const ee=window.setInterval(()=>{document.visibilityState==="visible"&&L()},nC);return()=>{window.clearInterval(ee)}},[f,L]),n.useEffect(()=>{b>=so&&(y("outage"),E.current=!0)},[b]),n.useEffect(()=>{const ee=Date.now();T(ie=>{const fe=M(ie,ee);return fe.length===ie.length?ie:fe})},[M,j]);const $=n.useMemo(()=>{const ee=Date.now();return M(j,ee).length},[M,j])>=oC,B=n.useMemo(()=>ph({isOnline:f,backendHealth:g,probeFailures:b,outageThreshold:so,hasIncident:E.current,queueCount:a,degradedByErrors:$,degradedDismissed:_}),[g,$,_,f,a,b]);n.useEffect(()=>{(B==="offline"||B==="outage")&&(E.current=!0),(B==="recovering"||E.current)&&a===0&&f&&g==="healthy"&&(E.current=!1,R(Date.now()+cC),ta("queue_recovered",{recoveredAt:new Date().toISOString()}))},[g,B,f,a]);const W=n.useMemo(()=>tC({isOnline:f,backendHealth:g,probeFailures:b,outageThreshold:so,hasIncident:E.current,queueCount:a,degradedByErrors:$,degradedDismissed:_,showRecoveredUntil:D}),[g,$,_,f,a,b,D]);n.useEffect(()=>{if(W==="healthy"){O.current=null;return}O.current!==W&&(O.current=W,ta("status_banner_shown",{state:W,queueCount:a,backendHealth:g}))},[g,a,W]);const H=n.useCallback(async ee=>{if(!s?.id)throw new Error("You must be signed in to report issues");const ie=rC(ee);if(!f||W==="outage")return await l({actionKind:"SUPPORT_REPORT",entityType:"support_report",entityId:ie.correlationId,payload:ie}),ta("support_report_queued",{correlationId:ie.correlationId,reason:W}),{queued:!0,submitted:!1};try{return await sC(ie),ta("support_report_submitted",{correlationId:ie.correlationId}),{queued:!1,submitted:!0}}catch(fe){if(A(fe,{source:"support_report_submit"}),mh(fe)===404||Ms(fe))return await l({actionKind:"SUPPORT_REPORT",entityType:"support_report",entityId:ie.correlationId,payload:ie}),ta("support_report_queued",{correlationId:ie.correlationId,reason:"network_or_outage"}),{queued:!0,submitted:!1};throw fe}},[f,l,A,W,s?.id]),K=n.useCallback(()=>{C(!0)},[]),X=!f||W==="offline"||W==="outage",Y=n.useMemo(()=>({state:W,isOnline:f,backendHealth:g,queueCount:a,lastHealthyAt:x,receipts:o.map(ee=>({id:ee.id,actionKind:ee.action_kind,entityType:ee.entity_type,entityId:ee.entity_id,status:ee.status,retryCount:ee.retry_count,lastError:ee.last_error,createdAt:ee.created_at,updatedAt:ee.updated_at})),syncStatus:r,lastSyncError:i,shouldQueueWrites:X,retryAll:u,retryAction:d,discardAction:p,retryNow:h,queueAction:l,queueTaskAction:c,reportIssue:H,reportApiFailure:A,recentErrorFingerprints:S,dismissDegraded:K}),[g,K,f,x,i,a,l,c,o,S,A,H,d,u,X,W,r,h,p]);return e.jsx(hh.Provider,{value:Y,children:t})}function gi(){const t=n.useContext(hh);if(!t)throw new Error("useResilience must be used within a ResilienceProvider");return t}const fh="inbox-tasks",gh="inbox-count",mC=t=>[fh,t],pC=t=>[gh,t],hC=async t=>{const{data:s,error:a}=await k.from("daily_tasks").select("*").eq("user_id",t).is("task_date",null).eq("completed",!1).order("created_at",{ascending:!1});if(a)throw a;return s||[]},fC=async t=>{const{count:s,error:a}=await k.from("daily_tasks").select("id",{count:"exact",head:!0}).eq("user_id",t).is("task_date",null).eq("completed",!1);if(a)throw a;return s??0},gC=(t={})=>{const{user:s}=_e(),{shouldQueueWrites:a,queueTaskAction:r,reportApiFailure:i}=gi(),o=Ie(),{enabled:l=!0}=t,c=n.useCallback(()=>{o.invalidateQueries({queryKey:[fh]}),o.invalidateQueries({queryKey:[gh]})},[o]),{data:d=[],isLoading:u}=Ee({queryKey:mC(s?.id),queryFn:async()=>s?.id?hC(s.id):[],enabled:l&&!!s?.id,staleTime:30*1e3,gcTime:1800*1e3,placeholderData:m=>m,refetchOnWindowFocus:!1}),p=he({mutationFn:async({taskId:m,targetDate:g})=>{if(a)return await r("UPDATE_TASK",{taskId:m,updates:{task_date:g}}),{queued:!0};const{data:y,error:b}=await k.from("daily_tasks").select("task_date, scheduled_time, habit_source_id, source").eq("id",m).maybeSingle();if(b){if(Ms(b))return await r("UPDATE_TASK",{taskId:m,updates:{task_date:g}}),{queued:!0};throw i(b,{source:"inbox_schedule_fetch"}),b}if(!y)throw new Error("Task not found");const w=Za({task_date:g,scheduled_time:y.scheduled_time,habit_source_id:y.habit_source_id,source:y.source}),x={task_date:w.task_date,scheduled_time:w.scheduled_time};w.source!==y.source&&(x.source=w.source);const{error:v}=await k.from("daily_tasks").update(x).eq("id",m);if(v){if(Ms(v))return await r("UPDATE_TASK",{taskId:m,updates:x}),{queued:!0};throw i(v,{source:"inbox_schedule_update"}),v}return w},onSuccess:m=>{if(c(),o.invalidateQueries({queryKey:["daily-tasks"]}),m?.queued){V("Quest schedule queued. It will sync when connection is restored.");return}m?.normalizedToInbox&&V("Regular quests without time stay in Inbox.")}}),h=he({mutationFn:async({taskId:m,completed:g})=>{if(a)return await r("COMPLETE_TASK",{taskId:m,completed:g,completedAt:g?new Date().toISOString():null}),{queued:!0};const{error:y}=await k.from("daily_tasks").update({completed:g,completed_at:g?new Date().toISOString():null}).eq("id",m);if(y){if(Ms(y))return await r("COMPLETE_TASK",{taskId:m,completed:g,completedAt:g?new Date().toISOString():null}),{queued:!0};throw i(y,{source:"inbox_toggle"}),y}return{queued:!1}},onSuccess:m=>{c(),o.invalidateQueries({queryKey:["daily-tasks"]}),m?.queued&&V("Quest completion queued. It will sync when connection is restored.")}}),f=he({mutationFn:async m=>{if(a)return await r("DELETE_TASK",{taskId:m}),{queued:!0};const{error:g}=await k.from("daily_tasks").delete().eq("id",m);if(g){if(Ms(g))return await r("DELETE_TASK",{taskId:m}),{queued:!0};throw i(g,{source:"inbox_delete"}),g}return{queued:!1}},onSuccess:m=>{c(),o.invalidateQueries({queryKey:["daily-tasks"]}),m?.queued&&V("Quest deletion queued. It will sync when connection is restored.")}});return{inboxTasks:d,inboxCount:d.length,isLoading:u,scheduleTask:p.mutate,toggleInboxTask:h.mutate,deleteInboxTask:f.mutate}},xC=()=>{const{user:t}=_e(),{data:s=0}=Ee({queryKey:pC(t?.id),queryFn:async()=>t?.id?fC(t.id):0,enabled:!!t?.id,staleTime:30*1e3,gcTime:1800*1e3,placeholderData:a=>a,refetchOnWindowFocus:!1});return{inboxCount:s}},Qc="add-quest-fab-position",yC=500,bC={"top-left":{top:"calc(env(safe-area-inset-top, 0px) + 80px)",left:"16px",bottom:"auto",right:"auto"},"top-right":{top:"calc(env(safe-area-inset-top, 0px) + 80px)",right:"16px",bottom:"auto",left:"auto"},"bottom-left":{bottom:"144px",left:"16px",top:"auto",right:"auto"},"bottom-right":{bottom:"144px",right:"16px",top:"auto",left:"auto"}},Wc=async(t=Ut.Medium)=>{if(Ze.isNativePlatform())try{await ws.impact({style:t})}catch{}},wC=(t,s)=>{const a=window.innerWidth/2,r=window.innerHeight/2;return s<r&&t<a?"top-left":s<r?"top-right":t<a?"bottom-left":"bottom-right"},vC=({defaultPosition:t="bottom-right",onDragStart:s,onDragEnd:a}={})=>{const[r,i]=n.useState(()=>{const S=st.getItem(Qc);return S&&["top-left","top-right","bottom-left","bottom-right"].includes(S)?S:t}),[o,l]=n.useState(!1),[c,d]=n.useState(!1),[u,p]=n.useState({x:0,y:0}),h=n.useRef(null),f=n.useRef(null);n.useEffect(()=>()=>{h.current&&clearTimeout(h.current)},[]),n.useEffect(()=>{st.setItem(Qc,r)},[r]);const m=n.useCallback(()=>{h.current&&(clearTimeout(h.current),h.current=null)},[]),g=n.useCallback(S=>{S.preventDefault();const N=S.target.getBoundingClientRect();f.current={x:N.left+N.width/2,y:N.top+N.height/2},h.current=setTimeout(()=>{d(!0),Wc(Ut.Medium)},yC)},[]),y=n.useCallback(()=>{m(),o||d(!1)},[m,o]),b=n.useCallback(()=>{m(),d(!1)},[m]),w=n.useCallback(()=>{c&&(l(!0),s?.())},[c,s]),x=n.useCallback((S,N)=>{if(!o){d(!1);return}const D=(f.current?.x||window.innerWidth/2)+N.offset.x,R=(f.current?.y||window.innerHeight/2)+N.offset.y,_=wC(D,R);i(_),l(!1),d(!1),p({x:0,y:0}),Wc(Ut.Light),a?.(_)},[o,a]),v=n.useMemo(()=>bC[r],[r]),j=n.useMemo(()=>({drag:c,dragConstraints:{top:-500,left:-500,right:500,bottom:500},dragElastic:.1,dragMomentum:!1,onDragStart:w,onDragEnd:x}),[c,w,x]),T=n.useMemo(()=>({onPointerDown:g,onPointerUp:y,onPointerCancel:b}),[g,y,b]);return{position:r,isDragging:o,isLongPressing:c,dragControls:j,longPressHandlers:T,positionStyles:v,dragOffset:u}},xh=({onTap:t})=>{const{isDragging:s,isLongPressing:a,dragControls:r,longPressHandlers:i,positionStyles:o}=vC(),l=()=>{!s&&!a&&t()},c=d=>{d.preventDefault()};return e.jsx(P.button,{"data-tour":"add-quest-fab",initial:{scale:0,opacity:0},animate:{scale:s?1.15:1,opacity:1,boxShadow:s?"0 8px 30px rgba(0,0,0,0.3)":"0 2px 8px rgba(0,0,0,0.1)"},whileTap:a?void 0:{scale:.9},onClick:l,onTouchStart:c,style:{position:"fixed",zIndex:50,WebkitTouchCallout:"none",WebkitUserSelect:"none",userSelect:"none",...o},className:"w-11 h-11 rounded-full bg-muted/60 backdrop-blur-sm border border-border/50 flex items-center justify-center hover:bg-muted/80 transition-colors touch-none select-none",...r,...i,children:e.jsx(qr,{className:"w-5 h-5 text-muted-foreground"})})},ka=n.forwardRef(({className:t,...s},a)=>e.jsx(Ru,{ref:a,className:I("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...s,children:e.jsx(Qg,{className:I("flex items-center justify-center text-current"),children:e.jsx(Rt,{className:"h-4 w-4"})})}));ka.displayName=Ru.displayName;const Hn=n.forwardRef(({className:t,onCheckedChange:s,...a},r)=>e.jsx(Iu,{className:I("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50",t),onCheckedChange:i=>{gt.light(),s?.(i)},...a,ref:r,children:e.jsx(Wg,{className:I("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})}));Hn.displayName=Iu.displayName;const Gc=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],_C=({selectedDays:t,onDaysChange:s,selectionMode:a="multiple"})=>{const r=o=>{if(a==="single"){if(t.length===1&&t[0]===o)return;s([o]);return}t.includes(o)?s(t.filter(l=>l!==o)):s([...t,o].sort())},i=()=>{s([0,1,2,3,4,5,6])};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h4",{className:"text-sm font-medium text-foreground",children:["Select days (",t.length,"/7)"]}),a==="multiple"&&e.jsx("button",{onClick:i,className:"text-xs text-primary hover:text-primary/80 font-medium",children:"Select all"})]}),e.jsx("div",{className:"grid grid-cols-7 gap-2",children:Gc.map((o,l)=>e.jsx("button",{onClick:()=>r(l),"aria-label":Gc[l],className:I("aspect-square rounded-full flex items-center justify-center text-xs font-bold transition-all border-2",t.includes(l)?"bg-primary border-primary text-primary-foreground shadow-glow":"border-border bg-card text-muted-foreground hover:border-primary/50"),children:o.charAt(0)},o))})]})};function jC(){const[t,s]=n.useState([]),[a,r]=n.useState(!1),[i,o]=n.useState(null),l=n.useCallback(async(d,u=30,p="medium")=>{r(!0),o(null);try{const{data:h,error:f}=await k.functions.invoke("suggest-task-times",{body:{task_date:ae(d,"yyyy-MM-dd"),estimated_duration:u,difficulty:p}});if(f)throw new Error(f.message);s(h?.suggestedSlots||[])}catch(h){console.error("[useSmartScheduling] Error fetching suggestions:",h),o(h instanceof Error?h.message:"Failed to get suggestions"),s([])}finally{r(!1)}},[]),c=n.useCallback(()=>{s([]),o(null)},[]);return{suggestedSlots:t,isLoading:a,error:i,getSuggestedSlots:l,clearSuggestions:c}}function NC(t){const[s,a]=t.split(":").map(Number),r=s>=12?"PM":"AM";return`${s%12||12}:${a.toString().padStart(2,"0")} ${r}`}function kC(t){const s=t.getDay();return s===0?6:s-1}const xl=t=>{const{suggestedSlots:s,getSuggestedSlots:a,isLoading:r}=jC(),[i,o]=n.useState(!1),l=[{value:15,label:"15 min"},{value:30,label:"30 min"},{value:45,label:"45 min"},{value:60,label:"1 hr"},{value:90,label:"1.5 hrs"},{value:120,label:"2 hrs"}],c=[{value:5,label:"5 minutes before"},{value:10,label:"10 minutes before"},{value:15,label:"15 minutes before"},{value:30,label:"30 minutes before"},{value:60,label:"1 hour before"},{value:120,label:"2 hours before"},{value:1440,label:"1 day before"},{value:10080,label:"1 week before"}],d=[{value:"none",label:"None"},{value:"daily",label:"Daily"},{value:"weekdays",label:"Weekdays"},{value:"weekly",label:"Weekly"},{value:"biweekly",label:"Every 2 Weeks"},{value:"monthly",label:"Monthly"},{value:"custom",label:"Custom Days"}],[u,p]=n.useState(!1),[h,f]=n.useState(!1),[m,g]=n.useState(!1),y=async()=>{t.selectedDate&&(await a(t.selectedDate,t.estimatedDuration||30,t.taskDifficulty),o(!0))},b=s.slice(0,3),w=n.useMemo(()=>kC(t.selectedDate??new Date),[t.selectedDate]),x=n.useMemo(()=>t.recurrencePattern==="weekly"&&t.recurrenceDays.length>1?"custom":t.recurrencePattern,[t.recurrencePattern,t.recurrenceDays]);n.useEffect(()=>{t.recurrencePattern==="weekly"&&t.recurrenceDays.length>1&&t.onRecurrencePatternChange("custom")},[t.recurrencePattern,t.recurrenceDays,t.onRecurrencePatternChange]),n.useEffect(()=>{x!=="weekly"&&x!=="biweekly"||t.recurrenceDays.length!==1&&t.onRecurrenceDaysChange([w])},[x,t.recurrenceDays,t.onRecurrenceDaysChange,w]);const v=T=>{t.onScheduledTimeChange(T),o(!1)},j=n.useCallback(T=>{if(T==="none"){t.onRecurrencePatternChange(null),t.onRecurrenceDaysChange([]),f(!1);return}t.onRecurrencePatternChange(T),T==="weekdays"?t.onRecurrenceDaysChange([0,1,2,3,4]):T==="weekly"||T==="biweekly"?t.onRecurrenceDaysChange([w]):(T==="daily"||T==="monthly")&&t.onRecurrenceDaysChange([]),f(!1)},[t,w]);return e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[!t.hideScheduledTime&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ht,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(ct,{className:"text-sm font-medium",children:"Scheduled Time"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(mt,{type:"time",step:300,value:t.scheduledTime||"",onChange:T=>t.onScheduledTimeChange(T.target.value||null),className:"flex-1"}),t.selectedDate&&e.jsxs(qs,{open:i,onOpenChange:o,children:[e.jsx(Ls,{asChild:!0,children:e.jsx(z,{type:"button",variant:"outline",size:"icon",onClick:y,disabled:r,className:"shrink-0",children:r?e.jsx(Nt,{className:"h-4 w-4 animate-spin"}):e.jsx(be,{className:"h-4 w-4 text-primary"})})}),e.jsx(js,{className:"w-64 p-2",align:"end",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground px-2 py-1",children:"Suggested Times"}),b.length===0?e.jsx("p",{className:"text-sm text-muted-foreground px-2 py-2",children:"No suggestions available"}):b.map((T,S)=>e.jsx("button",{type:"button",onClick:()=>v(T.time),className:"w-full flex items-start gap-2 px-2 py-2 text-left rounded-md hover:bg-accent transition-colors",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[S===0&&e.jsx(Mt,{className:"h-3 w-3 text-amber-500 fill-amber-500"}),e.jsx("span",{className:"font-medium text-sm",children:NC(T.time)})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:T.reason})]})},T.time))]})})]})]})]}),!t.hideDuration&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zt,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(ct,{className:"text-sm font-medium",children:"Estimated Duration"})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>p(!u),className:"w-full px-3 py-2 text-sm text-left border rounded-lg bg-background hover:bg-accent transition-colors flex items-center justify-between",children:[e.jsx("span",{children:t.estimatedDuration?l.find(T=>T.value===t.estimatedDuration)?.label||`${t.estimatedDuration} min`:"Select duration"}),e.jsx(Ws,{className:"w-4 h-4 text-muted-foreground"})]}),u&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-popover border rounded-lg shadow-lg max-h-48 overflow-y-auto",children:l.map(T=>e.jsx("button",{type:"button",onClick:()=>{t.onEstimatedDurationChange(T.value),p(!1)},className:`w-full px-3 py-2 text-sm text-left hover:bg-accent transition-colors ${t.estimatedDuration===T.value?"bg-accent":""}`,children:T.label},T.value))})]})]}),t.scheduledTime&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Gg,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(ct,{className:"text-sm font-medium",children:"Early Reminder"})]}),e.jsx(Hn,{checked:t.reminderEnabled,onCheckedChange:t.onReminderEnabledChange})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"You'll be notified when the quest starts. Add an early reminder to prepare ahead."}),t.reminderEnabled&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>g(!m),className:"w-full px-3 py-2 text-sm text-left border rounded-lg bg-background hover:bg-accent transition-colors flex items-center justify-between",children:[e.jsx("span",{children:c.find(T=>T.value===t.reminderMinutesBefore)?.label||"Select time"}),e.jsx(Ws,{className:"w-4 h-4 text-muted-foreground"})]}),m&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-popover border rounded-lg shadow-lg max-h-48 overflow-y-auto",children:c.map(T=>e.jsx("button",{type:"button",onClick:()=>{t.onReminderMinutesBeforeChange(T.value),g(!1)},className:`w-full px-3 py-2 text-sm text-left hover:bg-accent transition-colors ${t.reminderMinutesBefore===T.value?"bg-accent":""}`,children:T.label},T.value))})]})]}),!t.hideRecurrence&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(nr,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(ct,{className:"text-sm font-medium",children:"Recurrence"})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>f(!h),className:"w-full px-3 py-2 text-sm text-left border rounded-lg bg-background hover:bg-accent transition-colors flex items-center justify-between",children:[e.jsx("span",{children:d.find(T=>T.value===(x||"none"))?.label||"None"}),e.jsx(Ws,{className:"w-4 h-4 text-muted-foreground"})]}),h&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-popover border rounded-lg shadow-lg",children:d.map(T=>e.jsx("button",{type:"button",onClick:()=>j(T.value),className:`w-full px-3 py-2 text-sm text-left hover:bg-accent transition-colors ${(x||"none")===T.value?"bg-accent":""}`,children:T.label},T.value))})]}),(x==="custom"||x==="weekly"||x==="biweekly")&&e.jsx(_C,{selectedDays:t.recurrenceDays,onDaysChange:t.onRecurrenceDaysChange,selectionMode:x==="custom"?"multiple":"single"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Jr,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(ct,{className:"text-sm font-medium",children:"Location"})]}),e.jsx(mt,{value:t.location||"",onChange:T=>t.onLocationChange(T.target.value||null),placeholder:"Where will this happen? (optional)",className:"bg-muted/30 border-border/50"})]}),!t.hideMoreInformation&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Qo,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(ct,{className:"text-sm font-medium",children:"More Information"})]}),e.jsx(Zt,{value:t.moreInformation||"",onChange:T=>t.onMoreInformationChange(T.target.value||null),placeholder:"Add extra context, notes, or details (optional)",className:"min-h-[100px] resize-none bg-muted/30 border-border/50",style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent"},"data-vaul-no-drag":!0})]})]})},yh=n.forwardRef(({className:t,...s},a)=>e.jsx(Kt,{ref:a,className:I("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",t),...s}));yh.displayName=Kt.displayName;const bh=n.forwardRef(({className:t,...s},a)=>e.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[e.jsx(Yg,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(Kt.Input,{ref:a,className:I("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",t),...s})]}));bh.displayName=Kt.Input.displayName;const wh=n.forwardRef(({className:t,...s},a)=>e.jsx(Kt.List,{ref:a,className:I("max-h-[300px] overflow-y-auto overflow-x-hidden",t),...s}));wh.displayName=Kt.List.displayName;const vh=n.forwardRef((t,s)=>e.jsx(Kt.Empty,{ref:s,className:"py-6 text-center text-sm",...t}));vh.displayName=Kt.Empty.displayName;const _h=n.forwardRef(({className:t,...s},a)=>e.jsx(Kt.Group,{ref:a,className:I("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",t),...s}));_h.displayName=Kt.Group.displayName;const CC=n.forwardRef(({className:t,...s},a)=>e.jsx(Kt.Separator,{ref:a,className:I("-mx-1 h-px bg-border",t),...s}));CC.displayName=Kt.Separator.displayName;const jh=n.forwardRef(({className:t,...s},a)=>e.jsx(Kt.Item,{ref:a,className:I("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",t),...s}));jh.displayName=Kt.Item.displayName;const Xt={contacts:{all:["contacts"],byUser:t=>["contacts",t],detail:t=>["contacts","detail",t]},contactInteractions:{all:["contact-interactions"],byContact:t=>["contact-interactions",t]},contactReminders:{all:["contact-reminders"],byContact:t=>["contact-reminders",t],upcoming:()=>["contact-reminders","upcoming"]}};function SC(){const{user:t}=_e(),s=Ie(),a=Ee({queryKey:Xt.contacts.byUser(t?.id??""),queryFn:async()=>{const{data:c,error:d}=await k.from("contacts").select("*").eq("user_id",t.id).order("name",{ascending:!0});if(d)throw d;return c},enabled:!!t}),r=he({mutationFn:async c=>{const{data:d,error:u}=await k.from("contacts").insert({...c,user_id:t.id}).select().single();if(u)throw u;return d},onSuccess:()=>{s.invalidateQueries({queryKey:Xt.contacts.all}),V.success("Contact created")},onError:c=>{V.error("Failed to create contact"),console.error(c)}}),i=he({mutationFn:async({id:c,...d})=>{const{data:u,error:p}=await k.from("contacts").update(d).eq("id",c).select().single();if(p)throw p;return u},onSuccess:()=>{s.invalidateQueries({queryKey:Xt.contacts.all}),V.success("Contact updated")},onError:c=>{V.error("Failed to update contact"),console.error(c)}}),o=he({mutationFn:async c=>{const{error:d}=await k.from("contacts").delete().eq("id",c);if(d)throw d},onSuccess:()=>{s.invalidateQueries({queryKey:Xt.contacts.all}),V.success("Contact deleted")},onError:c=>{V.error("Failed to delete contact"),console.error(c)}}),l=he({mutationFn:async({id:c,is_favorite:d})=>{const{error:u}=await k.from("contacts").update({is_favorite:d}).eq("id",c);if(u)throw u},onMutate:async({id:c,is_favorite:d})=>{await s.cancelQueries({queryKey:Xt.contacts.byUser(t?.id??"")});const u=s.getQueryData(Xt.contacts.byUser(t?.id??""));return s.setQueryData(Xt.contacts.byUser(t?.id??""),p=>p?.map(h=>h.id===c?{...h,is_favorite:d}:h)),{previous:u}},onError:(c,d,u)=>{s.setQueryData(Xt.contacts.byUser(t?.id??""),u?.previous),V.error("Failed to update favorite")},onSettled:()=>{s.invalidateQueries({queryKey:Xt.contacts.all})}});return{contacts:a.data??[],isLoading:a.isLoading,createContact:r,updateContact:i,deleteContact:o,toggleFavorite:l}}function EC({value:t,onChange:s,placeholder:a="Link to contact...",disabled:r=!1}){const[i,o]=n.useState(!1),{contacts:l,isLoading:c}=SC(),d=n.useMemo(()=>!t||!l?null:l.find(p=>p.id===t)||null,[t,l]),u=p=>p.split(" ").map(h=>h[0]).join("").toUpperCase().slice(0,2);return e.jsxs(qs,{open:i,onOpenChange:o,children:[e.jsx(Ls,{asChild:!0,children:e.jsxs(z,{variant:"outline",role:"combobox","aria-expanded":i,className:I("w-full justify-between bg-background/50",!d&&"text-muted-foreground"),disabled:r||c,children:[d?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(_a,{className:"h-5 w-5",children:[e.jsx(ja,{src:d.avatar_url||void 0}),e.jsx(Na,{className:"text-[10px]",children:u(d.name)})]}),e.jsx("span",{className:"truncate",children:d.name})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qu,{className:"h-4 w-4"}),e.jsx("span",{children:a})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[d&&e.jsx(kt,{className:"h-4 w-4 opacity-50 hover:opacity-100",onClick:p=>{p.stopPropagation(),s(null)}}),e.jsx(Vg,{className:"h-4 w-4 shrink-0 opacity-50"})]})]})}),e.jsx(js,{className:"w-[300px] p-0",align:"start",children:e.jsxs(yh,{children:[e.jsx(bh,{placeholder:"Search contacts..."}),e.jsxs(wh,{children:[e.jsx(vh,{children:"No contacts found."}),e.jsx(_h,{children:l?.map(p=>e.jsxs(jh,{value:p.name,onSelect:()=>{s(p.id===t?null:p.id),o(!1)},children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs(_a,{className:"h-6 w-6",children:[e.jsx(ja,{src:p.avatar_url||void 0}),e.jsx(Na,{className:"text-[10px]",children:u(p.name)})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm",children:p.name}),p.company&&e.jsx("span",{className:"text-xs text-muted-foreground",children:p.company})]})]}),e.jsx(Rt,{className:I("ml-auto h-4 w-4",t===p.id?"opacity-100":"opacity-0")})]},p.id))})]})]})})]})}const ya=10,TC=10*1024*1024,MC=[".jpg",".jpeg",".png",".webp",".gif",".pdf",".doc",".docx",".txt",".csv"],DC=["application/pdf","application/msword","application/vnd.openxmlformats-officedocument.wordprocessingml.document","text/plain","text/csv"],AC="image/*,.pdf,.doc,.docx,.txt,.csv",PC="image/",RC=t=>{const s=t.lastIndexOf(".");return s<0?"":t.slice(s).toLowerCase()},IC=t=>{const s=RC(t.name);return MC.includes(s)||t.type?.startsWith(PC)?!0:DC.includes(t.type)},qC=(t,s=0,a=ya)=>{const r=[],i=[],o=Math.max(0,a-s);return o===0?{accepted:[],errors:[`You can attach up to ${ya} files.`]}:(t.forEach(l=>{if(!(i.length>=o)){if(!IC(l)){r.push(`"${l.name}" is not a supported file type.`);return}if(l.size>TC){r.push(`"${l.name}" exceeds the 10MB limit.`);return}i.push(l)}}),t.length>o&&r.push(`Only ${o} more file(s) can be attached (max ${ya}).`),{accepted:i,errors:r})};function LC(){const{user:t}=_e(),[s,a]=n.useState(!1),[r,i]=n.useState(null),o=n.useCallback(b=>{if(b instanceof Error)return b.message;if(b&&typeof b=="object"&&"message"in b){const w=b.message;if(typeof w=="string")return w}return String(b??"")},[]),l=n.useCallback(b=>{const w=o(b).toLowerCase();return w.includes("cancelled")||w.includes("canceled")},[o]),c=n.useCallback(b=>{const w=o(b).toLowerCase();return w.includes("unsupported device")||w.includes("not supported")||w.includes("visionkit")||w.includes("removebackground")||w.includes("remove background")||w.includes("code=-8")},[o]),d=n.useCallback(b=>{const w=Date.now(),x=b?.split(".").pop()||"jpg";return`${t?.id}/${w}_${Math.random().toString(36).slice(2)}_quest.${x}`},[t?.id]),u=n.useCallback(async(b,w)=>{if(!t?.id)return i("User not authenticated"),null;a(!0),i(null);try{const x=d(w),{error:v}=await k.storage.from("quest-attachments").upload(x,b,{contentType:b.type||"application/octet-stream",upsert:!1});if(v)throw v;const{data:{publicUrl:j}}=k.storage.from("quest-attachments").getPublicUrl(x);return{fileUrl:j,filePath:x,fileName:w||`attachment-${Date.now()}`,mimeType:b.type||"application/octet-stream",fileSizeBytes:typeof b.size=="number"?b.size:0,isImage:!!b.type?.startsWith("image/")}}catch(x){const v=x instanceof Error?x.message:"Failed to upload attachment";return i(v),V.error(v),null}finally{a(!1)}},[d,t?.id]),p=n.useCallback(async(b,w)=>{const x=await u(b,w);return!x||!x.isImage?x?.fileUrl??null:x.fileUrl},[u]),h=n.useCallback(async()=>new Promise(b=>{const w=document.createElement("input");w.type="file",w.accept="image/*",w.capture="environment",w.onchange=async x=>{const v=x.target.files?.[0];if(!v){b(null);return}const j=await p(v,v.name);b(j)},w.oncancel=()=>b(null),w.click()}),[p]),f=n.useCallback(async()=>{if(!t?.id)return i("User not authenticated"),null;i(null);try{if(Ze.isNativePlatform()){const{Camera:b,CameraResultType:w,CameraSource:x}=await ke(async()=>{const{Camera:v,CameraResultType:j,CameraSource:T}=await import("./vendor-DK8VKJIv.js").then(S=>S.ef);return{Camera:v,CameraResultType:j,CameraSource:T}},__vite__mapDeps([1,2,3]));try{const v=await b.getPhoto({quality:80,allowEditing:!1,resultType:w.Base64,source:x.Prompt,width:1200,height:1200});if(!v.base64String)return null;const j=atob(v.base64String),T=new Array(j.length);for(let D=0;D<j.length;D++)T[D]=j.charCodeAt(D);const S=new Uint8Array(T),N=new Blob([S],{type:`image/${v.format||"jpeg"}`});return await p(N,`photo.${v.format||"jpg"}`)}catch(v){if(l(v))return null;if(c(v))return console.info("Native image picker unsupported on this device, falling back to file input",v),await h();throw v}}else return await h()}catch(b){if(l(b))return null;const w=o(b)||"Failed to pick image";return i(w),V.error(w),null}},[t?.id,p,o,l,c,h]),m=n.useCallback(async b=>{if(!t?.id)return i("User not authenticated"),[];const w=b?.currentCount??0,x=b?.maxCount??ya;return new Promise(v=>{const j=document.createElement("input");j.type="file",j.accept=AC,j.multiple=!0,j.onchange=async T=>{const S=Array.from(T.target.files??[]);if(S.length===0){v([]);return}const{accepted:N,errors:D}=qC(S,w,x);if(D.forEach(_=>V.error(_)),N.length===0){v([]);return}const R=[];for(const _ of N){const C=await u(_,_.name);C&&R.push(C)}v(R)},j.oncancel=()=>v([]),j.click()})},[u,t?.id]),g=n.useCallback(async b=>{if(!t?.id)return i("User not authenticated"),!1;try{const w=typeof b=="string"?(()=>{const j=new URL(b).pathname.split("/"),T=j.findIndex(S=>S==="quest-attachments");return T===-1?null:j.slice(T+1).join("/")})():b.filePath;if(!w)return!1;const{error:x}=await k.storage.from("quest-attachments").remove([w]);if(x)throw x;return!0}catch(w){const x=w instanceof Error?w.message:"Failed to delete attachment";return i(x),console.error("Delete attachment error:",w),!1}},[t?.id]),y=n.useCallback(async b=>g(b),[g]);return{pickImage:f,pickAttachments:m,uploadImage:p,uploadAttachment:u,deleteImage:y,deleteAttachment:g,isUploading:s,error:r}}function Nh({attachments:t,onAttachmentsChange:s,className:a,disabled:r=!1,helperText:i=!0}){const{pickAttachments:o,deleteAttachment:l,isUploading:c}=LC(),d=Math.max(0,ya-t.length),u=!r&&d>0&&!c,p=async()=>{if(!u)return;const f=await o({currentCount:t.length,maxCount:ya});f.length!==0&&s([...t,...f])},h=async f=>{await l(f),s(t.filter(m=>m.fileUrl!==f.fileUrl))};return e.jsxs("div",{className:I("space-y-2",a),children:[e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs(z,{type:"button",variant:"outline",size:"sm",disabled:!u,onClick:p,className:"gap-2",children:[c?e.jsx(Nt,{className:"h-4 w-4 animate-spin"}):e.jsx(Lu,{className:"h-4 w-4"}),c?"Uploading...":"Add Photo/File"]}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:[t.length,"/",ya]})]}),i&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Up to 10 files, 10MB each."}),t.length>0&&e.jsx("div",{className:"grid grid-cols-2 gap-2",children:t.map(f=>e.jsxs("div",{className:"relative rounded-lg border border-border/60 bg-card p-2",children:[e.jsx("button",{type:"button",onClick:()=>h(f),className:"absolute right-1 top-1 rounded-full bg-background/80 p-1 text-muted-foreground hover:text-destructive","aria-label":`Remove ${f.fileName}`,children:e.jsx(kt,{className:"h-3 w-3"})}),f.isImage?e.jsx("a",{href:f.fileUrl,target:"_blank",rel:"noreferrer",className:"block",children:e.jsx("img",{src:f.fileUrl,alt:f.fileName,className:"h-16 w-full rounded object-cover"})}):e.jsx("a",{href:f.fileUrl,target:"_blank",rel:"noreferrer",className:"flex h-16 items-center justify-center rounded bg-muted/30",children:e.jsx(Lr,{className:"h-5 w-5 text-muted-foreground"})}),e.jsxs("div",{className:"mt-2 flex items-center gap-1",children:[f.isImage?e.jsx(Ou,{className:"h-3.5 w-3.5 text-muted-foreground"}):e.jsx(Lr,{className:"h-3.5 w-3.5 text-muted-foreground"}),e.jsx("span",{className:"truncate text-xs text-muted-foreground",children:f.fileName})]})]},f.fileUrl))})]})}function hr({className:t,classNames:s,showOutsideDays:a=!0,...r}){return e.jsx(Xg,{showOutsideDays:a,className:I("p-3",t),classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center",caption_label:"text-sm font-medium hidden",caption_dropdowns:"flex gap-2 items-center",dropdown:"appearance-none bg-transparent border border-white/20 rounded-lg px-3 py-1.5 text-sm font-medium text-white cursor-pointer hover:border-white/40 hover:bg-white/5 focus:outline-none focus:ring-2 focus:ring-white/30 transition-all",dropdown_month:"",dropdown_year:"",dropdown_icon:"hidden",vhidden:"hidden",nav:"space-x-1 flex items-center",nav_button:I(Br({variant:"outline"}),"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"),nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-white/70 rounded-md w-9 font-normal text-[0.8rem]",row:"flex w-full mt-2",cell:"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:I(Br({variant:"ghost"}),"h-9 w-9 p-0 font-normal aria-selected:opacity-100 text-white hover:bg-white/10 hover:text-white"),day_range_end:"day-range-end",day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent text-accent-foreground",day_outside:"day-outside text-white/30 opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",day_disabled:"text-white/30 opacity-50",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible",...s},components:{IconLeft:()=>e.jsx(Xa,{className:"h-4 w-4"}),IconRight:()=>e.jsx(Dt,{className:"h-4 w-4"})},...r})}hr.displayName="Calendar";const yl=Jg,kh=Zg,xi=n.forwardRef(({className:t,children:s,...a},r)=>e.jsx(Fu,{ref:r,className:I("overflow-hidden","data-[state=open]:animate-collapsible-down","data-[state=closed]:animate-collapsible-up",t),...a,children:s}));xi.displayName=Fu.displayName;const yi=au,OC=su,Ch=n.forwardRef(({className:t,...s},a)=>e.jsx(Vn,{className:I("fixed inset-0 z-50 bg-black/58 backdrop-blur-[2px] data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...s,ref:a}));Ch.displayName=Vn.displayName;const FC=dr("fixed z-50 gap-4 border-border/70 bg-card/95 p-6 shadow-[0_20px_40px_rgba(0,0,0,0.34)] backdrop-blur-xl transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-200 data-[state=open]:duration-300",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),rn=n.forwardRef(({side:t="right",className:s,children:a,...r},i)=>e.jsxs(OC,{children:[e.jsx(Ch,{}),e.jsx(Xn,{ref:i,className:I(FC({side:t}),s),...r,children:a})]}));rn.displayName=Xn.displayName;const bl=({className:t,...s})=>e.jsx("div",{className:I("flex flex-col space-y-2 text-center sm:text-left",t),...s});bl.displayName="SheetHeader";const Sh=({className:t,...s})=>e.jsx("div",{className:I("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...s});Sh.displayName="SheetFooter";const nn=n.forwardRef(({className:t,...s},a)=>e.jsx(Jn,{ref:a,className:I("text-lg font-semibold text-foreground",t),...s}));nn.displayName=Jn.displayName;const bi=n.forwardRef(({className:t,...s},a)=>e.jsx(Zn,{ref:a,className:I("text-sm text-muted-foreground",t),...s}));bi.displayName=Zn.displayName;const ys=gu("NativeCalendar",{web:()=>ke(()=>import("./NativeCalendarWeb-Cz8pElqg.js"),__vite__mapDeps([18,1,2,3])).then(t=>new t.NativeCalendarWeb)}),Ha=t=>`${t}-calendar-auth`,ao=()=>Ze.isNativePlatform()&&Ze.getPlatform()==="ios",ro="This app build needs an update to enable Apple Calendar.";function $C(t){const s=Ze.isPluginAvailable;return typeof s=="function"?s(t):!1}function BC(t){return t==="google"?"Google":"Outlook"}async function za(t){const{provider:s,action:a,error:r}=t,i=await Ur(r);return`${i.backendMessage??""} ${i.message??""}`.toLowerCase().includes("integration not configured")?new Error(`${BC(s)} Calendar is not configured on the server yet. Please contact support.`):new Error(Hr(i,{action:a}))}function wi(t={}){const{user:s}=_e(),a=Ie(),{enabled:r=!0}=t,i=ao()&&$C("NativeCalendar"),o=ao()&&i,l=o?null:ro,c=Ee({queryKey:["calendar-user-settings",s?.id],enabled:r&&!!s?.id,queryFn:async()=>{if(!s?.id)return null;const{data:N,error:D}=await k.from("calendar_user_settings").select("user_id, integration_visible, nudge_dismissed_at, default_provider").eq("user_id",s.id).maybeSingle();if(D)throw D;return N}}),d=Ee({queryKey:["calendar-connections",s?.id],enabled:r&&!!s?.id,queryFn:async()=>{if(!s?.id)return[];const{data:N,error:D}=await k.from("user_calendar_connections").select("id, provider, calendar_email, primary_calendar_id, primary_calendar_name, sync_mode, sync_enabled, platform, last_synced_at").eq("user_id",s.id).eq("sync_enabled",!0).order("created_at",{ascending:!0});if(D)throw D;return N||[]}}),u=c.data,p=d.data||[],h=n.useMemo(()=>{const N={};for(const D of p)N[D.provider]=D;return N},[p]),f=u?.default_provider||null,m=u?.integration_visible??!1,g=async()=>{await Promise.all([a.invalidateQueries({queryKey:["calendar-user-settings"]}),a.invalidateQueries({queryKey:["calendar-connections"]}),a.invalidateQueries({queryKey:["quest-calendar-links"]})])},y=he({mutationFn:async N=>{if(!s?.id)throw new Error("User not authenticated");const D={user_id:s.id,integration_visible:m,default_provider:f,...N},{error:R}=await k.from("calendar_user_settings").upsert(D,{onConflict:"user_id"});if(R)throw R},onSuccess:g}),b=he({mutationFn:async({provider:N,redirectUri:D,syncMode:R="send_only"})=>{const _=Ha(N),{data:C,error:E}=await k.functions.invoke(_,{body:{action:"getAuthUrl",redirectUri:D,syncMode:R}});if(E)throw await za({provider:N,action:"start calendar connection",error:E});return C?.url||C?.auth_url}}),w=he({mutationFn:async({provider:N,code:D,redirectUri:R,syncMode:_="send_only",state:C})=>{const E=Ha(N),{data:O,error:M}=await k.functions.invoke(E,{body:{action:"exchangeCode",code:D,redirectUri:R,syncMode:_,state:C}});if(M)throw await za({provider:N,action:"connect your calendar",error:M});return O},onSuccess:g}),x=he({mutationFn:async N=>{if(N==="apple"){if(!s?.id)throw new Error("User not authenticated");const{error:_}=await k.from("user_calendar_connections").delete().eq("user_id",s.id).eq("provider","apple");if(_)throw _;return}const D=Ha(N),{error:R}=await k.functions.invoke(D,{body:{action:"disconnect"}});if(R)throw await za({provider:N,action:"disconnect your calendar",error:R})},onSuccess:g}),v=he({mutationFn:async({provider:N,syncMode:D})=>{if(N==="apple"){if(!s?.id)throw new Error("User not authenticated");const{error:C}=await k.from("user_calendar_connections").update({sync_mode:D}).eq("user_id",s.id).eq("provider","apple");if(C)throw C;return}const R=Ha(N),{error:_}=await k.functions.invoke(R,{body:{action:"setSyncMode",syncMode:D}});if(_)throw await za({provider:N,action:"update calendar sync mode",error:_})},onSuccess:g}),j=he({mutationFn:async N=>{if(N==="apple"){if(!o)throw new Error(l??ro);if(!(await ys.isAvailable()).available)return[];if(!(await ys.requestPermissions()).granted)return[];const{calendars:M}=await ys.listCalendars();return M.map(A=>({id:A.id,name:A.title,isPrimary:A.isPrimary}))}const D=Ha(N),{data:R,error:_}=await k.functions.invoke(D,{body:{action:"listCalendars"}});if(_)throw await za({provider:N,action:"list calendars",error:_});return(Array.isArray(R?.calendars)?R.calendars:[]).map(E=>({id:String(E.id),name:String(E.summary||E.name||E.id),isPrimary:!!(E.primary||E.isDefaultCalendar)}))}}),T=he({mutationFn:async({provider:N,calendarId:D,calendarName:R})=>{if(!D)throw new Error("calendarId is required");if(N==="apple"){if(!s?.id)throw new Error("User not authenticated");const{error:E}=await k.from("user_calendar_connections").update({primary_calendar_id:D,primary_calendar_name:R??D,calendar_id:D}).eq("user_id",s.id).eq("provider","apple");if(E)throw E;return}const _=Ha(N),{error:C}=await k.functions.invoke(_,{body:{action:"setPrimaryCalendar",calendarId:D,calendarName:R}});if(C)throw await za({provider:N,action:"set a primary calendar",error:C})},onSuccess:g}),S=he({mutationFn:async({syncMode:N="send_only"}={})=>{if(!s?.id)throw new Error("User not authenticated");if(!ao())throw new Error("Apple Calendar is only available on iOS native");if(!o)throw new Error(l??ro);if(!(await ys.isAvailable()).available)throw new Error("Native Apple Calendar plugin unavailable");if(!(await ys.requestPermissions()).granted)throw new Error("Calendar permission not granted");const{calendars:_}=await ys.listCalendars(),C=_.find(O=>O.isPrimary)||_[0];if(!C)throw new Error("No writable Apple calendars found on this device");const{error:E}=await k.from("user_calendar_connections").upsert({user_id:s.id,provider:"apple",sync_enabled:!0,sync_mode:N,primary_calendar_id:C.id,primary_calendar_name:C.title,calendar_id:C.id,platform:"ios"},{onConflict:"user_id,provider"});if(E)throw E},onSuccess:g});return{settings:u,connections:p,connectedByProvider:h,defaultProvider:f,integrationVisible:m,applePluginAvailable:i,canConnectAppleNative:o,appleNativeUnavailableReason:l,isLoading:c.isLoading||d.isLoading,upsertSettings:y,beginOAuthConnection:b,completeOAuthConnection:w,disconnectProvider:x,setProviderSyncMode:v,listProviderCalendars:j,setPrimaryCalendar:T,connectAppleNative:S}}const UC=!1,Eh={easy:{bg:"bg-emerald-600",text:"text-emerald-400",pill:"bg-emerald-500",border:"border-emerald-500/40"},medium:{bg:"bg-[#FF914F]/80",text:"text-[#FF914F]",pill:"bg-[#FF914F]/80",border:"border-[#FF914F]/35"},hard:{bg:"bg-violet-500",text:"text-violet-400",pill:"bg-violet-500",border:"border-violet-500/40"}},HC={easy:bt,medium:es,hard:Vr};function Qs(t){const[s,a]=t.split(":").map(Number),r=s>=12?"PM":"AM";return`${s%12||12}:${String(a).padStart(2,"0")} ${r}`}function zC(){const t=[];for(let s=0;s<24;s++)for(let a=0;a<60;a+=30)t.push(`${String(s).padStart(2,"0")}:${String(a).padStart(2,"0")}`);return t}function Th(t=new Date){const s=new Date(t);s.setSeconds(0,0);const a=s.getMinutes(),r=a%30;return r!==0&&s.setMinutes(a+(30-r)),`${String(s.getHours()).padStart(2,"0")}:${String(s.getMinutes()).padStart(2,"0")}`}const er=zC(),zn=[{label:"1m",value:1},{label:"15m",value:15},{label:"30m",value:30},{label:"45m",value:45},{label:"1h",value:60},{label:"1.5h",value:90},{label:"All Day",value:1440},{label:"Custom",value:-1}],KC=({difficulty:t})=>{const s=HC[t];return e.jsx(s,{className:"h-5 w-5"})},Mh=n.memo(function({open:s,onOpenChange:a,selectedDate:r,prefilledTime:i,onAdd:o,isAdding:l=!1,onCreateCampaign:c,preventClose:d=!1,onPreventedCloseAttempt:u}){const[p,h]=n.useState(""),[f,m]=n.useState("medium"),[g,y]=n.useState(!1),[b,w]=n.useState(i??null),[x,v]=n.useState(30),[j,T]=n.useState(null),[S,N]=n.useState([]),[D,R]=n.useState(!1),[_,C]=n.useState(15),[E,O]=n.useState(null),[M,A]=n.useState(null),[L,q]=n.useState(null),[$,B]=n.useState(!0),[W,H]=n.useState(ae(r,"yyyy-MM-dd")),[K,X]=n.useState(!1),[Y,ee]=n.useState(!1),[ie,fe]=n.useState([]),[U,ce]=n.useState(""),[se,ne]=n.useState(!1),[xe,G]=n.useState([]),{defaultProvider:ye,connections:we}=wi(),Te=n.useMemo(()=>(ye?we.find(Ae=>Ae.provider===ye)?.provider??null:null)||we[0]?.provider||null,[we,ye]),qe=!!UC,Se=n.useRef(null),Pe=n.useRef(null),$e=n.useRef([]),Be=n.useRef(!1);n.useEffect(()=>{i&&w(i)},[i]),n.useEffect(()=>{s?H(ae(r,"yyyy-MM-dd")):(h(""),m("medium"),y(!1),w(null),v(30),T(null),N([]),R(!1),C(15),O(null),A(null),q(null),B(!0),X(!1),ee(!1),fe([]),ne(!1),G([]),Be.current=!1)},[s,r]),n.useEffect(()=>{Y&&Pe.current&&setTimeout(()=>{Pe.current?.scrollIntoView({block:"center",behavior:"smooth"})},150)},[Y,b]);const Me=n.useMemo(()=>{if(!b||!x)return null;const me=Gr(b);return me?ae(nm(me,x),"HH:mm"):null},[b,x]),Qe=x!==null&&!zn.some(me=>me.value===x),De=n.useMemo(()=>x?x===1440?"All Day":x>=60?`${x/60}h`:`${x} min`:"No duration",[x]),ve=n.useMemo(()=>{const me=De;if(W){const Ae=new Date(W+"T00:00:00");return Vo(Ae)?`${me} - Today`:`${me} - ${ae(Ae,"EEE, MMM d")}`}return`${me} - Inbox`},[De,W]),Z=Eh[f],Q=W?new Date(W+"T00:00:00"):r,J=!!W&&!!b,de=!!p.trim()&&J,oe=n.useCallback((me,Ae)=>{fe(Ue=>{const xt=[...Ue];return xt[me]=Ae,xt})},[]),Fe=n.useCallback((me,Ae)=>{Ae.key==="Enter"&&ie[me]?.trim()&&(Ae.preventDefault(),fe(Ue=>{const xt=[...Ue];return xt.splice(me+1,0,""),xt}),setTimeout(()=>$e.current[me+1]?.focus(),50)),Ae.key==="Backspace"&&!ie[me]&&ie.length>0&&(Ae.preventDefault(),fe(Ue=>Ue.filter((xt,Pt)=>Pt!==me)),setTimeout(()=>$e.current[Math.max(0,me-1)]?.focus(),50))},[ie]),Je=n.useCallback(me=>{fe(Ae=>Ae.filter((Ue,xt)=>xt!==me))},[]),pt=n.useCallback(()=>{fe(me=>[...me,""]),setTimeout(()=>$e.current[ie.length]?.focus(),50)},[ie.length]),nt=n.useCallback(me=>{if(me){a(!0);return}if(d){window.dispatchEvent(new CustomEvent("add-quest-sheet-close-attempted")),u?.();return}a(!1)},[a,u,d]),Ct=n.useCallback(async()=>{p.trim()&&(window.dispatchEvent(new CustomEvent("add-quest-create-attempted")),await o({text:p,taskDate:W,difficulty:f,scheduledTime:b,estimatedDuration:x,recurrencePattern:j,recurrenceDays:S,reminderEnabled:D,reminderMinutesBefore:_,moreInformation:E,location:M,contactId:L,autoLogInteraction:$,sendToInbox:!1,sendToCalendar:se&&qe,subtasks:ie.filter(me=>me.trim()),imageUrl:xe.find(me=>me.isImage)?.fileUrl??null,attachments:xe}),a(!1))},[p,W,f,b,x,j,S,D,_,E,M,L,$,se,qe,ie,xe,o,a]),lt=n.useCallback(async()=>{p.trim()&&(await o({text:p,taskDate:null,difficulty:f,scheduledTime:null,estimatedDuration:x,recurrencePattern:j,recurrenceDays:S,reminderEnabled:D,reminderMinutesBefore:_,moreInformation:E,location:M,contactId:L,autoLogInteraction:$,sendToInbox:!0,sendToCalendar:!1,subtasks:ie.filter(me=>me.trim()),imageUrl:xe.find(me=>me.isImage)?.fileUrl??null,attachments:xe}),a(!1))},[p,f,x,j,S,D,_,E,M,L,$,ie,xe,o,a]);return n.useEffect(()=>{s&&window.dispatchEvent(new CustomEvent("add-quest-sheet-opened"))},[s]),n.useEffect(()=>{s&&(Be.current||p.trim()&&(Be.current=!0,window.dispatchEvent(new CustomEvent("add-quest-title-entered"))))},[s,p]),n.useEffect(()=>{b&&window.dispatchEvent(new CustomEvent("add-quest-time-selected",{detail:{scheduledTime:b}}))},[b]),e.jsx(yi,{open:s,onOpenChange:nt,children:e.jsxs(rn,{side:"bottom","data-tour":"add-quest-sheet",className:"h-[92vh] rounded-t-2xl flex flex-col p-0 gap-0 overflow-hidden",onOpenAutoFocus:me=>me.preventDefault(),children:[e.jsx(nn,{className:"sr-only",children:"Add Quest"}),e.jsx(bi,{className:"sr-only",children:"Create a new quest with schedule, subtasks, and optional details."}),e.jsxs("div",{className:I("relative px-5 pt-4 pb-5 flex-shrink-0",Z.bg),children:[e.jsx("button",{onClick:()=>nt(!1),className:"absolute top-3 right-3 p-1.5 rounded-full bg-black/20 hover:bg-black/30 transition-colors text-white z-10","aria-label":"Close",children:e.jsx(kt,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex flex-col items-center text-center pt-2 text-white",children:[e.jsx(KC,{difficulty:f}),e.jsx("p",{className:"text-sm opacity-80 mt-1.5",children:"New Quest"}),e.jsx(mt,{"data-tour":"add-quest-title-input",placeholder:"Quest Title",value:p,onChange:me=>h(me.target.value),disabled:l,className:"mt-2 text-center text-lg font-bold bg-white/10 border-white/20 text-white placeholder:text-white/50 focus-visible:ring-white/30 h-11"}),e.jsx("p",{className:"text-white/70 text-xs mt-1",children:ve})]}),e.jsx("div",{className:"flex justify-center gap-3 mt-3",children:[{value:"easy",icon:bt,label:"Easy"},{value:"medium",icon:es,label:"Medium"},{value:"hard",icon:Vr,label:"Hard"}].map(({value:me,icon:Ae,label:Ue})=>e.jsxs("button",{onClick:()=>m(me),className:I("w-14 h-12 rounded-xl flex flex-col items-center justify-center gap-0.5 transition-all border-2",f===me?"bg-white/30 border-white scale-110":"bg-white/10 border-transparent hover:bg-white/20"),children:[e.jsx(Ae,{className:"h-4 w-4 text-white"}),e.jsx("span",{className:"text-[10px] font-medium text-white/80 leading-none",children:Ue})]},me))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4 space-y-3",children:[e.jsxs("button",{onClick:()=>X(!K),className:"w-full flex items-center justify-between bg-card rounded-xl px-4 py-3 border border-border/50 hover:bg-muted/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2.5 text-sm font-medium",children:[e.jsx(Ht,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:De})]}),e.jsx(Dt,{className:I("h-4 w-4 text-muted-foreground transition-transform",K&&"rotate-90")})]}),K&&e.jsxs("div",{className:"space-y-2 px-1",children:[e.jsx("div",{className:"flex gap-2 flex-wrap",children:zn.map(me=>{const Ae=me.value===-1?Qe:x===me.value;return e.jsx("button",{onClick:()=>{me.value===-1?(ce(""),v(null)):(ce(""),v(me.value))},className:I("px-4 py-2 rounded-lg text-sm font-bold transition-all duration-150",Ae?I(Z.pill,"text-white shadow-md"):"bg-muted/50 text-muted-foreground hover:bg-muted"),children:me.label},me.value)})}),(Qe||x===null&&U!==void 0)&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(mt,{type:"number",inputMode:"numeric",placeholder:"Minutes",value:U,onChange:me=>{const Ae=me.target.value;ce(Ae);const Ue=parseInt(Ae,10);!isNaN(Ue)&&Ue>0?v(Ue):v(null)},className:"w-28 h-9 text-sm",autoFocus:!0}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"min"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(qs,{children:[e.jsx(Ls,{asChild:!0,children:e.jsxs("button",{className:I("flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border text-sm font-medium transition-colors",W?"bg-card border-border/50 text-foreground":"bg-muted/30 border-dashed border-border/50 text-muted-foreground"),children:[e.jsx(zt,{className:"h-4 w-4"}),W?ae(Q,"MMM d"):"Date"]})}),e.jsx(js,{className:"w-auto p-0 z-[100]",align:"start",children:e.jsx(hr,{mode:"single",selected:Q,onSelect:me=>H(me?ae(me,"yyyy-MM-dd"):null),className:"pointer-events-auto"})})]}),e.jsxs("button",{onClick:()=>{b||w(Th()),ee(!Y)},"data-tour":"add-quest-time-chip",className:I("flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border text-sm font-medium transition-colors",b?"bg-card border-border/50 text-foreground":"bg-muted/30 border-dashed border-border/50 text-muted-foreground"),children:[e.jsx(Ht,{className:"h-4 w-4"}),b?Qs(b):"Time"]})]}),Y&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(mt,{"aria-label":"Custom quest time","data-tour":"add-quest-time-input",type:"time",step:60,value:b||"",onChange:me=>w(me.target.value||null),className:"h-10"}),e.jsxs("div",{ref:Se,className:"relative h-[180px] overflow-y-auto rounded-xl bg-card border border-border/50 snap-y snap-mandatory scrollbar-none",style:{scrollbarWidth:"none"},children:[e.jsx("div",{className:"sticky top-0 h-12 bg-gradient-to-b from-card to-transparent z-10 pointer-events-none"}),e.jsx("div",{className:"flex flex-col items-center py-1",children:er.map(me=>{const Ae=b===me,Ue=b?er.indexOf(b):-1,xt=er.indexOf(me),Pt=Ue>=0?Math.abs(xt-Ue):0,ge=Ae?1:Math.max(.25,1-Pt*.15);return e.jsx("button",{"data-tour":"add-quest-time-slot",ref:Ae?Pe:void 0,onClick:()=>w(me),className:I("w-[85%] py-2.5 rounded-xl text-center text-sm font-semibold snap-center transition-all duration-150 my-0.5",Ae?I(Z.pill,"text-white shadow-lg scale-[1.02]"):"text-foreground hover:bg-muted/50"),style:{opacity:Ae?1:ge},children:Ae&&Me?`${Qs(me)} â€“ ${Qs(Me)}`:Qs(me)},me)})}),e.jsx("div",{className:"sticky bottom-0 h-12 bg-gradient-to-t from-card to-transparent z-10 pointer-events-none"})]})]}),e.jsxs("div",{className:"bg-card rounded-xl border border-border/50 overflow-hidden",children:[ie.map((me,Ae)=>e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b border-border/30 group",children:[e.jsx(ka,{disabled:!0,className:"h-4 w-4 opacity-50"}),e.jsx("input",{ref:Ue=>{$e.current[Ae]=Ue},value:me,onChange:Ue=>oe(Ae,Ue.target.value),onKeyDown:Ue=>Fe(Ae,Ue),placeholder:"Subtask",className:"flex-1 bg-transparent text-sm outline-none placeholder:text-muted-foreground/50"}),e.jsx("button",{onClick:()=>Je(Ae),className:"p-1 rounded opacity-0 group-hover:opacity-100 hover:bg-destructive/10 text-muted-foreground hover:text-destructive transition-all",children:e.jsx(oa,{className:"h-3.5 w-3.5"})})]},Ae)),e.jsxs("div",{role:"button",tabIndex:0,onClick:pt,onKeyDown:me=>{(me.key==="Enter"||me.key===" ")&&(me.preventDefault(),pt())},className:"flex items-center gap-2 px-3 py-2.5 w-full text-left hover:bg-muted/30 transition-colors border-b border-border/30 cursor-pointer",children:[e.jsx(ka,{disabled:!0,className:"h-4 w-4 opacity-30"}),e.jsx("span",{className:"text-sm text-muted-foreground/60",children:"Add Subtask"})]}),e.jsx(Zt,{value:E||"",onChange:me=>O(me.target.value||null),placeholder:"Add notes, meeting links or phone numbers...",className:"min-h-[70px] border-0 rounded-none bg-transparent resize-none focus-visible:ring-0 focus-visible:ring-offset-0 text-sm",style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent"},"data-vaul-no-drag":!0})]}),e.jsxs("div",{className:"space-y-2 px-1",children:[e.jsx(ct,{className:"text-sm font-medium text-muted-foreground",children:"Photo / Files"}),e.jsx(Nh,{attachments:xe,onAttachmentsChange:G})]}),e.jsxs(yl,{open:g,onOpenChange:y,children:[e.jsx(kh,{asChild:!0,children:e.jsxs(z,{variant:"ghost",size:"sm",className:"w-full justify-between text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx($u,{className:"w-4 h-4"}),"Advanced Settings"]}),e.jsx("span",{className:"text-xs",children:g?"â–²":"â–¼"})]})}),e.jsx(xi,{children:e.jsxs("div",{className:"mt-3 space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground",children:[e.jsx(Bu,{className:"w-4 h-4"}),e.jsx("span",{children:"Link to Contact"})]}),e.jsx(EC,{value:L,onChange:q,placeholder:"Select a contact..."}),L&&e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 bg-muted/30 rounded-lg",children:[e.jsx(ct,{htmlFor:"auto-log-add",className:"text-sm cursor-pointer",children:"Log as interaction when completed"}),e.jsx(Hn,{id:"auto-log-add",checked:$,onCheckedChange:B})]})]}),e.jsx(xl,{scheduledTime:b,estimatedDuration:x,recurrencePattern:j,recurrenceDays:S,reminderEnabled:D,reminderMinutesBefore:_,onScheduledTimeChange:w,onEstimatedDurationChange:v,onRecurrencePatternChange:T,onRecurrenceDaysChange:N,onReminderEnabledChange:R,onReminderMinutesBeforeChange:C,moreInformation:E,onMoreInformationChange:O,location:M,onLocationChange:A,selectedDate:r,taskDifficulty:f,hideScheduledTime:!0,hideDuration:!0,hideMoreInformation:!0})]})})]})]})}),e.jsxs("div",{className:"px-5 pt-4 pb-6 flex-shrink-0 flex flex-col gap-3 border-t border-border/50",children:[qe&&e.jsxs("div",{className:"flex items-center justify-between rounded-md border border-border/50 px-3 py-2",children:[e.jsxs("div",{className:"text-xs text-muted-foreground",children:["Send to ",Te==="apple"?"Apple":Te==="google"?"Google":"Outlook"," Calendar after create"]}),e.jsx(Hn,{checked:se,onCheckedChange:ne})]}),e.jsx(z,{onClick:Ct,"data-tour":"add-quest-create-button",disabled:l||!de,className:I("w-full text-white",de?I(Z.pill,"hover:opacity-90"):""),children:l?"Creating...":"Create Quest"}),e.jsxs(z,{variant:"outline",onClick:lt,disabled:l||!p.trim(),className:"w-full",children:[e.jsx(Yo,{className:"mr-2 h-4 w-4"}),"Add to Inbox instead"]}),c&&e.jsxs("button",{onClick:()=>{a(!1),c()},className:"text-xs text-muted-foreground hover:text-foreground transition-colors flex items-center justify-center gap-1.5 py-1",children:[e.jsx(Tr,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:"Or create a Campaign"}),e.jsx("span",{className:"rounded-full border border-border/60 px-2 py-0.5 text-[10px] leading-none text-muted-foreground/80",children:"Max 2 active"})]})]})]})})}),QC=t=>{const{user:s}=_e(),a=Ie(),{data:r=[],isLoading:i}=Ee({queryKey:["subtasks",t],queryFn:async()=>{if(!s?.id||!t)return[];const{data:m,error:g}=await k.from("subtasks").select("*").eq("task_id",t).eq("user_id",s.id).order("sort_order",{ascending:!0});if(g)throw g;return m},enabled:!!s?.id&&!!t}),o=he({mutationFn:async m=>{if(!s?.id||!t)throw new Error("Missing required data");const g=r.length>0?Math.max(...r.map(w=>w.sort_order))+1:0,{data:y,error:b}=await k.from("subtasks").insert({task_id:t,user_id:s.id,title:m,sort_order:g}).select().single();if(b)throw b;return y},onSuccess:()=>{a.invalidateQueries({queryKey:["subtasks",t]}),a.invalidateQueries({queryKey:["daily-tasks"]})},onError:()=>{V.error("Failed to add subtask")}}),l=he({mutationFn:async({subtaskId:m,completed:g})=>{const{error:y}=await k.from("subtasks").update({completed:g,completed_at:g?new Date().toISOString():null}).eq("id",m);if(y)throw y},onSuccess:()=>{a.invalidateQueries({queryKey:["subtasks",t]}),a.invalidateQueries({queryKey:["daily-tasks"]})}}),c=he({mutationFn:async m=>{const{error:g}=await k.from("subtasks").delete().eq("id",m);if(g)throw g},onSuccess:()=>{a.invalidateQueries({queryKey:["subtasks",t]}),a.invalidateQueries({queryKey:["daily-tasks"]})}}),d=he({mutationFn:async({subtaskId:m,title:g})=>{const{error:y}=await k.from("subtasks").update({title:g}).eq("id",m);if(y)throw y},onSuccess:()=>{a.invalidateQueries({queryKey:["subtasks",t]}),a.invalidateQueries({queryKey:["daily-tasks"]})},onError:()=>{V.error("Failed to update subtask")}}),u=he({mutationFn:async m=>{if(!s?.id||!t)throw new Error("Missing required data");const g=r.length>0?Math.max(...r.map(w=>w.sort_order))+1:0,y=m.map((w,x)=>({task_id:t,user_id:s.id,title:w,sort_order:g+x})),{error:b}=await k.from("subtasks").insert(y);if(b)throw b},onSuccess:()=>{a.invalidateQueries({queryKey:["subtasks",t]}),a.invalidateQueries({queryKey:["daily-tasks"]}),V.success("Subtasks added!")},onError:()=>{V.error("Failed to add subtasks")}}),p=r.filter(m=>m.completed).length,h=r.length,f=h>0?Math.round(p/h*100):0;return{subtasks:r,isLoading:i,addSubtask:o.mutate,toggleSubtask:l.mutate,deleteSubtask:c.mutate,updateSubtask:d.mutate,bulkAddSubtasks:u.mutateAsync,isAdding:o.isPending,isBulkAdding:u.isPending,completedCount:p,totalCount:h,progressPercent:f}},WC=/^\d{4}-\d{2}-\d{2}$/,GC=t=>{const s=t?.trim().toLowerCase();return s==="easy"||s==="medium"||s==="hard"?s:s&&["simple","beginner","low"].includes(s)?"easy":s&&["difficult","advanced","challenging","high"].includes(s)?"hard":"medium"},Po=t=>{if(!t)return null;const s=t.trim();if(!s)return null;const a=s.includes("T")?s.slice(0,10):s;if(!WC.test(a))return null;const r=new Date(`${a}T00:00:00`);return va(r)?a:null},YC=t=>{const s=Po(t);if(!s)return null;const a=new Date(`${s}T00:00:00`);return va(a)?a:null};function Dh({task:t,open:s,onOpenChange:a,onSave:r,isSaving:i,onDelete:o,isDeleting:l,onSendToCalendar:c,hasCalendarLink:d=!1,isSendingToCalendar:u=!1}){const[p,h]=n.useState(""),[f,m]=n.useState(null),[g,y]=n.useState("medium"),[b,w]=n.useState(null),[x,v]=n.useState(30),[j,T]=n.useState(null),[S,N]=n.useState([]),[D,R]=n.useState(!1),[_,C]=n.useState(15),[E,O]=n.useState(null),[M,A]=n.useState(!1),[L,q]=n.useState(!1),[$,B]=n.useState([]),[W,H]=n.useState(null),[K,X]=n.useState(!1),[Y,ee]=n.useState(!1),[ie,fe]=n.useState(""),[U,ce]=n.useState(""),se=n.useRef(null),ne=n.useRef(null),{subtasks:xe,addSubtask:G,toggleSubtask:ye,deleteSubtask:we}=QC(t?.id??null);n.useEffect(()=>{if(t&&s){h(t.task_text),m(Po(t.task_date)),y(GC(t.difficulty)),w(Mo(t.scheduled_time)),v(t.estimated_duration??30);const Z=Array.isArray(t.recurrence_days)?t.recurrence_days:[],Q=t.recurrence_pattern==="weekly"&&Z.length>1?"custom":t.recurrence_pattern||null;T(Q),N(Z),R(!!t.reminder_enabled),C(typeof t.reminder_minutes_before=="number"&&t.reminder_minutes_before>0?t.reminder_minutes_before:15),O(t.notes||null);const J=(t.attachments??[]).map((de,oe)=>({fileUrl:de.fileUrl,filePath:de.filePath,fileName:de.fileName,mimeType:de.mimeType,fileSizeBytes:de.fileSizeBytes,isImage:de.isImage,sortOrder:de.sortOrder??oe}));J.length>0?B(J):t.image_url?B([{fileUrl:t.image_url,filePath:"",fileName:"image",mimeType:"image/jpeg",fileSizeBytes:0,isImage:!0,sortOrder:0}]):B([]),H(t.location||null),X(!1),ee(!1),A(!!t.recurrence_pattern||!!t.reminder_enabled||!!t.location)}},[t,s]),n.useEffect(()=>{Y&&ne.current&&setTimeout(()=>{ne.current?.scrollIntoView({block:"center",behavior:"smooth"})},150)},[Y,b]);const Te=n.useMemo(()=>{if(!b||!x)return null;const Z=Gr(b);return Z?ae(nm(Z,x),"HH:mm"):null},[b,x]),qe=x!==null&&!zn.some(Z=>Z.value===x),Se=n.useMemo(()=>x?x===1440?"All Day":x>=60?`${x/60}h`:`${x} min`:"No duration",[x]),Pe=n.useMemo(()=>YC(f),[f]),$e=n.useMemo(()=>{const Z=Se;if(Pe){const Q=Pe;return Vo(Q)?`${Z} Â· Today`:`${Z} Â· ${ae(Q,"EEE, MMM d")}`}return`${Z} Â· Inbox`},[Se,Pe]),Be=Eh[g],Me=Pe??new Date,Qe=n.useCallback(async()=>{!t||!p.trim()||(await r(t.id,{task_text:p.trim(),task_date:Po(f),difficulty:g,scheduled_time:Mo(b),estimated_duration:x,recurrence_pattern:j,recurrence_days:Array.isArray(S)?S:[],reminder_enabled:D,reminder_minutes_before:Number.isFinite(_)&&_>0?_:15,notes:E,category:t.category||null,image_url:$.find(Z=>Z.isImage)?.fileUrl??null,location:W,attachments:$}),a(!1))},[t,p,f,g,b,x,j,S,D,_,E,$,W,r,a]),De=async()=>{!t||!o||(await o(t.id),q(!1),a(!1))},ve=n.useCallback(()=>{U.trim()&&(G(U.trim()),ce(""))},[U,G]);return e.jsxs(yi,{open:s,onOpenChange:a,children:[e.jsxs(rn,{side:"bottom",className:"h-[92vh] rounded-t-2xl flex flex-col p-0 gap-0 overflow-hidden",children:[e.jsx(nn,{className:"sr-only",children:"Edit Quest"}),e.jsx(bi,{className:"sr-only",children:"Update this quest details, schedule, and reminders."}),e.jsxs("div",{className:I("relative px-5 pt-3 pb-3 flex-shrink-0",Be.bg),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>a(!1),className:"p-1.5 rounded-full bg-black/20 hover:bg-black/30 transition-colors text-white","aria-label":"Close",children:e.jsx(ex,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(mt,{value:p,onChange:Z=>h(Z.target.value),className:"text-base font-bold bg-white/10 border-white/20 text-white placeholder:text-white/50 focus-visible:ring-white/30 h-9",placeholder:"Quest title"}),e.jsx("p",{className:"text-white/70 text-xs mt-1",children:$e})]}),e.jsx("button",{onClick:()=>a(!1),className:"p-1.5 rounded-full bg-black/20 hover:bg-black/30 transition-colors text-white","aria-label":"Close",children:e.jsx(kt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex justify-center gap-3 mt-2",children:[{value:"easy",icon:bt,label:"Easy"},{value:"medium",icon:es,label:"Medium"},{value:"hard",icon:Vr,label:"Hard"}].map(({value:Z,icon:Q,label:J})=>e.jsxs("button",{onClick:()=>y(Z),className:I("w-14 h-12 rounded-xl flex flex-col items-center justify-center gap-0.5 transition-all border-2",g===Z?"bg-white/30 border-white scale-110":"bg-white/10 border-transparent hover:bg-white/20"),children:[e.jsx(Q,{className:"h-4 w-4 text-white"}),e.jsx("span",{className:"text-[10px] font-medium text-white/80 leading-none",children:J})]},Z))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4 space-y-3",children:[e.jsxs("button",{onClick:()=>X(!K),className:"w-full flex items-center justify-between bg-card rounded-xl px-4 py-3 border border-border/50 hover:bg-muted/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2.5 text-sm font-medium",children:[e.jsx(Ht,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:Se})]}),e.jsx(Dt,{className:I("h-4 w-4 text-muted-foreground transition-transform",K&&"rotate-90")})]}),K&&e.jsxs("div",{className:"space-y-2 px-1",children:[e.jsx("div",{className:"flex gap-2 flex-wrap",children:zn.map(Z=>{const Q=Z.value===-1?qe:x===Z.value;return e.jsx("button",{onClick:()=>{Z.value===-1?(fe(""),v(null)):(fe(""),v(Z.value))},className:I("px-4 py-2 rounded-lg text-sm font-bold transition-all duration-150",Q?I(Be.pill,"text-white shadow-md"):"bg-muted/50 text-muted-foreground hover:bg-muted"),children:Z.label},Z.value)})}),(qe||x===null&&ie!==void 0)&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(mt,{type:"number",inputMode:"numeric",placeholder:"Minutes",value:ie,onChange:Z=>{const Q=Z.target.value;fe(Q);const J=parseInt(Q,10);!isNaN(J)&&J>0?v(J):v(null)},className:"w-28 h-9 text-sm",autoFocus:!0}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"min"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(qs,{children:[e.jsx(Ls,{asChild:!0,children:e.jsxs("button",{className:I("flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border text-sm font-medium transition-colors",f?"bg-card border-border/50 text-foreground":"bg-muted/30 border-dashed border-border/50 text-muted-foreground"),children:[e.jsx(zt,{className:"h-4 w-4"}),f?ae(Me,"MMM d"):"Date"]})}),e.jsx(js,{className:"w-auto p-0 z-[100]",align:"start",children:e.jsx(hr,{mode:"single",selected:Me,onSelect:Z=>m(Z?ae(Z,"yyyy-MM-dd"):null),className:"pointer-events-auto"})})]}),e.jsxs("button",{onClick:()=>{b||w(Th()),ee(!Y)},className:I("flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border text-sm font-medium transition-colors",b?"bg-card border-border/50 text-foreground":"bg-muted/30 border-dashed border-border/50 text-muted-foreground"),children:[e.jsx(Ht,{className:"h-4 w-4"}),b?Qs(b):"Time"]})]}),Y&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(mt,{"aria-label":"Custom quest time",type:"time",step:60,value:b||"",onChange:Z=>w(Z.target.value||null),className:"h-10"}),e.jsxs("div",{ref:se,className:"relative h-[180px] overflow-y-auto rounded-xl bg-card border border-border/50 snap-y snap-mandatory scrollbar-none",style:{scrollbarWidth:"none"},children:[e.jsx("div",{className:"sticky top-0 h-12 bg-gradient-to-b from-card to-transparent z-10 pointer-events-none"}),e.jsx("div",{className:"flex flex-col items-center py-1",children:er.map(Z=>{const Q=b===Z,J=b?er.indexOf(b):-1,de=er.indexOf(Z),oe=J>=0?Math.abs(de-J):0,Fe=Q?1:Math.max(.25,1-oe*.15);return e.jsx("button",{ref:Q?ne:void 0,onClick:()=>w(Z),className:I("w-[85%] py-2.5 rounded-xl text-center text-sm font-semibold snap-center transition-all duration-150 my-0.5",Q?I(Be.pill,"text-white shadow-lg scale-[1.02]"):"text-foreground hover:bg-muted/50"),style:{opacity:Q?1:Fe},children:Q&&Te?`${Qs(Z)} â€“ ${Qs(Te)}`:Qs(Z)},Z)})}),e.jsx("div",{className:"sticky bottom-0 h-12 bg-gradient-to-t from-card to-transparent z-10 pointer-events-none"})]})]}),e.jsxs("div",{className:"bg-card rounded-xl border border-border/50 overflow-hidden",children:[xe.map(Z=>e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b border-border/30 group",children:[e.jsx(ka,{checked:Z.completed,onCheckedChange:Q=>ye({subtaskId:Z.id,completed:!!Q}),className:"h-4 w-4"}),e.jsx("span",{className:I("flex-1 text-sm",Z.completed&&"line-through text-muted-foreground"),children:Z.title}),e.jsx("button",{onClick:()=>we(Z.id),className:"p-1 rounded opacity-0 group-hover:opacity-100 hover:bg-destructive/10 text-muted-foreground hover:text-destructive transition-all",children:e.jsx(oa,{className:"h-3.5 w-3.5"})})]},Z.id)),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b border-border/30",children:[e.jsx(ka,{disabled:!0,className:"h-4 w-4 opacity-30"}),e.jsx("input",{value:U,onChange:Z=>ce(Z.target.value),onKeyDown:Z=>{Z.key==="Enter"&&U.trim()&&(Z.preventDefault(),ve())},placeholder:"Add Subtask",className:"flex-1 bg-transparent text-sm outline-none placeholder:text-muted-foreground/60"})]}),e.jsx(Zt,{value:E||"",onChange:Z=>O(Z.target.value||null),placeholder:"Add notes, meeting links or phone numbers...",className:"min-h-[70px] border-0 rounded-none bg-transparent resize-none focus-visible:ring-0 focus-visible:ring-offset-0 text-sm",style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent"},"data-vaul-no-drag":!0})]}),e.jsxs("div",{className:"space-y-2 px-1",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground",children:"Photo / Files"}),e.jsx(Nh,{attachments:$,onAttachmentsChange:B})]}),e.jsxs(yl,{open:M,onOpenChange:A,children:[e.jsx(kh,{asChild:!0,children:e.jsxs(z,{variant:"ghost",size:"sm",className:"w-full justify-between text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx($u,{className:"w-4 h-4"}),"Advanced Settings"]}),e.jsx("span",{className:"text-xs",children:M?"â–²":"â–¼"})]})}),e.jsx(xi,{children:e.jsx("div",{className:"mt-3",children:e.jsx(xl,{scheduledTime:b,estimatedDuration:x,recurrencePattern:j,recurrenceDays:S,reminderEnabled:D,reminderMinutesBefore:_,onScheduledTimeChange:w,onEstimatedDurationChange:v,onRecurrencePatternChange:T,onRecurrenceDaysChange:N,onReminderEnabledChange:R,onReminderMinutesBeforeChange:C,moreInformation:E,onMoreInformationChange:O,location:W,onLocationChange:H,selectedDate:Pe??new Date,hideScheduledTime:!0,hideDuration:!0,hideMoreInformation:!0})})})]})]})}),e.jsxs("div",{className:"px-5 pt-4 pb-6 flex-shrink-0 flex flex-col gap-3 border-t border-border/50",children:[e.jsx(z,{onClick:Qe,disabled:i||!p.trim(),className:I("w-full text-white",p.trim()?I(Be.pill,"hover:opacity-90"):""),children:i?"Saving...":"Save Changes"}),c&&e.jsxs(z,{variant:"outline",onClick:()=>c(t?.id||""),disabled:u||!t?.id,className:"w-full",children:[e.jsx(Uu,{className:"w-4 h-4 mr-2"}),u?"Syncing...":d?"Re-send to Calendar":"Send to Calendar"]}),o&&e.jsxs(z,{variant:"ghost",onClick:()=>q(!0),disabled:l,className:"w-full text-destructive hover:text-destructive hover:bg-destructive/10",children:[e.jsx(oa,{className:"w-4 h-4 mr-2"}),"Delete"]})]})]}),e.jsx(mr,{open:L,onOpenChange:q,children:e.jsxs(Ea,{children:[e.jsxs(Ta,{children:[e.jsx(Da,{children:"Delete this quest?"}),e.jsxs(Aa,{children:['This action cannot be undone. This will permanently delete "',t?.task_text,'".']})]}),e.jsxs(Ma,{children:[e.jsx(Pa,{children:"Cancel"}),e.jsx(la,{onClick:De,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:l?"Deleting...":"Delete"})]})]})})]})}function VC(){const t=n.useCallback(async r=>{const{data:{user:i}}=await k.auth.getUser();if(!i){console.log("[SchedulingLearner] No user - skipping completion tracking");return}console.log("[SchedulingLearner] Tracking completion for user:",i.id),console.log("[SchedulingLearner] Data:",{taskText:r.taskText?.substring(0,30),category:r.category,difficulty:r.difficulty});try{const{data:o,error:l}=await k.functions.invoke("analyze-user-patterns",{body:{type:"task_completion",data:r}});l?console.error("[SchedulingLearner] Edge function error:",l):console.log("[SchedulingLearner] Completion saved:",o)}catch(o){console.error("[SchedulingLearner] Error tracking completion:",o)}},[]),s=n.useCallback(async(r,i,o)=>{const{data:{user:l}}=await k.auth.getUser();if(l)try{const c={suggestedTime:r,actualTime:i,taskDifficulty:o};await k.functions.invoke("analyze-user-patterns",{body:{type:"schedule_modification",data:c}})}catch(c){console.error("[useSchedulingLearner] Error tracking modification:",c)}},[]),a=n.useCallback(async(r,i,o,l)=>{const{data:{user:c}}=await k.auth.getUser();if(!c){console.log("[SchedulingLearner] No user - skipping creation tracking");return}console.log("[SchedulingLearner] Tracking creation:",{taskText:l?.substring(0,30),category:o,difficulty:i});try{const d={scheduledTime:r,difficulty:i,createdAt:new Date().toISOString(),hour:new Date().getHours(),taskText:l,category:o},{data:u,error:p}=await k.functions.invoke("analyze-user-patterns",{body:{type:"task_creation",data:d}});p?console.error("[SchedulingLearner] Edge function error:",p):console.log("[SchedulingLearner] Creation saved:",u)}catch(d){console.error("[SchedulingLearner] Error tracking creation:",d)}},[]);return{trackTaskCompletion:t,trackScheduleModification:s,trackTaskCreation:a}}const XC=async(t,s)=>{if(!t)return{bonusXP:0,toastReason:"Task Complete!"};try{const{data:a,error:r}=await k.from("epic_habits").select("epic_id, epics!inner(is_public, status)").eq("epics.status","active").eq("epics.is_public",!0);if(r)return console.error("Failed to fetch epic habits:",r),{bonusXP:0,toastReason:"Task Complete!"};if(!a||a.length===0)return{bonusXP:0,toastReason:"Task Complete!"};const{data:i,error:o}=await k.from("epic_members").select("epic_id").eq("user_id",t).in("epic_id",a.map(l=>l.epic_id));if(o)return console.error("Failed to fetch memberships:",o),{bonusXP:0,toastReason:"Task Complete!"};if(i&&i.length>0){const l=Math.round(s*.1),c=s>0?Math.max(1,l):0;return{bonusXP:c,toastReason:`Task Complete! +${c} Guild Bonus (10%) ðŸŽ¯`}}}catch(a){console.error("Unexpected error computing guild bonus:",a)}return{bonusXP:0,toastReason:"Task Complete!"}},Ah=["mind","body","soul"],JC={body:["gym","run","exercise","workout","walk","yoga","stretch","fitness","sports"],soul:["meditate","journal","breathe","gratitude","reflect","pray","mindful","relax","rest"],mind:["read","learn","study","plan","organize","think","write","research","course"]};function no(t,s){if(s&&Ah.includes(s))return s;const a=t.toLowerCase();for(const[r,i]of Object.entries(JC))if(i.some(o=>a.includes(o)))return r;return null}const In=t=>!t||t.length===0?null:t.find(s=>s.isImage)?.fileUrl??null,Yc=t=>({taskId:t.taskId,completed:t.completed,completedAt:t.completed?new Date().toISOString():null,forceUndo:t.forceUndo??!1}),Vc=(t,s)=>{const a={...s};if("attachments"in a){const r=a.attachments;a.image_url=In(r)??a.image_url??null,delete a.attachments}return{taskId:t,updates:a}};function Xc(t){if(!t)return!1;const s=(t.code??"").toUpperCase(),a=`${t.message??""} ${t.details??""} ${t.hint??""}`.toLowerCase(),r=a.includes("task_attachments");return s==="42P01"&&r?!0:r&&(s.startsWith("PGRST")||a.includes("schema cache")||a.includes("does not exist")||a.includes("could not find the table")||a.includes("relation"))}const io=()=>({attachmentsSkippedDueToSchema:!1}),Ph=t=>{const{user:s}=_e(),{toast:a}=_s(),r=Ie(),{companion:i}=At(),{updateDisciplineFromRitual:o}=Xm(),{showXPToast:l}=vm(),{awardCustomXP:c}=rs(),{trackTaskCompletion:d,trackTaskCreation:u}=VC(),{shouldQueueWrites:p,queueTaskAction:h,reportApiFailure:f}=gi(),m=n.useRef(!1),g=()=>{a({title:"Attachments unavailable",description:"Quest saved, but attachments could not be stored. Please try again after the backend migration finishes."})},y=async _=>{if(!s?.id)throw new Error("User not authenticated");const{data:C,error:E}=await k.from("daily_tasks").select("task_date, scheduled_time, habit_source_id, source").eq("id",_).eq("user_id",s.id).maybeSingle();if(E)throw E;if(!C)throw new Error("Task not found");return C},b=async(_,C)=>{if(!s?.id)throw new Error("User not authenticated");const{error:E}=await k.from("task_attachments").delete().eq("task_id",_).eq("user_id",s.id);if(E){if(Xc(E))return{attachmentsSkippedDueToSchema:!0};throw E}if(C.length===0)return io();const O=C.map((A,L)=>({task_id:_,user_id:s.id,file_url:A.fileUrl,file_path:A.filePath,file_name:A.fileName,mime_type:A.mimeType,file_size_bytes:A.fileSizeBytes,is_image:A.isImage,sort_order:A.sortOrder??L})),{error:M}=await k.from("task_attachments").insert(O);if(M){if(Xc(M))return{attachmentsSkippedDueToSchema:!0};throw M}return io()},w=he({mutationFn:async _=>{if(m.current)throw new Error("Please wait...");m.current=!0;const C=Za({task_date:_.taskDate!==void 0?_.taskDate:t,scheduled_time:_.scheduledTime||null,habit_source_id:null,source:_.taskDate===null?"inbox":"manual"}),E=(_.attachments??[]).slice(0,10),O=In(E)??_.imageUrl??null,M=no(_.taskText,_.category),A=async()=>({id:"queued-"+await h("CREATE_TASK",{task_text:_.taskText,difficulty:_.difficulty,xp_reward:Fi(_.difficulty,1),task_date:C.task_date,is_main_quest:_.isMainQuest??!1,scheduled_time:C.scheduled_time,estimated_duration:_.estimatedDuration||null,recurrence_pattern:_.recurrencePattern||null,recurrence_days:_.recurrenceDays||null,recurrence_end_date:_.recurrenceEndDate||null,reminder_enabled:_.reminderEnabled??!1,reminder_minutes_before:_.reminderMinutesBefore??15,category:M,notes:_.notes||null,contact_id:_.contactId||null,auto_log_interaction:_.autoLogInteraction??!0,image_url:O,location:_.location||null,source:C.source??(C.task_date===null?"inbox":"manual")}),task_date:C.task_date,scheduled_time:C.scheduled_time,task_text:_.taskText,difficulty:_.difficulty,queued:!0,attachmentsSkippedDueToSchema:!1});try{if(!s?.id)throw new Error("User not authenticated");if(p)return A();const L=C.task_date;let q=k.from("daily_tasks").select("id").eq("user_id",s.id);L===null?q=q.is("task_date",null):q=q.eq("task_date",L);const{data:$,error:B}=await q;if(B)throw B;const W=($?.length||0)+1,H=Fi(_.difficulty,W),{data:K,error:X}=await k.from("daily_tasks").insert({user_id:s.id,task_text:_.taskText,difficulty:_.difficulty,xp_reward:H,task_date:C.task_date,is_main_quest:_.isMainQuest??!1,scheduled_time:C.scheduled_time,estimated_duration:_.estimatedDuration||null,recurrence_pattern:_.recurrencePattern||null,recurrence_days:_.recurrenceDays||null,recurrence_end_date:_.recurrenceEndDate||null,is_recurring:!!_.recurrencePattern,reminder_enabled:_.reminderEnabled??!1,reminder_minutes_before:_.reminderMinutesBefore??15,category:M,is_bonus:!1,notes:_.notes||null,contact_id:_.contactId||null,auto_log_interaction:_.autoLogInteraction??!0,image_url:O,location:_.location||null,source:C.source??(C.task_date===null?"inbox":"manual")}).select().single();if(X)throw X.message?.includes("MAX_TASKS_REACHED")||X.message?.includes("Maximum quest limit")?new Error("Maximum quest limit reached for today"):X;let Y=io();if(K?.id)try{Y=await b(K.id,E)}catch(ie){throw await k.from("daily_tasks").delete().eq("id",K.id).eq("user_id",s.id),ie}const ee=(_.subtasks||[]).map(ie=>ie.trim()).filter(ie=>ie.length>0);if(ee.length>0&&K?.id){const{error:ie}=await k.from("subtasks").insert(ee.map((fe,U)=>({task_id:K.id,user_id:s.id,title:fe,sort_order:U})));if(ie)throw await k.from("daily_tasks").delete().eq("id",K.id).eq("user_id",s.id),ie}return{...K??{},attachmentsSkippedDueToSchema:Y.attachmentsSkippedDueToSchema}}catch(L){if(Ms(L))return f(L,{source:"task_add"}),A();throw f(L,{source:"task_add_nonqueueable"}),L}finally{m.current=!1}},onMutate:async _=>{await r.cancelQueries({queryKey:["daily-tasks"]}),await r.cancelQueries({queryKey:["calendar-tasks"]});const C=r.getQueriesData({queryKey:["daily-tasks"]}),E=r.getQueriesData({queryKey:["calendar-tasks"]}),O=Za({task_date:_.taskDate!==void 0?_.taskDate:t,scheduled_time:_.scheduledTime||null,habit_source_id:null,source:_.taskDate===null?"inbox":"manual"}),M=In(_.attachments)??_.imageUrl??null,A={id:`temp-${Date.now()}`,user_id:s?.id,task_text:_.taskText,difficulty:_.difficulty,task_date:O.task_date,completed:!1,completed_at:null,is_main_quest:_.isMainQuest??!1,scheduled_time:O.scheduled_time,estimated_duration:_.estimatedDuration||null,xp_reward:Fi(_.difficulty,1),created_at:new Date().toISOString(),category:no(_.taskText,_.category),is_bonus:!1,is_recurring:!!_.recurrencePattern,recurrence_pattern:_.recurrencePattern||null,recurrence_days:_.recurrenceDays||null,reminder_enabled:_.reminderEnabled??!1,reminder_minutes_before:_.reminderMinutesBefore??15,reminder_sent:!1,parent_template_id:null,notes:_.notes||null,image_url:M,location:_.location||null,source:O.source??(O.task_date===null?"inbox":"manual")};return A.task_date&&r.setQueryData(["daily-tasks",s?.id,A.task_date],L=>!L||!Array.isArray(L)?L:[A,...L]),{previousDailyTasks:C,previousCalendarTasks:E}},onError:(_,C,E)=>{E?.previousDailyTasks&&E.previousDailyTasks.forEach(([O,M])=>{r.setQueryData(O,M)}),E?.previousCalendarTasks&&E.previousCalendarTasks.forEach(([O,M])=>{r.setQueryData(O,M)}),f(_,{source:"task_add_onError"}),a({title:"Failed to add quest",description:_.message,variant:"destructive"})},onSettled:()=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),r.invalidateQueries({queryKey:["inbox-tasks"]}),r.invalidateQueries({queryKey:["inbox-count"]})},onSuccess:_=>{if(_?.queued){a({title:"Quest queued",description:"We'll sync it as soon as connection is restored."});return}else a({title:"Quest added!"});_?.attachmentsSkippedDueToSchema&&g(),window.dispatchEvent(new CustomEvent("task-added",{detail:{taskDate:_?.task_date??null,scheduledTime:_?.scheduled_time??null}})),_&&u(_.scheduled_time,_.difficulty||"medium",_.category,_.task_text)}}),x=he({mutationFn:async _=>{const{taskId:C,completed:E,xpReward:O,forceUndo:M=!1}=_;if(!s?.id)throw new Error("User not authenticated");if(p)return await h("COMPLETE_TASK",Yc(_)),{queued:!0,taskId:C,completed:E,xpAwarded:0,toastReason:null,wasAlreadyCompleted:!1,isUndo:!1,taskText:"Quest",habitSourceId:null,taskDifficulty:null,taskScheduledTime:null,taskCategory:null};const{data:A,error:L}=await k.from("daily_tasks").select(`
          completed_at, task_text, habit_source_id, task_date, difficulty, scheduled_time, category,
          is_main_quest, xp_reward,
          contact_id, auto_log_interaction,
          contact:contacts!contact_id(id, name, avatar_url)
        `).eq("id",C).eq("user_id",s.id).maybeSingle();if(L)throw L;const q=A?.completed_at!==null,$=A?.task_text||"Task",B=A?.habit_source_id,W=A?.task_date||ae(new Date,"yyyy-MM-dd"),H=A?.is_main_quest===!0,K=Number(A?.xp_reward??O),X=Math.round(K*Eo),Y=H&&O<=K?X:O;if(q&&!E&&!M)throw new Error("Cannot uncheck completed tasks");if(!E&&M){const{error:Se}=await k.from("daily_tasks").update({completed:!1,completed_at:null}).eq("id",C).eq("user_id",s.id);if(Se)throw Se;return Y>0&&await c(-Y,"task_undo","Quest undone",{task_id:C}),B&&await k.from("habit_completions").delete().eq("user_id",s.id).eq("habit_id",B).eq("date",W),{taskId:C,completed:!1,xpAwarded:0,wasAlreadyCompleted:!0,isUndo:!0,taskText:$,habitSourceId:B}}if(!E){const{error:Se}=await k.from("daily_tasks").update({completed:!1,completed_at:null}).eq("id",C).eq("user_id",s.id);if(Se)throw Se;return B&&await k.from("habit_completions").delete().eq("user_id",s.id).eq("habit_id",B).eq("date",W),{taskId:C,completed:!1,xpAwarded:0,wasAlreadyCompleted:q,isUndo:!1,taskText:$,habitSourceId:B}}const{bonusXP:ee,toastReason:ie}=await XC(s.id,Y),fe=Y+ee,{data:U,error:ce}=await k.from("daily_tasks").update({completed:!0,completed_at:new Date().toISOString()}).eq("id",C).eq("user_id",s.id).eq("completed",!1).select();if(ce)throw ce;if(!U||U.length===0)throw new Error("Task was already completed");const ne=(await c(fe,"task_complete",ie,{task_id:C}))?.xpAwarded??0;if(B){const{error:Se}=await k.from("habit_completions").upsert({user_id:s.id,habit_id:B,date:W},{onConflict:"user_id,habit_id,date"});Se?console.error("[Task Toggle] Failed to sync habit completion:",Se):console.log("[Task Toggle] Synced habit completion for habit:",B)}const xe=A?.difficulty||"medium",G=A?.scheduled_time||null,ye=A?.category||null,we=A?.contact_id||null,Te=A?.auto_log_interaction??!0,qe=A?.contact;return{taskId:C,completed:!0,xpAwarded:ne,bonusXP:ee,toastReason:ie,wasAlreadyCompleted:q,isUndo:!1,taskText:$,habitSourceId:B,taskDifficulty:xe,taskScheduledTime:G,taskCategory:ye,contactId:we,autoLogInteraction:Te,contact:qe}},onSuccess:async _=>{const{completed:C,xpAwarded:E,toastReason:O,wasAlreadyCompleted:M,isUndo:A,taskId:L,taskText:q,habitSourceId:$,taskDifficulty:B,taskScheduledTime:W,taskCategory:H}=_??{};if(r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),_?.queued){a({title:"Quest update queued",description:"We'll sync this change when connection is restored."});return}if($&&(r.invalidateQueries({queryKey:["habit-completions"]}),r.invalidateQueries({queryKey:["habits"]}),r.invalidateQueries({queryKey:["habit-surfacing"]}),r.invalidateQueries({queryKey:["epics"]})),A){a({title:"Quest undone",description:"XP has been adjusted"});return}if(C&&!M){E>0&&l(E,O||"Quest Complete!"),i?.id&&o(i.id).catch(console.error),window.dispatchEvent(new CustomEvent("mission-completed")),window.dispatchEvent(new CustomEvent("quest-completed"));const K=new Date;console.log("[TaskMutations] About to track completion:",{taskId:L,taskText:q?.substring(0,50),taskDifficulty:B,taskCategory:H});try{await d({taskId:L,completedAt:K.toISOString(),difficulty:B||"medium",scheduledTime:W,actualCompletionHour:K.getHours(),dayOfWeek:K.getDay(),wasOnTime:W?Math.abs(parseInt(W.split(":")[0])-K.getHours())<=1:null,category:H||void 0,taskText:q}),console.log("[TaskMutations] trackTaskCompletion succeeded")}catch(X){console.error("[TaskMutations] trackTaskCompletion failed:",X)}a({title:"Quest completed! âœ¨",description:q.length>40?q.substring(0,40)+"...":q,duration:5e3,action:n.createElement(um,{altText:"Undo completion",onClick:()=>{x.mutate({taskId:L,completed:!1,xpReward:E,forceUndo:!0})}},"Undo")})}},onError:(_,C)=>{if(Ms(_)){f(_,{source:"task_toggle_onError"}),h("COMPLETE_TASK",Yc(C)),a({title:"Quest update queued",description:"We'll sync this change when connection is restored."});return}f(_,{source:"task_toggle_onError_nonqueueable"});const E=_.message==="Please wait..."?"Please wait for the previous action to complete":_.message.includes("Failed to fetch")||_.message.includes("Load failed")?"Network error. Please check your connection and try again.":_.message;a({title:"Failed to toggle quest",description:E,variant:"destructive"})},retry:2,retryDelay:1e3}),v=he({mutationFn:async _=>{if(!s?.id)throw new Error("User not authenticated");if(!_)throw new Error("Invalid task ID");if(p)return await h("DELETE_TASK",{taskId:_}),{queued:!0};const{error:C}=await k.from("daily_tasks").delete().eq("id",_).eq("user_id",s.id);if(C)throw C;return{queued:!1}},onSuccess:_=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),_?.queued&&a({title:"Quest deletion queued",description:"We'll sync this deletion when connection is restored."})},onError:(_,C)=>{if(Ms(_)){f(_,{source:"task_delete_onError"}),h("DELETE_TASK",{taskId:C}),a({title:"Quest deletion queued",description:"We'll sync this deletion when connection is restored."});return}f(_,{source:"task_delete_onError_nonqueueable"}),a({title:"Failed to delete quest",description:_.message,variant:"destructive"})}}),j=he({mutationFn:async _=>{if(!s?.id)throw new Error("User not authenticated");const C=Za({task_date:_.task_date??null,scheduled_time:_.scheduled_time??null,habit_source_id:_.habit_source_id??null,source:_.source??null}),{data:E,error:O}=await k.from("daily_tasks").insert({user_id:s.id,task_text:_.task_text,task_date:C.task_date,xp_reward:_.xp_reward??10,difficulty:_.difficulty??"medium",scheduled_time:C.scheduled_time,estimated_duration:_.estimated_duration,is_main_quest:_.is_main_quest??!1,epic_id:_.epic_id,sort_order:_.sort_order,notes:_.notes,priority:_.priority,category:_.category,habit_source_id:_.habit_source_id,is_recurring:_.is_recurring??!1,recurrence_pattern:_.recurrence_pattern,recurrence_days:_.recurrence_days,reminder_enabled:_.reminder_enabled??!1,reminder_minutes_before:_.reminder_minutes_before,source:C.source??(C.task_date===null?"inbox":"manual")}).select().single();if(O)throw O;return E},onSuccess:()=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]})},onError:_=>{a({title:"Failed to restore quest",description:_.message,variant:"destructive"})}}),T=he({mutationFn:async _=>{if(!s?.id)throw new Error("User not authenticated");const{data:C,error:E}=await k.from("daily_tasks").select("id, user_id, task_date").eq("id",_).eq("user_id",s.id).eq("task_date",t).maybeSingle();if(E)throw E;if(!C)throw new Error("Task not found or access denied");await k.from("daily_tasks").update({is_main_quest:!1}).eq("user_id",s.id).eq("task_date",t);const{error:O}=await k.from("daily_tasks").update({is_main_quest:!0}).eq("id",_).eq("user_id",s.id);if(O)throw O},onSuccess:()=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),a({title:"Main quest updated!"})},onError:_=>{a({title:"Failed to update main quest",description:_.message,variant:"destructive"})}}),S=he({mutationFn:async({taskId:_,updates:C})=>{if(!s?.id)throw new Error("User not authenticated");let E=!1,O=!1,M=!1,A=!1;const L={};if(C.task_text!==void 0&&(L.task_text=C.task_text),C.task_date!==void 0&&(L.task_date=C.task_date),C.difficulty!==void 0&&(L.difficulty=C.difficulty),C.scheduled_time!==void 0&&(L.scheduled_time=C.scheduled_time),C.estimated_duration!==void 0&&(L.estimated_duration=C.estimated_duration),C.recurrence_pattern!==void 0&&(L.recurrence_pattern=C.recurrence_pattern),C.recurrence_days!==void 0&&(L.recurrence_days=C.recurrence_days),C.reminder_enabled!==void 0&&(L.reminder_enabled=C.reminder_enabled),C.reminder_minutes_before!==void 0&&(L.reminder_minutes_before=C.reminder_minutes_before),C.notes!==void 0&&(L.notes=C.notes),C.category!==void 0||C.task_text!==void 0){const B=C.category&&Ah.includes(C.category)?C.category:C.task_text?no(C.task_text,C.category||void 0):C.category;L.category=B}C.image_url!==void 0&&(L.image_url=C.image_url);const q=C.attachments!==void 0;if(q&&(L.image_url=In(C.attachments)??null),C.location!==void 0&&(L.location=C.location),!p&&(C.task_date!==void 0||C.scheduled_time!==void 0)){const B=await y(_),W=Rn(B,{task_date:C.task_date,scheduled_time:C.scheduled_time});L.task_date=W.task_date,L.scheduled_time=W.scheduled_time,W.source!==B.source&&(L.source=W.source),E=W.normalizedToInbox,O=W.strippedScheduledTime,M=W.movedFromInboxToScheduled}if(Object.keys(L).length===0)return{normalizedToInbox:E,strippedScheduledTime:O,movedFromInboxToScheduled:M,attachmentsSkippedDueToSchema:A,queued:!1};if(p)return await h("UPDATE_TASK",Vc(_,L)),{normalizedToInbox:E,strippedScheduledTime:O,movedFromInboxToScheduled:M,attachmentsSkippedDueToSchema:A,queued:!0};const{error:$}=await k.from("daily_tasks").update(L).eq("id",_).eq("user_id",s.id);if($)throw $;return q&&(A=(await b(_,C.attachments??[])).attachmentsSkippedDueToSchema),{normalizedToInbox:E,strippedScheduledTime:O,movedFromInboxToScheduled:M,attachmentsSkippedDueToSchema:A,queued:!1}},onSuccess:(_,C)=>{if(r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),_?.queued){a({title:"Quest update queued",description:"We'll sync this change when connection is restored."});return}_?.attachmentsSkippedDueToSchema&&g();const E=Object.entries(C.updates).filter(([,M])=>M!==void 0).map(([M])=>M),O=E.length===1&&E[0]==="scheduled_time";if(_?.normalizedToInbox){a({title:"Moved to Inbox",description:"Regular quests without a time are kept in Inbox."});return}if(_?.movedFromInboxToScheduled){a({title:"Moved to Quests",description:"Added a time, so this quest is now scheduled in Quests."});return}O||a({title:"Quest updated!"})},onError:(_,C)=>{if(Ms(_)){f(_,{source:"task_update_onError"}),h("UPDATE_TASK",Vc(C.taskId,C.updates)),a({title:"Quest update queued",description:"We'll sync this change when connection is restored."});return}f(_,{source:"task_update_onError_nonqueueable"}),a({title:"Failed to update quest",description:_.message,variant:"destructive"})}}),N=he({mutationFn:async _=>{if(!s?.id)throw new Error("User not authenticated");for(const C of _){const{error:E}=await k.from("daily_tasks").update({sort_order:C.sort_order}).eq("id",C.id).eq("user_id",s.id);if(E)throw E}},onMutate:async _=>{await r.cancelQueries({queryKey:["daily-tasks"]}),await r.cancelQueries({queryKey:["calendar-tasks"]});const C=r.getQueriesData({queryKey:["daily-tasks"]}),E=r.getQueriesData({queryKey:["calendar-tasks"]}),O=new Map(_.map(M=>[M.id,M.sort_order]));return r.setQueriesData({queryKey:["daily-tasks"]},M=>!M||!Array.isArray(M)?M:[...M].map(A=>({...A,sort_order:O.has(A.id)?O.get(A.id):A.sort_order})).sort((A,L)=>(A.sort_order??999)-(L.sort_order??999))),r.setQueriesData({queryKey:["calendar-tasks"]},M=>!M||!Array.isArray(M)?M:[...M].map(A=>({...A,sort_order:O.has(A.id)?O.get(A.id):A.sort_order})).sort((A,L)=>(A.sort_order??999)-(L.sort_order??999))),{previousDailyTasks:C,previousCalendarTasks:E}},onError:(_,C,E)=>{E?.previousDailyTasks&&E.previousDailyTasks.forEach(([O,M])=>{r.setQueryData(O,M)}),E?.previousCalendarTasks&&E.previousCalendarTasks.forEach(([O,M])=>{r.setQueryData(O,M)}),a({title:"Failed to reorder quests",description:_.message,variant:"destructive"})},onSettled:()=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]})}}),D=he({mutationFn:async({taskId:_,targetSection:C})=>{if(!s?.id)throw new Error("User not authenticated");const O={morning:"09:00",afternoon:"14:00",evening:"19:00",unscheduled:null}[C],M=await y(_),A=Rn(M,{scheduled_time:O}),L={task_date:A.task_date,scheduled_time:A.scheduled_time,sort_order:0};A.source!==M.source&&(L.source=A.source);const{error:q}=await k.from("daily_tasks").update(L).eq("id",_).eq("user_id",s.id);if(q)throw q;return A},onSuccess:_=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),_?.normalizedToInbox&&a({title:"Moved to Inbox",description:"Regular quests without a time are kept in Inbox."})},onError:_=>{a({title:"Failed to move quest",description:_.message,variant:"destructive"})}}),R=he({mutationFn:async({taskId:_,targetDate:C})=>{if(!s?.id)throw new Error("User not authenticated");const E=await y(_),O=Rn(E,{task_date:C}),M={task_date:O.task_date,scheduled_time:O.scheduled_time,sort_order:0};O.source!==E.source&&(M.source=O.source);const{error:A}=await k.from("daily_tasks").update(M).eq("id",_).eq("user_id",s.id);if(A)throw A;return{taskId:_,targetDate:O.task_date,normalizedToInbox:O.normalizedToInbox}},onMutate:async()=>{await r.cancelQueries({queryKey:["daily-tasks"]}),await r.cancelQueries({queryKey:["calendar-tasks"]});const _=r.getQueriesData({queryKey:["daily-tasks"]}),C=r.getQueriesData({queryKey:["calendar-tasks"]});return{previousDaily:_,previousCalendar:C}},onError:(_,C,E)=>{E?.previousDaily&&E.previousDaily.forEach(([O,M])=>r.setQueryData(O,M)),E?.previousCalendar&&E.previousCalendar.forEach(([O,M])=>r.setQueryData(O,M)),a({title:"Failed to move quest",description:_.message,variant:"destructive"})},onSuccess:_=>{_?.normalizedToInbox&&a({title:"Moved to Inbox",description:"Regular quests without a time are kept in Inbox."})},onSettled:()=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]})}});return{addTask:w.mutateAsync,toggleTask:x.mutate,deleteTask:v.mutateAsync,restoreTask:j.mutateAsync,setMainQuest:T.mutate,updateTask:S.mutateAsync,reorderTasks:N.mutate,moveTaskToSection:D.mutate,moveTaskToDate:R.mutate,isAdding:w.isPending,isToggling:x.isPending,isDeleting:v.isPending,isRestoring:j.isPending,isUpdating:S.isPending,isReordering:N.isPending,isMoving:D.isPending,isMovingDate:R.isPending}};function Jc(t){if(!t.task_date)throw new Error("TASK_DATE_REQUIRED");if(!t.scheduled_time)throw new Error("SCHEDULED_TIME_REQUIRED");const s=Gr(t.scheduled_time,new Date(`${t.task_date}T00:00:00`));if(!s)throw new Error("SCHEDULED_TIME_INVALID");const a=t.estimated_duration&&t.estimated_duration>0?t.estimated_duration:30,r=new Date(s.getTime()+a*6e4);return{startDate:s.toISOString(),endDate:r.toISOString()}}function Rh(t={}){const{user:s}=_e(),a=Ie(),{enabled:r=!0}=t,{connections:i,defaultProvider:o}=wi({enabled:r}),c=Ee({queryKey:["quest-calendar-links",s?.id],enabled:r&&!!s?.id,queryFn:async()=>{if(!s?.id)return[];const{data:x,error:v}=await k.from("quest_calendar_links").select("id, task_id, user_id, connection_id, provider, external_calendar_id, external_event_id, sync_mode, last_app_sync_at, last_provider_sync_at").eq("user_id",s.id);if(v)throw v;return x||[]}}).data||[],d=n.useMemo(()=>{const x=new Map;for(const v of c){const j=x.get(v.task_id)||[];j.push(v),x.set(v.task_id,j)}return x},[c]),u=x=>i.find(v=>v.provider===x)||null,p=x=>{if(x){if(!u(x))throw new Error("NO_CALENDAR_CONNECTION");return x}if(o&&u(o))return o;const v=i[0]?.provider;if(!v)throw new Error("NO_CALENDAR_CONNECTION");return v},h=async x=>{if(!s?.id)throw new Error("User not authenticated");const{data:v,error:j}=await k.from("daily_tasks").select("id, task_text, task_date, scheduled_time, estimated_duration, location, notes").eq("id",x).eq("user_id",s.id).single();if(j||!v)throw new Error("Task not found");return v},f=async(x,v)=>{if(!s?.id)throw new Error("User not authenticated");const j={};if(v.taskDate!==void 0&&(j.task_date=v.taskDate),v.scheduledTime!==void 0&&(j.scheduled_time=v.scheduledTime),v.estimatedDuration!==void 0&&(j.estimated_duration=v.estimatedDuration),Object.keys(j).length===0)return;const{error:T}=await k.from("daily_tasks").update(j).eq("id",x).eq("user_id",s.id);if(T)throw T},m=he({mutationFn:async({taskId:x,options:v})=>{if(!s?.id)throw new Error("User not authenticated");const j=p(v?.provider),T=u(j);if(!T)throw new Error("NO_CALENDAR_CONNECTION");v&&await f(x,v);const S=await h(x);if(!S.task_date)throw new Error("TASK_DATE_REQUIRED");if(!S.scheduled_time)throw new Error("SCHEDULED_TIME_REQUIRED");const N=(d.get(x)||[]).find(C=>C.provider===j);if(j==="apple"){if(!(await ys.isAvailable()).available)throw new Error("Apple Calendar is only available on iOS native builds");if(!(await ys.requestPermissions()).granted)throw new Error("Calendar permission not granted");const O=T.primary_calendar_id;if(!O)throw new Error("No primary Apple calendar selected");const M=Jc(S),{eventId:A}=await ys.createOrUpdateEvent({calendarId:O,eventId:N?.external_event_id,title:S.task_text,notes:S.notes,location:S.location,startDate:M.startDate,endDate:M.endDate,isAllDay:!1}),L=new Date().toISOString(),{error:q}=await k.from("quest_calendar_links").upsert({user_id:s.id,task_id:S.id,connection_id:T.id,provider:"apple",external_calendar_id:O,external_event_id:A,sync_mode:T.sync_mode,last_app_sync_at:L,last_provider_sync_at:L},{onConflict:"task_id,connection_id"});if(q)throw q;return}const D=`${j}-calendar-events`,R=N?"updateLinkedEvent":"createLinkedEvent",{error:_}=await k.functions.invoke(D,{body:{action:R,taskId:x,syncMode:T.sync_mode}});if(_)throw new Error(_.message||`Failed to send task to ${j}`)},onSuccess:async()=>{await Promise.all([a.invalidateQueries({queryKey:["quest-calendar-links"]}),a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]})])}}),g=he({mutationFn:async({taskId:x})=>{if(!s?.id)throw new Error("User not authenticated");const v=(d.get(x)||[]).filter(T=>T.sync_mode==="full_sync");if(v.length===0)return;const j=await h(x);if(!(!j.task_date||!j.scheduled_time))for(const T of v){if(T.provider==="apple"){const D=u("apple");if(!D?.primary_calendar_id)continue;const R=Jc(j),{eventId:_}=await ys.createOrUpdateEvent({calendarId:T.external_calendar_id||D.primary_calendar_id,eventId:T.external_event_id,title:j.task_text,notes:j.notes,location:j.location,startDate:R.startDate,endDate:R.endDate,isAllDay:!1});await k.from("quest_calendar_links").update({external_event_id:_,last_app_sync_at:new Date().toISOString()}).eq("id",T.id).eq("user_id",s.id);continue}const S=`${T.provider}-calendar-events`,{error:N}=await k.functions.invoke(S,{body:{action:"updateLinkedEvent",taskId:x}});if(N)throw new Error(N.message||`Failed full sync update for ${T.provider}`)}},onSuccess:async()=>{await a.invalidateQueries({queryKey:["quest-calendar-links"]})}}),y=he({mutationFn:async({taskId:x})=>{if(!s?.id)throw new Error("User not authenticated");const v=(d.get(x)||[]).filter(j=>j.sync_mode==="full_sync");if(v.length!==0)for(const j of v){if(j.provider==="apple"){await ys.deleteEvent({eventId:j.external_event_id}).catch(()=>null),await k.from("quest_calendar_links").delete().eq("id",j.id).eq("user_id",s.id);continue}const T=`${j.provider}-calendar-events`;await k.functions.invoke(T,{body:{action:"deleteLinkedEvent",taskId:x}})}},onSuccess:async()=>{await a.invalidateQueries({queryKey:["quest-calendar-links"]})}}),b=he({mutationFn:async({provider:x})=>{const v=`${x}-calendar-events`,{error:j}=await k.functions.invoke(v,{body:{action:"syncLinkedChanges"}});if(j)throw new Error(j.message||`Failed to sync ${x} updates`)},onSuccess:async()=>{await Promise.all([a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]}),a.invalidateQueries({queryKey:["quest-calendar-links"]})])}});return{links:c,linksByTask:d,hasLinkedEvent:x=>(d.get(x)||[]).length>0,sendTaskToCalendar:m,syncTaskUpdate:g,syncTaskDelete:y,syncProviderPull:b}}const ZC=/^([01]\d|2[0-3]):([0-5]\d)$/,e5=/^\d{4}-\d{2}-\d{2}$/,t5=n.memo(function(){const s=Yr(),a=ts(),{user:r}=_e(),{isTabActive:i}=sn(),o=Ie(),{inboxTasks:l,inboxCount:c,isLoading:d,toggleInboxTask:u,deleteInboxTask:p}=gC({enabled:i}),[h,f]=n.useState(!1),[m,g]=n.useState(null),{addTask:y,updateTask:b,isUpdating:w}=Ph(ae(new Date,"yyyy-MM-dd")),{sendTaskToCalendar:x,syncTaskUpdate:v,syncTaskDelete:j,hasLinkedEvent:T}=Rh({enabled:i}),{connections:S}=wi({enabled:i}),N=n.useCallback(async C=>{const E=()=>{V.error("No calendar connected. Opening Preferences..."),a("/profile",{state:{openTab:"preferences"}})};if(S.length===0){E();return}let O,M;const A=async()=>{await x.mutateAsync({taskId:C,options:O||M?{taskDate:O,scheduledTime:M}:void 0})};try{await A(),V.success("Quest synced to calendar");return}catch(L){let q=L instanceof Error?L.message:"Failed to send quest to calendar";if(q.includes("NO_CALENDAR_CONNECTION")){E();return}for(let $=0;$<2;$+=1){if(q.includes("NO_CALENDAR_CONNECTION")){E();return}if(q.includes("TASK_DATE_REQUIRED")&&!O){const B=window.prompt("Choose a date to send this quest (YYYY-MM-DD)",ae(new Date,"yyyy-MM-dd"));if(!B||!e5.test(B)){V.error("Calendar send cancelled. Please choose a valid YYYY-MM-DD date.");return}O=B}if((q.includes("SCHEDULED_TIME_REQUIRED")||q.includes("SCHEDULED_TIME_INVALID"))&&!M){const B=window.prompt("Choose a time to send this quest (HH:mm)","09:00");if(!B||!ZC.test(B)){V.error("Calendar send cancelled. Please choose a valid HH:mm time.");return}M=B}try{await A(),V.success("Quest synced to calendar");return}catch(B){if(q=B instanceof Error?B.message:"Failed to send quest to calendar",q.includes("NO_CALENDAR_CONNECTION")){E();return}if(!q.includes("TASK_DATE_REQUIRED")&&!q.includes("SCHEDULED_TIME_REQUIRED")&&!q.includes("SCHEDULED_TIME_INVALID")){V.error(q);return}}}if(q.includes("TASK_DATE_REQUIRED")){V.error("Please assign a date before sending this quest to calendar.");return}if(q.includes("SCHEDULED_TIME_REQUIRED")||q.includes("SCHEDULED_TIME_INVALID")){V.error("Please assign a time before sending this quest to calendar.");return}V.error(q)}},[S.length,a,x]),D=n.useCallback(async(C,E)=>{await b({taskId:C,updates:E}),await v.mutateAsync({taskId:C}).catch(()=>{V.error("Saved quest, but failed to sync linked calendar event")}),o.invalidateQueries({queryKey:["inbox-tasks"]}),o.invalidateQueries({queryKey:["inbox-count"]}),g(null)},[b,v,o]),R=n.useCallback(async C=>{await j.mutateAsync({taskId:C}).catch(()=>{V.error("Failed to remove linked calendar event")}),p(C)},[p,j]),_=n.useCallback(async C=>{if(!r?.id)return;const E=C.sendToInbox?null:C.taskDate??ae(new Date,"yyyy-MM-dd");await y({taskText:C.text,difficulty:C.difficulty,taskDate:E,isMainQuest:!1,scheduledTime:C.scheduledTime,estimatedDuration:C.estimatedDuration,recurrencePattern:C.recurrencePattern,recurrenceDays:C.recurrenceDays,reminderEnabled:C.reminderEnabled,reminderMinutesBefore:C.reminderMinutesBefore,notes:C.moreInformation,location:C.location,contactId:C.contactId,autoLogInteraction:C.autoLogInteraction,subtasks:C.subtasks,imageUrl:C.imageUrl,attachments:C.attachments}),C.sendToInbox||o.invalidateQueries({queryKey:["daily-tasks"]}),o.invalidateQueries({queryKey:["inbox-tasks"]}),o.invalidateQueries({queryKey:["inbox-count"]}),f(!1)},[r?.id,y,N,o]);return e.jsx(tn,{mode:"instant",children:e.jsxs("div",{className:"min-h-screen bg-transparent pb-24 pt-safe",children:[e.jsx(an,{}),e.jsx("div",{className:"max-w-lg mx-auto px-4 pt-6",style:{paddingTop:"max(1.5rem, env(safe-area-inset-top, 0px))"},children:e.jsxs(P.div,{initial:s?!1:{opacity:0,y:-12},animate:{opacity:1,y:0},transition:{duration:s?0:.24},className:"text-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-semibold tracking-tight bg-gradient-to-r from-celestial-blue to-blue-400 bg-clip-text text-transparent",children:"Inbox"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Capture now. Conquer later."}),c>0&&e.jsxs(Oe,{variant:"celestial",className:"text-xs mt-2",children:[c," quests"]})]})}),e.jsx("div",{className:"max-w-lg mx-auto px-4 pt-4",children:d?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(C=>e.jsx("div",{className:"h-14 bg-muted/30 rounded-xl animate-pulse"},C))}):c===0?e.jsx(Rk,{icon:Yo,title:"Inbox is empty",description:"Capture quests with the + button â€” schedule them later when you're ready.",actionLabel:"Add a quest",onAction:()=>f(!0)}):e.jsx("div",{className:"space-y-2",children:l.map(C=>e.jsxs("div",{className:"flex items-center gap-3 py-3 px-3 rounded-2xl bg-card/82 backdrop-blur-lg border border-border/55 shadow-[0_8px_18px_rgba(0,0,0,0.16)]",children:[e.jsx("button",{onClick:()=>{u({taskId:C.id,completed:!C.completed}),gt.light()},className:"flex-shrink-0 w-6 h-6 rounded-full border-2 border-muted-foreground/40 hover:border-primary flex items-center justify-center transition-colors",children:C.completed&&e.jsx(Rt,{className:"w-4 h-4 text-primary"})}),e.jsx("span",{className:I("text-sm flex-1 min-w-0",C.completed&&"line-through text-muted-foreground"),children:C.task_text}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[e.jsx("button",{onClick:()=>{g(C),gt.light()},className:"p-2 rounded-xl hover:bg-muted/55 text-muted-foreground hover:text-foreground transition-colors touch-manipulation","aria-label":"Edit quest",children:e.jsx(Hu,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>{R(C.id),gt.light()},className:"p-2 rounded-xl hover:bg-destructive/12 text-muted-foreground hover:text-destructive transition-colors touch-manipulation","aria-label":"Delete quest",children:e.jsx(oa,{className:"w-4 h-4"})})]})]},C.id))})}),e.jsx(xh,{onTap:()=>f(!0)}),e.jsx(Mh,{open:h,onOpenChange:f,selectedDate:new Date,onAdd:_}),e.jsx(Dh,{task:m,open:!!m,onOpenChange:C=>!C&&g(null),onSave:D,isSaving:w,onSendToCalendar:void 0,hasCalendarLink:m?T(m.id):!1,isSendingToCalendar:x.isPending,onDelete:async C=>{await R(C),g(null)},isDeleting:!1})]})})}),oo=(t,s,a)=>Math.max(s,Math.min(a,t)),s5=()=>Math.max(0,document.documentElement.scrollHeight-window.innerHeight),a5=t=>{const s=window.getComputedStyle(t),a=s.overflowY||s.overflow;return/(auto|scroll|overlay)/i.test(a)&&t.scrollHeight>t.clientHeight},r5=t=>{if(!t)return{kind:"window"};let s=t;for(;s;){if(a5(s))return{kind:"element",element:s};s=s.parentElement}return{kind:"window"}};function n5({containerRef:t,edgeThreshold:s=80,scrollSpeed:a=8,enabled:r=!1}){const i=n.useRef(null),o=n.useRef({kind:"window"}),l=n.useRef(0),c=n.useCallback(()=>{i.current!==null&&(cancelAnimationFrame(i.current),i.current=null),l.current=0},[]),d=n.useCallback(()=>{if(!r||l.current===0){c();return}const f=l.current;let m=!1;if(o.current.kind==="window"){const g=window.scrollY,y=s5(),b=oo(g+f,0,y);Math.abs(b-g)>.01&&(window.scrollTo({top:b,left:window.scrollX,behavior:"auto"}),m=!0)}else{const{element:g}=o.current,y=g.scrollTop,b=Math.max(0,g.scrollHeight-g.clientHeight),w=oo(y+f,0,b);Math.abs(w-y)>.01&&(g.scrollTop=w,m=!0)}if(!m){c();return}i.current=requestAnimationFrame(d)},[r,c]),u=n.useCallback(f=>{if(o.current.kind==="window")return{topDistance:f,bottomDistance:window.innerHeight-f};const m=o.current.element.getBoundingClientRect();return{topDistance:f-m.top,bottomDistance:m.bottom-f}},[]),p=n.useCallback(f=>{const g=1-oo(f,0,s)/s;if(g<=0)return 0;const y=Math.max(1,a*.5),b=Math.max(y+1,a*2.5),w=g*g;return y+(b-y)*w},[s,a]),h=n.useCallback(f=>{if(!r)return;o.current=r5(t.current);const{topDistance:m,bottomDistance:g}=u(f),y=m<=s,b=g<=s;let w=0;if(y&&(!b||m<=g)?w=-p(m):b&&(w=p(g)),l.current=w,w===0){c();return}i.current===null&&(i.current=requestAnimationFrame(d))},[t,s,r,u,p,d,c]);return n.useEffect(()=>(r||c(),()=>c()),[r,c]),{updatePosition:h,stopScroll:c}}const i5={coarseStepMinutes:15,fineStepMinutes:5,minMinute:0,maxMinute:1439,coarseHoursPerViewport:6,fineHoursPerViewport:2,precisionActivationMode:"manual-hold",precisionHoldMs:220,precisionHoldMovementPx:14,precisionActivationWindowPx:72,precisionExitMovementPx:96,zoomTickCount:7},Zc=720,o5=320,on=t=>({...i5,...t}),l5=Object.freeze({coarseStepMinutes:15,fineStepMinutes:5,coarseHoursPerViewport:12,fineHoursPerViewport:2,precisionActivationMode:"manual-hold"}),ba=(t,s)=>{const a=on(s);return Math.max(a.minMinute,Math.min(a.maxMinute,Math.round(t)))},c5=(t,s,a)=>{const r=on(a),i=Math.max(1,s),o=Math.round(t/i)*i;return ba(o,r)},ed=(t,s,a)=>{const r=on(a),i=r.fineStepMinutes;return c5(t,i,r)},lo=(t,s)=>{const a=ba(t,s),r=Math.floor(a/60),i=a%60;return`${String(r).padStart(2,"0")}:${String(i).padStart(2,"0")}`},d5=(t,s)=>{const[a,r]=t.split(":"),i=Number(a),o=Number(r);return!Number.isFinite(i)||!Number.isFinite(o)?ba(0,s):ba(i*60+o,s)},co=(t,s=Zc)=>{const a=on(t),r=Math.max(o5,Math.round(Number.isFinite(s)?s:Zc)),i=r/Math.max(60,a.coarseHoursPerViewport*60),o=r/Math.max(60,a.fineHoursPerViewport*60);return{viewportHeight:r,coarsePixelsPerMinute:Math.max(.1,i),finePixelsPerMinute:Math.max(.1,o)}},u5=300,m5='[data-interactive="true"]',p5=8,h5=500,f5=2,td=async t=>{try{await ws.impact({style:t})}catch{}},uo=()=>{if(typeof window>"u")return 720;const t=window.visualViewport?.height??window.innerHeight;return Number.isFinite(t)?t:720},g5=t=>{if(typeof window>"u")return!1;const s=window.getComputedStyle(t),a=s.overflowY||s.overflow;return/(auto|scroll|overlay)/i.test(a)&&t.scrollHeight>t.clientHeight},x5=t=>{if(!t)return{kind:"window"};let s=t;for(;s;){if(g5(s))return{kind:"element",element:s};s=s.parentElement}return{kind:"window"}},sd=t=>t.kind==="window"?typeof window>"u"?0:Number.isFinite(window.scrollY)?window.scrollY:window.pageYOffset:t.element.scrollTop;function y5({containerRef:t,onDrop:s,snapConfig:a,activationThresholdPx:r=p5}){const i=n.useMemo(()=>on(a),[a]),o=Math.max(0,r),[l,c]=n.useState(null),[d,u]=n.useState(null),[p,h]=n.useState(null),[f,m]=n.useState(null),[g,y]=n.useState("coarse"),[b,w]=n.useState(null),x=wo(0),v=wo(0),j=n.useRef(null),T=n.useRef("09:00"),S=n.useRef(540),N=n.useRef(540),D=n.useRef(0),R=n.useRef(540),_=n.useRef(540),C=n.useRef(0),E=n.useRef(!1),O=n.useRef(co(i,uo())),M=n.useRef(null),A=n.useRef(null),L=n.useRef({}),q=n.useRef(null),$=n.useRef({kind:"window"}),B=n.useRef(0),W=n.useRef(0),H=n.useRef(null),K=n.useRef(null),{updatePosition:X,stopScroll:Y}=n5({containerRef:t,enabled:l!==null,edgeThreshold:80,scrollSpeed:8}),ee=n.useCallback(Q=>Q instanceof Element&&!!Q.closest(m5),[]),ie=n.useCallback(()=>{M.current&&(clearTimeout(M.current),M.current=null)},[]),fe=n.useCallback(()=>{A.current&&(clearTimeout(A.current),A.current=null)},[]),U=n.useCallback(()=>{const Q=L.current;Q.pointermove&&window.removeEventListener("pointermove",Q.pointermove),Q.pointerup&&window.removeEventListener("pointerup",Q.pointerup),Q.pointercancel&&window.removeEventListener("pointercancel",Q.pointercancel),Q.touchmove&&window.removeEventListener("touchmove",Q.touchmove),Q.touchend&&window.removeEventListener("touchend",Q.touchend),Q.touchcancel&&window.removeEventListener("touchcancel",Q.touchcancel),Q.scroll&&(Q.scrollContext?.kind==="element"?Q.scrollContext.element.removeEventListener("scroll",Q.scroll):window.removeEventListener("scroll",Q.scroll)),L.current={}},[]),ce=n.useCallback(()=>{y("coarse"),w(null),O.current=co(i,uo())},[i]),se=n.useCallback((Q,J)=>{const de=ba(Q,i),oe=ba(de+J,i),Fe=oe-de;N.current=de,D.current=Fe,R.current=oe;const Je=(de-S.current)*O.current.coarsePixelsPerMinute,pt=(oe-S.current)*O.current.coarsePixelsPerMinute;v.set(Je),x.set(pt),!E.current&&Math.abs(pt)>.5&&(E.current=!0);const nt=ed(oe,"fine",i);nt!==_.current&&(_.current=nt,h(lo(nt,i)))},[v,x,i]),ne=n.useCallback((Q,J)=>{if(!j.current)return;const de=Number.isFinite(Q)?Q:C.current,oe=W.current;W.current=de;const Fe=J?.source??"pointer";J?.skipAutoscrollUpdate||X(de);const Je=sd($.current)-B.current,nt=de+Je-C.current,Ct=S.current+nt/O.current.coarsePixelsPerMinute,lt=ba(Ct,i);let me=D.current;if(Fe==="pointer"&&Math.abs(oe-de)>f5&&Math.abs(me)>0){const Ae=Math.sign(de-oe),Ue=Math.sign(me);Ae!==0&&Ae===-Ue&&(me-=Ue*i.fineStepMinutes,Math.sign(me)!==Ue&&(me=0))}se(lt,me)},[se,i,X]),xe=n.useCallback(()=>{K.current!==null&&typeof window<"u"&&(window.cancelAnimationFrame(K.current),K.current=null),H.current=null},[]),G=n.useCallback(Q=>{const J=H.current;K.current!==null&&typeof window<"u"&&(window.cancelAnimationFrame(K.current),K.current=null),J!==null&&(H.current=null,ne(J,{source:"pointer",...Q}))},[ne]),ye=n.useCallback(Q=>{if(!j.current)return;const J=Number.isFinite(Q)?Q:C.current;if(H.current=J,typeof window>"u"){G();return}K.current===null&&(K.current=window.requestAnimationFrame(()=>{K.current=null;const de=H.current;de!==null&&(H.current=null,ne(de,{source:"pointer"}))}))},[G,ne]),we=n.useCallback(()=>{const Q=x5(t.current);$.current=Q,B.current=sd(Q);const J=()=>{j.current&&ne(W.current,{skipAutoscrollUpdate:!0,source:"scroll"})};L.current.scroll=J,L.current.scrollContext=Q,Q.kind==="element"?Q.element.addEventListener("scroll",J,{passive:!0}):window.addEventListener("scroll",J,{passive:!0})},[t,ne]),Te=n.useCallback(Q=>{if(j.current)return;const J=Number.isFinite(Q.startY)?Q.startY:0,de=d5(Q.scheduledTime,i),oe=lo(de,i);q.current=null,fe(),u(null),j.current=Q.taskId,T.current=oe,S.current=de,N.current=de,D.current=0,R.current=de,_.current=de,C.current=J,W.current=J,E.current=!1,O.current=co(i,uo()),c(Q.taskId),h(oe),x.set(0),v.set(0),y("coarse"),w(null),we()},[we,fe,v,x,i]),qe=n.useCallback(Q=>{if(j.current)return!0;const J=q.current;if(!J)return!1;const de=Number.isFinite(Q)?Q:J.startY;return W.current=de,Math.abs(de-J.startY)<o?!1:(Te(J),!0)},[Te,o]),Se=n.useCallback(()=>{G({skipAutoscrollUpdate:!0}),U(),q.current=null,fe(),u(null);const Q=j.current,J=ed(R.current,"fine",i),de=E.current?lo(J,i):T.current,oe=Q&&de!==T.current;Q&&oe&&(td(Ut.Medium),s(Q,de),m(Q),ie(),M.current=setTimeout(()=>{m(null)},u5)),j.current=null,c(null),h(null),x.set(0),v.set(0),xe(),Y(),$.current={kind:"window"},B.current=0,W.current=0,N.current=S.current,D.current=0,E.current=!1,ce()},[fe,ie,xe,v,x,G,s,U,ce,i,Y]),Pe=n.useCallback((Q,J,de,oe)=>{if(j.current||q.current)return;U(),xe(),fe(),u(null);const Fe=Number.isFinite(de)?de:0;q.current={taskId:Q,scheduledTime:J,startY:Fe},A.current=setTimeout(()=>{j.current||q.current?.taskId===Q&&(u(Q),td(Ut.Medium))},h5),W.current=Fe,D.current=0,E.current=!1;const Je=lt=>{qe(lt.clientY)&&ye(lt.clientY)},pt=()=>{if(j.current){Se();return}q.current=null,fe(),u(null),N.current=S.current,D.current=0,xe(),U()},nt=lt=>{const me=lt.touches[0];!me||!qe(me.clientY)||(lt.preventDefault(),ye(me.clientY))},Ct=()=>{if(j.current){Se();return}q.current=null,fe(),u(null),N.current=S.current,D.current=0,xe(),U()};L.current={},oe==="touch"?(L.current.touchmove=nt,L.current.touchend=Ct,L.current.touchcancel=Ct,window.addEventListener("touchmove",nt,{passive:!1}),window.addEventListener("touchend",Ct),window.addEventListener("touchcancel",Ct)):(L.current.pointermove=Je,L.current.pointerup=pt,L.current.pointercancel=pt,window.addEventListener("pointermove",Je),window.addEventListener("pointerup",pt),window.addEventListener("pointercancel",pt))},[fe,xe,Se,qe,ye,U]),$e=n.useCallback((Q,J,de)=>{if(Q.defaultPrevented||j.current||q.current||ee(Q.target))return;const oe=Q.touches[0];oe&&Pe(J,de,oe.clientY,"touch")},[ee,Pe]),Be=n.useCallback(Q=>{Q.stopPropagation()},[]),Me=n.useCallback(Q=>{Q.stopPropagation()},[]),Qe=n.useCallback((Q,J,de)=>{Q.defaultPrevented||j.current||q.current||ee(Q.target)||Q.pointerType==="mouse"&&Q.button!==0||Pe(J,de,Q.clientY,"pointer")},[ee,Pe]),De=n.useCallback(Q=>{if(G({skipAutoscrollUpdate:!0}),!j.current)return!1;const J=R.current,de=N.current,oe=D.current+Q*i.fineStepMinutes;return se(de,oe),R.current===J?!1:(E.current=!0,!0)},[se,G,i]),ve=n.useCallback((Q,J)=>({onPointerDownCapture:de=>Qe(de,Q,J),onPointerDown:de=>Qe(de,Q,J),onTouchStartCapture:de=>$e(de,Q,J),onTouchStart:de=>$e(de,Q,J),onTouchMove:Be,onTouchEnd:Me,onTouchCancel:Me}),[Qe,$e,Me,Be]),Z=n.useCallback((Q,J)=>({onPointerDownCapture:de=>Qe(de,Q,J),onPointerDown:de=>Qe(de,Q,J),onTouchStartCapture:de=>$e(de,Q,J),onTouchStart:de=>$e(de,Q,J),onTouchMove:Be,onTouchEnd:Me,onTouchCancel:Me}),[Qe,$e,Me,Be]);return n.useEffect(()=>()=>{U(),ie(),fe(),xe(),q.current=null,N.current=S.current,D.current=0,Y()},[ie,fe,xe,U,Y]),{draggingTaskId:l,previewTime:p,longPressTaskId:d,dragOffsetY:x,dragVisualOffsetY:x,dragEdgeOffsetY:v,justDroppedId:f,isDragging:l!==null,snapMode:g,zoomRail:b,nudgeByFineStep:De,getDragHandleProps:ve,getRowDragProps:Z}}const ad=sx,rd=ax,b5=n.forwardRef(({className:t,inset:s,children:a,...r},i)=>e.jsxs(zu,{ref:i,className:I("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[state=open]:bg-accent focus:bg-accent",s&&"pl-8",t),...r,children:[a,e.jsx(Dt,{className:"ml-auto h-4 w-4"})]}));b5.displayName=zu.displayName;const w5=n.forwardRef(({className:t,...s},a)=>e.jsx(Ku,{ref:a,className:I("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...s}));w5.displayName=Ku.displayName;const Ro=n.forwardRef(({className:t,sideOffset:s=4,...a},r)=>e.jsx(tx,{children:e.jsx(Qu,{ref:r,sideOffset:s,className:I("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...a})}));Ro.displayName=Qu.displayName;const Hs=n.forwardRef(({className:t,inset:s,...a},r)=>e.jsx(Wu,{ref:r,className:I("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",s&&"pl-8",t),...a}));Hs.displayName=Wu.displayName;const v5=n.forwardRef(({className:t,children:s,checked:a,...r},i)=>e.jsxs(Gu,{ref:i,className:I("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",t),checked:a,...r,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Yu,{children:e.jsx(Rt,{className:"h-4 w-4"})})}),s]}));v5.displayName=Gu.displayName;const _5=n.forwardRef(({className:t,children:s,...a},r)=>e.jsxs(Vu,{ref:r,className:I("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",t),...a,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(Yu,{children:e.jsx(ei,{className:"h-2 w-2 fill-current"})})}),s]}));_5.displayName=Vu.displayName;const j5=n.forwardRef(({className:t,inset:s,...a},r)=>e.jsx(Xu,{ref:r,className:I("px-2 py-1.5 text-sm font-semibold",s&&"pl-8",t),...a}));j5.displayName=Xu.displayName;const N5=n.forwardRef(({className:t,...s},a)=>e.jsx(Ju,{ref:a,className:I("-mx-1 my-1 h-px bg-muted",t),...s}));N5.displayName=Ju.displayName;const k5=["January","February","March","April","May","June","July","August","September","October","November","December"],C5=({selectedDate:t,onDateSelect:s,onMonthChange:a,tasks:r,milestones:i=[],onTaskClick:o,onMilestoneClick:l,onDateLongPress:c})=>{const[d,u]=n.useState(null),p=Or(t),h=Fr(t),f=im(p,{weekStartsOn:0}),m=om(h,{weekStartsOn:0}),g=vo({start:f,end:m}),y=new Date().getFullYear(),b=Array.from({length:8},(_,C)=>y-2+C),w=t.getMonth(),x=t.getFullYear(),v=_=>{const C=new Date(t);C.setMonth(parseInt(_)),(a||s)(C)},j=_=>{const C=new Date(t);C.setFullYear(parseInt(_)),(a||s)(C)},T=_=>{const C=setTimeout(()=>{wy("pop"),c?.(_)},500);u(C)},S=()=>{d&&(clearTimeout(d),u(null))},N=_=>{const C=ae(_,"yyyy-MM-dd");return r.filter(E=>E.task_date===C)},D=_=>{const C=ae(_,"yyyy-MM-dd");return i.filter(E=>E.target_date===C)},R=_=>{const E=N(_).filter(O=>O.scheduled_time&&O.estimated_duration);for(let O=0;O<E.length;O++)for(let M=O+1;M<E.length;M++){const A=Gr(E[O].scheduled_time,new Date("2000-01-01T00:00:00")),L=Gr(E[M].scheduled_time,new Date("2000-01-01T00:00:00"));if(!A||!L)continue;const q=new Date(A.getTime()+E[O].estimated_duration*6e4),$=new Date(L.getTime()+E[M].estimated_duration*6e4);if(A<$&&L<q)return!0}return!1};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(Qr,{value:w.toString(),onValueChange:v,children:[e.jsx(lr,{className:"w-[120px] h-9 text-xl font-bold border-0 bg-transparent hover:bg-muted/50 focus:ring-0 px-2",children:e.jsx(Wr,{})}),e.jsx(cr,{className:"bg-popover border border-border z-[110]",children:k5.map((_,C)=>e.jsx(ra,{value:C.toString(),children:_},_))})]}),e.jsxs(Qr,{value:x.toString(),onValueChange:j,children:[e.jsx(lr,{className:"w-[80px] h-9 text-xl font-bold border-0 bg-transparent hover:bg-muted/50 focus:ring-0 px-2",children:e.jsx(Wr,{})}),e.jsx(cr,{className:"bg-popover border border-border z-[110]",children:b.map(_=>e.jsx(ra,{value:_.toString(),children:_},_))})]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(z,{variant:"outline",size:"icon",onClick:()=>(a||s)(Cx(t)),children:e.jsx(Xa,{className:"h-4 w-4"})}),e.jsx(z,{variant:"outline",size:"icon",onClick:()=>(a||s)(Ja(t,1)),children:e.jsx(Dt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"border border-border",children:[e.jsx("div",{className:"grid grid-cols-7 border-b border-border bg-muted/30",children:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((_,C)=>e.jsx("div",{className:I("text-center text-sm font-medium text-muted-foreground p-2",C<6&&"border-r border-border"),children:_},_))}),e.jsx("div",{className:"grid grid-cols-7",children:g.map((_,C)=>{const E=N(_),O=D(_),M=$r(_,t),A=$r(_,new Date),L=R(_),q=(C+1)%7===0,$=C>=g.length-7,B=E.length+O.length,W=3;return e.jsxs("div",{className:I("min-h-[120px] p-2 cursor-pointer transition-colors bg-background",!q&&"border-r border-border",!$&&"border-b border-border",M&&"bg-primary/10",A&&"bg-primary/5",!Sx(_,t)&&"bg-muted/20 text-muted-foreground"),onClick:()=>s(_),onTouchStart:()=>T(_),onTouchEnd:S,onMouseDown:()=>T(_),onMouseUp:S,onMouseLeave:S,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:I("text-sm font-medium",A&&"bg-celestial-blue text-white w-6 h-6 flex items-center justify-center rounded-full ring-2 ring-celestial-blue/30"),children:ae(_,"d")}),e.jsxs("div",{className:"flex items-center gap-1",children:[O.length>0&&e.jsx(Mt,{className:"h-3 w-3 text-amber-500"}),L&&e.jsx(Ca,{className:"h-3 w-3 text-destructive"})]})]}),e.jsxs("div",{className:"space-y-0.5",children:[O.slice(0,2).map(H=>e.jsxs("div",{onClick:K=>{K.stopPropagation(),l?.(H)},className:I("text-xs p-1 border-l-2 truncate transition-all hover:bg-amber-500/10","border-l-amber-500 bg-amber-500/5",H.completed_at&&"opacity-50 line-through"),children:[e.jsx(Mt,{className:"h-2 w-2 inline mr-1 text-amber-500"}),H.title]},H.id)),E.slice(0,Math.max(0,W-O.length)).map(H=>e.jsxs("div",{onClick:K=>{K.stopPropagation(),o(H)},className:I("text-xs p-1 border-l-2 truncate transition-all hover:bg-muted/50",H.completed&&"opacity-50 line-through",H.is_main_quest&&"border-l-amber-500 bg-amber-500/5",!H.is_main_quest&&H.difficulty==="easy"&&"border-l-emerald-500 bg-emerald-500/5",!H.is_main_quest&&H.difficulty==="medium"&&"border-l-amber-500 bg-amber-500/5",!H.is_main_quest&&H.difficulty==="hard"&&"border-l-rose-500 bg-rose-500/5"),children:[H.scheduled_time&&e.jsx(Ht,{className:"h-2 w-2 inline mr-1"}),H.task_text]},H.id)),B>W&&e.jsxs(Oe,{variant:"secondary",className:"text-[10px] py-0",children:["+",B-W," more"]})]})]},_.toString())})})]})]})},S5=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],nd=t=>{if(!t)return null;const s=new Date(t);return Number.isNaN(s.getTime())?null:s};function E5({selectedDate:t,onMonthSelect:s,onBack:a,onClose:r,onYearChange:i,tasks:o,milestones:l=[]}){const[c,d]=n.useState(!1),u=t.getFullYear(),p=new Date,h=new Date().getFullYear(),f=Array.from({length:16},(v,j)=>h-5+j),m=()=>{i(u-1)},g=()=>{i(u+1)},y=v=>{i(v),d(!1)},b=v=>{const j=Gs(En(new Date,u),v);s(j)},w=v=>{const j=Or(Gs(En(new Date,u),v)),T=Fr(j),S=vo({start:j,end:T});return o.filter(N=>{const D=nd(N.task_date);return D?S.some(R=>ae(R,"yyyy-MM-dd")===ae(D,"yyyy-MM-dd")):!1})},x=v=>{const j=Or(Gs(En(new Date,u),v)),T=Fr(j),S=vo({start:j,end:T});return l.filter(N=>{const D=nd(N.target_date);return D?S.some(R=>ae(R,"yyyy-MM-dd")===ae(D,"yyyy-MM-dd")):!1})};return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-border/30",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(z,{variant:"ghost",size:"icon",onClick:m,className:"h-8 w-8",children:e.jsx(Xa,{className:"h-5 w-5"})}),e.jsxs(qs,{open:c,onOpenChange:d,children:[e.jsx(Ls,{asChild:!0,children:e.jsx("button",{className:"text-2xl font-bold text-primary hover:opacity-80 transition-opacity",children:u})}),e.jsx(js,{className:"w-32 p-0 bg-background border border-border z-[70] pointer-events-auto",align:"start",onOpenAutoFocus:v=>v.preventDefault(),onPointerDownOutside:v=>v.preventDefault(),children:e.jsx("div",{className:"h-64 overflow-y-auto overscroll-contain p-2",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},onTouchMove:v=>v.stopPropagation(),onTouchStart:v=>v.stopPropagation(),children:e.jsx("div",{className:"space-y-1",children:f.map(v=>e.jsx("button",{onClick:j=>{j.stopPropagation(),y(v)},className:I("w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors",v===u?"bg-primary text-primary-foreground":"hover:bg-muted"),children:v},v))})})})]}),e.jsx(z,{variant:"ghost",size:"icon",onClick:g,className:"h-8 w-8",children:e.jsx(Dt,{className:"h-5 w-5"})})]}),e.jsx(z,{variant:"ghost",size:"icon",onClick:r,className:"h-9 w-9 rounded-full bg-muted",children:e.jsx(kt,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"p-4 overflow-y-auto flex-1",children:e.jsx("div",{className:"grid grid-cols-3 gap-3",children:S5.map((v,j)=>{const T=w(j),S=x(j),N=p.getMonth()===j&&p.getFullYear()===u,D=t.getMonth()===j&&t.getFullYear()===u,R=T.filter(E=>!E.completed).length,_=T.filter(E=>E.completed).length,C=S.length>0;return e.jsxs("button",{onClick:()=>b(j),className:I("flex flex-col items-center justify-center py-4 px-2 rounded-xl transition-all min-h-[80px]",D?"bg-coral-500 text-white":N?"bg-coral-500/15 text-coral-500":"text-foreground hover:bg-muted/50"),children:[e.jsx("span",{className:I("text-base font-semibold",D&&"text-white"),children:v}),e.jsxs("div",{className:"flex items-center justify-center gap-1 mt-2 min-h-[8px]",children:[C&&e.jsx("div",{className:I("w-2 h-2 rounded-full",D?"bg-white/70":"bg-amber-500")}),R>0&&e.jsx("div",{className:I("w-2 h-2 rounded-full",D?"bg-white/70":"bg-coral-500")}),_>0&&e.jsx("div",{className:I("w-2 h-2 rounded-full",D?"bg-white/50":"bg-celestial-blue")})]})]},v)})})})]})}const id=t=>{if(!t)return null;const s=new Date(`${t}T00:00:00`);return Number.isNaN(s.getTime())?null:s},T5=(t,s,a="")=>{try{return Number.isNaN(t.getTime())?a:ae(t,s)}catch{return a}};function M5({open:t,onOpenChange:s,selectedDate:a,onDateSelect:r,tasks:i,milestones:o=[],onTimeSlotLongPress:l}){const[c,d]=n.useState(!1),u=y=>{r(y),s(!1)},p=y=>{r(y)},h=y=>{const b=id(y.task_date);b&&(r(b),s(!1))},f=y=>{const b=id(y.target_date);b&&(r(b),s(!1))},m=y=>{r(En(a,y))},g=y=>{r(y),d(!1)};return e.jsx(as,{open:t,onOpenChange:s,children:e.jsxs(Qt,{className:"max-w-2xl w-full h-[90vh] p-0 gap-0 flex flex-col bg-background",hideCloseButton:!0,children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border shrink-0",children:[e.jsx(ps,{className:"text-lg font-semibold",children:T5(a,"MMMM yyyy","Calendar")}),e.jsx(z,{variant:"ghost",size:"icon",onClick:()=>s(!1),className:"h-8 w-8",children:e.jsx(kt,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"px-4 py-2 text-sm text-muted-foreground border-b border-border/50 shrink-0",children:"Tap any date to view daily schedule"}),e.jsx("div",{className:"flex-1 overflow-y-auto px-4 py-3",children:c?e.jsx(E5,{selectedDate:a,onMonthSelect:g,onBack:()=>d(!1),onClose:()=>s(!1),onYearChange:m,tasks:i,milestones:o}):e.jsx(C5,{selectedDate:a,onDateSelect:u,onMonthChange:p,tasks:i,milestones:o,onTaskClick:h,onMilestoneClick:f,onDateLongPress:y=>l?.(y,"09:00")})})]})})}function D5({rail:t,className:s}){return null}function A5({text:t,className:s,speed:a=30,pauseDuration:r=2e3,initialDelay:i=3e3}){const o=n.useRef(null),l=n.useRef(null),[c,d]=n.useState(!1),[u,p]=n.useState(0);n.useEffect(()=>{const b=()=>{if(o.current&&l.current){const v=o.current.offsetWidth,j=l.current.scrollWidth,T=j>v;d(T),T&&p(j-v+20)}},w=setTimeout(b,100),x=new ResizeObserver(b);return o.current&&x.observe(o.current),()=>{clearTimeout(w),x.disconnect()}},[t]);const h=u/a,f=i/1e3+h+r*2/1e3,m=i/1e3/f,g=h/2/f,y=r/1e3/f;return e.jsx("div",{ref:o,className:I("overflow-hidden",s),children:e.jsx(P.span,{ref:l,className:"whitespace-nowrap inline-block",animate:c?{x:[0,0,-u,-u,0,0]}:{x:0},transition:c?{duration:f,times:[0,m,m+g,m+g+y,m+g*2+y,1],repeat:1/0,ease:"linear"}:{duration:0},children:t})})}const wl=t=>{const{user:s}=_e(),a=Ie(),{data:r,isLoading:i,error:o}=Ee({queryKey:["journey-path",t],queryFn:async()=>{if(!t||!s?.id)return null;const{data:u,error:p}=await k.from("epic_journey_paths").select("*").eq("epic_id",t).order("milestone_index",{ascending:!1}).limit(1).maybeSingle();if(p)throw console.error("Error fetching journey path:",p),p;return u},enabled:!!t&&!!s?.id,staleTime:600*1e3}),l=he({mutationFn:async({milestoneIndex:u})=>{if(!t||!s?.id)throw new Error("Missing epic or user");const{data:p,error:h}=await k.functions.invoke("generate-journey-path",{body:{epicId:t,milestoneIndex:u,userId:s.id}});if(h)throw h;if(p?.error)throw new Error(p.error);return p},onSuccess:()=>{a.invalidateQueries({queryKey:["journey-path",t]})},onError:u=>{console.error("Failed to generate journey path:",u)}}),c=n.useCallback(()=>{!t||!s?.id||!r&&!i&&l.mutate({milestoneIndex:0})},[t,s?.id,r,i,l]),d=n.useCallback(u=>{!t||!s?.id||l.mutate({milestoneIndex:u})},[t,s?.id,l]);return{pathImageUrl:r?.image_url||null,currentMilestoneIndex:r?.milestone_index??-1,isLoading:i,isGenerating:l.isPending,error:o,generateInitialPath:c,regeneratePathForMilestone:d}},od=[70,40,60,25,75,35,55,45],P5=t=>{const s=[];for(let a=0;a<t;a++){const r=t===1?.5:a/(t-1),i=8+r*84,o=od[a%od.length],l=Math.sin(r*Math.PI*2)*8,c=o+l,d=a===0||a===t-1?10:6+Math.random()*4;s.push({x:i,y:c,size:d})}return s},Io=(t,s)=>{if(s.length<2)return{x:10,y:50};const a=Math.max(0,Math.min(100,t))/100,r=s.length-1,i=a*r,o=Math.min(Math.floor(i),r-1),l=i-o,c=s[o],d=s[o+1],u=(c.x+d.x)/2,p=(c.y+d.y)/2+(o%2===0?-10:10),h=1-l,f=h*h*c.x+2*h*l*u+l*l*d.x,m=h*h*c.y+2*h*l*p+l*l*d.y;return{x:f,y:m}},ld=t=>{if(t.length<2)return"";let s=`M ${t[0].x} ${t[0].y}`;for(let a=1;a<t.length;a++){const r=t[a-1],i=t[a],o=(r.x+i.x)/2,l=(r.y+i.y)/2+(a%2===0?-12:12);if(a===Math.max(1,Math.floor(t.length*.4))){const c=o,d=(r.y+i.y)/2;s+=` Q ${o-5} ${l} ${c-4} ${d}`,s+=` C ${c-8} ${d-12} ${c+8} ${d-12} ${c+4} ${d}`,s+=` Q ${o+5} ${l} ${i.x} ${i.y}`}else s+=` Q ${o} ${l} ${i.x} ${i.y}`}return s},R5=(t,s)=>{if(t.length<2||s<=0)return"";const a=Io(s,t),r=Math.max(0,Math.min(100,s))/100,i=t.length-1,o=r*i,l=Math.floor(o);let c=`M ${t[0].x} ${t[0].y}`;for(let d=1;d<=l&&d<t.length;d++){const u=t[d-1],p=t[d],h=(u.x+p.x)/2,f=(u.y+p.y)/2+(d%2===0?-12:12);if(d===Math.max(1,Math.floor(t.length*.4))){const m=h,g=(u.y+p.y)/2;c+=` Q ${h-5} ${f} ${m-4} ${g}`,c+=` C ${m-8} ${g-12} ${m+8} ${g-12} ${m+4} ${g}`,c+=` Q ${h+5} ${f} ${p.x} ${p.y}`}else c+=` Q ${h} ${f} ${p.x} ${p.y}`}return l<i&&(c+=` L ${a.x} ${a.y}`),c},I5=({milestone:t,currentProgress:s,isPostcard:a})=>{const[r,i]=n.useState(!1),o=t.milestone_percent-s,l=Math.min(100,Math.max(0,s/t.milestone_percent*100));n.useEffect(()=>(r&&(document.body.style.overflow="hidden"),()=>{document.body.style.overflow=""}),[r]);const c=async()=>{try{await ws.impact({style:Ut.Medium})}catch{}i(!0)},d=()=>a?`A cosmic postcard is forming in the starlight... ${t.chapter_number?`Chapter ${t.chapter_number}`:"A new chapter"} of your companion's tale awaits.`:"A new milestone on your journey awaits... Keep going to discover what lies ahead.";return e.jsxs(qs,{open:r,onOpenChange:i,children:[e.jsx(Ls,{asChild:!0,children:e.jsx("button",{onClick:c,className:I("w-11 h-11 -m-4 flex items-center justify-center","cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 rounded-full","group transition-all duration-200","active:scale-90 active:bg-white/5"),"aria-label":`Unlock milestone at ${t.milestone_percent}%`,children:e.jsx(P.div,{className:I("w-4 h-4 rounded-full flex items-center justify-center",a?"text-amber-400/70":"text-purple-400/70","group-hover:scale-125 transition-transform"),animate:{opacity:[.5,1,.5],scale:[1,1.1,1]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx(wu,{className:"w-3.5 h-3.5"})})})}),e.jsx(js,{className:I("w-64 p-0 border overflow-hidden shadow-xl","supports-[backdrop-filter]:backdrop-blur-xl",a?"bg-gradient-to-br from-amber-950/98 via-yellow-950/95 to-slate-950/98 border-amber-500/20":"bg-gradient-to-br from-purple-950/98 via-slate-950/95 to-slate-950/98 border-purple-500/20"),sideOffset:12,collisionPadding:{top:50,bottom:50,left:16,right:16},children:e.jsxs(P.div,{initial:{opacity:0,scale:.95,y:-5},animate:{opacity:1,scale:1,y:0},transition:{type:"spring",stiffness:300,damping:25},children:[e.jsx(Re,{children:r&&e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx(P.div,{className:I("absolute top-3 right-4",a?"text-amber-400/40":"text-purple-400/40"),initial:{opacity:0,scale:0},animate:{opacity:1,scale:1,rotate:360},exit:{opacity:0,scale:0},transition:{opacity:{duration:.3},rotate:{duration:4,repeat:1/0,ease:"linear"}},children:e.jsx(be,{className:"w-4 h-4"})}),e.jsx(P.div,{className:I("absolute bottom-6 left-3",a?"text-amber-400/25":"text-purple-400/25"),initial:{opacity:0,scale:0},animate:{opacity:1,scale:[1,1.3,1],rotate:-360},exit:{opacity:0,scale:0},transition:{opacity:{duration:.3,delay:.1},scale:{duration:3,repeat:1/0},rotate:{duration:5,repeat:1/0,ease:"linear"}},children:e.jsx(Mt,{className:"w-3 h-3"})}),e.jsx(P.div,{className:I("absolute top-1/2 right-6 w-1.5 h-1.5 rounded-full",a?"bg-amber-400/30":"bg-purple-400/30"),initial:{opacity:0},animate:{opacity:[0,1,0],y:[0,-10,0]},exit:{opacity:0},transition:{duration:2,repeat:1/0,delay:.5}})]})}),e.jsxs("div",{className:"p-4 relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(P.div,{className:I("w-8 h-8 rounded-full flex items-center justify-center",a?"bg-amber-500/20 text-amber-400 shadow-[0_0_12px_rgba(251,191,36,0.3)]":"bg-purple-500/20 text-purple-400 shadow-[0_0_12px_rgba(168,85,247,0.3)]"),animate:{boxShadow:a?["0 0 12px rgba(251,191,36,0.3)","0 0 20px rgba(251,191,36,0.5)","0 0 12px rgba(251,191,36,0.3)"]:["0 0 12px rgba(168,85,247,0.3)","0 0 20px rgba(168,85,247,0.5)","0 0 12px rgba(168,85,247,0.3)"]},transition:{duration:2,repeat:1/0},children:e.jsx(Yn,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-white leading-tight",children:"Mystery Awaits..."}),e.jsx("p",{className:I("text-xs leading-tight",a?"text-amber-400/80":"text-purple-400/80"),children:a?"Postcard Milestone":"Journey Milestone"})]})]}),e.jsx("div",{className:I("h-px w-full mb-3",a?"bg-amber-400/20":"bg-purple-400/20")}),e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsxs("div",{className:"relative w-12 h-12 flex-shrink-0",children:[e.jsxs("svg",{className:"w-12 h-12 -rotate-90",viewBox:"0 0 36 36",children:[e.jsx("circle",{cx:"18",cy:"18",r:"14",fill:"none",stroke:"currentColor",strokeWidth:"2.5",className:"text-white/10"}),e.jsx(P.circle,{cx:"18",cy:"18",r:"14",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",className:a?"text-amber-400":"text-purple-400",initial:{strokeDasharray:"0 100"},animate:{strokeDasharray:`${l*.88} 100`},transition:{duration:.8,ease:"easeOut"}})]}),e.jsxs("span",{className:I("absolute inset-0 flex items-center justify-center text-xs font-bold",a?"text-amber-400":"text-purple-400"),children:[Math.round(l),"%"]})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-white/60 leading-snug",children:"Unlock at"}),e.jsxs("p",{className:I("text-lg font-bold leading-tight",a?"text-amber-400":"text-purple-400"),children:[t.milestone_percent,"%"]}),e.jsx("p",{className:"text-xs text-white/50 leading-snug",children:o>0?`${Math.round(o)}% to go`:"Almost there!"})]})]}),e.jsxs("p",{className:"text-xs text-white/75 leading-relaxed italic mb-3",children:['"',d(),'"']}),(t.phase_name||t.target_date)&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.phase_name&&e.jsx("span",{className:I("px-2 py-1 rounded-md text-[11px] font-medium",a?"bg-amber-400/10 text-amber-400/70":"bg-purple-400/10 text-purple-400/70"),children:t.phase_name}),t.target_date&&e.jsxs("span",{className:I("px-2 py-1 rounded-md text-[11px] font-medium",a?"bg-amber-400/10 text-amber-400/70":"bg-purple-400/10 text-purple-400/70"),children:["Est. ",ae(new Date(t.target_date),"MMM d")]})]})]})]})})]})},q5=({isRevealing:t,isPostcard:s,onComplete:a})=>(n.useEffect(()=>{if(t){(async()=>{try{await ws.notification({type:rx.Success})}catch{}})();const i=setTimeout(a,2e3);return()=>clearTimeout(i)}},[t,a]),e.jsx(Re,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(P.div,{className:I("absolute inset-0 rounded-full border-2",s?"border-amber-400":"border-purple-400"),initial:{scale:.5,opacity:1},animate:{scale:4,opacity:0},exit:{opacity:0},transition:{duration:.8,ease:"easeOut"},style:{width:20,height:20,marginLeft:-10,marginTop:-10}}),e.jsx(P.div,{className:I("absolute inset-0 rounded-full border",s?"border-amber-400/50":"border-purple-400/50"),initial:{scale:.5,opacity:1},animate:{scale:5,opacity:0},exit:{opacity:0},transition:{duration:1,ease:"easeOut",delay:.1},style:{width:20,height:20,marginLeft:-10,marginTop:-10}}),e.jsx(P.div,{className:I("absolute rounded-full",s?"bg-amber-400":"bg-purple-400"),initial:{scale:0,opacity:.8},animate:{scale:[0,2.5,0],opacity:[.8,.4,0]},exit:{opacity:0},transition:{duration:.6,ease:"easeOut"},style:{width:24,height:24,marginLeft:-12,marginTop:-12,filter:"blur(6px)"}}),Array.from({length:8}).map((r,i)=>{const o=i/8*Math.PI*2,l=30+Math.random()*20;return e.jsx(P.div,{className:I("absolute w-1.5 h-1.5 rounded-full",s?"bg-amber-400":"bg-purple-400"),initial:{x:0,y:0,scale:1,opacity:1},animate:{x:Math.cos(o)*l,y:Math.sin(o)*l,scale:0,opacity:0},exit:{opacity:0},transition:{duration:.6+Math.random()*.3,ease:"easeOut",delay:Math.random()*.1},style:{marginLeft:-3,marginTop:-3}},`particle-${i}`)}),e.jsx(P.div,{className:I("absolute",s?"text-amber-400":"text-purple-400"),initial:{scale:0,rotate:0,opacity:1},animate:{scale:[0,1.5,0],rotate:180,opacity:[1,1,0]},exit:{opacity:0},transition:{duration:.8,ease:"easeOut"},style:{marginLeft:-8,marginTop:-30},children:e.jsx(be,{className:"w-4 h-4"})}),e.jsx(P.div,{className:I("absolute",s?"text-yellow-300":"text-purple-300"),initial:{scale:0,rotate:0,opacity:1},animate:{scale:[0,1.2,0],rotate:-90,opacity:[1,1,0]},exit:{opacity:0},transition:{duration:.7,ease:"easeOut",delay:.1},style:{marginLeft:15,marginTop:-20},children:e.jsx(Mt,{className:"w-3 h-3"})}),e.jsx(P.div,{className:I("absolute",s?"text-amber-300":"text-purple-300"),initial:{scale:0,y:0,opacity:1},animate:{scale:[0,1,0],y:-25,opacity:[1,1,0]},exit:{opacity:0},transition:{duration:.6,ease:"easeOut",delay:.15},style:{marginLeft:-20,marginTop:-15},children:e.jsx(bt,{className:"w-3 h-3"})})]})})),L5=({milestone:t,pos:s,index:a,progress:r,sortedMilestones:i})=>{const o=t.milestone_percent,l=r>=o||!!t.completed_at,c=a<i.length-1?i[a+1].milestone_percent:101,d=r>=o&&r<c,u=t.is_postcard_milestone,p=o===100||a===i.length-1,h=a===0,f=u?s.size*1.3:s.size,m=n.useRef(l),[g,y]=n.useState(!1);n.useEffect(()=>{l&&!m.current&&!h&&y(!0),m.current=l},[l,h]);const b=()=>{y(!1)};return e.jsxs(P.div,{className:"absolute transform -translate-x-1/2 -translate-y-1/2",style:{left:`${s.x}%`,top:`${s.y}%`},initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{delay:a*.1,duration:.5},children:[e.jsx(q5,{isRevealing:g,isPostcard:!!u,onComplete:b}),e.jsx(Re,{children:l&&e.jsx(P.div,{className:I("absolute inset-0 rounded-full",u?d?"bg-yellow-400":"bg-yellow-400/50":d?"bg-primary":"bg-primary/50"),style:{width:f*3,height:f*3,marginLeft:-f,marginTop:-f,filter:"blur(8px)"},initial:g?{scale:0,opacity:0}:{scale:1,opacity:.5},animate:d?{scale:[1,1.3,1],opacity:[.5,.8,.5]}:{scale:1,opacity:.5},exit:{scale:0,opacity:0},transition:g?{scale:{duration:.5,ease:"easeOut"},opacity:{duration:.5,ease:"easeOut"}}:{duration:2,repeat:d?1/0:0,ease:"easeInOut"}})}),e.jsx(P.div,{className:I("rounded-full relative z-10",l?u?"bg-gradient-to-br from-yellow-400 via-amber-300 to-yellow-500 shadow-[0_0_10px_rgba(250,204,21,0.5)]":"bg-gradient-to-br from-primary via-purple-400 to-primary shadow-[0_0_10px_rgba(167,108,255,0.5)]":"bg-muted/30 border border-muted/50"),style:{width:f,height:f},animate:g?{scale:[.5,1.4,1],rotate:[0,180,360]}:d?{boxShadow:u?["0 0 10px rgba(250,204,21,0.5)","0 0 20px rgba(250,204,21,0.8)","0 0 10px rgba(250,204,21,0.5)"]:["0 0 10px rgba(167,108,255,0.5)","0 0 20px rgba(167,108,255,0.8)","0 0 10px rgba(167,108,255,0.5)"]}:{},transition:g?{duration:.6,ease:"easeOut"}:{duration:1.5,repeat:1/0,ease:"easeInOut"}}),e.jsx("div",{className:I("absolute top-full mt-1 left-1/2 -translate-x-1/2 text-[10px] font-medium whitespace-nowrap flex items-center gap-0.5 max-w-[60px] overflow-hidden",l?u?"text-yellow-400":"text-primary":"text-muted-foreground/50",p&&l&&"text-yellow-400"),children:e.jsx(Re,{mode:"wait",children:h?e.jsx(P.span,{className:"font-semibold",initial:{opacity:1},animate:{opacity:1},children:"Start"},"start"):l?u?e.jsx(P.div,{initial:{opacity:0,scale:0,rotate:-180},animate:{opacity:1,scale:1,rotate:0},transition:{type:"spring",stiffness:300,damping:20,delay:g?.3:0},children:e.jsx(Jr,{className:"w-3 h-3"})},"postcard"):e.jsx(P.span,{className:"truncate",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{type:"spring",stiffness:300,damping:20,delay:g?.3:0},children:t.title.slice(0,8)},"title"):e.jsx(P.div,{initial:{opacity:1},exit:{opacity:0,scale:0,rotate:180},transition:{duration:.3},children:e.jsx(I5,{milestone:t,currentProgress:r,isPostcard:!!u})},"mystery")})})]})},O5=t=>{switch(t){case"sick":return"saturate-50 brightness-75";case"sad":return"saturate-75 brightness-90";case"worried":return"saturate-90";default:return""}},F5=n.memo(function({progress:s,targetDays:a,className:r,companionImageUrl:i,companionMood:o,showCompanion:l=!0,milestones:c,epicId:d,transparentBackground:u=!1}){const{pathImageUrl:p,isGenerating:h}=wl(d),f=n.useMemo(()=>!c||c.length===0?[{id:"start",title:"Start",milestone_percent:0,is_postcard_milestone:!1,completed_at:null},{id:"end",title:"Finish",milestone_percent:100,is_postcard_milestone:!0,completed_at:null}]:[{id:"start",title:"Start",milestone_percent:0,is_postcard_milestone:!1,completed_at:new Date().toISOString()},...c].sort((x,v)=>x.milestone_percent-v.milestone_percent),[c]),m=n.useMemo(()=>P5(f.length),[f.length]),g=n.useMemo(()=>{const w=x=>{const v=Math.sin(x*9999)*1e4;return v-Math.floor(v)};return Array.from({length:20},(x,v)=>({x:w(v*1)*100,y:w(v*2+.5)*100,size:1+w(v*3+.7)*2,delay:w(v*4+.3)*3,duration:2+w(v*5+.9)*2}))},[]),b=(w=>{const x=Math.max(0,Math.min(100,w)),v=Math.round(x/100*120);return{border:`hsl(${v}, 70%, 50%)`,glowStrong:`hsla(${v}, 80%, 60%, 0.4)`,glowMedium:`hsla(${v}, 80%, 60%, 0.3)`,glowSoft:`hsla(${v}, 70%, 40%, 0.2)`,glowInner:`hsla(${v}, 80%, 60%, 0.1)`}})(s);return e.jsxs("div",{className:I("relative w-full h-56 rounded-xl overflow-hidden",!u&&!p&&"bg-gradient-to-br from-slate-950 via-purple-950/50 to-slate-950",r),style:u?void 0:{boxShadow:`
          0 0 10px ${b.glowStrong},
          0 0 20px ${b.glowMedium},
          0 0 40px ${b.glowSoft},
          inset 0 0 15px ${b.glowInner}
        `},children:[p&&e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("img",{src:p,alt:"Journey path",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-slate-950/90 via-slate-950/50 to-slate-950/70"})]}),h&&!p&&e.jsxs("div",{className:"absolute inset-0 bg-gradient-to-br from-slate-950 via-purple-950/50 to-slate-950",children:[e.jsx(P.div,{className:"absolute inset-0 bg-gradient-to-r from-transparent via-primary/10 to-transparent",animate:{x:["-100%","100%"]},transition:{duration:2,repeat:1/0,ease:"linear"}}),e.jsxs("div",{className:"absolute bottom-2 left-2 text-xs text-primary/60 flex items-center gap-1",children:[e.jsx(be,{className:"w-3 h-3 animate-pulse"}),e.jsx("span",{children:"Mapping your path..."})]})]}),!p&&!u&&e.jsxs("div",{className:"absolute inset-0 opacity-40",children:[e.jsx("div",{className:"absolute top-1/2 left-1/3 w-24 h-24 bg-primary/30 rounded-full blur-xl"}),e.jsx("div",{className:"absolute top-1/3 right-1/4 w-16 h-16 bg-purple-500/20 rounded-full blur-lg"})]}),g.map((w,x)=>e.jsx(P.div,{className:"absolute rounded-full bg-white/60",style:{left:`${w.x}%`,top:`${w.y}%`,width:w.size,height:w.size},animate:{opacity:[.2,.8,.2],scale:[1,1.2,1]},transition:{duration:w.duration,delay:w.delay,repeat:1/0,ease:"easeInOut"}},`bg-${x}`)),e.jsxs("svg",{className:"absolute inset-0 w-full h-full",viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"pulseGradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"hsl(var(--primary) / 0.15)"}),e.jsx("stop",{offset:"40%",stopColor:"hsl(var(--primary) / 0.15)"}),e.jsx("stop",{offset:"50%",stopColor:"hsl(var(--primary) / 0.8)"}),e.jsx("stop",{offset:"60%",stopColor:"hsl(var(--primary) / 0.15)"}),e.jsx("stop",{offset:"100%",stopColor:"hsl(var(--primary) / 0.15)"}),e.jsx("animate",{attributeName:"x1",values:"-100%;100%",dur:"2.5s",repeatCount:"indefinite"}),e.jsx("animate",{attributeName:"x2",values:"0%;200%",dur:"2.5s",repeatCount:"indefinite"})]}),e.jsxs("filter",{id:"trailGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"1",result:"blur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"blur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("path",{d:ld(m),fill:"none",stroke:"hsl(var(--muted) / 0.15)",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:ld(m),fill:"none",stroke:"url(#pulseGradient)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",opacity:"0.7"}),s>0&&e.jsx(P.path,{d:R5(m,s),fill:"none",stroke:"hsl(var(--primary))",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",filter:"url(#trailGlow)",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:1.5,ease:"easeOut"}})]}),m.map((w,x)=>e.jsx(L5,{milestone:f[x],pos:w,index:x,progress:s,sortedMilestones:f},`star-${f[x].id}`)),l&&i&&e.jsxs(P.div,{className:"absolute transform -translate-x-1/2 -translate-y-1/2 z-20",style:{left:`${Io(s,m).x}%`,top:`${Io(s,m).y}%`},initial:{scale:0,opacity:0},animate:{scale:1,opacity:1,y:[0,-4,0]},transition:{scale:{duration:.5},opacity:{duration:.5},y:{duration:2,repeat:1/0,ease:"easeInOut"}},children:[e.jsx(P.div,{className:"absolute inset-0 rounded-full bg-primary/40",style:{width:36,height:36,marginLeft:-4,marginTop:-4,filter:"blur(6px)"},animate:{scale:[1,1.2,1],opacity:[.4,.7,.4]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx("div",{className:I("w-7 h-7 rounded-full border-2 border-primary overflow-hidden bg-background shadow-lg",O5(o)),children:e.jsx("img",{src:i,alt:"Companion",className:"w-full h-full object-cover"})})]}),e.jsxs("div",{className:"absolute bottom-2 right-3 flex items-center gap-1.5",children:[e.jsxs("div",{className:"text-xs font-bold text-primary",children:[s,"%"]}),e.jsx("div",{className:"w-8 h-1 bg-muted/20 rounded-full overflow-hidden",children:e.jsx(P.div,{className:"h-full bg-gradient-to-r from-primary to-purple-400",initial:{width:0},animate:{width:`${s}%`},transition:{duration:1}})})]}),e.jsx("div",{className:"absolute top-2 left-3 text-[10px] uppercase tracking-wider text-muted-foreground/60 font-medium",children:"Star Path Journey"})]})}),vi=t=>{const{user:s}=_e(),a=Ie(),{data:r=[],isLoading:i,error:o}=Ee({queryKey:["milestones",t],queryFn:async()=>{if(!s||!t)return[];const{data:S,error:N}=await k.from("epic_milestones").select("*").eq("epic_id",t).eq("user_id",s.id).order("phase_order",{ascending:!0,nullsFirst:!0}).order("milestone_percent",{ascending:!0});if(N)throw N;return S},enabled:!!s&&!!t,staleTime:180*1e3}),l=n.useMemo(()=>r.reduce((N,D)=>{const R=D.phase_name||"General",_=D.phase_order??0,C=N.find(E=>E.phaseName===R);return C?C.milestones.push(D):N.push({phaseName:R,phaseOrder:_,milestones:[D]}),N},[]).sort((N,D)=>N.phaseOrder-D.phaseOrder),[r]),c=r.filter(S=>S.completed_at).length,d=r.length,u=r.find(S=>!S.completed_at),p=r.filter(S=>S.is_postcard_milestone),h=n.useCallback(()=>{for(const S of l)if(S.milestones.filter(D=>!D.completed_at).length>0)return S.phaseName;return l[l.length-1]?.phaseName||null},[l]),f=n.useCallback(()=>{const S=new Date;S.setHours(0,0,0,0);const N=h();return l.map(D=>{const R=D.milestones.filter(q=>q.completed_at).length,_=D.milestones.length,C=_>0?R/_*100:0,E=D.milestones.filter(q=>q.target_date).map(q=>new Date(q.target_date)).sort((q,$)=>q.getTime()-$.getTime()),O=E[0]||null,M=E[E.length-1]||null,A=D.milestones.filter(q=>q.completed_at||!q.target_date?!1:new Date(q.target_date)<S),L=M?Ft(M,S):null;return{phaseName:D.phaseName,phaseOrder:D.phaseOrder,completed:R,total:_,progress:C,isComplete:C===100,isCurrent:D.phaseName===N,isOnTrack:A.length===0,overdueMilestones:A.length,daysUntilEnd:L,startDate:O,endDate:M}})},[l,h]),m=n.useCallback(()=>f().find(D=>D.isCurrent)?.progress??0,[f]),g=n.useCallback((S,N)=>{if(!S||!N||d===0)return null;const D=new Date,R=new Date(S),_=new Date(N),C=Ft(_,R),E=Ft(D,R);if(C<=0)return null;const O=d>0?c/d*100:0,M=Math.min(100,E/C*100),A=O-M,L=E>0?O/E:0;let q=null;if(L>0){const Y=(100-O)/L;q=new Date,q.setDate(q.getDate()+Y)}const $=L>0&&q?Ft(_,q):0;let B;A>=10?B="A":A>=0?B="B":A>=-10?B="C":A>=-25?B="D":B="F";const H=f().find(X=>X.isCurrent);let K="on_track";return H&&H.overdueMilestones>0&&(K=H.overdueMilestones>1?"behind":"at_risk"),{score:B,overallProgress:O,expectedProgress:M,progressDelta:A,velocity:L,estimatedCompletionDate:q,daysAheadOrBehind:$,currentPhaseHealth:K}},[c,d,f]),y=n.useCallback(S=>{if(S.completed_at||!S.target_date)return!1;const N=new Date(S.target_date),D=new Date;return D.setHours(0,0,0,0),N.setHours(0,0,0,0),N<D},[]),b=n.useCallback(S=>{if(!S.target_date)return null;const N=new Date(S.target_date),D=new Date;D.setHours(0,0,0,0),N.setHours(0,0,0,0);const R=N.getTime()-D.getTime();return Math.ceil(R/(1e3*60*60*24))},[]),w=n.useCallback(()=>r.find(S=>S.is_postcard_milestone&&!S.completed_at),[r]),x=n.useCallback(()=>{const S=w();if(!S)return null;const N=d>0?c/d*100:0,D=S.milestone_percent;return{current:N,target:D,remaining:Math.max(0,D-N),milestone:S}},[w,c,d]),v=he({mutationFn:async({milestoneId:S,epicId:N,onPostcardTrigger:D})=>{if(!s)throw new Error("Not authenticated");const R=r.find(C=>C.id===S);if(!R)throw new Error("Milestone not found");const{error:_}=await k.from("epic_milestones").update({completed_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",S).eq("user_id",s.id);if(_)throw _;return{milestone:R,onPostcardTrigger:D}},onSuccess:({milestone:S,onPostcardTrigger:N})=>{a.invalidateQueries({queryKey:["milestones",t]}),a.invalidateQueries({queryKey:["epics"]}),V.success(`Milestone completed: ${S.title}`),S.is_postcard_milestone&&N&&N(S)},onError:S=>{console.error("Failed to complete milestone:",S),V.error("Failed to complete milestone")}}),j=he({mutationFn:async S=>{if(!s)throw new Error("Not authenticated");const{error:N}=await k.from("epic_milestones").update({completed_at:null,updated_at:new Date().toISOString()}).eq("id",S).eq("user_id",s.id);if(N)throw N},onSuccess:()=>{a.invalidateQueries({queryKey:["milestones",t]}),a.invalidateQueries({queryKey:["epics"]}),V.success("Milestone unmarked")},onError:S=>{console.error("Failed to uncomplete milestone:",S),V.error("Failed to update milestone")}}),T=he({mutationFn:async S=>{if(!s)throw new Error("Not authenticated");let N=5;S.targetDays<=14?N=3:S.targetDays<=30?N=4:S.targetDays<=60?N=5:N=6;const D=new Date(S.startDate),R=Array.from({length:N},(C,E)=>{const O=Math.round((E+1)/N*100),M=Math.floor(S.targetDays*O/100),A=new Date(D);return A.setDate(A.getDate()+M),{epic_id:S.epicId,user_id:s.id,title:E===N-1?"The Finale":`Chapter ${E+1}`,description:E===N-1?"Complete your epic journey!":`Reach ${O}% of your goal`,target_date:A.toISOString().split("T")[0],milestone_percent:O,is_postcard_milestone:!0,phase_order:E+1,chapter_number:E+1}}),{error:_}=await k.from("epic_milestones").insert(R);if(_)throw _;return R},onSuccess:()=>{a.invalidateQueries({queryKey:["milestones",t]}),a.invalidateQueries({queryKey:["epics"]})},onError:S=>{console.error("Failed to backfill milestones:",S)}});return{milestones:r,milestonesByPhase:l,isLoading:i,error:o,completedCount:c,totalCount:d,nextMilestone:u,postcardMilestones:p,completeMilestone:v,uncompleteMilestone:j,getCurrentPhase:h,getPhaseStats:f,getCurrentPhaseProgress:m,getJourneyHealth:g,isMilestoneOverdue:y,getDaysUntilMilestone:b,getNextPostcardMilestone:w,getProgressToNextPostcard:x,backfillLegacyMilestones:T,isCompleting:v.isPending,isBackfilling:T.isPending}};function Ih(){const[t,s]=n.useState(null),[a,r]=n.useState(!1),[i,o]=n.useState(null),l=n.useCallback(async w=>{r(!0),o(null);try{const{data:x,error:v}=await k.functions.invoke("generate-journey-schedule",{body:w});if(v)throw v;if(x?.error)throw new Error(x.error);const j=x;return s(j),j}catch(x){const v=x instanceof Error?x.message:"Failed to build schedule";return o(v),console.error("Failed to generate schedule:",x),null}finally{r(!1)}},[]),c=n.useCallback(async w=>{r(!0),o(null);try{const{data:x,error:v}=await k.functions.invoke("generate-journey-schedule",{body:w});if(v)throw v;if(x?.error)throw new Error(x.error);const j=x;return s(j),j}catch(x){const v=x instanceof Error?x.message:"Failed to adjust schedule";return o(v),console.error("Failed to adjust schedule:",x),null}finally{r(!1)}},[]),d=7,u=n.useMemo(()=>t?.milestones.filter(w=>w.isPostcardMilestone).length??0,[t]),p=n.useCallback(w=>{s(x=>{if(!x)return x;const v=x.milestones.find(j=>j.id===w);return!v||!v.isPostcardMilestone&&x.milestones.filter(T=>T.isPostcardMilestone).length>=d?x:{...x,milestones:x.milestones.map(j=>j.id===w?{...j,isPostcardMilestone:!j.isPostcardMilestone}:j)}})},[]),h=n.useCallback(w=>{s(x=>x&&{...x,rituals:x.rituals.map(v=>v.id===w.id?w:v)})},[]),f=n.useCallback(w=>{s(x=>x&&{...x,rituals:[...x.rituals,w]})},[]),m=n.useCallback(w=>{s(x=>x&&{...x,rituals:x.rituals.filter(v=>v.id!==w)})},[]),g=n.useCallback(w=>{s(x=>x&&{...x,rituals:w})},[]),y=n.useCallback((w,x)=>{s(v=>v&&{...v,milestones:v.milestones.map(j=>j.id===w?{...j,targetDate:x}:j)})},[]),b=n.useCallback(()=>{s(null),o(null),r(!1)},[]);return{schedule:t,isLoading:a,error:i,generateSchedule:l,adjustSchedule:c,toggleMilestone:p,updateRitual:h,addRitual:f,removeRitual:m,setRituals:g,updateMilestoneDate:y,reset:b,postcardCount:u,maxPostcards:d}}function $5(t,s,a,r,i){const{milestones:o,completedCount:l,totalCount:c,getPhaseStats:d,getCurrentPhase:u,getJourneyHealth:p}=vi(t);return n.useMemo(()=>{const h=new Date,f=u(),m=d(),g=p(r,i),y=[],b=[],w=c,x=[...o].sort((q,$)=>new Date(q.target_date||0).getTime()-new Date($.target_date||0).getTime()),v=r?new Date(r):x[0]?.target_date?new Date(x[0].target_date):h,j=i?new Date(i):x[x.length-1]?.target_date?new Date(x[x.length-1].target_date):h,T=Math.max(1,Ft(h,v)),S=l/T,N=w-l,D=S>0?N/S:1/0,R=S>0?new Date(h.getTime()+D*24*60*60*1e3):null,_=R?Ft(j,R):-999,C=[];if(s&&s.length>0){const q=new Map;s.forEach($=>{const B=q.get($.habit_id)||{completions:[],title:$.habit?.title||"Unknown"};B.completions.push(new Date($.completed_at)),q.set($.habit_id,B)}),q.forEach(($,B)=>{const H=$.completions.filter(G=>Ft(h,G)<=30),K={},X={0:0,1:0,2:0,3:0,4:0,5:0,6:0},Y={0:0,1:0,2:0,3:0,4:0,5:0,6:0};H.forEach(G=>{X[G.getDay()]++});for(let G=0;G<30;G++){const ye=ai(h,G);Y[ye.getDay()]++}for(let G=0;G<7;G++)K[G.toString()]=Y[G]>0?X[G]/Y[G]:0;const ee=Math.floor(H.length/2),ie=H.slice(0,ee).length,fe=H.slice(ee).length;let U="stable";fe>ie*1.2?U="improving":fe<ie*.8&&(U="declining");const ce=H.length/30,ne=Object.entries(K).sort((G,ye)=>G[1]-ye[1]).slice(0,2).filter(([,G])=>G<.3).map(([G])=>["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][parseInt(G)]);let xe;ne.length>0?xe=`You often skip this on ${ne.join(" and ")}. Consider a lighter version for those days.`:U==="declining"&&(xe="Your completion rate is declining. Maybe simplify or reschedule?"),C.push({habitId:B,habitTitle:$.title,completionRate:ce,weekdayRates:K,trend:U,suggestion:xe})})}let E=null,O=!1;const M=a?Ft(h,a):0;if(_<-7&&(O=!0,E="behind_schedule",y.push({type:"warning",priority:"high",title:"You're falling behind",description:`At your current pace, you'll finish ${Math.abs(_)} days late. Let's adjust your plan.`,action:{label:"Get back on track",adjustmentText:"I'm behind schedule. Please help me get back on track by redistributing milestones or simplifying the plan."}}),b.push({label:"Get Back on Track",description:"We will redistribute milestones to match your pace",adjustmentText:"I'm behind schedule. Redistribute milestones realistically based on my current pace, prioritizing the most important ones.",icon:"target",priority:"primary"})),_>7&&(y.push({type:"celebration",priority:"low",title:"You're ahead of schedule!",description:`You're on track to finish ${_} days early. Consider accelerating or adding depth.`,action:{label:"Accelerate journey",adjustmentText:"I'm ahead of schedule! Please compress my timeline or add more challenging milestones."}}),b.push({label:"Accelerate Journey",description:"Compress timeline since you're ahead",adjustmentText:"I'm ahead of schedule. Compress my timeline or add more challenging milestones to maximize growth.",icon:"rocket",priority:"secondary"})),g&&(g.score==="D"||g.score==="F")){O=!0,E=E||"poor_health";const q=g.progressDelta<-20?"You're significantly behind expected progress":"Your journey needs attention to stay on track";y.push({type:"warning",priority:"high",title:"Journey needs attention",description:q,action:{label:"Review & adjust",adjustmentText:`My journey health is poor. ${q}. Please suggest adjustments to get back on track.`}})}M>5&&(O=!0,E=E||"inactive",y.push({type:"suggestion",priority:"medium",title:"Welcome back!",description:`It's been ${M} days since your last activity. Let's reassess your timeline.`,action:{label:"Adjust for break",adjustmentText:`I took a ${M}-day break. Please adjust my milestones to account for this time away.`}}),b.push({label:"Adjust for Break",description:`Account for your ${M}-day break`,adjustmentText:`I took a ${M}-day break. Shift my remaining milestones forward while keeping the overall pace realistic.`,icon:"clock",priority:"primary"}));const A=C.filter(q=>q.completionRate<.3);A.length>0&&(y.push({type:"suggestion",priority:"medium",title:"Some habits need attention",description:`${A.map(q=>q.habitTitle).join(", ")} have low completion rates.`,action:{label:"Simplify routine",adjustmentText:`I'm struggling with these habits: ${A.map(q=>q.habitTitle).join(", ")}. Please suggest easier alternatives or reduced frequency.`}}),b.push({label:"Simplify Routine",description:"Make struggling habits more achievable",adjustmentText:`These habits are hard to maintain: ${A.map(q=>q.habitTitle).join(", ")}. Suggest simpler versions or reduced frequency.`,icon:"shield",priority:"secondary"}));const L=m.find(q=>q.phaseName===f);if(L&&!L.isOnTrack&&L.daysUntilEnd!==null&&L.daysUntilEnd<7){const q=L.total-L.completed;y.push({type:"warning",priority:"high",title:"Phase deadline approaching",description:`Only ${L.daysUntilEnd} days left in "${L.phaseName}" with ${q} milestones to go.`,action:{label:"Redistribute phase",adjustmentText:`I'm running out of time in the "${L.phaseName}" phase. Please redistribute remaining milestones.`}})}return b.length===0&&b.push({label:"Optimize Timeline",description:"Get guidance to improve your schedule",adjustmentText:"Analyze my current progress and optimize the remaining timeline for best results.",icon:"sparkles",priority:"primary"},{label:"Add Buffer Time",description:"Extend deadline by 2 weeks",adjustmentText:"Add 2 weeks of buffer time to my journey and redistribute milestones accordingly.",icon:"clock",priority:"secondary"}),b.find(q=>q.label==="Simplify Routine")||b.push({label:"Focus on Essentials",description:"Keep only the most impactful milestones",adjustmentText:"Simplify my journey to focus on the most essential milestones. Remove or combine less critical ones.",icon:"target",priority:"secondary"}),{shouldShowAdvisor:O,advisorTrigger:E,insights:y,habitPatterns:C,velocityPerDay:S,estimatedCompletionDate:R,daysAheadOrBehind:_,smartQuickActions:b.slice(0,4)}},[o,l,c,s,a,r,i,d,u,p])}const cd={rocket:nu,clock:Ht,target:It,sparkles:be,shield:As};function B5({epicId:t,onSelectAdjustment:s,onDismiss:a,variant:r="card",className:i}){const[o,l]=n.useState(!1),[c,d]=n.useState(!1),{user:u}=_e(),{data:p}=Ee({queryKey:["epic-details",t],queryFn:async()=>{const{data:w,error:x}=await k.from("epics").select("start_date, end_date, epic_habits(habit_id)").eq("id",t).maybeSingle();if(x)throw x;return w||null},enabled:!!t}),{data:h}=Ee({queryKey:["epic-habit-completions",t,u?.id],queryFn:async()=>{if(!u?.id||!p?.epic_habits?.length)return[];const w=p.epic_habits.map(T=>T.habit_id),x=ae(ai(new Date,30),"yyyy-MM-dd"),{data:v,error:j}=await k.from("habit_completions").select("habit_id, date, habits(title)").eq("user_id",u.id).in("habit_id",w).gte("date",x);if(j)throw j;return(v||[]).map(T=>({habit_id:T.habit_id,completed_at:T.date,habit:T.habits}))},enabled:!!u?.id&&!!p?.epic_habits?.length}),{data:f}=Ee({queryKey:["last-epic-activity",t,u?.id],queryFn:async()=>{if(!u?.id)return null;const{data:w,error:x}=await k.from("epic_progress_log").select("date").eq("epic_id",t).eq("user_id",u.id).order("date",{ascending:!1}).limit(1).maybeSingle();if(x&&x.code!=="PGRST116")throw x;return w?.date?new Date(w.date):void 0},enabled:!!u?.id&&!!t}),m=$5(t,h,f,p?.start_date,p?.end_date),g=()=>{l(!0),a?.()};if(o||!m.shouldShowAdvisor&&r!=="inline")return null;const y=m.insights[0],b=m.smartQuickActions.find(w=>w.priority==="primary");return r==="banner"?e.jsx(Re,{children:e.jsx(P.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:I("bg-gradient-to-r from-primary/10 via-primary/5 to-transparent","border border-primary/20 rounded-lg p-3",i),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0",children:e.jsx(be,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:y?.title||"Journey Check-in"}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:y?.description||"Get suggestions to optimize your plan"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[b&&e.jsxs(z,{size:"sm",variant:"default",className:"text-xs h-7 gap-1",onClick:()=>s(b.adjustmentText),children:[b.label,e.jsx(Dt,{className:"w-3 h-3"})]}),e.jsx(z,{size:"icon",variant:"ghost",className:"h-6 w-6",onClick:g,children:e.jsx(kt,{className:"w-3 h-3"})})]})]})})}):r==="inline"?e.jsxs("div",{className:I("space-y-3",i),children:[e.jsx("div",{className:"grid grid-cols-2 gap-2",children:m.smartQuickActions.map((w,x)=>{const v=cd[w.icon];return e.jsx(P.button,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{delay:x*.05},onClick:()=>s(w.adjustmentText),className:I("p-3 rounded-lg text-left transition-all","hover:scale-[1.02] active:scale-[0.98]",w.priority==="primary"?"bg-primary/10 border border-primary/30 hover:bg-primary/20":"bg-secondary/50 border border-border/50 hover:bg-secondary"),children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:I("w-7 h-7 rounded-full flex items-center justify-center flex-shrink-0",w.priority==="primary"?"bg-primary/20":"bg-muted"),children:e.jsx(v,{className:I("w-3.5 h-3.5",w.priority==="primary"?"text-primary":"text-muted-foreground")})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs font-medium",children:w.label}),e.jsx("p",{className:"text-[10px] text-muted-foreground line-clamp-2",children:w.description})]})]})},x)})}),m.insights.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>d(!c),className:"flex items-center gap-1.5 text-xs text-muted-foreground hover:text-foreground transition-colors",children:[e.jsx(Go,{className:"w-3 h-3"}),e.jsxs("span",{children:[m.insights.length," insight",m.insights.length>1?"s":""," available"]}),e.jsx(Dt,{className:I("w-3 h-3 transition-transform",c&&"rotate-90")})]}),e.jsx(Re,{children:c&&e.jsx(P.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"space-y-2 overflow-hidden",children:m.insights.map((w,x)=>e.jsx(dd,{insight:w,onAction:s},x))})})]}),m.estimatedCompletionDate&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground bg-secondary/30 rounded-lg px-3 py-2",children:[m.daysAheadOrBehind>=0?e.jsx(Rs,{className:"w-3.5 h-3.5 text-green-500"}):e.jsx(Er,{className:"w-3.5 h-3.5 text-amber-500"}),e.jsxs("span",{children:["Est. completion: ",ae(m.estimatedCompletionDate,"MMM d, yyyy"),m.daysAheadOrBehind!==0&&e.jsxs("span",{className:I("ml-1",m.daysAheadOrBehind>=0?"text-green-500":"text-amber-500"),children:["(",m.daysAheadOrBehind>0?"+":"",m.daysAheadOrBehind," days)"]})]})]})]}):e.jsxs(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:I("bg-card border border-border rounded-xl overflow-hidden",i),children:[e.jsx("div",{className:"px-4 py-3 bg-gradient-to-r from-primary/10 to-transparent border-b border-border/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center",children:e.jsx(be,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Smart Reschedule"}),e.jsx("p",{className:"text-[10px] text-muted-foreground",children:"Personalized suggestions"})]})]}),e.jsx(z,{size:"icon",variant:"ghost",className:"h-6 w-6",onClick:g,children:e.jsx(kt,{className:"w-3 h-3"})})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[y&&e.jsx(dd,{insight:y,onAction:s,featured:!0}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:m.smartQuickActions.slice(0,2).map((w,x)=>{const v=cd[w.icon];return e.jsxs(z,{variant:w.priority==="primary"?"default":"outline",size:"sm",className:"h-auto py-2 px-3 justify-start gap-2",onClick:()=>s(w.adjustmentText),children:[e.jsx(v,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsx("span",{className:"text-xs truncate",children:w.label})]},x)})}),m.estimatedCompletionDate&&e.jsxs("div",{className:"flex items-center justify-between text-xs bg-secondary/30 rounded-lg px-3 py-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Projected finish"}),e.jsxs("span",{className:"font-medium flex items-center gap-1",children:[ae(m.estimatedCompletionDate,"MMM d"),m.daysAheadOrBehind>=0?e.jsxs(Oe,{variant:"outline",className:"text-[10px] px-1 py-0 text-green-500 border-green-500/30",children:["+",m.daysAheadOrBehind,"d"]}):e.jsxs(Oe,{variant:"outline",className:"text-[10px] px-1 py-0 text-amber-500 border-amber-500/30",children:[m.daysAheadOrBehind,"d"]})]})]})]})]})}function dd({insight:t,onAction:s,featured:a=!1}){const r=()=>{switch(t.type){case"warning":return e.jsx(ca,{className:"w-3.5 h-3.5 text-amber-500"});case"celebration":return e.jsx(Rs,{className:"w-3.5 h-3.5 text-green-500"});default:return e.jsx(Go,{className:"w-3.5 h-3.5 text-blue-500"})}},i=()=>{switch(t.type){case"warning":return"bg-amber-500/10 border-amber-500/20";case"celebration":return"bg-green-500/10 border-green-500/20";default:return"bg-blue-500/10 border-blue-500/20"}};return e.jsx("div",{className:I("rounded-lg border p-3",i(),a&&"ring-1 ring-primary/20"),children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"mt-0.5",children:r()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium",children:t.title}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:t.description}),t.action&&e.jsxs(z,{size:"sm",variant:"ghost",className:"h-6 px-2 text-[10px] mt-2 gap-1",onClick:()=>s(t.action.adjustmentText),children:[t.action.label,e.jsx(Dt,{className:"w-3 h-3"})]})]})]})})}const U5=[{label:"I'm falling behind",value:"I'm falling behind schedule and need more time for each milestone"},{label:"Ahead of schedule",value:"I'm ahead of schedule, please compress the timeline"},{label:"Extend deadline",value:"I need to extend my deadline, please redistribute milestones"},{label:"More milestones",value:"Add more intermediate milestones to track progress better"},{label:"Simplify plan",value:"Simplify the plan with fewer, more focused milestones"}],H5=({epicId:t,epicTitle:s,epicGoal:a,currentDeadline:r,children:i})=>{const[o,l]=n.useState(!1),[c,d]=n.useState(""),[u,p]=n.useState(r?new Date(r):void 0),[h,f]=n.useState("input"),[m,g]=n.useState(!0),{user:y}=_e(),b=Ie(),{milestones:w,milestonesByPhase:x,getJourneyHealth:v}=vi(t),j=v(),{schedule:T,adjustSchedule:S,isLoading:N,error:D,reset:R}=Ih(),_={phases:x.map((q,$)=>({id:`phase-${$}`,name:q.phaseName,description:"",startDate:q.milestones[0]?.target_date||"",endDate:q.milestones[q.milestones.length-1]?.target_date||"",phaseOrder:q.phaseOrder})),milestones:w.map(q=>({id:q.id,title:q.title,description:q.description||"",targetDate:q.target_date||"",phaseOrder:q.phase_order||0,phaseName:q.phase_name||"General",isPostcardMilestone:q.is_postcard_milestone||!1,milestonePercent:q.milestone_percent})),rituals:[]},C=q=>{d(q),g(!1)},E=q=>{d(q),g(!1)},O=async()=>{if(!c.trim()&&u?.toISOString()===r){V.error("Please describe your adjustment or change the deadline");return}await S({goal:a||s,deadline:u?.toISOString()||r,adjustmentRequest:c,previousSchedule:_})&&f("preview")},M=async()=>{if(!(!T||!y)){f("saving");try{const{error:q}=await k.from("epic_milestones").delete().eq("epic_id",t).eq("user_id",y.id);if(q)throw q;const $=T.milestones.map(W=>({epic_id:t,user_id:y.id,title:W.title,description:W.description,milestone_percent:W.milestonePercent,target_date:W.targetDate,phase_name:W.phaseName,phase_order:W.phaseOrder,is_postcard_milestone:W.isPostcardMilestone})),{error:B}=await k.from("epic_milestones").insert($);if(B)throw B;if(u&&u.toISOString()!==r){const{error:W}=await k.from("epics").update({end_date:u.toISOString()}).eq("id",t).eq("user_id",y.id);if(W)throw W}b.invalidateQueries({queryKey:["milestones",t]}),b.invalidateQueries({queryKey:["epics"]}),V.success("Journey rescheduled!",{description:`${T.milestones.length} milestones updated`}),l(!1),A()}catch(q){console.error("Failed to apply schedule changes:",q),V.error("Failed to update schedule"),f("preview")}}},A=()=>{f("input"),d(""),g(!0),R()},L=q=>{l(q),q||A()};return e.jsxs(Ra,{open:o,onOpenChange:L,handleOnly:!0,shouldScaleBackground:!1,modal:!1,children:[e.jsx(ml,{asChild:!0,children:i||e.jsxs(z,{variant:"outline",size:"sm",className:"gap-1.5 text-xs",children:[e.jsx(ia,{className:"w-3.5 h-3.5"}),"Reschedule"]})}),e.jsxs(Ia,{className:"max-h-[90vh]",children:[e.jsxs(qa,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(La,{className:"flex items-center gap-2",children:[e.jsx(ia,{className:"w-5 h-5 text-primary"}),"Smart Reschedule"]}),j&&e.jsxs(Oe,{variant:"outline",className:I("text-xs",j.score==="A"&&"border-green-500/50 text-green-500",j.score==="B"&&"border-blue-500/50 text-blue-500",j.score==="C"&&"border-amber-500/50 text-amber-500",(j.score==="D"||j.score==="F")&&"border-red-500/50 text-red-500"),children:[e.jsx(Ds,{className:"w-3 h-3 mr-1"}),"Health: ",j.score]})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[h==="input"&&"Personalized suggestions to optimize your journey",h==="preview"&&"Review and apply the new schedule",h==="saving"&&"Applying changes..."]})]}),e.jsx(di,{className:"flex-1 px-4 max-h-[60vh]",children:e.jsxs(Re,{mode:"wait",children:[h==="input"&&e.jsxs(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"space-y-4 pb-4",children:[m&&e.jsx(B5,{epicId:t,onSelectAdjustment:E,onDismiss:()=>g(!1),variant:"inline"}),!m&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Quick adjustments"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:U5.map(q=>e.jsx(Oe,{variant:"outline",className:"cursor-pointer hover:bg-primary/10 hover:border-primary/50 transition-colors",onClick:()=>C(q.value),children:q.label},q.label))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Describe your changes"}),e.jsx(Zt,{value:c,onChange:q=>d(q.target.value),placeholder:"e.g., I need to take a 2-week break next month, please adjust milestones around that...",className:"min-h-[100px] resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Adjust deadline (optional)"}),e.jsxs(qs,{children:[e.jsx(Ls,{asChild:!0,children:e.jsxs(z,{variant:"outline",className:I("w-full justify-start text-left font-normal",!u&&"text-muted-foreground"),children:[e.jsx(zt,{className:"mr-2 h-4 w-4"}),u?ae(u,"PPP"):"Pick a new deadline"]})}),e.jsx(js,{className:"w-auto p-0",align:"start",children:e.jsx(hr,{mode:"single",selected:u,onSelect:p,disabled:q=>q<new Date,initialFocus:!0})})]})]}),e.jsxs("div",{className:"bg-secondary/30 rounded-lg p-3 space-y-1",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Current journey"}),e.jsx("div",{className:"text-sm font-medium",children:s}),e.jsxs("div",{className:"flex gap-3 text-xs text-muted-foreground",children:[e.jsxs("span",{children:[w.length," milestones"]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:[w.filter(q=>q.completed_at).length," completed"]})]})]}),D&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive bg-destructive/10 rounded-lg p-3",children:[e.jsx(Ca,{className:"w-4 h-4"}),D]})]},"input"),h==="preview"&&T&&e.jsxs(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"space-y-4 pb-4",children:[e.jsxs("div",{className:I("rounded-lg p-3 border",T.feasibilityAssessment.feasibility==="comfortable"&&"bg-green-500/10 border-green-500/20",T.feasibilityAssessment.feasibility==="achievable"&&"bg-blue-500/10 border-blue-500/20",T.feasibilityAssessment.feasibility==="aggressive"&&"bg-amber-500/10 border-amber-500/20",T.feasibilityAssessment.feasibility==="very_aggressive"&&"bg-red-500/10 border-red-500/20"),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(be,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-medium text-sm capitalize",children:[Ps(T.feasibilityAssessment.feasibility)," timeline"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:T.feasibilityAssessment.message})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground mb-2",children:["New milestones (",T.milestones.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-[200px] overflow-y-auto",children:T.milestones.map((q,$)=>e.jsxs("div",{className:"flex items-center gap-3 p-2 bg-secondary/30 rounded-lg",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center text-xs font-medium",children:$+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-sm font-medium truncate",children:q.title}),q.isPostcardMilestone&&e.jsx(be,{className:"w-3 h-3 text-amber-500 flex-shrink-0"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-muted-foreground",children:[e.jsx("span",{children:q.phaseName}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:ae(new Date(q.targetDate),"MMM d")})]})]})]},q.id))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-secondary/30 rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-lg font-bold",children:w.length}),e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Current milestones"})]}),e.jsxs("div",{className:"bg-primary/10 rounded-lg p-3 text-center border border-primary/20",children:[e.jsx("div",{className:"text-lg font-bold text-primary",children:T.milestones.length}),e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"New milestones"})]})]})]},"preview"),h==="saving"&&e.jsxs(P.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center py-12",children:[e.jsx(Nt,{className:"w-8 h-8 animate-spin text-primary mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Updating your journey..."})]},"saving")]})}),e.jsxs(xp,{className:"border-t pt-4",children:[h==="input"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(z,{variant:"outline",className:"flex-1",onClick:()=>l(!1),children:"Cancel"}),e.jsx(z,{className:"flex-1 gap-2",onClick:O,disabled:N,children:N?e.jsxs(e.Fragment,{children:[e.jsx(Nt,{className:"w-4 h-4 animate-spin"}),"Building..."]}):e.jsxs(e.Fragment,{children:[e.jsx(be,{className:"w-4 h-4"}),"Build New Schedule"]})})]}),h==="preview"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(z,{variant:"outline",className:"flex-1",onClick:()=>f("input"),children:"Back"}),e.jsxs(z,{className:"flex-1 gap-2",onClick:M,children:[e.jsx(rr,{className:"w-4 h-4"}),"Apply Changes"]})]})]})]})]})},z5=({show:t,milestoneTitle:s,chapterNumber:a,onDismiss:r})=>{const[i,o]=n.useState("entering");n.useEffect(()=>{if(t){o("entering"),el(),ws.impact({style:Ut.Heavy}).catch(()=>{});const c=["#F59E0B","#F97316","#FBBF24","#FCD34D","#D97706"];Bt({particleCount:80,spread:70,origin:{y:.6},colors:c}),setTimeout(()=>{Bt({particleCount:50,angle:60,spread:55,origin:{x:0,y:.6},colors:c}),Bt({particleCount:50,angle:120,spread:55,origin:{x:1,y:.6},colors:c})},200),setTimeout(()=>o("main"),300)}},[t]);const l=()=>{o("exiting"),setTimeout(()=>{r()},300)};return t?e.jsx(Re,{children:e.jsx(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-background/80 backdrop-blur-sm",onClick:l,children:e.jsxs(P.div,{initial:{scale:.8,rotateY:180,opacity:0},animate:i==="exiting"?{scale:.8,opacity:0,y:20}:{scale:1,rotateY:0,opacity:1},transition:{type:"spring",damping:20,stiffness:300,duration:.6},className:"relative w-[85vw] max-w-sm p-6 rounded-2xl bg-gradient-to-br from-amber-500/20 via-orange-500/10 to-yellow-500/20 border border-amber-500/30 shadow-2xl",onClick:c=>c.stopPropagation(),style:{perspective:1e3},children:[e.jsx("div",{className:"absolute inset-0 rounded-2xl bg-amber-500/10 blur-xl"}),e.jsxs("div",{className:"relative z-10 flex flex-col items-center text-center space-y-4",children:[e.jsxs(P.div,{initial:{scale:0},animate:{scale:1},transition:{delay:.3,type:"spring",stiffness:500},className:"relative",children:[e.jsx("div",{className:"w-20 h-20 rounded-2xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shadow-lg",children:e.jsx(Zu,{className:"w-10 h-10 text-white"})}),e.jsx(P.div,{animate:{rotate:360},transition:{duration:3,repeat:1/0,ease:"linear"},className:"absolute -top-2 -right-2",children:e.jsx(be,{className:"w-6 h-6 text-amber-400"})}),e.jsx(P.div,{animate:{scale:[1,1.2,1]},transition:{duration:2,repeat:1/0},className:"absolute -bottom-1 -left-2",children:e.jsx(be,{className:"w-5 h-5 text-yellow-400"})})]}),e.jsxs(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.4},children:[e.jsx("h2",{className:"text-xl font-bold bg-gradient-to-r from-amber-400 via-orange-400 to-yellow-500 bg-clip-text text-transparent",children:"Postcard Unlocked!"}),a&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Chapter ",a]})]}),s&&e.jsx(P.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},className:"text-sm text-foreground/80 font-medium",children:s}),e.jsx(P.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.6},className:"text-xs text-muted-foreground italic",children:"Your companion is sending you a cosmic memory..."}),e.jsx(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.7},className:"pt-2",children:e.jsx(z,{onClick:l,className:"bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white px-8",children:"Continue"})})]}),e.jsx("button",{onClick:l,className:"absolute top-3 right-3 p-1 rounded-full hover:bg-white/10 transition-colors",children:e.jsx(kt,{className:"w-4 h-4 text-muted-foreground"})}),e.jsx(be,{className:"absolute top-4 left-4 w-4 h-4 text-amber-400/50"}),e.jsx(be,{className:"absolute bottom-4 right-4 w-4 h-4 text-orange-400/50"})]})})}):null},K5=({milestone:t,isOpen:s,onClose:a,onComplete:r,onUncomplete:i,isCompleting:o,status:l,postcard:c})=>{if(!t)return null;const d=l==="completed",u=l==="overdue",p=t.is_postcard_milestone,f=p?pa.POSTCARD:pa.REGULAR,g=(()=>{if(!t.target_date)return null;const y=new Date(t.target_date),b=new Date;return b.setHours(0,0,0,0),y.setHours(0,0,0,0),Ft(y,b)})();return e.jsx(Ra,{open:s,onOpenChange:y=>!y&&a(),handleOnly:!0,shouldScaleBackground:!1,modal:!1,children:e.jsxs(Ia,{className:"max-h-[90vh]",children:[e.jsxs(qa,{className:"pb-2 border-b border-border/50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.phase_name&&e.jsx(Oe,{variant:"outline",className:"text-xs",children:t.phase_name}),p&&e.jsxs(Oe,{variant:"outline",className:"text-xs text-royal-purple border-royal-purple/30 bg-royal-purple/10",children:[e.jsx(be,{className:"w-3 h-3 mr-1"}),"Celebration"]})]}),e.jsx(z,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:a,children:e.jsx(kt,{className:"w-4 h-4"})})]}),e.jsxs(La,{className:"text-left flex items-center gap-2 mt-2",children:[e.jsx("span",{children:t.title}),p&&e.jsx(be,{className:"w-4 h-4 text-amber-500"})]})]}),e.jsx("div",{className:"flex-1 max-h-[60vh] overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},"data-vaul-no-drag":!0,children:e.jsxs("div",{className:"px-4 py-4 space-y-5",children:[e.jsxs(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex flex-wrap items-center gap-2",children:[d&&e.jsxs(Oe,{className:"bg-green-500/10 text-green-600 border-green-200",children:[e.jsx(rr,{className:"w-3 h-3 mr-1"}),"Completed"]}),u&&e.jsxs(Oe,{variant:"destructive",className:"bg-destructive/10",children:[e.jsx(Ca,{className:"w-3 h-3 mr-1"}),"Overdue"]}),!d&&!u&&e.jsx(Oe,{variant:"secondary",children:"Pending"}),t.target_date&&e.jsxs("div",{className:I("flex items-center gap-1.5 text-sm",u&&"text-destructive"),children:[e.jsx(zt,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:ae(new Date(t.target_date),"MMM d, yyyy")}),g!==null&&!d&&e.jsxs("span",{className:"text-muted-foreground text-xs",children:["(",g>0?`in ${g} day${g!==1?"s":""}`:g===0?"today":`${Math.abs(g)} day${Math.abs(g)!==1?"s":""} ago`,")"]})]})]}),t.description&&e.jsxs(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.05},className:"space-y-2",children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground",children:"Description"}),e.jsx("p",{className:"text-sm leading-relaxed",children:t.description})]}),p&&e.jsxs(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.1},className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ir,{className:"w-4 h-4 text-primary"}),e.jsx("h4",{className:"text-sm font-semibold",children:"Cosmiq Story"})]}),c?e.jsxs("div",{className:"rounded-xl border border-border/50 bg-card/50 overflow-hidden",children:[c.chapter_title&&e.jsx("div",{className:"px-4 py-3 border-b border-border/30 bg-primary/5",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Mt,{className:"w-4 h-4 text-amber-500"}),e.jsxs("span",{className:"text-sm font-medium",children:[c.chapter_number?`Chapter ${c.chapter_number}: `:"",c.chapter_title]})]})}),c.image_url&&e.jsxs("div",{className:"relative aspect-video w-full",children:[e.jsx("img",{src:c.image_url,alt:c.location_name,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-3",children:e.jsxs("div",{className:"flex items-center gap-1.5 text-white/90",children:[e.jsx(Jr,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-sm font-medium",children:c.location_name})]})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[c.location_description&&e.jsx("p",{className:"text-sm text-muted-foreground italic",children:c.location_description}),c.story_content&&e.jsx("div",{className:"space-y-2",children:e.jsx("p",{className:"text-sm leading-relaxed",children:c.story_content})}),c.clue_text&&e.jsxs("div",{className:"flex items-start gap-2 p-3 rounded-lg bg-purple-500/10 border border-purple-200/30",children:[e.jsx(Sr,{className:"w-4 h-4 text-purple-500 mt-0.5 shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-purple-600 block mb-1",children:"Mystery Clue"}),e.jsxs("p",{className:"text-sm italic text-purple-700/80",children:['"',c.clue_text,'"']})]})]}),c.prophecy_line&&e.jsxs("div",{className:"flex items-start gap-2 p-3 rounded-lg bg-amber-500/10 border border-amber-200/30",children:[e.jsx(nx,{className:"w-4 h-4 text-amber-500 mt-0.5 shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-amber-600 block mb-1",children:"Prophecy Fragment"}),e.jsxs("p",{className:"text-sm italic text-amber-700/80",children:['"',c.prophecy_line,'"']})]})]}),c.characters_featured&&c.characters_featured.length>0&&e.jsxs("div",{className:"flex items-center gap-2 pt-2 border-t border-border/30",children:[e.jsx(Bu,{className:"w-3.5 h-3.5 text-muted-foreground"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Featuring:"," ",c.characters_featured.join(", ")]})]})]})]}):d?e.jsxs("div",{className:"rounded-xl border border-border/50 bg-muted/30 p-4 text-center",children:[e.jsx(Nt,{className:"w-6 h-6 text-muted-foreground mx-auto mb-2 animate-spin"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Your story chapter is being written..."})]}):e.jsxs("div",{className:"relative rounded-xl border border-dashed border-stardust-gold/40 bg-gradient-to-br from-stardust-gold/10 via-amber-500/5 to-royal-purple/10 p-5 text-center overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-stardust-gold/10 to-transparent animate-shimmer"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-stardust-gold/20 flex items-center justify-center mx-auto mb-3",children:e.jsx(be,{className:"w-6 h-6 text-stardust-gold"})}),e.jsxs("p",{className:"text-sm text-foreground/90 font-medium",children:["Complete this milestone to unlock"," ",e.jsx("span",{className:"text-stardust-gold",children:t.chapter_number?`Chapter ${t.chapter_number}`:"a new chapter"})," ","of your cosmic journey!"]})]})]})]})]})}),e.jsx("div",{className:"p-4 border-t border-border/50",children:e.jsx(Re,{mode:"wait",children:d?e.jsx(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:e.jsxs(z,{variant:"outline",className:"w-full",onClick:()=>i(t),disabled:o,children:[o?e.jsx(Nt,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(kt,{className:"w-4 h-4 mr-2"}),"Mark Incomplete"]})},"uncomplete"):e.jsx(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:e.jsxs(z,{className:"w-full gap-2",onClick:()=>r(t),disabled:o,children:[o?e.jsx(Nt,{className:"w-4 h-4 animate-spin"}):e.jsx(rr,{className:"w-4 h-4"}),"Complete Milestone",e.jsxs(Oe,{variant:"secondary",className:"ml-1 bg-primary-foreground/20 text-primary-foreground text-xs",children:["+",f," XP"]})]})},"complete")})})]})})},Q5=({epicId:t,epicTitle:s,epicGoal:a,currentDeadline:r,children:i})=>{const[o,l]=n.useState(!1),[c,d]=n.useState(null),{milestones:u,milestonesByPhase:p,isLoading:h,completedCount:f,totalCount:m,completeMilestone:g,uncompleteMilestone:y,getCurrentPhase:b,isMilestoneOverdue:w,isCompleting:x}=vi(t),{postcards:v,checkMilestoneForPostcard:j,postcardJustUnlocked:T,clearPostcardUnlocked:S}=Ck(),{companion:N}=At(),{awardMilestoneComplete:D,awardPhaseComplete:R,awardEpicComplete:_}=rs(),{regeneratePathForMilestone:C}=wl(t),E=b(),O=n.useMemo(()=>v?.filter(H=>H.epic_id===t)||[],[v,t]),M=H=>O.find(K=>K.milestone_percent===H.milestone_percent),A=H=>{const K=p.find(Y=>Y.phaseName===H.phase_name);if(!K)return;K.milestones.every(Y=>Y.id===H.id||Y.completed_at)&&R(K.phaseName)},L=H=>{u.every(X=>X.id===H.id||X.completed_at)&&m>0&&_(s)},q=async H=>{const K=u.findIndex(X=>X.id===H.id);g.mutate({milestoneId:H.id,epicId:t,onPostcardTrigger:X=>{j(X.id,t,N?.id||"",{spirit_animal:N?.spirit_animal,favorite_color:N?.favorite_color,core_element:N?.core_element,eye_color:N?.eye_color,fur_color:N?.fur_color})}},{onSuccess:()=>{K>=0&&C(K+1),D(H.is_postcard_milestone||!1),A(H),L(H),d(null)}})},$=H=>{y.mutate(H.id),d(null)},B=H=>{d(H)},W=H=>H.completed_at?"completed":w(H)?"overdue":"pending";return e.jsxs(e.Fragment,{children:[e.jsx(z5,{show:!!T,milestoneTitle:T?.milestoneTitle,chapterNumber:T?.chapterNumber,onDismiss:S}),e.jsxs(Ra,{open:o,onOpenChange:l,shouldScaleBackground:!1,handleOnly:!0,children:[e.jsx(ml,{asChild:!0,children:i||e.jsxs(z,{variant:"ghost",size:"sm",className:"gap-1.5 text-xs",children:[e.jsx(Tr,{className:"w-3.5 h-3.5"}),"View Timeline"]})}),e.jsxs(Ia,{className:"max-h-[85vh]",children:[e.jsxs(qa,{className:"pb-2",children:[e.jsxs(La,{className:"flex items-center gap-2",children:[e.jsx(Tr,{className:"w-5 h-5 text-primary"}),s]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Oe,{variant:"secondary",className:"text-xs",children:[f," / ",m," milestones"]}),E&&e.jsxs(Oe,{variant:"outline",className:"text-xs",children:["Current: ",E]})]}),r&&e.jsx(H5,{epicId:t,epicTitle:s,epicGoal:a,currentDeadline:r,children:e.jsxs(z,{variant:"ghost",size:"sm",className:"gap-1.5 text-xs h-7",children:[e.jsx(ia,{className:"w-3.5 h-3.5"}),"Reschedule"]})})]})]}),e.jsx("div",{className:"flex-1 px-4 pb-6 max-h-[60vh] overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},"data-vaul-no-drag":!0,children:h?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary"})}):u.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(Tr,{className:"w-10 h-10 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No milestones yet"})]}):e.jsx("div",{className:"space-y-2",children:u.sort((H,K)=>!H.target_date&&!K.target_date?0:H.target_date?K.target_date?new Date(H.target_date).getTime()-new Date(K.target_date).getTime():-1:1).map(H=>{const K=W(H);return e.jsxs("div",{onClick:()=>B(H),className:I("flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors",K==="completed"&&"bg-green-500/5",K==="overdue"&&"bg-destructive/5",K==="pending"&&"bg-secondary/30 hover:bg-secondary/50"),children:[e.jsx(ka,{checked:!!H.completed_at,disabled:!0,className:"pointer-events-none"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("span",{className:I("text-sm",K==="completed"&&"line-through text-muted-foreground"),children:H.title})}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[H.target_date&&e.jsx("span",{className:I("text-xs text-muted-foreground",K==="overdue"&&"text-destructive"),children:ae(new Date(H.target_date),"MMM d")}),K==="completed"&&e.jsx(rr,{className:"w-4 h-4 text-green-600"}),K==="overdue"&&e.jsx(Ca,{className:"w-4 h-4 text-destructive"}),H.is_postcard_milestone&&!H.completed_at&&e.jsx(Mt,{className:"w-4 h-4 text-amber-500"}),e.jsx(Dt,{className:"w-4 h-4 text-muted-foreground/50"})]})]},H.id)})})})]})]}),e.jsx(K5,{milestone:c,isOpen:!!c,onClose:()=>d(null),onComplete:q,onUncomplete:$,isCompleting:x,status:c?W(c):"pending",postcard:c?M(c):void 0})]})},ud=n.memo(function({epic:s,children:a}){const[r,i]=n.useState(!1),{pathImageUrl:o,isLoading:l}=wl(s.id),{milestones:c,totalCount:d}=vi(s.id),{companion:u}=At(),p=n.useMemo(()=>Math.max(0,Ft(new Date(s.end_date),new Date)),[s.end_date]),h=n.useMemo(()=>c.map(f=>({id:f.id,title:f.title,milestone_percent:f.milestone_percent,is_postcard_milestone:f.is_postcard_milestone,completed_at:f.completed_at,description:f.description,phase_name:f.phase_name,target_date:f.target_date,chapter_number:f.chapter_number})),[c]);return e.jsxs(Ra,{open:r,onOpenChange:i,shouldScaleBackground:!1,handleOnly:!0,children:[e.jsx(ml,{asChild:!0,children:a}),e.jsxs(Ia,{className:"max-h-[85vh]",children:[e.jsxs(qa,{className:"pb-2",children:[e.jsxs(La,{className:"flex items-center gap-2",children:[e.jsx(It,{className:"w-5 h-5 text-primary"}),s.title]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"font-bold text-primary",children:[Math.round(s.progress_percentage),"% Complete"]}),e.jsxs("span",{className:"text-muted-foreground flex items-center gap-1",children:[e.jsx(es,{className:"w-3.5 h-3.5 text-orange-500"}),p,"d left"]})]}),e.jsx(Ys,{value:s.progress_percentage,className:"h-2"})]})]}),e.jsxs("div",{className:"flex-1 px-4 pb-6 max-h-[60vh] overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},"data-vaul-no-drag":!0,children:[e.jsx(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mb-4",children:e.jsxs("div",{className:"rounded-xl overflow-hidden border border-border/30 bg-card/30 backdrop-blur-sm",children:[e.jsxs("div",{className:"relative h-56 w-full overflow-hidden",children:[o&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:o,alt:"Your journey path",className:"absolute inset-0 w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background/80 via-background/30 to-transparent"})]}),e.jsx(F5,{progress:s.progress_percentage,targetDays:s.target_days,companionImageUrl:u?.current_image_url,companionMood:u?.current_mood,showCompanion:!0,milestones:h,transparentBackground:!!o,className:"absolute inset-0"})]}),l&&!o&&e.jsx("div",{className:"h-56 flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx(be,{className:"w-8 h-8 text-primary/50 mx-auto animate-pulse"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Loading journey path..."})]})})]})}),e.jsxs("div",{className:"flex items-center justify-center gap-6 mb-6 text-sm text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(Mt,{className:"w-4 h-4 text-purple-400"}),e.jsxs("span",{children:[d," milestones"]})]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(zt,{className:"w-4 h-4 text-sky-400"}),e.jsxs("span",{children:[s.target_days,"d journey"]})]})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(Q5,{epicId:s.id,epicTitle:s.title,epicGoal:s.description,currentDeadline:s.end_date,children:e.jsxs(z,{variant:"outline",className:"gap-2",children:[e.jsx(Tr,{className:"w-4 h-4"}),"View Milestones"]})})})]})]})]})}),W5=t=>{const[s,a]=t.split(":"),r=parseInt(s),i=r>=12?"p":"a";return`${r%12||12}:${a}${i}`};function mo({time:t,overrideTime:s,label:a,rowKind:r="task",tone:i="default",durationMinutes:o,laneIndex:l=0,laneCount:c=1,overlapCount:d=0,showLine:u=!0,isLast:p=!1,isDragTarget:h=!1,className:f,children:m,...g}){const y=s??t,b=s!=null,w=i==="now",x=r==="task",v=r==="marker",j=x&&!!y;return e.jsxs("div",{className:I("relative flex gap-2",h&&"rounded-lg",f),"data-timeline-lane":j?l:void 0,"data-timeline-lane-count":j?c:void 0,"data-timeline-overlap":j?d:void 0,...g,children:[e.jsx("div",{className:I("w-9 flex-shrink-0 text-left",v?"pt-[8px]":"pt-[22px]"),children:y?e.jsx("span",{className:I(v?"text-[9px]":"text-[10px]","font-medium leading-none transition-colors",w?"font-semibold text-stardust-gold":b?"text-primary font-bold":"text-muted-foreground"),children:W5(y)}):a?e.jsx("span",{className:"text-[9px] font-semibold uppercase tracking-wide text-muted-foreground/80",children:a}):null}),e.jsx("div",{className:I("flex-1 min-w-0",v?"py-0":"py-1"),children:m})]})}const G5=({percent:t,size:s=32,strokeWidth:a=3,className:r,showLabel:i=!1})=>{const o=(s-a)/2,l=o*2*Math.PI,c=l-t/100*l,d=()=>t===100?"hsl(var(--chart-2))":t>=50?"hsl(var(--chart-4))":"hsl(var(--primary))";return e.jsxs("div",{className:I("relative inline-flex items-center justify-center",r),children:[e.jsxs("svg",{width:s,height:s,className:"transform -rotate-90",children:[e.jsx("circle",{cx:s/2,cy:s/2,r:o,fill:"none",stroke:"hsl(var(--muted))",strokeWidth:a}),e.jsx("circle",{cx:s/2,cy:s/2,r:o,fill:"none",stroke:d(),strokeWidth:a,strokeDasharray:l,strokeDashoffset:c,strokeLinecap:"round",className:"transition-all duration-300 ease-out"})]}),i&&e.jsxs("span",{className:"absolute text-xs font-medium",children:[t,"%"]})]})},Y5=30,qo=t=>Number.isFinite(t.estimated_duration)&&(t.estimated_duration??0)>0?Number(t.estimated_duration):Y5,Lo=t=>{const s=mi(t);return s?s.hour*60+s.minute:null},V5=(t,s)=>{const a=[];for(const r of t){const i=r.scheduled_time,o=Lo(i);o!==null&&a.push({id:r.id,startMinutes:o,endMinutes:o+qo(r)})}return a.sort((r,i)=>r.startMinutes-i.startMinutes)},X5=(t,s)=>{const a=V5(t);if(a.length<2)return[];const r=[];for(let i=0;i<a.length-1;i+=1){const o=a[i];for(let l=i+1;l<a.length;l+=1){const c=a[l];if(c.startMinutes>=o.endMinutes)break;const d=Math.min(o.endMinutes,c.endMinutes)-c.startMinutes;d<=0||r.push({taskAId:o.id,taskBId:c.id,overlapMinutes:d})}}return r},J5=(t,s)=>{const a=X5(t),r=new Map;for(const i of a)r.has(i.taskAId)||r.set(i.taskAId,new Set),r.has(i.taskBId)||r.set(i.taskBId,new Set),r.get(i.taskAId)?.add(i.taskBId),r.get(i.taskBId)?.add(i.taskAId);return r},qh=(t,s,a)=>{const r=s.find(u=>u.id===t);if(!r)return new Set;const i=a?.[t],o=i!==void 0?i:r.scheduled_time,l=Lo(o);if(l===null)return new Set;const c=l+qo(r),d=new Set;for(const u of s){if(u.id===t)continue;const p=a?.[u.id],h=p!==void 0?p:u.scheduled_time,f=Lo(h);if(f===null)continue;const m=f+qo(u);Math.min(c,m)-Math.max(l,f)>0&&d.add(u.id)}return d},Z5=30,e2=t=>!Number.isFinite(t.estimated_duration)||(t.estimated_duration??0)<=0?Z5:Number(t.estimated_duration),t2=t=>{const s=mi(t);return s?s.hour*60+s.minute:null},s2=(t,s)=>t.map(a=>{const r=a.scheduled_time,i=t2(r);if(i===null)return null;const o=e2(a);return{...a,startMinute:i,endMinute:i+o}}).filter(a=>a!==null).sort((a,r)=>a.startMinute!==r.startMinute?a.startMinute-r.startMinute:a.endMinute!==r.endMinute?a.endMinute-r.endMinute:a.id.localeCompare(r.id)),a2=(t,s)=>{const a=s2(t),r=new Map;if(a.length===0)return{orderedTaskIds:[],byTaskId:r};const i=[],o=[];let l=[],c=0,d=null;const u=()=>{if(l.length!==0){for(const p of l){const h=r.get(p);h&&(h.laneCount=Math.max(h.laneCount,c),r.set(p,h))}l=[],c=0}};for(const p of a){for(let y=i.length-1;y>=0;y-=1)i[y].endMinute<=p.startMinute&&i.splice(y,1);i.length===0&&u();const h=new Set(i.map(y=>y.laneIndex));let f=0;for(;h.has(f);)f+=1;i.push({id:p.id,endMinute:p.endMinute,laneIndex:f}),l.push(p.id),c=Math.max(c,i.length),o.push(p.id);const m=qh(p.id,t,s).size,g=d===null?0:Math.max(0,p.startMinute-d);d=p.startMinute,r.set(p.id,{id:p.id,startMinute:p.startMinute,endMinute:p.endMinute,laneIndex:f,laneCount:1,overlapCount:m,gapBeforeMinutes:g})}return u(),{orderedTaskIds:o,byTaskId:r}},md=t=>{if(!t)return null;try{const s=new Date(t);return Number.isNaN(s.getTime())?null:Math.max(0,Ft(s,new Date))}catch{return null}},r2=(t,s,a="")=>{try{return Number.isNaN(t.getTime())?a:ae(t,s)}catch{return a}},pd="Photo attachment",hd=t=>{const s=(t.attachments??[]).filter(a=>typeof a.fileUrl=="string"&&a.fileUrl.trim().length>0).map(a=>({fileUrl:a.fileUrl,fileName:a.fileName?.trim()||pd,isImage:!!a.isImage}));return s.length>0?s:t.image_url?[{fileUrl:t.image_url,fileName:pd,isImage:!0}]:[]},n2=(t,s,a,r)=>t&&t.map(i=>i.id!==s||!i.subtasks?i:{...i,subtasks:i.subtasks.map(o=>o.id===a?{...o,completed:r}:o)}),i2=t=>{const[s,a]=t.split(":"),r=parseInt(s),i=r>=12?"PM":"AM";return`${r%12||12}:${a} ${i}`},fd=8e3,o2=360,fa=1439,ga=180,Va=.2,Ga=1,l2=10,gd=.45,Lh=104,c2=8,d2=10,u2=4,m2=180,Oo=.5,p2=24,h2=72,f2=140,g2=180,x2=140,y2=100,b2=75,Fo=1,w2=1,v2=2,_2=3,j2=t=>!Number.isFinite(t)||t<=Oo?null:t<=p2?{repeatMs:g2,stepMultiplier:Fo}:t<=h2?{repeatMs:x2,stepMultiplier:w2}:t<=f2?{repeatMs:y2,stepMultiplier:v2}:{repeatMs:b2,stepMultiplier:_2},xd=()=>{if(typeof window>"u"||typeof document>"u")return Lh;const t=document.createElement("div");t.style.position="fixed",t.style.visibility="hidden",t.style.pointerEvents="none",t.style.top="0",t.style.left="0",t.style.height="var(--bottom-nav-safe-offset)",document.body.appendChild(t);const s=t.getBoundingClientRect().height;if(t.remove(),Number.isFinite(s)&&s>0)return s;const a=Number.parseFloat(window.getComputedStyle(document.documentElement).fontSize||"16");return(Number.isFinite(a)&&a>0?a:16)*6.5},Ka=t=>{if(!t)return null;const[s,a]=t.split(":").map(Number);return!Number.isFinite(s)||!Number.isFinite(a)?null:s*60+a},$o=t=>{const s=Math.max(0,Math.min(1439,Math.round(t))),a=Math.floor(s/60),r=s%60;return`${String(a).padStart(2,"0")}:${String(r).padStart(2,"0")}`},N2=t=>$o(t).replace(":",""),k2=t=>Math.max(0,Math.min(1,t)),C2=(t,s)=>(t%s+s)%s,yd=(t,s)=>s>0?t*l2:0,S2=(t,s)=>{if(s-t<=1)return[];const a=Math.ceil((t+1)/60)*60,r=[];for(let i=a;i<s;i+=60)i<=fa&&r.push(i);return r},Oh=(t,s)=>{if(t.length===0)return null;let a=t[0],r=Math.abs(a-s);for(let i=1;i<t.length;i+=1){const o=t[i],l=Math.abs(o-s);if(l<r){a=o,r=l;continue}l===r&&o<a&&(a=o)}return a},E2=(t,s)=>{if(s-t<60)return null;const r=(t+s)/2,i=S2(t,s);return Oh(i,r)},T2=(t,s)=>{for(let a=1;a<s.length;a+=1){const r=s[a-1],i=s[a];if(r<t&&t<i)return!0}return!1},M2=(t,s)=>{const a=[...t].sort((i,o)=>i-o),r=new Set([s]);if(a.length===0)return Array.from(r).sort((i,o)=>i-o);for(const i of a){const o=C2(i,ga),l=o===0,c=l?i-ga:i-o,d=l?i+ga:c+ga;c>=0&&c<=fa&&r.add(c),d>=0&&d<=fa&&r.add(d)}if(a.length>1){for(const i of Array.from(r))i!==s&&T2(i,a)&&r.delete(i);for(let i=1;i<a.length;i+=1){const o=a[i-1],l=a[i],c=E2(o,l);c!==null&&r.add(c)}}return Array.from(r).sort((i,o)=>i-o)},D2=(t,s)=>{if(s.length<2)return t;for(let a=1;a<s.length;a+=1){const r=s[a-1],i=s[a],o=Array.from(t.values()).filter(d=>r<d.minute&&d.minute<i).sort((d,u)=>d.minute-u.minute);if(o.length<=1)continue;if(o.find(d=>d.kind==="now")){for(const d of o)d.kind==="placeholder"&&t.delete(d.minute);continue}const c=Oh(o.filter(d=>d.kind==="placeholder").map(d=>d.minute),(r+i)/2);if(c!==null)for(const d of o)d.kind==="placeholder"&&d.minute!==c&&t.delete(d.minute)}return t},A2=(t,s)=>{const a=new Map;for(const p of t)a.set(p,Va);if(t.length===0)return a;if(t.length===1)return a.set(t[0],Ga),a;const r=t[0],i=t[t.length-1];if(s<=r)return a.set(r,Ga),a;if(s>=i)return a.set(i,Ga),a;const o=t.findIndex(p=>p>=s);if(o<=0)return a.set(r,Ga),a;const l=t[o-1],c=t[o],d=k2((s-l)/(c-l)),u=Ga-Va;return a.set(l,Va+(1-d)*u),a.set(c,Va+d*u),a},P2=n.memo(function({tasks:s,selectedDate:a,isVisible:r=!0,onToggle:i,onAddQuest:o,completedCount:l,totalCount:c,currentStreak:d=0,onUndoToggle:u,onEditQuest:p,calendarTasks:h=[],calendarMilestones:f=[],onDateSelect:m,activeEpics:g=[],onDeleteQuest:y,onMoveQuestToNextDay:b,onUpdateScheduledTime:w,onTimeSlotLongPress:x,onSendToCalendar:v,hasCalendarLink:j,onTimelineDragPreviewTimeChange:T}){const S=Yr(),{capabilities:N}=cl(),R=n.useMemo(()=>{if(typeof window>"u")return!1;const F=window.Capacitor;return!!(F?.isNativePlatform?.()&&F?.getPlatform?.()==="ios")},[])||!!S||!N.allowBackgroundAnimation,{profile:_}=ss(),C=Ie(),E=_?.completed_tasks_stay_in_place??!0,O=he({mutationFn:async({taskId:F,subtaskId:pe,completed:te})=>{const{error:le}=await k.from("subtasks").update({completed:te,completed_at:te?new Date().toISOString():null}).eq("id",pe).eq("task_id",F);if(le)throw le},onMutate:async({taskId:F,subtaskId:pe,completed:te})=>{await C.cancelQueries({queryKey:["daily-tasks"]});const le=C.getQueriesData({queryKey:["daily-tasks"]});return C.setQueriesData({queryKey:["daily-tasks"]},Ke=>n2(Ke,F,pe,te)),{previousDailyTasks:le}},onError:(F,pe,te)=>{te?.previousDailyTasks&&te.previousDailyTasks.forEach(([le,Ke])=>{C.setQueryData(le,Ke)})},onSettled:()=>{C.invalidateQueries({queryKey:["daily-tasks"]})}}),M=n.useRef(null),A=n.useRef(null),[L,q]=n.useState(null),$=n.useCallback(F=>{A.current=F,M.current=F},[]),[B,W]=n.useState(new Set),[H,K]=n.useState(!1),[X,Y]=n.useState("custom"),[ee,ie]=n.useState(new Set),[fe,U]=n.useState(new Set),[ce,se]=n.useState(new Set),[ne,xe]=n.useState(0),[G,ye]=n.useState(!1),we=n.useRef(null),Te=n.useRef(null),qe=n.useRef(null);n.useEffect(()=>{U(F=>{const pe=s.filter(le=>le.completed).map(le=>le.id),te=new Set(F);return pe.forEach(le=>te.delete(le)),te.size!==F.size?te:F})},[s]);const Se=n.useCallback(()=>{Te.current!==null&&window.clearTimeout(Te.current),Te.current=window.setTimeout(()=>{xe(0),ye(!1),we.current=null,Te.current=null},fd)},[]),Pe=n.useCallback(()=>{const F=Date.now(),te=we.current!==null&&F-we.current<=fd?ne+1:1;xe(te),we.current=F,Se(),te>1&&(ye(!0),window.setTimeout(()=>{ye(!1)},R?600:1e3))},[ne,Se,R]),$e=n.useCallback(()=>{Te.current!==null&&(window.clearTimeout(Te.current),Te.current=null),xe(0),ye(!1),we.current=null},[]);n.useEffect(()=>()=>{Te.current!==null&&window.clearTimeout(Te.current)},[]),n.useEffect(()=>{$e()},[a,$e]);const Be=F=>{switch(F){case"high":return 0;case"medium":return 1;case"low":return 2;default:return 3}},{ritualTasks:Me,questTasks:Qe}=n.useMemo(()=>{const F=s.filter(le=>!!le.habit_source_id),pe=s.filter(le=>!le.habit_source_id),te=le=>{let Ke=[...le].sort((ze,Ve)=>{switch(X){case"time":return ze.scheduled_time&&Ve.scheduled_time?ze.scheduled_time.localeCompare(Ve.scheduled_time):ze.scheduled_time?-1:Ve.scheduled_time?1:0;case"priority":return Be(ze.priority)-Be(Ve.priority);case"xp":return Ve.xp_reward-ze.xp_reward;default:{const ft=ze.sort_order??9999,it=Ve.sort_order??9999;return ft!==it?ft-it:ze.scheduled_time&&Ve.scheduled_time?ze.scheduled_time.localeCompare(Ve.scheduled_time):ze.scheduled_time?-1:Ve.scheduled_time?1:ze.id.localeCompare(Ve.id)}}});if(!E){const ze=Ke.filter(ft=>!ft.completed),Ve=Ke.filter(ft=>ft.completed);Ke=[...ze,...Ve]}return Ke};return{ritualTasks:te(F),questTasks:te(pe)}},[s,X,E]),De=n.useMemo(()=>Qe.filter(F=>!!F.scheduled_time).sort((F,pe)=>(F.scheduled_time||"").localeCompare(pe.scheduled_time||"")),[Qe]),ve=n.useMemo(()=>Qe.filter(F=>!F.scheduled_time),[Qe]),Z=n.useMemo(()=>[...De,...ve],[De,ve]),Q=n.useMemo(()=>[...Z,...Me],[Z,Me]),J=y5({containerRef:M,snapConfig:l5,onDrop:(F,pe)=>{const te=qh(F,Q,{[F]:pe}).size;w?.(F,pe),te>0&&V(`Overlap: ${te} quest${te===1?"":"s"}`)}}),de=J.dragVisualOffsetY??J.dragOffsetY,oe=J.dragEdgeOffsetY??de,Fe=n.useRef(new Map),[Je,pt]=n.useState(null),nt=wo(0),Ct=n.useRef(Lh),lt=n.useRef(0),me=n.useRef(null),Ae=n.useRef(Fo),Ue=n.useRef(null),xt=n.useRef(null),Pt=n.useRef(!1),[ge,Le]=n.useState(()=>Ka(ae(new Date,"HH:mm"))??0),He=$r(a,new Date),wt=n.useRef(null),ht=n.useRef(null),qt=n.useRef(r),St=n.useRef(He),Xs=n.useRef(!1);n.useEffect(()=>{const F=J.isDragging?J.previewTime??null:null;wt.current!==F&&(wt.current=F,T?.(F))},[T,J.isDragging,J.previewTime]),n.useEffect(()=>()=>{T?.(null)},[T]);const Ns=n.useCallback(()=>{Ue.current!==null&&(window.clearTimeout(Ue.current),Ue.current=null)},[]),ns=n.useCallback(()=>{xt.current!==null&&(window.clearInterval(xt.current),xt.current=null)},[]),Lt=n.useCallback(()=>{lt.current=0,me.current=null,Ae.current=Fo,Pt.current=!1,Ns(),ns()},[Ns,ns]),Os=n.useCallback((F,pe,te)=>{ns(),Ae.current=Math.max(1,te),Pt.current=!0,xt.current=window.setInterval(()=>{if(!J.isDragging||lt.current!==F){Pt.current=!1,ns();return}const le=Math.max(1,Ae.current);for(let Ke=0;Ke<le;Ke+=1)if(!J.nudgeByFineStep(F)){Pt.current=!1,ns();return}},pe)},[ns,J.isDragging,J.nudgeByFineStep]),Js=n.useCallback((F,pe)=>{if(!J.isDragging||F===0||pe===null){Lt();return}const te=pe.repeatMs,le=pe.stepMultiplier,Ke=lt.current,ze=me.current,Ve=Ae.current,ft=Ke!==F,it=ze!==te,We=Ve!==le;if(lt.current=F,me.current=te,Ae.current=le,ft){Pt.current=!1,Ns(),ns(),Ue.current=window.setTimeout(()=>{if(Ue.current=null,!J.isDragging||lt.current!==F)return;const _t=me.current;if(_t===null){Lt();return}const hs=Math.max(1,Ae.current);Os(F,_t,hs)},m2);return}Pt.current&&(it||We)&&Os(F,te,le)},[Ns,ns,Os,Lt,J.isDragging]);n.useLayoutEffect(()=>{if(!J.draggingTaskId){pt(null),nt.set(0);return}let F=null;const pe=()=>{const te=Fe.current.get(J.draggingTaskId);if(!te)return!1;const le=te.getBoundingClientRect(),Ke=le.width>0?le.width:te.clientWidth||te.offsetWidth||1,ze=le.height>0?le.height:te.clientHeight||te.offsetHeight||1;return pt({taskId:J.draggingTaskId,top:le.top,left:le.left,width:Ke,height:ze}),Ct.current=xd(),!0};return!pe()&&typeof window<"u"&&(F=window.requestAnimationFrame(()=>{pe()})),()=>{F!==null&&typeof window<"u"&&window.cancelAnimationFrame(F)}},[nt,J.draggingTaskId]),n.useEffect(()=>{if(!J.isDragging||!Je){nt.set(0),Lt();return}const F=(Ve,ft)=>{const it=window.visualViewport,We=it?.height??window.innerHeight,_t=it?.offsetTop??0,hs=_t+We,Ot=A.current?.getBoundingClientRect(),Gt=document.querySelector('nav[aria-label="Main navigation"]')?.getBoundingClientRect(),da=!!Ot&&Number.isFinite(Ot.top)&&Number.isFinite(Ot.bottom)&&Ot.bottom>Ot.top+1,fr=!!Gt&&Number.isFinite(Gt.top)&&Number.isFinite(Gt.bottom)&&Gt.bottom>Gt.top,Oa=da?Ot.top:_t,cn=da?Ot.bottom:hs,Ye=hs-Ct.current-Je.height,et=cn-Je.height-d2,Yt=fr?Gt.top-Je.height-u2:null,gr=Math.max(_t,Oa)+c2,dn=Yt!==null?Math.min(Yt,Ye):da?et:Ye,un=Math.max(gr,dn),xr=gr-Je.top,yr=un-Je.top,ji=Math.max(xr,Math.min(yr,Ve));nt.set(ji);const Ni=Math.max(xr,Math.min(yr,ft)),ki=ft-Ni,Rf=ki>Oo?1:ki<-Oo?-1:0,If=j2(Math.abs(ki));Js(Rf,If)};F(de.get(),oe.get());const pe=de.on("change",Ve=>{F(Ve,oe.get())}),te=oe===de?null:oe.on("change",Ve=>{F(de.get(),Ve)}),le=()=>F(de.get(),oe.get());window.addEventListener("resize",le);const Ke=window.visualViewport,ze=!!Ke&&typeof Ke.addEventListener=="function"&&typeof Ke.removeEventListener=="function";return ze&&(Ke.addEventListener("resize",le),Ke.addEventListener("scroll",le)),()=>{pe(),te?.(),Lt(),window.removeEventListener("resize",le),ze&&(Ke.removeEventListener("resize",le),Ke.removeEventListener("scroll",le))}},[oe,nt,Je,de,Lt,Js,J.isDragging]),n.useEffect(()=>{J.isDragging||Lt()},[Lt,J.isDragging]),n.useEffect(()=>()=>{Lt()},[Lt]),n.useEffect(()=>{if(!He)return;const F=()=>{const te=Ka(ae(new Date,"HH:mm"))??0;Le(te)};F();const pe=window.setInterval(F,6e4);return()=>window.clearInterval(pe)},[He,a]);const je=n.useMemo(()=>a2(De),[De]),dt=n.useMemo(()=>new Map(De.map(F=>[F.id,F])),[De]),vt=n.useMemo(()=>{if(je.orderedTaskIds.length===0)return De;const F=[];for(const pe of je.orderedTaskIds){const te=dt.get(pe);te&&F.push(te)}return F.length>0?F:De},[je.orderedTaskIds,De,dt]),at=n.useMemo(()=>{const F=He,te=[...De.map(We=>Ka(We.scheduled_time)).filter(We=>We!==null)].sort((We,_t)=>We-_t),le=te.length>0?te[0]:o2;let Ke=M2(te,le);te.length>0&&(Ke=Ke.filter(We=>We>le));const ze=Math.max(le,Math.min(fa,ge));if(F&&te.length===0){const We=Math.floor(ze/ga)*ga,_t=We+ga;We>=le&&We<=fa&&Ke.push(We),_t>=le&&_t<=fa&&Ke.push(_t)}const Ve=Array.from(new Set(Ke)).sort((We,_t)=>We-_t),ft=F?A2(Ve,ge):new Map(Ve.map(We=>[We,Va])),it=new Map;for(const We of Ve)it.set(We,{id:`timeline-marker-placeholder-${N2(We)}`,minute:We,time:$o(We),kind:"placeholder",emphasis:ft.get(We)??Va});if(F){const We=Math.max(0,Math.min(fa,ge));it.set(We,{id:"timeline-marker-now",minute:We,time:$o(We),kind:"now",emphasis:Ga})}return Array.from(D2(it,te).values())},[He,ge,De]),Wt=n.useMemo(()=>[...at.map(pe=>({kind:"marker",marker:pe,minute:pe.minute,sortKey:`0-${pe.minute}-${pe.id}`})),...vt.map(pe=>{const te=Ka(pe.scheduled_time);return te===null?null:{kind:"task",task:pe,minute:te,sortKey:`1-${te}-${pe.id}`}}).filter(pe=>!!pe)].sort((pe,te)=>pe.minute!==te.minute?pe.minute-te.minute:pe.sortKey.localeCompare(te.sortKey)).map(pe=>pe.kind==="marker"?{kind:"marker",marker:pe.marker}:{kind:"task",task:pe.task}),[vt,at]),Ne=n.useMemo(()=>Wt.some(F=>F.kind==="marker"&&F.marker.kind==="now"),[Wt])&&s.length>0;n.useLayoutEffect(()=>{if(typeof window>"u")return;const F=()=>{const Ke=A.current;if(!Ke){q(null);return}const ze=window.visualViewport?.height??window.innerHeight,Ve=xd(),ft=Math.floor(ze-Ke.getBoundingClientRect().top-Ve);Number.isFinite(ft)&&q(Math.max(120,ft))},pe=window.requestAnimationFrame(F);F(),window.addEventListener("resize",F);const te=window.visualViewport,le=!!te&&typeof te.addEventListener=="function"&&typeof te.removeEventListener=="function";return le&&(te.addEventListener("resize",F),te.addEventListener("scroll",F)),()=>{window.cancelAnimationFrame(pe),window.removeEventListener("resize",F),le&&(te.removeEventListener("resize",F),te.removeEventListener("scroll",F))}},[ne,Ne,He,s.length,Wt.length]),n.useEffect(()=>{const F=He,pe=r&&!qt.current,te=F&&!St.current,le=Ne&&!Xs.current;if(r&&F&&Ne&&!J.isDragging&&(pe||te||le)&&ht.current&&typeof window<"u"){const ze=A.current;if(ze&&ze.scrollHeight>ze.clientHeight+1){const Ve=ht.current.getBoundingClientRect(),ft=ze.getBoundingClientRect(),it=Ve.top-ft.top+Ve.height/2,We=ze.scrollTop+it-ze.clientHeight*gd,_t=Math.max(0,ze.scrollHeight-ze.clientHeight);ze.scrollTo({top:Math.max(0,Math.min(_t,We)),behavior:"smooth"})}else{const Ve=ht.current.getBoundingClientRect(),ft=Ve.top+Ve.height/2,it=Math.max(0,window.scrollY+ft-window.innerHeight*gd);window.scrollTo({top:it,behavior:"smooth"})}}qt.current=r,St.current=F,Xs.current=Ne},[Ne,He,r,J.isDragging]);const rt=n.useMemo(()=>J5(Q),[Q]),ut=n.useMemo(()=>J.draggingTaskId?dt.get(J.draggingTaskId)??null:null,[dt,J.draggingTaskId]),is=n.useMemo(()=>ut?je.byTaskId.get(ut.id)??null:null,[ut,je.byTaskId]),Tt=!!(J.isDragging&&Je&&ut&&Je.taskId===ut.id),ln=is?yd(is.laneIndex,is.overlapCount):0,os=ut?rt.get(ut.id)?.size??0:0,jl=n.useMemo(()=>{const F=[],pe=new Map;for(const te of Me){const le=te.epic_id;le&&(pe.has(le)||pe.set(le,[]),pe.get(le).push(te))}for(const te of g){const le=pe.get(te.id);!le||le.length===0||F.push({epicId:te.id,title:te.title,progress:Math.round(te.progress_percentage??0),daysLeft:md(te.end_date),rituals:le,completedCount:le.filter(Ke=>!!Ke.completed).length,epic:te})}return F},[Me,g]);n.useEffect(()=>{se(F=>{const pe=new Set(F);let te=!1;for(const le of g)pe.has(le.id)||(pe.add(le.id),te=!0);return te?pe:F})},[g]);const Tf=n.useCallback(F=>{se(pe=>{const te=new Set(pe);return te.has(F)?te.delete(F):te.add(F),te})},[]),Mf=s.reduce((F,pe)=>{if(!pe.completed)return F;const te=pe.is_main_quest?Math.round(pe.xp_reward*Eo):pe.xp_reward;return F+te},0),Df=c>0?l/c*100:0,Af=c>0&&l===c,Nl=async F=>{try{await ws.impact({style:F})}catch{}},kl=n.useCallback(F=>{const pe=hd(F);return!!(F.subtasks&&F.subtasks.length>0||pe.length>0||F.notes||F.priority||F.estimated_duration||F.is_recurring&&F.recurrence_pattern||F.difficulty||F.category)},[]),Cl=n.useCallback((F,pe)=>{pe.stopPropagation(),W(te=>{const le=new Set(te);return le.has(F)?le.delete(F):le.add(F),le})},[]),Pf=F=>{switch(F){case"mind":return Ds;case"body":return Ko;case"soul":return aa;default:return null}},_i=n.useCallback((F,pe,te=0)=>{const le=!!F.completed||fe.has(F.id),Ke=!!F.habit_source_id,ze=F.is_main_quest?Math.round(F.xp_reward*Eo):F.xp_reward,Ve=pe?.isDragging??!1,ft=pe?.isPressed??!1,it=pe?.isActivated??!1,We=B.has(F.id),_t=kl(F),hs=Pf(F.category),Ot=F.subtasks??[],Gt=hd(F),da=Ot.filter(Ye=>!!Ye.completed).length,fr=!!(hs&&F.category||F.difficulty||F.priority||F.estimated_duration||F.is_recurring&&F.recurrence_pattern),Oa=Ye=>{if(Ye.stopPropagation(),Ve||it||ft){Ye.preventDefault();return}le&&u?(U(et=>{const Yt=new Set(et);return Yt.delete(F.id),Yt}),$e(),Nl(Ut.Light),u(F.id,ze)):(U(et=>new Set(et).add(F.id)),Pe(),Nl(Ut.Medium),by(),ie(et=>new Set(et).add(F.id)),setTimeout(()=>{ie(et=>{const Yt=new Set(et);return Yt.delete(F.id),Yt})},600),i(F.id,!le,ze))};return e.jsxs(yl,{open:We,onOpenChange:()=>{},children:[e.jsxs("div",{className:I("flex items-center gap-3 transition-all relative group","select-none min-h-[46px]",Ke?"py-3":"py-2",le&&"opacity-60",Ve&&"cursor-grabbing",it&&!Ve&&"bg-muted/30 rounded-lg"),children:[e.jsx("div",{className:"relative ml-1 flex flex-col items-center self-start pt-0.5 gap-0",children:e.jsx("button",{"data-interactive":"true",onClick:Oa,onTouchStart:Ye=>{qe.current={x:Ye.touches[0].clientX,y:Ye.touches[0].clientY}},onTouchEnd:Ye=>{if(Ye.preventDefault(),Ye.stopPropagation(),qe.current){const et=Math.abs(Ye.changedTouches[0].clientX-qe.current.x),Yt=Math.abs(Ye.changedTouches[0].clientY-qe.current.y);et<5&&Yt<5&&Oa(Ye)}qe.current=null},className:I("relative flex items-center justify-center w-11 h-11 touch-manipulation transition-transform select-none","active:scale-95"),style:{WebkitTapHighlightColor:"transparent",touchAction:"manipulation"},"aria-label":le?"Mark task as incomplete":"Mark task as complete",role:"checkbox","aria-checked":le,children:R?e.jsx("div",{className:I("flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all",le?"bg-primary border-primary":"border-muted-foreground/40 hover:border-primary"),children:le&&e.jsx(Rt,{className:"w-4 h-4 text-primary-foreground"})}):e.jsx(P.div,{className:I("flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all",le?"bg-primary border-primary":"border-muted-foreground/40 hover:border-primary"),whileTap:!Ve&&!ft?{scale:.85}:{},children:le&&e.jsx(P.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:25},children:e.jsx(Rt,{className:"w-4 h-4 text-primary-foreground"})})})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[Ke&&e.jsx(nr,{className:"w-4 h-4 text-accent flex-shrink-0"}),e.jsx(A5,{text:F.task_text,className:I("text-sm flex-1",le&&"text-muted-foreground",le&&(ee.has(F.id)?"animate-strikethrough":"line-through"))})]}),F.scheduled_time&&e.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1 mt-0.5",children:[e.jsx(Ht,{className:"w-3 h-3"}),i2(F.scheduled_time)]}),te>0&&e.jsxs("span",{className:"mt-1 inline-flex items-center rounded-full border border-primary/35 bg-primary/10 px-2 py-0.5 text-[10px] font-semibold uppercase tracking-wide text-primary",children:["Overlaps: ",te]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[!le&&!Ve&&!it&&(p||v||y||b)&&e.jsxs(ad,{children:[e.jsx(rd,{asChild:!0,children:e.jsx(z,{"data-interactive":"true","aria-label":"Quest actions",variant:"ghost",size:"icon",className:"h-9 w-9 -m-1.5 opacity-100 md:opacity-0 md:group-hover:opacity-100 md:group-focus-within:opacity-100 md:focus-visible:opacity-100 transition-opacity touch-manipulation",onClick:Ye=>Ye.stopPropagation(),children:e.jsx(ix,{className:"w-4 h-4"})})}),e.jsxs(Ro,{align:"end",className:"w-44",children:[p&&e.jsxs(Hs,{onClick:Ye=>{Ye.stopPropagation(),p(F)},children:[e.jsx(Hu,{className:"w-4 h-4 mr-2"}),"Edit quest"]}),v&&e.jsxs(Hs,{onClick:Ye=>{Ye.stopPropagation(),v(F.id)},children:[e.jsx(Uu,{className:"w-4 h-4 mr-2"}),j?.(F.id)?"Re-send to calendar":"Send to calendar"]}),b&&!Ke&&e.jsxs(Hs,{onClick:Ye=>{Ye.stopPropagation(),b(F.id)},children:[e.jsx(ox,{className:"w-4 h-4 mr-2"}),"Move to tomorrow"]}),y&&e.jsxs(Hs,{className:"text-destructive focus:text-destructive",onClick:Ye=>{Ye.stopPropagation(),y(F.id)},children:[e.jsx(oa,{className:"w-4 h-4 mr-2"}),"Delete quest"]})]})]}),F.is_main_quest&&e.jsx(Oe,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 bg-primary/10 border-primary/30",children:"Main"}),e.jsxs("span",{className:"text-sm font-bold text-stardust-gold/80",children:["+",ze]}),_t&&e.jsx(z,{"data-interactive":"true",variant:"ghost",size:"icon",className:"h-7 w-7 -m-1 flex-shrink-0",onClick:Ye=>Cl(F.id,Ye),children:e.jsx(Ws,{className:I("w-4 h-4 text-muted-foreground transition-transform duration-200",We&&"rotate-180")})})]})]}),e.jsx(xi,{children:e.jsxs("div",{className:"pl-8 pr-2 pb-2 space-y-2",children:[Ot.length>0&&e.jsxs("div",{className:"space-y-1.5 rounded-md border border-border/40 bg-muted/20 p-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-[11px] font-medium uppercase tracking-wide text-muted-foreground",children:"Subtasks"}),e.jsxs("p",{className:"text-[11px] text-muted-foreground",children:[da,"/",Ot.length]})]}),e.jsx("div",{className:"space-y-1",children:Ot.map(Ye=>e.jsxs("label",{className:"flex items-center gap-2 rounded-sm px-1 py-1 text-xs",children:[e.jsx(ka,{checked:!!Ye.completed,onCheckedChange:et=>{O.mutate({taskId:F.id,subtaskId:Ye.id,completed:!!et})},onClick:et=>et.stopPropagation(),className:"h-3.5 w-3.5"}),e.jsx("span",{className:I("text-xs",Ye.completed&&"text-muted-foreground line-through"),children:Ye.title})]},Ye.id))})]}),Gt.length>0&&e.jsxs("div",{className:"space-y-1.5 rounded-md border border-border/40 bg-muted/20 p-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("p",{className:"text-[11px] font-medium uppercase tracking-wide text-muted-foreground",children:"Attachments"}),e.jsx("p",{className:"text-[11px] text-muted-foreground",children:Gt.length})]}),e.jsx("div",{className:"space-y-1",children:Gt.map((Ye,et)=>e.jsxs("a",{href:Ye.fileUrl,target:"_blank",rel:"noreferrer",className:"flex items-center gap-2 rounded-sm px-1 py-1 text-xs text-muted-foreground transition-colors hover:bg-muted/40 hover:text-foreground",children:[Ye.isImage?e.jsx(Ou,{className:"h-3.5 w-3.5 flex-shrink-0"}):e.jsx(Lu,{className:"h-3.5 w-3.5 flex-shrink-0"}),e.jsx("span",{className:"truncate",children:Ye.fileName})]},`${Ye.fileUrl}-${et}`))})]}),F.notes&&(R?e.jsxs("div",{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(Lr,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-xs leading-relaxed whitespace-pre-line",children:No(F.notes)})]}):e.jsxs(P.div,{className:"flex items-start gap-2 text-sm text-muted-foreground",children:[e.jsx(Lr,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-xs leading-relaxed whitespace-pre-line",children:No(F.notes)})]})),fr&&e.jsxs("div",{className:"flex flex-wrap gap-1.5",children:[hs&&F.category&&e.jsxs(Oe,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 gap-1 border-muted-foreground/30",children:[e.jsx(hs,{className:"w-3 h-3"}),F.category]}),F.difficulty&&e.jsx(Oe,{variant:"outline",className:I("text-xs px-1.5 py-0.5 h-5",F.difficulty==="easy"&&"bg-green-500/10 text-green-500 border-green-500/30",F.difficulty==="medium"&&"bg-yellow-500/10 text-yellow-500 border-yellow-500/30",F.difficulty==="hard"&&"bg-red-500/10 text-red-500 border-red-500/30"),children:F.difficulty}),F.priority&&e.jsxs(Oe,{variant:"outline",className:I("text-xs px-1.5 py-0.5 h-5",F.priority==="high"&&"bg-red-500/10 text-red-500 border-red-500/30",F.priority==="medium"&&"bg-yellow-500/10 text-yellow-500 border-yellow-500/30",F.priority==="low"&&"bg-blue-500/10 text-blue-500 border-blue-500/30"),children:[F.priority," priority"]}),F.estimated_duration&&e.jsxs(Oe,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 gap-1 border-muted-foreground/30",children:[e.jsx(ti,{className:"w-3 h-3"}),F.estimated_duration,"m"]}),F.is_recurring&&F.recurrence_pattern&&e.jsxs(Oe,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 gap-1 bg-accent/10 text-accent border-accent/30",children:[e.jsx(nr,{className:"w-3 h-3"}),Ps(F.recurrence_pattern)]})]})]})})]})},[i,u,p,v,j,y,b,B,kl,Cl,ee,fe,O,R,Pe,$e]);return e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"relative px-2 py-2 overflow-visible",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>K(!0),className:"flex items-center gap-1.5 hover:opacity-80 transition-opacity",children:e.jsx("span",{className:"text-lg font-bold",children:r2(a,"MMM d, yyyy","Invalid date")})}),d>0&&e.jsxs("div",{className:I("flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",d>=30?"bg-stardust-gold/20 text-stardust-gold":d>=14?"bg-celestial-blue/20 text-celestial-blue":"bg-orange-500/10 text-orange-400"),children:[e.jsx(es,{className:"h-3.5 w-3.5"}),d]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[c>0&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(G5,{percent:Df,size:24,strokeWidth:2.5}),e.jsxs("span",{className:"text-xs font-medium text-muted-foreground",children:[l,"/",c]})]}),e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(ru,{className:I("h-4 w-4",Af?"text-stardust-gold":"text-stardust-gold/70")}),e.jsx("span",{className:"font-semibold text-stardust-gold",children:Mf})]})]})]}),e.jsx(Re,{children:ne>1&&e.jsxs(P.div,{initial:R?{opacity:1}:{opacity:0,y:8,scale:.96},animate:{opacity:1,y:0,scale:1},exit:R?{opacity:0}:{opacity:0,y:-6,scale:.98},transition:{duration:R?.1:.24},className:I("mb-3 relative overflow-hidden rounded-xl border px-3 py-2","bg-gradient-to-r from-stardust-gold/12 via-primary/10 to-stardust-gold/12 border-stardust-gold/30",G&&!R&&"animate-combo-pop"),"data-testid":"combo-banner",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(es,{className:"w-4 h-4 text-stardust-gold"}),e.jsxs("span",{className:"text-sm font-semibold text-stardust-gold",children:["Combo x",ne]})]}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Keep completing quests"})]}),!R&&G&&e.jsxs("div",{className:"pointer-events-none absolute inset-0",children:[e.jsx("span",{className:"absolute left-4 top-2 h-1.5 w-1.5 rounded-full bg-stardust-gold animate-combo-particle"}),e.jsx("span",{className:"absolute left-1/2 top-1 h-1 w-1 rounded-full bg-primary animate-combo-particle [animation-delay:120ms]"}),e.jsx("span",{className:"absolute right-5 bottom-2 h-1.5 w-1.5 rounded-full bg-celestial-blue animate-combo-particle [animation-delay:200ms]"})]})]},"combo-banner")}),s.length===0?e.jsxs("div",{className:"text-center py-6",children:[e.jsx(ei,{className:"w-10 h-10 mx-auto text-muted-foreground/30 mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"No tasks for this day"}),e.jsxs("p",{className:"text-xs text-muted-foreground/70",children:["Tap ",e.jsx(qr,{className:"w-3 h-3 inline"})," to add your first quest"]}),e.jsxs(z,{variant:"outline",size:"sm",className:"mt-3",onClick:o,children:[e.jsx(qr,{className:"w-3 h-3 mr-1.5"}),"Add Quest"]})]}):e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:s.length>0&&e.jsxs(ad,{children:[e.jsx(rd,{asChild:!0,children:e.jsx("button",{className:"p-1 rounded opacity-40 hover:opacity-70 transition-opacity flex-shrink-0",children:e.jsx(cx,{className:"w-3 h-3"})})}),e.jsxs(Ro,{align:"start",className:"w-28",children:[e.jsx(Hs,{onClick:()=>Y("custom"),className:I("text-xs",X==="custom"&&"bg-accent/10"),children:"Custom"}),e.jsx(Hs,{onClick:()=>Y("time"),className:I("text-xs",X==="time"&&"bg-accent/10"),children:"Time"}),e.jsx(Hs,{onClick:()=>Y("priority"),className:I("text-xs",X==="priority"&&"bg-accent/10"),children:"Priority"}),e.jsx(Hs,{onClick:()=>Y("xp"),className:I("text-xs",X==="xp"&&"bg-accent/10"),children:"XP"})]})]})}),Wt.length>0&&e.jsx("div",{children:e.jsx("div",{ref:$,className:"overflow-y-auto overscroll-contain pr-1",style:L?{maxHeight:`${L}px`}:void 0,"data-testid":"scheduled-timeline-pane",children:Wt.map((F,pe)=>{if(F.kind==="marker"){const et=F.marker,Yt=pe>0?Wt[pe-1]:null,gr=pe<Wt.length-1?Wt[pe+1]:null,dn=Yt?.kind==="task"?Ka(Yt.task.scheduled_time):null,un=gr?.kind==="task"?Ka(gr.task.scheduled_time):null,xr=dn!==null&&un!==null&&dn<et.minute&&et.minute<un,yr=et.kind==="placeholder"?.72+et.emphasis*.28:1,ji=et.kind==="placeholder"?.25+et.emphasis*.65:1,Ni=xr?`translateY(-50%) scale(${yr})`:`scale(${yr})`;return e.jsx("div",{className:I("pointer-events-none select-none",xr&&"h-0 overflow-visible"),"data-testid":et.id,children:e.jsx("div",{ref:et.kind==="now"?ht:void 0,style:{opacity:ji,transform:Ni,transformOrigin:"left center"},children:e.jsx(mo,{rowKind:"marker",time:et.time,tone:et.kind==="now"?"now":"default",showLine:pe>0,isLast:pe===Wt.length-1,children:e.jsx("div",{className:"h-px"})})})},et.id)}const te=F.task,le=J.draggingTaskId===te.id,Ke=J.longPressTaskId===te.id,ze=le||Ke,Ve=J.isDragging,ft=J.justDroppedId===te.id,it=le&&Tt,We=je.byTaskId.get(te.id),_t=We?.laneIndex,hs=We?.laneCount,Ot=We?yd(We.laneIndex,We.overlapCount):0,Gt=te.scheduled_time&&!te.completed?J.getRowDragProps(te.id,te.scheduled_time):void 0,da=!!Gt,fr=rt.get(te.id)?.size??0,Oa={WebkitUserSelect:"none",userSelect:"none",WebkitTouchCallout:"none",touchAction:le&&!it?"none":"pan-y",pointerEvents:Ve&&!le?"none":"auto",opacity:it?0:Ve&&!le?.7:1,boxShadow:ze&&!it?"0 15px 30px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -4px rgba(0, 0, 0, 0.15)":"none",backgroundColor:ze&&!it?"hsl(var(--background))":"transparent",borderRadius:ze&&!it?12:0,transition:"none",willChange:le&&!it?"transform":void 0},cn=e.jsx(mo,{rowKind:"task",time:te.scheduled_time,overrideTime:le?J.previewTime:void 0,showLine:pe>0,isLast:pe===Wt.length-1,isDragTarget:le,durationMinutes:te.estimated_duration,laneIndex:_t,laneCount:hs,overlapCount:We?.overlapCount,className:I(da&&!le&&"cursor-grab active:cursor-grabbing",le&&"cursor-grabbing"),"data-testid":`timeline-row-${te.id}`,...Gt,children:_i(te,void 0,fr)}),Ye=!R&&ft&&!le?{scale:[1,1.02,.98,1],y:[0,-2,1,0]}:void 0;return e.jsx(P.div,{ref:et=>{et?Fe.current.set(te.id,et):Fe.current.delete(te.id)},className:I("relative",ze&&!it&&"z-50"),layout:!le||it,animate:Ye,transition:Ye?{duration:.25,ease:[.25,.1,.25,1],layout:{type:"spring",stiffness:420,damping:34,mass:.7}}:{layout:{type:"spring",stiffness:420,damping:34,mass:.7}},"data-timeline-lane":_t,"data-timeline-lane-count":hs,"data-timeline-overlap":We?.overlapCount,style:{...Oa,x:Ot,y:le&&!it?de:0},children:cn},te.id)})})})]}),jl.length>0&&e.jsxs("div",{className:"mt-6 pt-4 border-t border-border/30",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"w-9 flex-shrink-0"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs font-medium text-muted-foreground uppercase tracking-wide",children:[e.jsx(It,{className:"h-3 w-3"}),"Campaigns"]}),e.jsx("div",{className:"flex-1 border-t border-dashed border-border/40"})]}),e.jsx("div",{className:"space-y-2",children:jl.map(F=>{const pe=ce.has(F.epicId);return e.jsxs("div",{className:"rounded-xl border border-border/30 bg-card/30 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2.5",children:[e.jsx(ud,{epic:{id:F.epic.id,title:F.epic.title,description:F.epic.description??void 0,progress_percentage:F.epic.progress_percentage??0,target_days:F.epic.target_days,start_date:F.epic.start_date,end_date:F.epic.end_date,epic_habits:F.epic.epic_habits},children:e.jsxs("button",{className:"flex items-center gap-2 min-w-0 flex-1 text-left focus:outline-none",children:[e.jsx(It,{className:"w-4 h-4 text-primary shrink-0"}),e.jsx("span",{className:"text-sm font-medium truncate",children:F.title})]})}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsxs("span",{className:"text-primary font-bold text-xs",children:[F.progress,"%"]}),F.daysLeft!==null&&e.jsxs("span",{className:"text-muted-foreground text-xs",children:[F.daysLeft,"d"]}),e.jsxs(Oe,{variant:"secondary",className:"text-xs h-5 px-1.5",children:[F.completedCount,"/",F.rituals.length]}),e.jsx("button",{onClick:te=>{te.stopPropagation(),Tf(F.epicId)},className:"p-1 -m-1 focus:outline-none",children:pe?e.jsx(Wo,{className:"w-4 h-4 text-muted-foreground"}):e.jsx(Ws,{className:"w-4 h-4 text-muted-foreground"})})]})]}),pe&&e.jsx("div",{className:"border-t border-border/20 px-2 pb-1",children:F.rituals.map(te=>{const le=J.draggingTaskId===te.id,Ke=J.isDragging,ze=rt.get(te.id)?.size??0;return e.jsx(P.div,{className:I("relative",le&&"z-50"),style:{y:le?J.dragOffsetY:0,pointerEvents:Ke&&!le?"none":"auto",opacity:Ke&&!le?.7:1},children:_i(te,void 0,ze)},te.id)})})]},F.epicId)})})]}),g&&g.length>0&&Me.length===0&&e.jsx("div",{className:"mt-4 pt-3 border-t border-border/20 space-y-2",children:g.map(F=>{const pe=Math.round(F.progress_percentage??0),te=md(F.end_date);return e.jsx(ud,{epic:{id:F.id,title:F.title,description:F.description??void 0,progress_percentage:F.progress_percentage??0,target_days:F.target_days,start_date:F.start_date,end_date:F.end_date,epic_habits:F.epic_habits},children:e.jsx("button",{className:"w-full text-left focus:outline-none",children:e.jsx("div",{className:"flex items-center justify-between py-2 px-3 rounded-xl hover:bg-muted/30 border border-border/30 bg-card/30",children:e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx(It,{className:"w-4 h-4 text-primary shrink-0"}),e.jsx("span",{className:"text-sm font-medium truncate max-w-[140px]",children:F.title}),e.jsxs("span",{className:"text-primary font-bold text-xs shrink-0",children:[pe,"%"]}),te!==null&&e.jsxs("span",{className:"text-muted-foreground text-xs shrink-0",children:["Â· ",te,"d"]})]})})})},F.id)})})]}),Tt&&ut&&Je&&typeof document<"u"?lx.createPortal(e.jsx(P.div,{"data-testid":"timeline-drag-overlay",className:"pointer-events-none fixed z-[120] rounded-xl bg-background shadow-[0_18px_32px_-10px_rgba(0,0,0,0.35),0_10px_16px_-8px_rgba(0,0,0,0.2)]",style:{top:Je.top,left:Je.left,width:Je.width,x:ln,y:nt},children:e.jsx(mo,{rowKind:"task",time:ut.scheduled_time,overrideTime:J.previewTime??void 0,isDragTarget:!0,durationMinutes:ut.estimated_duration,laneIndex:is?.laneIndex,laneCount:is?.laneCount,overlapCount:is?.overlapCount,className:"cursor-grabbing","data-testid":`timeline-drag-overlay-row-${ut.id}`,children:_i(ut,void 0,os)})}),document.body):null,e.jsx(M5,{open:H,onOpenChange:K,selectedDate:a,onDateSelect:F=>{m&&m(F)},tasks:h,milestones:f,onTaskDrop:()=>{},onTimeSlotLongPress:x}),e.jsx(D5,{rail:J.zoomRail})]})}),bd=80,R2=14,I2=8,q2=3e3,L2=500,O2=async t=>{try{await ws.impact({style:t})}catch{}},Cn=(t,s)=>{const a=Math.max(7,s),r=ir(t),i=Math.floor(a/2),o=ai(r,i),l=Ts(o,a-1);return{start:o,end:l}},F2=n.memo(function({selectedDate:s,onDateSelect:a,tasksPerDay:r={},daysToShow:i=14,isActive:o=!0}){const l=n.useRef(null),c=n.useRef(null),d=n.useRef(null),u=n.useRef(!1),p=n.useRef(!1),h=n.useRef(!1),f=n.useRef(null),m=n.useRef(null),[g,y]=n.useState(()=>Cn(s,i).start),[b,w]=n.useState(()=>Cn(s,i).end),[x,v]=n.useState(0),[j,T]=n.useState(0),[S,N]=n.useState(!1),D=Math.max(R2,i),R=n.useMemo(()=>ae(s,"yyyy-MM-dd"),[s]);n.useEffect(()=>{const H=Cn(s,i);y(H.start),w(H.end)},[i]),n.useEffect(()=>{const H=s.getTime();if(!(H<g.getTime()||H>b.getTime()))return;const X=Cn(s,i);y(X.start),w(X.end)},[i,b,g,s]),n.useEffect(()=>{if(typeof window>"u"||typeof window.matchMedia!="function")return;const H=window.matchMedia("(prefers-reduced-motion: reduce)");N(H.matches);const K=X=>{N(X.matches)};return typeof H.addEventListener=="function"?(H.addEventListener("change",K),()=>{H.removeEventListener("change",K)}):(H.addListener(K),()=>{H.removeListener(K)})},[]);const _=n.useMemo(()=>{const H=lm(b,g)+1;return Array.from({length:Math.max(1,H)},(K,X)=>Ts(g,X))},[b,g]),C=n.useCallback(H=>{const K=ae(H,"yyyy-MM-dd");return r[K]||0},[r]),E=n.useCallback(()=>{const H=l.current;if(!H)return null;const K=c.current;return K?.dataset.dateKey===R?K:H.querySelector(`button[data-date-pill='true'][data-date-key='${R}']`)},[R]),O=n.useCallback(()=>{const H=l.current;if(!H)return null;const K=E();if(!K)return null;const X=H.offsetWidth,Y=K.offsetWidth;return X===0||Y===0?null:Math.max(0,X/2-Y/2)},[E]),M=n.useCallback(()=>{const H=O();H!==null&&v(K=>Math.abs(K-H)<.5?K:H)},[O]),A=n.useCallback(()=>{f.current!==null&&(window.clearTimeout(f.current),f.current=null)},[]),L=n.useCallback(()=>{m.current!==null&&(window.clearTimeout(m.current),m.current=null)},[]),q=n.useCallback(()=>{T(H=>H+1)},[]),$=n.useCallback(()=>{typeof window>"u"||(h.current=!0,A(),f.current=window.setTimeout(()=>{h.current=!1,f.current=null},L2))},[A]),B=n.useCallback(()=>{if(o){if(typeof window>"u"){q();return}L(),m.current=window.setTimeout(()=>{m.current=null,q()},q2)}},[L,o,q]),W=n.useCallback(()=>{const H=l.current;if(!H)return;if(u.current){h.current||(p.current=!0);return}h.current||B();const{scrollLeft:K,clientWidth:X,scrollWidth:Y}=H;if(K<=bd){u.current=!0,p.current=!0,d.current={previousScrollWidth:Y,previousScrollLeft:K},y(ee=>ai(ee,D));return}K+X>=Y-bd&&(u.current=!0,p.current=!0,w(ee=>Ts(ee,D)))},[D,B]);return n.useLayoutEffect(()=>{const H=l.current;if(!H){u.current=!1;return}const K=d.current;if(K){const Y=H.scrollWidth-K.previousScrollWidth;H.scrollLeft=K.previousScrollLeft+Y,d.current=null}const X=typeof window<"u"?window.requestAnimationFrame(()=>{u.current=!1,p.current&&(p.current=!1,q())}):null;return()=>{X!==null&&window.cancelAnimationFrame(X)}},[b,g,q]),n.useLayoutEffect(()=>{M()},[_,s,o,M]),n.useEffect(()=>{if(typeof ResizeObserver>"u")return;const H=l.current;if(!H)return;const K=new ResizeObserver(()=>{M()});return K.observe(H),()=>{K.disconnect()}},[M]),n.useEffect(()=>{o||L()},[L,o]),n.useEffect(()=>()=>{L(),A(),h.current=!1},[A,L]),n.useLayoutEffect(()=>{if(!o)return;let H=null,K=!1;const X=Y=>{if(K)return;const ee=l.current,ie=E();if(!ee||!ie){Y>0&&typeof window<"u"&&(H=window.requestAnimationFrame(()=>{X(Y-1)}));return}const fe=ee.offsetWidth,U=ie.offsetWidth;if((fe===0||U===0)&&Y>0&&typeof window<"u"){H=window.requestAnimationFrame(()=>{X(Y-1)});return}if(fe===0||U===0)return;const ce=O();if(ce!==null&&Math.abs(ce-x)>=.5){v(ce),Y>0&&typeof window<"u"&&(H=window.requestAnimationFrame(()=>{X(Y-1)}));return}const ne=ie.offsetLeft-fe/2+U/2,xe=Math.max(0,ee.scrollWidth-fe),G=Math.min(Math.max(ne,0),xe);Math.abs(ee.scrollLeft-G)>.5&&$();try{ee.scrollTo({left:G,behavior:S?"auto":"smooth"})}catch{ee.scrollLeft=G}};return X(I2),()=>{K=!0,H!==null&&window.cancelAnimationFrame(H)}},[O,j,_,x,E,o,$,S,s]),e.jsxs("div",{ref:l,onScroll:W,className:I("flex gap-2 overflow-x-auto pb-2 scrollbar-hide -mx-1 px-1 transition-all duration-200"),style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:[e.jsx("div",{"aria-hidden":"true","data-testid":"date-pill-edge-spacer-start",className:"shrink-0",style:{width:`${x}px`}}),_.map(H=>{const K=$r(H,s),X=Vo(H),Y=C(H),ee=ae(H,"yyyy-MM-dd");return e.jsxs(P.button,{ref:K?c:void 0,"data-date-pill":"true","data-date-key":ee,onClick:async()=>{await O2(Ut.Light),a(H)},className:I("flex-shrink-0 flex flex-col items-center justify-center","min-w-[52px] h-16 rounded-xl transition-all duration-200","border border-border/50",K?"bg-gradient-to-br from-primary to-purple-500 text-white border-primary shadow-lg shadow-primary/25":"bg-card/50 hover:bg-card hover:border-primary/30",X&&!K&&"border-celestial-blue/50 ring-1 ring-celestial-blue/30 bg-celestial-blue/5"),animate:{scale:1,y:0},transition:{type:"spring",stiffness:400,damping:25},children:[e.jsx("span",{className:I("text-[10px] font-medium uppercase tracking-wide",K?"text-white/90":X?"text-celestial-blue":"text-muted-foreground"),children:ae(H,"EEE")}),e.jsx("span",{className:I("text-lg font-bold leading-tight",K?"text-white":X?"text-celestial-blue":"text-foreground"),children:ae(H,"d")}),e.jsx("div",{className:"flex gap-0.5 mt-0.5 h-1.5",children:Y>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:I("h-1.5 w-1.5 rounded-full",K?"bg-white/70":X?"bg-celestial-blue/60":"bg-stardust-gold/60")}),Y>1&&e.jsx("div",{className:I("h-1.5 w-1.5 rounded-full",K?"bg-white/50":X?"bg-celestial-blue/40":"bg-stardust-gold/40")}),Y>2&&e.jsx("div",{className:I("h-1.5 w-1.5 rounded-full",K?"bg-white/30":X?"bg-celestial-blue/20":"bg-stardust-gold/20")})]})})]},ee)}),e.jsx("div",{"aria-hidden":"true","data-testid":"date-pill-edge-spacer-end",className:"shrink-0",style:{width:`${x}px`}})]})}),$2=({onClick:t,className:s})=>e.jsx(z,{variant:"ghost",size:"icon",onClick:t,className:I("h-8 w-8 rounded-full bg-muted/50 hover:bg-muted text-muted-foreground hover:text-foreground transition-colors",s),"aria-label":"Page information",children:e.jsx(Qo,{className:"h-4 w-4"})}),B2=({open:t,onClose:s,title:a,icon:r,description:i,features:o,tip:l})=>e.jsx(as,{open:t,onOpenChange:s,children:e.jsxs(Qt,{className:"max-w-md",children:[e.jsxs(Is,{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(r,{className:"h-6 w-6 text-primary"})}),e.jsx(ps,{className:"text-2xl",children:a})]}),e.jsx(Vs,{className:"text-base",children:i})]}),e.jsx("div",{className:"space-y-3 py-4",children:o.map((c,d)=>e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-5 w-5 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0 mt-0.5",children:e.jsx(Rt,{className:"h-3 w-3 text-primary"})}),e.jsx("p",{className:"text-sm text-muted-foreground flex-1",children:c})]},d))}),l&&e.jsx("div",{className:"bg-accent/10 border border-accent/20 rounded-lg p-4",children:e.jsx("p",{className:"text-sm italic text-muted-foreground",children:l})}),e.jsx(z,{onClick:s,className:"w-full",children:"Got it!"})]})}),U2=n.memo(function({open:s,currentStreak:a,freezesAvailable:r,onUseFreeze:i,onResetStreak:o,onOpenChange:l,isResolving:c}){const[d,u]=n.useState(null),p=async()=>{u("freeze"),await i()},h=async()=>{u("reset"),await o()};return e.jsx(as,{open:s,onOpenChange:l,children:e.jsxs(Qt,{className:"sm:max-w-md bg-background/95 backdrop-blur-xl border-amber-500/30",hideCloseButton:!0,children:[e.jsxs(Is,{className:"text-center",children:[e.jsx(P.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},className:"mx-auto mb-4 p-4 rounded-full bg-amber-500/20 border border-amber-500/30",children:e.jsx(ca,{className:"w-10 h-10 text-amber-400"})}),e.jsx(ps,{className:"text-2xl font-bold text-center",children:"Your Streak is at Risk!"}),e.jsx(Vs,{className:"text-center text-muted-foreground",children:"You missed a day. What would you like to do?"})]}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs(P.div,{initial:{y:10,opacity:0},animate:{y:0,opacity:1},transition:{delay:.1},className:"flex items-center justify-center gap-3 p-4 rounded-xl bg-gradient-to-r from-orange-500/20 to-red-500/20 border border-orange-500/30",children:[e.jsx(es,{className:"w-8 h-8 text-orange-400"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-3xl font-bold text-foreground",children:a}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"day streak"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(P.div,{initial:{x:-20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.2},children:[e.jsx(z,{onClick:p,disabled:c||r<=0,className:"w-full h-auto py-4 px-4 bg-gradient-to-r from-cyan-500/20 to-blue-500/20 hover:from-cyan-500/30 hover:to-blue-500/30 border border-cyan-500/40 text-foreground",variant:"outline",children:e.jsxs("div",{className:"flex items-center gap-4 w-full",children:[e.jsx("div",{className:"p-2 rounded-full bg-cyan-500/20",children:e.jsx(vu,{className:"w-6 h-6 text-cyan-400"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-semibold text-base",children:"Use Streak Freeze"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Keep your ",a,"-day streak alive"]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"text-sm font-medium text-cyan-400",children:[r," available"]})})]})}),r<=0&&e.jsx("p",{className:"text-xs text-muted-foreground text-center mt-1",children:"No freezes available. Freezes reset weekly."})]}),e.jsx(P.div,{initial:{x:20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.3},children:e.jsx(z,{onClick:h,disabled:c,className:"w-full h-auto py-4 px-4 bg-muted/30 hover:bg-muted/50 border border-border/50 text-foreground",variant:"outline",children:e.jsxs("div",{className:"flex items-center gap-4 w-full",children:[e.jsx("div",{className:"p-2 rounded-full bg-muted/30",children:e.jsx(be,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-semibold text-base",children:"Start Fresh"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Let the streak reset and begin anew"})]})]})})})]}),c&&e.jsx(P.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center text-sm text-muted-foreground",children:d==="freeze"?"Preserving your streak...":"Resetting streak..."})]})]})})}),Fh=n.forwardRef(({className:t,...s},a)=>e.jsx(em,{className:I("grid gap-2",t),...s,ref:a}));Fh.displayName=em.displayName;const qn=n.forwardRef(({className:t,...s},a)=>e.jsx(tm,{ref:a,className:I("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...s,children:e.jsx(dx,{className:"flex items-center justify-center",children:e.jsx(ei,{className:"h-2.5 w-2.5 fill-current text-current"})})}));qn.displayName=tm.displayName;const H2=({value:t,onChange:s})=>e.jsxs("div",{className:"space-y-3",children:[e.jsx(ct,{className:"text-sm font-bold",children:"Difficulty (affects XP reward)"}),e.jsxs(Fh,{value:t,onValueChange:s,className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(qn,{value:"easy",id:"easy",className:"peer sr-only"}),e.jsxs(ct,{htmlFor:"easy",className:"flex flex-col items-center gap-2 rounded-lg border-2 border-muted bg-background p-4 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary cursor-pointer transition-all",children:[e.jsx(bt,{className:"h-5 w-5 text-green-500"}),e.jsx("span",{className:"font-semibold",children:"Easy"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",qi.EASY," XP"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(qn,{value:"medium",id:"medium",className:"peer sr-only"}),e.jsxs(ct,{htmlFor:"medium",className:"flex flex-col items-center gap-2 rounded-lg border-2 border-muted bg-background p-4 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary cursor-pointer transition-all",children:[e.jsx(es,{className:"h-5 w-5 text-orange-500"}),e.jsx("span",{className:"font-semibold",children:"Medium"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",qi.MEDIUM," XP"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(qn,{value:"hard",id:"hard",className:"peer sr-only"}),e.jsxs(ct,{htmlFor:"hard",className:"flex flex-col items-center gap-2 rounded-lg border-2 border-muted bg-background p-4 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary cursor-pointer transition-all",children:[e.jsx(Vr,{className:"h-6 w-6 text-red-500"}),e.jsx("span",{className:"font-semibold",children:"Hard"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",qi.HARD," XP"]})]})]})]})]}),$h={jan:0,january:0,feb:1,february:1,mar:2,march:2,apr:3,april:3,may:4,jun:5,june:5,jul:6,july:6,aug:7,august:7,sep:8,sept:8,september:8,oct:9,october:9,nov:10,november:10,dec:11,december:11};function z2(t){return t>=1&&t<=6?"pm":t>=7&&t<=11?"am":t===12?"pm":"am"}function wd(t){let s=parseInt(t[1]);const a=t[2]?parseInt(t[2]):0;let r=t[3]?.toLowerCase();return!r&&s>=1&&s<=12&&(r=z2(s)),r==="pm"&&s<12&&(s+=12),r==="am"&&s===12&&(s=0),`${s.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}function K2(t){const s=t[1].toLowerCase(),a=parseInt(t[2]),r=$h[s];if(r===void 0||a<1||a>31)return ae(new Date,"yyyy-MM-dd");let i=Gs(new Date,r);return i=or(i,a),i<new Date&&(i=Gs(new Date(Xo(new Date)+1,0,1),r),i=or(i,a)),ae(i,"yyyy-MM-dd")}function Q2(t){const s=parseInt(t[1]),a=t[2].toLowerCase(),r=$h[a];if(r===void 0||s<1||s>31)return ae(new Date,"yyyy-MM-dd");let i=Gs(new Date,r);return i=or(i,s),i<new Date&&(i=Gs(new Date(Xo(new Date)+1,0,1),r),i=or(i,s)),ae(i,"yyyy-MM-dd")}function W2(t){const s=parseInt(t[1]),a=parseInt(t[2]),r=s-1,i=a;if(r<0||r>11||i<1||i>31)return ae(new Date,"yyyy-MM-dd");let o=Gs(new Date,r);return o=or(o,i),o<new Date&&(o=Gs(new Date(Xo(new Date)+1,0,1),r),o=or(o,i)),ae(o,"yyyy-MM-dd")}const Bh=[{regex:/\bat\s+(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i,handler:wd},{regex:/\b(\d{1,2})(?::(\d{2}))?\s*(am|pm)/i,handler:wd},{regex:/\b(?:first\s*thing|wake\s*up|early\s*morning|dawn|sunrise)\b/i,handler:()=>"06:00"},{regex:/\bmorning\b/i,handler:()=>"09:00"},{regex:/\bmid[- ]?morning\b/i,handler:()=>"10:00"},{regex:/\b(?:noon|midday|lunch(?:time)?)\b/i,handler:()=>"12:00"},{regex:/\bearly\s*afternoon\b/i,handler:()=>"13:00"},{regex:/\bafternoon\b/i,handler:()=>"14:00"},{regex:/\blate\s*afternoon\b/i,handler:()=>"16:00"},{regex:/\b(?:before\s*dinner|pre[- ]?dinner)\b/i,handler:()=>"17:00"},{regex:/\bevening\b/i,handler:()=>"18:00"},{regex:/\b(?:after\s*dinner|post[- ]?dinner)\b/i,handler:()=>"19:00"},{regex:/\bnight\b/i,handler:()=>"21:00"},{regex:/\b(?:before\s*bed|bedtime|end\s*of\s*day)\b/i,handler:()=>"22:00"},{regex:/\blate\s*night\b/i,handler:()=>"23:00"},{regex:/\bmidnight\b/i,handler:()=>"00:00"}],Uh=[{regex:/\bin\s+(\d+)\s*days?\b/i,handler:t=>ae(Ts(new Date,parseInt(t[1])),"yyyy-MM-dd")},{regex:/\bin\s+(\d+)\s*weeks?\b/i,handler:t=>ae(_o(new Date,parseInt(t[1])),"yyyy-MM-dd")},{regex:/\bin\s+(\d+)\s*months?\b/i,handler:t=>ae(Ja(new Date,parseInt(t[1])),"yyyy-MM-dd")},{regex:/\bnext\s+week\b/i,handler:()=>ae(_o(new Date,1),"yyyy-MM-dd")},{regex:/\btoday\b/i,handler:()=>ae(new Date,"yyyy-MM-dd")},{regex:/\btomorrow\b/i,handler:()=>ae(Ts(new Date,1),"yyyy-MM-dd")},{regex:/\bday\s*after\s*tomorrow\b/i,handler:()=>ae(Ts(new Date,2),"yyyy-MM-dd")},{regex:/\bthis\s*weekend\b/i,handler:()=>ae(Si(new Date),"yyyy-MM-dd")},{regex:/\b(?:end\s*of\s*week|eow)\b/i,handler:()=>ae(Ei(new Date),"yyyy-MM-dd")},{regex:/\b(?:start\s*of\s*(?:next\s*)?week|beginning\s*of\s*week)\b/i,handler:()=>ae(Ti(new Date),"yyyy-MM-dd")},{regex:/\b(?:end\s*of\s*month|eom)\b/i,handler:()=>ae(Fr(new Date),"yyyy-MM-dd")},{regex:/\bnext\s*month\b/i,handler:()=>ae(Or(Ja(new Date,1)),"yyyy-MM-dd")},{regex:/\b(?:in\s*a\s*)?fortnight\b/i,handler:()=>ae(Ts(new Date,14),"yyyy-MM-dd")},{regex:/\b(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|june?|july?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\s+(\d{1,2})(?:st|nd|rd|th)?\b/i,handler:K2},{regex:/\b(\d{1,2})(?:st|nd|rd|th)?\s+(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|june?|july?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\b/i,handler:Q2},{regex:/\b(\d{1,2})[/-](\d{1,2})\b/,handler:W2},{regex:/\bnext\s+monday\b/i,handler:()=>ae(Ti(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+tuesday\b/i,handler:()=>ae(Al(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+wednesday\b/i,handler:()=>ae(Pl(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+thursday\b/i,handler:()=>ae(Rl(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+friday\b/i,handler:()=>ae(Ei(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+saturday\b/i,handler:()=>ae(Si(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+sunday\b/i,handler:()=>ae(Il(new Date),"yyyy-MM-dd")},{regex:/\bmonday\b/i,handler:()=>ae(Ti(new Date),"yyyy-MM-dd")},{regex:/\btuesday\b/i,handler:()=>ae(Al(new Date),"yyyy-MM-dd")},{regex:/\bwednesday\b/i,handler:()=>ae(Pl(new Date),"yyyy-MM-dd")},{regex:/\bthursday\b/i,handler:()=>ae(Rl(new Date),"yyyy-MM-dd")},{regex:/\bfriday\b/i,handler:()=>ae(Ei(new Date),"yyyy-MM-dd")},{regex:/\bsaturday\b/i,handler:()=>ae(Si(new Date),"yyyy-MM-dd")},{regex:/\bsunday\b/i,handler:()=>ae(Il(new Date),"yyyy-MM-dd")}],Hh=[{regex:/\bfor\s+(\d+)\s*h(?:ours?)?\b/i,handler:t=>parseInt(t[1])*60},{regex:/\bfor\s+(\d+)\s*m(?:in(?:utes?)?)?\b/i,handler:t=>parseInt(t[1])},{regex:/\b(\d+)\s*h(?:ours?)?\s*(?:(\d+)\s*m(?:in)?s?)?\b/i,handler:t=>parseInt(t[1])*60+(t[2]?parseInt(t[2]):0)},{regex:/\b(\d+)\s*m(?:in(?:utes?)?)?\b/i,handler:t=>parseInt(t[1])},{regex:/\bhalf\s*(?:an?\s*)?hour\b/i,handler:()=>30},{regex:/\bquarter\s*(?:of\s*an?\s*)?hour\b/i,handler:()=>15},{regex:/\b(?:a\s*)?couple\s*(?:of\s*)?hours?\b/i,handler:()=>120},{regex:/\b(?:a\s*)?few\s*(?:of\s*)?hours?\b/i,handler:()=>180},{regex:/\b(?:a\s*)?few\s*(?:of\s*)?min(?:ute)?s?\b/i,handler:()=>10},{regex:/\b(?:all|full)\s*day\b/i,handler:()=>480},{regex:/\bhalf\s*day\b/i,handler:()=>240},{regex:/\bquick\b/i,handler:()=>15},{regex:/\bbrief\b/i,handler:()=>5},{regex:/\bpomodoro\b/i,handler:()=>25},{regex:/\bdeep\s*work\b/i,handler:()=>90},{regex:/\bsprint\b/i,handler:()=>45}],zh=[{regex:/\b(super\s+)?easy\b/i,result:"easy"},{regex:/\bsimple\b/i,result:"easy"},{regex:/\blight\b/i,result:"easy"},{regex:/\bbasic\b/i,result:"easy"},{regex:/\btrivial\b/i,result:"easy"},{regex:/\bhard\b/i,result:"hard"},{regex:/\bdifficult\b/i,result:"hard"},{regex:/\bchallenging\b/i,result:"hard"},{regex:/\bcomplex\b/i,result:"hard"},{regex:/\btough\b/i,result:"hard"},{regex:/\bintense\b/i,result:"hard"}],Kh=[{regex:/!{4,}/,priority:"urgent"},{regex:/!{3}/,priority:"high"},{regex:/!{2}/,priority:"medium"},{regex:/!1\b/i,priority:"urgent"},{regex:/!2\b/i,priority:"high"},{regex:/!3\b/i,priority:"medium"},{regex:/!4\b/i,priority:"low"},{regex:/\bp1\b/i,priority:"urgent"},{regex:/\bp2\b/i,priority:"high"},{regex:/\bp3\b/i,priority:"medium"},{regex:/\bp4\b/i,priority:"low"},{regex:/\bURGENT\b/i,priority:"urgent"},{regex:/\bASAP\b/i,priority:"urgent"},{regex:/\bcritical\b/i,priority:"urgent"},{regex:/\bemergency\b/i,priority:"urgent"},{regex:/\bhigh\s*priority\b/i,priority:"high"},{regex:/\bimportant\b/i,priority:"high"},{regex:/\bmust\s+do\b/i,priority:"high"},{regex:/\bmedium\s*priority\b/i,priority:"medium"},{regex:/\blow\s*priority\b/i,priority:"low"},{regex:/\bsomeday\b/i,priority:"low"},{regex:/\bbacklog\b/i,priority:"low"},{regex:/\bwhenever\b/i,priority:"low"},{regex:/\btop\s*3\b/i,isTopThree:!0},{regex:/\b#1\b/,isTopThree:!0},{regex:/\bpriority\s*(?:one|1)\b/i,isTopThree:!0},{regex:/\bmost\s*important\b/i,isTopThree:!0},{regex:/\bmain\s*focus\b/i,isTopThree:!0}],Qh=[{regex:/\bevery\s*day\b/i,result:"daily"},{regex:/\bdaily\b/i,result:"daily"},{regex:/\bevery\s*week\b/i,result:"weekly"},{regex:/\bweekly\b/i,result:"weekly"},{regex:/\bevery\s*month\b/i,result:"monthly"},{regex:/\bmonthly\b/i,result:"monthly"},{regex:/\bevery\s*(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/i,result:"weekly"},{regex:/\b(?:twice\s*(?:a\s*)?(?:day|daily)|2x\s*daily)\b/i,result:"twice_daily"},{regex:/\b(?:alternate\s*days?|every\s*other\s*day)\b/i,result:"alternate"},{regex:/\b(?:biweekly|every\s*(?:two|2)\s*weeks?)\b/i,result:"biweekly"}],Wh=[{regex:/\bweekdays?\s*(?:only)?\b/i,days:[1,2,3,4,5]},{regex:/\bweekends?\s*(?:only)?\b/i,days:[0,6]},{regex:/\bMWF\b|mon(?:day)?\s*wed(?:nesday)?\s*fri(?:day)?/i,days:[1,3,5]},{regex:/\bTTh?\b|tue(?:sday)?\s*thu(?:rsday)?/i,days:[2,4]},{regex:/\b(\d)x\s*(?:a\s*)?week\b/i,frequency:"custom"},{regex:/\b(?:three|3)\s*times?\s*(?:a\s*)?week\b/i,frequency:"3x_week"},{regex:/\b(?:five|5)\s*times?\s*(?:a\s*)?week\b/i,frequency:"5x_week"},{regex:/\b(?:twice|2x?)\s*(?:a\s*)?week\b/i,frequency:"2x_week"}],Gh=[{regex:/@home\b/i,result:"home"},{regex:/@work\b/i,result:"work"},{regex:/@office\b/i,result:"work"},{regex:/@errands?\b/i,result:"errands"},{regex:/@phone\b/i,result:"phone"},{regex:/@computer\b/i,result:"computer"},{regex:/@anywhere\b/i,result:"anywhere"},{regex:/@gym\b/i,result:"gym"},{regex:/@outside\b/i,result:"outside"},{regex:/@online\b/i,result:"online"}],Yh=[{regex:/remind\s*(?:me\s+)?(\d+)\s*(?:min(?:ute)?s?)\s*(?:before|early|prior)/i,handler:t=>parseInt(t[1])},{regex:/remind\s*(?:me\s+)?(?:at\s+least\s+)?(\d+)\s*(?:h(?:ou)?rs?)\s*(?:before|early|prior)/i,handler:t=>parseInt(t[1])*60},{regex:/remind\s*(?:me\s+)?(?:a\s+)?half\s*(?:an?\s+)?(?:h(?:ou)?r)\s*(?:before|early|prior)/i,handler:()=>30},{regex:/remind\s*(?:me\s+)?(?:an?\s+|one\s+)(?:h(?:ou)?r)\s*(?:before|early|prior)/i,handler:()=>60},{regex:/remind\s*me\b/i,handler:()=>15},{regex:/(?:set|with)\s*(?:a\s+)?reminder/i,handler:()=>15}],Vh=[{regex:/\bnotes?:\s*(.+?)(?=\s*(?:!{1,4}|p[1-4]|\bat\s+\d|@|\bremind|\btomorrow|\btoday|$))/i,handler:t=>t[1].trim()},{regex:/\/\/\s*(.+?)$/i,handler:t=>t[1].trim()},{regex:/\(([^)]+)\)\s*$/i,handler:t=>t[1].trim()}],Xh=[{regex:/\b(?:remove|clear|delete|no|unset)\s*(?:the\s*)?(?:scheduled?\s*)?time\b/i,clears:"time"},{regex:/\b(?:remove|clear|delete|no|unset)\s*(?:the\s*)?(?:scheduled?\s*)?date\b/i,clears:"date"},{regex:/\b(?:remove|clear|delete|no|unset)\s*(?:the\s*)?(?:estimated?\s*)?duration\b/i,clears:"duration"},{regex:/\b(?:remove|clear|delete|no|unset|stop)\s*(?:the\s*)?(?:recurrence|repeat(?:ing)?)\b/i,clears:"recurrence"},{regex:/\bunschedule\b/i,clears:"both"},{regex:/\bclear\s*(?:all\s*)?schedule\b/i,clears:"both"},{regex:/\b(?:reset|clear\s*all|start\s*fresh|defaults?)\b/i,clears:"all"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?category\b/i,clears:"category"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?(?:attribute|type)\b/i,clears:"category"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?priority\b/i,clears:"priority"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?notes?\b/i,clears:"notes"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?remind(?:er)?\b/i,clears:"reminder"}],Jh=[{regex:/\b(?:for\s+)?(?:mind|mental|brain|cognitive|intellectual|thinking|#mind)\b/i,category:"mind"},{regex:/\b(?:for\s+)?(?:body|physical|fitness|workout|exercise|health|#body)\b/i,category:"body"},{regex:/\b(?:for\s+)?(?:soul|spirit(?:ual)?|emotional|heart|inner|#soul)\b/i,category:"soul"}],Zh=[{regex:/\b(?:pause|skip|disable|deactivate|turn\s*off|stop)\s*(?:this)?\b/i,paused:!0},{regex:/\b(?:resume|activate|enable|turn\s*on|unpause|start)\s*(?:this)?\b/i,paused:!1},{regex:/\b(?:archive|hide)\s*(?:this)?\b/i,archived:!0},{regex:/\b(?:unarchive|unhide|restore)\s*(?:this)?\b/i,archived:!1}],ef=[{regex:/\b(?:bonus|extra\s*credit|stretch\s*goal|optional|nice\s*to\s*have)\b/i,isBonus:!0},{regex:/\b(?:required|mandatory|essential|core)\b/i,isBonus:!1}],tf=[{regex:/\b(?:milestone|checkpoint|key\s*moment|major|significant|big\s*step)\b/i,isMilestone:!0}],sf=[{regex:/\b(?:worth\s*)?(\d+)\s*(?:xp|points?|pts?)\b/i,handler:t=>parseInt(t[1])},{regex:/\b(?:double|2x)\s*xp\b/i,multiplier:2},{regex:/\b(?:triple|3x)\s*xp\b/i,multiplier:3},{regex:/\bhigh\s*value\b/i,xp:100},{regex:/\bquick\s*win\b/i,xp:25}],af=[{regex:/\b(?:rename|call\s*it|change\s*(?:name|title)\s*to)\s*[:\s]*["']?(.+?)["']?$/i,handler:t=>t[1].trim()}],rf=[{regex:/\b(?:break\s*(?:this\s*)?down|decompose|split\s*(?:into\s*)?(?:sub)?tasks?|suggest\s*(?:sub)?steps?|expand)\b/i,trigger:!0}],nf=[{regex:/\b(?:plan|schedule|organize|optimise|optimize)\s*(?:my|the|today'?s?)?\s*(?:day|schedule|tasks?|quests?)\b/i,trigger:!0},{regex:/\b(?:help\s*me\s*)?plan\s*(?:out\s*)?today\b/i,trigger:!0},{regex:/\bwhat\s*should\s*I\s*do\s*(?:today|first|next)\b/i,trigger:!0},{regex:/\b(?:build|create|make)\s*(?:my|a)?\s*schedule\b/i,trigger:!0},{regex:/\bauto[- ]?schedule\b/i,trigger:!0}],of=[{regex:/\b(?:plan|schedule|organize|optimise|optimize)\s*(?:my|the|this)?\s*week\b/i,trigger:!0},{regex:/\bweekly\s*(?:plan|planning|schedule)\b/i,trigger:!0},{regex:/\bwhat\s*should\s*I\s*do\s*this\s*week\b/i,trigger:!0},{regex:/\b(?:build|create|make)\s*(?:my|a)?\s*weekly\s*(?:plan|schedule)\b/i,trigger:!0},{regex:/\bplan\s*(?:out\s*)?(?:the\s*)?(?:next\s*)?(?:7|seven)\s*days?\b/i,trigger:!0},{regex:/\bweek\s*ahead\b/i,trigger:!0}];function G2(t){let s=t;return[...Bh.map(r=>r.regex),...Uh.map(r=>r.regex),...Hh.map(r=>r.regex),...zh.map(r=>r.regex),...Kh.map(r=>r.regex),...Qh.map(r=>r.regex),...Wh.map(r=>r.regex),...Gh.map(r=>r.regex),...Yh.map(r=>r.regex),...Vh.map(r=>r.regex),...Xh.map(r=>r.regex),...Jh.map(r=>r.regex),...Zh.map(r=>r.regex),...ef.map(r=>r.regex),...tf.map(r=>r.regex),...sf.map(r=>r.regex),...af.map(r=>r.regex),...rf.map(r=>r.regex),...nf.map(r=>r.regex),...of.map(r=>r.regex)].forEach(r=>{s=s.replace(r,"")}),s=s.replace(/\s+/g," ").replace(/^\s*[-,;:]\s*/,"").replace(/\s*[-,;:]\s*$/,"").trim(),s}function Y2(t){const s={text:t,difficulty:"medium",scheduledTime:null,scheduledDate:null,estimatedDuration:null,recurrencePattern:null,recurrenceEndDate:null,priority:null,context:null,isTopThree:!1,reminderEnabled:!1,reminderMinutesBefore:null,notes:null,contactId:null,autoLogInteraction:!0,mentionedContactName:null,clearTime:!1,clearDate:!1,clearDuration:!1,clearRecurrence:!1,clearAll:!1,clearCategory:!1,clearPriority:!1,clearNotes:!1,clearReminder:!1,category:null,frequency:null,customDays:null,paused:null,archived:null,isBonus:null,isMilestone:null,xpReward:null,xpMultiplier:null,newTitle:null,triggerDecomposition:!1,triggerPlanMyDay:!1,triggerPlanMyWeek:!1,imageUrl:null,attachments:[]};for(const a of Xh)a.regex.test(t)&&((a.clears==="time"||a.clears==="both")&&(s.clearTime=!0),(a.clears==="date"||a.clears==="both")&&(s.clearDate=!0),a.clears==="duration"&&(s.clearDuration=!0),a.clears==="recurrence"&&(s.clearRecurrence=!0),a.clears==="all"&&(s.clearAll=!0),a.clears==="category"&&(s.clearCategory=!0),a.clears==="priority"&&(s.clearPriority=!0),a.clears==="notes"&&(s.clearNotes=!0),a.clears==="reminder"&&(s.clearReminder=!0));for(const a of Bh){const r=t.match(a.regex);if(r){s.scheduledTime=a.handler(r);break}}for(const a of Uh){const r=t.match(a.regex);if(r){s.scheduledDate=a.handler(r);break}}for(const a of Hh){const r=t.match(a.regex);if(r){s.estimatedDuration=a.handler(r);break}}for(const a of zh)if(a.regex.test(t)){s.difficulty=a.result;break}for(const a of Kh)a.regex.test(t)&&(a.isTopThree?s.isTopThree=!0:a.priority&&!s.priority&&(s.priority=a.priority));for(const a of Qh)if(a.regex.test(t)){s.recurrencePattern=a.result;break}for(const a of Wh)if(t.match(a.regex)){a.days&&(s.customDays=a.days),a.frequency&&(s.frequency=a.frequency);break}for(const a of Gh)if(a.regex.test(t)){s.context=a.result;break}for(const a of Yh){const r=t.match(a.regex);if(r){s.reminderEnabled=!0,s.reminderMinutesBefore=a.handler(r);break}}for(const a of Jh)if(a.regex.test(t)){s.category=a.category;break}for(const a of Zh)if(a.regex.test(t)){a.paused!==void 0&&(s.paused=a.paused),a.archived!==void 0&&(s.archived=a.archived);break}for(const a of ef)if(a.regex.test(t)){s.isBonus=a.isBonus;break}for(const a of tf)if(a.regex.test(t)){s.isMilestone=a.isMilestone;break}for(const a of sf){const r=t.match(a.regex);if(r){a.handler?s.xpReward=a.handler(r):a.xp?s.xpReward=a.xp:a.multiplier&&(s.xpMultiplier=a.multiplier);break}}for(const a of af){const r=t.match(a.regex);if(r){s.newTitle=a.handler(r);break}}for(const a of rf)if(a.regex.test(t)){s.triggerDecomposition=a.trigger;break}for(const a of of)if(a.regex.test(t)){s.triggerPlanMyWeek=a.trigger;break}if(!s.triggerPlanMyWeek){for(const a of nf)if(a.regex.test(t)){s.triggerPlanMyDay=a.trigger;break}}for(const a of Vh){const r=t.match(a.regex);if(r){s.notes=a.handler(r);break}}return s.text=G2(t),s}function V2(){const[t,s]=n.useState(""),[a,r]=n.useState(null);n.useEffect(()=>{t.trim()?r(Y2(t)):r(null)},[t]);const i=n.useCallback(()=>{s(""),r(null)},[]);return{input:t,setInput:s,parsed:a,reset:i}}function X2(){const[t,s]=n.useState("prompt"),[a,r]=n.useState(!0),i=n.useCallback(async()=>{if(!navigator.permissions)return navigator.mediaDevices?.getUserMedia?(s("prompt"),"prompt"):(s("unsupported"),"unsupported");try{const l=await navigator.permissions.query({name:"microphone"}),c=l.state==="granted"?"granted":l.state==="denied"?"denied":"prompt";return s(c),l.onchange=()=>{const d=l.state==="granted"?"granted":l.state==="denied"?"denied":"prompt";s(d)},c}catch{return s("prompt"),"prompt"}},[]),o=n.useCallback(async()=>{if(!navigator.mediaDevices?.getUserMedia)return s("unsupported"),"unsupported";try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(c=>c.stop()),s("granted"),"granted"}catch(l){if(l instanceof Error){if(l.name==="NotAllowedError"||l.name==="PermissionDeniedError")return s("denied"),"denied";if(l.name==="NotFoundError")return s("unsupported"),"unsupported"}return s("denied"),"denied"}},[]);return n.useEffect(()=>{i().finally(()=>r(!1))},[i]),{status:t,isLoading:a,checkPermission:i,requestPermission:o}}function lf({onInterimResult:t,onFinalResult:s,onError:a,onPermissionNeeded:r,onAutoStopping:i,language:o="en-US",autoStopOnSilence:l=!0,silenceTimeoutMs:c=1500}={}){const[d,u]=n.useState(!1),[p,h]=n.useState(!1),f=n.useRef(null),m=n.useRef(null),{status:g,requestPermission:y,checkPermission:b}=X2(),w=typeof window<"u"&&("SpeechRecognition"in window||"webkitSpeechRecognition"in window),x=n.useCallback(()=>{m.current&&(clearTimeout(m.current),m.current=null),h(!1)},[]),v=n.useCallback(()=>{x(),h(!1),f.current&&(f.current.stop(),f.current=null,u(!1))},[x]),j=n.useCallback(()=>{if(!w)return null;const N=window.SpeechRecognition||window.webkitSpeechRecognition;if(!N)return null;const D=new N;return D.continuous=!0,D.interimResults=!0,D.lang=o,D.onresult=R=>{let _="",C="";for(let E=R.resultIndex;E<R.results.length;E++){const O=R.results[E][0].transcript;R.results[E].isFinal?C+=O:_+=O}C&&s&&s(C),_&&t&&t(_),l&&(_||C)&&(x(),m.current=setTimeout(()=>{h(!0),i?.(),setTimeout(()=>{v()},300)},c))},D.onerror=R=>{console.error("Speech recognition error:",R.error),x(),u(!1),a&&a({"not-allowed":"Microphone access denied. Please enable microphone permissions.","no-speech":"No speech detected. Please try again.","audio-capture":"No microphone found. Please check your device.",network:"Network error. Please check your connection."}[R.error]||`Speech recognition error: ${R.error}`)},D.onend=()=>{x(),u(!1)},D},[w,o,t,s,a,l,c,x,v]),T=n.useCallback(async()=>{if(!w){a?.("Speech recognition is not supported in this browser.");return}const N=await b();if(N==="denied"||N==="unsupported"){r?.();return}if(N==="prompt"&&await y()!=="granted"){r?.();return}if(f.current=j(),f.current)try{f.current.start(),u(!0)}catch(D){console.error("Failed to start recording:",D),a?.("Failed to start recording. Please try again.")}},[w,j,a,b,y,r]),S=n.useCallback(()=>{d?v():T()},[d,T,v]);return n.useEffect(()=>()=>{x(),f.current&&f.current.stop()},[x]),{isRecording:d,isAutoStopping:p,isSupported:w,permissionStatus:g,startRecording:T,stopRecording:v,toggleRecording:S,requestPermission:y}}function J2({onApply:t}){const[s,a]=n.useState(!1),{input:r,setInput:i,parsed:o,reset:l}=V2(),{isRecording:c,toggleRecording:d,isSupported:u}=lf({onInterimResult:f=>{i(m=>m+" "+f)},onFinalResult:f=>{i(m=>(m+" "+f).trim())},language:"en-US",autoStopOnSilence:!0}),p=o&&(o.scheduledTime||o.scheduledDate||o.estimatedDuration||o.difficulty!=="medium"||o.recurrencePattern||o.priority||o.context||o.isTopThree||o.reminderEnabled||o.notes||o.category||o.frequency||o.customDays||o.paused!==null||o.archived!==null||o.isBonus!==null||o.isMilestone!==null||o.xpReward||o.xpMultiplier||o.newTitle||o.triggerDecomposition||o.clearTime||o.clearDate||o.clearDuration||o.clearRecurrence||o.clearAll||o.clearCategory||o.clearPriority||o.clearNotes||o.clearReminder),h=()=>{o&&t(o),l(),a(!1)};return s?e.jsxs("div",{className:"space-y-3 p-3 rounded-lg bg-muted/50 border border-border",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"Quick Edit"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(mt,{value:r,onChange:f=>i(f.target.value),placeholder:"e.g., 'at 3pm for 1 hour daily for body'",className:"flex-1 text-sm"}),u&&e.jsx(z,{variant:c?"destructive":"outline",size:"icon",onClick:d,className:"shrink-0",children:c?e.jsx(ux,{className:"h-4 w-4"}):e.jsx(sm,{className:"h-4 w-4"})})]}),p&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[o.scheduledTime&&e.jsxs(tt,{color:"primary",children:["â° ",o.scheduledTime]}),o.scheduledDate&&e.jsxs(tt,{color:"accent",children:["ðŸ“… ",o.scheduledDate]}),o.estimatedDuration&&e.jsxs(tt,{color:"secondary",children:["â±ï¸ ",o.estimatedDuration,"min"]}),o.difficulty!=="medium"&&e.jsxs(tt,{color:o.difficulty==="easy"?"green":"red",children:[o.difficulty==="easy"?"ðŸŒ±":"ðŸ”¥"," ",o.difficulty]}),o.recurrencePattern&&e.jsxs(tt,{color:"purple",children:["ðŸ”„ ",o.recurrencePattern]}),o.priority&&e.jsxs(tt,{color:o.priority==="urgent"?"red":o.priority==="high"?"orange":"blue",children:["âš¡ ",o.priority]}),o.category&&e.jsxs(tt,{color:o.category==="mind"?"blue":o.category==="body"?"green":"purple",children:[o.category==="mind"?"ðŸ§ ":o.category==="body"?"ðŸ’ª":"âœ¨"," ",o.category]}),o.context&&e.jsxs(tt,{color:"secondary",children:["ðŸ“ @",o.context]}),o.frequency&&e.jsxs(tt,{color:"purple",children:["ðŸ“Š ",o.frequency]}),o.customDays&&e.jsxs(tt,{color:"purple",children:["ðŸ“… ",Z2(o.customDays)]}),o.isTopThree&&e.jsx(tt,{color:"yellow",children:"â­ Top 3"}),o.reminderEnabled&&e.jsxs(tt,{color:"blue",children:["ðŸ”” ",o.reminderMinutesBefore?`${o.reminderMinutesBefore}min before`:"reminder"]}),o.isBonus===!0&&e.jsx(tt,{color:"yellow",children:"ðŸŽ Bonus"}),o.isBonus===!1&&e.jsx(tt,{color:"primary",children:"âœ“ Required"}),o.isMilestone&&e.jsx(tt,{color:"gold",children:"ðŸ† Milestone"}),o.xpReward&&e.jsxs(tt,{color:"yellow",children:["âœ¨ ",o.xpReward," XP"]}),o.xpMultiplier&&e.jsxs(tt,{color:"yellow",children:["âœ¨ ",o.xpMultiplier,"x XP"]}),o.paused===!0&&e.jsx(tt,{color:"orange",children:"â¸ï¸ Pause"}),o.paused===!1&&e.jsx(tt,{color:"green",children:"â–¶ï¸ Resume"}),o.archived===!0&&e.jsx(tt,{color:"gray",children:"ðŸ“¦ Archive"}),o.newTitle&&e.jsxs(tt,{color:"primary",children:['âœï¸ "',o.newTitle,'"']}),o.triggerDecomposition&&e.jsx(tt,{color:"blue",children:"ðŸ”€ Break down"}),o.notes&&e.jsx(tt,{color:"secondary",children:"ðŸ“ Note added"}),o.clearAll&&e.jsx(tt,{color:"destructive",children:"ðŸš« Reset all"}),o.clearTime&&!o.clearAll&&e.jsx(tt,{color:"destructive",children:"ðŸš« Remove time"}),o.clearDate&&!o.clearAll&&e.jsx(tt,{color:"destructive",children:"ðŸš« Remove date"}),o.clearDuration&&!o.clearAll&&e.jsx(tt,{color:"destructive",children:"ðŸš« Remove duration"}),o.clearRecurrence&&!o.clearAll&&e.jsx(tt,{color:"destructive",children:"ðŸš« Remove repeat"}),o.clearCategory&&!o.clearAll&&e.jsx(tt,{color:"destructive",children:"ðŸš« Remove category"}),o.clearPriority&&!o.clearAll&&e.jsx(tt,{color:"destructive",children:"ðŸš« Remove priority"}),o.clearNotes&&!o.clearAll&&e.jsx(tt,{color:"destructive",children:"ðŸš« Remove notes"}),o.clearReminder&&!o.clearAll&&e.jsx(tt,{color:"destructive",children:"ðŸš« Remove reminder"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(z,{variant:"ghost",size:"sm",onClick:()=>{l(),a(!1)},className:"flex-1",children:"Cancel"}),e.jsxs(z,{size:"sm",onClick:h,disabled:!p,className:"flex-1 gap-1",children:[e.jsx(Rt,{className:"h-3 w-3"}),"Apply"]})]})]}):e.jsxs(z,{variant:"ghost",size:"sm",onClick:()=>a(!0),className:"w-full justify-start text-muted-foreground hover:text-foreground gap-2",children:[e.jsx(be,{className:"h-4 w-4"}),"Quick edit with natural language..."]})}function tt({children:t,color:s}){const a={primary:"bg-primary/10 text-primary",accent:"bg-accent/50 text-accent-foreground",secondary:"bg-secondary text-secondary-foreground",green:"bg-green-500/20 text-green-600 dark:text-green-400",red:"bg-red-500/20 text-red-600 dark:text-red-400",purple:"bg-purple-500/20 text-purple-600 dark:text-purple-400",blue:"bg-blue-500/20 text-blue-600 dark:text-blue-400",orange:"bg-orange-500/20 text-orange-600 dark:text-orange-400",yellow:"bg-yellow-500/20 text-yellow-600 dark:text-yellow-400",gold:"bg-amber-500/20 text-amber-600 dark:text-amber-400",gray:"bg-muted text-muted-foreground",destructive:"bg-destructive/20 text-destructive"};return e.jsx("span",{className:I("inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs",a[s]||a.secondary),children:t})}function Z2(t){const s=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return t.map(a=>s[a]).join(", ")}const cf=["M","T","W","T","F","S","S"],eS=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],tS=[{value:"daily",label:"Daily",days:[0,1,2,3,4,5,6]},{value:"5x_week",label:"Weekdays",days:[0,1,2,3,4]},{value:"weekly",label:"Weekly",days:[0]},{value:"custom",label:"Custom",days:[]}];function df({frequency:t,customDays:s,onFrequencyChange:a}){const r=t==="weekly"||t==="custom",i=l=>{a(l.value,l.days)},o=l=>{const c=s.includes(l)?s.filter(d=>d!==l):[...s,l].sort((d,u)=>d-u);a(t,c)};return e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-[10px] text-muted-foreground block",children:"Frequency"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:tS.map(l=>e.jsx("button",{type:"button",onClick:()=>i(l),className:I("px-2 py-1 text-xs rounded-full border transition-all",t===l.value?"bg-primary text-primary-foreground border-primary":"bg-background border-border text-muted-foreground hover:border-primary/50"),children:l.label},l.value))}),r&&e.jsx("div",{className:"flex gap-1 pt-1",children:cf.map((l,c)=>e.jsx("button",{type:"button",onClick:()=>o(c),title:eS[c],className:I("w-7 h-7 rounded-full text-[10px] font-bold transition-all border",s.includes(c)?"bg-primary border-primary text-primary-foreground":"border-border bg-background text-muted-foreground hover:border-primary/50"),children:l},c))})]})}function uf(t){switch(t){case"daily":return[0,1,2,3,4,5,6];case"weekdays":case"5x_week":return[0,1,2,3,4];case"weekly":return[0];default:return[]}}function sS(t){return!t||t.length===0||t.length===7?"":t.map(s=>cf[s]).join("")}const vd={mind:{icon:Ds,label:"Mind",color:"text-blue-500 border-blue-500/50 bg-blue-500/10"},body:{icon:Ko,label:"Body",color:"text-green-500 border-green-500/50 bg-green-500/10"},soul:{icon:es,label:"Soul",color:"text-orange-500 border-orange-500/50 bg-orange-500/10"}},aS=n.memo(function({ritual:s,open:a,onOpenChange:r,onSaveComplete:i,onDelete:o,isDeleting:l}){const{user:c}=_e(),d=Ie(),[u,p]=n.useState(""),[h,f]=n.useState(""),[m,g]=n.useState("daily"),[y,b]=n.useState(null),[w,x]=n.useState(""),[v,j]=n.useState("medium"),[T,S]=n.useState("soul"),[N,D]=n.useState(null),[R,_]=n.useState([]),[C,E]=n.useState(!1),[O,M]=n.useState(15),[A,L]=n.useState(!1),[q,$]=n.useState(!1),[B,W]=n.useState(!1);n.useEffect(()=>{s&&(p(s.title),f(s.description||""),g(s.frequency||"daily"),b(s.estimated_minutes||null),x(s.preferred_time||""),j(s.difficulty||"medium"),S(s.category||"soul"),D(s.recurrence_pattern||null),_(s.recurrence_days||s.custom_days||[]),E(s.reminder_enabled||!1),M(s.reminder_minutes_before||15),L(!!s.recurrence_pattern||!!s.reminder_enabled||!!s.category))},[s]);const H=Y=>{if(Y.clearAll){x(""),b(null),D(null),_([]),E(!1);return}Y.newTitle?p(Y.newTitle):Y.text&&Y.text!==u&&p(Y.text),Y.scheduledTime&&x(Y.scheduledTime),Y.estimatedDuration&&b(Y.estimatedDuration),Y.difficulty&&j(Y.difficulty),Y.recurrencePattern&&D(Y.recurrencePattern),Y.category&&S(Y.category),Y.customDays&&_(Y.customDays),Y.reminderEnabled&&(E(!0),Y.reminderMinutesBefore&&M(Y.reminderMinutesBefore)),Y.clearTime&&x(""),Y.clearDuration&&b(null),Y.clearRecurrence&&(D(null),_([])),Y.clearCategory&&S("soul"),Y.clearReminder&&E(!1)},K=async()=>{if(!(!s||!c?.id||!u.trim())){$(!0);try{const Y={title:u.trim(),description:h.trim()||null,frequency:m,estimated_minutes:y,difficulty:v,preferred_time:w||null,category:T,custom_days:R.length>0?R:null},ee={task_text:u.trim(),difficulty:v,scheduled_time:w||null,estimated_duration:y,category:T,recurrence_pattern:N,recurrence_days:R,reminder_enabled:C,reminder_minutes_before:O},{error:ie}=await k.from("habits").update(Y).eq("id",s.habitId).eq("user_id",c.id);if(ie){console.error("Error updating habit:",ie),V.error("Failed to update ritual template");return}const{error:fe}=await k.from("daily_tasks").update(ee).eq("habit_source_id",s.habitId).eq("user_id",c.id).eq("completed",!1);fe?(console.error("Error updating linked tasks:",fe),V.warning("Ritual updated, but some task instances may not have synced")):V.success("Ritual updated everywhere!"),d.invalidateQueries({queryKey:["habits"]}),d.invalidateQueries({queryKey:["daily-tasks"]}),d.invalidateQueries({queryKey:["epics"]}),d.invalidateQueries({queryKey:["habit-surfacing"]}),d.invalidateQueries({queryKey:["epic-progress"]}),i?.(),r(!1)}catch(Y){console.error("Error saving ritual:",Y),V.error("Failed to save changes")}finally{$(!1)}}},X=async()=>{!s||!o||(await o(s.habitId),W(!1),r(!1))};return e.jsxs(yi,{open:a,onOpenChange:r,children:[e.jsxs(rn,{side:"bottom",className:"h-[85vh] rounded-t-xl",children:[e.jsxs(bl,{className:"pb-2",children:[e.jsxs(nn,{className:"flex items-center gap-2",children:[e.jsx(nr,{className:"h-5 w-5 text-accent"}),"Edit Ritual"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Changes sync to all instances of this ritual"})]}),e.jsx(di,{className:"h-[calc(85vh-140px)] pr-4",children:e.jsxs("div",{className:"space-y-6 py-4","data-vaul-no-drag":!0,children:[e.jsx(J2,{onApply:H}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ct,{htmlFor:"title",children:"Ritual Name"}),e.jsx(mt,{id:"title",value:u,onChange:Y=>p(Y.target.value),placeholder:"What's your ritual?"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ct,{htmlFor:"description",children:"Description"}),e.jsx(Zt,{id:"description",value:h,onChange:Y=>f(Y.target.value),placeholder:"What does this ritual involve? Add details about how to perform it, timing, or any tips...",rows:3}),!h&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Add details about what this ritual involves - this was drafted when you created your campaign"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ct,{children:"Difficulty"}),e.jsx(H2,{value:v,onChange:j})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ct,{htmlFor:"time",children:"Scheduled Time"}),e.jsx(mt,{id:"time",type:"time",value:w,onChange:Y=>x(Y.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ct,{htmlFor:"duration",children:"Duration (min)"}),e.jsx(mt,{id:"duration",type:"number",value:y||"",onChange:Y=>b(Y.target.value?parseInt(Y.target.value):null),placeholder:"30",min:"1"})]})]}),e.jsx(df,{frequency:m==="3x_week"?"custom":m,customDays:R,onFrequencyChange:(Y,ee)=>{g(Y),_(ee)}}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ct,{children:"Attribute Boost"}),e.jsx("div",{className:"flex gap-2",children:Object.keys(vd).map(Y=>{const ee=vd[Y],ie=ee.icon;return e.jsxs(z,{type:"button",variant:"outline",size:"sm",onClick:()=>S(Y),className:I("flex-1 gap-2",T===Y&&ee.color),children:[e.jsx(ie,{className:"h-4 w-4"}),ee.label]},Y)})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Which companion attribute grows when you complete this ritual"})]}),e.jsxs("div",{className:"pt-2",children:[e.jsxs(z,{variant:"ghost",size:"sm",onClick:()=>L(!A),className:"w-full justify-between text-muted-foreground",children:["Advanced Options",e.jsx("span",{className:"text-xs",children:A?"â–²":"â–¼"})]}),A&&e.jsx("div",{className:"mt-4",children:e.jsx(xl,{scheduledTime:w||null,estimatedDuration:y,recurrencePattern:N,recurrenceDays:R,reminderEnabled:C,reminderMinutesBefore:O,moreInformation:null,onScheduledTimeChange:x,onEstimatedDurationChange:b,onRecurrencePatternChange:D,onRecurrenceDaysChange:_,onReminderEnabledChange:E,onReminderMinutesBeforeChange:M,onMoreInformationChange:()=>{},location:null,onLocationChange:()=>{},hideRecurrence:!0})})]}),o&&e.jsx("div",{className:"pt-6 mt-4 border-t border-border/50",children:e.jsxs(z,{variant:"ghost",onClick:()=>W(!0),disabled:l||q,className:"w-full text-destructive hover:text-destructive hover:bg-destructive/10",children:[e.jsx(oa,{className:"w-4 h-4 mr-2"}),"Delete Ritual"]})})]})}),e.jsxs(Sh,{className:"pt-4 flex gap-2",children:[e.jsx(z,{variant:"outline",className:"flex-1",onClick:()=>r(!1),disabled:q,children:"Cancel"}),e.jsx(z,{className:"flex-1",onClick:K,disabled:q||!u.trim(),children:q?e.jsxs(e.Fragment,{children:[e.jsx(Nt,{className:"w-4 h-4 mr-2 animate-spin"}),"Saving..."]}):"Save Changes"})]})]}),e.jsx(mr,{open:B,onOpenChange:W,children:e.jsxs(Ea,{children:[e.jsxs(Ta,{children:[e.jsx(Da,{children:"Delete this ritual?"}),e.jsxs(Aa,{children:['This will permanently delete "',s?.title,'" and remove all future instances. Completed tasks will remain in your history.']})]}),e.jsxs(Ma,{children:[e.jsx(Pa,{children:"Cancel"}),e.jsx(la,{onClick:X,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:l?"Deleting...":"Delete"})]})]})})]})}),rS=(t,s={})=>{const{enabled:a=!0}=s,{tasks:r,isLoading:i,taskDate:o,completedCount:l,totalCount:c}=op(t,{enabled:a}),{addTask:d,toggleTask:u,deleteTask:p,setMainQuest:h,updateTask:f,reorderTasks:m,moveTaskToSection:g,moveTaskToDate:y,restoreTask:b,isAdding:w,isToggling:x,isDeleting:v,isUpdating:j,isReordering:T,isMoving:S,isMovingDate:N,isRestoring:D}=Ph(o);return{tasks:r,isLoading:i,addTask:d,toggleTask:u,deleteTask:p,setMainQuest:h,updateTask:f,reorderTasks:m,moveTaskToSection:g,moveTaskToDate:y,restoreTask:b,isAdding:w,isToggling:x,isDeleting:v,isUpdating:j,isReordering:T,isMoving:S,isMovingDate:N,isRestoring:D,completedCount:l,totalCount:c}},nS=(t,s,a={})=>{const{user:r}=_e(),{enabled:i=!0}=a,o=()=>{{const f=Or(t),m=Fr(t),g=im(f,{weekStartsOn:0}),y=om(m,{weekStartsOn:0});return{start:g,end:y}}},{start:l,end:c}=o(),d=ae(l,"yyyy-MM-dd"),u=ae(c,"yyyy-MM-dd"),{data:p=[],isLoading:h}=Ee({queryKey:["calendar-tasks",r?.id,d,u,s],queryFn:async()=>{if(!r?.id)throw new Error("User not authenticated");const{data:f,error:m}=await k.from("daily_tasks").select("*").eq("user_id",r.id).gte("task_date",d).lte("task_date",u).order("scheduled_time",{ascending:!0,nullsFirst:!1}).order("created_at",{ascending:!1});if(m)throw m;return f||[]},enabled:i&&!!r,staleTime:120*1e3,refetchOnWindowFocus:!1});return{tasks:p,isLoading:h}},po=t=>{const s=t.toLowerCase(),a=["read","study","learn","course","book","lesson","tutorial","class","lecture","podcast","audiobook","article","research","education","work","meeting","email","project","deadline","task","report","present","schedule","agenda","calendar","productivity","efficient","prioritize","plan","organize","budget","finance","goal","track","review","prepare","declutter","sort","file","list","todo","checklist","write","journal","blog","code","program","develop","design","build","debug","test","deploy","website","app","software","think","analyze","solve","problem","puzzle","brain","mental","focus","concentrate","memory","memorize","practice","skill","improve","strategy","calculate","math","logic","critical","decision","language","spanish","french","german","japanese","chinese","korean","english","duolingo","vocabulary","grammar","fluent"],r=["exercise","workout","run","running","walk","walking","jog","jogging","gym","lift","weight","strength","cardio","hiit","crossfit","fitness","train","training","marathon","sprint","rep","set","warmup","cooldown","yoga","pilates","stretch","stretching","swim","swimming","bike","cycling","hike","hiking","climb","climbing","dance","dancing","sport","tennis","basketball","soccer","football","golf","martial","boxing","kickbox","push-up","pushup","sit-up","situp","squat","plank","burpee","lunge","deadlift","bench","curl","crunch","jumping","step","abs","core","eat","meal","breakfast","lunch","dinner","snack","cook","cooking","diet","nutrition","protein","vegetable","fruit","healthy","calorie","fast","fasting","keto","vegan","portion","prep","recipe","sleep","rest","nap","hydrate","water","vitamin","supplement","health","doctor","dentist","medicine","checkup","therapy","physical","shower","hygiene","skincare","teeth","floss","brush","groom","posture","ergonomic","stand","move","active","steps","outdoor","recover","recovery","foam","massage","ice","heat","sauna"],i=["meditate","meditation","mindful","mindfulness","breathe","breathing","calm","peace","peaceful","quiet","stillness","present","aware","center","ground","zen","mantra","affirmation","pray","prayer","spiritual","soul","spirit","faith","worship","church","temple","mosque","scripture","bible","devotion","sacred","gratitude","grateful","thankful","appreciate","appreciation","bless","reflect","reflection","introspect","self-care","selfcare","healing","emotion","emotional","feel","feeling","mood","happy","joy","positive","anxiety","stress","cope","release","let go","forgive","accept","therapy","therapist","counseling","mental health","friend","family","partner","spouse","parent","child","loved","call","text","connect","connection","relationship","social","community","talk","listen","conversation","catch up","visit","hang out","date","help","volunteer","donate","give","giving","charity","serve","service","kindness","kind","compassion","empathy","care","support","encourage","art","artist","creative","create","paint","painting","draw","drawing","sketch","craft","diy","pottery","knit","sew","photography","photo","music","sing","singing","song","instrument","piano","guitar","drum","practice music","play music","compose","melody","perform","nature","garden","gardening","plant","flower","outdoor","park","beach","sunset","sunrise","stargazing","wildlife","bird","pet","dog","cat","relax","relaxation","unwind","hobby","fun","enjoy","pleasure","treat","spa","bath","candle","tea","cozy","comfort","movie","show","inspire","inspiration","dream","vision","purpose","meaning","value","intention","manifest","visualize","believe","hope","aspire","transform"],o=p=>p.filter(h=>h.includes(" ")?s.includes(h):new RegExp(`\\b${h}\\b|${h}s?\\b`,"i").test(s)).length,l=o(a),c=o(r),d=o(i),u=Math.max(l,c,d);return u===0?null:l===u?"mind":c===u?"body":d===u?"soul":null};function _d(t,s){switch(t.frequency?.toLowerCase()){case"daily":return!0;case"weekly":return t.custom_days&&t.custom_days.length>0?t.custom_days.includes(s):s===0;case"weekdays":case"5x_week":return s>=0&&s<=4;case"weekends":return s===5||s===6;case"3x_week":return t.custom_days&&t.custom_days.length>0?t.custom_days.includes(s):[0,2,4].includes(s);case"custom":return t.custom_days&&t.custom_days.length>0?t.custom_days.includes(s):!1;default:return!0}}function iS(t){const{user:s}=_e(),a=Ie(),r=km(),i=ky(),o=i===0?6:i-1,{data:l,isLoading:c,error:d}=Ee({queryKey:["habit-surfacing",s?.id,r],queryFn:async()=>{if(!s?.id)return[];const{data:f,error:m}=await k.from("habits").select(`
          id,
          title,
          description,
          difficulty,
          category,
          frequency,
          estimated_minutes,
          preferred_time,
          custom_days,
          epic_habits(epic_id, epics(id, title, status))
        `).eq("user_id",s.id).eq("is_active",!0);if(m)throw m;const{data:g,error:y}=await k.from("daily_tasks").select("id, habit_source_id, completed").eq("user_id",s.id).eq("task_date",r).not("habit_source_id","is",null);if(y)throw y;const b=new Map(g?.map(x=>[x.habit_source_id,x])||[]);return(f||[]).filter(x=>{const v=x.epic_habits?.[0],j=v?.epics;return!(v&&j&&j.status!=="active")}).map(x=>{const j=x.epic_habits?.[0]?.epics,T=b.get(x.id);return{id:x.id,habit_id:x.id,habit_name:x.title,habit_description:x.description||null,frequency:x.frequency||"daily",estimated_minutes:x.estimated_minutes||null,preferred_time:x.preferred_time||null,epic_id:j?.id||null,epic_title:j?.title||null,task_id:T?.id||null,is_completed:T?.completed||!1,category:po(x.title),custom_days:x.custom_days||null}})},enabled:!!s?.id}),u=he({mutationFn:async f=>{if(!s?.id)throw new Error("Not authenticated");const m=l?.find(b=>b.habit_id===f);if(!m)throw new Error("Habit not found");if(m.task_id)return{id:m.task_id};const{data:g,error:y}=await k.from("daily_tasks").insert({user_id:s.id,task_text:m.habit_name,task_date:r,habit_source_id:f,epic_id:m.epic_id,category:po(m.habit_name),source:"recurring",scheduled_time:m.preferred_time,estimated_duration:m.estimated_minutes}).select("id").single();if(y)throw y;return g},onSuccess:()=>{a.invalidateQueries({queryKey:["habit-surfacing"]}),a.invalidateQueries({queryKey:["tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]}),a.invalidateQueries({queryKey:["daily-tasks"]})}}),p=he({mutationFn:async()=>{if(!s?.id)throw new Error("Not authenticated");const f=l?.filter(v=>!v.task_id&&_d(v,o))||[];if(console.log("[Habit Surfacing] Habits to surface:",f.length,f),f.length===0)return console.log("[Habit Surfacing] No habits need surfacing"),[];const m=f.map(v=>({user_id:s.id,task_text:v.habit_name,task_date:r,habit_source_id:v.habit_id,epic_id:v.epic_id,category:po(v.habit_name),source:"recurring",scheduled_time:v.preferred_time,estimated_duration:v.estimated_minutes})),{data:g}=await k.from("daily_tasks").select("habit_source_id").eq("user_id",s.id).eq("task_date",r).not("habit_source_id","is",null),y=new Set(g?.map(v=>v.habit_source_id)||[]),b=m.filter(v=>!y.has(v.habit_source_id));if(console.log("[Habit Surfacing] Inserting new tasks:",b.length,"of",m.length),b.length===0)return console.log("[Habit Surfacing] All habits already have tasks for today"),[];const{data:w,error:x}=await k.from("daily_tasks").insert(b).select("id");if(x)throw console.error("[Habit Surfacing] Insert error:",x),x;return console.log("[Habit Surfacing] Successfully surfaced",w?.length,"habits"),w},onSuccess:f=>{a.invalidateQueries({queryKey:["habit-surfacing"]}),a.invalidateQueries({queryKey:["tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]}),a.invalidateQueries({queryKey:["daily-tasks"]}),f&&f.length>0&&V.success(`${f.length} ritual${f.length>1?"s":""} added to today's quests`)},onError:f=>{console.error("[Habit Surfacing] Mutation error:",f),V.error("Failed to surface habits as quests")}}),h=l?.filter(f=>!f.task_id&&_d(f,o)).length||0;return{surfacedHabits:l||[],isLoading:c,error:d,surfaceHabit:u.mutate,surfaceAllEpicHabits:p.mutate,surfaceAllHabits:p.mutate,unsurfacedEpicHabitsCount:h,unsurfacedHabitsCount:h}}function oS(t){const{user:s}=_e(),a=Ie(),r=t||new Date,i=ae(r,"yyyy-MM-dd"),o=Bo(jo(r)),{data:l,isLoading:c}=Ee({queryKey:["recurring-templates",s?.id,i],queryFn:async()=>{if(!s?.id)return[];const{data:u,error:p}=await k.from("daily_tasks").select(`
          id,
          task_text,
          difficulty,
          task_date,
          created_at,
          scheduled_time,
          estimated_duration,
          category,
          recurrence_pattern,
          recurrence_days,
          recurrence_end_date,
          xp_reward,
          epic_id,
          reminder_enabled,
          reminder_minutes_before
        `).eq("user_id",s.id).eq("is_recurring",!0).not("recurrence_pattern","is",null);if(p)throw p;const{data:h,error:f}=await k.from("daily_tasks").select("parent_template_id, task_text").eq("user_id",s.id).eq("task_date",i);if(f)throw f;const m=new Set(h?.filter(b=>b.parent_template_id).map(b=>b.parent_template_id)),g=new Set(h?.map(b=>b.task_text.toLowerCase()));return(u||[]).filter(b=>{if(m.has(b.id)||g.has(b.task_text.toLowerCase()))return!1;if(b.recurrence_end_date){const w=Jt(b.recurrence_end_date);if(va(w)&&Ex(ir(r),ir(w)))return!1}return lS(b,o,r)})},enabled:!!s?.id}),d=he({mutationFn:async()=>{if(!s?.id||!l?.length)return[];const u=l.map(f=>({user_id:s.id,task_text:f.task_text,task_date:i,difficulty:f.difficulty,scheduled_time:f.scheduled_time,estimated_duration:f.estimated_duration,category:f.category,xp_reward:f.xp_reward,epic_id:f.epic_id,reminder_enabled:f.reminder_enabled,reminder_minutes_before:f.reminder_minutes_before,parent_template_id:f.id,source:"recurring",is_recurring:!1})),{data:p,error:h}=await k.from("daily_tasks").upsert(u,{onConflict:"user_id,task_date,parent_template_id",ignoreDuplicates:!0}).select("id");if(h)throw h;return p},onSuccess:u=>{a.invalidateQueries({queryKey:["recurring-templates"]}),a.invalidateQueries({queryKey:["tasks"]}),a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]}),u&&u.length>0&&console.log(`[RecurringSpawner] Spawned ${u.length} recurring tasks for ${i}`)},onError:u=>{console.error("[RecurringSpawner] Failed to spawn recurring tasks:",u),V.error("Failed to create recurring quests")}});return{pendingRecurringCount:l?.length||0,isLoading:c,spawnRecurringTasks:d.mutate,isSpawning:d.isPending}}function lS(t,s,a=new Date){const r=t.recurrence_pattern?.toLowerCase(),i=ir(a),o=cS(t);if(!r)return!1;switch(r){case"daily":return!0;case"weekly":return t.recurrence_days&&t.recurrence_days.length>0?t.recurrence_days.includes(s):o?Bo(jo(o))===s:!0;case"weekdays":return s>=0&&s<=4;case"weekends":return s===5||s===6;case"biweekly":{if((t.recurrence_days?.[0]??(o?Bo(jo(o)):s))!==s||!o)return!1;const c=lm(i,o);return c>=0&&c%14===0}case"monthly":{if(!o)return!1;const l=o.getDate(),c=Math.min(l,Tx(i).getDate());return i.getDate()===c}case"custom":return t.recurrence_days&&t.recurrence_days.length>0?t.recurrence_days.includes(s):!1;default:return!!(r.includes("daily")||r.includes("day"))}}function cS(t){if(t.task_date){const s=Jt(t.task_date);if(va(s))return ir(s)}if(t.created_at){const s=Jt(t.created_at);if(va(s))return ir(s)}return null}function Bo(t){return t===0?6:t-1}function dS(){const{user:t}=_e(),{toast:s}=_s(),a=Ie(),{data:r,isLoading:i}=Ee({queryKey:["streak-at-risk",t?.id],queryFn:async()=>{if(!t?.id)return null;const{data:l,error:c}=await k.from("profiles").select("streak_at_risk, streak_at_risk_since, current_habit_streak, streak_freezes_available").eq("id",t.id).maybeSingle();return c?(console.error("Error fetching streak at risk:",c),null):{streak_at_risk:l.streak_at_risk??!1,streak_at_risk_since:l.streak_at_risk_since,current_habit_streak:l.current_habit_streak??0,streak_freezes_available:l.streak_freezes_available??0}},enabled:!!t?.id,staleTime:3e4}),o=he({mutationFn:async l=>{const{data:c,error:d}=await k.functions.invoke("resolve-streak-freeze",{body:{action:l}});if(d)throw d;return c},onSuccess:(l,c)=>{a.invalidateQueries({queryKey:["streak-at-risk"]}),a.invalidateQueries({queryKey:["profile"]}),s(c==="use_freeze"?{title:"Streak Preserved! â„ï¸",description:`Your ${l.newStreak}-day streak is safe. ${l.freezesRemaining} freeze${l.freezesRemaining===1?"":"s"} remaining.`}:{title:"Fresh Start",description:"Your streak has been reset. Time to build a new one!"})},onError:l=>{console.error("Error resolving streak:",l),s({title:"Error",description:"Failed to process your choice. Please try again.",variant:"destructive"})}});return{needsStreakDecision:r?.streak_at_risk??!1,currentStreak:r?.current_habit_streak??0,freezesAvailable:r?.streak_freezes_available??0,streakAtRiskSince:r?.streak_at_risk_since,isLoading:i,useFreeze:()=>o.mutateAsync("use_freeze"),resetStreak:()=>o.mutateAsync("reset_streak"),isResolving:o.isPending}}const uS=2,mS=["Create Your First Quest ðŸŽ¯","Create Your First Quest","Complete Your First Quest âœ…","Complete Your First Quest","Meet Your Companion âœ¨","Meet Your Companion","Morning Check-in ðŸŒ…","Morning Check-in","Create Your First Campaign ðŸš€","Create Your First Campaign","Listen to Your Mentor ðŸŽ§","Listen to Your Mentor"],pS=[2,3,4],hS=t=>`onboarding_task_cleanup_version_${uS}_${t}`;function fS(t,s,a=!1){const r=Ie(),i=n.useRef(!1);n.useEffect(()=>{if(a||!t||!s)return;const o=hS(t);st.getItem(o)==="true"||i.current||(i.current=!0,(async()=>{try{const{error:c}=await k.from("daily_tasks").delete().eq("user_id",t).eq("source","onboarding");if(c){console.error("[OnboardingCleanup] Failed to delete onboarding-source tasks:",c);return}const{error:d}=await k.from("daily_tasks").delete().eq("user_id",t).in("task_text",[...mS]).eq("difficulty","easy").eq("is_main_quest",!1).in("xp_reward",[...pS]);if(d){console.error("[OnboardingCleanup] Failed to delete legacy tutorial-title tasks:",d);return}st.setItem(o,"true"),r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]})}finally{i.current=!1}})())},[s,a,r,t])}function vl(){const{user:t}=_e(),s=n.useCallback(async l=>{if(!t)return;const{interactionType:c,inputText:d,detectedIntent:u,aiResponse:p,userAction:h,modifications:f}=l;try{const{data:{session:m}}=await k.auth.getSession();if(!m||m.user.id!==t.id)return;const{error:g}=await k.from("ai_interactions").insert({user_id:t.id,interaction_type:c,input_text:d,detected_intent:u,ai_response:p,user_action:h,modifications:f});if(g){console.warn("Failed to track interaction (non-blocking):",g.message);return}await a(t.id,h)}catch(m){console.warn("Error tracking interaction (non-blocking):",m)}},[t]),a=async(l,c)=>{try{const{data:d}=await k.from("user_ai_learning").select("interaction_count, acceptance_rate, modification_rate").eq("user_id",l).maybeSingle();if(!d){await k.from("user_ai_learning").insert({user_id:l,interaction_count:1,acceptance_rate:c==="accepted"?100:0,modification_rate:c==="modified"?100:0,last_interaction_at:new Date().toISOString()});return}const u=(d.interaction_count||0)+1,p=d.acceptance_rate||0,h=d.modification_rate||0,f=c==="accepted"?(p*(u-1)+100)/u:p*(u-1)/u,m=c==="modified"?(h*(u-1)+100)/u:h*(u-1)/u;await k.from("user_ai_learning").update({interaction_count:u,acceptance_rate:Math.round(f*100)/100,modification_rate:Math.round(m*100)/100,last_interaction_at:new Date().toISOString()}).eq("user_id",l)}catch(d){console.error("Error updating learning from action:",d)}},r=n.useCallback(async l=>{if(!t)return;const{storyType:c,themeColor:d,category:u,epicDuration:p,habitDifficulty:h,habitFrequency:f,wasSuccessful:m}=l;try{const{data:g}=await k.from("user_ai_learning").select("preference_weights, successful_patterns, failed_patterns, common_contexts").eq("user_id",t.id).maybeSingle(),y=g?.preference_weights||{story_type:{},theme_color:{},categories:{}},b=g?.successful_patterns||{},w=g?.failed_patterns||{},x=g?.common_contexts||[],v=m?1:-.5;c&&(y.story_type=y.story_type||{},y.story_type[c]=(y.story_type[c]||0)+v),d&&(y.theme_color=y.theme_color||{},y.theme_color[d]=(y.theme_color[d]||0)+v),u&&!x.includes(u)&&x.push(u);const j=`${c||"none"}_${p||30}_${h||"medium"}`;m?b[j]=(b[j]||0)+1:w[j]=(w[j]||0)+1;const T={preference_weights:y,successful_patterns:b,failed_patterns:w,common_contexts:x.slice(-20),updated_at:new Date().toISOString()};m&&(p&&(T.preferred_epic_duration=p),h&&(T.preferred_habit_difficulty=h),f&&(T.preferred_habit_frequency=f)),await k.from("user_ai_learning").upsert({user_id:t.id,...T},{onConflict:"user_id"})}catch(g){console.error("Error updating preference weights:",g)}},[t]),i=n.useCallback(async(l,c)=>{if(t)try{const{data:d}=await k.from("epics").select("story_type_slug, theme_color, target_days").eq("id",l).maybeSingle();if(!d)return;const{data:u}=await k.from("epic_habits").select("habits(difficulty, frequency, category, custom_days)").eq("epic_id",l),p=u?.length?u.reduce((f,m)=>{const g=m.habits?.difficulty||"medium";return f+(g==="easy"?1:g==="medium"?2:3)},0)/u.length:2,h=p<1.5?"easy":p<2.5?"medium":"hard";await r({storyType:d.story_type_slug||void 0,themeColor:d.theme_color||void 0,epicDuration:d.target_days,habitDifficulty:h,wasSuccessful:c==="completed"})}catch(d){console.error("Error tracking epic outcome:",d)}},[t,r]),o=n.useCallback(async(l,c,d)=>{if(t)try{const{data:u}=await k.from("user_ai_learning").select("successful_patterns, failed_patterns, energy_by_hour, day_of_week_patterns").eq("user_id",t.id).maybeSingle(),p=u?.successful_patterns||{},h=u?.failed_patterns||{},f=u?.energy_by_hour||{},m=u?.day_of_week_patterns||{},g=c==="completed",y=new Date().toLocaleDateString("en-US",{weekday:"long"}).toLowerCase();if(d?.actualCompletionTime&&g){const x=d.actualCompletionTime.split(":")[0];f[x]=(f[x]||50)+5}else if(d?.scheduledTime&&!g){const x=d.scheduledTime.split(":")[0];f[x]=Math.max(0,(f[x]||50)-5)}const b=(m[`${y}_total`]||0)+1,w=(m[`${y}_success`]||0)+(g?1:0);if(m[`${y}_total`]=b,m[`${y}_success`]=w,m[y]=Math.round(w/b*100),d?.category){const x=`category_${d.category}`;g?p[x]=(p[x]||0)+1:h[x]=(h[x]||0)+1}if(d?.difficulty){const x=`difficulty_${d.difficulty}`;g?p[x]=(p[x]||0)+1:h[x]=(h[x]||0)+1}await k.from("user_ai_learning").upsert({user_id:t.id,successful_patterns:p,failed_patterns:h,energy_by_hour:f,day_of_week_patterns:m,updated_at:new Date().toISOString()},{onConflict:"user_id"})}catch(u){console.warn("Error tracking daily plan outcome (non-blocking):",u)}},[t]);return{trackInteraction:s,updatePreferenceWeights:r,trackEpicOutcome:i,trackDailyPlanOutcome:o}}const gS=t=>{const s=t?.toLowerCase()?.trim()||"medium";return["easy","simple","beginner","low"].includes(s)?"easy":["hard","difficult","advanced","high","challenging"].includes(s)?"hard":"medium"},xS=t=>{const s=t?.toLowerCase()?.trim()?.replace(/\s+/g,"_")||"daily";return["daily","everyday","every_day","7x_week","7x"].includes(s)?"daily":["5x_week","5x","weekdays","five_times","5_times"].includes(s)?"5x_week":["3x_week","3x","three_times","3_times","thrice"].includes(s)?"3x_week":["weekly","biweekly","twice","2x","2x_week","once","1x","custom","twice_daily"].includes(s)?"custom":"daily"},yS=t=>{if(!t)return"heroic";const s=t.toLowerCase().trim();return["heroic","warrior","mystic","nature","solar"].includes(s)?s:{"#f59e0b":"heroic","#ef4444":"warrior","#10b981":"nature","#ec4899":"mystic","#f97316":"solar","#8b5cf6":"mystic","#3b82f6":"heroic","#475569":"warrior"}[s]||"heroic"},mf=2,pf=`You can only have ${mf} active campaigns at a time. Complete or abandon one before creating another.`,bS=t=>{if(!t)return"";if(typeof t=="string")return t.toLowerCase();if(t instanceof Error)return t.message.toLowerCase();if(typeof t=="object"){const s=t;return`${s.message??""} ${s.details??""} ${s.hint??""} ${s.code??""}`.toLowerCase()}return""},wS=t=>{const s=bS(t);return s.includes("2 active epics")||s.includes("active epics at a time")||s.includes("active campaigns at a time")?{title:"Campaign limit reached",description:pf}:s.includes("not authenticated")||s.includes("jwt")||s.includes("auth")?{title:"Sign in required",description:"Please refresh and sign in again before creating a campaign."}:s.includes("failed to create habits")||s.includes("no habits were created")?{title:"Failed to create campaign",description:"We couldn't save your rituals. Please review your plan and try again."}:s.includes("maximum active habit limit reached")?{title:"Too many active rituals",description:"Your account hit a legacy ritual limit. Update your app data and try creating this campaign again."}:{title:"Failed to create campaign",description:"Please try again in a moment. If this keeps happening, close and reopen the planner."}},vS=(t={})=>{const{user:s}=_e(),a=Ie(),{awardCustomXP:r}=rs(),{trackEpicOutcome:i}=vl(),{enabled:o=!0}=t,{data:l,isLoading:c,error:d}=Ee({queryKey:["epics",s?.id],queryFn:async()=>{if(!s?.id)return[];const{data:y,error:b}=await k.from("epics").select(`
          *,
          epic_habits(
            habit_id,
            habits(id, title, difficulty, description, frequency, estimated_minutes, custom_days, preferred_time, category)
          )
        `).eq("user_id",s.id).order("created_at",{ascending:!1});if(b)throw console.error("Failed to fetch epics:",b),b;return y||[]},enabled:o&&!!s?.id,staleTime:180*1e3,refetchOnWindowFocus:!1,retry:2}),u=he({mutationFn:async y=>{const{data:{session:b},error:w}=await k.auth.getSession();if(w||!b?.user?.id)throw new Error("Not authenticated. Please refresh and try again.");const x=b.user.id;if(!y.habits||y.habits.length===0)throw new Error("Campaign must have at least one ritual");if(y.target_days<1||y.target_days>365)throw new Error("Target days must be between 1 and 365");let v=[],j=null;try{const{data:T,error:S}=await k.rpc("count_user_epics",{p_user_id:x});if(S)console.error("Failed to check active campaign limit (continuing):",S);else if((T??0)>=mf)throw new Error(pf);const{data:N,error:D}=await k.from("habits").insert(y.habits.map(M=>{const A=xS(M.frequency);let L=M.custom_days?.length>0?M.custom_days:null;return!L&&A!=="daily"&&(A==="5x_week"?L=[0,1,2,3,4]:A==="3x_week"?L=[0,2,4]:A==="custom"&&(L=[0])),{user_id:x,title:M.title,description:M.description||null,difficulty:gS(M.difficulty),frequency:A,custom_days:L,preferred_time:M.preferred_time||null,reminder_enabled:M.reminder_enabled||!1,reminder_minutes_before:M.reminder_minutes_before||15,estimated_minutes:M.estimated_minutes||null}})).select();if(D)throw console.error("Failed to create habits:",D),new Error(`Failed to create habits: ${D.message}`);if(!N||N.length===0)throw new Error("No habits were created");v=N;const R=`EPIC-${Math.random().toString(36).substring(2,10).toUpperCase()}`,{data:_,error:C}=await k.from("epics").insert({user_id:x,title:y.title,description:y.description,target_days:y.target_days,is_public:!0,xp_reward:Math.floor(y.target_days*10),invite_code:R,theme_color:yS(y.theme_color),story_type_slug:y.story_type_slug||null}).select().single();if(C)throw console.error("Failed to create campaign:",C),await k.from("habits").delete().in("id",v.map(M=>M.id)),new Error(`Failed to create campaign: ${C.message}`);if(!_)throw new Error("Campaign creation returned no data");j=_;const{error:E}=await k.from("epic_habits").insert(v.map(M=>({epic_id:_.id,habit_id:M.id})));if(E)throw console.error("Failed to link habits:",E),await k.from("epics").delete().eq("id",_.id),await k.from("habits").delete().in("id",v.map(M=>M.id)),new Error(`Failed to link habits: ${E.message}`);if(y.phases&&y.phases.length>0){const{error:M}=await k.from("journey_phases").insert(y.phases.map(A=>({epic_id:_.id,user_id:x,name:A.name,description:A.description,start_date:A.start_date,end_date:A.end_date,phase_order:A.phase_order})));M&&console.error("Failed to create journey phases:",M)}let O=y.milestones;if((!O||O.length===0)&&y.story_type_slug){console.log("[Epic Creation] No milestones provided, generating defaults for story type:",y.story_type_slug);let M=5;y.target_days<=14?M=3:y.target_days<=30?M=4:y.target_days<=60?M=5:M=6;const A=new Date;O=Array.from({length:M},(L,q)=>{const $=Math.round((q+1)/M*100),B=Math.floor(y.target_days*$/100),W=new Date(A);return W.setDate(W.getDate()+B),{title:q===M-1?"The Finale":`Chapter ${q+1}`,description:q===M-1?"Complete your epic journey!":`Reach ${$}% of your goal`,target_date:W.toISOString().split("T")[0],milestone_percent:$,is_postcard_milestone:!0}})}if(O&&O.length>0){console.log("[Epic Creation] Inserting milestones:",O.length,O);const{data:M,error:A}=await k.from("epic_milestones").insert(O.map((L,q)=>({epic_id:_.id,user_id:x,title:L.title,description:L.description||null,target_date:L.target_date,milestone_percent:L.milestone_percent,is_postcard_milestone:L.is_postcard_milestone??!1,phase_order:q+1,phase_name:L.phase_name||L.phaseName||null}))).select();A?(console.error("Failed to create milestones:",A),V.error("Milestones couldn't be created",{description:"You can add them manually from the campaign settings"})):console.log("[Epic Creation] Successfully created milestones:",M?.length)}else console.log("[Epic Creation] No milestones to insert and no story type for fallback");if(y.story_type_slug){const[M,A]=await Promise.all([k.from("user_companion").select("spirit_animal, core_element, favorite_color, fur_color").eq("user_id",x).maybeSingle(),k.from("profiles").select("selected_mentor_id").eq("id",x).maybeSingle()]);let L;if(A.data?.selected_mentor_id){const{data:W}=await k.from("mentors").select("id, name, slug").eq("id",A.data.selected_mentor_id).maybeSingle();W&&(L={id:W.id,name:W.name,slug:W.slug||void 0})}const q=y.milestones?.filter(W=>W.is_postcard_milestone)||[],$=q.length||5,B=q.map((W,H)=>({chapterNumber:H+1,title:W.title,targetDate:W.target_date,milestonePercent:W.milestone_percent}));k.functions.invoke("generate-epic-narrative-seed",{body:{userId:x,epicId:_.id,epicTitle:y.title,epicDescription:y.description,targetDays:y.target_days,storyTypeSlug:y.story_type_slug,companionData:M.data||void 0,mentorData:L,userGoal:y.description,totalChapters:$,milestoneData:B}}).catch(W=>{console.error("Narrative seed generation failed:",W)}),k.functions.invoke("generate-journey-path",{body:{epicId:_.id,milestoneIndex:0,userId:x}}).catch(W=>{console.error("Initial journey path generation failed:",W)})}return _}catch(T){throw j&&k.from("epics").delete().eq("id",j.id).then(({error:S})=>{S&&console.error("Failed to cleanup epic:",S)}),v.length>0&&k.from("habits").delete().in("id",v.map(S=>S.id)).then(({error:S})=>{S&&console.error("Failed to cleanup habits:",S)}),T}},onSuccess:()=>{a.invalidateQueries({queryKey:["epics"]}),a.invalidateQueries({queryKey:["habits"]}),a.invalidateQueries({queryKey:["user-ai-context"]}),window.dispatchEvent(new CustomEvent("campaign-created")),V.success("Campaign created! ðŸŽ¯",{description:"Your companion is excited for this new journey!"})},onError:y=>{console.error("Failed to create campaign:",y);const b=wS(y);V.error(b.title,{description:b.description})}}),p=he({mutationFn:async({epicId:y,status:b})=>{if(!s?.id)throw new Error("User not authenticated");const{data:w,error:x}=await k.from("epics").select("xp_reward, title, progress_percentage, status, user_id").eq("id",y).eq("user_id",s.id).maybeSingle();if(x)throw console.error("Failed to fetch epic:",x),new Error(`Failed to fetch epic: ${x.message}`);if(!w)throw new Error("Epic not found or you don't have permission");if(w.status==="completed"&&b==="completed")throw new Error("Epic is already completed");const{error:v}=await k.from("epics").update({status:b,completed_at:b==="completed"?new Date().toISOString():null}).eq("id",y).eq("user_id",s.id);if(v)throw v;if(b==="abandoned"){console.log("[Epic Abandon] Cleaning up rituals and milestones for epic:",y);const{data:j}=await k.from("epic_habits").select("habit_id").eq("epic_id",y);if(j&&j.length>0){const S=j.map(C=>C.habit_id);console.log("[Epic Abandon] Deactivating habits:",S);const{error:N}=await k.from("habits").update({is_active:!1}).in("id",S).eq("user_id",s.id);N&&console.error("Failed to deactivate habits:",N);const D=ae(new Date,"yyyy-MM-dd"),{error:R}=await k.from("daily_tasks").delete().in("habit_source_id",S).gte("task_date",D).eq("completed",!1);R&&console.error("Failed to delete future habit tasks:",R);const{error:_}=await k.from("epic_habits").delete().eq("epic_id",y);_&&console.error("Failed to delete epic_habits links:",_)}const{error:T}=await k.from("epic_milestones").delete().eq("epic_id",y).eq("user_id",s.id);T&&console.error("Failed to delete milestones:",T),console.log("[Epic Abandon] Cleanup complete")}return{epic:w,status:b,wasAlreadyCompleted:w.status==="completed"}},onSuccess:async({epic:y,status:b,wasAlreadyCompleted:w},x)=>{if(a.invalidateQueries({queryKey:["epics"]}),a.invalidateQueries({queryKey:["habits"]}),a.invalidateQueries({queryKey:["habit-surfacing"]}),a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["user-ai-context"]}),(b==="completed"||b==="abandoned")&&i(x.epicId,b).catch(v=>{console.error("Failed to track epic outcome:",v)}),b==="completed"&&!w){try{await r(y.xp_reward,"epic_complete",`Epic "${y.title}" Completed!`,{epic_id:x?.epicId})}catch(v){console.error("Failed to award epic completion XP:",v)}V.success("Epic Completed! ðŸ†",{description:`You've conquered the ${y.title} epic! Your companion grows stronger!`})}else b==="abandoned"&&V("Epic abandoned",{description:"You can always start a new epic when ready."})},onError:y=>{console.error("Failed to update epic:",y),V.error("Failed to update epic status")}}),h=he({mutationFn:async({epicId:y,habitId:b})=>{if(!y||!b)throw new Error("Invalid epic or habit ID");const{data:w}=await k.from("epic_habits").select("id").eq("epic_id",y).eq("habit_id",b).maybeSingle();if(w)throw new Error("Habit is already linked to this epic");const{error:x}=await k.from("epic_habits").insert({epic_id:y,habit_id:b});if(x)throw console.error("Failed to link habit to epic:",x),x},onSuccess:()=>{a.invalidateQueries({queryKey:["epics"]}),V.success("Habit linked to epic! âš”ï¸")},onError:y=>{console.error("Failed to link habit:",y),V.error("Failed to link habit to epic")}}),f=he({mutationFn:async({epicId:y,habitId:b})=>{if(!y||!b)throw new Error("Invalid epic or habit ID");const{error:w}=await k.from("epic_habits").delete().eq("epic_id",y).eq("habit_id",b);if(w)throw console.error("Failed to remove habit from epic:",w),w},onSuccess:()=>{a.invalidateQueries({queryKey:["epics"]}),V("Habit removed from epic")},onError:y=>{console.error("Failed to remove habit:",y),V.error("Failed to remove habit from epic")}}),m=l?.filter(y=>y.status==="active")||[],g=l?.filter(y=>y.status==="completed")||[];return{epics:l||[],activeEpics:m,completedEpics:g,isLoading:c,error:d,createEpic:u.mutateAsync,isCreating:u.isPending,isCreateSuccess:u.isSuccess,updateEpicStatus:p.mutate,addHabitToEpic:h.mutate,removeHabitFromEpic:f.mutate}};function _S({open:t,onOpenChange:s,tasks:a,selectedDate:r,onComplete:i}){const[o,l]=n.useState(""),[c,d]=n.useState(!1),u=Ie(),p=n.useMemo(()=>a.filter(m=>!m.completed),[a]),h=n.useMemo(()=>{const g=new Date().getHours(),y=[];return p.length>3&&g>14&&y.push({icon:e.jsx(It,{className:"h-4 w-4"}),label:"Focus on top 3",prompt:"Keep only the 3 most important remaining tasks for today and move the rest to tomorrow"}),p.length>0&&y.push({icon:e.jsx(Ht,{className:"h-4 w-4"}),label:"Push all by 1 hour",prompt:"Push all remaining tasks back by 1 hour"}),p.length>2&&y.push({icon:e.jsx(zt,{className:"h-4 w-4"}),label:"Move rest to tomorrow",prompt:"Move all remaining incomplete tasks to tomorrow"}),y.push({icon:e.jsx(be,{className:"h-4 w-4"}),label:"Reschedule smarter",prompt:"Reorganize the remaining tasks based on current time and energy optimization"}),y.slice(0,4)},[p]),f=async m=>{if(m.trim()){d(!0);try{const g=ae(r,"yyyy-MM-dd"),{data:y,error:b}=await k.functions.invoke("adjust-saved-daily-plan",{body:{planDate:g,adjustmentRequest:m,currentTasks:p.map(w=>({id:w.id,title:w.task_text,scheduledTime:w.scheduled_time}))}});if(b)throw b;if(y?.adjustments&&Array.isArray(y.adjustments)){let w=0;for(const x of y.adjustments)if(x.action==="update"&&x.taskId&&x.updates){const v={...x.updates};if(Object.prototype.hasOwnProperty.call(v,"task_date")||Object.prototype.hasOwnProperty.call(v,"scheduled_time")){const{data:j,error:T}=await k.from("daily_tasks").select("task_date, scheduled_time, habit_source_id, source").eq("id",x.taskId).maybeSingle();if(T)throw T;if(j){const S=Rn(j,{task_date:v.task_date,scheduled_time:v.scheduled_time});v.task_date=S.task_date,v.scheduled_time=S.scheduled_time,S.source!==j.source&&(v.source=S.source),S.normalizedToInbox&&(w+=1)}}await k.from("daily_tasks").update(v).eq("id",x.taskId)}else if(x.action==="delete"&&x.taskId)await k.from("daily_tasks").delete().eq("id",x.taskId);else if(x.action==="move_to_tomorrow"&&x.taskId){const v=new Date(r);v.setDate(v.getDate()+1);const{data:j,error:T}=await k.from("daily_tasks").select("task_date, scheduled_time, habit_source_id, source").eq("id",x.taskId).maybeSingle();if(T)throw T;if(!j)continue;const S=Za({task_date:ae(v,"yyyy-MM-dd"),scheduled_time:j.scheduled_time,habit_source_id:j.habit_source_id,source:j.source});S.normalizedToInbox&&(w+=1);const N={task_date:S.task_date,scheduled_time:S.scheduled_time};S.source!==j.source&&(N.source=S.source),await k.from("daily_tasks").update(N).eq("id",x.taskId)}w>0&&V(`${w} quest${w===1?"":"s"} stayed in Inbox (time required).`)}u.invalidateQueries({queryKey:["daily-tasks"]}),V.success(y?.message||"Plan adjusted!"),l(""),i()}catch(g){console.error("Adjust error:",g),V.error("Failed to adjust plan")}finally{d(!1)}}};return e.jsx(Ra,{open:t,onOpenChange:s,children:e.jsxs(Ia,{className:"max-h-[70vh]",children:[e.jsxs(qa,{className:"text-center pb-2",children:[e.jsx("div",{className:"flex justify-center mb-2",children:e.jsx("div",{className:"p-2 rounded-full bg-primary/10",children:e.jsx(ia,{className:"h-5 w-5 text-primary"})})}),e.jsx(La,{children:"Quick Adjust"}),e.jsxs(pl,{children:[p.length," task",p.length!==1?"s":""," remaining"]})]}),e.jsxs("div",{className:"px-4 pb-6 space-y-4",children:[e.jsx("div",{className:"grid grid-cols-2 gap-2",children:h.map((m,g)=>e.jsxs(P.button,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:g*.05},onClick:()=>f(m.prompt),disabled:c,className:I("flex items-center gap-2 p-3 rounded-lg","bg-muted/50 border border-border/50","hover:bg-muted hover:border-primary/30 transition-all","text-left text-sm","disabled:opacity-50 disabled:cursor-not-allowed"),children:[e.jsx("div",{className:"text-primary",children:m.icon}),e.jsx("span",{className:"font-medium",children:m.label})]},g))}),e.jsxs("div",{className:"relative",children:[e.jsx(mt,{value:o,onChange:m=>l(m.target.value),placeholder:"Or describe what to change...",className:"pr-12",onKeyDown:m=>m.key==="Enter"&&f(o),disabled:c}),e.jsx(z,{size:"icon",variant:"ghost",className:"absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8",onClick:()=>f(o),disabled:!o.trim()||c,children:c?e.jsx(Nt,{className:"h-4 w-4 animate-spin"}):e.jsx(xu,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:["Move workout to 6pm","Cancel meeting prep","Add 30min break"].map(m=>e.jsx("button",{onClick:()=>l(m),disabled:c,className:"text-xs px-2 py-1 rounded-full bg-muted/50 text-muted-foreground hover:text-foreground transition-colors",children:m},m))})]})]})})}function jS(){const[t,s]=n.useState([]),[a,r]=n.useState(!1),[i,o]=n.useState(null),l=n.useCallback(async(f,m)=>{if(!f.trim()){o("Please enter a goal");return}r(!0),o(null);try{const{data:g,error:y}=await k.functions.invoke("generate-epic-suggestions",{body:{goal:f.trim(),deadline:m?.deadline,targetDays:m?.targetDays,clarificationAnswers:m?.clarificationAnswers,epicContext:m?.epicContext,timelineAnalysis:m?.timelineAnalysis}});if(y)throw y;if(g.error)throw new Error(g.error);const b=(g.suggestions||[]).map(w=>({...w,selected:!1}));s(b)}catch(g){const y=g instanceof Error?g.message:"Failed to build suggestions";o(y),V.error(y)}finally{r(!1)}},[]),c=n.useCallback(f=>{s(m=>m.map(g=>g.id===f?{...g,selected:!g.selected}:g))},[]),d=n.useCallback(()=>{s(f=>f.map(m=>({...m,selected:!0})))},[]),u=n.useCallback(()=>{s(f=>f.map(m=>({...m,selected:!1})))},[]),p=n.useCallback(()=>t.filter(f=>f.selected),[t]),h=n.useCallback(()=>{s([]),o(null),r(!1)},[]);return{suggestions:t,isLoading:a,error:i,generateSuggestions:l,toggleSuggestion:c,selectAll:d,deselectAll:u,getSelectedSuggestions:p,reset:h}}const NS=()=>{const t=Ie(),{data:s,isLoading:a}=Ee({queryKey:["epic-templates"],queryFn:async()=>{const{data:l,error:c}=await k.from("epic_templates").select("*").order("is_featured",{ascending:!1}).order("popularity_count",{ascending:!1});if(c)throw c;return(l||[]).map(d=>({...d,habits:Array.isArray(d.habits)?d.habits:JSON.parse(d.habits||"[]")}))}}),r=he({mutationFn:async l=>{const{data:c,error:d}=await k.from("epic_templates").select("popularity_count").eq("id",l).maybeSingle();c?await k.from("epic_templates").update({popularity_count:(c.popularity_count||0)+1}).eq("id",l):d&&console.error("Error incrementing popularity:",d)},onSuccess:()=>{t.invalidateQueries({queryKey:["epic-templates"]})}}),i=s?.filter(l=>l.is_featured)||[];return{templates:s||[],featuredTemplates:i,isLoading:a,incrementPopularity:r}};function kS(){const{user:t}=_e(),{data:s,isLoading:a,refetch:r}=Ee({queryKey:["user-ai-context",t?.id],queryFn:async()=>{if(!t)return null;const{data:f,error:m}=await k.functions.invoke("enrich-user-context");return m?(console.error("Error fetching AI context:",m),null):f},enabled:!!t,staleTime:300*1e3,gcTime:600*1e3}),{data:i,isLoading:o,refetch:l}=Ee({queryKey:["user-ai-learning",t?.id],queryFn:async()=>{if(!t)return null;const{data:f,error:m}=await k.from("user_ai_learning").select("*").eq("user_id",t.id).maybeSingle();return m?(console.error("Error fetching AI learning profile:",m),null):f},enabled:!!t,staleTime:300*1e3,gcTime:600*1e3}),c=s?.atEpicLimit??!1,d=s?.overloaded??!1,u=s?.suggestedWorkload??"normal",p={epicDuration:i?.preferred_epic_duration??s?.preferredEpicDuration??30,habitDifficulty:i?.preferred_habit_difficulty??s?.preferredDifficulty??"medium",habitFrequency:i?.preferred_habit_frequency??s?.preferredHabitFrequency??"daily",commonContexts:i?.common_contexts??s?.commonContexts??[],preferenceWeights:i?.preference_weights??s?.preferenceWeights??{}};return{enrichedContext:s,learningProfile:i,isLoading:a||o,isContextLoading:a,isLearningLoading:o,isAtEpicLimit:c,isOverloaded:d,suggestedWorkload:u,capacityWarning:c?"You have 2 active campaigns. Consider completing one before starting another.":d?"You seem overloaded. Consider simplifying your current habits before adding more.":null,preferences:p,activeEpicCount:s?.activeEpics.length??0,activeHabitCount:s?.activeHabits.length??0,completionRate:s?.completionRates.thisWeek??0,refetch:()=>{r(),l()},refetchContext:r,refetchLearning:l}}function CS(t={}){const{debounceMs:s=500,minInputLength:a=10,useOrchestrator:r=!1}=t,[i,o]=n.useState(null),[l,c]=n.useState(!1),[d,u]=n.useState(null),[p,h]=n.useState(null),f=n.useRef(null),m=n.useRef(""),g=n.useCallback(async N=>{if(!N||N.length<a)return o(null),null;if(N===m.current)return i;m.current=N,c(!0),u(null);try{const D=r?"ai-orchestrator":"classify-task-intent",R=r?{input:N,interactionType:"classify"}:{input:N},{data:_,error:C}=await k.functions.invoke(D,{body:R});if(C)throw new Error(C.message);if(_?.error)throw new Error(_.error);let E;return r?(E={type:_.type||"quest",confidence:_.confidence||0,reasoning:_.reasoning||"",suggestedDeadline:_.suggestedDeadline,suggestedDuration:_.suggestedDuration,needsClarification:_.needsClarification,clarifyingQuestion:_.clarifyingQuestion,clarificationContext:_.clarificationContext,extractedTasks:_.extractedTasks,suggestedTasks:_.suggestedTasks,detectedContext:_.detectedContext,epicClarifyingQuestions:_.epicClarifyingQuestions,epicContext:_.epicContext,epicDetails:_.epicDetails,timelineAnalysis:_.timelineAnalysis,capacityWarnings:_.capacityWarnings,warning:_.warning},_.capacityWarnings?h(_.capacityWarnings):_.enrichedContext&&h({atEpicLimit:_.enrichedContext.atEpicLimit??!1,overloaded:_.enrichedContext.overloaded??!1,suggestedWorkload:_.enrichedContext.suggestedWorkload??"normal"})):E=_,o(E),E}catch(D){return console.error("Intent classification error:",D),u(D instanceof Error?D.message:"Classification failed"),o(null),null}finally{c(!1)}},[i,a,r]),y=n.useCallback(async(N,D)=>{if(!N||!D)return null;c(!0),u(null);try{const{data:R,error:_}=await k.functions.invoke("classify-task-intent",{body:{input:N,clarification:D,previousContext:i?.clarificationContext}});if(_)throw new Error(_.message);if(R?.error)throw new Error(R.error);const C=R;return o(C),C}catch(R){return console.error("Intent clarification error:",R),u(R instanceof Error?R.message:"Clarification failed"),null}finally{c(!1)}},[i?.clarificationContext]),b=n.useCallback(async(N,D)=>{if(!N||!D||Object.keys(D).length===0)return null;c(!0),u(null);try{const{data:R,error:_}=await k.functions.invoke("classify-task-intent",{body:{input:N,epicAnswers:D}});if(_)throw new Error(_.message);if(R?.error)throw new Error(R.error);const C=R;return o(C),C}catch(R){return console.error("Epic clarification error:",R),u(R instanceof Error?R.message:"Epic clarification failed"),null}finally{c(!1)}},[]),w=n.useCallback(N=>{if(f.current&&clearTimeout(f.current),!N||N.length<a){o(null);return}f.current=setTimeout(()=>{g(N)},s)},[g,s,a]),x=n.useCallback(()=>{f.current&&clearTimeout(f.current),o(null),u(null),c(!1),m.current=""},[]);n.useEffect(()=>()=>{f.current&&clearTimeout(f.current)},[]);const v=i?.type==="epic"&&i.confidence>=.6,j=i?.type==="habit"&&i.confidence>=.6,T=i?.type==="brain-dump"&&i.confidence>=.7&&(i.extractedTasks?.length??0)>=2,S=v&&i?.needsClarification===!0&&(i?.epicClarifyingQuestions?.length??0)>0;return{classification:i,isClassifying:l,error:d,classify:g,clarify:y,clarifyEpic:b,classifyDebounced:w,reset:x,isEpicDetected:v,isHabitDetected:j,isBrainDumpDetected:T,needsClarification:i?.needsClarification??!1,clarifyingQuestion:i?.clarifyingQuestion,extractedTasks:i?.extractedTasks??[],suggestedTasks:i?.suggestedTasks??[],detectedContext:i?.detectedContext,needsEpicClarification:S,epicClarifyingQuestions:i?.epicClarifyingQuestions??[],epicContext:i?.epicContext,epicDetails:i?.epicDetails,timelineAnalysis:i?.timelineAnalysis??null,capacityWarnings:p,capacityWarning:i?.warning??null,isAtEpicLimit:p?.atEpicLimit??!1,isOverloaded:p?.overloaded??!1}}const SS={easy:"bg-green-500/10 text-green-500 border-green-500/30",medium:"bg-amber-500/10 text-amber-500 border-amber-500/30",hard:"bg-red-500/10 text-red-500 border-red-500/30"},ES={daily:"Daily",weekdays:"Weekdays","5x_week":"5x/week","3x_week":"3x/week",weekly:"Weekly",custom:"Custom"},TS=n.memo(function({ritual:s,onUpdate:a,onDelete:r,isEditing:i=!1}){const[o,l]=n.useState(i),[c,d]=n.useState(s),u=()=>{a(c),l(!1)},p=()=>{d(s),l(!1)},h=(m,g)=>{d({...c,frequency:m,customDays:g})};if(o)return e.jsxs(P.div,{layout:!0,className:"p-3 rounded-lg border bg-muted/30 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(mt,{value:c.title,onChange:m=>d({...c,title:m.target.value}),placeholder:"Ritual name",className:"font-medium"}),e.jsx(mt,{value:c.description,onChange:m=>d({...c,description:m.target.value}),placeholder:"Description (optional)",className:"text-sm"})]}),e.jsx(df,{frequency:c.frequency==="3x_week"?"custom":c.frequency,customDays:c.customDays||uf(c.frequency),onFrequencyChange:h}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] text-muted-foreground mb-1 block",children:"Difficulty"}),e.jsxs(Qr,{value:c.difficulty,onValueChange:m=>d({...c,difficulty:m}),children:[e.jsx(lr,{className:"h-8 text-xs",children:e.jsx(Wr,{})}),e.jsxs(cr,{children:[e.jsx(ra,{value:"easy",children:"Easy"}),e.jsx(ra,{value:"medium",children:"Medium"}),e.jsx(ra,{value:"hard",children:"Hard"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] text-muted-foreground mb-1 block",children:"Minutes"}),e.jsx(mt,{type:"number",value:c.estimatedMinutes||"",onChange:m=>d({...c,estimatedMinutes:parseInt(m.target.value)||void 0}),placeholder:"15",className:"h-8 text-xs"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(z,{size:"sm",variant:"outline",className:"flex-1",onClick:p,children:[e.jsx(kt,{className:"w-3 h-3 mr-1"}),"Cancel"]}),e.jsxs(z,{size:"sm",className:"flex-1",onClick:u,children:[e.jsx(Rt,{className:"w-3 h-3 mr-1"}),"Save"]})]})]});const f=sS(s.customDays||[]);return e.jsxs(P.div,{layout:!0,className:"group flex items-center gap-2 p-3 rounded-lg border bg-background hover:bg-muted/30 transition-colors",children:[e.jsx(mx,{className:"w-4 h-4 text-muted-foreground/50 cursor-grab"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-sm truncate",children:s.title}),e.jsx(Oe,{variant:"outline",className:I("text-[10px] px-1.5 py-0",SS[s.difficulty]),children:s.difficulty})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:ES[s.frequency]}),f&&s.frequency!=="daily"&&e.jsx(e.Fragment,{children:e.jsxs("span",{className:"text-[10px] opacity-70",children:["(",f,")"]})}),s.estimatedMinutes&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"â€¢"}),e.jsx(Ht,{className:"w-3 h-3"}),e.jsxs("span",{children:[s.estimatedMinutes,"min"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(z,{size:"icon",variant:"ghost",className:"h-7 w-7",onClick:()=>l(!0),children:e.jsx(px,{className:"w-3.5 h-3.5"})}),e.jsx(z,{size:"icon",variant:"ghost",className:"h-7 w-7 text-destructive hover:text-destructive",onClick:()=>r(s.id),children:e.jsx(oa,{className:"w-3.5 h-3.5"})})]})]})});function MS({rituals:t,originalRituals:s,onRitualsChange:a,className:r}){const[i,o]=n.useState(!1),[l,c]=n.useState(""),d=n.useMemo(()=>t.reduce((y,b)=>{const w=b.estimatedMinutes||15,v={daily:7,"5x_week":5,"3x_week":3,weekly:1,custom:3}[b.frequency]||3;return y+w*v},0),[t]),u=Math.round(d/60*10)/10,p=y=>{a(t.map(b=>b.id===y.id?y:b))},h=y=>{a(t.filter(b=>b.id!==y))},f=()=>{if(!l.trim())return;const y={id:`custom-${Date.now()}`,title:l.trim(),description:"",frequency:"daily",difficulty:"medium",estimatedMinutes:15};a([...t,y]),c(""),o(!1)},m=()=>{a([...s])},g=JSON.stringify(t)!==JSON.stringify(s);return e.jsxs("div",{className:I("space-y-4",r),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(Oe,{variant:"secondary",className:"gap-1",children:[e.jsx(be,{className:"w-3 h-3"}),t.length," Rituals"]}),e.jsxs(Oe,{variant:"outline",className:"gap-1",children:[e.jsx(Ht,{className:"w-3 h-3"}),"~",u," hrs/week"]})]}),g&&e.jsxs(z,{variant:"ghost",size:"sm",onClick:m,className:"text-xs gap-1",children:[e.jsx(hx,{className:"w-3 h-3"}),"Reset"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Re,{mode:"popLayout",children:t.map(y=>e.jsx(P.div,{layout:!0,initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,x:-20},children:e.jsx(TS,{ritual:y,onUpdate:p,onDelete:h})},y.id))}),e.jsx(Re,{children:i?e.jsxs(P.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"flex gap-2",children:[e.jsx(mt,{value:l,onChange:y=>c(y.target.value),placeholder:"New ritual name...",className:"flex-1",autoFocus:!0,onKeyDown:y=>{y.key==="Enter"&&f(),y.key==="Escape"&&o(!1)}}),e.jsx(z,{size:"sm",onClick:f,disabled:!l.trim(),children:"Add"}),e.jsx(z,{size:"sm",variant:"outline",onClick:()=>o(!1),children:"Cancel"})]}):e.jsx(P.div,{layout:!0,children:e.jsxs(z,{variant:"outline",size:"sm",className:"w-full border-dashed gap-2",onClick:()=>o(!0),children:[e.jsx(qr,{className:"w-4 h-4"}),"Add Custom Ritual"]})})})]}),e.jsxs("div",{className:"flex gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-green-500"}),t.filter(y=>y.difficulty==="easy").length," easy"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-amber-500"}),t.filter(y=>y.difficulty==="medium").length," medium"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-red-500"}),t.filter(y=>y.difficulty==="hard").length," hard"]})]})]})}const DS=n.memo(function({milestones:s,storyType:a,className:r}){const i=n.useMemo(()=>s.filter(o=>o.isPostcardMilestone),[s]);return i.length===0?null:e.jsxs("div",{className:I("space-y-3",r),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(fx,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"font-medium text-sm",children:"Your Story Chapters"}),e.jsxs(Oe,{variant:"secondary",className:"text-xs ml-auto",children:[i.length," chapters"]})]}),e.jsx("div",{className:"grid gap-2",children:i.map((o,l)=>e.jsxs(P.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:l*.1},className:"relative overflow-hidden rounded-lg border bg-gradient-to-r from-amber-500/5 to-orange-500/5 p-3",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent -translate-x-full animate-[shimmer_2s_infinite]"}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-gradient-to-br from-amber-500/20 to-orange-500/20 border border-amber-500/30 flex items-center justify-center flex-shrink-0",children:e.jsx(be,{className:"w-5 h-5 text-amber-500"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-0.5",children:[e.jsxs("span",{className:"text-xs font-medium text-amber-600",children:["Chapter ",l+1]}),e.jsx(Mt,{className:"w-3 h-3 text-amber-500"})]}),e.jsx("p",{className:"font-medium text-sm truncate",children:o.title}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground mt-1",children:[e.jsx(Jr,{className:"w-3 h-3"}),e.jsx("span",{className:"italic",children:"Location revealed on completion"})]})]}),e.jsxs(Oe,{variant:"outline",className:"text-[10px] flex-shrink-0",children:[o.milestonePercent,"%"]})]})]},o.id))}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Complete milestones to unlock cosmic postcards from your companion's journey"})]})}),AS=n.memo(function({isAtEpicLimit:s=!1,isOverloaded:a=!1,suggestedWorkload:r="normal",isLoading:i=!1,className:o}){const l=s||a;return i?null:e.jsx(Re,{children:l&&e.jsxs(P.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:I("px-3 py-2 rounded-lg text-xs flex items-center gap-2",a?"bg-destructive/10 border border-destructive/30 text-destructive":"bg-amber-500/10 border border-amber-500/30 text-amber-600 dark:text-amber-400",o),children:[e.jsx(ca,{className:"h-3.5 w-3.5 flex-shrink-0"}),e.jsx("span",{children:a?"You seem overloaded. Consider simplifying current habits first.":s?"You have 2 active campaigns. Complete one before starting another.":r==="light"?"Consider a lighter workload today.":null})]})})}),ho=[{id:"heroic",label:"Heroic Gold",color:"from-amber-500 to-yellow-600",value:"#f59e0b"},{id:"warrior",label:"Warrior Red",color:"from-red-500 to-rose-600",value:"#ef4444"},{id:"nature",label:"Nature Green",color:"from-emerald-500 to-green-600",value:"#10b981"},{id:"mystic",label:"Mystic Pink",color:"from-pink-500 to-rose-600",value:"#ec4899"},{id:"solar",label:"Solar Orange",color:"from-orange-500 to-yellow-500",value:"#f97316"}];function PS({goal:t,questions:s,onSubmit:a,onSkip:r,isLoading:i=!1}){const[o,l]=n.useState({}),c=(m,g)=>{l(y=>({...y,[m]:g}))},d=(m,g)=>{l(y=>{const b=y[m]||[],w=b.includes(g)?b.filter(x=>x!==g):[...b,g];return{...y,[m]:w}})},u=()=>{const m={};Object.entries(o).forEach(([g,y])=>{Array.isArray(y)?m[g]=y.join(", "):m[g]=y}),a(m)},h=s.filter(m=>m.required).every(m=>{const g=o[m.id];return m.multiSelect?Array.isArray(g)&&g.length>0:g!==void 0&&g!==""}),f=m=>m.includes("date")||m.includes("exam")||m.includes("target")?zt:m.includes("hours")||m.includes("time")||m.includes("days")?Ht:m.includes("subject")||m.includes("level")||m.includes("status")?Ir:It;return e.jsxs(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"bg-gradient-to-br from-primary/5 via-background to-primary/5 rounded-xl border border-primary/20 p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:e.jsx(be,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Let's personalize your epic"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-1",children:t})]})]}),e.jsx("div",{className:"space-y-4",children:s.map((m,g)=>{const y=f(m.id);return e.jsxs(P.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:g*.1},className:"space-y-2",children:[e.jsxs(ct,{className:"text-sm flex items-center gap-2",children:[e.jsx(y,{className:"w-4 h-4 text-muted-foreground"}),m.question,m.required&&e.jsx("span",{className:"text-destructive",children:"*"})]}),m.type==="select"&&m.options&&m.multiSelect?e.jsx("div",{className:"flex flex-wrap gap-2",children:m.options.map(b=>{const w=(o[m.id]||[]).includes(b);return e.jsxs("button",{type:"button",onClick:()=>d(m.id,b),className:I("px-3 py-1.5 rounded-full text-sm border transition-all flex items-center gap-1",w?"bg-primary text-primary-foreground border-primary":"bg-background border-border hover:border-primary/50"),children:[w&&e.jsx(Rt,{className:"w-3 h-3"}),b]},b)})}):m.type==="select"&&m.options&&e.jsxs(Qr,{value:o[m.id]?.toString()||"",onValueChange:b=>c(m.id,b),children:[e.jsx(lr,{className:"h-9",children:e.jsx(Wr,{placeholder:"Select an option..."})}),e.jsx(cr,{children:m.options.map(b=>e.jsx(ra,{value:b,children:b},b))})]}),m.type==="date"&&e.jsx(mt,{type:"date",value:o[m.id]?.toString()||"",onChange:b=>c(m.id,b.target.value),className:"h-9",min:new Date().toISOString().split("T")[0]}),m.type==="number"&&e.jsx(mt,{type:"number",value:o[m.id]?.toString()||"",onChange:b=>c(m.id,parseInt(b.target.value)||""),placeholder:m.placeholder||"Enter a number...",className:"h-9",min:1,max:24}),m.type==="text"&&e.jsx(mt,{type:"text",value:o[m.id]?.toString()||"",onChange:b=>c(m.id,b.target.value),placeholder:m.placeholder||"Type your answer...",className:"h-9"})]},m.id)})}),e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsx(z,{onClick:u,disabled:!h||i,className:"flex-1 h-10",children:i?e.jsxs(e.Fragment,{children:[e.jsx(Nt,{className:"w-4 h-4 mr-2 animate-spin"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(be,{className:"w-4 h-4 mr-2"}),"Generate My Epic",e.jsx(Dt,{className:"w-4 h-4 ml-1"})]})}),e.jsx(z,{variant:"ghost",size:"sm",onClick:r,disabled:i,className:"text-muted-foreground hover:text-foreground",children:"Skip"})]}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"This helps create a personalized study plan just for you"})]})}const RS=[{label:"2 weeks",getValue:()=>_o(new Date,2)},{label:"1 month",getValue:()=>Ja(new Date,1)},{label:"3 months",getValue:()=>Ja(new Date,3)},{label:"6 months",getValue:()=>Ja(new Date,6)},{label:"1 year",getValue:()=>Mx(new Date,1)}];function IS({value:t,onChange:s,minDate:a}){const[r,i]=n.useState(!1),o=a||Ts(new Date,7),l=t?Ft(t,new Date):null;return e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:RS.map(c=>{const d=c.getValue(),u=t&&ae(t,"yyyy-MM-dd")===ae(d,"yyyy-MM-dd");return e.jsx(z,{type:"button",variant:u?"default":"outline",size:"sm",onClick:()=>s(d),className:"flex-1 min-w-[80px]",children:c.label},c.label)})}),e.jsxs(qs,{open:r,onOpenChange:i,modal:!0,children:[e.jsx(Ls,{asChild:!0,children:e.jsxs(z,{variant:"outline",className:I("w-full justify-start text-left font-normal h-12",!t&&"text-muted-foreground"),children:[e.jsx(zt,{className:"mr-2 h-4 w-4"}),t?e.jsxs("span",{className:"flex items-center gap-2",children:[ae(t,"EEEE, MMMM d, yyyy"),l&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",l," days)"]})]}):e.jsx("span",{children:"Pick a specific date"})]})}),e.jsx(js,{className:"w-auto p-0 z-[100] pointer-events-auto",align:"start",onOpenAutoFocus:c=>c.preventDefault(),children:e.jsx(hr,{mode:"single",selected:t,onSelect:c=>{s(c),i(!1)},disabled:c=>c<o,initialFocus:!0,className:"pointer-events-auto",captionLayout:"dropdown",fromYear:new Date().getFullYear(),toYear:new Date().getFullYear()+10})})]}),t&&l&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(Ht,{className:"w-4 h-4"}),e.jsxs("span",{children:[l," days until deadline",l<=14&&e.jsxs("span",{className:"ml-2 text-amber-500 font-medium",children:[e.jsx(bt,{className:"w-3 h-3 inline mr-1"}),"Intensive"]})]})]})]})}function qS({phase:t,milestones:s,isFirst:a,isLast:r,onMilestoneToggle:i,onMilestoneDateChange:o,postcardCount:l=0,maxPostcards:c=7}){const[d,u]=n.useState(null),[p,h]=n.useState(new Set),f=Jt(t.startDate),m=x=>{h(v=>{const j=new Set(v);return j.has(x)?j.delete(x):j.add(x),j})},g=Jt(t.endDate),y=Ft(g,f)+1,b=["from-blue-500/20 to-cyan-500/20 border-blue-500/30","from-purple-500/20 to-pink-500/20 border-purple-500/30","from-amber-500/20 to-orange-500/20 border-amber-500/30","from-green-500/20 to-emerald-500/20 border-green-500/30","from-rose-500/20 to-red-500/20 border-rose-500/30"],w=b[(t.phaseOrder-1)%b.length];return e.jsxs("div",{className:"relative",children:[!a&&e.jsx("div",{className:"absolute left-6 -top-4 w-0.5 h-4 bg-border"}),e.jsxs("div",{className:I("p-4 rounded-xl border bg-gradient-to-br",w),children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-background/50 flex items-center justify-center font-bold text-sm",children:t.phaseOrder}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold",children:t.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[ae(f,"MMM d")," - ",ae(g,"MMM d")," (",y," days)"]})]})]}),e.jsxs(Oe,{variant:"outline",className:"text-xs",children:[y,"d"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:t.description}),s.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-xs font-medium text-muted-foreground flex items-center gap-1",children:[e.jsx(si,{className:"w-3 h-3"}),"Milestones"]}),s.map(x=>e.jsx("div",{className:I("w-full p-2.5 rounded-lg text-left transition-all","bg-background/50 hover:bg-background/80","border border-transparent hover:border-primary/30",x.isPostcardMilestone&&"ring-1 ring-amber-500/50"),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:v=>{v.stopPropagation(),i?.(x.id)},disabled:!x.isPostcardMilestone&&l>=c,className:I("flex-shrink-0 transition-all",x.isPostcardMilestone?"text-amber-500 hover:text-amber-600":l>=c?"text-muted-foreground/30 cursor-not-allowed":"text-muted-foreground hover:text-amber-500"),title:x.isPostcardMilestone?"Remove celebration milestone":l>=c?`Max ${c} postcards reached`:"Mark as celebration milestone",children:e.jsx(Mt,{className:"w-4 h-4",fill:x.isPostcardMilestone?"currentColor":"none"})}),e.jsxs("button",{onClick:()=>m(x.id),className:"flex-1 min-w-0 text-left flex items-center gap-1",children:[e.jsx(Dt,{className:I("w-3 h-3 flex-shrink-0 transition-transform",p.has(x.id)&&"rotate-90")}),e.jsx("p",{className:I("text-sm font-medium",p.has(x.id)?"whitespace-normal break-words":"truncate"),children:x.title})]}),e.jsxs(qs,{open:d===x.id,onOpenChange:v=>u(v?x.id:null),children:[e.jsx(Ls,{asChild:!0,children:e.jsxs(z,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-muted-foreground hover:text-foreground",onClick:v=>v.stopPropagation(),children:[e.jsx(zt,{className:"w-3 h-3 mr-1"}),ae(Jt(x.targetDate),"MMM d")]})}),e.jsx(js,{className:"w-auto p-0",align:"end",children:e.jsx(hr,{mode:"single",selected:Jt(x.targetDate),onSelect:v=>{v&&(o?.(x.id,ae(v,"yyyy-MM-dd")),u(null))},className:"pointer-events-auto"})})]}),x.isPostcardMilestone&&e.jsx(Oe,{variant:"secondary",className:"text-[10px] px-1 py-0 h-4 flex-shrink-0",children:"Postcard"})]})},x.id))]})]}),!r&&e.jsx("div",{className:"absolute left-6 -bottom-4 w-0.5 h-4 bg-border"})]})}function LS({feasibilityAssessment:t,phases:s,milestones:a,rituals:r,weeklyHoursEstimate:i,deadline:o,onMilestoneToggle:l,onMilestoneDateChange:c,postcardCount:d=0,maxPostcards:u=7}){const p=n.useMemo(()=>[...s].sort((g,y)=>g.phaseOrder-y.phaseOrder),[s]),h=n.useMemo(()=>{const g=new Map;return a.forEach(y=>{const b=g.get(y.phaseOrder)||[];g.set(y.phaseOrder,[...b,y])}),g},[a]),f={comfortable:{bg:"bg-green-500/10",text:"text-green-500",border:"border-green-500/30"},achievable:{bg:"bg-blue-500/10",text:"text-blue-500",border:"border-blue-500/30"},aggressive:{bg:"bg-amber-500/10",text:"text-amber-500",border:"border-amber-500/30"},very_aggressive:{bg:"bg-red-500/10",text:"text-red-500",border:"border-red-500/30"}},m=f[t.feasibility]||f.achievable;return e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:I("p-4 rounded-xl border",m.bg,m.border),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:I("p-2 rounded-lg",m.bg),children:e.jsx(zt,{className:I("w-5 h-5",m.text)})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("span",{className:"font-semibold text-sm",children:[t.daysAvailable," days available"]}),e.jsx(Oe,{variant:"outline",className:I("text-xs",m.text,m.border),children:Ps(t.feasibility)})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.message})]})]})}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Ht,{className:"w-4 h-4"}),e.jsxs("span",{children:["~",i," hrs/week"]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(Mt,{className:"w-4 h-4 text-amber-500"}),e.jsxs("span",{children:[d,"/",u," celebration milestones"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[p.map((g,y)=>e.jsx(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:y*.1},children:e.jsx(qS,{phase:g,milestones:h.get(g.phaseOrder)||[],isFirst:y===0,isLast:y===p.length-1,onMilestoneToggle:l,onMilestoneDateChange:c,postcardCount:d,maxPostcards:u})},g.id)),e.jsx(P.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{delay:p.length*.1},className:"p-4 bg-gradient-to-r from-primary/10 to-purple-500/10 rounded-xl border border-primary/30",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full bg-primary/20",children:e.jsx(si,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Goal Complete!"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:ae(Jt(o),"EEEE, MMMM d, yyyy")})]}),e.jsx(be,{className:"w-5 h-5 text-primary ml-auto animate-pulse"})]})})]}),e.jsxs("div",{className:"p-4 rounded-lg bg-muted/30 border",children:[e.jsxs("p",{className:"text-xs font-medium text-muted-foreground mb-2",children:["Daily & Weekly Rituals (",r.length,")"]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.slice(0,4).map(g=>e.jsx(Oe,{variant:"secondary",className:"text-xs",children:g.title},g.id)),r.length>4&&e.jsxs(Oe,{variant:"outline",className:"text-xs",children:["+",r.length-4," more"]})]})]})]})}const OS=[{label:"Less aggressive",value:"Make the schedule less aggressive, I need more breathing room"},{label:"More intensive",value:"I can dedicate more time, make it more intensive"},{label:"Fewer milestones",value:"Reduce the number of milestones, keep only the essential ones"},{label:"More rest days",value:"Include more rest days and recovery time"}];function FS({onSubmit:t,isLoading:s}){const[a,r]=n.useState(""),[i,o]=n.useState(!1),l=d=>{t(d)},c=()=>{a.trim()&&(t(a.trim()),r(""),o(!1))};return s?e.jsxs("div",{className:"p-4 bg-muted/50 rounded-xl border border-dashed flex items-center justify-center gap-2",children:[e.jsx(Nt,{className:"w-4 h-4 animate-spin text-primary"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Adjusting your plan..."})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(am,{className:"w-4 h-4"}),"Want to adjust the plan?"]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[OS.map(d=>e.jsx(z,{variant:"outline",size:"sm",onClick:()=>l(d.value),className:"text-xs",children:d.label},d.label)),e.jsxs(z,{variant:"ghost",size:"sm",onClick:()=>o(!i),className:"text-xs",children:[e.jsx(be,{className:"w-3 h-3 mr-1"}),"Custom request"]})]}),i&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(mt,{placeholder:"e.g., 'I have prior experience, skip the basics'",value:a,onChange:d=>r(d.target.value),onKeyDown:d=>d.key==="Enter"&&c(),className:"flex-1"}),e.jsx(z,{onClick:c,disabled:!a.trim(),size:"sm",children:"Adjust"})]})]})}const $S=[{id:"experience_level",question:"What is your current experience level?",type:"select",options:["Complete beginner","Some experience","Intermediate","Advanced"],required:!0},{id:"daily_time",question:"How much time can you dedicate daily?",type:"text",placeholder:"e.g., 1-2 hours, 30 minutes",required:!0},{id:"priority_focus",question:"What aspect is most important to you?",type:"text",placeholder:"e.g., speed, thoroughness, consistency",required:!1}];function BS({open:t,onOpenChange:s,onCreateEpic:a,isCreating:r,initialGoal:i="",initialTargetDays:o,template:l,showTemplatesFirst:c=!1,clarificationAnswers:d,epicContext:u}){const p=n.useRef(!1),h=n.useRef(null),[f,m]=n.useState("goal"),[g,y]=n.useState(i),[b,w]=n.useState(void 0),[x,v]=n.useState(""),{preferences:j,isAtEpicLimit:T}=kS(),{trackInteraction:S}=vl(),{schedule:N,isLoading:D,generateSchedule:R,adjustSchedule:_,toggleMilestone:C,updateMilestoneDate:E,reset:O,setRituals:M,postcardCount:A,maxPostcards:L}=Ih(),[q,$]=n.useState([]),{classify:B,isClassifying:W,clarifyEpic:H,reset:K}=CS({useOrchestrator:!1}),[X,Y]=n.useState(!1),[ee,ie]=n.useState([]),[fe,U]=n.useState({}),[ce,se]=n.useState(void 0),ne=n.useMemo(()=>b?Math.max(7,Ft(b,new Date)):o||j.epicDuration||30,[b,o,j.epicDuration]),[xe,G]=n.useState(""),[ye,we]=n.useState(""),[Te,qe]=n.useState([]),[Se,Pe]=n.useState(null),[$e,Be]=n.useState(ho[0].id),[Me,Qe]=n.useState(l||null),{medium:De,success:ve,light:Z,tap:Q}=Kp();NS();const{suggestions:J,error:de,getSelectedSuggestions:oe,reset:Fe}=jS(),[Je,pt]=n.useState(""),{isRecording:nt,isAutoStopping:Ct,startRecording:lt,stopRecording:me}=lf({onInterimResult:je=>pt(je),onFinalResult:je=>{y(dt=>(dt?dt+" "+je:je).trim()),pt(""),ve()},autoStopOnSilence:!0,silenceTimeoutMs:2e3});n.useEffect(()=>{if(Me&&t){G(Me.name),we(Me.description),w(Ts(new Date,Me.target_days)),Be(Me.theme_color||ho[0].id);const je=vt=>vt==="daily"?"daily":vt==="5x_week"?"5x_week":vt==="3x_week"||vt==="weekly"?"3x_week":"custom",dt=Me.habits.map((vt,at)=>({id:`template-${at}`,type:"habit",title:vt.title,description:"",difficulty:vt.difficulty||"medium",frequency:je(vt.frequency||"daily"),selected:!0}));qe(dt),m("goal")}},[Me,t]),n.useEffect(()=>{l&&t&&Qe(l)},[l,t]),n.useEffect(()=>{t||(p.current=!1)},[t]),n.useEffect(()=>{h.current&&h.current.scrollTo({top:0,behavior:"instant"})},[f]);const Ae=n.useMemo(()=>oe(),[oe]),Ue=n.useMemo(()=>N?.rituals?(console.log("[Pathfinder] Mapping schedule rituals:",N.rituals.length,N.rituals.map(je=>({title:je.title,estimatedMinutes:je.estimatedMinutes}))),N.rituals.map(je=>({id:je.id,title:je.title,description:je.description,type:"habit",difficulty:je.difficulty,frequency:je.frequency,estimatedMinutes:je.estimatedMinutes,isSelected:!0}))):[...Ae.filter(je=>je.type==="habit"),...Te],[N,Ae,Te]),xt=n.useMemo(()=>N?.milestones||Ae.filter(je=>je.type==="milestone"),[N,Ae]),Pt=n.useMemo(()=>ne*Z0.XP_PER_DAY,[ne]),ge=n.useCallback(async(je,dt)=>{if(!g.trim()||!b)return;Q();const vt=ae(b,"yyyy-MM-dd"),at=je??(Object.keys(fe).length>0?fe:d),re=await R({goal:g,deadline:vt,clarificationAnswers:at,epicContext:dt??ce??u,timelineContext:x.trim()||void 0});if(!re){V.error("Failed to build timeline",{description:"Please try again or adjust your goal"});return}re.rituals&&$([...re.rituals]),re.suggestedStoryType&&Pe(re.suggestedStoryType),re.suggestedThemeColor&&Be(re.suggestedThemeColor),xe||G(g),m("timeline"),ve()},[g,b,d,u,fe,ce,x,xe,R,Q,ve]),Le=n.useCallback(async je=>{if(!N||!b)return;await _({goal:g,deadline:ae(b,"yyyy-MM-dd"),adjustmentRequest:je,previousSchedule:{phases:N.phases,milestones:N.milestones,rituals:N.rituals}})?(ve(),V.success("Schedule updated!",{description:je.toLowerCase().includes("intensive")?"Made your plan more intensive":je.toLowerCase().includes("less")||je.toLowerCase().includes("breathing")?"Made your plan more relaxed":"Adjusted based on your feedback"})):(Z(),V.error("Failed to adjust schedule",{description:"Please try again"}))},[N,b,g,_,ve,Z]),He=n.useCallback(()=>{N&&(m("suggestions"),De())},[N,De]),wt=n.useCallback(async()=>{if(!g.trim()||!b)return;Q();const je=await B(g);if(console.log("[Pathfinder] Classification result:",{input:g,type:je?.type,confidence:je?.confidence,needsClarification:je?.needsClarification,questionsCount:je?.epicClarifyingQuestions?.length,epicContext:je?.epicContext}),je?.type==="epic"){const dt=je.epicClarifyingQuestions?.length?je.epicClarifyingQuestions:$S;ie(dt),Y(!0)}else xe||G(g),await ge()},[g,b,xe,B,Q,ge]),ht=n.useCallback(async je=>{U(je),Y(!1);const vt=(await H(g,je))?.epicContext;vt&&se(vt),xe||G(g),await ge(je,vt)},[g,H,xe,ge]),qt=n.useCallback(async()=>{Y(!1),xe||G(g),await ge()},[g,xe,ge]),St=n.useCallback(()=>{m("review"),De()},[De]),Xs=n.useCallback(()=>{if(Ue.length===0){console.warn("Cannot create epic: no habits selected");return}const je=Ue.map(at=>({title:at.title,description:at.description,difficulty:at.difficulty,frequency:at.frequency||"daily",custom_days:at.customDays||uf(at.frequency||"daily"),estimated_minutes:at.estimatedMinutes}));console.log("[Pathfinder] Creating epic with habits:",je.length,je.map(at=>at.title)),je.length<2&&N?.rituals&&N.rituals.length>je.length&&console.warn("[Pathfinder] Habit count mismatch! Schedule has",N.rituals.length,"but habits array has",je.length);const dt=N?.milestones.map(at=>({title:at.title,description:at.description,target_date:at.targetDate,milestone_percent:at.milestonePercent,is_postcard_milestone:at.isPostcardMilestone}));console.log("[Pathfinder] Creating epic with milestones:",dt?.length||0,dt);const vt=N?.phases.map(at=>({name:at.name,description:at.description,start_date:at.startDate,end_date:at.endDate,phase_order:at.phaseOrder}));S({interactionType:"epic-creation",inputText:g,aiResponse:{totalSuggestions:J?.length||0,selectedHabits:Ue.length,targetDays:ne,storyType:Se,hasSchedule:!!N},userAction:"accepted",detectedIntent:"epic"}),a({title:xe||g,description:ye||void 0,target_days:ne,habits:je,milestones:dt,phases:vt,is_public:!0,story_type_slug:Se||void 0,theme_color:$e}),ve()},[Ue,xe,g,ye,ne,Se,$e,N,a,ve,S,J]),Ns=n.useCallback(()=>{Z(),f==="timeline"?m("goal"):f==="suggestions"?m("timeline"):f==="review"&&m("suggestions")},[f,Z]),ns=n.useCallback(()=>{m("goal"),y(i),w(void 0),v(""),G(""),we(""),qe([]),Pe(null),Be(ho[0].id),Qe(null),Y(!1),ie([]),U({}),se(void 0),Fe(),O(),K(),s(!1)},[s,Fe,O,K,i]),Lt=n.useCallback(()=>{nt?me():lt(),Q()},[nt,lt,me,Q]),Os=["goal","timeline","suggestions","review"],Js=Os.indexOf(f);return e.jsx(as,{open:t,onOpenChange:ns,children:e.jsxs(Qt,{className:"sm:max-w-lg max-h-[90vh] flex flex-col p-0",children:[e.jsxs(Is,{className:"p-6 pb-4",children:[e.jsxs(ps,{className:"flex items-center gap-2",children:[e.jsx(be,{className:"w-5 h-5 text-primary"}),"Pathfinder"]}),e.jsxs(Vs,{children:[f==="goal"&&"Set your goal and deadline",f==="timeline"&&"Review your personalized timeline",f==="suggestions"&&"Confirm your rituals and milestones",f==="review"&&"Review and create your campaign"]})]}),T&&e.jsx("div",{className:"px-6 pb-2",children:e.jsx(AS,{isAtEpicLimit:T,isLoading:!1})}),e.jsx("div",{className:"px-6 pb-4",children:e.jsx("div",{className:"flex items-center justify-center gap-2",children:Os.map((je,dt)=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:I("w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all",f===je?"bg-primary text-primary-foreground":Js>dt?"bg-primary/20 text-primary":"bg-muted text-muted-foreground"),children:Js>dt?e.jsx(Rt,{className:"w-4 h-4"}):dt+1}),dt<Os.length-1&&e.jsx("div",{className:I("w-4 h-0.5 mx-1",Js>dt?"bg-primary":"bg-muted")})]},je))})}),e.jsx("div",{ref:h,className:"flex-1 min-h-0 overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:e.jsxs(Re,{mode:"wait",children:[f==="goal"&&e.jsxs(P.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"px-6 pb-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ct,{htmlFor:"goal-input",className:"text-base font-semibold",children:"What's your goal?"}),e.jsxs("div",{className:"relative",children:[e.jsx(Zt,{id:"goal-input",placeholder:"e.g., Pass the bar exam, Run a marathon, Learn Spanish",value:nt?g+(Je?" "+Je:""):g,onChange:je=>y(je.target.value),rows:3,className:"pr-12 text-base"}),e.jsx(z,{size:"icon",variant:nt?"default":"ghost",className:I("absolute right-2 top-2 h-8 w-8",nt&&"animate-pulse bg-red-500 hover:bg-red-600"),onClick:Lt,disabled:Ct,children:e.jsx(sm,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ct,{htmlFor:"context-input",className:"text-base font-semibold flex items-center gap-2",children:["List current experience",e.jsx("span",{className:"text-sm font-normal text-muted-foreground",children:"(optional)"})]}),e.jsx(Zt,{id:"context-input",placeholder:"e.g., Already know basics, studying for 2 weeks, starting from scratch",value:x,onChange:je=>v(je.target.value),rows:2,className:"text-base"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(ct,{className:"text-base font-semibold flex items-center gap-2",children:[e.jsx(zt,{className:"w-4 h-4"}),"When do you need to achieve this?"]}),e.jsx(IS,{value:b,onChange:w})]}),e.jsx(Re,{children:X&&ee.length>0&&e.jsx(PS,{goal:g,questions:ee,onSubmit:ht,onSkip:qt,isLoading:W})}),!X&&e.jsx(z,{onClick:wt,disabled:!g.trim()||!b||W||D,className:"w-full h-12 text-base",size:"lg",children:W?e.jsxs(e.Fragment,{children:[e.jsx(Nt,{className:"w-4 h-4 mr-2 animate-spin"}),"Analyzing your goal..."]}):D?e.jsxs(e.Fragment,{children:[e.jsx(Nt,{className:"w-4 h-4 mr-2 animate-spin"}),"Building your plan..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ia,{className:"w-5 h-5 mr-2"}),"Build My Plan"]})}),de&&e.jsx("p",{className:"text-sm text-destructive text-center",children:de})]},"goal"),f==="timeline"&&N&&b&&e.jsx(P.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"flex flex-col h-full min-h-0",children:e.jsx("div",{className:"flex-1 overflow-y-auto px-4 overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:e.jsxs("div",{className:"space-y-4 pb-4",children:[e.jsx(LS,{feasibilityAssessment:N.feasibilityAssessment,phases:N.phases,milestones:N.milestones,rituals:N.rituals,weeklyHoursEstimate:N.weeklyHoursEstimate,deadline:ae(b,"yyyy-MM-dd"),onMilestoneToggle:C,onMilestoneDateChange:E,postcardCount:A,maxPostcards:L}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(FS,{onSubmit:Le,isLoading:D})}),e.jsxs("div",{className:"space-y-3 pt-2",children:[e.jsxs(z,{onClick:He,className:"w-full",children:["Continue with this plan",e.jsx(Dt,{className:"w-4 h-4 ml-1"})]}),e.jsxs(z,{variant:"ghost",onClick:Ns,className:"w-full",children:[e.jsx(Xa,{className:"w-4 h-4 mr-1"}),"Back"]})]})]})})},"timeline"),f==="suggestions"&&e.jsxs(P.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"flex flex-col h-full min-h-0",children:[e.jsx("div",{className:"flex-1 overflow-y-auto px-6 overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:e.jsxs("div",{className:"space-y-4 pb-4",children:[N?.rituals&&e.jsx(MS,{rituals:N.rituals,originalRituals:q,onRitualsChange:M}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(si,{className:"w-4 h-4"}),"Milestones (",xt.length,")"]}),xt.map(je=>e.jsx("div",{className:"p-3 bg-amber-500/10 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:je.title}),e.jsx(Oe,{variant:"outline",children:je.targetDate?ae(Jt(je.targetDate),"MMM d"):`Week ${je.suggestedWeek}`})]})},je.id))]}),N?.milestones&&e.jsx(DS,{milestones:N.milestones,storyType:Se})]})}),e.jsxs("div",{className:"p-6 pt-4 border-t bg-background space-y-3",children:[e.jsxs(z,{onClick:St,className:"w-full",children:["Continue to Review",e.jsx(Dt,{className:"w-4 h-4 ml-1"})]}),e.jsxs(z,{variant:"ghost",onClick:Ns,className:"w-full",children:[e.jsx(Xa,{className:"w-4 h-4 mr-1"}),"Back to Timeline"]})]})]},"suggestions"),f==="review"&&e.jsxs(P.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"flex flex-col h-full min-h-0",children:[e.jsx("div",{className:"flex-1 overflow-y-auto px-6 overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:e.jsxs("div",{className:"space-y-4 pb-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ct,{htmlFor:"epic-why",children:"Your Why"}),e.jsx(Zt,{id:"epic-why",value:ye,onChange:je=>we(je.target.value),placeholder:"Why are you embarking on this campaign? What's your purpose?",rows:3}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Define your purpose - this will fuel your motivation"})]}),ye.trim().length>0&&e.jsxs(P.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-2",children:[e.jsx(ct,{htmlFor:"epic-title",children:"Campaign Name"}),e.jsx(mt,{id:"epic-title",value:xe,onChange:je=>G(je.target.value),placeholder:"Name your campaign"})]}),e.jsxs("div",{className:"p-4 bg-gradient-to-r from-primary/10 to-purple-500/10 rounded-xl border border-primary/20",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(bt,{className:"w-5 h-5 text-primary"}),e.jsx("span",{className:"font-medium",children:"Completion Reward"})]}),e.jsxs("span",{className:"text-xl font-bold text-primary",children:["+",Pt," XP"]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[ne," days â€¢ ",Ue.length," rituals â€¢ ",xt.length," milestones"]})]})]})}),e.jsxs("div",{className:"p-6 pt-4 border-t bg-background space-y-3",children:[e.jsx(z,{onClick:Xs,disabled:T||r||Ue.length===0||ye.trim().length===0||xe.trim().length===0,className:"w-full bg-gradient-to-r from-primary to-purple-600",children:r?e.jsxs(e.Fragment,{children:[e.jsx(Nt,{className:"w-4 h-4 mr-2 animate-spin"}),"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(It,{className:"w-4 h-4 mr-2"}),"Create Campaign"]})}),e.jsxs(z,{variant:"ghost",onClick:Ns,className:"w-full",children:[e.jsx(Xa,{className:"w-4 h-4 mr-1"}),"Back"]})]})]},"review")]})})]})})}const US={easy:{label:"Easy",color:"text-green-500 bg-green-500/10 border-green-500/20"},medium:{label:"Medium",color:"text-amber-500 bg-amber-500/10 border-amber-500/20"},hard:{label:"Hard",color:"text-red-500 bg-red-500/10 border-red-500/20"}},HS={daily:"Daily",weekly:"Weekly",custom:"Custom Days"};n.memo(function({suggestion:s,onToggle:a,index:r}){const i=s.type==="habit",o=US[s.difficulty];return e.jsx(P.button,{initial:{opacity:0,y:20,scale:.95},animate:{opacity:1,y:0,scale:1},transition:{delay:r*.08,duration:.3},onClick:()=>a(s.id),className:I("w-full p-4 rounded-xl border-2 text-left transition-all duration-200","hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]",s.selected?"border-primary bg-primary/5 shadow-md":"border-border/50 bg-card hover:border-primary/30"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:I("w-6 h-6 rounded-full border-2 flex items-center justify-center shrink-0 mt-0.5 transition-all",s.selected?"border-primary bg-primary text-primary-foreground":"border-muted-foreground/30"),children:s.selected&&e.jsx(Rt,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[i?e.jsx(nr,{className:"w-4 h-4 text-primary shrink-0"}):e.jsx(si,{className:"w-4 h-4 text-amber-500 shrink-0"}),e.jsx("span",{className:"font-semibold text-foreground truncate",children:s.title})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2 mb-2",children:No(s.description)}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("span",{className:I("text-xs px-2 py-0.5 rounded-full border",i?"text-primary bg-primary/10 border-primary/20":"text-amber-500 bg-amber-500/10 border-amber-500/20"),children:i?"Habit":"Milestone"}),i&&s.frequency&&e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-secondary text-secondary-foreground",children:HS[s.frequency]||s.frequency}),!i&&s.suggestedWeek&&e.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full bg-secondary text-secondary-foreground",children:["Week ",s.suggestedWeek]}),e.jsx("span",{className:I("text-xs px-2 py-0.5 rounded-full border",o.color),children:o.label}),s.category&&e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-muted text-muted-foreground",children:s.category})]})]})]})})});function zS({isVisible:t,campaignTitle:s,habits:a,onComplete:r}){const[i,o]=n.useState(!1),[l,c]=n.useState("title");return n.useEffect(()=>{if(!t){c("title"),o(!1);return}const d=setTimeout(()=>c("habits"),800),u=setTimeout(()=>o(!0),1200),p=setTimeout(()=>c("flyout"),2500+a.length*200),h=setTimeout(r,3500+a.length*200);return()=>{clearTimeout(d),clearTimeout(u),clearTimeout(p),clearTimeout(h)}},[t,a.length,r]),t?e.jsx(Re,{children:e.jsxs(P.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-[100] flex items-center justify-center bg-background/95 backdrop-blur-sm",onClick:r,children:[i&&e.jsx(gx,{width:window.innerWidth,height:window.innerHeight,recycle:!1,numberOfPieces:150,gravity:.3,colors:["#a855f7","#ec4899","#f59e0b","#10b981","#3b82f6"]}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",children:e.jsx(P.div,{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 rounded-full bg-primary/20 blur-3xl",animate:{scale:[1,1.2,1],opacity:[.3,.5,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}})}),e.jsxs("div",{className:"relative z-10 flex flex-col items-center gap-6 px-6 max-w-md mx-auto",children:[e.jsxs(P.div,{initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",damping:12,stiffness:200},className:"text-center",children:[e.jsxs(P.div,{className:"flex items-center justify-center gap-2 mb-2",animate:{scale:[1,1.05,1]},transition:{duration:1.5,repeat:1/0},children:[e.jsx(be,{className:"w-6 h-6 text-stardust-gold"}),e.jsx("span",{className:"text-sm font-medium text-stardust-gold uppercase tracking-wider",children:"Campaign Created!"}),e.jsx(be,{className:"w-6 h-6 text-stardust-gold"})]}),e.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-primary via-purple-500 to-accent bg-clip-text text-transparent",children:s})]}),e.jsx(Re,{children:l!=="title"&&e.jsxs(P.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"w-full space-y-2",children:[e.jsx(P.p,{initial:{opacity:0},animate:{opacity:1},className:"text-center text-sm text-muted-foreground mb-3",children:"Cosmiq Rituals added to Today's Agenda"}),a.map((d,u)=>e.jsxs(P.div,{initial:{opacity:0,x:-30,scale:.9},animate:l==="flyout"?{opacity:0,x:-100,y:200,scale:.5,transition:{delay:u*.1,duration:.4}}:{opacity:1,x:0,scale:1,transition:{delay:u*.15,type:"spring",damping:15}},className:"flex items-center gap-3 p-3 rounded-xl bg-card/80 border border-accent/30 backdrop-blur-sm",children:[e.jsx("div",{className:"flex-shrink-0 w-8 h-8 rounded-full bg-accent/20 flex items-center justify-center",children:e.jsx(nr,{className:"w-4 h-4 text-accent"})}),e.jsx("span",{className:"flex-1 text-sm font-medium truncate",children:d.title}),e.jsx(P.div,{initial:{scale:0},animate:{scale:1},transition:{delay:u*.15+.3,type:"spring"},children:e.jsx(rr,{className:"w-5 h-5 text-primary"})})]},u))]})}),l==="habits"&&e.jsxs(P.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:a.length*.15+.3},className:"flex items-center gap-2 px-4 py-2 rounded-full bg-accent/20 border border-accent/40",children:[e.jsx(be,{className:"w-4 h-4 text-accent"}),e.jsxs("span",{className:"text-sm font-semibold text-accent",children:[a.length," Cosmiq Ritual",a.length!==1?"s":""," Ready"]})]}),e.jsx(P.p,{initial:{opacity:0},animate:{opacity:.5},transition:{delay:2},className:"text-xs text-muted-foreground",children:"Tap anywhere to continue"})]})]})}):null}class KS extends n.Component{constructor(s){super(s),this.state={hasError:!1,error:null,errorCount:0}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,a){const{section:r}=this.props;ue.error(`SectionErrorBoundary [${r}] caught error`,{section:r,error:s.message,stack:s.stack,componentStack:a.componentStack}),this.setState(i=>({errorCount:i.errorCount+1}))}handleRetry=()=>{const{onRetry:s,section:a}=this.props;ue.info(`Retrying section: ${a}`),this.setState({hasError:!1,error:null}),s&&s()};render(){const{hasError:s,error:a,errorCount:r}=this.state,{children:i,section:o,title:l="Something went wrong",description:c="This section couldn't load properly",icon:d=ca,fallback:u,showRetry:p=!0,compact:h=!1,className:f=""}=this.props;if(!s)return i;if(u)return u;const m=3,g=p&&r<m;return h?e.jsxs("div",{className:`flex items-center gap-3 p-3 rounded-lg bg-destructive/10 border border-destructive/20 ${f}`,children:[e.jsx(d,{className:"h-5 w-5 text-destructive flex-shrink-0"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("p",{className:"text-sm font-medium text-destructive truncate",children:l})}),g&&e.jsx(z,{variant:"ghost",size:"sm",onClick:this.handleRetry,className:"flex-shrink-0",children:e.jsx(wa,{className:"h-4 w-4"})})]}):e.jsxs(Xe,{className:`p-6 text-center ${f}`,children:[e.jsx(d,{className:"h-12 w-12 text-destructive mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:l}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:c}),!1,g?e.jsxs(z,{variant:"outline",size:"sm",onClick:this.handleRetry,className:"gap-2",children:[e.jsx(wa,{className:"h-4 w-4"}),"Try Again"]}):r>=m?e.jsx("p",{className:"text-xs text-muted-foreground",children:"Please refresh the page or try again later"}):null]})}}const QS=({children:t})=>e.jsx(KS,{section:"quests",title:"Quests unavailable",description:"Unable to load your quests right now",children:t});function WS(t){const{user:s}=_e(),a=Ie(),r=Ee({queryKey:Xt.contactInteractions.byContact(t??""),queryFn:async()=>{if(!t)return[];const{data:l,error:c}=await k.from("contact_interactions").select("*").eq("contact_id",t).order("occurred_at",{ascending:!1});if(c)throw c;return l},enabled:!!s&&!!t}),i=he({mutationFn:async l=>{if(!s)throw new Error("Not authenticated");const{data:c,error:d}=await k.from("contact_interactions").insert({...l,user_id:s.id,occurred_at:l.occurred_at??new Date().toISOString()}).select().single();if(d)throw d;return c},onSuccess:(l,c)=>{a.invalidateQueries({queryKey:Xt.contactInteractions.byContact(c.contact_id)}),a.invalidateQueries({queryKey:Xt.contacts.all}),V.success("Interaction logged")},onError:l=>{V.error("Failed to log interaction"),console.error("Create interaction error:",l)}}),o=he({mutationFn:async({id:l,contactId:c})=>{const{error:d}=await k.from("contact_interactions").delete().eq("id",l);if(d)throw d;return c},onSuccess:l=>{a.invalidateQueries({queryKey:Xt.contactInteractions.byContact(l)}),V.success("Interaction deleted")},onError:l=>{V.error("Failed to delete interaction"),console.error("Delete interaction error:",l)}});return{interactions:r.data??[],isLoading:r.isLoading,createInteraction:i,deleteInteraction:o}}function GS(){const[t,s]=n.useState(null),{createInteraction:a}=WS(t?.contact?.id),r=n.useCallback((c,d,u,p)=>{u&&p&&s({taskId:c,taskText:d,contact:u,autoLogInteraction:p})},[]),i=n.useCallback(async(c,d)=>{t&&(await a.mutateAsync({contact_id:t.contact.id,interaction_type:c,summary:d}),s(null))},[t,a]),o=n.useCallback(()=>{s(null)},[]),l=n.useCallback(()=>{s(null)},[]);return{pendingInteraction:t,isModalOpen:!!t,handleTaskCompleted:r,logInteraction:i,skipInteraction:o,closeModal:l,isLogging:a.isPending}}const YS=[{value:"call",label:"Call",icon:yx},{value:"email",label:"Email",icon:Zu},{value:"meeting",label:"Meeting",icon:zt},{value:"message",label:"Message",icon:am},{value:"note",label:"Note",icon:Lr}];function VS({open:t,onOpenChange:s,contactName:a,contactAvatarUrl:r,taskTitle:i,onLog:o,onSkip:l}){const[c,d]=n.useState(""),[u,p]=n.useState(i),[h,f]=n.useState(!1),m=n.useMemo(()=>{const w=i.toLowerCase();return w.includes("call")||w.includes("phone")?"call":w.includes("email")||w.includes("send")||w.includes("write")?"email":w.includes("meet")||w.includes("lunch")||w.includes("coffee")?"meeting":w.includes("text")||w.includes("message")?"message":"note"},[i]);xx.useEffect(()=>{c||d(m)},[m,c]);const g=async()=>{if(!(!c||!u.trim())){f(!0);try{await o(c,u.trim()),s(!1)}finally{f(!1)}}},y=()=>{l(),s(!1)},b=a.split(" ").map(w=>w[0]).join("").toUpperCase().slice(0,2);return e.jsx(as,{open:t,onOpenChange:s,children:e.jsxs(Qt,{className:"sm:max-w-md",children:[e.jsxs(Is,{children:[e.jsx(ps,{children:"Log Interaction"}),e.jsxs(Vs,{children:["Record this as an interaction with ",a,"?"]})]}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-muted/50",children:[e.jsxs(_a,{className:"h-10 w-10",children:[e.jsx(ja,{src:r||void 0}),e.jsx(Na,{className:"bg-primary/10 text-primary text-sm",children:b})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:a}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Type"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:YS.map(w=>{const x=w.icon,v=c===w.value;return e.jsxs("button",{type:"button",onClick:()=>d(w.value),className:I("flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm transition-all",v?"bg-primary text-primary-foreground":"bg-muted hover:bg-muted/80 text-foreground"),children:[e.jsx(x,{className:"h-3.5 w-3.5"}),w.label]},w.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Summary"}),e.jsx(Zt,{value:u,onChange:w=>p(w.target.value),placeholder:"What happened?",rows:2})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(z,{variant:"outline",onClick:y,className:"flex-1",disabled:h,children:"Just Complete"}),e.jsx(z,{onClick:g,className:"flex-1",disabled:!c||!u.trim()||h,children:h?e.jsxs(e.Fragment,{children:[e.jsx(Nt,{className:"h-4 w-4 mr-2 animate-spin"}),"Logging..."]}):"Log & Complete"})]})]})})}const XS="/journeys",JS=(t,s=new Date)=>$r(t,s)?t:s,ZS=t=>t?.walkthrough_completed===!0,eE=(t,s,a)=>t?!1:s===!0||ZS(a),tE=/^([01]\d|2[0-3]):([0-5]\d)$/,sE=/^\d{4}-\d{2}-\d{2}$/,aE=()=>{const t=Yr(),s=Xr(),a=ts(),{isTabActive:r}=sn(),[i,o]=n.useState(new Date),[l,c]=n.useState(!1),[d,u]=n.useState(!1),[p,h]=n.useState(null),[f,m]=n.useState(!1),[g,y]=n.useState(!1),[b,w]=n.useState(!1),[x,v]=n.useState(null),[j,T]=n.useState(null),S=n.useRef(r),{user:N}=_e(),D=Ie(),{profile:R,loading:_}=ss(),{needsStreakDecision:C,currentStreak:E,freezesAvailable:O,useFreeze:M,resetStreak:A,isResolving:L}=dS(),q=n.useCallback(()=>{o(re=>JS(re))},[]);n.useEffect(()=>{r&&!S.current&&q(),S.current=r},[r,q]),n.useEffect(()=>{if(!r||Ze.isNativePlatform())return;const re=()=>{document.visibilityState==="visible"&&q()};return document.addEventListener("visibilitychange",re),()=>{document.removeEventListener("visibilitychange",re)}},[r,q]),n.useEffect(()=>{if(!r||!Ze.isNativePlatform())return;let re=!1,Ne=null;return(async()=>{const rt=await tr.addListener("appStateChange",({isActive:ut})=>{ut&&q()});if(re){await rt.remove();return}Ne=rt})(),()=>{re=!0,Ne&&Ne.remove()}},[r,q]);const{trackDailyPlanOutcome:$}=vl(),{epics:B,createEpic:W,isCreating:H}=vS({enabled:r}),K=n.useMemo(()=>B?.filter(re=>re.status==="active").slice(0,5)||[],[B]),{currentStreak:X}=al(),{sendTaskToCalendar:Y,syncTaskUpdate:ee,syncTaskDelete:ie,syncProviderPull:fe,hasLinkedEvent:U}=Rh({enabled:r}),{connections:ce}=wi({enabled:r}),{pendingInteraction:se,isModalOpen:ne,handleTaskCompleted:xe,logInteraction:G,skipInteraction:ye,closeModal:we}=GS(),{tasks:Te,isLoading:qe,addTask:Se,toggleTask:Pe,updateTask:$e,deleteTask:Be,restoreTask:Me,moveTaskToDate:Qe,completedCount:De,totalCount:ve,isAdding:Z,isUpdating:Q,isDeleting:J}=rS(i,{enabled:r}),[de,oe]=n.useState(null),[Fe,Je]=n.useState(null),{tasks:pt}=nS(i,"month",{enabled:r}),{surfaceAllEpicHabits:nt,unsurfacedEpicHabitsCount:Ct}=iS(),{pendingRecurringCount:lt,spawnRecurringTasks:me}=oS(i),Ae=n.useRef(!1),Ue=n.useRef(!1),xt=n.useRef(ae(i,"yyyy-MM-dd"));n.useEffect(()=>{if(!r)return;const re=ae(i,"yyyy-MM-dd");xt.current!==re&&(xt.current=re,Ae.current=!1,Ue.current=!1),Ct>0&&!Ae.current&&(Ae.current=!0,nt()),lt>0&&!Ue.current&&(Ue.current=!0,me())},[r,Ct,lt,i,nt,me]);const Pt=R?.onboarding_data??null,ge=eE(_,R?.onboarding_completed,Pt);fS(N?.id,ge,_);const Le=n.useCallback(async re=>{if(re.habit_source_id){const{data:Ne}=await k.from("habits").select("frequency, custom_days, description").eq("id",re.habit_source_id).maybeSingle();Je({habitId:re.habit_source_id,taskId:re.id,title:re.task_text,description:Ne?.description||null,difficulty:re.difficulty||"medium",frequency:Ne?.frequency||"daily",custom_days:Ne?.custom_days||[],estimated_minutes:re.estimated_duration,preferred_time:re.scheduled_time,category:re.category,recurrence_pattern:re.recurrence_pattern,recurrence_days:re.recurrence_days,reminder_enabled:re.reminder_enabled,reminder_minutes_before:re.reminder_minutes_before})}else oe(re)},[]),{pendingTaskId:He,clearPendingTask:wt}=Iy(),ht=n.useRef(null);n.useEffect(()=>{if(!r||!He||ht.current===He||qe)return;const re=Te.find(Ne=>Ne.id===He);re?(ue.log("[Journeys] Opening deep-linked task:",He),ht.current=He,Le(re),wt()):(ue.log("[Journeys] Deep link task not found in daily tasks:",He),ht.current=He,wt())},[r,He,Te,qe,wt,Le]);const qt=n.useMemo(()=>{const re={};return pt.forEach(Ne=>{Ne.task_date&&(re[Ne.task_date]=(re[Ne.task_date]||0)+1)}),re},[pt]),St=n.useCallback(async re=>{const Ne=()=>{V.error("No calendar connected. Opening Preferences..."),a("/profile",{state:{openTab:"preferences"}})};if(ce.length===0){Ne();return}let Et,rt;const ut=async()=>{await Y.mutateAsync({taskId:re,options:Et||rt?{taskDate:Et,scheduledTime:rt}:void 0})};try{await ut(),V.success("Quest synced to calendar");return}catch(is){let Tt=is instanceof Error?is.message:"Failed to send quest to calendar";if(Tt.includes("NO_CALENDAR_CONNECTION")){Ne();return}for(let ln=0;ln<2;ln+=1){if(Tt.includes("NO_CALENDAR_CONNECTION")){Ne();return}if(Tt.includes("TASK_DATE_REQUIRED")&&!Et){const os=window.prompt("Choose a date to send this quest (YYYY-MM-DD)",ae(i,"yyyy-MM-dd"));if(!os||!sE.test(os)){V.error("Calendar send cancelled. Please choose a valid YYYY-MM-DD date.");return}Et=os}if((Tt.includes("SCHEDULED_TIME_REQUIRED")||Tt.includes("SCHEDULED_TIME_INVALID"))&&!rt){const os=window.prompt("Choose a time to send this quest (HH:mm)","09:00");if(!os||!tE.test(os)){V.error("Calendar send cancelled. Please choose a valid HH:mm time.");return}rt=os}try{await ut(),V.success("Quest synced to calendar");return}catch(os){if(Tt=os instanceof Error?os.message:"Failed to send quest to calendar",Tt.includes("NO_CALENDAR_CONNECTION")){Ne();return}if(!Tt.includes("TASK_DATE_REQUIRED")&&!Tt.includes("SCHEDULED_TIME_REQUIRED")&&!Tt.includes("SCHEDULED_TIME_INVALID")){V.error(Tt);return}}}if(Tt.includes("TASK_DATE_REQUIRED")){V.error("Please assign a date before sending this quest to calendar.");return}if(Tt.includes("SCHEDULED_TIME_REQUIRED")||Tt.includes("SCHEDULED_TIME_INVALID")){V.error("Please assign a time before sending this quest to calendar.");return}V.error(Tt)}},[ce.length,a,i,Y]),Xs=n.useCallback(async re=>{const Ne=re.sendToInbox?null:re.taskDate??ae(i,"yyyy-MM-dd");await Se({taskText:re.text,difficulty:re.difficulty,taskDate:Ne,isMainQuest:!1,scheduledTime:re.scheduledTime,estimatedDuration:re.estimatedDuration,recurrencePattern:re.recurrencePattern,recurrenceDays:re.recurrenceDays,reminderEnabled:re.reminderEnabled,reminderMinutesBefore:re.reminderMinutesBefore,notes:re.moreInformation,location:re.location,contactId:re.contactId,autoLogInteraction:re.autoLogInteraction,subtasks:re.subtasks,imageUrl:re.imageUrl,attachments:re.attachments}),u(!1)},[i,Se,St]),Ns=n.useCallback((re,Ne,Et,rt)=>{Ne&&rt?.ai_generated&&$(re,"completed",{scheduledTime:rt.scheduled_time??void 0,difficulty:rt.difficulty??void 0,category:rt.category??void 0,wasOnTime:!0}),Pe({taskId:re,completed:Ne,xpReward:Et},{onSuccess:ut=>{ut.completed&&ut.contact&&ut.autoLogInteraction&&xe(ut.taskId,ut.taskText,ut.contact,ut.autoLogInteraction)}})},[Pe,$,xe]),ns=n.useCallback((re,Ne)=>{Pe({taskId:re,completed:!1,xpReward:Ne,forceUndo:!0})},[Pe]),Lt=n.useCallback(async(re,Ne)=>{await $e({taskId:re,updates:Ne}),await ee.mutateAsync({taskId:re}).catch(()=>{V.error("Saved quest, but failed to sync linked calendar event")}),oe(null)},[$e,ee]),Os=n.useCallback(async(re,Ne)=>{Ne&&$(re,"deleted"),await ie.mutateAsync({taskId:re}).catch(()=>{V.error("Failed to remove linked calendar event")}),await Be(re),V.success("Quest deleted"),oe(null)},[Be,$,ie]),Js=n.useCallback(async re=>{if(N?.id){try{const{error:Ne}=await k.from("habits").delete().eq("id",re).eq("user_id",N.id);if(Ne)throw Ne;const{error:Et}=await k.from("daily_tasks").delete().eq("habit_source_id",re).eq("user_id",N.id).eq("completed",!1);Et&&console.error("Error deleting linked tasks:",Et),D.invalidateQueries({queryKey:["habits"]}),D.invalidateQueries({queryKey:["daily-tasks"]}),D.invalidateQueries({queryKey:["epics"]}),V.success("Ritual deleted")}catch(Ne){console.error("Error deleting ritual:",Ne),V.error("Failed to delete ritual")}Je(null)}},[N?.id,D]),je=n.useCallback(re=>{o(re)},[]),dt=n.useCallback(async re=>{const Ne=Te.find(rt=>rt.id===re);if(!Ne)return;const Et={task_text:Ne.task_text,task_date:Ne.task_date,xp_reward:Ne.xp_reward,difficulty:Ne.difficulty,scheduled_time:Ne.scheduled_time,estimated_duration:Ne.estimated_duration,is_main_quest:Ne.is_main_quest,epic_id:Ne.epic_id,sort_order:Ne.sort_order,priority:Ne.priority,category:Ne.category,habit_source_id:Ne.habit_source_id,is_recurring:Ne.is_recurring,recurrence_pattern:Ne.recurrence_pattern,recurrence_days:Ne.recurrence_days,reminder_enabled:Ne.reminder_enabled,reminder_minutes_before:Ne.reminder_minutes_before};try{await ws.impact({style:Ut.Medium})}catch{}await ie.mutateAsync({taskId:re}).catch(()=>{V.error("Failed to remove linked calendar event")}),await Be(re),V("Quest deleted",{duration:4e3,action:{label:"Undo",onClick:async()=>{try{await Me(Et),V.success("Quest restored")}catch{V.error("Failed to restore quest")}}}})},[Te,Be,Me,ie]),vt=n.useCallback(async re=>{const Et=Te.find(is=>is.id===re)?.task_date;try{await ws.impact({style:Ut.Light})}catch{}const rt=Ts(i,1),ut=ae(rt,"yyyy-MM-dd");Qe({taskId:re,targetDate:ut}),V(`Moved to ${ae(rt,"EEEE, MMM d")}`,{duration:4e3,action:{label:"Undo",onClick:()=>{Et&&(Qe({taskId:re,targetDate:Et}),V.success("Move undone"))}}})},[Te,i,Qe]);n.useEffect(()=>{if(!r)return;const re=ce.filter(rt=>rt.sync_mode==="full_sync"&&(rt.provider==="google"||rt.provider==="outlook")).map(rt=>rt.provider);if(re.length===0)return;const Ne=()=>{for(const rt of re)fe.mutate({provider:rt})};Ne();const Et=window.setInterval(()=>{Ne()},120*1e3);return()=>{window.clearInterval(Et)}},[r,ce,fe]);const at=n.useCallback(async re=>{try{await W(re),y(!1),v({title:re.title,habits:re.habits.map(Ne=>({title:Ne.title}))}),w(!0)}catch(Ne){console.error("Failed to create campaign:",Ne)}},[W]),Wt=n.useCallback(()=>{w(!1),v(null)},[]);return e.jsxs(tn,{mode:"instant",children:[e.jsx(an,{}),e.jsxs("div",{className:"min-h-screen pb-nav-safe pt-safe px-4 relative z-10",children:[e.jsxs(P.div,{initial:t?!1:{opacity:0,y:-14},animate:{opacity:1,y:0},transition:{duration:t?0:.22},className:"mb-6 text-center relative",children:[e.jsx("div",{className:"absolute right-0 top-0",children:e.jsx($2,{onClick:()=>c(!0)})}),e.jsx("h1",{className:"text-3xl font-semibold tracking-tight mb-2 bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent",children:"Quests"}),e.jsx("p",{className:"text-sm text-muted-foreground/90",children:j?`Dragging to ${Qs(j)}`:"Daily quests. Your path to progress."})]}),e.jsxs(QS,{children:[e.jsx(P.div,{initial:t?!1:{opacity:0,scale:.98},animate:{opacity:1,scale:1},transition:{delay:t?0:.04,duration:t?0:.2},className:"mb-4",children:e.jsx(F2,{selectedDate:i,onDateSelect:je,tasksPerDay:qt,isActive:r})}),e.jsx(P.div,{initial:t?!1:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{delay:t?0:.1,duration:t?0:.2},children:e.jsx(P2,{tasks:Te,selectedDate:i,isVisible:s.pathname===XS,onToggle:Ns,onAddQuest:()=>{h(null),u(!0)},completedCount:De,totalCount:ve,currentStreak:X,onUndoToggle:ns,onEditQuest:Le,calendarTasks:pt,calendarMilestones:[],onDateSelect:o,activeEpics:K,onDeleteQuest:dt,onSendToCalendar:void 0,hasCalendarLink:U,onMoveQuestToNextDay:vt,onUpdateScheduledTime:(re,Ne)=>{$e({taskId:re,updates:{scheduled_time:Ne}}),ee.mutate({taskId:re})},onTimeSlotLongPress:(re,Ne)=>{o(re),h(Ne),u(!0)},onTimelineDragPreviewTimeChange:T})})]}),e.jsx(Mh,{open:d,onOpenChange:u,selectedDate:i,onAdd:Xs,isAdding:Z,prefilledTime:p,onCreateCampaign:()=>y(!0)}),e.jsx(Dh,{task:de,open:!!de&&!de.habit_source_id,onOpenChange:re=>!re&&oe(null),onSave:Lt,isSaving:Q,onSendToCalendar:void 0,hasCalendarLink:de?U(de.id):!1,isSendingToCalendar:Y.isPending,onDelete:Os,isDeleting:J}),e.jsx(aS,{ritual:Fe,open:!!Fe,onOpenChange:re=>!re&&Je(null),onDelete:Js}),e.jsx(B2,{open:l,onClose:()=>c(!1),title:"About Quests",icon:rm,description:"Quests and Campaigns work together in one powerful view.",features:["Quests are your daily actions to earn XP and build momentum","Campaigns are goals you break down with your mentor into routines","Track progress across quests and campaigns to stay consistent"],tip:"Add a quest with +, or start a Campaign to plan your bigger goal."}),e.jsx(U2,{open:C,currentStreak:E,freezesAvailable:O,onUseFreeze:M,onResetStreak:A,isResolving:L}),e.jsx(VS,{open:ne,onOpenChange:we,contactName:se?.contact?.name??"",contactAvatarUrl:se?.contact?.avatar_url,taskTitle:se?.taskText??"",onLog:async(re,Ne)=>{await G(re,Ne)},onSkip:ye}),Te.some(re=>re.ai_generated)&&e.jsx(P.button,{initial:t?!1:{scale:.9,opacity:0},animate:{scale:1},transition:{duration:t?0:.2},className:"fixed bottom-24 right-4 z-40 p-3 rounded-full bg-card/92 backdrop-blur-xl border border-border/60 shadow-[0_10px_24px_rgba(0,0,0,0.28)] active:scale-95 transition-transform",onClick:()=>m(!0),"aria-label":"Open quick adjust",children:e.jsx(ia,{className:"h-5 w-5 text-primary"})}),e.jsx(_S,{open:f,onOpenChange:m,tasks:Te,selectedDate:i,onComplete:()=>{D.invalidateQueries({queryKey:["daily-tasks"]}),m(!1)}}),e.jsx(BS,{open:g,onOpenChange:y,onCreateEpic:at,isCreating:H,showTemplatesFirst:!1}),e.jsx(zS,{isVisible:b,campaignTitle:x?.title||"",habits:x?.habits||[],onComplete:Wt}),e.jsx(xh,{onTap:()=>{h(null),u(!0)}})]})]})},hf=["/mentor","/inbox","/journeys","/companion"],rE={"/mentor":Fv,"/inbox":t5,"/journeys":aE,"/companion":Pk},ff=t=>hf.includes(t),nE={"/mentor":0,"/inbox":0,"/journeys":0,"/companion":0},jd=1,gf=n.memo(({activePath:t})=>{const s=Ie(),{user:a}=_e(),[r,i]=n.useState([t]),o=n.useRef(t),l=n.useRef(new Set([t])),c=n.useRef(nE),d=n.useRef(!1),u=n.useRef([]),p=n.useCallback(()=>{if(!a?.id)return;const h=ae(new Date,"yyyy-MM-dd");s.prefetchQuery({queryKey:ol(a.id,h),queryFn:()=>ll(a.id,h),staleTime:nl,gcTime:il}).catch(()=>{})},[s,a?.id]);return n.useEffect(()=>{p()},[p]),n.useEffect(()=>{i(h=>h.includes(t)?h:[...h,t])},[t]),n.useLayoutEffect(()=>{const h=o.current;h!==t&&(c.current[h]=window.scrollY);const m=l.current.has(t)?c.current[t]??0:0;if(l.current.add(t),o.current=t,!d.current){d.current=!0;return}if(Math.abs(window.scrollY-m)<=jd)return;const g=window.requestAnimationFrame(()=>{const y=window.requestAnimationFrame(()=>{Math.abs(window.scrollY-m)<=jd||window.scrollTo({top:m,left:0,behavior:"auto"})});u.current.push(y)});return u.current.push(g),()=>{for(const y of u.current)window.cancelAnimationFrame(y);u.current=[]}},[t]),e.jsx("div",{className:"relative",children:hf.map(h=>{if(!r.includes(h))return null;const f=rE[h],m=h===t;return e.jsx("div",{style:{display:m?"block":"none"},"aria-hidden":!m,children:e.jsx(Dv,{isTabActive:m,children:e.jsx("section",{children:e.jsx(f,{})})})},h)})})});gf.displayName="MainTabsKeepAlive";const Cr=n.forwardRef(({className:t,activeClassName:s,pendingClassName:a,to:r,...i},o)=>e.jsx(bx,{ref:o,to:r,className:({isActive:l,isPending:c})=>I(t,l&&s,c&&a),...i}));Cr.displayName="NavLink";const xf=n.memo(({isActive:t=!1})=>{const{presence:s,isLoading:a}=ii(),{navGlow:r,primaryAura:i}=sh(),[o,l]=n.useState(!1);if(n.useEffect(()=>{const u=window.matchMedia("(prefers-reduced-motion: reduce)");l(u.matches);const p=()=>l(u.matches);return u.addEventListener("change",p),()=>u.removeEventListener("change",p)},[]),a||!s.isPresent)return null;const c=!o&&(s.mood==="joyful"||s.mood==="content"),d=s.needsAttention&&!t;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute inset-0 rounded-full -z-10",style:{boxShadow:r,animation:c?`companion-nav-breathe ${3/s.pulseRate}s ease-in-out infinite`:"none",willChange:c?"box-shadow":"auto"}}),d&&e.jsx("div",{className:"absolute -top-0.5 -right-0.5 w-2 h-2 rounded-full",style:{backgroundColor:i,boxShadow:`0 0 6px ${i}`,animation:o?"none":"companion-attention-pulse 2s ease-in-out infinite"}}),e.jsx("style",{children:`
        @keyframes companion-nav-breathe {
          0%, 100% {
            opacity: 0.6;
            transform: scale(1);
          }
          50% {
            opacity: 1;
            transform: scale(1.05);
          }
        }

        @keyframes companion-attention-pulse {
          0%, 100% {
            opacity: 0.7;
            transform: scale(1);
          }
          50% {
            opacity: 1;
            transform: scale(1.3);
          }
        }
      `})]})});xf.displayName="CompanionNavPresence";const yf=n.memo(()=>{const t=Ie(),{user:s}=_e(),{profile:a}=ss(),{companion:r,canEvolve:i}=At(),{inboxCount:o}=xC(),l=n.useCallback(()=>{if(!s?.id)return;const h=ae(new Date,"yyyy-MM-dd");t.prefetchQuery({queryKey:ol(s.id,h),queryFn:()=>ll(s.id,h),staleTime:nl,gcTime:il}).catch(()=>{})},[t,s?.id]),c=n.useCallback(h=>{h==="journeys"&&l()},[l]),d=ur(a),{data:u,isLoading:p}=Ee({queryKey:["selected-mentor",d],enabled:!!d,staleTime:600*1e3,queryFn:async()=>{if(!d)throw new Error("No mentor selected");const{data:h,error:f}=await k.from("mentors").select("slug, name, primary_color").eq("id",d).maybeSingle();if(f)throw f;return h}});return e.jsx(e.Fragment,{children:e.jsx("nav",{className:"fixed bottom-0 left-0 right-0 cosmiq-glass-nav z-50 border-t border-border/40 transition-transform duration-200",role:"navigation","aria-label":"Main navigation",style:{paddingBottom:"env(safe-area-inset-bottom, 0px)"},children:e.jsxs("div",{className:"max-w-lg mx-auto flex items-center justify-around px-2 sm:px-4 py-2.5",children:[e.jsx(Cr,{to:"/mentor",className:"flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition-all duration-200 active:scale-95 touch-manipulation min-w-[58px] min-h-[56px]",activeClassName:"bg-orange-500/12","data-tour":"mentor-tab",onClick:()=>gt.light(),onMouseEnter:()=>c("mentor"),onFocus:()=>c("mentor"),children:({isActive:h})=>e.jsxs(e.Fragment,{children:[p?e.jsx("div",{className:"h-7 w-7 rounded-full bg-muted animate-pulse","aria-hidden":!0}):u?e.jsx(Ar,{mentorSlug:u.slug||"",mentorName:u.name,primaryColor:u.primary_color||"#000",size:"sm",className:"w-7 h-7",showBorder:!1}):e.jsx(qu,{className:`h-6 w-6 transition-colors duration-200 ${h?"text-orange-300":"text-muted-foreground"}`}),e.jsx("span",{className:`text-[11px] font-medium transition-colors duration-200 ${h?"text-orange-200":"text-muted-foreground/85"}`,children:"Mentor"})]})}),e.jsx(Cr,{to:"/inbox",className:"flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition-all duration-200 active:scale-95 touch-manipulation min-w-[58px] min-h-[56px] relative",activeClassName:"bg-celestial-blue/12",onClick:()=>gt.light(),onMouseEnter:()=>c("inbox"),onFocus:()=>c("inbox"),children:({isActive:h})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(Yo,{className:`h-6 w-6 transition-colors duration-200 ${h?"text-celestial-blue":"text-muted-foreground"}`}),o>0&&e.jsx(Oe,{className:"absolute -top-1 -right-2 h-4 min-w-[16px] px-1 p-0 flex items-center justify-center text-[9px] bg-celestial-blue text-white border-0",children:o>9?"9+":o})]}),e.jsx("span",{className:`text-[11px] font-medium transition-colors duration-200 ${h?"text-celestial-blue":"text-muted-foreground/85"}`,children:"Inbox"})]})}),e.jsx(Cr,{to:"/journeys",className:"flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition-all duration-200 active:scale-95 touch-manipulation min-w-[58px] min-h-[56px]",activeClassName:"bg-cosmiq-glow/12","data-tour":"quests-tab",onClick:()=>gt.light(),onPointerDown:l,onMouseEnter:()=>c("journeys"),onFocus:()=>c("journeys"),children:({isActive:h})=>e.jsxs(e.Fragment,{children:[e.jsx(rm,{className:`h-6 w-6 transition-colors duration-200 ${h?"text-cosmiq-glow":"text-muted-foreground"}`}),e.jsx("span",{className:`text-[11px] font-medium transition-colors duration-200 ${h?"text-cosmiq-glow":"text-muted-foreground/85"}`,children:"Quests"})]})}),e.jsx(Cr,{to:"/companion",className:"flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition-all duration-200 active:scale-95 touch-manipulation min-w-[58px] min-h-[56px] relative",activeClassName:"bg-stardust-gold/12","data-tour":"companion-tab",onClick:()=>gt.light(),onMouseEnter:()=>c("companion"),onFocus:()=>c("companion"),children:({isActive:h})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(xf,{isActive:h}),e.jsx(_u,{fill:"currentColor",className:`h-6 w-6 -rotate-45 transition-colors duration-200 ${h?"text-stardust-gold":"text-muted-foreground"}`}),r&&i&&e.jsx(Oe,{className:"absolute -top-1 -right-1 h-4 w-4 p-0 flex items-center justify-center text-[9px] bg-stardust-gold text-black animate-pulse",children:"!"})]}),e.jsx("span",{className:`text-[11px] font-medium transition-colors duration-200 ${h?"text-stardust-gold":"text-muted-foreground/85"}`,children:"Companion"})]})})]})})})});yf.displayName="BottomNav";const iE=new Set(["/welcome","/terms","/privacy","/promo-code","/test-scroll","/test-day-planner"]),oE=["/auth","/onboarding"],lE=t=>oE.some(s=>t===s||t.startsWith(`${s}/`)),cE=(t,s)=>!(!s||iE.has(t)||lE(t)),fo=2,Ln=3,Nd=250,dE=1400,uE=2600,go='[data-tour="evolve-companion-button"]',kd=72,mE={create_quest:4,morning_checkin:3},bs=[{id:"quests_campaigns_intro",route:"/journeys"},{id:"create_quest",route:"/journeys"},{id:"morning_checkin",route:"/mentor"},{id:"companion_tab_intro",route:"/companion"},{id:"evolve_companion",route:"/companion"},{id:"post_evolution_companion_intro",route:"/companion"},{id:"mentor_closeout",route:"/companion"}],na=["open_add_quest","enter_title","select_time","submit_create_quest"],Cd=new Set(bs.map(t=>t.id)),pE=new Set([...bs.map(t=>t.id),"meet_companion"]),hE=new Set([...na,"stay_on_quests","quests_campaigns_intro"]),bf=t=>typeof t=="string"&&pE.has(t),Sd=t=>typeof t=="string"&&hE.has(t),_l=t=>!!t&&typeof t=="object"&&!Array.isArray(t),fE=new Set(["mentor_intro_hello","stay_on_quests","quests_campaigns_intro","open_add_quest","enter_title","select_time","submit_create_quest","open_companion_tab","confirm_companion_progress","open_mentor_tab","submit_morning_checkin","companion_tab_intro","tap_evolve_companion","complete_companion_evolution","post_evolution_companion_intro","mentor_closeout_message"]),gE=t=>typeof t=="string"&&fE.has(t),Ed=t=>Array.isArray(t)?t.filter(gE):[],Qa=(t,s)=>{typeof window>"u"||window.dispatchEvent(new CustomEvent(t,{detail:s}))},xE=t=>{switch(t){case"mentor_intro_hello":return[];case"quests_campaigns_intro":case"companion_tab_intro":case"post_evolution_companion_intro":return[];case"stay_on_quests":return['[data-tour="quests-tab"]'];case"open_add_quest":return['[data-tour="add-quest-fab"]'];case"enter_title":return['[data-tour="add-quest-title-input"]'];case"select_time":return['[data-tour="add-quest-time-chip"]','[data-tour="add-quest-time-input"]'];case"submit_create_quest":return['[data-tour="add-quest-create-button"]'];case"open_companion_tab":return['[data-tour="companion-tab"]'];case"confirm_companion_progress":return['[data-tour="companion-progress-area"]','[data-tour="companion-page"]'];case"open_mentor_tab":return['[data-tour="mentor-tab"]'];case"submit_morning_checkin":return['[data-tour="checkin-submit"]','[data-tour="morning-checkin"]'];case"tap_evolve_companion":return['[data-tour="evolve-companion-button"]'];case"complete_companion_evolution":case"mentor_closeout_message":return[];default:return[]}},Td={atlas:{text:"Greetings, I'm Atlas. Let's begin your path to productivity.",support:"Stay with me through this short walkthrough."},eli:{text:"Hey, I'm glad you're here. I'm Eli. We'll take this one step at a time.",support:"Quick walkthrough first. Then you'll have a rhythm you can rely on."},sienna:{text:"Hi. I'm really glad you're here. I'm Sienna. Let's get started.",support:"I'll guide your first steps so everything feels clear and manageable."},stryker:{text:"You showed up. Good. We move fast and execute clean.",support:"Complete the walkthrough. Then run your day like a mission."},carmen:{text:"Welcome. I'm Carmen. Today we establish your standard.",support:"Finish this walkthrough and your system goes live."},reign:{text:"Good. you're here. I'm Reign. Let's set your pace and move with intention.",support:"Lock in this walkthrough, then build momentum and own the day."},solace:{text:"Hi! I'm Solace. You're exactly where you need to be.",support:"I'll keep this walkthrough clear and concise so you feel grounded from the start."}},yE=(t,s)=>{const a=t?.toLowerCase();return a&&Td[a]?Td[a]:s&&s!=="Your mentor"?{text:`Hey, I'm ${s}. I'm glad you're here.`,support:"I'll guide your first few taps so you can settle in quickly."}:{text:"Hey, I'm your mentor. I'm glad you're here.",support:"I'll guide your first few taps so you can settle in quickly."}},bE=()=>({text:"This is your Quests tab. Think of Quests as your daily to-do list. Tasks you can schedule on your calendar, or save to your inbox to plan later.",support:"Campaigns are goals that build routines and rituals to help you succeed."}),wE=t=>{for(const s of t)if(document.querySelector(s))return s;return null},vE=(t,s)=>{const a=t.getBoundingClientRect();return a.top>=kd&&a.bottom<=s-kd},xo=(t,s)=>{if(t.size!==s.size)return!1;for(const a of t)if(!s.has(a))return!1;return!0},Kn=t=>{const s=new Set(t);return bs.map(a=>a.id).filter(a=>s.has(a))},Qn=t=>{const s=new Set(t);return na.filter(a=>s.has(a))},Wn=t=>{const s=new Set(t);return na.find(a=>!s.has(a))??"submit_create_quest"},Md=t=>{if(!_l(t))return null;const s=Array.isArray(t.completed)?t.completed.filter(Sd):[],a=Qn(s.filter(o=>o!=="stay_on_quests"&&o!=="quests_campaigns_intro")),r=Sd(t.current)?t.current:null;return{current:r&&na.includes(r)?r:Wn(a),completed:a,startedAt:typeof t.startedAt=="string"?t.startedAt:void 0,completedAt:typeof t.completedAt=="string"?t.completedAt:void 0}},_E=(t,s)=>{const a=t?.completed??[],r=s?.completed??[],i=Qn(new Set([...a,...r])),o=Wn(i),l=i.length>=na.length;return{current:o,completed:i,startedAt:t?.startedAt??s?.startedAt??new Date().toISOString(),completedAt:l?t?.completedAt??s?.completedAt??new Date().toISOString():void 0}},jE=({completedSteps:t,milestones:s,createQuestProgress:a})=>a.completed.length>0||t.has("create_quest")||t.has("meet_companion")||t.has("morning_checkin")||t.has("evolve_companion")||t.has("post_evolution_companion_intro")||t.has("mentor_closeout")||s.has("stay_on_quests")||s.has("open_add_quest")||s.has("enter_title")||s.has("select_time")||s.has("submit_create_quest"),NE=({completedSteps:t,awardedSteps:s,milestonesCompleted:a,createQuestProgress:r,completed:i,completedAt:o,flowVersion:l,evolutionInFlight:c,evolutionStartedAt:d,evolutionCompletedAt:u})=>{const p=new Set(t),h=new Set(s),f=new Set(a),m=jE({completedSteps:p,milestones:f,createQuestProgress:r}),g=new Set(t.filter(N=>Cd.has(N)));(p.has("evolve_companion")||p.has("post_evolution_companion_intro")||p.has("mentor_closeout"))&&g.add("companion_tab_intro"),m&&g.add("quests_campaigns_intro");const b=i||p.has("mentor_closeout");b&&bs.forEach(N=>g.add(N.id));const w=new Set(a);m&&w.add("quests_campaigns_intro"),b&&w.add("post_evolution_companion_intro");const x=new Set(s.filter(N=>Cd.has(N))),v=Kn(g),j=Kn(x),T=Array.from(w),S=l!==Ln||!xo(new Set(v),p)||!xo(new Set(j),h)||!xo(new Set(T),f);return{completedSteps:v,xpAwardedSteps:j,milestonesCompleted:T,createQuestProgress:r,completed:b||bs.every(N=>g.has(N.id)),completedAt:o,evolutionInFlight:c,evolutionStartedAt:d,evolutionCompletedAt:u,needsMigration:S}},Dd=t=>Array.isArray(t)?t.filter(bf):[],Ad=t=>Array.isArray(t)?t.filter(bf):[],wf=t=>`guided_tutorial_progress_${t}`,Pd=t=>{if(!t)return null;const s=st.getItem(wf(t));if(!s)return null;try{const a=JSON.parse(s);return _l(a)?a:null}catch{return null}},Rd=t=>{const s=t?.guided_tutorial;return _l(s)?s:null},Id=t=>t==="/welcome"||t==="/preview"||t.startsWith("/auth")||t.startsWith("/onboarding"),kE=new Set(["/","/mentor","/inbox","/journeys","/companion"]),CE=({pathname:t,stepRoute:s,tutorialReady:a,tutorialComplete:r,currentStepId:i,evolutionInFlight:o})=>!a||r||!s||i==="evolve_companion"&&o||!kE.has(t)?!1:t!==s,SE={isIntroDialogueActive:!1,isActive:!1,currentStep:null,currentSubstep:null,stepRoute:null,mentorInstructionLines:[],progressText:"",activeTargetSelectors:[],activeTargetSelector:null,isStrictLockActive:!1,canTemporarilyHide:!1,dialogueText:"",dialogueSupportText:void 0,speakerName:"Your mentor",speakerPrimaryColor:"#f59e0b",speakerSlug:void 0,speakerAvatarUrl:void 0,dialogueActionLabel:void 0,onDialogueAction:void 0},vf=n.createContext(SE),EE=(t,s)=>{switch(t){case"quests_campaigns_intro":return bE();case"stay_on_quests":return{text:"Start on Quests. We'll build your first quest together.",support:"You and I are setting the tone for your whole adventure."};case"open_add_quest":return{text:"Tap the + in the bottom right.",support:"This opens your Create a Quest Menu."};case"enter_title":return{text:"Enter your quest title.",support:"Name it clearly so future-you knows exactly what to do."};case"select_time":return{text:"Set a time.",support:"Scheduled quests get completed."};case"submit_create_quest":return{text:"Tap Create Quest.",support:"Your first mission is now live."};case"open_companion_tab":return{text:"Open Companion.",support:"Let's check in with your ally."};case"confirm_companion_progress":return{text:"This is your companion progress area.",support:"Every completed quest strengthens your bond."};case"open_mentor_tab":return{text:"Open Mentor."};case"submit_morning_checkin":return{text:"Welcome to your Mentor Tab. Receive a Pep Talk or talk to your Mentor to stay on track. Complete your check-in.",support:"Keep it honest. Keep it simple."};case"companion_tab_intro":return{text:"This is your Companion Tab. See your progress reflected in your Companion's growth.",support:"Stay locked in with the Pomodoro Timer and Resist mini games to break bad habits"};case"tap_evolve_companion":return{text:"Your companion has gathered enough strength. Tap Evolve to ascend.",support:"Effort becomes growth here."};case"complete_companion_evolution":return{text:"Evolution in progress.",support:"You can continue using the app. I'll bring you back when it's ready."};case"post_evolution_companion_intro":return{text:"AMAZING! You've taken your first step to greatness.",support:"Here you track your bond and growth."};case"mentor_closeout_message":return{text:"You're ready. This concludes the tutorial.",support:"Keep momentum through daily quests and check-ins."};default:return{text:"Let's keep going."}}},TE=t=>!(!t||t==="mentor_intro_hello"||t==="quests_campaigns_intro"||t==="confirm_companion_progress"||t==="submit_morning_checkin"||t==="companion_tab_intro"||t==="complete_companion_evolution"||t==="post_evolution_companion_intro"||t==="mentor_closeout_message"),ME=()=>{const{user:t}=_e(),{profile:s,loading:a}=ss(),{awardCustomXP:r}=rs(),i=pr(),o=Ie(),l=Xr(),c=ts(),d=n.useRef(!1),u=n.useRef(new Set),p=n.useRef(null),h=n.useRef(null),f=n.useRef(null),m=n.useRef(null),g=n.useRef(null),y=n.useRef(null),[b,w]=n.useState([]),[x,v]=n.useState([]),[j,T]=n.useState([]),[S,N]=n.useState([]),[D,R]=n.useState(null),[_,C]=n.useState(null),E=s?.onboarding_data??null,O=E?.walkthrough_completed===!0,M=n.useMemo(()=>Pd(t?.id),[t?.id]),A=n.useMemo(()=>Rd(E),[E]),L=A?.version===fo&&A?.eligible===!0;n.useEffect(()=>{w([]),v([]),T([]),N([]),R(null),C(null),d.current=!1,u.current.clear(),p.current=null,y.current=null},[t?.id]);const q=n.useMemo(()=>{const ge=Dd(A?.completedSteps),Le=Dd(M?.completedSteps);return Array.from(new Set([...ge,...Le]))},[M?.completedSteps,A?.completedSteps]),$=n.useMemo(()=>{const ge=Ad(A?.xpAwardedSteps),Le=Ad(M?.xpAwardedSteps);return Array.from(new Set([...ge,...Le]))},[M?.xpAwardedSteps,A?.xpAwardedSteps]),B=n.useMemo(()=>{const ge=Ed(A?.milestonesCompleted),Le=Ed(M?.milestonesCompleted);return Array.from(new Set([...ge,...Le]))},[M?.milestonesCompleted,A?.milestonesCompleted]),W=n.useMemo(()=>Md(A?.substeps?.create_quest),[A?.substeps]),H=n.useMemo(()=>Md(M?.substeps?.create_quest),[M?.substeps]),K=n.useMemo(()=>_E(W,H),[H,W]),X=n.useMemo(()=>NE({completedSteps:q,awardedSteps:$,milestonesCompleted:B,createQuestProgress:K,completed:!!(A?.completed??M?.completed??!1),completedAt:typeof A?.completedAt=="string"?A.completedAt:typeof M?.completedAt=="string"?M.completedAt:void 0,flowVersion:typeof A?.flowVersion=="number"?A.flowVersion:typeof M?.flowVersion=="number"?M.flowVersion:void 0,evolutionInFlight:!!(A?.evolutionInFlight??M?.evolutionInFlight??!1),evolutionStartedAt:typeof A?.evolutionStartedAt=="string"?A.evolutionStartedAt:typeof M?.evolutionStartedAt=="string"?M.evolutionStartedAt:void 0,evolutionCompletedAt:typeof A?.evolutionCompletedAt=="string"?A.evolutionCompletedAt:typeof M?.evolutionCompletedAt=="string"?M.evolutionCompletedAt:void 0}),[M?.completed,M?.completedAt,M?.evolutionCompletedAt,M?.evolutionInFlight,M?.evolutionStartedAt,M?.flowVersion,K,$,q,B,A?.completed,A?.completedAt,A?.evolutionCompletedAt,A?.evolutionInFlight,A?.evolutionStartedAt,A?.flowVersion]),Y=X.completedSteps,ee=X.xpAwardedSteps,ie=X.milestonesCompleted,fe=n.useMemo(()=>{const ge=Qn([...X.createQuestProgress.completed,...j]);return{...X.createQuestProgress,completed:ge,current:Wn(ge)}},[X.createQuestProgress,j]),U=n.useMemo(()=>new Set([...Y,...b]),[Y,b]),ce=n.useMemo(()=>new Set([...ee,...x]),[ee,x]),se=n.useMemo(()=>new Set([...ie,...S]),[ie,S]),ne=n.useMemo(()=>bs.find(ge=>!U.has(ge.id)),[U]),xe=ne?.id??null,G=n.useMemo(()=>X.evolutionInFlight,[X.evolutionInFlight]),ye=D??G,we=!!t?.id&&!a&&O&&L,Te=X.completed,qe=we&&(Te||!ne),Se=!!ne&&!se.has("mentor_intro_hello"),Pe=ne?.route??null,$e=CE({pathname:l.pathname,stepRoute:Pe,tutorialReady:we,tutorialComplete:qe,currentStepId:xe,evolutionInFlight:ye}),Be=n.useCallback(async ge=>{if(!t?.id)return;const Le=new Date().toISOString(),wt={...Pd(t.id)??{},...ge,version:fo,flowVersion:Ln,eligible:!0,lastUpdatedAt:Le};st.setItem(wf(t.id),JSON.stringify(wt));const ht=s?.onboarding_data??{},St={...Rd(ht)??{},...ge,version:fo,flowVersion:Ln,eligible:!0,lastUpdatedAt:Le},{error:Xs}=await k.from("profiles").update({onboarding_data:{...ht,guided_tutorial:St}}).eq("id",t.id);Xs||o.invalidateQueries({queryKey:["profile",t.id]})},[s?.onboarding_data,o,t?.id]);n.useEffect(()=>{if(!we||!X.needsMigration)return;const ge={flowVersion:Ln,completedSteps:X.completedSteps,xpAwardedSteps:X.xpAwardedSteps,milestonesCompleted:X.milestonesCompleted,substeps:{create_quest:{current:X.createQuestProgress.current,completed:X.createQuestProgress.completed,startedAt:X.createQuestProgress.startedAt,completedAt:X.createQuestProgress.completedAt}},completed:X.completed,completedAt:X.completedAt??(X.completed?new Date().toISOString():void 0),evolutionInFlight:X.evolutionInFlight,evolutionStartedAt:X.evolutionStartedAt,evolutionCompletedAt:X.evolutionCompletedAt},Le=JSON.stringify(ge);y.current!==Le&&(y.current=Le,Be(ge))},[X,Be,we]);const Me=n.useCallback(ge=>{if(se.has(ge))return;Qa("tutorial_step_transition",{userId:t?.id,milestoneId:ge,route:l.pathname}),N(He=>He.includes(ge)?He:[...He,ge]);const Le=Array.from(new Set([...Array.from(se),ge]));Be({milestonesCompleted:Le})},[l.pathname,se,Be,t?.id]),Qe=n.useCallback(ge=>{if(Se||!we||ne?.id!=="create_quest"||fe.current!==ge||fe.completed.includes(ge))return;const Le=[...fe.completed,ge],He=Qn(Le),wt=Wn(He),ht=He.length>=na.length;T(qt=>qt.includes(ge)?qt:[...qt,ge]),Me(ge),Be({substeps:{create_quest:{current:wt,completed:He,startedAt:fe.startedAt??new Date().toISOString(),completedAt:ht?new Date().toISOString():void 0}}})},[fe,ne?.id,Se,Me,Be,we]),De=n.useCallback(ge=>{if(Se||!we||U.has(ge)||u.current.has(ge))return;u.current.add(ge),window.setTimeout(()=>{u.current.delete(ge)},1e3);const Le=new Set([...U,ge]),He=Kn(Le),wt=bs.every(St=>Le.has(St.id));w(St=>St.includes(ge)?St:[...St,ge]);const ht=new Set(ce),qt=mE[ge]??0;!ht.has(ge)&&qt>0&&(ht.add(ge),v(St=>St.includes(ge)?St:[...St,ge]),r(qt,"guided_tutorial_step_complete",void 0,{guided_step:ge,source:"guided_tutorial"})),Be({completedSteps:He,xpAwardedSteps:Kn(ht),completed:wt,completedAt:wt?new Date().toISOString():void 0})},[r,ce,U,Se,Be,we]);n.useEffect(()=>{!qe||d.current||(d.current=!0,Be({completedSteps:bs.map(ge=>ge.id),xpAwardedSteps:Array.from(ce),completed:!0,completedAt:new Date().toISOString()}))},[ce,Be,qe]),n.useEffect(()=>{if(!(!we||qe||Se||!ne)){if(ne.id==="quests_campaigns_intro"){if(l.pathname!=="/journeys")return;se.has("quests_campaigns_intro")&&De("quests_campaigns_intro");return}if(ne.id!=="create_quest"){if(ne.id==="morning_checkin"){if(!se.has("open_mentor_tab")&&l.pathname==="/mentor"&&Me("open_mentor_tab"),se.has("open_mentor_tab")&&!se.has("submit_morning_checkin")){const ge=()=>{if(typeof document>"u"||l.pathname!=="/mentor")return!1;const He=!!document.querySelector('[data-tour="checkin-submit"]');return!!!document.querySelector('[data-tour="morning-checkin"]')||He?!1:(Me("submit_morning_checkin"),De("morning_checkin"),!0)};if(ge())return;const Le=window.setInterval(()=>{ge()&&window.clearInterval(Le)},Nd);return()=>{window.clearInterval(Le)}}return}if(ne.id==="companion_tab_intro"){if(l.pathname!=="/companion")return;se.has("companion_tab_intro")&&De("companion_tab_intro");return}if(ne.id==="evolve_companion"){const ge=t?.id?o.getQueryData(Um(t.id)):null;ge&&ge.current_stage>0&&!se.has("complete_companion_evolution")&&(Me("complete_companion_evolution"),De("evolve_companion"));return}if(ne.id==="post_evolution_companion_intro"){if(l.pathname!=="/companion")return;se.has("post_evolution_companion_intro")&&De("post_evolution_companion_intro");return}if(ne.id==="mentor_closeout"){if(l.pathname!=="/companion")return;se.has("mentor_closeout_message")||Me("mentor_closeout_message");const ge=window.setTimeout(()=>{De("mentor_closeout")},uE);return()=>{window.clearTimeout(ge)}}}}},[fe.current,ne,l.pathname,Qe,Me,De,o,se,Se,qe,we,t?.id]),n.useEffect(()=>{if(!ne||!we||qe||Se)return;const ge=[];return ne.id==="create_quest"&&(ge.push({eventName:"add-quest-sheet-opened",handler:()=>{l.pathname==="/journeys"&&Qe("open_add_quest")}}),ge.push({eventName:"add-quest-title-entered",handler:()=>{l.pathname==="/journeys"&&Qe("enter_title")}}),ge.push({eventName:"add-quest-time-selected",handler:Le=>{l.pathname!=="/journeys"||!Le.detail?.scheduledTime||Qe("select_time")}}),ge.push({eventName:"task-added",handler:Le=>{if(l.pathname!=="/journeys")return;const He=Le.detail;!He?.taskDate||!He?.scheduledTime||fe.current==="submit_create_quest"&&(Qe("submit_create_quest"),De("create_quest"))}})),ne.id==="morning_checkin"&&ge.push({eventName:"morning-checkin-completed",handler:()=>{l.pathname==="/mentor"&&(se.has("open_mentor_tab")||Me("open_mentor_tab"),Me("submit_morning_checkin"),De("morning_checkin"))}}),ne.id==="evolve_companion"&&(ge.push({eventName:"evolution-loading-start",handler:()=>{se.has("tap_evolve_companion")||Me("tap_evolve_companion"),R(!0),Be({evolutionInFlight:!0,evolutionStartedAt:new Date().toISOString()})}}),ge.push({eventName:"companion-evolved",handler:()=>{R(!1),Be({evolutionInFlight:!1,evolutionCompletedAt:new Date().toISOString()}),se.has("complete_companion_evolution")||Me("complete_companion_evolution"),De("evolve_companion")}})),ge.forEach(({eventName:Le,handler:He})=>{window.addEventListener(Le,He)}),()=>{ge.forEach(({eventName:Le,handler:He})=>{window.removeEventListener(Le,He)})}},[fe.current,ne,l.pathname,Qe,Me,De,se,Be,Se,qe,we]);const ve=n.useMemo(()=>ne?se.has("mentor_intro_hello")?ne.id==="quests_campaigns_intro"?"quests_campaigns_intro":ne.id==="create_quest"?fe.current:ne.id==="morning_checkin"?se.has("open_mentor_tab")?"submit_morning_checkin":"open_mentor_tab":ne.id==="companion_tab_intro"?"companion_tab_intro":ne.id==="evolve_companion"?ye?"complete_companion_evolution":"tap_evolve_companion":ne.id==="post_evolution_companion_intro"?"post_evolution_companion_intro":ne.id==="mentor_closeout"?"mentor_closeout_message":null:"mentor_intro_hello":null,[fe.current,ne,ye,se]),Z=ve==="mentor_intro_hello",Q=ve==="mentor_intro_hello"||ve==="quests_campaigns_intro"||ve==="companion_tab_intro"||ve==="post_evolution_companion_intro",J=Q?ve==="mentor_intro_hello"?"Start Tutorial":"Continue":void 0,de=n.useCallback(()=>{!ve||!Q||Me(ve)},[ve,Me,Q]),oe=n.useMemo(()=>ve?xE(ve):[],[ve]);n.useEffect(()=>{if(!$e||!Pe){m.current=null;return}const ge=`${l.pathname}->${Pe}`;m.current!==ge&&(m.current=ge,Qa("tutorial_route_restored",{userId:t?.id,from:l.pathname,to:Pe,stepId:ne?.id??null,milestoneId:ve}),c(Pe,{replace:!0}))},[ve,ne?.id,l.pathname,c,$e,Pe,t?.id]),n.useEffect(()=>{if(!ve){h.current=null,f.current=null;return}h.current=Date.now(),f.current=null,Qa("tutorial_step_enter",{userId:t?.id,stepId:ne?.id,milestoneId:ve,route:l.pathname})},[ve,ne?.id,l.pathname,t?.id]),n.useEffect(()=>{if(!we||qe||!ve||Z||$e||Id(l.pathname)){C(null),p.current=null;return}let ge=!1;const Le=()=>{if(ge)return;const wt=wE(oe);C(wt);const ht=`${ve}|${l.pathname}|${wt??"none"}`;f.current!==ht&&(f.current=ht,Qa("tutorial_target_resolution",{userId:t?.id,stepId:ne?.id,milestoneId:ve,selectorsTried:oe,resolvedSelector:wt,route:l.pathname,latencyMs:h.current===null?null:Date.now()-h.current}))};Le();const He=window.setInterval(Le,Nd);return window.addEventListener("resize",Le),window.addEventListener("orientationchange",Le),window.addEventListener("scroll",Le,!0),()=>{ge=!0,window.clearInterval(He),window.removeEventListener("resize",Le),window.removeEventListener("orientationchange",Le),window.removeEventListener("scroll",Le,!0)}},[oe,ve,ne?.id,Z,l.pathname,$e,qe,we,t?.id]);const Fe=we&&!qe&&!$e&&!Id(l.pathname)&&!!ne;n.useEffect(()=>{if(!(Fe&&xe==="evolve_companion"&&ve==="tap_evolve_companion"&&l.pathname==="/companion")){g.current=null;return}const Le=`${xe}|${ve}|${l.pathname}`;if(g.current===Le||_!==go)return;const He=document.querySelector(go);if(!He||(g.current=Le,vE(He,window.innerHeight)))return;const ht=typeof window.matchMedia=="function"&&window.matchMedia("(prefers-reduced-motion: reduce)").matches?"auto":"smooth";He.scrollIntoView({block:"center",inline:"nearest",behavior:ht}),Qa("tutorial_target_autoscroll",{userId:t?.id,stepId:xe,milestoneId:ve,route:l.pathname,selector:go,behavior:ht})},[_,ve,xe,Fe,l.pathname,t?.id]);const Je=xe==="create_quest"?fe.current:null,pt=xe?bs.findIndex(ge=>ge.id===xe):-1,nt=fe.completed.length+1,Ct=xe==="create_quest"?`Step ${pt+1} of ${bs.length} - Create Quest ${Math.min(nt,na.length)}/${na.length}`:xe?`Step ${pt+1} of ${bs.length}`:"",lt=ve?ve==="mentor_intro_hello"?yE(i?.slug,i?.name??"Your mentor"):EE(ve,i?.slug):{text:"",support:void 0},me=lt.support?[lt.text,lt.support]:[lt.text],Ae=Fe&&oe.length>0&&!_;Ae&&p.current===null&&(p.current=Date.now()),Ae||(p.current=null);const Ue=Ae&&p.current!==null&&Date.now()-p.current>dE;n.useEffect(()=>{!Ue||!ve||Qa("tutorial_target_missing",{userId:t?.id,stepId:xe,milestoneId:ve,selectorsTried:oe,route:l.pathname,elapsedMs:Date.now()-(p.current??Date.now())})},[oe,ve,xe,l.pathname,Ue,t?.id]);const xt=Ue?"I'm waiting for this area to load. Stay on this screen and it'll highlight as soon as it's ready.":lt.support,Pt=TE(ve);return{isIntroDialogueActive:Z,isActive:Fe,currentStep:xe,currentSubstep:Je,stepRoute:Pe,mentorInstructionLines:me,progressText:Ct,activeTargetSelectors:oe,activeTargetSelector:_,isStrictLockActive:!!(Fe&&_&&Pt),canTemporarilyHide:ve==="complete_companion_evolution",dialogueText:lt.text,dialogueSupportText:xt,speakerName:i?.name??"Your mentor",speakerPrimaryColor:i?.primary_color??"#f59e0b",speakerSlug:i?.slug,speakerAvatarUrl:i?.avatar_url,dialogueActionLabel:J,onDialogueAction:Q?de:void 0}},DE=({children:t})=>{const s=ME();return e.jsx(vf.Provider,{value:s,children:t})},_f=()=>n.useContext(vf),AE=12,jf=12,PE=8,Uo=0,qd=t=>t.anchor==="bottom"?{anchor:"bottom",bottomPx:Math.max(0,Math.round(t.bottomPx))}:{anchor:"top",topPx:Math.max(0,Math.round(t.topPx))},Nf=(t,s)=>t.anchor===s.anchor&&(t.anchor==="bottom"?t.bottomPx===s.bottomPx:t.topPx===s.topPx),RE=(t,s,a)=>!(t.right+a<=s.left||t.left-a>=s.right||t.bottom+a<=s.top||t.top-a>=s.bottom),Ld=(t,s,a)=>{const r=s.anchor==="bottom"?a-s.bottomPx-t.height:s.topPx;return{top:r,bottom:r+t.height,left:t.left,right:t.right,width:t.width,height:t.height}},IE=(t,s)=>{const a=Math.max(s.top-t.bottom,t.top-s.bottom,0),r=Math.max(s.left-t.right,t.left-s.right,0);return a*1e3+r},yo=t=>{if(!t)return null;const s=Number.parseFloat(t);return Number.isFinite(s)?Math.max(0,s):null},qE=()=>{if(typeof window>"u"||typeof document>"u")return 0;const t=window.getComputedStyle(document.documentElement),s=yo(t.getPropertyValue("--safe-area-inset-top"))??yo(t.getPropertyValue("--sat"));if(s!==null)return s;if(!document.body)return 0;const a=document.createElement("div");a.style.position="absolute",a.style.visibility="hidden",a.style.pointerEvents="none",a.style.paddingTop="env(safe-area-inset-top, 0px)",document.body.appendChild(a);const r=yo(window.getComputedStyle(a).paddingTop)??0;return a.remove(),r},LE=({safeAreaInsetTopPx:t,topMarginPx:s=jf,topSafeBufferPx:a=PE})=>Math.max(0,Math.round(t+s+a)),OE=({panelRect:t,targetRect:s,viewportHeight:a,baseBottomPx:r=Uo,gapPx:i=AE,topMarginPx:o=jf,minTopPx:l})=>{const c=Math.max(0,Math.round(Math.max(o,l??o))),d={anchor:"bottom",bottomPx:r};if(!s)return qd(d);const u=Math.max(r,a-t.height-c),p=Math.max(r,a-s.top+i),h={anchor:"bottom",bottomPx:Math.min(p,u)},m=[d,h,{anchor:"top",topPx:c}].map(qd).filter((b,w,x)=>w===x.findIndex(v=>Nf(v,b)));for(const b of m){const w=Ld(t,b,a);if(!RE(w,s,i))return b}let g=m[0],y=Number.NEGATIVE_INFINITY;for(const b of m){const w=Ld(t,b,a),x=IE(w,s);x>y&&(g=b,y=x)}return g},FE=()=>{const{isActive:t,activeTargetSelector:s,canTemporarilyHide:a,progressText:r,dialogueText:i,dialogueSupportText:o,speakerName:l,speakerPrimaryColor:c,speakerSlug:d,speakerAvatarUrl:u,dialogueActionLabel:p,onDialogueAction:h}=_f(),f=n.useRef(null),[m,g]=n.useState({anchor:"bottom",bottomPx:Uo}),[y,b]=n.useState(!1),w=n.useCallback(()=>{if(!t)return;const v=f.current;if(!v)return;const j=v.getBoundingClientRect();if(j.height<=0)return;const S=(s?document.querySelector(s):null)?.getBoundingClientRect()??null,N=qE(),D=LE({safeAreaInsetTopPx:N}),R=OE({panelRect:j,targetRect:S,viewportHeight:window.innerHeight,minTopPx:D});g(_=>Nf(_,R)?_:R)},[s,t]);n.useEffect(()=>{if(!t){g({anchor:"bottom",bottomPx:Uo});return}const v=window.requestAnimationFrame(w),j=()=>w();window.addEventListener("resize",j),window.addEventListener("scroll",j,!0),window.addEventListener("orientationchange",j);const T=typeof ResizeObserver<"u"?new ResizeObserver(()=>w()):null;return T&&f.current&&T.observe(f.current),()=>{window.cancelAnimationFrame(v),window.removeEventListener("resize",j),window.removeEventListener("scroll",j,!0),window.removeEventListener("orientationchange",j),T?.disconnect()}},[t,w]),n.useEffect(()=>{a||b(!1)},[a]);const x=n.useMemo(()=>m.anchor==="bottom"?{top:"auto",bottom:`${m.bottomPx}px`}:{bottom:"auto",top:`${m.topPx}px`},[m]);return!t||!i||a&&y?null:e.jsx("section",{ref:f,"data-tutorial":"mentor-dialogue-panel",className:"pointer-events-none fixed left-0 right-0 z-[105] px-3 pb-[calc(env(safe-area-inset-bottom,0px)+10px)] transition-[top,bottom] duration-200",style:x,"aria-live":"polite",children:e.jsx("div",{className:"pointer-events-none mx-auto max-w-4xl rounded-2xl border border-white/20 bg-black/65 shadow-[0_18px_40px_rgba(0,0,0,0.45)] backdrop-blur-md",children:e.jsxs("div",{className:"flex items-end gap-3 p-3 sm:p-4",children:[e.jsx("div",{className:"shrink-0",children:e.jsx(Ar,{mentorSlug:(d||"").toLowerCase(),mentorName:l,primaryColor:c||"#f59e0b",avatarUrl:u,size:"sm",className:"h-20 w-20 sm:h-24 sm:w-24",showBorder:!0,showGlow:!1})}),e.jsxs("div",{className:"min-w-0 flex-1",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-[0.16em] text-amber-200/90",children:r}),e.jsx("p",{className:"mt-1 inline-flex rounded-md bg-black/45 px-2 py-0.5 text-xs font-semibold text-amber-100",children:l}),e.jsx("p",{className:"mt-2 text-base leading-relaxed text-white sm:text-lg",children:i}),o?e.jsx("p",{className:"mt-1 text-sm leading-relaxed text-white/80",children:o}):null,a?e.jsx("div",{className:"mt-3",children:e.jsx(z,{type:"button",variant:"ghost","aria-label":"Hide tutorial",onClick:()=>b(!0),className:"pointer-events-auto h-9 rounded-xl border border-white/25 bg-black/45 text-white hover:bg-black/60",children:"Hide tutorial"})}):null,h?e.jsx("div",{className:"mt-3",children:e.jsx(z,{type:"button",onClick:h,className:"pointer-events-auto h-9 rounded-xl bg-amber-500 text-black hover:bg-amber-400",children:p||"Continue"})}):null]})]})})})},Sn=(t,s,a)=>Math.min(Math.max(t,s),a),$E=(t,s)=>{const a=t.getBoundingClientRect(),r=window.innerWidth,i=window.innerHeight,o=Sn(a.left-s,0,r),l=Sn(a.top-s,0,i),c=Sn(a.right+s,0,r),d=Sn(a.bottom+s,0,i);return{top:l,left:o,width:Math.max(0,c-o),height:Math.max(0,d-l)}},Od=t=>t?Array.from(t.querySelectorAll(["button:not([disabled])","[href]","input:not([disabled])","select:not([disabled])","textarea:not([disabled])",'[tabindex]:not([tabindex="-1"])'].join(","))).filter(s=>!s.hasAttribute("disabled")&&s.tabIndex!==-1):[],BE=({active:t,targetSelector:s,panelSelector:a='[data-tutorial="mentor-dialogue-panel"]'})=>{const[r,i]=n.useState(null),[o,l]=n.useState(null),[c,d]=n.useState(null);n.useEffect(()=>{if(!t||!s){i(null),d(null);return}const m=()=>{const y=document.querySelector(s);i(y),d(y?$E(y,10):null)};m();const g=window.setInterval(m,250);return window.addEventListener("scroll",m,!0),window.addEventListener("resize",m),window.addEventListener("orientationchange",m),()=>{window.clearInterval(g),window.removeEventListener("scroll",m,!0),window.removeEventListener("resize",m),window.removeEventListener("orientationchange",m)}},[t,s]),n.useEffect(()=>{if(!t){l(null);return}const m=()=>{l(document.querySelector(a))};m();const g=window.setInterval(m,250);return()=>{window.clearInterval(g)}},[t,a]),n.useEffect(()=>{if(!(!t||!r))return r.classList.add("mentor-spotlight-target-elevated"),()=>{r.classList.remove("mentor-spotlight-target-elevated")}},[t,r]),n.useEffect(()=>{if(!t||!r)return;const m=g=>{if(g.key!=="Tab")return;const y=[...Od(r),...Od(o)];if(y.length===0)return;const b=document.activeElement,w=b?y.indexOf(b):-1;if(w===-1){g.preventDefault(),y[0]?.focus();return}const x=g.shiftKey?(w-1+y.length)%y.length:(w+1)%y.length;g.preventDefault(),y[x]?.focus()};return document.addEventListener("keydown",m),()=>{document.removeEventListener("keydown",m)}},[t,o,r]);const u={onPointerDown:m=>{m.preventDefault(),m.stopPropagation()},onClick:m=>{m.preventDefault(),m.stopPropagation()}};if(!n.useMemo(()=>t&&r&&c,[t,r,c])||!c)return null;const h=window.innerWidth,f=window.innerHeight;return e.jsxs("div",{className:"mentor-spotlight-root","aria-hidden":"true","data-testid":"mentor-spotlight-guard",children:[e.jsx("div",{className:"mentor-spotlight-mask",style:{top:0,left:0,width:"100%",height:`${c.top}px`},...u}),e.jsx("div",{className:"mentor-spotlight-mask",style:{top:`${c.top}px`,left:0,width:`${c.left}px`,height:`${c.height}px`},...u}),e.jsx("div",{className:"mentor-spotlight-mask",style:{top:`${c.top}px`,left:`${c.left+c.width}px`,width:`${Math.max(0,h-(c.left+c.width))}px`,height:`${c.height}px`},...u}),e.jsx("div",{className:"mentor-spotlight-mask",style:{top:`${c.top+c.height}px`,left:0,width:"100%",height:`${Math.max(0,f-(c.top+c.height))}px`},...u}),e.jsx("div",{className:"mentor-spotlight-ring",style:{top:`${c.top}px`,left:`${c.left}px`,width:`${c.width}px`,height:`${c.height}px`}})]})},UE={queued:"secondary",syncing:"outline",synced:"default",failed:"destructive",dropped:"outline"},HE=t=>{switch(t){case"TASK_CREATE":return"Create quest";case"TASK_UPDATE":return"Update quest";case"TASK_COMPLETE":return"Toggle quest";case"TASK_DELETE":return"Delete quest";case"MENTOR_FEEDBACK":return"Mentor feedback";case"SUPPORT_REPORT":return"Support report";default:return t}};function zE({open:t,onOpenChange:s}){const{receipts:a,retryAll:r,retryAction:i,discardAction:o,queueCount:l}=gi(),c=a.some(d=>d.status==="failed");return e.jsx(yi,{open:t,onOpenChange:s,children:e.jsxs(rn,{side:"right",className:"w-full sm:max-w-xl",children:[e.jsxs(bl,{children:[e.jsx(nn,{children:"Queued Actions"}),e.jsxs(bi,{children:[l," pending action",l===1?"":"s",". Failed actions stay here until you retry or discard them."]})]}),e.jsx("div",{className:"mt-4 flex items-center gap-2",children:e.jsx(z,{onClick:()=>{r()},disabled:!c,children:"Retry all failed"})}),e.jsx(di,{className:"mt-4 h-[75vh] pr-2",children:e.jsx("div",{className:"space-y-3",children:a.length===0?e.jsx("div",{className:"rounded-lg border border-border/60 p-4 text-sm text-muted-foreground",children:"No queued actions."}):a.slice().sort((d,u)=>u.createdAt-d.createdAt).map(d=>e.jsxs("div",{className:"rounded-lg border border-border/60 p-3",children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium",children:HE(d.actionKind)}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(d.createdAt).toLocaleString()})]}),e.jsx(Oe,{variant:UE[d.status]??"outline",children:d.status})]}),e.jsxs("div",{className:"mt-2 text-xs text-muted-foreground",children:[e.jsxs("p",{children:["Entity: ",d.entityType,d.entityId?` (${d.entityId})`:""]}),e.jsxs("p",{children:["Retries: ",d.retryCount]}),d.lastError&&e.jsx("p",{className:"text-destructive",children:d.lastError})]}),(d.status==="failed"||d.status==="queued")&&e.jsxs("div",{className:"mt-3 flex items-center gap-2",children:[d.status==="failed"&&e.jsx(z,{size:"sm",onClick:()=>{i(d.id)},children:"Retry"}),e.jsx(z,{size:"sm",variant:"outline",onClick:()=>{o(d.id)},children:"Discard"})]})]},d.id))})})]})})}const Fd={offline:"bg-amber-600 text-white",degraded:"bg-amber-700 text-white",outage:"bg-red-700 text-white",recovering:"bg-sky-700 text-white",recovered:"bg-emerald-700 text-white"};function KE(){const t=ts(),{state:s,queueCount:a,retryNow:r,dismissDegraded:i}=gi(),[o,l]=n.useState(!1),c=s!=="healthy",d=n.useMemo(()=>{switch(s){case"offline":return`You're offline. ${a} action${a===1?"":"s"} queued.`;case"degraded":return"Service issues detected. We'll retry automatically.";case"outage":return"Server outage. Your actions are being queued locally.";case"recovering":return`Back online. Syncing ${a} action${a===1?"":"s"}...`;case"recovered":return"All queued actions synced.";default:return""}},[a,s]);return c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:`sticky top-0 z-[60] border-b border-black/20 px-3 py-2 text-xs sm:text-sm ${Fd[s]??Fd.offline}`,children:e.jsxs("div",{className:"mx-auto flex w-full max-w-6xl flex-col gap-2 sm:flex-row sm:items-center sm:justify-between",children:[e.jsx("p",{className:"font-medium",children:d}),s!=="recovered"&&e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(z,{size:"sm",variant:"secondary",className:"h-7 px-2 text-xs",onClick:()=>l(!0),children:"View queued actions"}),e.jsx(z,{size:"sm",variant:"secondary",className:"h-7 px-2 text-xs",onClick:()=>{r()},children:"Retry now"}),e.jsx(z,{size:"sm",variant:"secondary",className:"h-7 px-2 text-xs",onClick:()=>t("/support/report"),children:"Report issue"}),s==="degraded"&&e.jsx(z,{size:"sm",variant:"secondary",className:"h-7 px-2 text-xs",onClick:i,children:"Dismiss"})]})]})}),e.jsx(zE,{open:o,onOpenChange:l})]}):null}const QE=n.lazy(()=>ke(()=>import("./Home-C8MlTeIW.js"),__vite__mapDeps([19,1,2,3]))),WE=n.lazy(()=>ke(()=>import("./Auth-DO_x6Z6p.js"),__vite__mapDeps([20,1,2,3,21,22,23,24]))),GE=n.lazy(()=>ke(()=>import("./CalendarOAuthCallback-B3iqrPzA.js"),__vite__mapDeps([25,1,2,3]))),YE=n.lazy(()=>ke(()=>import("./ResetPassword-DwQ8jTyx.js"),__vite__mapDeps([26,1,2,3,21]))),VE=n.lazy(()=>ke(()=>import("./Onboarding-DovSRxEd.js"),__vite__mapDeps([27,1,2,3,21,28,29]))),XE=n.lazy(()=>ke(()=>import("./Welcome-ao5GqiCW.js"),__vite__mapDeps([30,1,2,3,22,24]))),JE=n.lazy(()=>ke(()=>import("./Preview-U93ZkXyR.js"),__vite__mapDeps([31,1,2,3,22]))),ZE=n.lazy(()=>ke(()=>import("./Profile-C_Hsi-pK.js"),__vite__mapDeps([32,1,2,3,33,34,28,23]))),eT=n.lazy(()=>ke(()=>import("./Premium-CF5-6AqT.js"),__vite__mapDeps([35,1,2,3,33]))),tT=n.lazy(()=>ke(()=>import("./PepTalkDetail-C2NlybG_.js"),__vite__mapDeps([36,1,2,3]))),sT=n.lazy(()=>ke(()=>import("./PromoCodeRedeem-Pw6hMTxk.js"),__vite__mapDeps([37,1,2,3]))),aT=n.lazy(()=>ke(()=>import("./Admin-cFATfUA6.js"),__vite__mapDeps([38,1,2,3]))),rT=n.lazy(()=>ke(()=>import("./MentorSelection-DVZkmn5N.js"),__vite__mapDeps([39,1,2,3,29]))),nT=n.lazy(()=>ke(()=>import("./NotFound-DuyunY91.js"),__vite__mapDeps([40,1,2,3]))),iT=n.lazy(()=>ke(()=>import("./Reflection-UCSAjkj9.js"),__vite__mapDeps([41,1,2,3]))),oT=n.lazy(()=>ke(()=>import("./MentorChat-4J7eyygm.js"),__vite__mapDeps([42,1,2,3]))),lT=n.lazy(()=>ke(()=>import("./Library-BjID8b-5.js"),__vite__mapDeps([43,1,2,3,44,34,23,45]))),cT=n.lazy(()=>ke(()=>import("./Challenges-Bd-ZKO6N.js"),__vite__mapDeps([46,1,2,3]))),dT=n.lazy(()=>ke(()=>import("./Search-B1sWCGDb.js"),__vite__mapDeps([47,1,2,3,45,44,34,23,17]))),uT=n.lazy(()=>ke(()=>import("./PepTalks-CNZFjcAs.js"),__vite__mapDeps([48,1,2,3,44,34,23]))),mT=n.lazy(()=>ke(()=>import("./TermsOfService-C-QMkV-s.js"),__vite__mapDeps([49,1,2,3]))),pT=n.lazy(()=>ke(()=>import("./PrivacyPolicy-wKBegAdL.js"),__vite__mapDeps([50,1,2,3]))),hT=n.lazy(()=>ke(()=>import("./PremiumSuccess-DAlAis3E.js"),__vite__mapDeps([51,1,2,3]))),fT=n.lazy(()=>ke(()=>import("./Epics-C9QLI4HE.js"),__vite__mapDeps([52,1,2,3]))),gT=n.lazy(()=>ke(()=>import("./SharedEpics-tC-ZIcqD.js"),__vite__mapDeps([53,1,2,3]))),xT=n.lazy(()=>ke(()=>import("./Partners-DBc-P0Ar.js"),__vite__mapDeps([54,1,2,3]))),yT=n.lazy(()=>ke(()=>import("./JoinEpic-S6OTtz2E.js"),__vite__mapDeps([55,1,2,3]))),bT=n.lazy(()=>ke(()=>import("./Creator-CF03iclo.js"),__vite__mapDeps([56,1,2,3]))),wT=n.lazy(()=>ke(()=>import("./InfluencerDashboard-RKD2R17e.js"),__vite__mapDeps([57,1,2,3]))),vT=n.lazy(()=>ke(()=>import("./AccountDeletionHelp-BaOsrkpW.js"),__vite__mapDeps([58,1,2,3,33]))),_T=n.lazy(()=>ke(()=>import("./Recaps-DBRIU8br.js"),__vite__mapDeps([59,1,2,3]))),jT=n.lazy(()=>ke(()=>import("./HelpCenter-5zRnk6B8.js"),__vite__mapDeps([60,1,2,3]))),NT=n.lazy(()=>ke(()=>import("./TestDayPlanner-o7wCqj5Y.js"),__vite__mapDeps([61,1,2,3]))),kT=n.lazy(()=>ke(()=>import("./TestScroll-DfMeuAn2.js"),__vite__mapDeps([62,1,2,3]))),CT=n.lazy(()=>ke(()=>import("./Contacts-DmlfAl8q.js"),__vite__mapDeps([63,1,2,3]))),ST=n.lazy(()=>ke(()=>import("./IAPTest-CIiYsZFB.js"),__vite__mapDeps([64,1,2,3]))),ET=n.lazy(()=>ke(()=>import("./SupportReport-DF6AIZ2o.js"),__vite__mapDeps([65,1,2,3]))),TT=new wx({defaultOptions:{queries:{staleTime:300*1e3,gcTime:600*1e3,refetchOnWindowFocus:!1,refetchOnReconnect:!0,retry:2,retryDelay:t=>Math.min(1e3*2**t,3e4)},mutations:{retry:1,retryDelay:1e3}}}),$d=()=>{[()=>ke(()=>import("./Profile-C_Hsi-pK.js"),__vite__mapDeps([32,1,2,3,33,34,28,23])),()=>ke(()=>import("./MentorChat-4J7eyygm.js"),__vite__mapDeps([42,1,2,3]))].forEach(s=>s())};typeof window<"u"&&("requestIdleCallback"in window?window.requestIdleCallback($d,{timeout:3e3}):setTimeout($d,1500));const Ho=n.memo(()=>e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"h-12 w-12 mx-auto rounded-full border-4 border-primary border-t-transparent animate-spin"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading..."})]})}));Ho.displayName="LoadingFallback";const kf=n.memo(()=>{const{pathname:t}=Xr();return n.useEffect(()=>{ff(t)||window.scrollTo(0,0)},[t]),null});kf.displayName="ScrollToTop";const Cf=n.memo(()=>e.jsxs(e.Fragment,{children:[e.jsx(p0,{}),e.jsx(Tw,{})]}));Cf.displayName="EvolutionAwareContent";const Sf=n.memo(()=>{const{isActive:t,activeTargetSelector:s,isStrictLockActive:a}=_f();return e.jsxs(e.Fragment,{children:[e.jsx(BE,{active:t&&a,targetSelector:s}),e.jsx(FE,{})]})});Sf.displayName="MentorTutorialLayer";const Ef=n.memo(()=>{const{profile:t,loading:s}=ss(),{session:a,status:r}=_e(),[i,o]=n.useState(!1),[l,c]=n.useState(!1),d=Xr(),u=ts();if(Mw({enabled:r==="authenticated"&&!!a?.user}),Uw({enabled:!!a?.user}),n.useEffect(()=>{const m=window.location.hash;m.includes("type=recovery")&&!d.pathname.includes("/auth/reset-password")&&u(`/auth/reset-password${m}`,{replace:!0}),c(!0)},[d.pathname,u]),n.useEffect(()=>{if(d.pathname!=="/"||typeof window>"u"||!a?.user||s||t?.onboarding_completed!==!0)return;ko.getItem("initialRouteRedirected")||(ko.setItem("initialRouteRedirected","true"),u("/journeys",{replace:!0}))},[d.pathname,u,t?.onboarding_completed,s,a?.user]),n.useEffect(()=>{const m=g=>{const y=g.detail;typeof y=="string"&&u(y)};return window.addEventListener("native-push-navigation",m),()=>window.removeEventListener("native-push-navigation",m)},[u]),n.useEffect(()=>{const m=g=>{const{path:y}=g.detail??{};y&&u(y)};return window.addEventListener("deep-link-navigation",m),()=>window.removeEventListener("deep-link-navigation",m)},[u]),n.useEffect(()=>{if(a?.user)try{oi()&&w0(a.user.id).catch(m=>{ue.error("Failed to initialize native push:",m)})}catch(m){ue.log("Native push initialization skipped:",m)}},[a]),n.useEffect(()=>{if(!s&&!i){const m=setTimeout(()=>{Ax(),o(!0)},100);return()=>clearTimeout(m)}},[s,i]),!l&&window.location.hash.includes("type=recovery"))return e.jsx(Ho,{});const p=ur(t),h=ff(d.pathname)?d.pathname:null,f=cE(d.pathname,!!a?.user);return e.jsx(uC,{children:e.jsxs(Xx,{mentorId:p,children:[e.jsx(KE,{}),e.jsx(Zx,{children:e.jsx(vy,{children:e.jsx(DE,{children:e.jsx(jw,{children:e.jsx(Tm,{children:e.jsx(ep,{children:e.jsx(x0,{children:e.jsx(xw,{children:e.jsxs(n.Suspense,{fallback:e.jsx(Ho,{}),children:[e.jsx(Cf,{}),h?e.jsx(jt,{children:e.jsx(gf,{activePath:h})}):e.jsx(Re,{mode:"sync",initial:!1,children:e.jsxs(vx,{location:d,children:[e.jsx(Ge,{path:"/welcome",element:e.jsx(XE,{})}),e.jsx(Ge,{path:"/preview",element:e.jsx(JE,{})}),e.jsx(Ge,{path:"/auth",element:e.jsx(WE,{})}),e.jsx(Ge,{path:"/calendar/oauth/callback",element:e.jsx(GE,{})}),e.jsx(Ge,{path:"/auth/reset-password",element:e.jsx(YE,{})}),e.jsx(Ge,{path:"/creator",element:e.jsx(bT,{})}),e.jsx(Ge,{path:"/creator/dashboard",element:e.jsx(wT,{})}),e.jsx(Ge,{path:"/onboarding",element:e.jsx(VE,{})}),e.jsx(Ge,{path:"/",element:e.jsx(jt,{children:e.jsx(QE,{})})}),e.jsx(Ge,{path:"/profile",element:e.jsx(jt,{children:e.jsx(ZE,{})})}),e.jsx(Ge,{path:"/promo-code",element:e.jsx(jt,{requireAccess:!1,children:e.jsx(sT,{})})}),e.jsx(Ge,{path:"/premium",element:e.jsx(jt,{children:e.jsx(eT,{})})}),e.jsx(Ge,{path:"/premium/success",element:e.jsx(jt,{children:e.jsx(hT,{})})}),e.jsx(Ge,{path:"/pep-talk/:id",element:e.jsx(jt,{children:e.jsx(tT,{})})}),e.jsx(Ge,{path:"/mentor-selection",element:e.jsx(jt,{children:e.jsx(rT,{})})}),e.jsx(Ge,{path:"/admin",element:e.jsx(jt,{requireMentor:!1,children:e.jsx(aT,{})})}),e.jsx(Ge,{path:"/tasks",element:e.jsx(Fa,{to:"/journeys",replace:!0})}),e.jsx(Ge,{path:"/epics",element:e.jsx(jt,{children:e.jsx(fT,{})})}),e.jsx(Ge,{path:"/join/:code",element:e.jsx(yT,{})}),e.jsx(Ge,{path:"/shared-epics",element:e.jsx(jt,{children:e.jsx(gT,{})})}),e.jsx(Ge,{path:"/mentor-chat",element:e.jsx(jt,{children:e.jsx(oT,{})})}),e.jsx(Ge,{path:"/horoscope",element:e.jsx(Fa,{to:"/journeys",replace:!0})}),e.jsx(Ge,{path:"/cosmic/:placement/:sign",element:e.jsx(Fa,{to:"/journeys",replace:!0})}),e.jsx(Ge,{path:"/challenges",element:e.jsx(jt,{children:e.jsx(cT,{})})}),e.jsx(Ge,{path:"/reflection",element:e.jsx(jt,{children:e.jsx(iT,{})})}),e.jsx(Ge,{path:"/library",element:e.jsx(jt,{children:e.jsx(lT,{})})}),e.jsx(Ge,{path:"/pep-talks",element:e.jsx(jt,{children:e.jsx(uT,{})})}),e.jsx(Ge,{path:"/inspire",element:e.jsx(Fa,{to:"/pep-talks",replace:!0})}),e.jsx(Ge,{path:"/search",element:e.jsx(jt,{children:e.jsx(dT,{})})}),e.jsx(Ge,{path:"/partners",element:e.jsx(xT,{})}),e.jsx(Ge,{path:"/account-deletion",element:e.jsx(vT,{})}),e.jsx(Ge,{path:"/recaps",element:e.jsx(jt,{children:e.jsx(_T,{})})}),e.jsx(Ge,{path:"/help",element:e.jsx(jt,{children:e.jsx(jT,{})})}),e.jsx(Ge,{path:"/campaigns",element:e.jsx(Fa,{to:"/journeys",replace:!0})}),e.jsx(Ge,{path:"/contacts",element:e.jsx(jt,{children:e.jsx(CT,{})})}),e.jsx(Ge,{path:"/iap-test",element:e.jsx(ST,{})}),e.jsx(Ge,{path:"/support/report",element:e.jsx(jt,{children:e.jsx(ET,{})})}),e.jsx(Ge,{path:"/guilds",element:e.jsx(Fa,{to:"/campaigns",replace:!0})}),e.jsx(Ge,{path:"/terms",element:e.jsx(mT,{})}),e.jsx(Ge,{path:"/privacy",element:e.jsx(pT,{})}),e.jsx(Ge,{path:"/test-scroll",element:e.jsx(kT,{})}),e.jsx(Ge,{path:"/test-day-planner",element:e.jsx(NT,{})}),e.jsx(Ge,{path:"*",element:e.jsx(nT,{})})]},d.pathname)}),f&&e.jsx(yf,{}),e.jsx(Sf,{})]})})})})})})})})})]})})});Ef.displayName="AppContent";const MT=()=>(n.useEffect(()=>{b0()},[]),e.jsx(ls,{children:e.jsx(_x,{client:TT,children:e.jsx(Ty,{children:e.jsx(ny,{children:e.jsx(_y,{children:e.jsx(jy,{children:e.jsxs(fm,{children:[e.jsx(Kx,{}),e.jsx(Qx,{}),e.jsx(y0,{}),e.jsx(jx,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:e.jsxs(qy,{children:[e.jsx(kf,{}),e.jsx(Ef,{})]})})]})})})})})})}));window.addEventListener("error",t=>{ue.error("Unhandled error:",t.error)});window.addEventListener("unhandledrejection",t=>{ue.error("Unhandled promise rejection:",t.reason)});"serviceWorker"in navigator&&!window.Capacitor?.isNativePlatform?.()&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js",{scope:"/"}).catch(()=>{})});const DT=()=>(n.useEffect(()=>{Dx()},[]),e.jsx(MT,{}));document.getElementById("debug-indicator")?.remove();Ze.isNativePlatform()&&Ze.getPlatform()==="ios"&&(document.documentElement.classList.add("platform-native-ios"),document.body.classList.add("platform-native-ios"));Nx.createRoot(document.getElementById("root")).render(e.jsx(DT,{}));export{as as $,FT as A,z as B,ka as C,yl as D,kh as E,xi as F,BT as G,$v as H,Ov as I,Oe as J,I as K,ct as L,Ar as M,Qy as N,Wy as O,Ys as P,Gy as Q,mr as R,an as S,LT as T,Ea as U,Ta as V,Da as W,Aa as X,Ma as Y,Pa as Z,la as _,mt as a,Ls as a$,Qt as a0,Is as a1,ps as a2,Uy as a3,e0 as a4,ea as a5,Yy as a6,Co as a7,st as a8,up as a9,Lv as aA,Rk as aB,iS as aC,Ph as aD,en as aE,Ra as aF,ml as aG,Ia as aH,qa as aI,La as aJ,H2 as aK,_C as aL,aS as aM,by as aN,Kv as aO,No as aP,xp as aQ,vp as aR,Ck as aS,vi as aT,rs as aU,_p as aV,F5 as aW,po as aX,Z0 as aY,Vs as aZ,qs as a_,us as aa,wi as ab,Rh as ac,$2 as ad,fl as ae,ui as af,Ss as ag,Es as ah,B2 as ai,di as aj,IT as ak,ma as al,wr as am,sa as an,dy as ao,Zw as ap,Ce as aq,Zt as ar,kw as as,n1 as at,dj as au,Ps as av,mv as aw,gi as ax,Ms as ay,Kp as az,cl as b,js as b0,NS as b1,vS as b2,BS as b3,ip as b4,Tw as b5,gt as b6,zE as b7,_a as b8,ja as b9,Ev as bA,b0 as bB,OT as bC,el as bD,gy as bE,qT as bF,HT as bG,li as bH,Na as ba,fm as bb,gm as bc,xm as bd,Jo as be,n5 as bf,Xt as bg,ad as bh,rd as bi,Ro as bj,Hs as bk,hr as bl,WS as bm,yi as bn,rn as bo,bl as bp,nn as bq,SC as br,qw as bs,hc as bt,pc as bu,Vy as bv,UT as bw,bw as bx,vw as by,yw as bz,_e as c,At as d,tn as e,Xe as f,tl as g,ur as h,Am as i,Fy as j,Oy as k,ue as l,ss as m,oi as n,$T as o,Ur as p,Hn as q,Qr as r,k as s,Hr as t,_s as u,lr as v,Wr as w,cr as x,ra as y,w0 as z};
