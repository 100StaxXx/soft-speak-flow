import{H as Ee,r as i,o as re,j as e,co as Te,an as De,e5 as ie,b0 as b,Q as Re,e6 as $e,ba as le,X as de,dd as ke,bI as Ie,cS as Ae,b_ as Oe}from"./vendor-DK8VKJIv.js";import{u as We,a4 as Le,bs as ne,bt as T,bu as G,B as c,f as m,N as g,O as h,g as u,L as B,aj as F,a5 as ce,a as Ge,bv as Be,s as oe}from"./index-vNUnYBjj.js";import"./date-vendor-BRrA_NVo.js";import"./three-vendor-qI8GXUTd.js";const o=i.memo(({value:f,label:D})=>{const N=typeof f=="boolean";return e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-border/30 last:border-0",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:D}),N?e.jsxs("span",{className:`flex items-center gap-1 text-sm font-medium ${f?"text-green-500":"text-red-500"}`,children:[f?e.jsx(le,{className:"h-4 w-4"}):e.jsx(de,{className:"h-4 w-4"}),f?"Yes":"No"]}):e.jsx("span",{className:"text-sm font-medium text-foreground",children:f})]})});o.displayName="StatusBadge";const Me=()=>{const f=Ee(),{toast:D}=We(),[N,z]=i.useState([]),[R,me]=i.useState(""),[_,$]=i.useState(null),[J,M]=i.useState(!1),[S,k]=i.useState(null),[j,w]=i.useState(null),[v,ue]=i.useState(null),[l,U]=i.useState(null),[xe,H]=i.useState(null),[V,P]=i.useState(null),[K,Y]=i.useState(!1),[X,Q]=i.useState(!1),[q,Z]=i.useState(!1),ee=i.useRef(null),{products:y,productsLoading:C,productError:I,handlePurchase:ge,handleRestore:he,handleManageSubscriptions:pe,loading:se,hasLoadedProducts:A,reloadProducts:te}=Le(),fe=i.useCallback(async()=>{a("[FETCH] Fetching products from App Store...","info");try{const s=await te();a(`[FETCH] Returned ${s.length} products`,s.length?"success":"info"),s.forEach((t,r)=>{a(`[FETCH] Product ${r}: id="${t.identifier}" title="${t.title}" price="${t.priceString}"`,"info")})}catch(s){a(`[FETCH] Failed: ${s instanceof Error?s.message:String(s)}`,"error")}},[te]),je=async s=>{k(s);const t=new Date().toLocaleTimeString("en-US",{hour12:!1});a(`[DIRECT] Attempting direct purchase (bypassing hook): ${s}`,"info");try{const r=await Be(s);a(`[DIRECT] Result: ${JSON.stringify(r)}`,"success"),w({productId:s,success:!0,message:`Direct purchase result: ${JSON.stringify(r)}`,timestamp:t})}catch(r){const n=r instanceof Error?r.message:String(r);a(`[DIRECT] Error: ${n}`,"error"),w({productId:s,success:!1,message:n,timestamp:t})}finally{k(null)}},O=re.getPlatform(),E=re.isNativePlatform(),W=O==="ios",a=(s,t="info")=>{const r=new Date().toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"});z(n=>[...n.slice(-100),{timestamp:r,message:s,type:t}])},L=s=>{const t=typeof s=="object"&&s!==null&&"code"in s&&String(s.code??"")||null,r=typeof s=="string"?s:s instanceof Error?s.message:typeof s=="object"&&s!==null&&"message"in s?String(s.message??""):"Unknown widget diagnostics error";return{code:t,message:r||"Unknown widget diagnostics error"}},p=i.useCallback(()=>{if(typeof window>"u")return;const s=window.sessionStorage.getItem(ne),t=window.sessionStorage.getItem(T);try{H(s?JSON.parse(s):null)}catch{H({parseError:"Failed to parse session diagnostics snapshot."})}try{P(t?JSON.parse(t):null)}catch{P({code:"PARSE_ERROR",message:"Failed to parse session widget error snapshot.",timestamp:new Date().toISOString(),source:"iap-test"})}},[]),be=i.useCallback(async()=>{Y(!0);try{const s=await G.getWidgetSyncDiagnostics();ue(s),a(`[WIDGET] Diagnostics fetched: accessible=${s.appGroupAccessible} hasPayload=${s.hasPayload} payloadDate=${s.payloadDate??"null"}`,s.appGroupAccessible?"success":"error"),typeof window<"u"&&window.sessionStorage.setItem(ne,JSON.stringify({...s,timestamp:new Date().toISOString()})),p()}catch(s){const t=L(s),r={code:t.code,message:t.message,timestamp:new Date().toISOString(),source:"iap-test/getWidgetSyncDiagnostics"};P(r),a(`[WIDGET] Diagnostics failed: ${t.code??"UNKNOWN"} ${t.message}`,"error"),typeof window<"u"&&window.sessionStorage.setItem(T,JSON.stringify(r)),p()}finally{Y(!1)}},[p]),Ne=i.useCallback(async()=>{Q(!0);try{const s=await G.runWidgetSyncProbe();if(U(s),s.errorCode||s.errorMessage){const t={code:s.errorCode,message:s.errorMessage??"Widget probe failed",timestamp:s.timestamp,source:"iap-test/runWidgetSyncProbe"};P(t),typeof window<"u"&&window.sessionStorage.setItem(T,JSON.stringify(t))}else typeof window<"u"&&window.sessionStorage.removeItem(T);a(`[WIDGET] Probe result: appGroupAccessible=${s.appGroupAccessible} writeSucceeded=${s.writeSucceeded} readBackSucceeded=${s.readBackSucceeded}`,s.writeSucceeded&&s.readBackSucceeded?"success":"error"),p()}catch(s){const t=L(s),r=new Date().toISOString(),n={appGroupAccessible:!1,writeSucceeded:!1,readBackSucceeded:!1,payloadByteCount:0,errorCode:t.code??"DIAGNOSTICS_FAILED",errorMessage:t.message,timestamp:r};U(n);const d={code:n.errorCode,message:n.errorMessage??t.message,timestamp:r,source:"iap-test/runWidgetSyncProbe"};P(d),a(`[WIDGET] Probe failed: ${d.code??"UNKNOWN"} ${d.message}`,"error"),typeof window<"u"&&window.sessionStorage.setItem(T,JSON.stringify(d)),p()}finally{Q(!1)}},[p]),Se=i.useCallback(async()=>{Z(!0);try{await G.reloadWidget(),a("[WIDGET] Requested widget timeline reload","success")}catch(s){const t=L(s);a(`[WIDGET] Reload failed: ${t.code??"UNKNOWN"} ${t.message}`,"error")}finally{Z(!1)}},[]);i.useEffect(()=>{const s=console.log,t=console.error,r=n=>["[IAP","[HOOK","[Apple","NativePurchases","product","purchase","subscription","receipt","transaction"].some(x=>n.toLowerCase().includes(x.toLowerCase()));return console.log=(...n)=>{s(...n);const d=n.map(x=>typeof x=="object"?JSON.stringify(x,null,2):String(x)).join(" ");r(d)&&a(d,"info")},console.error=(...n)=>{t(...n);const d=n.map(x=>typeof x=="object"?JSON.stringify(x,null,2):String(x)).join(" ");r(d)&&a(d,"error")},a("IAP Test Page initialized","info"),a(`Platform: ${O}, Native: ${E}, iOS: ${W}`,"info"),()=>{console.log=s,console.error=t}},[O,E,W]),i.useEffect(()=>{ee.current?.scrollIntoView({behavior:"smooth"})},[N]),i.useEffect(()=>{p()},[p]);const ae=async s=>{k(s);const t=new Date().toLocaleTimeString("en-US",{hour12:!1});a(`[TEST] Starting purchase for: ${s}`,"info"),a(`[TEST] Current products count: ${y.length}`,"info"),a(`[TEST] hasLoadedProducts: ${A}`,"info");try{a("[TEST] Calling handlePurchase...","info");const r=await ge(s);a(`[TEST] handlePurchase returned: ${r}`,r?"success":"error"),r?(a(`âœ… Purchase SUCCESS for: ${s}`,"success"),w({productId:s,success:!0,message:"Purchase completed successfully",timestamp:t})):(a(`âŒ Purchase BLOCKED for: ${s} - check toast messages`,"error"),w({productId:s,success:!1,message:"Purchase blocked or failed",timestamp:t}))}catch(r){const n=r instanceof Error?r.message:String(r);a(`âŒ Purchase EXCEPTION: ${n}`,"error"),w({productId:s,success:!1,message:n,timestamp:t})}finally{k(null)}},ye=async()=>{a("Starting restore purchases...","info");try{await he(),a("Restore completed","success")}catch(s){a(`Restore failed: ${s instanceof Error?s.message:String(s)}`,"error")}},we=async()=>{if(!R.trim()){D({title:"Error",description:"Please enter a transaction ID",variant:"destructive"});return}M(!0),$(null),a(`Verifying transaction: ${R}`,"info");try{const{data:{session:s}}=await oe.auth.getSession(),{data:t,error:r}=await oe.functions.invoke("verify-apple-receipt",{body:{transactionId:R},headers:s?.access_token?{Authorization:`Bearer ${s.access_token}`}:void 0});r?(a(`Verification error: ${r.message}`,"error"),$({error:r.message})):(a("Verification successful","success"),$(t))}catch(s){const t=s instanceof Error?s.message:String(s);a(`Verification exception: ${t}`,"error"),$({error:t})}finally{M(!1)}},ve=()=>{const s=N.map(t=>`[${t.timestamp}] ${t.message}`).join(`
`);navigator.clipboard.writeText(s),D({title:"Copied",description:"Logs copied to clipboard"})},Pe=()=>{z([]),a("Logs cleared","info")},Ce=!!(l&&l.appGroupAccessible&&l.writeSucceeded&&l.readBackSucceeded);return e.jsxs("div",{className:"min-h-screen pb-nav-safe bg-background pb-8",children:[e.jsx("div",{className:"sticky top-0 z-40 bg-background/95 backdrop-blur border-b border-border safe-area-top",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-3 flex items-center gap-3",children:[e.jsx(c,{variant:"ghost",size:"icon",onClick:()=>f(-1),children:e.jsx(Te,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold",children:"ðŸ§ª IAP Test Page"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Development & Debug Tools"})]})]})}),e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-4 space-y-4",children:[e.jsxs(m,{children:[e.jsx(g,{className:"pb-2",children:e.jsxs(h,{className:"text-sm flex items-center gap-2",children:[e.jsx(De,{className:"h-4 w-4"}),"Environment"]})}),e.jsxs(u,{className:"pt-0",children:[e.jsx(o,{label:"Platform",value:O}),e.jsx(o,{label:"Native",value:E}),e.jsx(o,{label:"iOS",value:W}),e.jsx(o,{label:"Products Loaded",value:A}),e.jsx(o,{label:"IAP Available",value:E&&W&&A})]})]}),e.jsxs(m,{children:[e.jsxs(g,{className:"pb-2",children:[e.jsxs(h,{className:"text-sm flex items-center gap-2",children:[e.jsx(ie,{className:"h-4 w-4"}),"Widget Sync Diagnostics"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"App Group runtime checks for widget payload visibility."})]}),e.jsxs(u,{className:"pt-0 space-y-3",children:[e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsxs(c,{variant:"outline",size:"sm",onClick:be,disabled:K,children:[K?e.jsx(b,{className:"h-4 w-4 mr-1.5 animate-spin"}):null,"Fetch Diagnostics"]}),e.jsxs(c,{variant:"outline",size:"sm",onClick:Ne,disabled:X,children:[X?e.jsx(b,{className:"h-4 w-4 mr-1.5 animate-spin"}):null,"Run Write Probe"]}),e.jsxs(c,{variant:"outline",size:"sm",onClick:Se,disabled:q,children:[q?e.jsx(b,{className:"h-4 w-4 mr-1.5 animate-spin"}):null,"Reload Widget"]})]}),e.jsxs("div",{className:"rounded-lg border border-border/50 px-3 py-2 space-y-1",children:[e.jsx(o,{label:"Probe Status",value:l?Ce?"PASS":"FAIL":"Not run"}),e.jsx(o,{label:"App Group Accessible",value:v?.appGroupAccessible??l?.appGroupAccessible??!1}),e.jsx(o,{label:"Has Payload",value:v?.hasPayload??!1}),e.jsx(o,{label:"Write Succeeded",value:l?.writeSucceeded??!1}),e.jsx(o,{label:"Readback Succeeded",value:l?.readBackSucceeded??!1}),e.jsx(o,{label:"Payload Bytes",value:String(l?.payloadByteCount??v?.payloadByteCount??0)}),e.jsx(o,{label:"Last Error Code",value:l?.errorCode??v?.lastErrorCode??V?.code??"none"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{className:"text-xs",children:"Widget Diagnostics JSON"}),e.jsx(F,{className:"h-44 rounded-lg bg-muted/30 border border-border/30",children:e.jsx("pre",{className:"text-xs p-3 font-mono",children:JSON.stringify({diagnostics:v,probe:l,sessionDiagnostics:xe,sessionError:V},null,2)})})]})]})]}),e.jsxs(m,{children:[e.jsx(g,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(h,{className:"text-sm",children:"App Store Products"}),e.jsx("div",{className:"flex gap-1",children:e.jsx(c,{variant:"ghost",size:"sm",onClick:fe,disabled:C,title:"Fetch Products",children:e.jsx(Re,{className:`h-4 w-4 ${C?"animate-spin":""}`})})})]})}),e.jsxs(u,{className:"pt-0 space-y-2",children:[C&&e.jsx("div",{className:"text-sm text-muted-foreground py-4 text-center",children:"Loading products..."}),I&&e.jsx("div",{className:"text-sm text-red-500 py-2 px-3 bg-red-500/10 rounded-lg",children:I}),!C&&!I&&y.length===0&&e.jsxs("div",{className:"text-sm text-muted-foreground py-4 text-center",children:["No products available. ",!E&&"(Run on device to load)"]}),y.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/30 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.title||s.identifier}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.priceString," â€¢ ",s.identifier]})]}),e.jsx(c,{size:"sm",onClick:()=>ae(s.identifier),disabled:S===s.identifier,children:S===s.identifier?e.jsx(b,{className:"h-4 w-4 animate-spin"}):"Buy"})]},s.identifier))]})]}),e.jsxs(m,{children:[e.jsxs(g,{className:"pb-2",children:[e.jsxs(h,{className:"text-sm flex items-center gap-2",children:[e.jsx($e,{className:"h-4 w-4"}),"Hardcoded Test Products"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Use these when App Store products don't load"})]}),e.jsx(u,{className:"pt-0 space-y-2",children:Object.entries(ce).map(([s,t])=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/30 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s}),e.jsx("p",{className:"text-xs text-muted-foreground font-mono",children:t})]}),e.jsx(c,{size:"sm",variant:"outline",onClick:()=>ae(t),disabled:S===t,children:S===t?e.jsx(b,{className:"h-4 w-4 animate-spin"}):"Test Buy"})]},s))})]}),e.jsxs(m,{children:[e.jsx(g,{className:"pb-2",children:e.jsxs(h,{className:"text-sm flex items-center gap-2",children:[e.jsx(ie,{className:"h-4 w-4"}),"Product State (Full Debug)"]})}),e.jsxs(u,{className:"pt-0 space-y-3",children:[e.jsx("pre",{className:"text-xs bg-muted/50 p-3 rounded-lg overflow-x-auto font-mono max-h-48 overflow-y-auto",children:JSON.stringify({hasLoadedProducts:A,productsLoading:C,productError:I,productCount:y.length,productIds:y.map(s=>s.identifier),fullProducts:y},null,2)}),e.jsxs("div",{className:"pt-2 border-t border-border/50",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Direct Purchase (bypasses validation):"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Object.entries(ce).map(([s,t])=>e.jsxs(c,{size:"sm",variant:"destructive",onClick:()=>je(t),disabled:S===t,className:"text-xs",children:[S===t?e.jsx(b,{className:"h-3 w-3 animate-spin mr-1"}):null,"Direct: ",s]},s))})]})]})]}),j&&e.jsxs(m,{className:j.success?"border-green-500/50 bg-green-500/5":"border-red-500/50 bg-red-500/5",children:[e.jsx(g,{className:"pb-2",children:e.jsxs(h,{className:"text-sm flex items-center gap-2",children:[j.success?e.jsx(le,{className:"h-4 w-4 text-green-500"}):e.jsx(de,{className:"h-4 w-4 text-red-500"}),"Last Purchase Result"]})}),e.jsx(u,{className:"pt-0",children:e.jsxs("div",{className:"text-sm space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Product:"})," ",e.jsx("span",{className:"font-mono text-xs",children:j.productId})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Result:"})," ",j.success?"âœ… Success":"âŒ Failed"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Message:"})," ",j.message]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:j.timestamp})]})})]}),e.jsxs(m,{children:[e.jsx(g,{className:"pb-2",children:e.jsx(h,{className:"text-sm",children:"Manual Verification"})}),e.jsxs(u,{className:"pt-0 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(B,{htmlFor:"transactionId",className:"text-xs",children:"Transaction ID"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(Ge,{id:"transactionId",placeholder:"Enter transaction ID...",value:R,onChange:s=>me(s.target.value),className:"font-mono text-sm"}),e.jsx(c,{onClick:we,disabled:J,size:"sm",children:J?e.jsx(b,{className:"h-4 w-4 animate-spin"}):"Verify"})]})]}),_&&e.jsxs("div",{className:"mt-3",children:[e.jsx(B,{className:"text-xs",children:"Result"}),e.jsx(F,{className:"h-32 mt-1",children:e.jsx("pre",{className:"text-xs bg-muted/50 p-3 rounded-lg overflow-x-auto font-mono",children:JSON.stringify(_,null,2)})})]})]})]}),e.jsxs(m,{children:[e.jsx(g,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(h,{className:"text-sm",children:"Debug Console"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(c,{variant:"ghost",size:"sm",onClick:ve,children:e.jsx(ke,{className:"h-4 w-4"})}),e.jsx(c,{variant:"ghost",size:"sm",onClick:Pe,children:e.jsx(Ie,{className:"h-4 w-4"})})]})]})}),e.jsx(u,{className:"pt-0",children:e.jsx(F,{className:"h-48 bg-muted/30 rounded-lg",children:e.jsxs("div",{className:"p-3 space-y-1 font-mono text-xs",children:[N.length===0?e.jsx("div",{className:"text-muted-foreground",children:"No logs yet..."}):N.map((s,t)=>e.jsxs("div",{className:`
                        ${s.type==="error"?"text-red-400":""}
                        ${s.type==="success"?"text-green-400":""}
                        ${s.type==="info"?"text-muted-foreground":""}
                      `,children:[e.jsxs("span",{className:"opacity-50",children:["[",s.timestamp,"]"]})," ",s.message]},t)),e.jsx("div",{ref:ee})]})})})]}),e.jsxs(m,{children:[e.jsx(g,{className:"pb-2",children:e.jsx(h,{className:"text-sm",children:"Quick Actions"})}),e.jsx(u,{className:"pt-0",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs(c,{variant:"outline",size:"sm",onClick:ye,disabled:se,className:"text-xs",children:[e.jsx(Ae,{className:`h-3 w-3 mr-1.5 ${se?"animate-spin":""}`}),"Restore Purchases"]}),e.jsxs(c,{variant:"outline",size:"sm",onClick:pe,className:"text-xs",children:[e.jsx(Oe,{className:"h-3 w-3 mr-1.5"}),"Manage Subs"]})]})})]}),e.jsx(m,{className:"border-dashed",children:e.jsx(u,{className:"py-4",children:e.jsxs("p",{className:"text-xs text-muted-foreground leading-relaxed",children:[e.jsx("strong",{children:"How to test:"}),' Build in Xcode â†’ Run on device/simulator â†’ Use Sandbox Apple ID for purchases â†’ Transactions appear in console above. Access this page by long-pressing "Command Center" on Profile.']})})})]})]})};export{Me as default};
