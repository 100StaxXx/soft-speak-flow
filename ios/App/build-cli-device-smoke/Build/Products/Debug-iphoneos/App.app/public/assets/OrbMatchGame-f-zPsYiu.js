import{r as s,j as a,l as xe,m as P}from"./vendor-DK8VKJIv.js";import{bt as ee,bu as Jt,bv as Kt,bw as Zt}from"./index-BJ43zXLh.js";import{t as B}from"./gameUtils-CBfv9FnM.js";import{u as eo,a as to,b as oo}from"./gameLifecycle-CMc-cG6H.js";import"./date-vendor-BRrA_NVo.js";import"./three-vendor-qI8GXUTd.js";const nt=30,ao=8,X=(o,t,c)=>t<0||t>=o.length||c<0||c>=(o[0]?.length??0)?null:o[t][c],ro=(o,t,c,l)=>{const d=X(o,t,c-1),g=X(o,t,c-2),b=X(o,t,c+1),y=X(o,t,c+2),k=X(o,t-1,c),E=X(o,t-2,c),O=X(o,t+1,c),T=X(o,t+2,c);return d===l&&g===l||d===l&&b===l||b===l&&y===l||(k===l&&E===l||k===l&&O===l||O===l&&T===l)},lt=({grid:o,row:t,col:c,availableColors:l,strategy:d,random:g=Math.random})=>{if(l.length===0)throw new Error("pickSpawnColor requires at least one available color");const b=l.filter(E=>!ro(o,t,c,E)),y=b.length>0?b:l,k=Math.floor(g()*y.length);return y[k]},it=o=>{const t=new Set,c=o.length,l=o[0]?.length??0;for(let d=0;d<c;d++){let g=0;for(;g<l;){const b=o[d][g];if(!b){g++;continue}let y=1;for(;g+y<l&&o[d][g+y]===b;)y++;if(y>=3)for(let k=0;k<y;k++)t.add(`${d},${g+k}`);g+=Math.max(1,y)}}for(let d=0;d<l;d++){let g=0;for(;g<c;){const b=o[g][d];if(!b){g++;continue}let y=1;for(;g+y<c&&o[g+y][d]===b;)y++;if(y>=3)for(let k=0;k<y;k++)t.add(`${g+k},${d}`);g+=Math.max(1,y)}}return t.size},_e=o=>it(o)>0,tt=o=>o.map(t=>[...t]),so=o=>{const t=o.length,c=o[0]?.length??0;for(let l=0;l<t;l++)for(let d=0;d<c;d++){const g=o[l][d];if(g){if(d+1<c&&o[l][d+1]){const b=tt(o),y=b[l][d+1];if(b[l][d]=y,b[l][d+1]=g,_e(b))return!0}if(l+1<t&&o[l+1][d]){const b=tt(o),y=b[l+1][d];if(b[l][d]=y,b[l+1][d]=g,_e(b))return!0}}}return!1},ot=(o,t,c,l)=>{const d=Array.from({length:o},()=>Array(t).fill(null));for(let g=0;g<o;g++)for(let b=0;b<t;b++)d[g][b]=lt({grid:d,row:g,col:b,availableColors:c,strategy:"initial",random:l});return d},no=({rows:o,cols:t,availableColors:c,maxAttempts:l=nt,random:d=Math.random})=>{if(c.length===0)throw new Error("generateInitialColorGrid requires at least one color");let g=null,b=Number.NEGATIVE_INFINITY;for(let y=0;y<l;y++){const k=ot(o,t,c,d),E=_e(k),O=so(k);if(!E&&O)return k;const T=(O?1e3:0)-it(k);T>b&&(b=T,g=k)}return g??ot(o,t,c,d)},at={normal:0,line_bomb:1,cross_bomb:2,star:3,cosmic_nova:0},lo=o=>{const t=new Map;for(const c of o){const l=`${c.row},${c.col}`,d=t.get(l);(!d||at[c.type]>at[d.type])&&t.set(l,c)}return Array.from(t.values())},io=async({maxSteps:o,getStep:t,onStep:c})=>{let l=0,d=t();for(;d&&l<o;)l+=1,await c(l,d),d=t();return{stepsProcessed:l,hitLimit:l===o&&d!==null,pendingStep:d}},co={beginner:{targetMod:.5,timeMod:1.5},easy:{targetMod:.7,timeMod:1.3},medium:{targetMod:1,timeMod:1},hard:{targetMod:1.4,timeMod:.85},master:{targetMod:2,timeMod:.7}},rt=(o,t)=>{const c=500+(o-1)*300,l=Math.max(30,60-(o-1)*2.5),d=Math.min(6,4+Math.floor(o/4)),g=Math.max(4,10-Math.floor(o/3)),b=Math.min(.3,o*.02);return{targetScore:Math.round(c*t.targetMod),timeLimit:Math.round(l*t.timeMod),colors:d,moveTime:g,specialSpawnBonus:b}},N=5,S=6,st=o=>{for(let t=0;t<N;t++)for(let c=0;c<S-2;c++){const l=o[t][c],d=o[t][c+1],g=o[t][c+2];if(l&&d&&g&&l.color===d.color&&d.color===g.color)return!0}for(let t=0;t<S;t++)for(let c=0;c<N-2;c++){const l=o[c][t],d=o[c+1][t],g=o[c+2][t];if(l&&d&&g&&l.color===d.color&&d.color===g.color)return!0}return!1},ct={fire:"â—",water:"â—†",earth:"â– ",light:"â˜…",dark:"â–²",cosmic:"âœ¦"},be={fire:{gradient:"linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #ff4757 100%)",glow:"rgba(255, 107, 107, 0.6)",inner:"rgba(255, 200, 150, 0.4)",emoji:"ðŸ”¥"},water:{gradient:"linear-gradient(135deg, #4facfe 0%, #00cec9 50%, #0984e3 100%)",glow:"rgba(79, 172, 254, 0.6)",inner:"rgba(200, 240, 255, 0.4)",emoji:"ðŸ’§"},earth:{gradient:"linear-gradient(135deg, #00b894 0%, #55a630 50%, #2d6a4f 100%)",glow:"rgba(0, 184, 148, 0.6)",inner:"rgba(200, 255, 220, 0.4)",emoji:"ðŸŒ¿"},light:{gradient:"linear-gradient(135deg, #ffd93d 0%, #ff9f1c 50%, #f9a825 100%)",glow:"rgba(255, 217, 61, 0.6)",inner:"rgba(255, 255, 220, 0.5)",emoji:"âœ¨"},dark:{gradient:"linear-gradient(135deg, #a855f7 0%, #7c3aed 50%, #6366f1 100%)",glow:"rgba(168, 85, 247, 0.6)",inner:"rgba(220, 200, 255, 0.4)",emoji:"ðŸŒ™"},cosmic:{gradient:"linear-gradient(135deg, #f472b6 0%, #ec4899 50%, #e11d48 100%)",glow:"rgba(244, 114, 182, 0.6)",inner:"rgba(255, 200, 230, 0.4)",emoji:"ðŸ’«"}},dt=s.memo(({intensity:o=.7})=>a.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[a.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 via-transparent to-cyan-500/5"}),a.jsx("div",{className:"stars-layer",style:{opacity:o}})]}));dt.displayName="StarBackground";const ut=s.memo(({explosion:o,onComplete:t})=>(s.useEffect(()=>{const c=setTimeout(t,400);return()=>clearTimeout(c)},[t]),a.jsxs("div",{className:"absolute pointer-events-none z-50 explosion-effect",style:{left:o.x,top:o.y,"--explosion-color":o.color},children:[a.jsx("div",{className:"explosion-ring",style:{borderColor:o.color}}),a.jsxs("div",{className:"explosion-score",style:{color:o.color},children:["+",o.score]})]})));ut.displayName="MatchExplosionEffect";const mt=s.memo(({multiplier:o})=>a.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 pointer-events-none cascade-popup",children:a.jsxs("span",{className:"text-4xl font-black text-yellow-400 drop-shadow-glow",children:["x",o,"!"]})}));mt.displayName="CascadeMultiplier";const pt=s.memo(({orbs:o,cellSize:t})=>a.jsx(a.Fragment,{children:o.map((c,l)=>a.jsx("div",{className:"absolute rounded-full pointer-events-none z-40 hint-pulse",style:{width:t-12,height:t-12,left:c.col*t+6,top:c.row*t+6}},l))}));pt.displayName="HintIndicator";const ft=s.memo(({progress:o,isComplete:t})=>{const l=2*Math.PI*18,d=l*(1-Math.min(1,o));return a.jsxs("svg",{className:"absolute -right-1 -top-1",width:"44",height:"44",viewBox:"0 0 44 44",children:[a.jsx("circle",{cx:"22",cy:"22",r:18,fill:"none",stroke:"rgba(255,255,255,0.1)",strokeWidth:"3"}),a.jsx("circle",{cx:"22",cy:"22",r:18,fill:"none",stroke:t?"#22c55e":"#a855f7",strokeWidth:"3",strokeLinecap:"round",strokeDasharray:l,strokeDashoffset:d,className:"transition-all duration-200",style:{transform:"rotate(-90deg)",transformOrigin:"center"}})]})});ft.displayName="ScoreProgressRing";const ht=s.memo(()=>a.jsx("div",{className:"absolute inset-0 pointer-events-none z-30 rounded-2xl urgency-pulse"}));ht.displayName="UrgencyOverlay";const gt=s.memo(()=>a.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-50 pointer-events-none perfect-banner",children:a.jsx("div",{className:"px-8 py-4 rounded-2xl bg-yellow-500/20 border-2 border-yellow-500/60 shadow-glow-yellow",children:a.jsx("span",{className:"text-2xl font-black text-yellow-400 drop-shadow-glow",children:"â­ PERFECT! +50 â­"})})}));gt.displayName="PerfectGameBanner";const xt=s.memo(()=>a.jsxs("div",{className:"absolute inset-0 flex items-center justify-center z-50 bg-black/50 rounded-2xl",children:[a.jsx("span",{className:"text-4xl animate-spin",children:"ðŸ”€"}),a.jsx("span",{className:"ml-3 text-lg font-bold text-white",children:"Shuffling..."})]}));xt.displayName="ShuffleOverlay";const bt=s.memo(({level:o,levelScore:t,timeBonus:c,totalScore:l,onContinue:d})=>(s.useEffect(()=>{const g=setTimeout(d,2500);return()=>clearTimeout(g)},[d]),a.jsx(P.div,{className:"absolute inset-0 flex flex-col items-center justify-center z-50 bg-black/70 rounded-2xl backdrop-blur-sm",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:a.jsxs(P.div,{initial:{scale:0,rotate:-10},animate:{scale:1,rotate:0},transition:{type:"spring",damping:15},className:"text-center",children:[a.jsx("div",{className:"text-4xl mb-2",children:"ðŸŽ‰"}),a.jsxs("h2",{className:"text-2xl font-black text-yellow-400 mb-1 drop-shadow-glow",children:["LEVEL ",o," COMPLETE!"]}),a.jsxs("div",{className:"space-y-1 text-sm",children:[a.jsxs("p",{className:"text-white/80",children:["Level Score: ",a.jsxs("span",{className:"text-green-400 font-bold",children:["+",t]})]}),a.jsxs("p",{className:"text-white/80",children:["Time Bonus: ",a.jsxs("span",{className:"text-cyan-400 font-bold",children:["+",c]})]}),a.jsxs("p",{className:"text-white/60 text-xs mt-2",children:["Total: ",a.jsx("span",{className:"text-purple-400 font-bold",children:l})]})]}),a.jsx(P.div,{className:"mt-4 px-4 py-2 bg-purple-500/30 rounded-full border border-purple-400/50",initial:{opacity:0},animate:{opacity:1},transition:{delay:1},children:a.jsx("span",{className:"text-sm text-purple-200",children:"Next level starting..."})})]})})));bt.displayName="LevelCompleteOverlay";const wt=s.memo(({level:o,progress:t})=>a.jsx("div",{className:"absolute left-1 top-1 z-40",children:a.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 bg-black/60 rounded-full border border-purple-500/40 backdrop-blur-sm",children:[a.jsx("span",{className:"text-[10px] font-bold text-purple-400",children:"LVL"}),a.jsx("span",{className:"text-base font-black text-white",children:o}),a.jsx("div",{className:"w-10 h-1 bg-white/10 rounded-full overflow-hidden",children:a.jsx("div",{className:"h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-200",style:{width:`${Math.min(100,t*100)}%`}})})]})}));wt.displayName="LevelIndicator";const yt=s.memo(()=>a.jsx(P.div,{className:"absolute inset-0 flex items-center justify-center z-50 pointer-events-none",initial:{opacity:0,scale:.5},animate:{opacity:[0,1,1,0],scale:[.5,1.2,1,1]},transition:{duration:1,times:[0,.3,.7,1]},children:a.jsx("div",{className:"px-8 py-4 rounded-2xl bg-gradient-to-r from-purple-500/40 to-pink-500/40 border-2 border-purple-400/60 shadow-glow-purple",children:a.jsx("span",{className:"text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-pink-400",children:"â¬†ï¸ LEVEL UP! â¬†ï¸"})})}));yt.displayName="LevelUpBanner";const vt=s.memo(({effect:o,cellSize:t,onComplete:c})=>{s.useEffect(()=>{const d=setTimeout(c,400);return()=>clearTimeout(d)},[c]);const l=o.type==="beam_horizontal";return a.jsx(P.div,{className:"absolute z-50 pointer-events-none",initial:{opacity:0,scaleX:l?0:1,scaleY:l?1:0},animate:{opacity:1,scaleX:1,scaleY:1},exit:{opacity:0},style:{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.9), transparent)",height:l?6:t*N,width:l?t*S:6,top:l?o.row*t+t/2-3:0,left:l?0:o.col*t+t/2-3,boxShadow:"0 0 20px rgba(255,255,255,0.8), 0 0 40px rgba(168,85,247,0.6)"}})});vt.displayName="BeamEffect";const jt=s.memo(({effect:o,cellSize:t,onComplete:c})=>(s.useEffect(()=>{const l=setTimeout(c,500);return()=>clearTimeout(l)},[c]),a.jsxs(a.Fragment,{children:[a.jsx(P.div,{className:"absolute z-50 pointer-events-none",initial:{opacity:0,scaleX:0},animate:{opacity:1,scaleX:1},exit:{opacity:0},style:{background:"linear-gradient(90deg, transparent, rgba(255,215,0,0.9), transparent)",height:6,width:t*S,top:o.row*t+t/2-3,left:0,boxShadow:"0 0 20px rgba(255,215,0,0.8)"}}),a.jsx(P.div,{className:"absolute z-50 pointer-events-none",initial:{opacity:0,scaleY:0},animate:{opacity:1,scaleY:1},exit:{opacity:0},style:{background:"linear-gradient(180deg, transparent, rgba(255,215,0,0.9), transparent)",height:t*N,width:6,top:0,left:o.col*t+t/2-3,boxShadow:"0 0 20px rgba(255,215,0,0.8)"}})]})));jt.displayName="CrossBeamEffect";const Mt=s.memo(({effect:o,cellSize:t,onComplete:c})=>(s.useEffect(()=>{const l=setTimeout(c,600);return()=>clearTimeout(l)},[c]),a.jsx(P.div,{className:"absolute z-50 pointer-events-none",initial:{scale:0,opacity:1},animate:{scale:4,opacity:0},transition:{duration:.6},style:{width:t,height:t,left:o.col*t,top:o.row*t,background:`radial-gradient(circle, ${o.color||"rgba(255,215,0,0.8)"}, transparent)`,borderRadius:"50%"}})));Mt.displayName="ColorBurstEffect";const Ct=s.memo(({effect:o,cellSize:t,onComplete:c})=>(s.useEffect(()=>{const l=setTimeout(c,700);return()=>clearTimeout(l)},[c]),a.jsxs(a.Fragment,{children:[a.jsx(P.div,{className:"absolute rounded-full z-50 pointer-events-none",initial:{scale:0,opacity:1},animate:{scale:5,opacity:0},transition:{duration:.7},style:{width:t*3,height:t*3,left:o.col*t-t,top:o.row*t-t,background:"radial-gradient(circle, rgba(255,255,255,0.9), rgba(168,85,247,0.6), rgba(236,72,153,0.4), transparent)"}}),[...Array(8)].map((l,d)=>a.jsx(P.div,{className:"absolute z-50 pointer-events-none",initial:{scale:0,opacity:1,x:0,y:0},animate:{scale:[0,1,.5],opacity:[1,.8,0],x:Math.cos(d*Math.PI/4)*t*2,y:Math.sin(d*Math.PI/4)*t*2},transition:{duration:.5},style:{width:12,height:12,borderRadius:"50%",background:"white",left:o.col*t+t/2-6,top:o.row*t+t/2-6,boxShadow:"0 0 10px rgba(255,255,255,0.8)"}},d))]})));Ct.displayName="CosmicNovaEffect";const Nt=s.memo(({orb:o,cellSize:t,isSelected:c,isInPath:l,isReverting:d,showAccessibility:g})=>{const b=be[o.color],y=t-8,E=(()=>{switch(o.special){case"line_bomb":return{border:"3px dashed rgba(255,255,255,0.9)",animation:"special-pulse 1s infinite",icon:"âž–"};case"star":return{border:"3px solid gold",animation:"special-rainbow 1.5s infinite",icon:"â˜…"};case"cross_bomb":return{border:"3px double rgba(255,215,0,0.9)",animation:"special-rotate 2s linear infinite",icon:"âœš"};case"cosmic_nova":return{border:"4px solid magenta",animation:"special-nova 0.8s infinite",icon:"âœ¦"};default:return{border:"2px solid rgba(255,255,255,0.25)",animation:void 0,icon:null}}})(),O=o.col*t+(t-y)/2,T=o.row*t+(t-y)/2,F=o.matched?0:c?1.15:l?1.08:1;return a.jsxs("div",{className:`absolute rounded-full flex items-center justify-center orb-base ${c?"z-30":l?"z-20":"z-10"} ${o.matched?"orb-matched":""} ${o.isNew?"orb-new":""} ${d?"orb-revert":""}`,style:{width:y,height:y,background:b.gradient,border:E.border,transform:`translate(${O}px, ${T}px) scale(${F})`,boxShadow:c||l?`0 8px 20px rgba(0,0,0,0.4), 0 0 15px ${b.glow}`:o.special!=="normal"?`0 4px 15px rgba(0,0,0,0.4), 0 0 20px ${b.glow}, 0 0 30px ${o.special==="cosmic_nova"?"rgba(236,72,153,0.5)":"rgba(255,215,0,0.3)"}`:`0 4px 10px rgba(0,0,0,0.3), 0 0 10px ${b.glow}`,animation:E.animation,"--start-y":`${-t*2}px`},children:[a.jsx("div",{className:"absolute rounded-full pointer-events-none",style:{width:"60%",height:"60%",top:"10%",left:"20%",background:`radial-gradient(circle at 30% 30%, ${b.inner}, transparent 70%)`}}),a.jsx("span",{className:"text-base select-none relative z-10 drop-shadow-sm",children:g?ct[o.color]:b.emoji}),E.icon&&a.jsx("span",{className:"absolute -top-1 -right-1 text-xs bg-black/60 rounded-full w-4 h-4 flex items-center justify-center z-20",children:E.icon}),(c||l)&&a.jsx("div",{className:"absolute inset-[-3px] rounded-full pointer-events-none selection-ring",style:{borderColor:b.glow,boxShadow:`0 0 10px ${b.glow}`}})]})});Nt.displayName="OrbComponent";const xo=({companionStats:o,onComplete:t,onDamage:c,tierAttackDamage:l,difficulty:d="medium",questIntervalScale:g=0,maxTimer:b,isPractice:y=!1,compact:k=!1})=>{const E=eo(),{completeOnce:O}=to(t),{registerTimeout:T,registerInterval:F,clearTimer:_}=oo(),[j,H]=s.useState("countdown"),[G,q]=s.useState([]),[te,re]=s.useState(null),[we,se]=s.useState([]),[Q,ye]=s.useState(0),[D,oe]=s.useState(0),[A,Re]=s.useState(0),[ve,St]=s.useState(0),[U,kt]=s.useState(1),[Y,Tt]=s.useState(0),[Et,$t]=s.useState(0),[je,Lt]=s.useState(0),[_t,Ae]=s.useState(!1),[Rt,Ie]=s.useState(0),[Me,At]=s.useState(0),[Oe,Be]=s.useState(0),[It,Ce]=s.useState(!1),[Ot,Pe]=s.useState([]),[Ge,ne]=s.useState(null),[Ne,De]=s.useState(!1),[Bt,Pt]=s.useState(!1),[Gt,Ue]=s.useState(new Set),[le,Dt]=s.useState(!1),[Ut,Ye]=s.useState([]),Se=s.useRef(null),V=s.useRef(null),J=s.useRef(null),W=s.useRef(!1),z=s.useRef(G),ie=s.useRef(null),ce=s.useRef(j),ke=s.useRef(0);s.useEffect(()=>{z.current=G},[G]),s.useEffect(()=>{ce.current=j,j!=="playing"&&(ke.current+=1)},[j]);const Te=s.useCallback(e=>new Promise(u=>{T(u,e)}),[T]),ze=o.soul/100,de=co[d],$=s.useMemo(()=>{const e=rt(U,de);return{...e,moveTime:Math.max(3,e.moveTime-g*.5+ze*1.5)}},[U,de,g,ze]),Ee=b??$.timeLimit,ae=s.useMemo(()=>["fire","water","earth","light","dark","cosmic"].slice(0,$.colors),[$.colors]),I=s.useMemo(()=>280/S,[]),ue=s.useCallback(e=>{const u=Array(N).fill(null).map(()=>Array(S).fill(null));e.forEach(r=>{u[r.row][r.col]=r});for(let r=0;r<N;r++)for(let i=0;i<S;i++){const m=u[r][i];if(m){if(i<S-1&&u[r][i+1]){const f=u.map(p=>[...p]);if(f[r][i]=u[r][i+1],f[r][i+1]=m,st(f))return[{row:r,col:i},{row:r,col:i+1}]}if(r<N-1&&u[r+1][i]){const f=u.map(p=>[...p]);if(f[r][i]=u[r+1][i],f[r+1][i]=m,st(f))return[{row:r,col:i},{row:r+1,col:i}]}}}return null},[]),Xe=s.useCallback(()=>{De(!0),B("medium"),c?.({target:"player",amount:l||15,source:"no_moves"}),T(()=>{E.current&&(q(e=>{const u=e.map(r=>r.color);for(let r=u.length-1;r>0;r--){const i=Math.floor(Math.random()*(r+1));[u[r],u[i]]=[u[i],u[r]]}return e.map((r,i)=>({...r,color:u[i]}))}),De(!1))},600)},[c,l,T,E]),me=s.useCallback(e=>{const r=no({rows:N,cols:S,availableColors:e||ae,maxAttempts:nt}),i=[];for(let m=0;m<N;m++)for(let f=0;f<S;f++)i.push({id:`${m}-${f}`,color:r[m][f],row:m,col:f,special:"normal"});q(i),z.current=i},[ae]),Fe=s.useCallback(()=>{me(),oe($.moveTime),re(null),se([]),ne(null),W.current=!1},[me,$.moveTime]),Yt=s.useCallback(()=>{H("playing"),ye(Ee),Fe()},[Ee,Fe]),K=s.useCallback(()=>{ne(null),_(J.current),J.current=T(()=>{if(!E.current||ce.current!=="playing")return;const e=ue(z.current);e&&(ne(e),B("light"))},4e3)},[ue,_,T,E]),He=s.useCallback((e,u,r)=>{switch(e.special){case"line_bomb":{const i=e.col%2===0,m=[];if(i)for(let f=0;f<S;f++){const p=u[e.row][f];p&&m.push(p.id)}else for(let f=0;f<N;f++){const p=u[f][e.col];p&&m.push(p.id)}return{affectedIds:m,bonusDamage:ee.orb_match.specialActivation,effectType:i?"beam_horizontal":"beam_vertical"}}case"cross_bomb":{const i=[];for(let m=0;m<S;m++){const f=u[e.row][m];f&&i.push(f.id)}for(let m=0;m<N;m++){const f=u[m][e.col];f&&!i.includes(f.id)&&i.push(f.id)}return{affectedIds:i,bonusDamage:ee.orb_match.specialActivation,effectType:"cross_beam"}}case"star":return{affectedIds:r.filter(m=>m.color===e.color).map(m=>m.id),bonusDamage:ee.orb_match.specialActivation,effectType:"color_burst"};case"cosmic_nova":{const i=[];for(let m=Math.max(0,e.row-1);m<=Math.min(N-1,e.row+1);m++)for(let f=Math.max(0,e.col-1);f<=Math.min(S-1,e.col+1);f++){const p=u[m][f];p&&i.push(p.id)}return{affectedIds:i,bonusDamage:ee.orb_match.specialActivation,effectType:"cosmic_nova"}}default:return null}},[]),Ve=s.useCallback(e=>{const u=new Set,r=[],i=[],m=[],f=Array(N).fill(null).map(()=>Array(S).fill(null));e.forEach(n=>{f[n.row][n.col]=n});const p=new Map;for(let n=0;n<N;n++){let x=0;for(;x<S;){const h=f[n][x];if(!h){x++;continue}let w=1;for(;x+w<S&&f[n][x+w]?.color===h.color;)w++;if(w>=3){const C=[];for(let R=0;R<w;R++){const v=f[n][x+R];v&&(u.add(v.id),C.push(v.id),p.set(`${n}-${x+R}`,{row:n,col:x+R,color:h.color}))}const L=x+Math.floor(w/2);r.push({ids:C,size:w,color:h.color,centerRow:n,centerCol:L,isHorizontal:!0}),w===4?i.push({row:n,col:L,type:"line_bomb",color:h.color}):w>=5&&i.push({row:n,col:L,type:"cross_bomb",color:h.color})}x+=Math.max(1,w)}}for(let n=0;n<S;n++){let x=0;for(;x<N;){const h=f[x][n];if(!h){x++;continue}let w=1;for(;x+w<N&&f[x+w][n]?.color===h.color;)w++;if(w>=3){const C=[];for(let R=0;R<w;R++){const v=f[x+R][n];v&&!u.has(v.id)&&C.push(v.id),v&&(u.add(v.id),p.set(`${x+R}-${n}`,{row:x+R,col:n,color:h.color}))}const L=x+Math.floor(w/2);C.length>0&&r.push({ids:C,size:w,color:h.color,centerRow:L,centerCol:n,isHorizontal:!1}),w===4?i.push({row:L,col:n,type:"line_bomb",color:h.color}):w>=5&&i.push({row:L,col:n,type:"cross_bomb",color:h.color})}x+=Math.max(1,w)}}for(const[,n]of p){const x=p.has(`${n.row}-${n.col-1}`)&&p.get(`${n.row}-${n.col-1}`)?.color===n.color||p.has(`${n.row}-${n.col+1}`)&&p.get(`${n.row}-${n.col+1}`)?.color===n.color,h=p.has(`${n.row-1}-${n.col}`)&&p.get(`${n.row-1}-${n.col}`)?.color===n.color||p.has(`${n.row+1}-${n.col}`)&&p.get(`${n.row+1}-${n.col}`)?.color===n.color;if(x&&h&&!i.find(C=>C.row===n.row&&C.col===n.col&&C.type==="star")){const C=i.findIndex(L=>L.row===n.row&&L.col===n.col);C>=0?i[C]={row:n.row,col:n.col,type:"star",color:n.color}:i.push({row:n.row,col:n.col,type:"star",color:n.color})}}for(const n of u){const x=e.find(h=>h.id===n);if(x&&x.special&&x.special!=="normal"){const h=He(x,f,e);h&&(m.push({orb:x,...h}),h.affectedIds.forEach(w=>u.add(w)))}}const M=Array.from(u).map(n=>e.find(x=>x.id===n)).filter(n=>n&&n.special&&n.special!=="normal");if(M.length>=2){const n=M[0],x=[];for(const h of M)for(let w=Math.max(0,h.row-1);w<=Math.min(N-1,h.row+1);w++)for(let C=Math.max(0,h.col-1);C<=Math.min(S-1,h.col+1);C++){const L=f[w][C];L&&x.push(L.id)}m.push({orb:n,affectedIds:x,bonusDamage:ee.orb_match.specialActivation,effectType:"cosmic_nova"}),x.forEach(h=>u.add(h))}return{matched:u,matchGroups:r,specialsToCreate:i,specialsActivated:m}},[He]),We=s.useCallback((e,u=[])=>{const r=Array(N).fill(null).map(()=>Array(S).fill(null));e.forEach(p=>{p.matched||(r[p.row][p.col]=p)});const i=r.map(p=>p.map(M=>M?.color??null)),m=new Map;u.forEach(p=>{const M=m.get(p.col)||[];M.push(p),m.set(p.col,M)});for(let p=0;p<S;p++){let M=N-1;for(let h=N-1;h>=0;h--)r[h][p]&&(h!==M&&(r[M][p]=r[h][p],r[h][p]=null),M--);const n=m.get(p)||[];let x=0;for(let h=M;h>=0;h--){const w=n[x],C=!!(w&&x<n.length),L=C?w.color:lt({grid:i,row:h,col:p,availableColors:ae,strategy:"refill"});r[h][p]={id:`${h}-${p}-${Date.now()}-${Math.random()}`,color:L,row:h,col:p,special:C?w.type:"normal",isNew:!0},i[h][p]=L,C&&x++}}const f=[];for(let p=0;p<N;p++)for(let M=0;M<S;M++){const n=r[p][M];n&&f.push({...n,row:p,col:M})}return f},[ae]),qe=s.useCallback(e=>{B("error"),Ue(new Set([e.orb1.id,e.orb2.id])),q(u=>u.map(r=>r.id===e.orb1.id?{...r,row:e.orb1.row,col:e.orb1.col}:r.id===e.orb2.id?{...r,row:e.orb2.row,col:e.orb2.col}:r)),T(()=>{E.current&&Ue(new Set)},200)},[T,E]),Qe=s.useCallback(async e=>{const u=++ke.current,r=()=>E.current&&ce.current==="playing"&&u===ke.current;if(!r())return 0;let i=e,m=0,f=0;const M=await io({maxSteps:ao,getStep:()=>{const n=Ve(i);return n.matched.size>=3?n:null},onStep:async(n,x)=>{if(!r())return;const{matched:h,matchGroups:w,specialsActivated:C}=x,L=lo(x.specialsToCreate);m=n,Be(n),n>1&&(Ce(!0),T(()=>{r()&&Ce(!1)},500));for(const v of C){const $e={id:`effect-${Date.now()}-${Math.random()}`,type:v.effectType,row:v.orb.row,col:v.orb.col,color:be[v.orb.color].glow};Ye(Le=>[...Le,$e]),c?.({target:"adversary",amount:v.bonusDamage,source:`special_${v.orb.special}`,isCritical:!0}),f+=v.bonusDamage*5,B("heavy")}const R=w.map(v=>{const $e=v.size*10,Le=1+(n-1)*.5,et=Math.round($e*Le);return f+=et,{id:`exp-${Date.now()}-${Math.random()}`,x:v.centerCol*I+I/2,y:v.centerRow*I+I/2,color:be[v.color].glow,size:v.size,score:et}});Pe(v=>[...v,...R]),i=i.map(v=>h.has(v.id)?{...v,matched:!0}:v),q([...i]),z.current=[...i],h.size>=5||C.length>0?B("heavy"):B("success"),await Te(C.length>0?350:200),r()&&(i=We(i,L),q([...i]),z.current=[...i],await Te(180),r())}});return r()&&(M.hitLimit&&Ce(!1),m>0&&(Re(n=>n+f),Ie(n=>{const x=n+m;return At(h=>Math.max(h,x)),x}),oe($.moveTime),K(),T(()=>{if(!r())return;!ue(z.current)&&ce.current==="playing"&&Xe()},200)),Be(0)),m},[Ve,We,$.moveTime,I,K,ue,Xe,c,Te,T,E]),pe=s.useCallback((e,u)=>{if(!Se.current)return null;const r=Se.current.getBoundingClientRect(),i=Math.floor((e-r.left)/(r.width/S)),m=Math.floor((u-r.top)/(r.height/N));return m>=0&&m<N&&i>=0&&i<S?{row:m,col:i}:null},[]),Je=s.useCallback((e,u)=>{ie.current={orb1:{id:e.id,row:e.row,col:e.col},orb2:{id:u.id,row:u.row,col:u.col}},q(r=>{const i=r.map(m=>m.id===e.id?{...m,row:u.row,col:u.col}:m.id===u.id?{...m,row:e.row,col:e.col}:m);return z.current=i,i})},[]),fe=s.useCallback((e,u)=>{if(j!=="playing"||D<=0||Ne)return;const r=pe(e,u);if(!r)return;const i=G.find(m=>m.row===r.row&&m.col===r.col);i&&(re(i),se([i.id]),W.current=!0,B("light"),ne(null))},[j,D,Ne,pe,G]),he=s.useCallback((e,u)=>{if(!W.current||!te||j!=="playing")return;const r=pe(e,u);if(!r)return;const i=G.find(p=>p.id===te.id);if(!i)return;const m=Math.abs(r.row-i.row),f=Math.abs(r.col-i.col);if(m===1&&f===0||m===0&&f===1){const p=G.find(M=>M.row===r.row&&M.col===r.col);p&&p.id!==te.id&&(Je(i,p),se(M=>[...M,p.id]),B("light"),re({...i,row:r.row,col:r.col}))}},[te,j,pe,G,Je]),Z=s.useCallback(async()=>{W.current&&(W.current=!1,we.length>1&&(_(V.current),V.current=null,await Qe(z.current)===0&&ie.current&&qe(ie.current),ie.current=null),re(null),se([]),K())},[we,Qe,qe,K,_]),zt=s.useCallback(e=>fe(e.clientX,e.clientY),[fe]),Xt=s.useCallback(e=>he(e.clientX,e.clientY),[he]),Ke=s.useCallback(()=>Z(),[Z]),Ft=s.useCallback(e=>{e.preventDefault(),fe(e.touches[0].clientX,e.touches[0].clientY)},[fe]),Ht=s.useCallback(e=>{e.preventDefault(),he(e.touches[0].clientX,e.touches[0].clientY)},[he]),Vt=s.useCallback(e=>{e.preventDefault(),Z()},[Z]);s.useEffect(()=>{if(j==="playing"){if(D<=0&&!W.current){oe($.moveTime);return}if(!(D<=0))return V.current=F(()=>{oe(e=>e<=.15?(W.current&&Z(),0):e-.15)},150),()=>{_(V.current),V.current=null}}},[j,D,Z,$.moveTime,F,_]),s.useEffect(()=>{if(j!=="playing")return;const e=F(()=>{ye(u=>u<=1?(H("complete"),0):u-1)},1e3);return()=>_(e)},[j,F,_]),s.useEffect(()=>(j==="playing"&&K(),()=>{_(J.current),J.current=null}),[j,K,_]),s.useEffect(()=>{j!=="playing"&&(_(V.current),V.current=null,_(J.current),J.current=null)},[j,_]),s.useEffect(()=>{if(j==="playing"&&A>=$.targetScore){const e=Q*5,u=A+e;if($t(A),Lt(e),St(r=>r+u),Tt(r=>r+1),y){H("complete");return}c?.({target:"adversary",amount:ee.orb_match.scoreTarget,source:"level_complete"}),B("heavy"),H("levelComplete")}},[A,$.targetScore,j,Q,c,y]);const Wt=s.useCallback(()=>{const e=U+1;kt(e),Re(0),Ie(0),Ae(!0),T(()=>{E.current&&Ae(!1)},1e3);const u=rt(e,de),i=["fire","water","earth","light","dark","cosmic"].slice(0,u.colors);ye(b??u.timeLimit),me(i),oe(u.moveTime),H("playing")},[U,de,me,b,T,E]);s.useEffect(()=>{if(j==="complete"){const e=ve+A,u=Y>=1;Y>=3&&(Pt(!0),B("heavy"));const r=Math.min(Me*2,15),i=Y*5,m=Math.round(u?Math.min(100,50+i+r):Math.min(50,A/$.targetScore*50)),f=Y>=5?"perfect":u?"good":"fail";T(()=>{O({success:u,accuracy:m,result:f,highScoreValue:e,gameStats:{score:e,level:U,levelsCompleted:Y,maxCombo:Me,time:Q,timeBonus:je}})},Y>=3?1200:400)}},[j,A,ve,Y,U,$.targetScore,Me,Q,je,T,O]);const qt=s.useCallback(e=>Pe(u=>u.filter(r=>r.id!==e)),[]),ge=s.useCallback(e=>Ye(u=>u.filter(r=>r.id!==e)),[]),Ze=A/$.targetScore,Qt=Q<=5&&j==="playing";return a.jsxs("div",{className:"flex flex-col items-center relative flex-1 min-h-0",children:[j==="countdown"&&a.jsx(Jt,{count:3,onComplete:Yt}),a.jsx(xe,{children:j==="paused"&&a.jsx(Kt,{onResume:()=>H("playing")})}),a.jsx(xe,{children:j==="levelComplete"&&a.jsx(bt,{level:U,levelScore:Et,timeBonus:je,totalScore:ve,onContinue:Wt})}),a.jsx(Zt,{title:`Starburst - Level ${U}`,subtitle:`Target: ${$.targetScore} pts`,timeLeft:Q,totalTime:Ee,combo:Rt,showCombo:!0,primaryStat:{value:A,label:`${A}/${$.targetScore}`,color:A>=$.targetScore?"#22c55e":"#a855f7"},secondaryStat:{value:Y,label:`${Y} cleared`,color:"#22d3ee"},isPaused:j==="paused",onPauseToggle:()=>H(j==="paused"?"playing":"paused"),compact:k}),a.jsxs("div",{className:"relative w-full max-w-xs mb-2",children:[a.jsx(wt,{level:U,progress:Ze}),a.jsx("div",{className:"absolute right-0 top-0",children:a.jsx(ft,{progress:Ze,isComplete:A>=$.targetScore})}),j==="playing"&&a.jsxs("div",{className:"pt-8",children:[a.jsx("div",{className:"h-2 bg-muted rounded-full overflow-hidden",children:a.jsx("div",{className:`h-full transition-all duration-150 ${D<2?"animate-pulse":""}`,style:{width:`${D/$.moveTime*100}%`,background:D<2?"linear-gradient(90deg, #ef4444, #f87171)":"linear-gradient(90deg, hsl(var(--primary)), hsl(var(--accent)))"}})}),a.jsxs("p",{className:"text-xs text-center text-muted-foreground mt-1",children:["Move: ",D.toFixed(1),"s"]})]})]}),!k&&a.jsx("button",{className:"text-xs text-muted-foreground mb-2 underline",onClick:()=>Dt(!le),children:le?"Show Emojis":"Show Shapes"}),a.jsxs("div",{ref:Se,className:"relative w-full max-w-xs rounded-2xl overflow-hidden cursor-pointer touch-none game-container",style:{aspectRatio:`${S}/${N}`,maxWidth:300},onMouseDown:zt,onMouseMove:Xt,onMouseUp:Ke,onMouseLeave:Ke,onTouchStart:Ft,onTouchMove:Ht,onTouchEnd:Vt,children:[a.jsx(dt,{}),a.jsx("div",{className:"absolute inset-0 pointer-events-none grid-lines"}),Ge&&a.jsx(pt,{orbs:Ge,cellSize:I}),G.map(e=>a.jsx(Nt,{orb:e,cellSize:I,isSelected:te?.id===e.id,isInPath:we.includes(e.id),isReverting:Gt.has(e.id),showAccessibility:le},e.id)),Ot.map(e=>a.jsx(ut,{explosion:e,onComplete:()=>qt(e.id)},e.id)),a.jsx(xe,{children:Ut.map(e=>{switch(e.type){case"beam_horizontal":case"beam_vertical":return a.jsx(vt,{effect:e,cellSize:I,onComplete:()=>ge(e.id)},e.id);case"cross_beam":return a.jsx(jt,{effect:e,cellSize:I,onComplete:()=>ge(e.id)},e.id);case"color_burst":return a.jsx(Mt,{effect:e,cellSize:I,onComplete:()=>ge(e.id)},e.id);case"cosmic_nova":return a.jsx(Ct,{effect:e,cellSize:I,onComplete:()=>ge(e.id)},e.id);default:return null}})}),It&&Oe>1&&a.jsx(mt,{multiplier:Oe}),Qt&&a.jsx(ht,{}),Ne&&a.jsx(xt,{}),Bt&&a.jsx(gt,{}),a.jsx(xe,{children:_t&&a.jsx(yt,{})})]}),!k&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"flex flex-wrap justify-center gap-3 mt-4 text-xs",children:ae.slice(0,4).map(e=>a.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full bg-white/5 border border-white/10",children:[a.jsx("span",{className:"text-sm",children:le?ct[e]:be[e].emoji}),a.jsx("span",{className:"capitalize text-white/60 font-medium",children:e})]},e))}),a.jsx("p",{className:"text-xs text-white/40 mt-3 text-center font-medium",children:"Match 4+ for specials â€¢ T/L shapes = â˜… Star â€¢ Match specials for big damage!"})]}),a.jsx("style",{children:`
        .orb-base {
          transition: transform 120ms ease-out, box-shadow 100ms ease-out;
          will-change: transform;
        }
        .orb-matched {
          animation: orb-pop 180ms ease-out forwards;
        }
        .orb-new {
          animation: orb-drop 200ms ease-out;
        }
        .orb-revert {
          animation: orb-shake 150ms ease-out;
        }
        @keyframes orb-pop {
          0% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.2); opacity: 0.8; }
          100% { transform: scale(0); opacity: 0; }
        }
        @keyframes orb-drop {
          0% { transform: translateY(var(--start-y, -80px)) scale(0.8); opacity: 0; }
          100% { opacity: 1; }
        }
        @keyframes orb-shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-4px); }
          75% { transform: translateX(4px); }
        }
        .selection-ring {
          border: 2px solid;
          animation: ring-pulse 400ms ease-in-out infinite;
        }
        @keyframes ring-pulse {
          0%, 100% { opacity: 0.6; }
          50% { opacity: 1; }
        }
        .hint-pulse {
          border: 3px solid rgba(255, 215, 0, 0.8);
          box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
          animation: hint-glow 800ms ease-in-out infinite;
        }
        @keyframes hint-glow {
          0%, 100% { transform: scale(1); opacity: 0.6; }
          50% { transform: scale(1.08); opacity: 1; }
        }
        .explosion-effect {
          transform: translate(-50%, -50%);
        }
        .explosion-ring {
          position: absolute;
          width: 50px; height: 50px;
          left: -25px; top: -25px;
          border: 3px solid;
          border-radius: 50%;
          animation: ring-expand 350ms ease-out forwards;
        }
        @keyframes ring-expand {
          0% { transform: scale(0); opacity: 1; }
          100% { transform: scale(2); opacity: 0; }
        }
        .explosion-score {
          position: absolute;
          font-size: 16px; font-weight: 800;
          text-shadow: 0 0 8px currentColor, 0 2px 4px rgba(0,0,0,0.5);
          animation: score-float 400ms ease-out forwards;
        }
        @keyframes score-float {
          0% { transform: translateY(0); opacity: 1; }
          100% { transform: translateY(-40px); opacity: 0; }
        }
        .cascade-popup {
          animation: cascade-pop 500ms ease-out forwards;
        }
        @keyframes cascade-pop {
          0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
          30% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        .urgency-pulse {
          box-shadow: inset 0 0 40px rgba(239, 68, 68, 0.4);
          border: 2px solid rgba(239, 68, 68, 0.5);
          animation: urgency 400ms ease-in-out infinite;
        }
        @keyframes urgency {
          0%, 100% { box-shadow: inset 0 0 40px rgba(239, 68, 68, 0.3); }
          50% { box-shadow: inset 0 0 60px rgba(239, 68, 68, 0.5); }
        }
        .perfect-banner {
          animation: banner-pop 300ms ease-out;
        }
        @keyframes banner-pop {
          0% { transform: scale(0) rotate(-10deg); opacity: 0; }
          100% { transform: scale(1) rotate(0); opacity: 1; }
        }
        .game-container {
          background: linear-gradient(145deg, rgba(0,0,0,0.85) 0%, rgba(15,15,35,0.95) 50%, rgba(25,15,45,0.9) 100%);
          border: 1px solid rgba(255,255,255,0.08);
          box-shadow: 0 20px 40px -12px rgba(0,0,0,0.6);
        }
        .grid-lines {
          background-image: 
            linear-gradient(to right, rgba(255,255,255,0.04) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(255,255,255,0.04) 1px, transparent 1px);
          background-size: calc(100% / 6) calc(100% / 5);
        }
        .stars-layer {
          position: absolute; inset: 0;
          background-image: radial-gradient(1px 1px at 10% 20%, white, transparent),
            radial-gradient(1px 1px at 30% 60%, white, transparent),
            radial-gradient(1px 1px at 50% 30%, white, transparent),
            radial-gradient(1px 1px at 70% 80%, white, transparent),
            radial-gradient(1px 1px at 90% 40%, white, transparent);
        }
        .drop-shadow-glow { text-shadow: 0 0 20px rgba(250,204,21,0.8); }
        .shadow-glow-yellow { box-shadow: 0 0 40px rgba(250,204,21,0.4); }
        .shadow-glow-purple { box-shadow: 0 0 40px rgba(168,85,247,0.4); }
        
        /* Special orb animations */
        @keyframes special-pulse {
          0%, 100% { box-shadow: 0 0 10px rgba(255,255,255,0.5); }
          50% { box-shadow: 0 0 25px rgba(255,255,255,0.9), 0 0 35px rgba(255,255,255,0.4); }
        }
        @keyframes special-rainbow {
          0% { border-color: gold; box-shadow: 0 0 15px gold; }
          33% { border-color: #ff6b6b; box-shadow: 0 0 15px #ff6b6b; }
          66% { border-color: #4facfe; box-shadow: 0 0 15px #4facfe; }
          100% { border-color: gold; box-shadow: 0 0 15px gold; }
        }
        @keyframes special-rotate {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        @keyframes special-nova {
          0%, 100% { box-shadow: 0 0 15px rgba(236,72,153,0.6), 0 0 30px rgba(168,85,247,0.3); }
          50% { box-shadow: 0 0 30px rgba(236,72,153,0.9), 0 0 50px rgba(168,85,247,0.6); }
        }
      `})]})};export{xo as OrbMatchGame};
