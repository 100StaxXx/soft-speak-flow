import{dq as C,H as J,u as F,q as P,ay as Q,ax as g,j as e,aj as x,b0 as y,m as S,cl as N,aQ as T,aa as Y,da as A}from"./vendor-DK8VKJIv.js";import{c as B,s as a,e as o,f as d,B as u,J as w}from"./index-vNUnYBjj.js";import"./date-vendor-BRrA_NVo.js";import"./three-vendor-qI8GXUTd.js";const K=()=>{const{code:n}=C(),l=J(),{user:i}=B(),v=F(),{data:s,isLoading:_}=P({queryKey:["epic-preview",n],queryFn:async()=>{if(!n)throw new Error("No invite code provided");const{data:t,error:c}=await a.from("epics").select(`
          *,
          epic_habits(
            habit_id,
            habits(id, title, difficulty, frequency, custom_days)
          )
        `).eq("invite_code",n).eq("is_public",!0).maybeSingle();if(c)throw c;if(!t)throw new Error("Epic not found");const{count:p}=await a.from("epic_members").select("*",{count:"exact",head:!0}).eq("epic_id",t.id);return{...t,member_count:p||0}},enabled:!!n}),h=2,m=Q({mutationFn:async()=>{if(!i||!s)throw new Error("Not authenticated or epic not found");const{data:t}=await a.from("epics").select("id").eq("user_id",i.id).eq("status","active"),{data:c}=await a.from("epic_members").select("epic_id, epics!inner(user_id, status)").eq("user_id",i.id).neq("epics.user_id",i.id).eq("epics.status","active");if((t?.length||0)+(c?.length||0)>=h)throw new Error(`You can only have ${h} active epics at a time. Complete or abandon an epic to join a new one.`);const{data:q}=await a.from("epic_members").select("id").eq("epic_id",s.id).eq("user_id",i.id).maybeSingle();if(q)throw new Error("You're already part of this epic!");const{error:b}=await a.from("epic_members").insert({epic_id:s.id,user_id:i.id});if(b)throw b;if(s.epic_habits&&s.epic_habits.length>0){const{data:k,error:f}=await a.from("habits").insert(s.epic_habits.map(r=>({user_id:i.id,title:r.habits.title,difficulty:r.habits.difficulty,frequency:r.habits.frequency||"daily",custom_days:r.habits.custom_days||null}))).select();if(f)throw f;const{error:j}=await a.from("epic_habits").insert(k.map(r=>({epic_id:s.id,habit_id:r.id})));if(j)throw j}return s},onSuccess:()=>{v.invalidateQueries({queryKey:["epics"]}),g.success("Epic Joined! ⚔️",{description:"You're now part of this legendary quest!"}),l("/epics")},onError:t=>{g.error(t.message||"Failed to join epic")}});if(!i)return e.jsx(o,{children:e.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:e.jsxs(d,{className:"max-w-md w-full p-8 text-center",children:[e.jsx(x,{className:"w-16 h-16 text-primary mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Join This Epic Quest"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Sign in to join this shared epic and embark on the journey with the community!"}),e.jsx(u,{onClick:()=>l("/auth"),className:"w-full",children:"Sign In to Join"})]})})});if(_)return e.jsx(o,{children:e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(y,{className:"w-8 h-8 animate-spin text-primary"})})});if(!s)return e.jsx(o,{children:e.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:e.jsxs(d,{className:"max-w-md w-full p-8 text-center",children:[e.jsx(x,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4 opacity-50"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Epic Not Found"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"This invite code is invalid or the epic is no longer available."}),e.jsx(u,{onClick:()=>l("/epics"),variant:"outline",children:"View Your Epics"})]})})});const E=s?.member_count||0;return e.jsx(o,{children:e.jsx("div",{className:"min-h-screen pb-nav-safe pt-safe-lg px-4",children:e.jsxs(S.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsxs(w,{className:"mb-4 px-4 py-2 text-sm",children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"Community Epic"]}),e.jsx("h1",{className:"text-4xl font-bold mb-2 bg-gradient-to-r from-primary to-purple-500 bg-clip-text text-transparent",children:"Join the Quest"}),e.jsx("p",{className:"text-muted-foreground",children:"You've been invited to join a shared epic challenge"})]}),e.jsxs(d,{className:"p-8 bg-gradient-to-br from-background to-secondary/20 border-2 border-primary/20 mb-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold mb-2",children:s.title}),s.description&&e.jsx("p",{className:"text-muted-foreground",children:s.description})]}),e.jsx(x,{className:"w-8 h-8 text-primary flex-shrink-0"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-background/50 rounded-lg p-4 text-center",children:[e.jsx(T,{className:"w-5 h-5 text-primary mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold mb-1",children:s.target_days}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Days"})]}),e.jsxs("div",{className:"bg-background/50 rounded-lg p-4 text-center",children:[e.jsx(N,{className:"w-5 h-5 text-purple-500 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold mb-1",children:E}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Members"})]}),e.jsxs("div",{className:"bg-background/50 rounded-lg p-4 text-center",children:[e.jsx(Y,{className:"w-5 h-5 text-yellow-500 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold mb-1",children:s.xp_reward}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"XP Reward"})]})]}),s.epic_habits&&s.epic_habits.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("h3",{className:"text-sm font-semibold mb-3 text-muted-foreground",children:["Habits You'll Track (",s.epic_habits.length,")"]}),e.jsx("div",{className:"space-y-2",children:s.epic_habits.map(t=>e.jsxs("div",{className:"flex items-center justify-between bg-background/50 rounded-lg p-3",children:[e.jsx("span",{className:"font-medium",children:t.habits.title}),e.jsx(w,{variant:"outline",className:"text-xs",children:t.habits.difficulty})]},t.habit_id))})]}),e.jsx(u,{onClick:()=>m.mutate(),disabled:m.isPending,className:"w-full h-14 text-lg bg-gradient-to-r from-primary to-purple-600 hover:from-primary/90 hover:to-purple-600/90",children:m.isPending?e.jsxs(e.Fragment,{children:[e.jsx(y,{className:"w-5 h-5 mr-2 animate-spin"}),"Joining..."]}):e.jsxs(e.Fragment,{children:["Join This Epic",e.jsx(A,{className:"w-5 h-5 ml-2"})]})})]}),e.jsx(d,{className:"p-4 bg-primary/5 border-primary/20",children:e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"By joining, you'll track the same habits as other members and compete on the leaderboard!"})})]})})})};export{K as default};
