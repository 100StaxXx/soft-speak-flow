import{r as s,j as a,l as be,m as P}from"./vendor-DK8VKJIv.js";import{bw as ee,bx as Zt,by as eo,bz as to}from"./index-vNUnYBjj.js";import{t as B}from"./gameUtils-CBfv9FnM.js";import{u as oo,a as ao,b as ro}from"./gameLifecycle-CMc-cG6H.js";import{u as so}from"./useMaxAspectRect-BoDFlwNt.js";import"./date-vendor-BRrA_NVo.js";import"./three-vendor-qI8GXUTd.js";const it=30,no=8,H=(o,t,c)=>t<0||t>=o.length||c<0||c>=(o[0]?.length??0)?null:o[t][c],io=(o,t,c,i)=>{const d=H(o,t,c-1),g=H(o,t,c-2),b=H(o,t,c+1),y=H(o,t,c+2),T=H(o,t-1,c),E=H(o,t-2,c),O=H(o,t+1,c),N=H(o,t+2,c);return d===i&&g===i||d===i&&b===i||b===i&&y===i||(T===i&&E===i||T===i&&O===i||O===i&&N===i)},lt=({grid:o,row:t,col:c,availableColors:i,strategy:d,random:g=Math.random})=>{if(i.length===0)throw new Error("pickSpawnColor requires at least one available color");const b=i.filter(E=>!io(o,t,c,E)),y=b.length>0?b:i,T=Math.floor(g()*y.length);return y[T]},ct=o=>{const t=new Set,c=o.length,i=o[0]?.length??0;for(let d=0;d<c;d++){let g=0;for(;g<i;){const b=o[d][g];if(!b){g++;continue}let y=1;for(;g+y<i&&o[d][g+y]===b;)y++;if(y>=3)for(let T=0;T<y;T++)t.add(`${d},${g+T}`);g+=Math.max(1,y)}}for(let d=0;d<i;d++){let g=0;for(;g<c;){const b=o[g][d];if(!b){g++;continue}let y=1;for(;g+y<c&&o[g+y][d]===b;)y++;if(y>=3)for(let T=0;T<y;T++)t.add(`${g+T},${d}`);g+=Math.max(1,y)}}return t.size},Re=o=>ct(o)>0,ot=o=>o.map(t=>[...t]),lo=o=>{const t=o.length,c=o[0]?.length??0;for(let i=0;i<t;i++)for(let d=0;d<c;d++){const g=o[i][d];if(g){if(d+1<c&&o[i][d+1]){const b=ot(o),y=b[i][d+1];if(b[i][d]=y,b[i][d+1]=g,Re(b))return!0}if(i+1<t&&o[i+1][d]){const b=ot(o),y=b[i+1][d];if(b[i][d]=y,b[i+1][d]=g,Re(b))return!0}}}return!1},at=(o,t,c,i)=>{const d=Array.from({length:o},()=>Array(t).fill(null));for(let g=0;g<o;g++)for(let b=0;b<t;b++)d[g][b]=lt({grid:d,row:g,col:b,availableColors:c,strategy:"initial",random:i});return d},co=({rows:o,cols:t,availableColors:c,maxAttempts:i=it,random:d=Math.random})=>{if(c.length===0)throw new Error("generateInitialColorGrid requires at least one color");let g=null,b=Number.NEGATIVE_INFINITY;for(let y=0;y<i;y++){const T=at(o,t,c,d),E=Re(T),O=lo(T);if(!E&&O)return T;const N=(O?1e3:0)-ct(T);N>b&&(b=N,g=T)}return g??at(o,t,c,d)},rt={normal:0,line_bomb:1,cross_bomb:2,star:3,cosmic_nova:0},uo=o=>{const t=new Map;for(const c of o){const i=`${c.row},${c.col}`,d=t.get(i);(!d||rt[c.type]>rt[d.type])&&t.set(i,c)}return Array.from(t.values())},mo=async({maxSteps:o,getStep:t,onStep:c})=>{let i=0,d=t();for(;d&&i<o;)i+=1,await c(i,d),d=t();return{stepsProcessed:i,hitLimit:i===o&&d!==null,pendingStep:d}},po={beginner:{targetMod:.5,timeMod:1.5},easy:{targetMod:.7,timeMod:1.3},medium:{targetMod:1,timeMod:1},hard:{targetMod:1.4,timeMod:.85},master:{targetMod:2,timeMod:.7}},st=(o,t)=>{const c=500+(o-1)*300,i=Math.max(30,60-(o-1)*2.5),d=Math.min(6,4+Math.floor(o/4)),g=Math.max(4,10-Math.floor(o/3)),b=Math.min(.3,o*.02);return{targetScore:Math.round(c*t.targetMod),timeLimit:Math.round(i*t.timeMod),colors:d,moveTime:g,specialSpawnBonus:b}},S=5,k=6,nt=o=>{for(let t=0;t<S;t++)for(let c=0;c<k-2;c++){const i=o[t][c],d=o[t][c+1],g=o[t][c+2];if(i&&d&&g&&i.color===d.color&&d.color===g.color)return!0}for(let t=0;t<k;t++)for(let c=0;c<S-2;c++){const i=o[c][t],d=o[c+1][t],g=o[c+2][t];if(i&&d&&g&&i.color===d.color&&d.color===g.color)return!0}return!1},dt={fire:"â—",water:"â—†",earth:"â– ",light:"â˜…",dark:"â–²",cosmic:"âœ¦"},we={fire:{gradient:"linear-gradient(135deg, #ff6b6b 0%, #ee5a24 50%, #ff4757 100%)",glow:"rgba(255, 107, 107, 0.6)",inner:"rgba(255, 200, 150, 0.4)",emoji:"ðŸ”¥"},water:{gradient:"linear-gradient(135deg, #4facfe 0%, #00cec9 50%, #0984e3 100%)",glow:"rgba(79, 172, 254, 0.6)",inner:"rgba(200, 240, 255, 0.4)",emoji:"ðŸ’§"},earth:{gradient:"linear-gradient(135deg, #00b894 0%, #55a630 50%, #2d6a4f 100%)",glow:"rgba(0, 184, 148, 0.6)",inner:"rgba(200, 255, 220, 0.4)",emoji:"ðŸŒ¿"},light:{gradient:"linear-gradient(135deg, #ffd93d 0%, #ff9f1c 50%, #f9a825 100%)",glow:"rgba(255, 217, 61, 0.6)",inner:"rgba(255, 255, 220, 0.5)",emoji:"âœ¨"},dark:{gradient:"linear-gradient(135deg, #a855f7 0%, #7c3aed 50%, #6366f1 100%)",glow:"rgba(168, 85, 247, 0.6)",inner:"rgba(220, 200, 255, 0.4)",emoji:"ðŸŒ™"},cosmic:{gradient:"linear-gradient(135deg, #f472b6 0%, #ec4899 50%, #e11d48 100%)",glow:"rgba(244, 114, 182, 0.6)",inner:"rgba(255, 200, 230, 0.4)",emoji:"ðŸ’«"}},ut=s.memo(({intensity:o=.7})=>a.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[a.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-purple-500/5 via-transparent to-cyan-500/5"}),a.jsx("div",{className:"stars-layer",style:{opacity:o}})]}));ut.displayName="StarBackground";const mt=s.memo(({explosion:o,onComplete:t})=>(s.useEffect(()=>{const c=setTimeout(t,400);return()=>clearTimeout(c)},[t]),a.jsxs("div",{className:"absolute pointer-events-none z-50 explosion-effect",style:{left:o.x,top:o.y,"--explosion-color":o.color},children:[a.jsx("div",{className:"explosion-ring",style:{borderColor:o.color}}),a.jsxs("div",{className:"explosion-score",style:{color:o.color},children:["+",o.score]})]})));mt.displayName="MatchExplosionEffect";const pt=s.memo(({multiplier:o})=>a.jsx("div",{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 z-50 pointer-events-none cascade-popup",children:a.jsxs("span",{className:"text-4xl font-black text-yellow-400 drop-shadow-glow",children:["x",o,"!"]})}));pt.displayName="CascadeMultiplier";const ft=s.memo(({orbs:o,cellSize:t})=>a.jsx(a.Fragment,{children:o.map((c,i)=>a.jsx("div",{className:"absolute rounded-full pointer-events-none z-40 hint-pulse",style:{width:t-12,height:t-12,left:c.col*t+6,top:c.row*t+6}},i))}));ft.displayName="HintIndicator";const ht=s.memo(({progress:o,isComplete:t})=>{const i=2*Math.PI*18,d=i*(1-Math.min(1,o));return a.jsxs("svg",{className:"absolute -right-1 -top-1",width:"44",height:"44",viewBox:"0 0 44 44",children:[a.jsx("circle",{cx:"22",cy:"22",r:18,fill:"none",stroke:"rgba(255,255,255,0.1)",strokeWidth:"3"}),a.jsx("circle",{cx:"22",cy:"22",r:18,fill:"none",stroke:t?"#22c55e":"#a855f7",strokeWidth:"3",strokeLinecap:"round",strokeDasharray:i,strokeDashoffset:d,className:"transition-all duration-200",style:{transform:"rotate(-90deg)",transformOrigin:"center"}})]})});ht.displayName="ScoreProgressRing";const gt=s.memo(()=>a.jsx("div",{className:"absolute inset-0 pointer-events-none z-30 rounded-2xl urgency-pulse"}));gt.displayName="UrgencyOverlay";const xt=s.memo(()=>a.jsx("div",{className:"absolute inset-0 flex items-center justify-center z-50 pointer-events-none perfect-banner",children:a.jsx("div",{className:"px-8 py-4 rounded-2xl bg-yellow-500/20 border-2 border-yellow-500/60 shadow-glow-yellow",children:a.jsx("span",{className:"text-2xl font-black text-yellow-400 drop-shadow-glow",children:"â­ PERFECT! +50 â­"})})}));xt.displayName="PerfectGameBanner";const bt=s.memo(()=>a.jsxs("div",{className:"absolute inset-0 flex items-center justify-center z-50 bg-black/50 rounded-2xl",children:[a.jsx("span",{className:"text-4xl animate-spin",children:"ðŸ”€"}),a.jsx("span",{className:"ml-3 text-lg font-bold text-white",children:"Shuffling..."})]}));bt.displayName="ShuffleOverlay";const wt=s.memo(({level:o,levelScore:t,timeBonus:c,totalScore:i,onContinue:d})=>(s.useEffect(()=>{const g=setTimeout(d,2500);return()=>clearTimeout(g)},[d]),a.jsx(P.div,{className:"absolute inset-0 flex flex-col items-center justify-center z-50 bg-black/70 rounded-2xl backdrop-blur-sm",initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:a.jsxs(P.div,{initial:{scale:0,rotate:-10},animate:{scale:1,rotate:0},transition:{type:"spring",damping:15},className:"text-center",children:[a.jsx("div",{className:"text-4xl mb-2",children:"ðŸŽ‰"}),a.jsxs("h2",{className:"text-2xl font-black text-yellow-400 mb-1 drop-shadow-glow",children:["LEVEL ",o," COMPLETE!"]}),a.jsxs("div",{className:"space-y-1 text-sm",children:[a.jsxs("p",{className:"text-white/80",children:["Level Score: ",a.jsxs("span",{className:"text-green-400 font-bold",children:["+",t]})]}),a.jsxs("p",{className:"text-white/80",children:["Time Bonus: ",a.jsxs("span",{className:"text-cyan-400 font-bold",children:["+",c]})]}),a.jsxs("p",{className:"text-white/60 text-xs mt-2",children:["Total: ",a.jsx("span",{className:"text-purple-400 font-bold",children:i})]})]}),a.jsx(P.div,{className:"mt-4 px-4 py-2 bg-purple-500/30 rounded-full border border-purple-400/50",initial:{opacity:0},animate:{opacity:1},transition:{delay:1},children:a.jsx("span",{className:"text-sm text-purple-200",children:"Next level starting..."})})]})})));wt.displayName="LevelCompleteOverlay";const yt=s.memo(({level:o,progress:t})=>a.jsx("div",{className:"absolute left-1 top-1 z-40",children:a.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 bg-black/60 rounded-full border border-purple-500/40 backdrop-blur-sm",children:[a.jsx("span",{className:"text-[10px] font-bold text-purple-400",children:"LVL"}),a.jsx("span",{className:"text-base font-black text-white",children:o}),a.jsx("div",{className:"w-10 h-1 bg-white/10 rounded-full overflow-hidden",children:a.jsx("div",{className:"h-full bg-gradient-to-r from-purple-500 to-pink-500 transition-all duration-200",style:{width:`${Math.min(100,t*100)}%`}})})]})}));yt.displayName="LevelIndicator";const vt=s.memo(()=>a.jsx(P.div,{className:"absolute inset-0 flex items-center justify-center z-50 pointer-events-none",initial:{opacity:0,scale:.5},animate:{opacity:[0,1,1,0],scale:[.5,1.2,1,1]},transition:{duration:1,times:[0,.3,.7,1]},children:a.jsx("div",{className:"px-8 py-4 rounded-2xl bg-gradient-to-r from-purple-500/40 to-pink-500/40 border-2 border-purple-400/60 shadow-glow-purple",children:a.jsx("span",{className:"text-3xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-pink-400",children:"â¬†ï¸ LEVEL UP! â¬†ï¸"})})}));vt.displayName="LevelUpBanner";const Mt=s.memo(({effect:o,cellSize:t,onComplete:c})=>{s.useEffect(()=>{const d=setTimeout(c,400);return()=>clearTimeout(d)},[c]);const i=o.type==="beam_horizontal";return a.jsx(P.div,{className:"absolute z-50 pointer-events-none",initial:{opacity:0,scaleX:i?0:1,scaleY:i?1:0},animate:{opacity:1,scaleX:1,scaleY:1},exit:{opacity:0},style:{background:"linear-gradient(90deg, transparent, rgba(255,255,255,0.9), transparent)",height:i?6:t*S,width:i?t*k:6,top:i?o.row*t+t/2-3:0,left:i?0:o.col*t+t/2-3,boxShadow:"0 0 20px rgba(255,255,255,0.8), 0 0 40px rgba(168,85,247,0.6)"}})});Mt.displayName="BeamEffect";const jt=s.memo(({effect:o,cellSize:t,onComplete:c})=>(s.useEffect(()=>{const i=setTimeout(c,500);return()=>clearTimeout(i)},[c]),a.jsxs(a.Fragment,{children:[a.jsx(P.div,{className:"absolute z-50 pointer-events-none",initial:{opacity:0,scaleX:0},animate:{opacity:1,scaleX:1},exit:{opacity:0},style:{background:"linear-gradient(90deg, transparent, rgba(255,215,0,0.9), transparent)",height:6,width:t*k,top:o.row*t+t/2-3,left:0,boxShadow:"0 0 20px rgba(255,215,0,0.8)"}}),a.jsx(P.div,{className:"absolute z-50 pointer-events-none",initial:{opacity:0,scaleY:0},animate:{opacity:1,scaleY:1},exit:{opacity:0},style:{background:"linear-gradient(180deg, transparent, rgba(255,215,0,0.9), transparent)",height:t*S,width:6,top:0,left:o.col*t+t/2-3,boxShadow:"0 0 20px rgba(255,215,0,0.8)"}})]})));jt.displayName="CrossBeamEffect";const Ct=s.memo(({effect:o,cellSize:t,onComplete:c})=>(s.useEffect(()=>{const i=setTimeout(c,600);return()=>clearTimeout(i)},[c]),a.jsx(P.div,{className:"absolute z-50 pointer-events-none",initial:{scale:0,opacity:1},animate:{scale:4,opacity:0},transition:{duration:.6},style:{width:t,height:t,left:o.col*t,top:o.row*t,background:`radial-gradient(circle, ${o.color||"rgba(255,215,0,0.8)"}, transparent)`,borderRadius:"50%"}})));Ct.displayName="ColorBurstEffect";const Nt=s.memo(({effect:o,cellSize:t,onComplete:c})=>(s.useEffect(()=>{const i=setTimeout(c,700);return()=>clearTimeout(i)},[c]),a.jsxs(a.Fragment,{children:[a.jsx(P.div,{className:"absolute rounded-full z-50 pointer-events-none",initial:{scale:0,opacity:1},animate:{scale:5,opacity:0},transition:{duration:.7},style:{width:t*3,height:t*3,left:o.col*t-t,top:o.row*t-t,background:"radial-gradient(circle, rgba(255,255,255,0.9), rgba(168,85,247,0.6), rgba(236,72,153,0.4), transparent)"}}),[...Array(8)].map((i,d)=>a.jsx(P.div,{className:"absolute z-50 pointer-events-none",initial:{scale:0,opacity:1,x:0,y:0},animate:{scale:[0,1,.5],opacity:[1,.8,0],x:Math.cos(d*Math.PI/4)*t*2,y:Math.sin(d*Math.PI/4)*t*2},transition:{duration:.5},style:{width:12,height:12,borderRadius:"50%",background:"white",left:o.col*t+t/2-6,top:o.row*t+t/2-6,boxShadow:"0 0 10px rgba(255,255,255,0.8)"}},d))]})));Nt.displayName="CosmicNovaEffect";const St=s.memo(({orb:o,cellSize:t,isSelected:c,isInPath:i,isReverting:d,showAccessibility:g})=>{const b=we[o.color],y=t-8,E=(()=>{switch(o.special){case"line_bomb":return{border:"3px dashed rgba(255,255,255,0.9)",animation:"special-pulse 1s infinite",icon:"âž–"};case"star":return{border:"3px solid gold",animation:"special-rainbow 1.5s infinite",icon:"â˜…"};case"cross_bomb":return{border:"3px double rgba(255,215,0,0.9)",animation:"special-rotate 2s linear infinite",icon:"âœš"};case"cosmic_nova":return{border:"4px solid magenta",animation:"special-nova 0.8s infinite",icon:"âœ¦"};default:return{border:"2px solid rgba(255,255,255,0.25)",animation:void 0,icon:null}}})(),O=Math.max(14,Math.min(36,t*.4)),N=Math.max(12,Math.min(18,t*.2)),X=o.col*t+(t-y)/2,_=o.row*t+(t-y)/2,v=o.matched?0:c?1.15:i?1.08:1;return a.jsxs("div",{className:`absolute rounded-full flex items-center justify-center orb-base ${c?"z-30":i?"z-20":"z-10"} ${o.matched?"orb-matched":""} ${o.isNew?"orb-new":""} ${d?"orb-revert":""}`,style:{width:y,height:y,background:b.gradient,border:E.border,transform:`translate(${X}px, ${_}px) scale(${v})`,boxShadow:c||i?`0 8px 20px rgba(0,0,0,0.4), 0 0 15px ${b.glow}`:o.special!=="normal"?`0 4px 15px rgba(0,0,0,0.4), 0 0 20px ${b.glow}, 0 0 30px ${o.special==="cosmic_nova"?"rgba(236,72,153,0.5)":"rgba(255,215,0,0.3)"}`:`0 4px 10px rgba(0,0,0,0.3), 0 0 10px ${b.glow}`,animation:E.animation,"--start-y":`${-t*2}px`},children:[a.jsx("div",{className:"absolute rounded-full pointer-events-none",style:{width:"60%",height:"60%",top:"10%",left:"20%",background:`radial-gradient(circle at 30% 30%, ${b.inner}, transparent 70%)`}}),a.jsx("span",{className:"select-none relative z-10 drop-shadow-sm",style:{fontSize:O},children:g?dt[o.color]:b.emoji}),E.icon&&a.jsx("span",{className:"absolute -top-1 -right-1 bg-black/60 rounded-full flex items-center justify-center z-20",style:{width:N,height:N,fontSize:Math.max(9,Math.min(12,N*.7))},children:E.icon}),(c||i)&&a.jsx("div",{className:"absolute inset-[-3px] rounded-full pointer-events-none selection-ring",style:{borderColor:b.glow,boxShadow:`0 0 10px ${b.glow}`}})]})});St.displayName="OrbComponent";const vo=({companionStats:o,onComplete:t,onDamage:c,tierAttackDamage:i,difficulty:d="medium",questIntervalScale:g=0,maxTimer:b,isPractice:y=!1,compact:T=!1})=>{const E=oo(),{completeOnce:O}=ao(t),{registerTimeout:N,registerInterval:X,clearTimer:_}=ro(),[v,F]=s.useState("countdown"),[G,q]=s.useState([]),[te,se]=s.useState(null),[ye,ne]=s.useState([]),[Q,ve]=s.useState(0),[D,oe]=s.useState(0),[A,Ae]=s.useState(0),[Me,kt]=s.useState(0),[z,Tt]=s.useState(1),[U,Et]=s.useState(0),[$t,Lt]=s.useState(0),[je,_t]=s.useState(0),[Rt,Ie]=s.useState(!1),[At,Oe]=s.useState(0),[Ce,It]=s.useState(0),[Be,Pe]=s.useState(0),[Ot,Ne]=s.useState(!1),[Bt,Ge]=s.useState([]),[De,ie]=s.useState(null),[Se,ze]=s.useState(!1),[Pt,Gt]=s.useState(!1),[Dt,Ue]=s.useState(new Set),[le,zt]=s.useState(!1),[Ut,Ye]=s.useState([]),ke=s.useRef(null),V=s.useRef(null),J=s.useRef(null),W=s.useRef(!1),Y=s.useRef(G),ce=s.useRef(null),de=s.useRef(v),Te=s.useRef(0);s.useEffect(()=>{Y.current=G},[G]),s.useEffect(()=>{de.current=v,v!=="playing"&&(Te.current+=1)},[v]);const Ee=s.useCallback(e=>new Promise(u=>{N(u,e)}),[N]),He=o.soul/100,ue=po[d],$=s.useMemo(()=>{const e=st(z,ue);return{...e,moveTime:Math.max(3,e.moveTime-g*.5+He*1.5)}},[z,ue,g,He]),$e=b??$.timeLimit,ae=s.useMemo(()=>["fire","water","earth","light","dark","cosmic"].slice(0,$.colors),[$.colors]),{hostRef:Yt,rect:re}=so(k,S),I=s.useMemo(()=>re.width/k,[re.width]),me=s.useCallback(e=>{const u=Array(S).fill(null).map(()=>Array(k).fill(null));e.forEach(r=>{u[r.row][r.col]=r});for(let r=0;r<S;r++)for(let l=0;l<k;l++){const m=u[r][l];if(m){if(l<k-1&&u[r][l+1]){const f=u.map(p=>[...p]);if(f[r][l]=u[r][l+1],f[r][l+1]=m,nt(f))return[{row:r,col:l},{row:r,col:l+1}]}if(r<S-1&&u[r+1][l]){const f=u.map(p=>[...p]);if(f[r][l]=u[r+1][l],f[r+1][l]=m,nt(f))return[{row:r,col:l},{row:r+1,col:l}]}}}return null},[]),Xe=s.useCallback(()=>{ze(!0),B("medium"),c?.({target:"player",amount:i||15,source:"no_moves"}),N(()=>{E.current&&(q(e=>{const u=e.map(r=>r.color);for(let r=u.length-1;r>0;r--){const l=Math.floor(Math.random()*(r+1));[u[r],u[l]]=[u[l],u[r]]}return e.map((r,l)=>({...r,color:u[l]}))}),ze(!1))},600)},[c,i,N,E]),pe=s.useCallback(e=>{const r=co({rows:S,cols:k,availableColors:e||ae,maxAttempts:it}),l=[];for(let m=0;m<S;m++)for(let f=0;f<k;f++)l.push({id:`${m}-${f}`,color:r[m][f],row:m,col:f,special:"normal"});q(l),Y.current=l},[ae]),Fe=s.useCallback(()=>{pe(),oe($.moveTime),se(null),ne([]),ie(null),W.current=!1},[pe,$.moveTime]),Ht=s.useCallback(()=>{F("playing"),ve($e),Fe()},[$e,Fe]),K=s.useCallback(()=>{ie(null),_(J.current),J.current=N(()=>{if(!E.current||de.current!=="playing")return;const e=me(Y.current);e&&(ie(e),B("light"))},4e3)},[me,_,N,E]),Ve=s.useCallback((e,u,r)=>{switch(e.special){case"line_bomb":{const l=e.col%2===0,m=[];if(l)for(let f=0;f<k;f++){const p=u[e.row][f];p&&m.push(p.id)}else for(let f=0;f<S;f++){const p=u[f][e.col];p&&m.push(p.id)}return{affectedIds:m,bonusDamage:ee.orb_match.specialActivation,effectType:l?"beam_horizontal":"beam_vertical"}}case"cross_bomb":{const l=[];for(let m=0;m<k;m++){const f=u[e.row][m];f&&l.push(f.id)}for(let m=0;m<S;m++){const f=u[m][e.col];f&&!l.includes(f.id)&&l.push(f.id)}return{affectedIds:l,bonusDamage:ee.orb_match.specialActivation,effectType:"cross_beam"}}case"star":return{affectedIds:r.filter(m=>m.color===e.color).map(m=>m.id),bonusDamage:ee.orb_match.specialActivation,effectType:"color_burst"};case"cosmic_nova":{const l=[];for(let m=Math.max(0,e.row-1);m<=Math.min(S-1,e.row+1);m++)for(let f=Math.max(0,e.col-1);f<=Math.min(k-1,e.col+1);f++){const p=u[m][f];p&&l.push(p.id)}return{affectedIds:l,bonusDamage:ee.orb_match.specialActivation,effectType:"cosmic_nova"}}default:return null}},[]),We=s.useCallback(e=>{const u=new Set,r=[],l=[],m=[],f=Array(S).fill(null).map(()=>Array(k).fill(null));e.forEach(n=>{f[n.row][n.col]=n});const p=new Map;for(let n=0;n<S;n++){let x=0;for(;x<k;){const h=f[n][x];if(!h){x++;continue}let w=1;for(;x+w<k&&f[n][x+w]?.color===h.color;)w++;if(w>=3){const C=[];for(let R=0;R<w;R++){const M=f[n][x+R];M&&(u.add(M.id),C.push(M.id),p.set(`${n}-${x+R}`,{row:n,col:x+R,color:h.color}))}const L=x+Math.floor(w/2);r.push({ids:C,size:w,color:h.color,centerRow:n,centerCol:L,isHorizontal:!0}),w===4?l.push({row:n,col:L,type:"line_bomb",color:h.color}):w>=5&&l.push({row:n,col:L,type:"cross_bomb",color:h.color})}x+=Math.max(1,w)}}for(let n=0;n<k;n++){let x=0;for(;x<S;){const h=f[x][n];if(!h){x++;continue}let w=1;for(;x+w<S&&f[x+w][n]?.color===h.color;)w++;if(w>=3){const C=[];for(let R=0;R<w;R++){const M=f[x+R][n];M&&!u.has(M.id)&&C.push(M.id),M&&(u.add(M.id),p.set(`${x+R}-${n}`,{row:x+R,col:n,color:h.color}))}const L=x+Math.floor(w/2);C.length>0&&r.push({ids:C,size:w,color:h.color,centerRow:L,centerCol:n,isHorizontal:!1}),w===4?l.push({row:L,col:n,type:"line_bomb",color:h.color}):w>=5&&l.push({row:L,col:n,type:"cross_bomb",color:h.color})}x+=Math.max(1,w)}}for(const[,n]of p){const x=p.has(`${n.row}-${n.col-1}`)&&p.get(`${n.row}-${n.col-1}`)?.color===n.color||p.has(`${n.row}-${n.col+1}`)&&p.get(`${n.row}-${n.col+1}`)?.color===n.color,h=p.has(`${n.row-1}-${n.col}`)&&p.get(`${n.row-1}-${n.col}`)?.color===n.color||p.has(`${n.row+1}-${n.col}`)&&p.get(`${n.row+1}-${n.col}`)?.color===n.color;if(x&&h&&!l.find(C=>C.row===n.row&&C.col===n.col&&C.type==="star")){const C=l.findIndex(L=>L.row===n.row&&L.col===n.col);C>=0?l[C]={row:n.row,col:n.col,type:"star",color:n.color}:l.push({row:n.row,col:n.col,type:"star",color:n.color})}}for(const n of u){const x=e.find(h=>h.id===n);if(x&&x.special&&x.special!=="normal"){const h=Ve(x,f,e);h&&(m.push({orb:x,...h}),h.affectedIds.forEach(w=>u.add(w)))}}const j=Array.from(u).map(n=>e.find(x=>x.id===n)).filter(n=>n&&n.special&&n.special!=="normal");if(j.length>=2){const n=j[0],x=[];for(const h of j)for(let w=Math.max(0,h.row-1);w<=Math.min(S-1,h.row+1);w++)for(let C=Math.max(0,h.col-1);C<=Math.min(k-1,h.col+1);C++){const L=f[w][C];L&&x.push(L.id)}m.push({orb:n,affectedIds:x,bonusDamage:ee.orb_match.specialActivation,effectType:"cosmic_nova"}),x.forEach(h=>u.add(h))}return{matched:u,matchGroups:r,specialsToCreate:l,specialsActivated:m}},[Ve]),qe=s.useCallback((e,u=[])=>{const r=Array(S).fill(null).map(()=>Array(k).fill(null));e.forEach(p=>{p.matched||(r[p.row][p.col]=p)});const l=r.map(p=>p.map(j=>j?.color??null)),m=new Map;u.forEach(p=>{const j=m.get(p.col)||[];j.push(p),m.set(p.col,j)});for(let p=0;p<k;p++){let j=S-1;for(let h=S-1;h>=0;h--)r[h][p]&&(h!==j&&(r[j][p]=r[h][p],r[h][p]=null),j--);const n=m.get(p)||[];let x=0;for(let h=j;h>=0;h--){const w=n[x],C=!!(w&&x<n.length),L=C?w.color:lt({grid:l,row:h,col:p,availableColors:ae,strategy:"refill"});r[h][p]={id:`${h}-${p}-${Date.now()}-${Math.random()}`,color:L,row:h,col:p,special:C?w.type:"normal",isNew:!0},l[h][p]=L,C&&x++}}const f=[];for(let p=0;p<S;p++)for(let j=0;j<k;j++){const n=r[p][j];n&&f.push({...n,row:p,col:j})}return f},[ae]),Qe=s.useCallback(e=>{B("error"),Ue(new Set([e.orb1.id,e.orb2.id])),q(u=>u.map(r=>r.id===e.orb1.id?{...r,row:e.orb1.row,col:e.orb1.col}:r.id===e.orb2.id?{...r,row:e.orb2.row,col:e.orb2.col}:r)),N(()=>{E.current&&Ue(new Set)},200)},[N,E]),Je=s.useCallback(async e=>{const u=++Te.current,r=()=>E.current&&de.current==="playing"&&u===Te.current;if(!r())return 0;let l=e,m=0,f=0;const j=await mo({maxSteps:no,getStep:()=>{const n=We(l);return n.matched.size>=3?n:null},onStep:async(n,x)=>{if(!r())return;const{matched:h,matchGroups:w,specialsActivated:C}=x,L=uo(x.specialsToCreate);m=n,Pe(n),n>1&&(Ne(!0),N(()=>{r()&&Ne(!1)},500));for(const M of C){const Le={id:`effect-${Date.now()}-${Math.random()}`,type:M.effectType,row:M.orb.row,col:M.orb.col,color:we[M.orb.color].glow};Ye(_e=>[..._e,Le]),c?.({target:"adversary",amount:M.bonusDamage,source:`special_${M.orb.special}`,isCritical:!0}),f+=M.bonusDamage*5,B("heavy")}const R=w.map(M=>{const Le=M.size*10,_e=1+(n-1)*.5,tt=Math.round(Le*_e);return f+=tt,{id:`exp-${Date.now()}-${Math.random()}`,x:M.centerCol*I+I/2,y:M.centerRow*I+I/2,color:we[M.color].glow,size:M.size,score:tt}});Ge(M=>[...M,...R]),l=l.map(M=>h.has(M.id)?{...M,matched:!0}:M),q([...l]),Y.current=[...l],h.size>=5||C.length>0?B("heavy"):B("success"),await Ee(C.length>0?350:200),r()&&(l=qe(l,L),q([...l]),Y.current=[...l],await Ee(180),r())}});return r()&&(j.hitLimit&&Ne(!1),m>0&&(Ae(n=>n+f),Oe(n=>{const x=n+m;return It(h=>Math.max(h,x)),x}),oe($.moveTime),K(),N(()=>{if(!r())return;!me(Y.current)&&de.current==="playing"&&Xe()},200)),Pe(0)),m},[We,qe,$.moveTime,I,K,me,Xe,c,Ee,N,E]),fe=s.useCallback((e,u)=>{if(!ke.current)return null;const r=ke.current.getBoundingClientRect(),l=Math.floor((e-r.left)/(r.width/k)),m=Math.floor((u-r.top)/(r.height/S));return m>=0&&m<S&&l>=0&&l<k?{row:m,col:l}:null},[]),Ke=s.useCallback((e,u)=>{ce.current={orb1:{id:e.id,row:e.row,col:e.col},orb2:{id:u.id,row:u.row,col:u.col}},q(r=>{const l=r.map(m=>m.id===e.id?{...m,row:u.row,col:u.col}:m.id===u.id?{...m,row:e.row,col:e.col}:m);return Y.current=l,l})},[]),he=s.useCallback((e,u)=>{if(v!=="playing"||D<=0||Se)return;const r=fe(e,u);if(!r)return;const l=G.find(m=>m.row===r.row&&m.col===r.col);l&&(se(l),ne([l.id]),W.current=!0,B("light"),ie(null))},[v,D,Se,fe,G]),ge=s.useCallback((e,u)=>{if(!W.current||!te||v!=="playing")return;const r=fe(e,u);if(!r)return;const l=G.find(p=>p.id===te.id);if(!l)return;const m=Math.abs(r.row-l.row),f=Math.abs(r.col-l.col);if(m===1&&f===0||m===0&&f===1){const p=G.find(j=>j.row===r.row&&j.col===r.col);p&&p.id!==te.id&&(Ke(l,p),ne(j=>[...j,p.id]),B("light"),se({...l,row:r.row,col:r.col}))}},[te,v,fe,G,Ke]),Z=s.useCallback(async()=>{W.current&&(W.current=!1,ye.length>1&&(_(V.current),V.current=null,await Je(Y.current)===0&&ce.current&&Qe(ce.current),ce.current=null),se(null),ne([]),K())},[ye,Je,Qe,K,_]),Xt=s.useCallback(e=>he(e.clientX,e.clientY),[he]),Ft=s.useCallback(e=>ge(e.clientX,e.clientY),[ge]),Ze=s.useCallback(()=>Z(),[Z]),Vt=s.useCallback(e=>{e.preventDefault(),he(e.touches[0].clientX,e.touches[0].clientY)},[he]),Wt=s.useCallback(e=>{e.preventDefault(),ge(e.touches[0].clientX,e.touches[0].clientY)},[ge]),qt=s.useCallback(e=>{e.preventDefault(),Z()},[Z]);s.useEffect(()=>{if(v==="playing"){if(D<=0&&!W.current){oe($.moveTime);return}if(!(D<=0))return V.current=X(()=>{oe(e=>e<=.15?(W.current&&Z(),0):e-.15)},150),()=>{_(V.current),V.current=null}}},[v,D,Z,$.moveTime,X,_]),s.useEffect(()=>{if(v!=="playing")return;const e=X(()=>{ve(u=>u<=1?(F("complete"),0):u-1)},1e3);return()=>_(e)},[v,X,_]),s.useEffect(()=>(v==="playing"&&K(),()=>{_(J.current),J.current=null}),[v,K,_]),s.useEffect(()=>{v!=="playing"&&(_(V.current),V.current=null,_(J.current),J.current=null)},[v,_]),s.useEffect(()=>{if(v==="playing"&&A>=$.targetScore){const e=Q*5,u=A+e;if(Lt(A),_t(e),kt(r=>r+u),Et(r=>r+1),y){F("complete");return}c?.({target:"adversary",amount:ee.orb_match.scoreTarget,source:"level_complete"}),B("heavy"),F("levelComplete")}},[A,$.targetScore,v,Q,c,y]);const Qt=s.useCallback(()=>{const e=z+1;Tt(e),Ae(0),Oe(0),Ie(!0),N(()=>{E.current&&Ie(!1)},1e3);const u=st(e,ue),l=["fire","water","earth","light","dark","cosmic"].slice(0,u.colors);ve(b??u.timeLimit),pe(l),oe(u.moveTime),F("playing")},[z,ue,pe,b,N,E]);s.useEffect(()=>{if(v==="complete"){const e=Me+A,u=U>=1;U>=3&&(Gt(!0),B("heavy"));const r=Math.min(Ce*2,15),l=U*5,m=Math.round(u?Math.min(100,50+l+r):Math.min(50,A/$.targetScore*50)),f=U>=5?"perfect":u?"good":"fail";N(()=>{O({success:u,accuracy:m,result:f,highScoreValue:e,gameStats:{score:e,level:z,levelsCompleted:U,maxCombo:Ce,time:Q,timeBonus:je}})},U>=3?1200:400)}},[v,A,Me,U,z,$.targetScore,Ce,Q,je,N,O]);const Jt=s.useCallback(e=>Ge(u=>u.filter(r=>r.id!==e)),[]),xe=s.useCallback(e=>Ye(u=>u.filter(r=>r.id!==e)),[]),et=A/$.targetScore,Kt=Q<=5&&v==="playing";return a.jsxs("div",{className:"flex flex-col items-center relative flex-1 min-h-0",children:[v==="countdown"&&a.jsx(Zt,{count:3,onComplete:Ht}),a.jsx(be,{children:v==="paused"&&a.jsx(eo,{onResume:()=>F("playing")})}),a.jsx(be,{children:v==="levelComplete"&&a.jsx(wt,{level:z,levelScore:$t,timeBonus:je,totalScore:Me,onContinue:Qt})}),a.jsx(to,{title:`Starburst - Level ${z}`,subtitle:`Target: ${$.targetScore} pts`,timeLeft:Q,totalTime:$e,combo:At,showCombo:!0,primaryStat:{value:A,label:`${A}/${$.targetScore}`,color:A>=$.targetScore?"#22c55e":"#a855f7"},secondaryStat:{value:U,label:`${U} cleared`,color:"#22d3ee"},isPaused:v==="paused",onPauseToggle:()=>F(v==="paused"?"playing":"paused"),compact:T}),a.jsxs("div",{className:"relative w-full mb-2 mx-auto",style:{width:re.width,maxWidth:"100%"},children:[a.jsx(yt,{level:z,progress:et}),a.jsx("div",{className:"absolute right-0 top-0",children:a.jsx(ht,{progress:et,isComplete:A>=$.targetScore})}),v==="playing"&&a.jsxs("div",{className:"pt-8",children:[a.jsx("div",{className:"h-2 bg-muted rounded-full overflow-hidden",children:a.jsx("div",{className:`h-full transition-all duration-150 ${D<2?"animate-pulse":""}`,style:{width:`${D/$.moveTime*100}%`,background:D<2?"linear-gradient(90deg, #ef4444, #f87171)":"linear-gradient(90deg, hsl(var(--primary)), hsl(var(--accent)))"}})}),a.jsxs("p",{className:"text-xs text-center text-muted-foreground mt-1",children:["Move: ",D.toFixed(1),"s"]})]})]}),!T&&a.jsx("button",{className:"text-xs text-muted-foreground mb-2 underline",onClick:()=>zt(!le),children:le?"Show Emojis":"Show Shapes"}),a.jsx("div",{ref:Yt,className:"w-full flex-1 min-h-0 flex items-center justify-center px-2 pb-2",children:a.jsxs("div",{ref:ke,className:"relative rounded-2xl overflow-hidden cursor-pointer touch-none game-container",style:{width:re.width,height:re.height},onMouseDown:Xt,onMouseMove:Ft,onMouseUp:Ze,onMouseLeave:Ze,onTouchStart:Vt,onTouchMove:Wt,onTouchEnd:qt,children:[a.jsx(ut,{}),a.jsx("div",{className:"absolute inset-0 pointer-events-none grid-lines"}),De&&a.jsx(ft,{orbs:De,cellSize:I}),G.map(e=>a.jsx(St,{orb:e,cellSize:I,isSelected:te?.id===e.id,isInPath:ye.includes(e.id),isReverting:Dt.has(e.id),showAccessibility:le},e.id)),Bt.map(e=>a.jsx(mt,{explosion:e,onComplete:()=>Jt(e.id)},e.id)),a.jsx(be,{children:Ut.map(e=>{switch(e.type){case"beam_horizontal":case"beam_vertical":return a.jsx(Mt,{effect:e,cellSize:I,onComplete:()=>xe(e.id)},e.id);case"cross_beam":return a.jsx(jt,{effect:e,cellSize:I,onComplete:()=>xe(e.id)},e.id);case"color_burst":return a.jsx(Ct,{effect:e,cellSize:I,onComplete:()=>xe(e.id)},e.id);case"cosmic_nova":return a.jsx(Nt,{effect:e,cellSize:I,onComplete:()=>xe(e.id)},e.id);default:return null}})}),Ot&&Be>1&&a.jsx(pt,{multiplier:Be}),Kt&&a.jsx(gt,{}),Se&&a.jsx(bt,{}),Pt&&a.jsx(xt,{}),a.jsx(be,{children:Rt&&a.jsx(vt,{})})]})}),!T&&a.jsxs(a.Fragment,{children:[a.jsx("div",{className:"flex flex-wrap justify-center gap-3 mt-4 text-xs",children:ae.slice(0,4).map(e=>a.jsxs("div",{className:"flex items-center gap-1.5 px-2 py-1 rounded-full bg-white/5 border border-white/10",children:[a.jsx("span",{className:"text-sm",children:le?dt[e]:we[e].emoji}),a.jsx("span",{className:"capitalize text-white/60 font-medium",children:e})]},e))}),a.jsx("p",{className:"text-xs text-white/40 mt-3 text-center font-medium",children:"Match 4+ for specials â€¢ T/L shapes = â˜… Star â€¢ Match specials for big damage!"})]}),a.jsx("style",{children:`
        .orb-base {
          transition: transform 120ms ease-out, box-shadow 100ms ease-out;
          will-change: transform;
        }
        .orb-matched {
          animation: orb-pop 180ms ease-out forwards;
        }
        .orb-new {
          animation: orb-drop 200ms ease-out;
        }
        .orb-revert {
          animation: orb-shake 150ms ease-out;
        }
        @keyframes orb-pop {
          0% { transform: scale(1); opacity: 1; }
          50% { transform: scale(1.2); opacity: 0.8; }
          100% { transform: scale(0); opacity: 0; }
        }
        @keyframes orb-drop {
          0% { transform: translateY(var(--start-y, -80px)) scale(0.8); opacity: 0; }
          100% { opacity: 1; }
        }
        @keyframes orb-shake {
          0%, 100% { transform: translateX(0); }
          25% { transform: translateX(-4px); }
          75% { transform: translateX(4px); }
        }
        .selection-ring {
          border: 2px solid;
          animation: ring-pulse 400ms ease-in-out infinite;
        }
        @keyframes ring-pulse {
          0%, 100% { opacity: 0.6; }
          50% { opacity: 1; }
        }
        .hint-pulse {
          border: 3px solid rgba(255, 215, 0, 0.8);
          box-shadow: 0 0 12px rgba(255, 215, 0, 0.6);
          animation: hint-glow 800ms ease-in-out infinite;
        }
        @keyframes hint-glow {
          0%, 100% { transform: scale(1); opacity: 0.6; }
          50% { transform: scale(1.08); opacity: 1; }
        }
        .explosion-effect {
          transform: translate(-50%, -50%);
        }
        .explosion-ring {
          position: absolute;
          width: 50px; height: 50px;
          left: -25px; top: -25px;
          border: 3px solid;
          border-radius: 50%;
          animation: ring-expand 350ms ease-out forwards;
        }
        @keyframes ring-expand {
          0% { transform: scale(0); opacity: 1; }
          100% { transform: scale(2); opacity: 0; }
        }
        .explosion-score {
          position: absolute;
          font-size: 16px; font-weight: 800;
          text-shadow: 0 0 8px currentColor, 0 2px 4px rgba(0,0,0,0.5);
          animation: score-float 400ms ease-out forwards;
        }
        @keyframes score-float {
          0% { transform: translateY(0); opacity: 1; }
          100% { transform: translateY(-40px); opacity: 0; }
        }
        .cascade-popup {
          animation: cascade-pop 500ms ease-out forwards;
        }
        @keyframes cascade-pop {
          0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
          30% { transform: translate(-50%, -50%) scale(1.3); opacity: 1; }
          100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        .urgency-pulse {
          box-shadow: inset 0 0 40px rgba(239, 68, 68, 0.4);
          border: 2px solid rgba(239, 68, 68, 0.5);
          animation: urgency 400ms ease-in-out infinite;
        }
        @keyframes urgency {
          0%, 100% { box-shadow: inset 0 0 40px rgba(239, 68, 68, 0.3); }
          50% { box-shadow: inset 0 0 60px rgba(239, 68, 68, 0.5); }
        }
        .perfect-banner {
          animation: banner-pop 300ms ease-out;
        }
        @keyframes banner-pop {
          0% { transform: scale(0) rotate(-10deg); opacity: 0; }
          100% { transform: scale(1) rotate(0); opacity: 1; }
        }
        .game-container {
          background: linear-gradient(145deg, rgba(0,0,0,0.85) 0%, rgba(15,15,35,0.95) 50%, rgba(25,15,45,0.9) 100%);
          border: 1px solid rgba(255,255,255,0.08);
          box-shadow: 0 20px 40px -12px rgba(0,0,0,0.6);
        }
        .grid-lines {
          background-image: 
            linear-gradient(to right, rgba(255,255,255,0.04) 1px, transparent 1px),
            linear-gradient(to bottom, rgba(255,255,255,0.04) 1px, transparent 1px);
          background-size: calc(100% / 6) calc(100% / 5);
        }
        .stars-layer {
          position: absolute; inset: 0;
          background-image: radial-gradient(1px 1px at 10% 20%, white, transparent),
            radial-gradient(1px 1px at 30% 60%, white, transparent),
            radial-gradient(1px 1px at 50% 30%, white, transparent),
            radial-gradient(1px 1px at 70% 80%, white, transparent),
            radial-gradient(1px 1px at 90% 40%, white, transparent);
        }
        .drop-shadow-glow { text-shadow: 0 0 20px rgba(250,204,21,0.8); }
        .shadow-glow-yellow { box-shadow: 0 0 40px rgba(250,204,21,0.4); }
        .shadow-glow-purple { box-shadow: 0 0 40px rgba(168,85,247,0.4); }
        
        /* Special orb animations */
        @keyframes special-pulse {
          0%, 100% { box-shadow: 0 0 10px rgba(255,255,255,0.5); }
          50% { box-shadow: 0 0 25px rgba(255,255,255,0.9), 0 0 35px rgba(255,255,255,0.4); }
        }
        @keyframes special-rainbow {
          0% { border-color: gold; box-shadow: 0 0 15px gold; }
          33% { border-color: #ff6b6b; box-shadow: 0 0 15px #ff6b6b; }
          66% { border-color: #4facfe; box-shadow: 0 0 15px #4facfe; }
          100% { border-color: gold; box-shadow: 0 0 15px gold; }
        }
        @keyframes special-rotate {
          0% { transform: rotate(0deg); }
          100% { transform: rotate(360deg); }
        }
        @keyframes special-nova {
          0%, 100% { box-shadow: 0 0 15px rgba(236,72,153,0.6), 0 0 30px rgba(168,85,247,0.3); }
          50% { box-shadow: 0 0 30px rgba(236,72,153,0.9), 0 0 50px rgba(168,85,247,0.6); }
        }
      `})]})};export{vo as OrbMatchGame};
