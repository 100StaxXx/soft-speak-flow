import{dK as M,H as Y,r as g,q as N,u as A,ay as B,ax as l,j as e,aU as q,b0 as S,dd as T,dm as Q,aR as z,cl as $,dr as I,c5 as P,bw as O,dN as V,o as H,aO as J}from"./vendor-DK8VKJIv.js";import{a8 as i,s as b,f as o,a as W,B as d,J as m}from"./index-vNUnYBjj.js";import"./date-vendor-BRrA_NVo.js";import"./three-vendor-qI8GXUTd.js";const se=()=>{const[j]=M(),w=Y(),[h,F]=g.useState(""),[t,f]=g.useState(null),[p,u]=g.useState(null);g.useEffect(()=>{const s=j.get("code"),r=j.get("token"),k=i.getItem("influencer_code"),_=i.getItem("influencer_dashboard_token");if(s){const E=s.toUpperCase();f(E),i.setItem("influencer_code",E),r?(u(r),i.setItem("influencer_dashboard_token",r)):(u(null),i.removeItem("influencer_dashboard_token"))}else k&&(f(k),_&&u(_))},[j]);const{data:a,isLoading:R}=N({queryKey:["influencer-code",t],queryFn:async()=>{if(!t)return null;const{data:s,error:r}=await b.from("referral_codes").select("*").eq("code",t).eq("owner_type","influencer").maybeSingle();if(r)throw console.error("Error fetching influencer code:",r),r;if(!s)throw new Error("Invalid or expired influencer code");return s},enabled:!!t}),{data:x}=N({queryKey:["influencer-conversions",t],queryFn:async()=>{if(!t)return[];const{data:s,error:r}=await b.from("profiles").select("id, email, created_at, subscription_status").eq("referred_by_code",t).order("created_at",{ascending:!1});if(r)throw r;return s},enabled:!!t}),{data:c}=N({queryKey:["influencer-payouts",a?.id],queryFn:async()=>{if(!a?.id)return[];const{data:s,error:r}=await b.from("referral_payouts").select("*").eq("referral_code_id",a.id).order("created_at",{ascending:!1});if(r)throw r;return s},enabled:!!a?.id}),n={totalSignups:x?.length||0,activeSubscribers:x?.filter(s=>s.subscription_status==="active").length||0,totalEarnings:c?.reduce((s,r)=>s+Number(r.amount),0)||0,pendingEarnings:c?.filter(s=>s.status==="pending").reduce((s,r)=>s+Number(r.amount),0)||0,requestedEarnings:c?.filter(s=>s.status==="requested").reduce((s,r)=>s+Number(r.amount),0)||0,paidEarnings:c?.filter(s=>s.status==="paid").reduce((s,r)=>s+Number(r.amount),0)||0},U=A(),y=B({mutationFn:async()=>{if(!t)throw new Error("Missing referral code");if(!p)throw new Error("Secure creator session expired. Re-open your dashboard link from email.");const{data:s,error:r}=await b.functions.invoke("request-referral-payout",{body:{referral_code:t,creator_access_token:p}});if(r)throw r;if(s?.error)throw new Error(s.error);return s},onSuccess:s=>{l.success(s.message||"Payout request submitted!"),U.invalidateQueries({queryKey:["influencer-payouts"]})},onError:s=>{l.error(s.message||"Failed to request payout")}}),v=()=>{if(!h.trim()){l.error("Please enter your referral code");return}f(h.trim().toUpperCase()),i.setItem("influencer_code",h.trim().toUpperCase()),u(null),i.removeItem("influencer_dashboard_token")},D=()=>{t&&(navigator.clipboard.writeText(t),l.success("Code copied to clipboard!"))},L=()=>{if(t){const s=`${window.location.origin}/?ref=${t}`;navigator.clipboard.writeText(s),l.success("Link copied to clipboard!")}},K=async()=>{if(!t)return;const s=`‚ú® Transform your habits into an epic journey with Cosmiq! Use my code ${t} or click: ${window.location.origin}/?ref=${t}`;if(H.isNativePlatform())try{await J.share({text:s,dialogTitle:"Share Your Referral Code"})}catch(r){console.error("Share failed:",r)}else navigator.clipboard.writeText(s),l.success("Promo text copied to clipboard!")},C=()=>{i.removeItem("influencer_code"),i.removeItem("influencer_dashboard_token"),f(null),u(null),w("/creator")};return t?R?e.jsx("div",{className:"min-h-screen pb-nav-safe bg-gradient-to-b from-background via-background/95 to-primary/5 flex items-center justify-center",children:e.jsx(S,{className:"h-8 w-8 animate-spin text-primary"})}):a?e.jsx("div",{className:"min-h-screen pb-nav-safe bg-gradient-to-b from-background via-background/95 to-primary/5 py-8 px-4",children:e.jsxs("div",{className:"max-w-6xl mx-auto",children:[e.jsxs("div",{className:"mb-8 flex items-start justify-between",children:[e.jsxs("div",{children:[e.jsxs("h1",{className:"font-heading text-4xl font-bold mb-2",children:["Welcome back, ",a.influencer_name,"! üëã"]}),e.jsx("p",{className:"text-muted-foreground",children:"Track your referrals and earnings"})]}),e.jsx(d,{variant:"outline",onClick:C,children:"Switch Code"})]}),e.jsx(o,{className:"p-6 mb-6 rounded-3xl shadow-soft",children:e.jsxs("div",{className:"flex flex-col md:flex-row items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Your Referral Code"}),e.jsx("code",{className:"text-3xl font-bold font-mono text-primary",children:a.code}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-2",children:[a.influencer_handle&&`${a.influencer_handle} ‚Ä¢ `,a.influencer_email]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(d,{onClick:D,variant:"outline",children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Copy Code"]}),e.jsxs(d,{onClick:L,variant:"outline",children:[e.jsx(Q,{className:"h-4 w-4 mr-2"}),"Copy Link"]}),e.jsxs(d,{onClick:K,children:[e.jsx(z,{className:"h-4 w-4 mr-2"}),"Share"]})]})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6",children:[e.jsxs(o,{className:"p-6 rounded-3xl shadow-soft",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx($,{className:"h-8 w-8 text-blue-500"}),e.jsx(m,{variant:"secondary",children:n.totalSignups})]}),e.jsx("p",{className:"text-2xl font-bold",children:n.totalSignups}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Sign-Ups"})]}),e.jsxs(o,{className:"p-6 rounded-3xl shadow-soft",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx(q,{className:"h-8 w-8 text-green-500"}),e.jsx(m,{variant:"secondary",children:n.activeSubscribers})]}),e.jsx("p",{className:"text-2xl font-bold",children:n.activeSubscribers}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Active Subscribers"})]}),e.jsxs(o,{className:"p-6 rounded-3xl shadow-soft",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx(I,{className:"h-8 w-8 text-green-600"}),e.jsxs(m,{className:"bg-green-500",children:["$",n.totalEarnings.toFixed(2)]})]}),e.jsxs("p",{className:"text-2xl font-bold",children:["$",n.totalEarnings.toFixed(2)]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Total Earnings"})]}),e.jsxs(o,{className:"p-6 rounded-3xl shadow-soft",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx(P,{className:"h-8 w-8 text-yellow-500"}),e.jsxs(m,{variant:"outline",children:["$",n.pendingEarnings.toFixed(2)]})]}),e.jsxs("p",{className:"text-2xl font-bold",children:["$",n.pendingEarnings.toFixed(2)]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Pending Payout"})]})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-6",children:[e.jsxs(o,{className:"p-6 rounded-3xl shadow-soft",children:[e.jsxs("h2",{className:"font-heading text-2xl font-semibold mb-4 flex items-center gap-2",children:[e.jsx($,{className:"h-6 w-6 text-primary"}),"Recent Sign-Ups"]}),x&&x.length>0?e.jsx("div",{className:"space-y-3",children:x.slice(0,10).map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-secondary/20 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.email}),e.jsx("p",{className:"text-xs text-muted-foreground",children:new Date(s.created_at).toLocaleDateString()})]}),e.jsx(m,{variant:s.subscription_status==="active"?"default":"outline",children:s.subscription_status||"Free"})]},s.id))}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:"No sign-ups yet. Keep sharing your code!"})]}),e.jsxs(o,{className:"p-6 rounded-3xl shadow-soft",children:[e.jsxs("h2",{className:"font-heading text-2xl font-semibold mb-4 flex items-center gap-2",children:[e.jsx(I,{className:"h-6 w-6 text-primary"}),"Payout History"]}),c&&c.length>0?e.jsx("div",{className:"space-y-3",children:c.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-secondary/20 rounded-lg",children:[e.jsxs("div",{children:[e.jsxs("p",{className:"font-medium",children:["$",Number(s.amount).toFixed(2)]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[new Date(s.created_at).toLocaleDateString()," ‚Ä¢"," ",s.payout_type==="first_month"?"Monthly":"Yearly"]})]}),e.jsxs(m,{variant:s.status==="paid"?"default":s.status==="pending"?"outline":"secondary",children:[s.status==="paid"&&e.jsx(O,{className:"h-3 w-3 mr-1"}),s.status==="pending"&&e.jsx(P,{className:"h-3 w-3 mr-1"}),s.status]})]},s.id))}):e.jsx("p",{className:"text-muted-foreground text-center py-8",children:"No payouts yet. Earnings appear when users subscribe!"}),n.pendingEarnings>=50&&e.jsxs("div",{className:"mt-4 p-4 bg-green-500/10 border border-green-500/20 rounded-lg",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-green-600",children:"üéâ You've reached the $50 payout threshold!"}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:["Request your payout to be sent to ",a.payout_identifier]})]}),e.jsxs(d,{onClick:()=>y.mutate(),disabled:y.isPending||!p,className:"shrink-0",children:[y.isPending?e.jsx(S,{className:"h-4 w-4 mr-2 animate-spin"}):e.jsx(V,{className:"h-4 w-4 mr-2"}),"Request Payout"]})]}),!p&&e.jsx("p",{className:"text-xs text-amber-600 mt-3",children:"Secure session required. Re-open your dashboard link from your confirmation email."})]}),n.requestedEarnings>0&&e.jsxs("div",{className:"mt-4 p-4 bg-blue-500/10 border border-blue-500/20 rounded-lg",children:[e.jsxs("p",{className:"text-sm font-medium text-blue-600",children:["‚è≥ Payout of $",n.requestedEarnings.toFixed(2)," is pending review"]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"Our team will process your payout request shortly."})]}),n.pendingEarnings<50&&n.pendingEarnings>0&&e.jsx("div",{className:"mt-4 p-4 bg-yellow-500/10 border border-yellow-500/20 rounded-lg",children:e.jsxs("p",{className:"text-sm font-medium",children:["$",(50-n.pendingEarnings).toFixed(2)," away from $50 minimum payout"]})})]})]}),e.jsxs(o,{className:"p-6 mt-6 rounded-3xl shadow-soft",children:[e.jsx("h2",{className:"font-heading text-2xl font-semibold mb-4",children:"üì¢ Promo Kit"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Copy and paste this ready-made caption for your posts:"}),e.jsxs("div",{className:"bg-secondary/20 p-4 rounded-lg",children:[e.jsxs("p",{className:"text-sm mb-3",children:["‚ú® Transform your habits into an epic journey with Cosmiq! Use my code"," ",e.jsx("strong",{children:a.code})," or click:"," ",window.location.origin,"/?ref=",a.code]}),e.jsxs(d,{variant:"outline",size:"sm",onClick:()=>{const s=`‚ú® Transform your habits into an epic journey with Cosmiq! Use my code ${a.code} or click: ${window.location.origin}/?ref=${a.code}`;navigator.clipboard.writeText(s),l.success("Promo caption copied!")},children:[e.jsx(T,{className:"h-4 w-4 mr-2"}),"Copy Caption"]})]})]})]})}):e.jsx("div",{className:"min-h-screen pb-nav-safe bg-gradient-to-b from-background via-background/95 to-primary/5 py-12 px-4",children:e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(o,{className:"p-8 rounded-3xl shadow-soft text-center",children:[e.jsx("h1",{className:"font-heading text-2xl font-bold mb-4 text-destructive",children:"Invalid Code"}),e.jsxs("p",{className:"text-muted-foreground mb-6",children:['The code "',t,'" was not found or is not an influencer code.']}),e.jsx(d,{onClick:C,children:"Try Different Code"})]})})}):e.jsx("div",{className:"min-h-screen pb-nav-safe bg-gradient-to-b from-background via-background/95 to-primary/5 py-12 px-4",children:e.jsx("div",{className:"max-w-md mx-auto",children:e.jsxs(o,{className:"p-8 rounded-3xl shadow-soft",children:[e.jsxs("div",{className:"text-center mb-6",children:[e.jsx(q,{className:"h-12 w-12 text-primary mx-auto mb-4"}),e.jsx("h1",{className:"font-heading text-3xl font-bold mb-2",children:"Influencer Dashboard"}),e.jsx("p",{className:"text-muted-foreground",children:"Enter your referral code to view your performance"})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsx(W,{placeholder:"Enter your code (e.g., COSMIQ-DARRYL)",value:h,onChange:s=>F(s.target.value.toUpperCase()),onKeyPress:s=>s.key==="Enter"&&v(),className:"text-center text-lg font-mono"}),e.jsx(d,{onClick:v,className:"w-full",size:"lg",children:"View Dashboard"})]}),e.jsxs("div",{className:"mt-6 pt-6 border-t text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Don't have a code yet?"}),e.jsx(d,{variant:"outline",onClick:()=>w("/creator"),children:"Create Referral Code"})]})]})})})};export{se as default};
