import{u as x,ay as C,H as f,r as l,j as e,bF as y,ax as g}from"./vendor-DK8VKJIv.js";import{c as w,s as b,f as j,N as v,O as P,Q as N,g as k,a as E,B as h}from"./index-vNUnYBjj.js";import"./date-vendor-BRrA_NVo.js";import"./three-vendor-qI8GXUTd.js";class i extends Error{reason;constructor(a,o){super(a),this.name="PromoCodeRedeemError",this.reason=o}}const R=s=>{switch(s){case"invalid":case"used":case"expired":case"unauthorized":case"already_active":return s;default:return"unknown"}},_=()=>{const{user:s}=w(),a=x();return{redeemPromoCode:C({mutationFn:async d=>{if(!s)throw new i("You must be signed in to redeem a promo code.","unauthorized");const n=d.trim().toUpperCase();if(!n)throw new i("Enter a promo code.","invalid");const{data:r,error:c}=await b.rpc("redeem_promo_code_secure",{p_user_id:s.id,p_promo_code:n});if(c){const m=c.message||"Unable to redeem promo code right now. Please try again.";throw new i(m,"unknown")}const t=Array.isArray(r)?r[0]:r;if(!t?.success)throw new i(t?.message||"Unable to redeem this promo code.",R(t?.status));return t},onSuccess:async()=>{await Promise.all([a.invalidateQueries({queryKey:["subscription"]}),a.invalidateQueries({queryKey:["profile"]})])}})}},A=()=>{const s=f(),{redeemPromoCode:a}=_(),[o,d]=l.useState(""),[n,r]=l.useState(null),c=a.isPending,t=l.useMemo(()=>o.trim().toUpperCase(),[o]),m=async u=>{if(u.preventDefault(),!t){r("Enter a promo code.");return}r(null);try{await a.mutateAsync(t),g.success("Promo code applied. Access unlocked."),s("/profile",{replace:!0})}catch(p){if(p instanceof i){r(p.message);return}r("Unable to redeem promo code right now. Please try again.")}};return e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center px-4 py-8",children:e.jsxs(j,{className:"w-full max-w-md",children:[e.jsxs(v,{className:"space-y-3 text-center",children:[e.jsx("div",{className:"mx-auto inline-flex h-12 w-12 items-center justify-center rounded-full bg-primary/10 text-primary",children:e.jsx(y,{className:"h-6 w-6"})}),e.jsx(P,{children:"Redeem Promo Code"}),e.jsx(N,{children:"Enter your promo code to unlock app access."})]}),e.jsxs(k,{className:"space-y-4",children:[e.jsxs("form",{onSubmit:m,className:"space-y-3",children:[e.jsx(E,{value:o,onChange:u=>d(u.target.value.toUpperCase()),placeholder:"PROMO-XXXX",autoCapitalize:"characters",autoComplete:"off",spellCheck:!1,className:"text-center text-lg tracking-wider",maxLength:40}),n&&e.jsx("p",{className:"rounded-md border border-destructive/40 bg-destructive/5 px-3 py-2 text-sm text-destructive",children:n}),e.jsx(h,{type:"submit",className:"w-full",disabled:c||!t,children:c?"Redeeming...":"Redeem Promo Code"})]}),e.jsx(h,{type:"button",variant:"ghost",className:"w-full",onClick:()=>s("/profile"),children:"Back to Command Center"})]})]})})};export{A as default};
