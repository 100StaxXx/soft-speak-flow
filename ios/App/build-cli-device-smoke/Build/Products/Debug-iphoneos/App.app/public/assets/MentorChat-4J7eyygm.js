import{r,j as e,m as W,dF as U,dG as G,cV as te,b3 as se,b4 as ae,X as ne,bZ as $,dH as re,W as oe,aW as ie,u as le,H as ce,q as de,co as ue,M as me}from"./vendor-DK8VKJIv.js";import{c as z,ax as he,B as d,s as _,ay as H,u as fe,p as ge,K as pe,f as Q,a as ye,m as xe,az as be,aA as ve,e as we,ad as je,ai as ke}from"./index-vNUnYBjj.js";import"./date-vendor-BRrA_NVo.js";import"./three-vendor-qI8GXUTd.js";const V=["Channeling wisdom...","Consulting the stars...","Gathering insights...","Aligning thoughts...","Seeking clarity..."],Ne=({mentorName:a})=>{const[s,u]=r.useState(0);return r.useEffect(()=>{const t=setInterval(()=>{u(l=>(l+1)%V.length)},1800);return()=>clearInterval(t)},[]),e.jsxs("div",{className:"flex flex-col gap-3",children:[e.jsx("div",{className:"font-semibold text-sm",children:a}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs("div",{className:"relative w-8 h-8",children:[e.jsx(W.div,{className:"absolute inset-0 rounded-full border border-primary/30",animate:{rotate:360},transition:{duration:8,repeat:1/0,ease:"linear"}}),e.jsx(W.div,{className:"absolute inset-1 rounded-full bg-gradient-to-br from-primary/40 to-purple-500/30",animate:{scale:[1,1.15,1],opacity:[.6,1,.6]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"}}),[0,1,2].map(t=>e.jsx(W.div,{className:"absolute w-1.5 h-1.5 rounded-full bg-primary/80",style:{top:"50%",left:"50%",marginTop:-3,marginLeft:-3},animate:{x:Math.cos(t*Math.PI*2/3)*12,y:Math.sin(t*Math.PI*2/3)*12,opacity:[.5,1,.5]},transition:{duration:2,repeat:1/0,delay:t*.3,ease:"easeInOut"}},t))]}),e.jsx(W.span,{initial:{opacity:0,x:-5},animate:{opacity:1,x:0},exit:{opacity:0,x:5},className:"text-sm text-muted-foreground italic",children:V[s]},s)]})]})},Ce=(a,s,u)=>{const t=a.toLowerCase(),l=/tough|direct/i.test(u),c=/empathetic|supportive/i.test(u);return t.includes("habit")||t.includes("consistent")?{content:Me(l,c),isFallback:!0}:t.includes("motivat")||t.includes("boost")||t.includes("encourage")?{content:Se(l,c),isFallback:!0}:t.includes("start")||t.includes("begin")||t.includes("day")?{content:_e(l,c),isFallback:!0}:t.includes("reflect")||t.includes("think")||t.includes("today")?{content:Ie(l,c),isFallback:!0}:t.includes("struggle")||t.includes("hard")||t.includes("difficult")?{content:Ee(l,c),isFallback:!0}:t.includes("goal")||t.includes("challenge")||t.includes("improve")?{content:Re(l,c),isFallback:!0}:{content:Te(l,c),isFallback:!0}};function Me(a,s){return a?"Consistency isn't built overnight. Track your habits daily, hold yourself accountable, and don't make excuses. Small actions compound over time - but only if you show up.":s?"Building habits takes time and patience. Start with one small habit and be gentle with yourself when you miss a day. What matters is that you keep coming back. You're doing great!":"The key to building strong habits is consistency. Start small - even 5 minutes a day makes a difference. Track your progress and celebrate small wins along the way."}function Se(a,s){return a?"You don't need motivation - you need discipline. Motivation fades, but habits and systems last. Stop waiting to feel ready and start taking action now.":s?"I know it can be tough sometimes. Remember why you started this journey. You have everything you need within you to succeed. Take a deep breath and tackle one small thing today.":"Every expert was once a beginner. Focus on progress, not perfection. Each step forward, no matter how small, is moving you closer to your goals."}function _e(a,s){return a?"Stop overthinking and start doing. Plan your top 3 priorities and execute them. No distractions, no excuses. Your future self will thank you.":s?"Good morning! Today is a fresh start full of possibilities. Take a moment to set a clear intention for what you want to accomplish. You've got this!":"Start your day with clarity. Choose your top 3 priorities and tackle them first. Build momentum with small wins and maintain that energy throughout the day."}function Ie(a,s){return a?"Be honest with yourself. What actually got done today versus what you planned? Learn from it and adjust tomorrow. No sugar-coating - just honest assessment leads to real growth.":s?"Take a moment to appreciate what you accomplished today. Even small victories count. What did you learn? What are you grateful for? Rest well - you earned it.":"Reflection is powerful. Think about what worked well today and what you'd do differently. Each day is a learning opportunity. What's one insight you can carry forward?"}function Ee(a,s){return a?"Struggling means you're pushing your limits - that's good. The question is: will you push through or give up? Discomfort is where growth happens. Keep going.":s?"It's okay to struggle - it means you're challenging yourself. Be kind to yourself during difficult times. Break things down into smaller steps and ask for help when needed. You're stronger than you think.":"Challenges are part of growth. When things feel hard, break them into smaller, manageable steps. Focus on what you can control and take it one step at a time."}function Re(a,s){return a?"Goals without action are just wishes. Break your goal into concrete steps and start executing today. Track your progress ruthlessly and adjust as needed.":s?"Your goals are within reach. Start by making them specific and achievable. Celebrate each milestone along the way. Remember - progress over perfection!":"Clear goals drive focused action. Make your goals specific, measurable, and break them into weekly milestones. Review regularly and adjust your approach based on what you learn."}function Te(a,s){return a?"I hear you. Remember - you're capable of more than you think. The path forward is action, not overthinking. What's one concrete step you can take right now?":s?"Thank you for sharing with me. You're on a meaningful journey of growth. Whatever you're facing, remember that small consistent steps lead to big changes. What feels most important to focus on right now?":"I understand. Progress comes from consistent effort in the right direction. Focus on what you can control, take one step at a time, and trust the process. What's your next move?"}const Le=a=>({content:"I'm having trouble connecting right now, but I'm here for you. While we work on restoring the connection, remember: you already have the strength and wisdom within you to move forward. Trust yourself and take action on what you know you need to do.",isFallback:!0}),Fe=({messageContent:a,onFeedbackSubmitted:s})=>{const{user:u}=z(),{queueAction:t,shouldQueueWrites:l,reportApiFailure:c}=he(),[o,p]=r.useState(!1),[C,y]=r.useState(!1),[h,v]=r.useState(null),x=async m=>{if(!u||C)return;const w={message_content:a.slice(0,500),feedback_type:m};if(l){await t({actionKind:"MENTOR_FEEDBACK",entityType:"mentor_feedback",payload:w}),y(!0),v(m),s?.(),setTimeout(()=>p(!1),1500);return}try{const{error:g}=await _.from("mentor_chat_feedback").insert({user_id:u.id,...w});if(g)if(H(g))await t({actionKind:"MENTOR_FEEDBACK",entityType:"mentor_feedback",payload:w});else{console.error("Failed to submit feedback:",g),c(g,{source:"mentor_feedback_submit"});return}y(!0),v(m),s?.(),setTimeout(()=>p(!1),1500)}catch(g){console.error("Error submitting feedback:",g),c(g,{source:"mentor_feedback_submit_catch"}),H(g)&&(await t({actionKind:"MENTOR_FEEDBACK",entityType:"mentor_feedback",payload:w}),y(!0),v(m),s?.())}};return C?e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground mt-2",children:[e.jsx("span",{children:"Thanks for the feedback!"}),h==="positive"&&e.jsx(U,{className:"h-3 w-3 text-green-500"}),h==="negative"&&e.jsx(G,{className:"h-3 w-3 text-red-500"})]}):e.jsxs("div",{className:"mt-2",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 hover:bg-green-500/10",onClick:()=>x("positive"),"aria-label":"Good response",children:e.jsx(U,{className:"h-3 w-3 text-muted-foreground hover:text-green-500"})}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0 hover:bg-red-500/10",onClick:()=>x("negative"),"aria-label":"Bad response",children:e.jsx(G,{className:"h-3 w-3 text-muted-foreground hover:text-red-500"})}),e.jsxs(d,{variant:"ghost",size:"sm",className:"h-6 px-1 text-xs text-muted-foreground hover:text-foreground",onClick:()=>p(!o),children:[e.jsx(te,{className:"h-3 w-3 mr-1"}),"More",o?e.jsx(se,{className:"h-3 w-3 ml-1"}):e.jsx(ae,{className:"h-3 w-3 ml-1"})]})]}),o&&e.jsxs("div",{className:"flex flex-wrap gap-1 mt-2 animate-in slide-in-from-top-2 duration-200",children:[e.jsx(d,{variant:"outline",size:"sm",className:"h-6 text-xs px-2",onClick:()=>x("too_long"),children:"Too long"}),e.jsx(d,{variant:"outline",size:"sm",className:"h-6 text-xs px-2",onClick:()=>x("too_short"),children:"Too short"}),e.jsx(d,{variant:"outline",size:"sm",className:"h-6 text-xs px-2",onClick:()=>x("too_formal"),children:"Too formal"}),e.jsx(d,{variant:"outline",size:"sm",className:"h-6 text-xs px-2",onClick:()=>x("too_casual"),children:"Too casual"}),e.jsx(d,{variant:"ghost",size:"sm",className:"h-6 w-6 p-0",onClick:()=>p(!1),"aria-label":"Close feedback options",children:e.jsx(ne,{className:"h-3 w-3"})})]})]})},De=15,Pe=20,We=(a,s,u)=>{const t=new Date().getHours(),l=/tough|direct/i.test(a),c=/empathetic|supportive/i.test(a),o=[];return t>=5&&t<12?o.push("Help me start my day strong","What should I focus on today?"):t>=12&&t<17?o.push("I need an afternoon boost","Keep me on track"):o.push("Help me reflect on today","Prepare me for tomorrow"),l?o.push("Give me the hard truth"):c?o.push("I need some encouragement"):o.push("Give me a pep talk"),s||u?o.push(s?"Help me stay consistent":"Keep me motivated"):o.push("Help me build better habits"),o.sort(()=>Math.random()-.5).slice(0,3)},Ae=({mentorName:a,mentorTone:s,mentorId:u,hasActiveHabits:t=!1,hasActiveChallenges:l=!1,briefingContext:c,comprehensiveMode:o=!1})=>{const{user:p}=z(),C=$(),[y,h]=r.useState([]),[v,x]=r.useState(""),[m,w]=r.useState(!1),[g,T]=r.useState(!0),[A,b]=r.useState([]),[M,j]=r.useState(0),[I,L]=r.useState(navigator.onLine),[k,Y]=r.useState(Pe),E=r.useRef(null),{toast:R}=fe(),q=r.useRef(!1),B=r.useRef([]);B.current=y;const F=r.useCallback(async n=>{const{data:{user:i},error:O}=await _.auth.getUser();if(O||!i){R({title:"Error",description:"You must be logged in",variant:"destructive"});return}if(M>=k){R({title:"Daily limit reached",description:`You've reached your daily limit of ${k} messages. It resets at 00:00 UTC.`,variant:"destructive"});return}const J={role:"user",content:n};h(S=>[...S,J]),w(!0);try{const S=B.current,{data:f,error:D}=await _.functions.invoke("mentor-chat",{body:{message:n,mentorName:a,mentorTone:s,conversationHistory:S.slice(-10),comprehensiveMode:o,briefingContext:c}});if(D)throw D;if(!f||!f.response)throw new Error("Invalid response from mentor");const K={role:"assistant",content:f.response};h(N=>[...N,K]),typeof f.dailyLimit=="number"&&Number.isFinite(f.dailyLimit)&&Y(f.dailyLimit),f.messagesUsed!==void 0?j(f.messagesUsed):j(N=>N+1),u&&_.from("mentor_chats").insert([{user_id:i.id,mentor_id:u,role:"user",content:n},{user_id:i.id,mentor_id:u,role:"assistant",content:f.response}]).then(({error:N})=>{N&&console.error("Failed to save chat history:",N)})}catch(S){console.error("Mentor chat error:",S);const f=await ge(S),D=f.responsePayload?.message??f.responsePayload?.error??f.message;if(f.status===429){R({title:"Daily limit reached",description:D||`You've reached your daily limit of ${k} messages. It resets at 00:00 UTC.`,variant:"destructive"}),h(P=>P.filter((Ye,ee)=>ee!==P.length-1));return}const N={role:"assistant",content:(I?Ce(n,a,s):Le()).content,isFallback:!0};h(P=>[...P,N]),R({title:"Connection issue",description:"Live reply unavailable. Showing fallback guidance.",duration:3e3})}finally{w(!1)}},[M,k,R,a,s,u,I,o,c]);r.useEffect(()=>{(async()=>{if(!p)return;const i=new Date;i.setUTCHours(0,0,0,0);const{count:O}=await _.from("mentor_chats").select("*",{count:"exact",head:!0}).eq("user_id",p.id).eq("role","user").gte("created_at",i.toISOString());j(O||0)})()},[p]),r.useEffect(()=>{b(We(s,t,l))},[s,t,l]),r.useEffect(()=>{E.current?.scrollIntoView({behavior:"smooth"})},[y]),r.useEffect(()=>{const n=()=>L(!0),i=()=>L(!1);return window.addEventListener("online",n),window.addEventListener("offline",i),()=>{window.removeEventListener("online",n),window.removeEventListener("offline",i)}},[]),r.useEffect(()=>{const n=C.state?.initialMessage;n&&!q.current&&(q.current=!0,T(!1),F(n))},[C.state,F]);const X=async n=>{n.preventDefault();const i=v.trim();!i||m||(x(""),await F(i))},Z=n=>{T(!1),F(n)};return e.jsxs("div",{className:"flex flex-col h-full",children:[!I&&e.jsxs("div",{className:"bg-destructive text-destructive-foreground px-4 py-2 text-sm flex items-center justify-center gap-2",children:[e.jsx(re,{className:"h-4 w-4"}),e.jsx("span",{children:"You're offline. Live mentor replies are unavailable; fallback guidance is shown."})]}),e.jsx("div",{className:"px-4 pt-3 pb-2 border-b border-border/50 bg-muted/30",children:e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Daily messages: ",M,"/",k]}),e.jsx("div",{className:"flex gap-1",children:Array.from({length:Math.min(k,De)}).map((n,i)=>e.jsx("div",{className:pe("h-1 w-3 rounded-full transition-colors",i<M?"bg-primary":"bg-muted")},i))})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-4 space-y-4",children:[y.length===0&&g&&e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-muted-foreground text-center",children:"Choose a prompt or type your own message"}),e.jsx("div",{className:"grid gap-2",children:A.map((n,i)=>e.jsx(d,{variant:"outline",className:"justify-start text-left h-auto py-3 px-4 hover:bg-accent",onClick:()=>Z(n),children:n},i))})]}),y.map((n,i)=>e.jsxs(Q,{className:`p-4 ${n.role==="user"?"ml-8 bg-primary/10":"mr-8"}`,children:[e.jsxs("div",{className:"flex items-center justify-between mb-1",children:[e.jsx("div",{className:"font-semibold text-sm",children:n.role==="user"?"You":a}),n.isFallback&&e.jsxs("div",{className:"flex items-center gap-1 text-xs text-muted-foreground",children:[e.jsx(oe,{className:"h-3 w-3"}),e.jsx("span",{children:"Offline mode"})]})]}),e.jsx("div",{className:"text-sm whitespace-pre-wrap",children:n.content}),n.role==="assistant"&&!n.isFallback&&e.jsx(Fe,{messageContent:n.content})]},i)),m&&e.jsx(Q,{className:"p-4 mr-8",children:e.jsx(Ne,{mentorName:a})}),e.jsx("div",{ref:E})]}),e.jsx("form",{onSubmit:X,className:"p-4 border-t",children:e.jsxs("div",{className:"flex gap-2 items-center",children:[e.jsx(ye,{value:v,onChange:n=>x(n.target.value),placeholder:"Type your message...",disabled:m,className:"flex-1"}),e.jsx(d,{type:"submit",disabled:m||!v.trim(),size:"icon","aria-label":"Send message",children:e.jsx(ie,{className:"h-4 w-4"})})]})})]})};function Ke(){const{user:a}=z(),{profile:s,loading:u,error:t,refetch:l}=xe(),c=le(),o=ce(),p=$(),[C,y]=r.useState(!1),[h,v]=r.useState(!1),x=be(),{effectiveMentorId:m,status:w,refreshConnection:g}=ve(),T=p.state?.briefingContext,A=p.state?.comprehensiveMode||!1,{data:b,isLoading:M,isFetching:j,error:I,refetch:L}=de({queryKey:["mentor",m],queryFn:async()=>{if(!m)return null;const{data:Y,error:E}=await _.from("mentors").select("*").eq("id",m).maybeSingle();if(E)throw E;return Y},enabled:!!m}),k=async()=>{v(!0);try{await l(),await g(),await Promise.all([c.invalidateQueries({queryKey:["mentor"]}),c.invalidateQueries({queryKey:["selected-mentor"]})]),m&&await L()}finally{v(!1)}};return!a||u||M||w==="recovering"?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center space-y-3",children:[e.jsx("div",{className:"w-16 h-16 border-4 border-primary border-t-transparent rounded-full animate-spin mx-auto"}),e.jsx("p",{className:"text-muted-foreground text-sm",children:"Loading your motivator..."})]})}):t&&!s?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center space-y-4 max-w-md",children:[e.jsx("p",{className:"text-lg font-semibold",children:"We couldn't load your profile"}),e.jsx("p",{className:"text-muted-foreground",children:"Connection may have dropped while the app was in the background. Try again."}),e.jsx(d,{onClick:()=>{k()},disabled:h||j,children:h||j?"Retrying...":"Retry"})]})}):w==="missing"?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center space-y-4 max-w-md",children:[e.jsx("p",{className:"text-lg font-semibold",children:"No mentor selected"}),e.jsx("p",{className:"text-muted-foreground",children:"Please select a mentor to continue."}),e.jsx(d,{onClick:()=>o("/mentor-selection"),children:"Choose Your Mentor"})]})}):I&&!b?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center space-y-4 max-w-md",children:[e.jsx("p",{className:"text-lg font-semibold",children:"We couldn't load your mentor"}),e.jsx("p",{className:"text-muted-foreground",children:"Connection may have dropped while the app was in the background. Try again."}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(d,{onClick:()=>{k()},disabled:h||j,children:h||j?"Retrying...":"Retry"}),e.jsx(d,{variant:"outline",onClick:()=>o("/mentor-selection"),children:"Choose Mentor"})]})]})}):b?e.jsxs(we,{children:[e.jsxs("div",{className:"min-h-screen bg-background pb-nav-safe pt-safe relative z-10",children:[e.jsxs("div",{className:"relative h-48 md:h-64 overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/30 via-accent/20 to-background animate-gradient-shift"}),e.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(circle_at_center,_var(--tw-gradient-stops))] from-primary/40 via-transparent to-transparent"}),e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("div",{className:"absolute top-1/4 left-1/4 w-2 h-2 bg-primary/60 rounded-full animate-float-slow"}),e.jsx("div",{className:"absolute top-1/3 right-1/3 w-3 h-3 bg-accent/60 rounded-full animate-float-medium",style:{animationDelay:"0.5s"}}),e.jsx("div",{className:"absolute bottom-1/4 left-1/3 w-2 h-2 bg-primary/40 rounded-full animate-float-fast",style:{animationDelay:"1s"}}),e.jsx("div",{className:"absolute top-1/2 right-1/4 w-2 h-2 bg-accent/50 rounded-full animate-float-slow",style:{animationDelay:"1.5s"}})]}),b.avatar_url&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"absolute inset-0 bg-primary/30 blur-3xl rounded-full animate-pulse"}),e.jsx("img",{src:b.avatar_url,alt:b.name,className:"relative w-24 h-24 md:w-32 md:h-32 rounded-full border-4 border-background shadow-glow-lg object-cover",loading:"lazy",decoding:"async"})]})}),e.jsxs("div",{className:"absolute top-4 left-4 right-4 z-10 flex items-center justify-between safe-area-top",children:[e.jsx(d,{variant:"ghost",size:"icon",onClick:()=>o("/mentor"),className:"bg-background/80 backdrop-blur-sm hover:bg-background/90 rounded-full shadow-soft",children:e.jsx(ue,{className:"w-5 h-5"})}),e.jsx(je,{onClick:()=>{x.tap(),y(!0)}})]}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-background via-background/95 to-transparent p-6 pb-4",children:[e.jsxs("h1",{className:"text-2xl md:text-3xl font-heading font-black text-foreground text-center",children:["Ask ",b.name]}),e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"Get guidance from your motivator"})]})]}),e.jsx("div",{className:"container max-w-4xl mx-auto p-4 md:p-6 space-y-6",children:e.jsx(Ae,{mentorName:b.name,mentorTone:b.tone_description,mentorId:b.id,briefingContext:T,comprehensiveMode:A})})]}),e.jsx(ke,{open:C,onClose:()=>y(!1),title:"About Your Mentor",icon:me,description:"Your personal motivator is here to guide and support you on your journey.",features:["Ask questions and get personalized advice","Receive guidance tailored to your goals","Get encouragement when you need it most","Chat anytime for instant motivation"],tip:"Your mentor's tone and style match your preferences from onboarding."})]}):e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center p-4",children:e.jsxs("div",{className:"text-center space-y-4 max-w-md",children:[e.jsx("p",{className:"text-lg font-semibold",children:"Mentor unavailable"}),e.jsx("p",{className:"text-muted-foreground",children:"We couldn't find your selected mentor right now."}),e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(d,{onClick:()=>{k()},disabled:h||j,children:h||j?"Retrying...":"Retry"}),e.jsx(d,{variant:"outline",onClick:()=>o("/mentor-selection"),children:"Choose Mentor"})]})]})})}export{Ke as default};
