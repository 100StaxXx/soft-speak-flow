import{r as l,j as e,ed as C,bl as G,q as $,ax as q,aP as p,L as w,am as z,cg as E,aw as F,ac as J,bc as R,b0 as W,K as B}from"./vendor-DK8VKJIv.js";import{K as I,a_ as H,a$ as K,b0 as M,d as U,bG as A,f as i,B as m,bH as b,s as D}from"./index-vNUnYBjj.js";import"./date-vendor-BRrA_NVo.js";import"./three-vendor-qI8GXUTd.js";const N=l.forwardRef(({className:a,orientation:d="horizontal",decorative:t=!0,...c},r)=>e.jsx(C,{ref:r,decorative:t,orientation:d,className:I("shrink-0 bg-border",d==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",a),...c}));N.displayName=C.displayName;const V=()=>e.jsxs(H,{children:[e.jsx(K,{asChild:!0,children:e.jsx("button",{className:"p-1 rounded-full hover:bg-primary/10 transition-colors",children:e.jsx(G,{className:"h-4 w-4 text-muted-foreground"})})}),e.jsx(M,{side:"bottom",className:"max-w-xs",children:e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsx("p",{className:"font-semibold",children:"Story Journal"}),e.jsxs("ul",{className:"space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"• Each evolution stage unlocks a new chapter"}),e.jsx("li",{children:"• Stories unique to your journey"}),e.jsx("li",{children:"• Learn life lessons through your companion's tale"}),e.jsx("li",{children:"• Prologue + 20 chapters to unlock"})]})]})})]}),Z=()=>{const{companion:a,isLoading:d}=U(),[t,c]=l.useState(0),[r,S]=l.useState(0),[g,j]=l.useState(!1);l.useEffect(()=>{const s=setTimeout(()=>{S(t)},300);return()=>clearTimeout(s)},[t]);const{story:o,allStories:y,isLoading:k,generateStory:x}=A(a?.id,r),{data:f}=$({queryKey:["companion-evolution-image",a?.id,r],queryFn:async()=>{if(!a)return null;try{const{data:s,error:n}=await D.from("companion_evolutions").select("image_url").eq("companion_id",a.id).eq("stage",r).maybeSingle();return n&&n.code!=="PGRST116"&&console.error("Failed to fetch evolution image:",n),s?.image_url?s.image_url:r===0?"/placeholder-egg.svg":a.current_image_url||"/placeholder-companion.svg"}catch(s){return console.error("Error in evolution image query:",s),r===0?"/placeholder-egg.svg":a.current_image_url||"/placeholder-companion.svg"}},enabled:!!a,staleTime:300*1e3,gcTime:1800*1e3,placeholderData:s=>s}),_=l.useCallback(()=>{if(!a){q.error("Companion not loaded. Please refresh the page.");return}x.mutate({companionId:a.id,stage:r})},[a,r,x]),u=l.useCallback(s=>a?s<=a.current_stage:!1,[a]),h=u(r),P=a?Math.min(a.current_stage+1,20):0,L=Array.from({length:P+1},(s,n)=>n);return d?e.jsx(i,{className:"p-8 text-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading your companion's story..."})]})}):a?e.jsxs("div",{className:"space-y-6 max-w-4xl mx-auto p-4",children:[g&&e.jsxs(i,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Chapter Gallery"}),e.jsx(m,{variant:"ghost",size:"sm",onClick:()=>j(!1),children:"Close"})]}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3",children:L.map(s=>{const n=u(s),v=y?.some(T=>T.stage===s);return e.jsx("button",{onClick:()=>{n&&(c(s),j(!1))},disabled:!n,className:`
                    relative aspect-square rounded-lg border-2 p-2 flex flex-col items-center justify-center gap-1 transition-all
                    ${n?"border-primary/30 hover:border-primary hover:bg-primary/5 cursor-pointer":"border-muted bg-muted/30 cursor-not-allowed opacity-50"}
                    ${t===s?"ring-2 ring-primary bg-primary/10":""}
                  `,children:n?e.jsxs(e.Fragment,{children:[e.jsx(p,{className:`w-4 h-4 ${v?"text-primary":"text-muted-foreground"}`}),e.jsx("span",{className:"text-xs font-medium",children:s===0?"P":s}),v&&e.jsx("div",{className:"absolute top-1 right-1 w-2 h-2 rounded-full bg-primary"})]}):e.jsxs(e.Fragment,{children:[e.jsx(w,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:s})]})},s)})})]}),e.jsxs("div",{className:"text-center space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("h1",{className:"text-3xl font-heading font-black bg-gradient-to-r from-primary via-accent to-primary bg-clip-text text-transparent",children:"Story Journal"}),e.jsx(V,{})]}),e.jsx("p",{className:"text-muted-foreground",children:"Your companion's epic journey - unlock new chapters as they evolve"})]}),e.jsxs("div",{className:"flex justify-center items-center gap-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Unlocked: Prologue + ",a.current_stage," Chapters (",y?.length||0," written)"]}),e.jsxs(m,{variant:"outline",size:"sm",onClick:()=>j(!g),children:[e.jsx(z,{className:"w-4 h-4 mr-2"}),g?"Close Gallery":"Gallery"]})]}),e.jsxs(i,{className:"p-6",children:[f&&h&&e.jsx("div",{className:"flex justify-center mb-6",children:e.jsxs("div",{className:"relative w-48 h-48 rounded-2xl overflow-hidden border-2 border-primary/20 shadow-glow",children:[e.jsx("img",{src:f,alt:`${a.spirit_animal} at ${b(r)}`,className:"w-full h-full object-cover",onError:s=>{console.error("Image failed to load:",f),s.currentTarget.src=r===0?"/placeholder-egg.svg":"/placeholder-companion.svg"}}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-background/90 to-transparent p-2",children:e.jsx("p",{className:"text-xs text-center font-medium text-foreground",children:b(r)})})]})}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs(m,{variant:"outline",size:"sm",onClick:()=>c(Math.max(0,t-1)),disabled:t===0,className:"flex-shrink-0 px-2 sm:px-3",children:[e.jsx(E,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline ml-1",children:"Previous"})]}),e.jsxs("div",{className:"text-center min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground truncate",children:r===0?"Prologue":`Chapter ${r}`}),e.jsx("p",{className:"font-semibold text-sm sm:text-base truncate",children:b(r)})]}),e.jsxs(m,{variant:"outline",size:"sm",onClick:()=>{const s=t+1;u(s)&&c(s)},disabled:t===20||!u(t+1),className:"flex-shrink-0 px-2 sm:px-3",children:[e.jsx("span",{className:"hidden sm:inline mr-1",children:"Next"}),e.jsx(F,{className:"w-4 h-4"})]})]}),e.jsx(N,{className:"my-6"}),!h&&e.jsxs(i,{className:"p-8 text-center",children:[e.jsx(w,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Chapter Locked"}),e.jsx("p",{className:"text-muted-foreground",children:r===0?"Complete companion creation to unlock the Prologue":`This chapter unlocks when your companion reaches Stage ${r}`})]}),h&&o?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2 text-center",children:[e.jsxs("h2",{className:"text-2xl font-bold",children:[r===0?"Prologue":`Chapter ${r}`,": ",o.chapter_title]}),e.jsxs("p",{className:"text-lg text-muted-foreground italic",children:['"',o.intro_line,'"']})]}),e.jsx(N,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground",children:[e.jsx(p,{className:"w-4 h-4"}),e.jsx("span",{children:"The Journey"})]}),e.jsx("p",{className:"text-foreground leading-relaxed whitespace-pre-wrap",children:o.main_story})]}),e.jsxs("div",{className:"bg-primary/5 p-4 rounded-lg border border-primary/20",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold mb-2 text-primary",children:[e.jsx(J,{className:"w-4 h-4"}),e.jsx("span",{children:"Bond Moment"})]}),e.jsx("p",{className:"text-sm text-foreground/90",children:o.bond_moment})]}),o.life_lesson&&e.jsxs("div",{className:"bg-amber-500/10 p-4 rounded-lg border border-amber-500/20",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold mb-2 text-amber-600 dark:text-amber-400",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{children:"Wisdom Gained"})]}),e.jsx("p",{className:"text-sm text-foreground/90",children:o.life_lesson})]})]}):h?e.jsxs(i,{className:"p-8 text-center space-y-4",children:[e.jsx(p,{className:"w-16 h-16 mx-auto text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Chapter Not Yet Written"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:r===0?"The beginning of your companion's story awaits...":"Write this chapter of your companion's story to continue the journey."}),e.jsx(m,{onClick:_,disabled:x.isPending||k,className:"w-full max-w-sm mx-auto",children:x.isPending?e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"w-4 h-4 mr-2 animate-spin"}),"Writing chapter..."]}):e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"w-4 h-4 mr-2"}),"Write ",r===0?"Prologue":`Chapter ${r}`]})})]})]}):null]})]}):e.jsxs(i,{className:"p-8 text-center",children:[e.jsx(p,{className:"w-16 h-16 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Create your companion first to unlock the Story Journal"})]})};export{Z as CompanionStoryJournal};
