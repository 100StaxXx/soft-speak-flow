import{r as l,j as e,b2 as B,aJ as F,as as I,a9 as O,cd as P,dq as W,H as D,co as G,m as w,K,cG as H,ax as S}from"./vendor-DK8VKJIv.js";import{ak as $,al as C,am as R,a7 as T,an as b,B as k,a9 as J,ao as _,ap as Q,K as A,e as z,S as L,aq as g,s as q}from"./index-BJ43zXLh.js";import"./date-vendor-BRrA_NVo.js";import"./three-vendor-qI8GXUTd.js";function V(t){if(typeof navigator>"u"||!("mediaSession"in navigator))return;const{mediaSession:r}=navigator;if(t.title&&(r.metadata=new MediaMetadata({title:t.title})),t.onPlay&&r.setActionHandler("play",()=>{t.onPlay?.()}),t.onPause&&r.setActionHandler("pause",()=>{t.onPause?.()}),t.onSeekBackward&&r.setActionHandler("seekbackward",()=>{t.onSeekBackward?.()}),t.onSeekForward&&r.setActionHandler("seekforward",()=>{t.onSeekForward?.()}),t.onPreviousTrack&&r.setActionHandler("previoustrack",()=>{t.onPreviousTrack?.()}),t.onNextTrack&&r.setActionHandler("nexttrack",()=>{t.onNextTrack?.()}),"setPositionState"in r)try{r.setPositionState({duration:0,playbackRate:1,position:0})}catch(s){console.log("[Media Session] Position state not supported:",s)}}function N(t){if(typeof navigator>"u"||!("mediaSession"in navigator))return;const{mediaSession:r}=navigator;if(t.title||t.artist||t.album||t.artwork){const s={};t.title&&(s.title=t.title),t.artist&&(s.artist=t.artist),t.album&&(s.album=t.album),t.artwork&&(s.artwork=t.artwork),r.metadata=new MediaMetadata(s)}if(t.playbackState&&(r.playbackState=t.playbackState),"setPositionState"in r&&(t.position!==void 0||t.duration!==void 0))try{r.setPositionState&&r.setPositionState({duration:t.duration??0,playbackRate:1,position:t.position??0})}catch(s){console.log("[Media Session] Position state update failed:",s)}}function X(){if(typeof navigator>"u"||!("mediaSession"in navigator))return;const{mediaSession:t}=navigator;t.setActionHandler("play",null),t.setActionHandler("pause",null),t.setActionHandler("seekbackward",null),t.setActionHandler("seekforward",null),t.setActionHandler("previoustrack",null),t.setActionHandler("nexttrack",null),t.metadata=null,t.playbackState="none"}const Y=({audioUrl:t,title:r,onTimeUpdate:s})=>{const n=l.useRef(null),[x,m]=l.useState(!1),[y,f]=l.useState(0),[c,d]=l.useState(0);l.useEffect(()=>{const a=$(t);return n.current=a,C&&R.registerAudio(a),V({title:r,onPlay:()=>{a&&!T.getMuted()&&_(a).then(i=>{i&&m(!0)})},onPause:()=>{a&&(a.pause(),m(!1))},onSeekBackward:()=>u(-10),onSeekForward:()=>u(10)}),()=>{n.current&&(n.current.pause(),n.current.src="",C&&R.unregisterAudio(n.current)),X()}},[t,r]),l.useEffect(()=>T.subscribe(i=>{const o=n.current;o&&(o.muted=i,i&&x&&(o.pause(),m(!1)))}),[x]),l.useEffect(()=>{const a=n.current;if(!a)return;const i=()=>{const j=a.currentTime;f(j),s?.(j),N({position:j,duration:a.duration,playbackState:a.paused?"paused":"playing"})},o=()=>{d(a.duration),N({duration:a.duration})},E=()=>{const j=a.currentTime;f(j),s?.(j),N({position:j,duration:a.duration,playbackState:a.paused?"paused":"playing"})},M=()=>{m(!1),N({playbackState:"none"})};return a.addEventListener("timeupdate",i),a.addEventListener("loadedmetadata",o),a.addEventListener("seeked",E),a.addEventListener("ended",M),()=>{a.removeEventListener("timeupdate",i),a.removeEventListener("loadedmetadata",o),a.removeEventListener("seeked",E),a.removeEventListener("ended",M)}},[t,s]);const h=async()=>{const a=n.current;a&&(x?(a.pause(),m(!1),N({playbackState:"paused"})):(T.getMuted()&&T.setMuted(!1),a.muted=!1,await _(a)&&(m(!0),N({playbackState:"playing"}))))},v=a=>{const i=n.current;if(!i)return;const o=a[0];i.currentTime=o,f(o),s?.(o)},u=a=>{const i=n.current;if(!i)return;const o=Math.max(0,Math.min(i.duration,i.currentTime+a));i.currentTime=o,f(o),s?.(o)},p=a=>{if(isNaN(a))return"0:00";const i=Math.floor(a/60),o=Math.floor(a%60);return`${i}:${o.toString().padStart(2,"0")}`};return e.jsx(b,{variant:"elevated",glow:"soft",className:"w-full p-6",children:e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>u(-10),className:"rounded-full h-11 w-11 hover:bg-muted/50 transition-colors","aria-label":"Skip back 10 seconds",children:e.jsx(B,{className:"h-5 w-5"})}),e.jsx(k,{variant:"default",size:"icon",onClick:h,className:"h-16 w-16 rounded-full bg-gradient-to-br from-primary via-primary to-stardust-gold/70 hover:shadow-glow transition-all duration-300 hover:scale-105","aria-label":x?"Pause":"Play",children:x?e.jsx(F,{className:"h-7 w-7",fill:"currentColor"}):e.jsx(I,{className:"h-7 w-7 ml-1",fill:"currentColor"})}),e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>u(10),className:"rounded-full h-11 w-11 hover:bg-muted/50 transition-colors","aria-label":"Skip forward 10 seconds",children:e.jsx(O,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"relative",children:e.jsx(J,{value:[y],max:c||100,step:.1,onValueChange:v,className:"w-full [&_[role=slider]]:bg-gradient-to-r [&_[role=slider]]:from-primary [&_[role=slider]]:to-stardust-gold [&_[role=slider]]:border-0 [&_[role=slider]]:shadow-glow"})}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground font-medium",children:[e.jsx("span",{children:p(y)}),e.jsx("span",{children:p(c)})]})]})]})})},Z=({transcript:t,currentTime:r,className:s})=>{const[n,x]=l.useState(-1),m=l.useRef(null),y=l.useRef(null),f=l.useMemo(()=>[...t].sort((c,d)=>c.start-d.start||c.end-d.end),[t]);return l.useEffect(()=>{x(c=>Q(f,r,c))},[r,f]),l.useEffect(()=>{if(!(n<0)&&y.current&&m.current){const c=m.current,d=y.current,h=c.getBoundingClientRect(),v=d.getBoundingClientRect(),u=v.top-h.top,a=h.height*.3;if(u>a||v.bottom>h.bottom||v.top<h.top){const i=d.offsetTop-c.offsetTop-a;c.scrollTo({top:Math.max(0,i),behavior:"smooth"})}}},[n]),!t||t.length===0?e.jsxs(b,{variant:"default",glow:"soft",className:A("p-6",s),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(P,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("h3",{className:"font-heading text-sm font-semibold text-muted-foreground uppercase tracking-wide",children:"Transcript"})]}),e.jsx("p",{className:"text-muted-foreground text-center italic py-4",children:"No transcript available for this pep talk."})]}):e.jsxs(b,{variant:"default",glow:"soft",className:A("p-6",s),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(P,{className:"h-4 w-4 text-stardust-gold"}),e.jsx("h3",{className:"font-heading text-sm font-semibold text-muted-foreground uppercase tracking-wide",children:"Transcript"})]}),e.jsx("div",{ref:m,className:"max-h-[300px] overflow-y-auto scroll-smooth pr-2 scrollbar-thin scrollbar-thumb-muted scrollbar-track-transparent",children:e.jsx("div",{className:"text-base leading-relaxed",children:f.map((c,d)=>e.jsxs("span",{ref:d===n?y:null,className:A("transition-all duration-200 px-0.5 py-0.5 rounded",d===n?"bg-stardust-gold/30 text-foreground font-semibold shadow-[0_0_8px_rgba(255,215,0,0.3)]":d<n?"text-muted-foreground/70":"text-muted-foreground"),children:[c.word," "]},d))})})]})},se=()=>{const{id:t}=W(),r=D(),[s,n]=l.useState(null),[x,m]=l.useState(!0),[y,f]=l.useState(0),[c,d]=l.useState(!1),h=async u=>{try{const{data:p,error:a}=await q.from("pep_talks").select("*").eq("id",u).maybeSingle();if(a)throw a;const i=Array.isArray(p.transcript)?p.transcript:[],o={...p,transcript:i};n(o)}catch(p){console.error("Error fetching pep talk:",p),S.error("Failed to load pep talk"),r("/pep-talks")}finally{m(!1)}};l.useEffect(()=>{t&&h(t)},[t]);const v=async()=>{if(!(!s||!t)){d(!0),S.info("Transcribing audio... This may take a minute.");try{const{data:u,error:p}=await q.functions.invoke("transcribe-audio",{body:{audioUrl:s.audio_url,pepTalkId:t}});if(p)throw p;if(u?.transcript&&Array.isArray(u.transcript))S.success("Transcript is ready!"),await h(t);else throw new Error("No transcript data returned")}catch(u){console.error("Transcription error:",u),S.error("Failed to prepare transcript")}finally{d(!1)}}};return x?e.jsxs(z,{children:[e.jsx(L,{}),e.jsxs("div",{className:"min-h-screen pb-nav-safe relative z-10",children:[e.jsx("div",{className:"sticky top-0 z-50 cosmiq-glass-header border-b border-cosmiq-glow/10",children:e.jsx("div",{className:"max-w-lg mx-auto px-4 py-3 pt-safe",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(g,{className:"h-9 w-9 rounded-full"}),e.jsx(g,{className:"h-5 w-24"})]})})}),e.jsxs("div",{className:"max-w-lg mx-auto px-4 py-6 space-y-6",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(g,{className:"h-6 w-24 mx-auto rounded-full"}),e.jsx(g,{className:"h-10 w-3/4 mx-auto"})]}),e.jsx(b,{variant:"elevated",className:"p-6",children:e.jsx(g,{className:"h-24 w-full"})}),e.jsxs(b,{variant:"default",className:"p-6",children:[e.jsxs("div",{className:"flex justify-center gap-4 mb-4",children:[e.jsx(g,{className:"h-10 w-10 rounded-full"}),e.jsx(g,{className:"h-16 w-16 rounded-full"}),e.jsx(g,{className:"h-10 w-10 rounded-full"})]}),e.jsx(g,{className:"h-2 w-full rounded-full"})]})]})]})]}):s?e.jsxs(z,{children:[e.jsx(L,{}),e.jsxs("div",{className:"min-h-screen pb-nav-safe relative z-10",children:[e.jsx("div",{className:"sticky top-0 z-50 cosmiq-glass-header border-b border-cosmiq-glow/10",children:e.jsx("div",{className:"max-w-lg mx-auto px-4 py-3 pt-safe",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(k,{variant:"ghost",size:"icon",onClick:()=>r("/pep-talks"),className:"rounded-full h-9 w-9 bg-muted/30 hover:bg-muted/50",children:e.jsx(G,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-sm font-medium text-muted-foreground truncate",children:s.category})]})})}),e.jsx("div",{className:"max-w-lg mx-auto px-4 py-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(w.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:"text-center",children:e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-4 py-1.5 rounded-full bg-gradient-to-r from-primary/20 to-stardust-gold/20 border border-cosmiq-glow/20 text-sm font-medium",children:[e.jsx(K,{className:"h-3.5 w-3.5 text-stardust-gold"}),s.category]})}),e.jsx(w.h1,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3,delay:.1},className:"font-heading text-3xl md:text-4xl font-bold text-center leading-tight",children:s.title}),e.jsx(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4,delay:.2},children:e.jsxs(b,{variant:"hero",glow:"accent",className:"p-6 relative overflow-hidden",children:[e.jsx("div",{className:"absolute -top-4 -left-4 w-24 h-24 bg-stardust-gold/20 rounded-full blur-2xl"}),e.jsx("div",{className:"absolute -bottom-4 -right-4 w-20 h-20 bg-primary/20 rounded-full blur-xl"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx(H,{className:"h-8 w-8 text-stardust-gold mb-3 opacity-60"}),e.jsx("p",{className:"font-heading text-xl md:text-2xl italic leading-relaxed text-foreground/90",children:s.quote}),e.jsx("div",{className:"flex justify-end mt-3",children:e.jsx(H,{className:"h-8 w-8 text-stardust-gold opacity-60 rotate-180"})})]})]})}),e.jsx(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4,delay:.3},children:e.jsx(Y,{audioUrl:s.audio_url,title:s.title,onTimeUpdate:f})}),(!s.transcript||s.transcript.length===0)&&e.jsx(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4,delay:.4},children:e.jsx(b,{variant:"elevated",glow:"soft",className:"p-6",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"h-14 w-14 mx-auto rounded-full bg-gradient-to-br from-primary/20 to-stardust-gold/20 flex items-center justify-center",children:e.jsx(P,{className:"h-7 w-7 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"No Transcript Available"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Prepare a word-by-word transcript with timestamps"}),e.jsx(k,{onClick:v,disabled:c,className:"w-full bg-gradient-to-r from-primary to-primary/80 hover:shadow-glow transition-all",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin mr-2 h-4 w-4 border-2 border-current border-t-transparent rounded-full"}),"Transcribing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(P,{className:"mr-2 h-4 w-4"}),"Prepare Transcript"]})})]})]})})}),s.transcript&&s.transcript.length>0&&e.jsx(w.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4,delay:.4},children:e.jsx(Z,{transcript:s.transcript,currentTime:y})})]})})]})]}):null};export{se as default};
