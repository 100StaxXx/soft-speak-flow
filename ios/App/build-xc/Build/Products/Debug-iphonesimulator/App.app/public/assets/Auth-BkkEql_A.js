import{r as o,H as ne,a_ as le,o as f,j as t,d7 as ce,d8 as $,d9 as ue,da as de}from"./vendor-CkzXtEGd.js";import{s as O}from"./nativeNavigation-o1P4gnIN.js";import{u as he,l as n,s as c,L as T,a as C,B as v}from"./index-B9iotTKE.js";import{e as pe,g as ge}from"./authRedirect-B8iaSKfJ.js";import{g as _,a as me}from"./redirectUrl-BJoiu_Ib.js";import{S as fe,s as we}from"./StaticBackgroundImage-DD6vqQ2B.js";import"./date-vendor-CuPqBTxb.js";import"./three-vendor-qI8GXUTd.js";const Ae=ue({email:$().trim().toLowerCase().email("Invalid email address").min(3,"Email too short").max(255,"Email too long").regex(/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,"Invalid email format"),password:$().min(8,"Password must be at least 8 characters").max(100,"Password too long").regex(/^(?=.*[a-zA-Z])(?=.*[0-9]|.*[!@#$%^&*])/,"Password must contain letters and at least one number or special character"),confirmPassword:$().optional()}).refine(u=>u.confirmPassword!==void 0?u.password===u.confirmPassword:!0,{message:"Passwords do not match",path:["confirmPassword"]}),Ee=()=>{const[u,W]=o.useState(!0),[x,S]=o.useState(!1),[k,N]=o.useState(""),[I,Y]=o.useState(""),[q,B]=o.useState(""),[A,P]=o.useState(!1),[M,G]=o.useState(null),w=ne(),H=le(),{toast:l}=he(),ee=we,h=o.useCallback(async(a,e)=>{const r=Date.now();if(n.info(`[Auth ${e}] handlePostAuthNavigation START`,{hasSession:!!a,hasRedirected:p.current,userId:a?.user?.id?.substring(0,8)}),!a||p.current){n.info(`[Auth ${e}] Skipping - session: ${!!a}, hasRedirected: ${p.current}`);return}p.current=!0;const s=5e3;let i=!1;const d=setTimeout(async()=>{if(!i){n.warn(`[Auth ${e}] TIMEOUT after ${s}ms - checking if returning user`),l({title:"Taking longer than expected",description:"Redirecting you now..."});try{const{data:g}=await c.from("profiles").select("onboarding_completed").eq("id",a.user.id).maybeSingle(),E=g?.onboarding_completed?"/tasks":"/onboarding";O(w,E)}catch{O(w,"/onboarding")}}},s);try{n.info(`[Auth ${e}] Calling ensureProfile...`);const g=Date.now();await pe(a.user.id,a.user.email),n.info(`[Auth ${e}] ensureProfile completed in ${Date.now()-g}ms`),n.info(`[Auth ${e}] Calling getAuthRedirectPath...`);const E=Date.now(),b=await ge(a.user.id);n.info(`[Auth ${e}] getAuthRedirectPath returned "${b}" in ${Date.now()-E}ms`),i=!0,clearTimeout(d),n.info(`[Auth ${e}] Navigating to ${b} (total time: ${Date.now()-r}ms)`),O(w,b),n.info(`[Auth ${e}] safeNavigate called successfully`)}catch(g){i=!0,clearTimeout(d),p.current=!1,n.error(`[Auth ${e}] Navigation error after ${Date.now()-r}ms`,{error:g}),O(w,"/onboarding")}},[w,l]),Z=o.useRef(null),R=o.useRef(null),p=o.useRef(!1),V=o.useRef(!1),[K,D]=o.useState(!1),[J,F]=o.useState(!1);o.useEffect(()=>{H.pathname==="/auth"&&p.current&&(p.current=!1)},[H.pathname]),o.useEffect(()=>{if(V.current)return;(async()=>{if(f.isNativePlatform()&&f.isPluginAvailable("SocialLogin"))try{const e="371878262982-tjcop6qvno6nsl68vurt44211g1835cp.apps.googleusercontent.com",r="371878262982-msdt2oq5rl858ft64d33onhrg5l67ofu.apps.googleusercontent.com";n.debug("[OAuth Init] Initializing with",{hasWebClientId:!!e,hasIOSClientId:!!r}),await ce.initialize({google:{webClientId:e,iOSClientId:r,mode:"online"}}),n.info("[OAuth Init] SocialLogin initialized successfully"),D(!0)}catch(e){n.error("[OAuth Init] Failed to initialize SocialLogin",{error:e}),D(!1)}else n.warn("[OAuth Init] SocialLogin plugin unavailable - using web OAuth fallback"),D(!1);V.current=!0})()},[]),o.useEffect(()=>{if(!f.isNativePlatform()){F(!1);return}if((f.getPlatform?.()??"web")!=="ios"){F(!1);return}const e=f.isPluginAvailable?.("SignInWithApple")??!1;e||n.warn("[OAuth Init] SignInWithApple plugin unavailable - falling back to web OAuth for Apple"),F(e)},[]),o.useEffect(()=>{(async()=>{if(typeof window>"u"||p.current)return;const e=new URL(window.location.href),r=e.hash.includes("access_token"),s=e.searchParams.get("code");if(!(!s&&!r))try{if(s){const{data:i,error:d}=await c.auth.exchangeCodeForSession(s);if(d)throw d;await h(i.session,"oauthCodeExchange")}else{const{data:{session:i}}=await c.auth.getSession();i&&await h(i,"oauthHashSession")}}catch(i){n.error("[OAuth Callback] Failed to complete OAuth login",{error:i}),l({title:"Error",description:"Something went wrong signing you in. Please try again.",variant:"destructive"})}finally{if(s){e.searchParams.delete("code");const i=`${e.pathname}${e.search}${e.hash}`;window.history.replaceState(window.history.state,"",i)}else r&&(window.location.hash="")}})()},[h,l]),o.useEffect(()=>{(async()=>{const{data:{session:r}}=await c.auth.getSession();r&&await h(r,"checkSession")})();const{data:{subscription:e}}=c.auth.onAuthStateChange(async(r,s)=>{if(["SIGNED_IN","TOKEN_REFRESHED","INITIAL_SESSION"].includes(r)&&s){if(p.current){n.debug(`[Auth onAuthStateChange] Skipping ${r} - already redirected`);return}const i=Date.now();n.info(`[Auth onAuthStateChange] Event: ${r} at ${i}, redirecting...`),await new Promise(d=>setTimeout(d,100)),await h(s,`onAuthStateChange:${r}`)}});return()=>{e.unsubscribe(),Z.current&&clearTimeout(Z.current),R.current&&clearTimeout(R.current)}},[h]);const te=async a=>{a.preventDefault();const e=k.trim().toLowerCase(),r=Ae.safeParse({email:e,password:I,confirmPassword:u?void 0:q});if(!r.success){l({title:"Validation Error",description:r.error.errors[0].message,variant:"destructive"});return}P(!0);try{if(u){const{error:s}=await c.auth.signInWithPassword({email:e,password:I});if(s)throw s;const{data:{session:i}}=await c.auth.getSession();await h(i,"passwordSignIn")}else{const{data:s,error:i}=await c.auth.signUp({email:e,password:I,options:{emailRedirectTo:_("/"),data:{timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}}});if(i)throw i.message.includes("already registered")?new Error("This email is already registered. Please sign in instead."):i;s?.session?await h(s.session,"signUpImmediate"):l({title:"Check your email",description:"We've sent you a confirmation link to complete your registration."})}}catch(s){l({title:"Error",description:s.message,variant:"destructive"})}finally{P(!1)}},ae=async a=>{a.preventDefault();const e=k.trim().toLowerCase();if(!e){l({variant:"destructive",title:"Email Required",description:"Please enter your email address"});return}if(!$().email().safeParse(e).success){l({variant:"destructive",title:"Invalid Email",description:"Please enter a valid email address"});return}P(!0);try{const{error:s}=await c.auth.resetPasswordForEmail(e,{redirectTo:_("/auth/reset-password")});s?l({variant:"destructive",title:"Error",description:s.message}):(l({title:"Check your email",description:"We've sent you a password reset link"}),S(!1),N(""))}catch(s){l({variant:"destructive",title:"Error",description:s.message||"An unexpected error occurred"})}finally{P(!1)}},se=async a=>{G(a),console.log(`[OAuth Debug] Starting ${a} sign-in flow`),console.log(`[OAuth Debug] Platform: ${f.isNativePlatform()?"Native":"Web"}`);try{const e=f.isNativePlatform(),r=f.getPlatform?.()??"web",s=a==="google"?e:e&&r==="ios";if(a==="apple"&&s&&J){console.log("[Apple OAuth] Initiating native Apple sign-in");const g=crypto.randomUUID();console.log("[Apple OAuth] Raw nonce generated:",g.substring(0,8)+"...");const b=new TextEncoder().encode(g),re=await crypto.subtle.digest("SHA-256",b),Q=Array.from(new Uint8Array(re)).map(z=>z.toString(16).padStart(2,"0")).join("");console.log("[Apple OAuth] Hashed nonce:",Q.substring(0,16)+"..."),console.log("[Apple OAuth] Calling SignInWithApple.authorize with clientId: com.darrylgraham.revolution");const y=await de.authorize({clientId:"com.darrylgraham.revolution",redirectURI:"com.darrylgraham.revolution://",scopes:"email name",state:crypto.randomUUID(),nonce:Q});if(console.log("[Apple OAuth] SignInWithApple result:",{hasIdentityToken:!!y.response.identityToken,hasEmail:!!y.response.email,hasUser:!!y.response.user}),!y.response.identityToken)throw console.error("[Apple OAuth] No identity token in response"),new Error("Apple Sign-In failed - no identity token returned");console.log("[Apple OAuth] Calling apple-native-auth edge function");const{data:m,error:L}=await c.functions.invoke("apple-native-auth",{body:{identityToken:y.response.identityToken}});if(console.log("[Apple OAuth] Edge function response:",{hasAccessToken:!!m?.access_token,hasRefreshToken:!!m?.refresh_token,error:L?.message,errorCode:m?.code}),L){if(m?.code==="APPLE_EMAIL_MISSING"){console.warn("[Apple OAuth] Missing email for Apple ID, prompting user to re-register"),l({title:"Finish setting up Apple Sign-In",description:"We couldn’t create an account with your Apple ID. Open Settings → Apple ID → Password & Security → Sign in with Apple, remove Revolution, then try again to share your email."}),W(!0),S(!1);return}throw new Error(m?.error||L.message||"Apple Sign-In failed")}if(!m?.access_token||!m?.refresh_token)throw new Error("Failed to get session tokens from edge function");const{error:X,data:{session:ie}}=await c.auth.setSession({access_token:m.access_token,refresh_token:m.refresh_token});if(X)throw X;const{data:{session:oe}}=await c.auth.getSession(),j=ie??oe;if(!j)throw new Error("Failed to establish Supabase session after Apple sign-in");const U=Date.now();console.log(`[Apple OAuth] Session set successfully at ${U}, proceeding to navigation`),await h(j,"appleNative"),j.user&&(R.current=setTimeout(async()=>{try{if(window.location.pathname!=="/auth"){console.log(`[Apple OAuth Fallback] Already redirected, skipping (${Date.now()-U}ms since session set)`);return}console.log(`[Apple OAuth Fallback] Executing manual redirect at ${Date.now()} (${Date.now()-U}ms since session set)`),await h(j,"appleNativeFallback")}catch(z){console.error("[Apple OAuth Fallback] Error during redirect:",z),w("/onboarding")}},800));return}s&&((a==="google"?K:J)||console.warn(`[${a} OAuth] Native plugin unavailable - falling back to web flow`)),console.log(`[${a} OAuth] Using web OAuth flow`),console.log(`[${a} OAuth] Redirect URL:`,me());const{data:i,error:d}=await c.auth.signInWithOAuth({provider:a,options:{redirectTo:_("/")}});if(console.log(`[${a} OAuth] OAuth response:`,{hasUrl:!!i?.url,provider:i?.provider,error:d?.message}),d)throw d}catch(e){if(console.error(`[${a} OAuth] Error caught:`,{message:e.message,code:e.code,status:e.status,fullError:e}),e.message?.includes("1001")||e.message?.includes("cancel")){console.log(`[${a} OAuth] User cancelled sign-in`);return}l({title:"Error",description:e.message||"Failed to sign in. Please try again.",variant:"destructive"})}finally{G(null)}};return t.jsxs("div",{className:"min-h-screen relative",children:[t.jsx(fe,{background:ee}),t.jsxs("section",{id:"auth-form",className:"min-h-screen relative flex items-center justify-center pt-safe-top pb-safe-bottom",children:[t.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-background/40 via-background/20 to-background/50"}),t.jsx("div",{className:"relative z-10 w-full px-6 md:max-w-md space-y-8",children:t.jsxs("div",{className:"space-y-6",children:[x?t.jsxs("form",{onSubmit:ae,className:"space-y-5",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(T,{htmlFor:"email",className:"text-steel text-sm uppercase tracking-wide",children:"Email"}),t.jsx(C,{id:"email",type:"email",placeholder:"your@email.com",value:k,onChange:a=>N(a.target.value),required:!0,className:"bg-obsidian/50 border-royal-purple/30 text-pure-white h-12 focus:border-royal-purple"})]}),t.jsx(v,{type:"submit",className:"w-full bg-royal-purple hover:bg-accent-purple text-pure-white font-bold h-12 text-lg",disabled:A,children:A?"Sending...":"Send Reset Link"})]}):t.jsxs("form",{onSubmit:te,className:"space-y-5",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(T,{htmlFor:"email",className:"text-steel text-sm uppercase tracking-wide",children:"Email"}),t.jsx(C,{id:"email",type:"email",placeholder:"your@email.com",value:k,onChange:a=>N(a.target.value),required:!0,className:"bg-obsidian/50 border-royal-purple/30 text-pure-white h-12 focus:border-royal-purple"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(T,{htmlFor:"password",className:"text-steel text-sm uppercase tracking-wide",children:"Password"}),t.jsx(C,{id:"password",type:"password",placeholder:"••••••••",value:I,onChange:a=>Y(a.target.value),required:!0,className:"bg-obsidian/50 border-royal-purple/30 text-pure-white h-12 focus:border-royal-purple"}),u&&t.jsx("button",{type:"button",onClick:()=>S(!0),className:"text-xs text-pure-white/70 hover:text-pure-white transition-colors",children:"Forgot password?"})]}),!u&&t.jsxs("div",{className:"space-y-2",children:[t.jsx(T,{htmlFor:"confirmPassword",className:"text-steel text-sm uppercase tracking-wide",children:"Confirm Password"}),t.jsx(C,{id:"confirmPassword",type:"password",placeholder:"••••••••",value:q,onChange:a=>B(a.target.value),required:!0,className:"bg-obsidian/50 border-royal-purple/30 text-pure-white h-12 focus:border-royal-purple"})]}),t.jsx(v,{type:"submit",className:"w-full bg-royal-purple hover:bg-accent-purple text-pure-white font-bold h-12 text-lg",disabled:A,children:A?"Loading...":u?"Sign In":"Get Started"})]}),!x&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"relative my-6",children:[t.jsx("div",{className:"absolute inset-0 flex items-center",children:t.jsx("div",{className:"w-full border-t border-white/20"})}),t.jsx("div",{className:"relative flex justify-center text-sm",children:t.jsx("span",{className:"bg-card px-4 text-white/60",children:"or"})})]}),t.jsx(v,{type:"button",onClick:()=>se("apple"),disabled:A||M!==null,className:"w-full bg-white hover:bg-white/90 text-black font-semibold h-12 text-base flex items-center justify-center gap-3 rounded-xl",children:M==="apple"?t.jsx("div",{className:"animate-spin h-5 w-5 border-2 border-black/20 border-t-black rounded-full"}):t.jsxs(t.Fragment,{children:[t.jsx("svg",{className:"h-5 w-5",viewBox:"0 0 24 24",fill:"currentColor",children:t.jsx("path",{d:"M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"})}),u?"Sign in with Apple":"Sign up with Apple"]})})]}),t.jsxs("div",{className:"text-center space-y-3",children:[t.jsx(v,{variant:"link",onClick:()=>{x?(S(!1),N("")):(W(!u),B(""))},className:"text-pure-white/90 hover:text-stardust-gold underline underline-offset-4",children:x?"Back to Sign In":u?"Need an account? Sign up":"Already have an account? Sign in"}),t.jsx("div",{className:"pt-2",children:t.jsx(v,{variant:"ghost",onClick:()=>w("/preview"),className:"text-muted-foreground hover:text-foreground text-sm",children:"Continue as Guest"})})]})]})})]})]})};export{Ee as default};
