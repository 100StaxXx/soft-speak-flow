import{v as N,H as E,u as C,aB as S,aA as f,j as e,aW as A,cp as B}from"./vendor-CkzXtEGd.js";import{b as K,s,d as Q,e as x,f as b,H,J,K as P,F as k,B as F,a8 as L}from"./index-B9iotTKE.js";import"./date-vendor-CuPqBTxb.js";import"./three-vendor-qI8GXUTd.js";const y=2;function D(){const{user:t}=K(),c=N(),j=E(),{data:o,isLoading:_}=C({queryKey:["public-epics"],queryFn:async()=>{const{data:i,error:n}=await s.from("epics").select(`
          *,
          epic_habits(
            habit:habits(id, title, difficulty, frequency, custom_days)
          )
        `).eq("is_public",!0).eq("status","active").order("created_at",{ascending:!1});if(n)throw n;return i}}),d=S({mutationFn:async i=>{if(!t?.id)throw new Error("Not authenticated");const{data:n}=await s.from("epics").select("id").eq("user_id",t.id).eq("status","active"),{data:w}=await s.from("epic_members").select("epic_id, epics!inner(user_id, status)").eq("user_id",t.id).neq("epics.user_id",t.id).eq("epics.status","active");if((n?.length||0)+(w?.length||0)>=y)throw new Error(`You can only have ${y} active epics at a time. Complete or abandon an epic to join a new one.`);const{data:r,error:u}=await s.from("epics").select(`
          *,
          epic_habits(
            habit:habits(id, title, difficulty, frequency, custom_days)
          )
        `).eq("id",i).eq("is_public",!0).maybeSingle();if(u)throw u;if(!r)throw new Error("Epic not found");const{data:g}=await s.from("epic_members").select("id").eq("epic_id",i).eq("user_id",t.id).maybeSingle();if(g)throw new Error("You're already part of this guild!");const{error:m}=await s.from("epic_members").insert({epic_id:i,user_id:t.id});if(m)throw m;if(r.epic_habits&&r.epic_habits.length>0){const v=r.epic_habits.map(a=>({user_id:t.id,title:a.habit.title,difficulty:a.habit.difficulty,frequency:a.habit.frequency||"daily",custom_days:a.habit.custom_days||null})),{data:l,error:h}=await s.from("habits").insert(v).select();if(h)throw h;if(l&&l.length>0){const a=l.map(q=>({epic_id:i,habit_id:q.id})),{error:p}=await s.from("epic_habits").insert(a);if(p)throw p}}return r},onSuccess:()=>{c.invalidateQueries({queryKey:["epics"]}),c.invalidateQueries({queryKey:["habits"]}),c.invalidateQueries({queryKey:["public-epics"]}),f.success("Guild joined! ðŸŽ¯",{description:"You're now part of this guild and can compete on the leaderboard!"}),j("/journeys")},onError:i=>{f.error(i.message)}});return e.jsxs(Q,{children:[e.jsx("div",{className:"min-h-screen pb-nav-safe pt-safe px-4",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-6",children:[e.jsx(A,{className:"h-8 w-8 text-primary"}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Community Epics"}),e.jsx("p",{className:"text-muted-foreground",children:"Join shared goals from the community"})]})]}),_?e.jsx("div",{className:"text-center py-12",children:"Loading community epics..."}):!o||o.length===0?e.jsx(x,{children:e.jsxs(b,{className:"py-12 text-center",children:[e.jsx(B,{className:"h-12 w-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"No public epics yet"})]})}):e.jsx("div",{className:"space-y-4",children:o.map(i=>e.jsxs(x,{children:[e.jsx(H,{children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx(J,{children:i.title}),e.jsx(P,{className:"mt-2",children:i.description})]}),e.jsxs(k,{variant:"secondary",className:"ml-2",children:[i.target_days," days"]})]})}),e.jsx(b,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:[i.epic_habits?.length||0," habits included"]}),e.jsx(F,{onClick:()=>d.mutate(i.id),disabled:d.isPending,size:"sm",children:d.isPending?"Joining...":"Join Guild"})]})})]},i.id))})]})}),e.jsx(L,{})]})}export{D as default};
