import{v as F,u as C,aB as $,aA as u,r as d,j as e,ea as P,bp as z,aS as b,L as q,ap as J,cj as K,az as B,af as R,bm as U,aa as A,K as M}from"./vendor-CkzXtEGd.js";import{b as Q,s as N,G as D,aT as V,aU as W,aV as Y,c as H,e as m,B as g,bC as S}from"./index-B9iotTKE.js";import"./date-vendor-CuPqBTxb.js";import"./three-vendor-qI8GXUTd.js";const O=(s,i)=>{const{user:n}=Q(),c=F(),{data:r,isLoading:v}=C({queryKey:["companion-story",s,i],queryFn:async()=>{if(!s||i===void 0)return null;const{data:t,error:o}=await N.from("companion_stories").select("*").eq("companion_id",s).eq("stage",i).maybeSingle();if(o)throw console.error("Failed to fetch companion story:",o),o;return t},enabled:!!s&&i!==void 0,placeholderData:t=>t,staleTime:120*1e3}),{data:x}=C({queryKey:["companion-stories-all",s],queryFn:async()=>{if(!s)return[];const{data:t,error:o}=await N.from("companion_stories").select("*").eq("companion_id",s).order("stage",{ascending:!0});if(o)throw o;return t},enabled:!!s}),h=$({mutationFn:async t=>{if(!n)throw new Error("Not authenticated");u.loading("Your story is being written...",{id:"story-gen"});const{data:o,error:p}=await N.functions.invoke("generate-companion-story",{body:{companionId:t.companionId,stage:t.stage}});if(p)throw console.error("Story generation error:",p),new Error("Unable to write your story right now. Please try again.");return o},onSuccess:()=>{u.dismiss("story-gen"),u.success("ðŸ“– New chapter unlocked!"),c.invalidateQueries({queryKey:["companion-story"]}),c.invalidateQueries({queryKey:["companion-stories-all"]})},onError:t=>{u.dismiss("story-gen"),console.error("Story generation failed:",t),u.error(t instanceof Error?t.message:"Something went wrong. Please try again.")}});return{story:r,allStories:x,isLoading:v,generateStory:h}},k=d.forwardRef(({className:s,orientation:i="horizontal",decorative:n=!0,...c},r)=>e.jsx(P,{ref:r,decorative:n,orientation:i,className:D("shrink-0 bg-border",i==="horizontal"?"h-[1px] w-full":"h-full w-[1px]",s),...c}));k.displayName=P.displayName;const I=()=>e.jsxs(V,{children:[e.jsx(W,{asChild:!0,children:e.jsx("button",{className:"p-1 rounded-full hover:bg-primary/10 transition-colors",children:e.jsx(z,{className:"h-4 w-4 text-muted-foreground"})})}),e.jsx(Y,{side:"bottom",className:"max-w-xs",children:e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsx("p",{className:"font-semibold",children:"Story Journal"}),e.jsxs("ul",{className:"space-y-1 text-muted-foreground",children:[e.jsx("li",{children:"â€¢ Each evolution stage unlocks a new chapter"}),e.jsx("li",{children:"â€¢ Stories unique to your journey"}),e.jsx("li",{children:"â€¢ Learn life lessons through your companion's tale"}),e.jsx("li",{children:"â€¢ Prologue + 20 chapters to unlock"})]})]})})]}),ae=()=>{const{companion:s,isLoading:i}=H(),[n,c]=d.useState(0),[r,v]=d.useState(0),[x,h]=d.useState(!1);d.useEffect(()=>{const a=setTimeout(()=>{v(n)},300);return()=>clearTimeout(a)},[n]);const{story:t,allStories:o,isLoading:p,generateStory:f}=O(s?.id,r),{data:w,isLoading:X}=C({queryKey:["companion-evolution-image",s?.id,r],queryFn:async()=>{if(!s)return null;try{const{data:a,error:l}=await N.from("companion_evolutions").select("image_url").eq("companion_id",s.id).eq("stage",r).maybeSingle();return l&&l.code!=="PGRST116"&&console.error("Failed to fetch evolution image:",l),a?.image_url?a.image_url:r===0?"/placeholder-egg.svg":s.current_image_url||"/placeholder-companion.svg"}catch(a){return console.error("Error in evolution image query:",a),r===0?"/placeholder-egg.svg":s.current_image_url||"/placeholder-companion.svg"}},enabled:!!s,staleTime:300*1e3,gcTime:1800*1e3,placeholderData:a=>a}),L=d.useCallback(()=>{if(!s){u.error("Companion not loaded. Please refresh the page.");return}f.mutate({companionId:s.id,stage:r})},[s,r,f]),j=d.useCallback(a=>s?a<=s.current_stage:!1,[s]),y=j(r),T=s?Math.min(s.current_stage+1,20):0,G=Array.from({length:T+1},(a,l)=>l);return i?e.jsx(m,{className:"p-8 text-center",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[e.jsx("div",{className:"inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-primary"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading your companion's story..."})]})}):s?e.jsxs("div",{className:"space-y-6 max-w-4xl mx-auto p-4",children:[x&&e.jsxs(m,{className:"p-6",children:[e.jsxs("div",{className:"flex items-center justify-between mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Chapter Gallery"}),e.jsx(g,{variant:"ghost",size:"sm",onClick:()=>h(!1),children:"Close"})]}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3",children:G.map(a=>{const l=j(a),_=o?.some(E=>E.stage===a);return e.jsx("button",{onClick:()=>{l&&(c(a),h(!1))},disabled:!l,className:`
                    relative aspect-square rounded-lg border-2 p-2 flex flex-col items-center justify-center gap-1 transition-all
                    ${l?"border-primary/30 hover:border-primary hover:bg-primary/5 cursor-pointer":"border-muted bg-muted/30 cursor-not-allowed opacity-50"}
                    ${n===a?"ring-2 ring-primary bg-primary/10":""}
                  `,children:l?e.jsxs(e.Fragment,{children:[e.jsx(b,{className:`w-4 h-4 ${_?"text-primary":"text-muted-foreground"}`}),e.jsx("span",{className:"text-xs font-medium",children:a===0?"P":a}),_&&e.jsx("div",{className:"absolute top-1 right-1 w-2 h-2 rounded-full bg-primary"})]}):e.jsxs(e.Fragment,{children:[e.jsx(q,{className:"w-4 h-4 text-muted-foreground"}),e.jsx("span",{className:"text-xs text-muted-foreground",children:a})]})},a)})})]}),e.jsxs("div",{className:"text-center space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx("h1",{className:"text-3xl font-heading font-black bg-gradient-to-r from-primary via-accent to-primary bg-clip-text text-transparent",children:"Story Journal"}),e.jsx(I,{})]}),e.jsx("p",{className:"text-muted-foreground",children:"Your companion's epic journey - unlock new chapters as they evolve"})]}),e.jsxs("div",{className:"flex justify-center items-center gap-4",children:[e.jsxs("div",{className:"text-sm text-muted-foreground",children:["Unlocked: Prologue + ",s.current_stage," Chapters (",o?.length||0," written)"]}),e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>h(!x),children:[e.jsx(J,{className:"w-4 h-4 mr-2"}),x?"Close Gallery":"Gallery"]})]}),e.jsxs(m,{className:"p-6",children:[w&&y&&e.jsx("div",{className:"flex justify-center mb-6",children:e.jsxs("div",{className:"relative w-48 h-48 rounded-2xl overflow-hidden border-2 border-primary/20 shadow-glow",children:[e.jsx("img",{src:w,alt:`${s.spirit_animal} at ${S(r)}`,className:"w-full h-full object-cover",onError:a=>{console.error("Image failed to load:",w),a.currentTarget.src=r===0?"/placeholder-egg.svg":"/placeholder-companion.svg"}}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-background/90 to-transparent p-2",children:e.jsx("p",{className:"text-xs text-center font-medium text-foreground",children:S(r)})})]})}),e.jsxs("div",{className:"flex items-center justify-between gap-2",children:[e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>c(Math.max(0,n-1)),disabled:n===0,className:"flex-shrink-0 px-2 sm:px-3",children:[e.jsx(K,{className:"w-4 h-4"}),e.jsx("span",{className:"hidden sm:inline ml-1",children:"Previous"})]}),e.jsxs("div",{className:"text-center min-w-0 flex-1",children:[e.jsx("p",{className:"text-xs sm:text-sm text-muted-foreground truncate",children:r===0?"Prologue":`Chapter ${r}`}),e.jsx("p",{className:"font-semibold text-sm sm:text-base truncate",children:S(r)})]}),e.jsxs(g,{variant:"outline",size:"sm",onClick:()=>{const a=n+1;j(a)&&c(a)},disabled:n===20||!j(n+1),className:"flex-shrink-0 px-2 sm:px-3",children:[e.jsx("span",{className:"hidden sm:inline mr-1",children:"Next"}),e.jsx(B,{className:"w-4 h-4"})]})]}),e.jsx(k,{className:"my-6"}),!y&&e.jsxs(m,{className:"p-8 text-center",children:[e.jsx(q,{className:"w-12 h-12 mx-auto mb-4 text-muted-foreground"}),e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Chapter Locked"}),e.jsx("p",{className:"text-muted-foreground",children:r===0?"Complete companion creation to unlock the Prologue":`This chapter unlocks when your companion reaches Stage ${r}`})]}),y&&t?e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-2 text-center",children:[e.jsxs("h2",{className:"text-2xl font-bold",children:[r===0?"Prologue":`Chapter ${r}`,": ",t.chapter_title]}),e.jsxs("p",{className:"text-lg text-muted-foreground italic",children:['"',t.intro_line,'"']})]}),e.jsx(k,{}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground",children:[e.jsx(b,{className:"w-4 h-4"}),e.jsx("span",{children:"The Journey"})]}),e.jsx("p",{className:"text-foreground leading-relaxed whitespace-pre-wrap",children:t.main_story})]}),e.jsxs("div",{className:"bg-primary/5 p-4 rounded-lg border border-primary/20",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold mb-2 text-primary",children:[e.jsx(R,{className:"w-4 h-4"}),e.jsx("span",{children:"Bond Moment"})]}),e.jsx("p",{className:"text-sm text-foreground/90",children:t.bond_moment})]}),t.life_lesson&&e.jsxs("div",{className:"bg-amber-500/10 p-4 rounded-lg border border-amber-500/20",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-semibold mb-2 text-amber-600 dark:text-amber-400",children:[e.jsx(U,{className:"w-4 h-4"}),e.jsx("span",{children:"Wisdom Gained"})]}),e.jsx("p",{className:"text-sm text-foreground/90",children:t.life_lesson})]})]}):y?e.jsxs(m,{className:"p-8 text-center space-y-4",children:[e.jsx(b,{className:"w-16 h-16 mx-auto text-muted-foreground"}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-semibold mb-2",children:"Chapter Not Yet Written"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:r===0?"The beginning of your companion's story awaits...":"Generate this chapter of your companion's story to continue the journey."}),e.jsx(g,{onClick:L,disabled:f.isPending||p,className:"w-full max-w-sm mx-auto",children:f.isPending?e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"w-4 h-4 mr-2 animate-spin"}),"Writing chapter..."]}):e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"w-4 h-4 mr-2"}),"Generate ",r===0?"Prologue":`Chapter ${r}`]})})]})]}):null]})]}):e.jsxs(m,{className:"p-8 text-center",children:[e.jsx(b,{className:"w-16 h-16 mx-auto mb-4 text-muted-foreground"}),e.jsx("p",{className:"text-muted-foreground",children:"Create your companion first to unlock the Story Journal"})]})};export{ae as CompanionStoryJournal};
