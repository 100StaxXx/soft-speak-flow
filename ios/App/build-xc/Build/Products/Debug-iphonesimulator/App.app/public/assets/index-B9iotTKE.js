const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/EnergyBeamGame-CLTOGMKR.js","assets/vendor-CkzXtEGd.js","assets/date-vendor-CuPqBTxb.js","assets/three-vendor-qI8GXUTd.js","assets/gameUtils-BnwM_CJ4.js","assets/TapSequenceGame-Bxu43lFI.js","assets/AstralFrequencyGame-Dc9Ov7No.js","assets/EclipseTimingGame-CdXXG3Da.js","assets/StarfallDodgeGame-BvuTVzja.js","assets/SoulSerpentGame-Bv_3BKdx.js","assets/OrbMatchGame-C3ujbT9L.js","assets/GalacticMatchGame-CBrJsOdG.js","assets/CompanionStoryJournal-D-2D_7jp.js","assets/CompanionPostcards-DcyMqcgw.js","assets/WidgetDataWeb-BsckqRvB.js","assets/Home-BNlMfIQl.js","assets/Auth-BkkEql_A.js","assets/nativeNavigation-o1P4gnIN.js","assets/authRedirect-B8iaSKfJ.js","assets/redirectUrl-BJoiu_Ib.js","assets/StaticBackgroundImage-DD6vqQ2B.js","assets/ResetPassword-1N_7ewFG.js","assets/Onboarding-CA5tMveF.js","assets/CompanionPersonalization-DpRcD7Qb.js","assets/MentorGrid-7iufA8ZM.js","assets/Welcome-DVxYsJjb.js","assets/Preview-Ct3qOW5S.js","assets/Profile-B3PmfHVv.js","assets/alert-R1BpSyQT.js","assets/Premium-CLpuReoF.js","assets/PepTalkDetail-Vb98Qm1l.js","assets/Admin-B3gKfO7-.js","assets/MentorSelection-A8n2nTYQ.js","assets/NotFound-nKscVqfZ.js","assets/Reflection-CYhyADiF.js","assets/MentorChat-ClApHp8m.js","assets/Library-84deM8vK.js","assets/PepTalkCard-CWn3ofEo.js","assets/QuoteCard-BsC5qDHx.js","assets/Challenges-BClUL62t.js","assets/Search-vTBUcsaF.js","assets/PepTalks-DMSNuMzT.js","assets/TermsOfService-nErCBvbC.js","assets/PrivacyPolicy-DkQ26ws9.js","assets/PremiumSuccess-57mU5DHH.js","assets/Epics-D7My4cDq.js","assets/habitLimits-NNrGyrB4.js","assets/SharedEpics-DCIlo2I7.js","assets/Partners-DFP6CCCj.js","assets/JoinEpic-NPe_L50w.js","assets/Creator-BmFDzVrk.js","assets/InfluencerDashboard-BBBGagV7.js","assets/AccountDeletionHelp-CDTD3WCN.js","assets/Recaps-CLjXd4XY.js","assets/Community-B_Atx4Bk.js","assets/HelpCenter-BAomb4_W.js","assets/TestDayPlanner-CGblyc6y.js","assets/TestScroll-DfE7XiQI.js","assets/Contacts-D6nBx4RQ.js","assets/IAPTest-i-cZNf5g.js"])))=>i.map(i=>d[i]);
import{S as Jd,i as Zd,c as eu,r as n,t as tu,a as su,j as e,V as no,R as io,b as Hs,A as oo,C as lo,X as Qe,T as co,D as uo,P as au,$ as ru,d as mo,e as nu,f as iu,g as ou,h as lu,k as ut,l as be,m as _,n as et,o as Ke,u as ye,p as Ka,q as po,I as cu,s as du,N as Ja,v as Se,O as ho,w as uu,x as fo,y as go,z as xo,B as yo,E as bo,F as mu,G as pu,H as Ht,J as In,K as se,M as Za,L as er,Q as bs,U as hu,W as es,Y as ps,Z as js,_ as fu,a0 as vo,a1 as Gt,a2 as tr,a3 as wo,a4 as sr,a5 as gu,a6 as ar,a7 as rr,a8 as jo,a9 as xu,aa as ze,ab as va,ac as ua,ad as Be,ae as nn,af as Xt,ag as on,ah as Rt,ai as Ct,aj as it,ak as Bt,al as qn,am as Ze,an as yu,ao as bu,ap as vu,aq as wu,ar as ju,as as Ga,at as nr,au as me,av as Vt,aw as na,ax as ln,ay as _u,az as tt,aA as X,aB as ie,aC as _o,aD as No,aE as Nu,aF as ku,aG as ko,aH as Cu,aI as Co,aJ as So,aK as To,aL as ma,aM as Rs,aN as ir,aO as Eo,aP as Mo,aQ as Do,aR as Po,aS as pa,aT as mt,aU as Su,aV as Tu,aW as Ao,aX as Eu,aY as ia,aZ as zt,a_ as cn,a$ as Mu,b0 as Ro,b1 as dn,b2 as Io,b3 as Du,b4 as ss,b5 as qo,b6 as Pu,b7 as Lo,b8 as Au,b9 as Ru,ba as Iu,bb as us,bc as qu,bd as un,be as Jt,bf as Lu,bg as Fu,bh as Ou,bi as $u,bj as Ln,bk as Xe,bl as It,bm as mn,bn as pn,bo as Fo,bp as hn,bq as Bu,br as Yt,bs as Fn,bt as Hu,bu as Oo,bv as zu,bw as Uu,bx as Wu,by as Qu,bz as wa,bA as Ku,bB as pt,bC as Gu,bD as On,bE as ms,bF as $o,bG as Bo,bH as Ho,bI as Yu,bJ as Vr,bK as Vu,bL as Xu,bM as Ju,bN as Zu,bO as em,bP as tm,bQ as zo,bR as Uo,bS as sm,bT as Wo,bU as Qo,bV as am,bW as Ko,bX as rm,bY as Go,bZ as Yo,b_ as nm,b$ as im,c0 as Vo,c1 as om,c2 as lm,c3 as ha,c4 as cm,c5 as dm,c6 as zs,c7 as um,c8 as Xo,c9 as mm,ca as Jo,cb as pm,cc as lt,cd as hm,ce as vs,cf as ht,cg as fm,ch as gm,ci as xm,cj as ys,ck as Zo,cl as ym,cm as bm,cn as el,co as tl,cp as sl,cq as oa,cr as vm,cs as $n,ct as al,cu as rl,cv as nl,cw as wm,cx as il,cy as ol,cz as ll,cA as cl,cB as dl,cC as ul,cD as ml,cE as jm,cF as _m,cG as Nm,cH as km,cI as Cm,cJ as pl,cK as Sm,cL as Xr,cM as Tm,cN as Em,cO as hl,cP as fl,cQ as Mm,cR as Dm,cS as Pm,cT as Am,cU as Rm,cV as Im,cW as qm,cX as or,cY as gl,cZ as Lm,c_ as Fm,c$ as Om,d0 as $m,d1 as Bm,d2 as Pe,d3 as Ts,d4 as Hm,d5 as zm,d6 as Um}from"./vendor-CkzXtEGd.js";import{o as Y,F as At,G as xl,H as yl,I as fn,s as fa,e as ga,B as bl,z as vl,J as Jr,K as Wm,c as Ps,g as Zr,i as Qm,v as Zt,w as Ba,L as Je,j as gn,h as os,m as en,M as Sr,N as Tr,O as Er,P as Bn,Q as Hn,R as zn,S as Un,T as Is,U as xn,V as Km,q as Gm}from"./date-vendor-CuPqBTxb.js";import"./three-vendor-qI8GXUTd.js";(function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const i of document.querySelectorAll('link[rel="modulepreload"]'))r(i);new MutationObserver(i=>{for(const o of i)if(o.type==="childList")for(const c of o.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&r(c)}).observe(document,{childList:!0,subtree:!0});function a(i){const o={};return i.integrity&&(o.integrity=i.integrity),i.referrerPolicy&&(o.referrerPolicy=i.referrerPolicy),i.crossOrigin==="use-credentials"?o.credentials="include":i.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function r(i){if(i.ep)return;i.ep=!0;const o=a(i);fetch(i.href,o)}})();const Ym=async()=>{try{console.debug("Capacitor initialized, splash screen visible")}catch(t){console.debug("Capacitor initialization error:",t)}},Vm=async()=>{try{await Jd.hide({fadeOutDuration:300}),console.debug("Splash screen hidden")}catch(t){console.debug("Splash screen not available:",t)}},Wn={debug:0,info:1,warn:2,error:3},Xm="warn";function Ha(t){return Wn[t]>=Wn[Xm]}function Jm(t){const s=t.scope?`[${t.scope}]`:"";return s?`${s} ${t.message}`:t.message}function Zm(t){Zd()&&eu(t.message,{level:"error",extra:t.context,tags:t.scope?{scope:t.scope}:void 0})}function _t(t,s,a,r){if(!Ha(t))return;const i={message:s,context:a,timestamp:new Date().toISOString(),scope:r},c=[Jm(i)];switch(a&&Object.keys(a).length>0&&c.push(a),t){case"debug":console.log(...c);break;case"info":console.log(...c);break;case"warn":console.warn(...c);break;case"error":console.error(...c),Zm(i);break}}function ep(t){return{debug:(s,a)=>_t("debug",s,a,t),info:(s,a)=>_t("info",s,a,t),warn:(s,a)=>_t("warn",s,a,t),error:(s,a)=>{s instanceof Error?_t("error",s.message,{...a,stack:s.stack,name:s.name},t):_t("error",s,a,t)}}}function tp(t,s){const a=performance.now();return{end:r=>{const i=Math.round(performance.now()-a);return _t("debug",`${t} completed in ${i}ms`,{...r,durationMs:i},s),i},checkpoint:r=>{const i=Math.round(performance.now()-a);return _t("debug",`${t} checkpoint: ${r} at ${i}ms`,{elapsedMs:i},s),i}}}const ee={debug:(t,s)=>_t("debug",t,s),info:(t,s)=>_t("info",t,s),warn:(t,s)=>_t("warn",t,s),error:(t,s)=>{t instanceof Error?_t("error",t.message,{...s,stack:t.stack,name:t.name}):_t("error",t,s)},log:(t,...s)=>{Ha("debug")&&console.log(t,...s)},scope:t=>ep(t),time:(t,s)=>tp(t,s),dev:(t,s)=>{},group:(t,s)=>{if(Ha("debug")){console.group(t);try{s()}finally{console.groupEnd()}}},table:t=>{Ha("debug")&&console.table(t)}},sp=1,ap=1e6;let Mr=0;function rp(){return Mr=(Mr+1)%Number.MAX_SAFE_INTEGER,Mr.toString()}const Dr=new Map,Qn=t=>{if(Dr.has(t))return;const s=setTimeout(()=>{Dr.delete(t),la({type:"REMOVE_TOAST",toastId:t})},ap);Dr.set(t,s)},np=(t,s)=>{switch(s.type){case"ADD_TOAST":return{...t,toasts:[s.toast,...t.toasts].slice(0,sp)};case"UPDATE_TOAST":return{...t,toasts:t.toasts.map(a=>a.id===s.toast.id?{...a,...s.toast}:a)};case"DISMISS_TOAST":{const{toastId:a}=s;return a?Qn(a):t.toasts.forEach(r=>{Qn(r.id)}),{...t,toasts:t.toasts.map(r=>r.id===a||a===void 0?{...r,open:!1}:r)}}case"REMOVE_TOAST":return s.toastId===void 0?{...t,toasts:[]}:{...t,toasts:t.toasts.filter(a=>a.id!==s.toastId)}}},za=[];let Ua={toasts:[]};function la(t){Ua=np(Ua,t),za.forEach(s=>{s(Ua)})}function ip({...t}){const s=rp(),a=i=>la({type:"UPDATE_TOAST",toast:{...i,id:s}}),r=()=>la({type:"DISMISS_TOAST",toastId:s});return la({type:"ADD_TOAST",toast:{...t,id:s,open:!0,onOpenChange:i=>{i||r()}}}),{id:s,dismiss:r,update:a}}function Ut(){const[t,s]=n.useState(Ua);return n.useEffect(()=>(za.push(s),()=>{const a=za.indexOf(s);a>-1&&za.splice(a,1)}),[t]),{...t,toast:ip,dismiss:a=>la({type:"DISMISS_TOAST",toastId:a})}}function E(...t){return tu(su(t))}function tn(t){return t?t.replace(/\*\*([^*]+)\*\*/g,"$1").replace(/\*([^*]+)\*/g,"$1").replace(/__([^_]+)__/g,"$1").replace(/_([^_]+)_/g,"$1").replace(/~~([^~]+)~~/g,"$1").replace(/`([^`]+)`/g,"$1").trim():""}const op=au,wl=n.forwardRef(({className:t,...s},a)=>e.jsx(no,{ref:a,className:E("fixed top-0 z-[100] flex max-h-screen w-full flex-col-reverse p-4 sm:bottom-0 sm:right-0 sm:top-auto sm:flex-col md:max-w-[420px]",t),...s}));wl.displayName=no.displayName;const lp=Hs("group pointer-events-auto relative flex w-full items-center justify-between space-x-4 overflow-hidden rounded-md border p-6 pr-8 shadow-lg transition-all data-[swipe=cancel]:translate-y-0 data-[swipe=end]:translate-y-[var(--radix-toast-swipe-end-y)] data-[swipe=move]:translate-y-[var(--radix-toast-swipe-move-y)] data-[swipe=move]:transition-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[swipe=end]:animate-out data-[state=closed]:fade-out-80 data-[state=closed]:slide-out-to-top-full data-[state=open]:slide-in-from-top-full data-[state=open]:sm:slide-in-from-bottom-full",{variants:{variant:{default:"border bg-background text-foreground",destructive:"destructive group border-destructive bg-destructive text-destructive-foreground"}},defaultVariants:{variant:"default"}}),jl=n.forwardRef(({className:t,variant:s,...a},r)=>e.jsx(io,{ref:r,className:E(lp({variant:s}),t),...a}));jl.displayName=io.displayName;const _l=n.forwardRef(({className:t,...s},a)=>e.jsx(oo,{ref:a,className:E("inline-flex h-8 shrink-0 items-center justify-center rounded-md border bg-transparent px-3 text-sm font-medium ring-offset-background transition-colors group-[.destructive]:border-muted/40 hover:bg-secondary group-[.destructive]:hover:border-destructive/30 group-[.destructive]:hover:bg-destructive group-[.destructive]:hover:text-destructive-foreground focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 group-[.destructive]:focus:ring-destructive disabled:pointer-events-none disabled:opacity-50",t),...s}));_l.displayName=oo.displayName;const Nl=n.forwardRef(({className:t,...s},a)=>e.jsx(lo,{ref:a,className:E("absolute right-2 top-2 rounded-md p-1 text-foreground/50 opacity-0 transition-opacity group-hover:opacity-100 group-[.destructive]:text-red-300 hover:text-foreground group-[.destructive]:hover:text-red-50 focus:opacity-100 focus:outline-none focus:ring-2 group-[.destructive]:focus:ring-red-400 group-[.destructive]:focus:ring-offset-red-600",t),"toast-close":"",...s,children:e.jsx(Qe,{className:"h-4 w-4"})}));Nl.displayName=lo.displayName;const kl=n.forwardRef(({className:t,...s},a)=>e.jsx(co,{ref:a,className:E("text-sm font-semibold",t),...s}));kl.displayName=co.displayName;const Cl=n.forwardRef(({className:t,...s},a)=>e.jsx(uo,{ref:a,className:E("text-sm opacity-90",t),...s}));Cl.displayName=uo.displayName;function cp(){const{toasts:t}=Ut();return e.jsxs(op,{swipeDirection:"up",children:[t.map(function({id:s,title:a,description:r,action:i,...o}){return e.jsxs(jl,{...o,children:[e.jsxs("div",{className:"grid gap-1",children:[a&&e.jsx(kl,{children:a}),r&&e.jsx(Cl,{children:r})]}),i,e.jsx(Nl,{})]},s)}),e.jsx(wl,{})]})}const dp=({...t})=>e.jsx(ru,{theme:"dark",className:"toaster group",position:"bottom-center",swipeDirections:["bottom","left","right"],toastOptions:{classNames:{toast:"group toast group-[.toaster]:bg-background group-[.toaster]:text-foreground group-[.toaster]:border-border group-[.toaster]:shadow-lg",description:"group-[.toast]:text-muted-foreground",actionButton:"group-[.toast]:bg-primary group-[.toast]:text-primary-foreground",cancelButton:"group-[.toast]:bg-muted group-[.toast]:text-muted-foreground"}},...t}),Sl=ou,Tl=nu,El=iu,yn=n.forwardRef(({className:t,sideOffset:s=4,...a},r)=>e.jsx(mo,{ref:r,sideOffset:s,className:E("z-50 overflow-hidden rounded-md border bg-popover px-3 py-1.5 text-sm text-popover-foreground shadow-md animate-in fade-in-0 zoom-in-95 data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=closed]:zoom-out-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...a}));yn.displayName=mo.displayName;const Ma=()=>{try{const t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch{return!1}},Da=()=>{try{const t="__storage_test__";return sessionStorage.setItem(t,t),sessionStorage.removeItem(t),!0}catch{return!1}},qe={getItem:t=>{try{return Ma()?localStorage.getItem(t):null}catch{return null}},setItem:(t,s)=>{try{return Ma()?(localStorage.setItem(t,s),!0):!1}catch{return!1}},removeItem:t=>{try{return Ma()?(localStorage.removeItem(t),!0):!1}catch{return!1}},clear:()=>{try{return Ma()?(localStorage.clear(),!0):!1}catch{return!1}}},Kn={getItem:t=>{try{return Da()?sessionStorage.getItem(t):null}catch{return null}},setItem:(t,s)=>{try{return Da()?(sessionStorage.setItem(t,s),!0):!1}catch{return!1}},removeItem:t=>{try{return Da()?(sessionStorage.removeItem(t),!0):!1}catch{return!1}},clear:()=>{try{return Da()?(sessionStorage.clear(),!0):!1}catch{return!1}}},up="https://opbfpbbqvuksuvmtmssd.supabase.co",mp="sb_publishable_JIATfg-h-gcg2TLZGmQeSw_XcHqQZvB",pp={getItem:t=>qe.getItem(t),setItem:(t,s)=>{qe.setItem(t,s)},removeItem:t=>{qe.removeItem(t)}},N=lu(up,mp,{auth:{storage:pp,persistSession:!0,autoRefreshToken:!0}}),Ml=n.createContext({currentTheme:null,isTransitioning:!1}),hp=()=>n.useContext(Ml),fp=({children:t,mentorId:s})=>{const[a,r]=n.useState(null),[i,o]=n.useState(!1);n.useEffect(()=>{let m=!0,p;return(async()=>{if(!s){m&&(r(null),l());return}try{const{data:f}=await N.from("mentors").select("theme_config").eq("id",s).maybeSingle();if(!m)return;if(f?.theme_config){o(!0);const d=f.theme_config;r(d),c(d),p=setTimeout(()=>{m&&o(!1)},300)}else l()}catch(f){console.error("Error applying theme:",f),m&&(l(),o(!1))}})(),()=>{m=!1,p&&clearTimeout(p)}},[s]);const c=m=>{const p=document.documentElement;p.style.setProperty("--primary",m.primary),p.style.setProperty("--secondary",m.secondary),p.style.setProperty("--accent",m.accent),p.style.setProperty("--background",m.background),p.style.setProperty("--foreground",m.foreground),p.style.setProperty("--card",m.card),p.style.setProperty("--card-foreground",m.foreground),p.style.setProperty("--popover",m.card),p.style.setProperty("--popover-foreground",m.foreground),p.style.setProperty("--primary-foreground",m.foreground),p.style.setProperty("--secondary-foreground",m.foreground),p.style.setProperty("--accent-foreground",m.foreground),p.style.setProperty("--radius",m.border_radius),m.glow_effect?p.style.setProperty("--shadow-glow",`0 0 24px hsl(${m.primary} / 0.5)`):p.style.setProperty("--shadow-glow","0 0 0 transparent"),m.border_style==="sharp"?p.classList.add("sharp-borders"):p.classList.remove("sharp-borders"),m.texture&&m.texture!=="none"&&p.style.setProperty("--bg-texture",m.texture),p.classList.add("theme-transition"),setTimeout(()=>p.classList.remove("theme-transition"),300)},l=()=>{const m=document.documentElement;m.style.setProperty("--primary","270 60% 50%"),m.style.setProperty("--secondary","240 6% 20%"),m.style.setProperty("--accent","270 50% 35%"),m.style.setProperty("--background","0 0% 7%"),m.style.setProperty("--foreground","0 0% 100%"),m.style.setProperty("--card","240 6% 15%"),m.style.setProperty("--radius","1.25rem"),m.style.setProperty("--shadow-glow","0 0 24px hsl(270 60% 50% / 0.5)"),m.classList.remove("sharp-borders")},u=n.useMemo(()=>({currentTheme:a,isTransitioning:i}),[a,i]);return e.jsx(Ml.Provider,{value:u,children:t})},gp=n.createContext(void 0),Pa="cosmiq_view_mode";function xp({children:t}){const[s,a]=n.useState(()=>{const c=qe.getItem(Pa);return c==="focus"||c==="quest"?c:"quest"}),r=n.useCallback(c=>{a(c),qe.setItem(Pa,c)},[]),i=n.useCallback(()=>{a(c=>{const l=c==="focus"?"quest":"focus";return qe.setItem(Pa,l),l})},[]);n.useEffect(()=>{qe.setItem(Pa,s)},[s]);const o=n.useMemo(()=>({viewMode:s,setViewMode:r,toggleViewMode:i}),[s,r,i]);return e.jsx(gp.Provider,{value:o,children:t})}const Ya={dawn:{start:5,end:8,colors:{primary:"hsl(25, 90%, 55%)",accent:"hsl(340, 75%, 60%)",nebula1:"hsl(330, 65%, 45%)",nebula2:"hsl(25, 80%, 50%)",nebula3:"hsl(45, 90%, 60%)",starTint:"warm",gradient:"from-rose-950/40 via-amber-900/30 to-slate-900/50"}},morning:{start:8,end:12,colors:{primary:"hsl(195, 85%, 50%)",accent:"hsl(170, 75%, 45%)",nebula1:"hsl(185, 70%, 45%)",nebula2:"hsl(45, 85%, 55%)",nebula3:"hsl(210, 75%, 50%)",starTint:"neutral",gradient:"from-sky-950/40 via-cyan-900/30 to-slate-900/50"}},afternoon:{start:12,end:17,colors:{primary:"hsl(35, 95%, 55%)",accent:"hsl(190, 80%, 50%)",nebula1:"hsl(40, 85%, 50%)",nebula2:"hsl(180, 70%, 45%)",nebula3:"hsl(55, 90%, 60%)",starTint:"warm",gradient:"from-amber-950/40 via-teal-900/30 to-slate-900/50"}},sunset:{start:17,end:20,colors:{primary:"hsl(330, 80%, 55%)",accent:"hsl(20, 90%, 55%)",nebula1:"hsl(340, 75%, 50%)",nebula2:"hsl(25, 85%, 55%)",nebula3:"hsl(280, 60%, 50%)",starTint:"warm",gradient:"from-pink-950/40 via-orange-900/30 to-purple-950/40"}},night:{start:20,end:5,colors:{primary:"hsl(230, 70%, 55%)",accent:"hsl(195, 90%, 55%)",nebula1:"hsl(240, 60%, 45%)",nebula2:"hsl(200, 75%, 50%)",nebula3:"hsl(270, 55%, 45%)",starTint:"cool",gradient:"from-indigo-950/50 via-slate-900/40 to-black/60"}}},yp=t=>t>=5&&t<8?"dawn":t>=8&&t<12?"morning":t>=12&&t<17?"afternoon":t>=17&&t<20?"sunset":"night",bp=(t,s,a)=>{const r=Ya[a],i=t*60+s;let o=r.start*60,c=r.end*60;a==="night"&&(t>=20?c=1740:(o=0,c=300));const l=c-o,u=i-o;return Math.max(0,Math.min(1,u/l))},vp=Ya.night.colors,Dl=n.createContext({period:"night",progress:0,colors:vp,rotationHue:0}),wp=()=>n.useContext(Dl),jp=({children:t})=>{const[s,a]=n.useState("night"),[r,i]=n.useState(0),[o,c]=n.useState(0);n.useEffect(()=>{const m=()=>{const h=new Date,f=h.getHours(),d=h.getMinutes(),g=yp(f),y=bp(f,d,g);a(g),i(y)};m();const p=setInterval(m,6e4);return()=>clearInterval(p)},[]),n.useEffect(()=>{const p=setInterval(()=>{c(h=>(h+.5)%360)},500);return()=>clearInterval(p)},[]),n.useEffect(()=>{const m=document.documentElement,p=Ya[s].colors;m.style.setProperty("--time-primary",p.primary),m.style.setProperty("--time-accent",p.accent),m.style.setProperty("--time-nebula-1",p.nebula1),m.style.setProperty("--time-nebula-2",p.nebula2),m.style.setProperty("--time-nebula-3",p.nebula3),m.style.setProperty("--time-gradient",p.gradient),m.style.setProperty("--rotation-hue",`${o}deg`),m.setAttribute("data-time-period",s)},[s,o]);const l=n.useMemo(()=>Ya[s].colors,[s]),u=n.useMemo(()=>({period:s,progress:r,colors:l,rotationHue:o}),[s,r,l,o]);return e.jsx(Dl.Provider,{value:u,children:t})},_p=typeof navigator<"u",Np=_p&&"vibrate"in navigator&&typeof navigator.vibrate=="function";let Gn=!1;const Zs=t=>{if(!(!Np||Gn))try{navigator.vibrate(t)}catch(s){console.warn("Haptics unavailable, disabling vibration",s),Gn=!0}},$e={light:()=>{Zs(10)},medium:()=>{Zs(20)},heavy:()=>{Zs(30)},success:()=>{Zs([10,50,10])},error:()=>{Zs([50,100,50])}},kp=({xp:t,reason:s,show:a,onComplete:r})=>(n.useEffect(()=>{if(a){$e.light(),ut({particleCount:20,spread:50,origin:{y:.7},colors:["#A76CFF","#C084FC"],ticks:100,gravity:1.2});const i=setTimeout(r,2e3);return()=>clearTimeout(i)}},[a,r]),e.jsx(be,{children:a&&e.jsx(_.div,{initial:{opacity:0,y:20,scale:.9},animate:{opacity:1,y:0,scale:1,transition:{type:"spring",stiffness:400,damping:20}},exit:{opacity:0,y:-10,scale:.95,transition:{duration:.15}},className:"fixed bottom-28 left-1/2 -translate-x-1/2 z-50",children:e.jsx(_.div,{className:"bg-black/70 backdrop-blur-sm border border-white/20 px-4 py-2 rounded-full",animate:{boxShadow:["0 0 10px rgba(167, 108, 255, 0.3)","0 0 20px rgba(167, 108, 255, 0.5)","0 0 10px rgba(167, 108, 255, 0.3)"]},transition:{duration:1.5,repeat:1/0},children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(et,{className:"h-4 w-4 text-stardust-gold"}),e.jsxs("span",{className:"text-sm font-semibold text-white",children:["+",t," XP"]}),s&&e.jsx("span",{className:"text-xs text-white/70",children:s})]})})})})),Nt=ee.scope("iOS Audio"),gs=Ke.getPlatform()==="ios"||/iPad|iPhone|iPod/.test(navigator.userAgent);let Pr=null,Ar=!1,Wa=!1;function Va(){if(typeof window>"u")return null;if(!Pr)try{const t=window.AudioContext||window.webkitAudioContext;t&&(Pr=new t)}catch(t){Nt.error("Failed to create AudioContext",{error:t})}return Pr}async function ja(){const t=Va();if(!t)return!1;if(t.state==="suspended")try{return await t.resume(),Ar=!0,Nt.debug("AudioContext resumed successfully"),!0}catch(s){return Nt.error("Failed to resume AudioContext",{error:s}),!1}return Ar=t.state==="running",Ar}function Cp(){return Va()?.state==="running"}function bn(){if(typeof document>"u"||Wa)return;const t=async()=>{if(!Wa){Wa=!0,Nt.info("User interaction detected, enabling audio..."),await ja();try{const s=new Audio;s.src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBIAAAABAAEARKwAAIhYAQACABAAAABkYXRhAgAAAAEA",s.volume=.001,s.playsInline=!0;const a=s.play();a&&a.then(()=>{s.pause(),s.src="",Nt.debug("Audio unlocked via silent play")}).catch(()=>{Nt.debug("Silent play caught (expected on some platforms)")})}catch(s){Nt.debug("Silent unlock failed (non-critical)",{error:s})}document.removeEventListener("touchstart",t,!0),document.removeEventListener("touchend",t,!0),document.removeEventListener("click",t,!0),document.removeEventListener("keydown",t,!0)}};document.addEventListener("touchstart",t,{capture:!0,passive:!0}),document.addEventListener("touchend",t,{capture:!0,passive:!0}),document.addEventListener("click",t,{capture:!0}),document.addEventListener("keydown",t,{capture:!0})}function vv(t){const s=new Audio;return s.playsInline=!0,s["webkit-playsinline"]=!0,s.preload="auto",t&&(s.src=t),s}async function Sp(t){if(!t)return!1;gs&&!Cp()&&await ja();try{const s=t.play();return s&&await s,!0}catch(s){const a=s;return a.name==="NotAllowedError"?(Nt.debug("Play blocked - waiting for user interaction"),!1):(a.name==="AbortError"||Nt.error("Play failed",{error:s}),!1)}}class Tp{isMuted=!1;listeners=new Set;audioElements=new Set;constructor(){typeof window<"u"&&(this.loadState(),bn(),document.addEventListener("visibilitychange",this.handleVisibilityChange),Ke.isNativePlatform()&&document.addEventListener("resume",()=>{this.isMuted||this.resumeAllAudio()}))}loadState(){const s=qe.getItem("global_audio_muted");this.isMuted=s==="true"}saveState(){qe.setItem("global_audio_muted",this.isMuted.toString())}handleVisibilityChange=()=>{document.hidden?Nt.info("App backgrounded"):(Nt.info("App foregrounded"),this.isMuted||setTimeout(()=>this.resumeAllAudio(),100))};registerAudio(s){this.audioElements.add(s),this.isMuted&&(s.muted=!0)}unregisterAudio(s){this.audioElements.delete(s)}async resumeAllAudio(){await ja();for(const s of this.audioElements)s.paused&&!this.isMuted&&Sp(s)}getMuted(){return this.isMuted}setMuted(s){if(this.isMuted!==s){this.isMuted=s,this.saveState();for(const a of this.audioElements)a.muted=s;this.notifyListeners(),typeof window<"u"&&window.dispatchEvent(new CustomEvent("ios-audio-mute-change",{detail:s}))}}toggleMute(){return this.setMuted(!this.isMuted),this.isMuted}subscribe(s){return this.listeners.add(s),()=>this.listeners.delete(s)}notifyListeners(){for(const s of this.listeners)try{s(this.isMuted)}catch(a){Nt.error("Listener error",{error:a})}}canPlay(){return!this.isMuted&&Wa}}const ea=new Tp;typeof window<"u"&&bn();class Ep{isMuted=!1;listeners=new Set;constructor(){typeof window<"u"&&(this.loadPreferences(),bn(),gs&&ea.subscribe(s=>{this.isMuted!==s&&(this.isMuted=s,this.notifyListeners())}))}loadPreferences(){try{const s=qe.getItem("global_audio_muted");s&&(this.isMuted=s==="true",gs&&ea.setMuted(this.isMuted))}catch(s){console.warn("Failed to load global audio preferences:",s)}}savePreferences(){try{qe.setItem("global_audio_muted",this.isMuted.toString())}catch(s){console.warn("Failed to save global audio preferences:",s)}}notifyListeners(){this.listeners.forEach(s=>{try{s(this.isMuted)}catch(a){console.error("Error in global audio listener:",a)}}),typeof window<"u"&&window.dispatchEvent(new CustomEvent("global-audio-mute-change",{detail:this.isMuted}))}toggleMute(){return this.isMuted=!this.isMuted,this.savePreferences(),gs&&ea.setMuted(this.isMuted),this.notifyListeners(),this.isMuted}setMuted(s){this.isMuted!==s&&(this.isMuted=s,this.savePreferences(),gs&&ea.setMuted(s),this.notifyListeners())}getMuted(){return this.isMuted}subscribe(s){return this.listeners.add(s),()=>{this.listeners.delete(s)}}canPlayAudio(){return gs?!this.isMuted&&ea.canPlay():!this.isMuted}async ensureReady(){gs&&await ja()}}const sn=new Ep;class Mp{audioContext=null;masterVolume=.5;isMuted=!1;isGloballyMuted=!1;sounds=new Map;activeIntervals=new Set;globalMuteUnsubscribe=null;constructor(){typeof window<"u"&&(this.audioContext=Va(),this.loadSoundPreferences(),this.isGloballyMuted=sn.getMuted(),this.globalMuteUnsubscribe=sn.subscribe(s=>{this.isGloballyMuted=s,s&&this.stopAllAmbientSounds()}),window.addEventListener("beforeunload",()=>{this.stopAllAmbientSounds(),this.globalMuteUnsubscribe&&this.globalMuteUnsubscribe()}))}shouldMute(){return this.isMuted||this.isGloballyMuted}async ensureAudioContext(){return this.audioContext||(this.audioContext=Va()),this.audioContext&&this.audioContext.state==="suspended"&&await ja(),this.audioContext}loadSoundPreferences(){const s=qe.getItem("sound_volume"),a=qe.getItem("sound_muted");s&&(this.masterVolume=parseFloat(s)),a&&(this.isMuted=a==="true")}setVolume(s){this.masterVolume=Math.max(0,Math.min(1,s)),qe.setItem("sound_volume",this.masterVolume.toString())}toggleMute(){return this.isMuted=!this.isMuted,qe.setItem("sound_muted",this.isMuted.toString()),this.isMuted&&this.stopAllAmbientSounds(),this.isMuted}stopAllAmbientSounds(){this.activeIntervals.forEach(s=>clearInterval(s)),this.activeIntervals.clear()}createOscillator(s,a,r="sine"){if(!this.audioContext||this.shouldMute())return null;const i=this.audioContext.createOscillator(),o=this.audioContext.createGain();return i.type=r,i.frequency.setValueAtTime(s,this.audioContext.currentTime),o.gain.setValueAtTime(this.masterVolume*.3,this.audioContext.currentTime),o.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+a),i.connect(o),o.connect(this.audioContext.destination),i.start(this.audioContext.currentTime),i.stop(this.audioContext.currentTime+a),null}async playEvolutionStart(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[220,277,330,440,554,659,880,1108].forEach((a,r)=>{setTimeout(()=>{this.createOscillator(a,.2,"sawtooth"),this.createOscillator(a*1.5,.1,"sine")},r*80)})}async playEvolutionSuccess(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=[130.81,164.81,196],a=[[523.25,659.25,783.99],[659.25,830.61,987.77],[783.99,987.77,1174.66],[1046.5,1318.51,1567.98]];s.forEach((r,i)=>{setTimeout(()=>{this.createOscillator(r,.4,"sawtooth")},i*150)}),a.forEach((r,i)=>{setTimeout(()=>{r.forEach(o=>{this.createOscillator(o,.35,"triangle"),this.createOscillator(o*2,.15,"sine")})},i*180)})}async playSparkle(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=1500+Math.random()*1e3;this.createOscillator(s,.15,"sine")}async playHabitComplete(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(800,.1,"triangle"),setTimeout(()=>{this.createOscillator(1200,.15,"sine")},50)))}async playXPGain(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[440,554.37,659.25].forEach((a,r)=>{setTimeout(()=>{this.createOscillator(a,.1,"square")},r*40)})}async playMissionComplete(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(523.25,.15,"triangle"),setTimeout(()=>{this.createOscillator(659.25,.15,"triangle")},75),setTimeout(()=>{this.createOscillator(783.99,.2,"triangle")},150)))}async playLessonComplete(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(659.25,.2,"sine"),setTimeout(()=>{this.createOscillator(783.99,.25,"sine")},100),setTimeout(()=>{this.createOscillator(1046.5,.3,"sine")},200)))}async playAchievementUnlock(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[{freq:392,duration:.2},{freq:523.25,duration:.2},{freq:659.25,duration:.3},{freq:783.99,duration:.4}].forEach((a,r)=>{setTimeout(()=>{this.createOscillator(a.freq,a.duration,"triangle")},r*150)})}async playButtonClick(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&this.createOscillator(300,.05,"square"))}async playNotification(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(660,.15,"sine"),setTimeout(()=>{this.createOscillator(880,.2,"sine")},100)))}async playStreakMilestone(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[523.25,659.25,783.99,1046.5,1318.51].forEach((a,r)=>{setTimeout(()=>{this.createOscillator(a,.25,"triangle")},r*100)})}async playAmbientNature(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=[100,150,200,250];s.forEach(r=>{this.createOscillator(r+Math.random()*20,2,"sine")});const a=setInterval(()=>{if(this.shouldMute()){clearInterval(a),this.activeIntervals.delete(a);return}s.forEach(r=>{this.createOscillator(r+Math.random()*20,2,"sine")})},2e3);return this.activeIntervals.add(a),()=>{clearInterval(a),this.activeIntervals.delete(a)}}async playCalming(){this.shouldMute()||(await this.ensureAudioContext(),this.audioContext&&(this.createOscillator(220,3,"sine"),setTimeout(()=>{this.createOscillator(440,3,"sine")},1500)))}async playArcadeEntrance(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=150,a=800,r=.6,i=this.audioContext.createOscillator(),o=this.audioContext.createGain();i.type="sawtooth",i.frequency.setValueAtTime(s,this.audioContext.currentTime),i.frequency.exponentialRampToValueAtTime(a,this.audioContext.currentTime+r),o.gain.setValueAtTime(this.masterVolume*.25,this.audioContext.currentTime),o.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+r),i.connect(o),o.connect(this.audioContext.destination),i.start(),i.stop(this.audioContext.currentTime+r);const c=this.audioContext.createOscillator(),l=this.audioContext.createGain();c.type="square",c.frequency.setValueAtTime(s*2,this.audioContext.currentTime),c.frequency.exponentialRampToValueAtTime(a*1.5,this.audioContext.currentTime+r),l.gain.setValueAtTime(this.masterVolume*.1,this.audioContext.currentTime),l.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+r),c.connect(l),l.connect(this.audioContext.destination),c.start(),c.stop(this.audioContext.currentTime+r),setTimeout(()=>{this.createOscillator(1200,.15,"sine"),this.createOscillator(1500,.1,"sine")},400)}async playArcadeSelect(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=this.audioContext.createOscillator(),a=this.audioContext.createGain();s.type="square",s.frequency.setValueAtTime(600,this.audioContext.currentTime),s.frequency.exponentialRampToValueAtTime(800,this.audioContext.currentTime+.08),a.gain.setValueAtTime(this.masterVolume*.2,this.audioContext.currentTime),a.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.1),s.connect(a),a.connect(this.audioContext.destination),s.start(),s.stop(this.audioContext.currentTime+.1)}async playArcadeHighScore(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[523.25,659.25,783.99,1046.5].forEach((a,r)=>{setTimeout(()=>{this.createOscillator(a,.2,"triangle"),this.createOscillator(a*2,.1,"sine")},r*100)}),setTimeout(()=>{[1046.5,1318.51,1567.98].forEach(a=>{this.createOscillator(a,.4,"triangle")})},450)}async playEncounterTrigger(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;[329.63,392,493.88,659.25].forEach((a,r)=>{setTimeout(()=>{const i=this.audioContext.createOscillator(),o=this.audioContext.createGain();i.type="square",i.frequency.setValueAtTime(a,this.audioContext.currentTime),o.gain.setValueAtTime(this.masterVolume*.25,this.audioContext.currentTime),o.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.15),i.connect(o),o.connect(this.audioContext.destination),i.start(),i.stop(this.audioContext.currentTime+.15)},r*100)})}async playStrikethrough(){if(this.shouldMute()||(await this.ensureAudioContext(),!this.audioContext))return;const s=this.audioContext.createOscillator(),a=this.audioContext.createGain();s.type="sine",s.frequency.setValueAtTime(1200,this.audioContext.currentTime),s.frequency.exponentialRampToValueAtTime(300,this.audioContext.currentTime+.15),a.gain.setValueAtTime(this.masterVolume*.25,this.audioContext.currentTime),a.gain.exponentialRampToValueAtTime(.01,this.audioContext.currentTime+.18),s.connect(a),a.connect(this.audioContext.destination),s.start(),s.stop(this.audioContext.currentTime+.2),setTimeout(()=>{this.createOscillator(800,.08,"triangle")},100)}}const kt=new Mp,Dp=()=>kt.playEvolutionStart(),Pp=()=>kt.playEvolutionSuccess(),wv=()=>kt.playHabitComplete(),Ap=()=>kt.playXPGain(),vn=()=>kt.playMissionComplete(),Rp=()=>kt.playAchievementUnlock(),Ip=()=>kt.playEncounterTrigger(),qp=()=>kt.playStrikethrough(),Lp=t=>{switch(t){case"complete":return kt.playHabitComplete();case"error":return kt.playButtonClick();case"pop":return kt.playSparkle();case"success":return kt.playMissionComplete()}},Pl=n.createContext(null),Fp=({children:t})=>{const[s,a]=n.useState({xp:0,reason:"",show:!1}),r=n.useCallback((c,l)=>{a({xp:c,reason:l,show:!0}),Ap()},[]),i=n.useCallback(()=>{a(c=>({...c,show:!1}))},[]),o=n.useMemo(()=>({showXPToast:r}),[r]);return e.jsxs(Pl.Provider,{value:o,children:[t,e.jsx(kp,{xp:s.xp,reason:s.reason,show:s.show,onComplete:i})]})},Al=()=>{const t=n.useContext(Pl);if(!t)throw new Error("useXPToast must be used within XPProvider");return t},Rl=n.createContext(void 0),Op=({children:t})=>{const[s,a]=n.useState(!1),[r,i]=n.useState(null),o=n.useMemo(()=>({isEvolvingLoading:s,setIsEvolvingLoading:a,onEvolutionComplete:r,setOnEvolutionComplete:i}),[s,r]);return e.jsx(Rl.Provider,{value:o,children:t})},lr=()=>{const t=n.useContext(Rl);if(t===void 0)throw new Error("useEvolution must be used within an EvolutionProvider");return t},Il=n.createContext(void 0),$p=({children:t})=>{const[s,a]=n.useState(!1),[r,i]=n.useState([]),o=n.useCallback(m=>{i(p=>p.includes(m)?p:[...p,m])},[]),c=n.useCallback(m=>{let p=!1;return i(h=>h.includes(m)?(p=!0,h.filter(f=>f!==m)):h),p},[]),l=n.useCallback(()=>{i([])},[]),u=n.useMemo(()=>({isEvolutionInProgress:s,setEvolutionInProgress:a,pendingCelebrations:r,addPendingCelebration:o,consumePendingCelebration:c,clearAllPending:l}),[s,r,o,c,l]);return e.jsx(Il.Provider,{value:u,children:t})},Bp=()=>{const t=n.useContext(Il);if(t===void 0)throw new Error("useCelebration must be used within a CelebrationProvider");return t},ql=2;function Ll(t){const s=new Date,a=Intl.DateTimeFormat().resolvedOptions().timeZone;if(parseInt(new Intl.DateTimeFormat("en-US",{hour:"numeric",hour12:!1,timeZone:a}).format(s))<ql){const i=new Date(s);return i.setDate(i.getDate()-1),Yn(i,a)}return Yn(s,a)}function Hp(t){const s=new Date,a=Intl.DateTimeFormat().resolvedOptions().timeZone,r=parseInt(new Intl.DateTimeFormat("en-US",{hour:"numeric",hour12:!1,timeZone:a}).format(s)),i=new Intl.DateTimeFormat("en-US",{weekday:"short",timeZone:a});let o=s;r<ql&&(o=new Date(s),o.setDate(o.getDate()-1));const c=i.format(o);return{Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6}[c]??0}function Yn(t,s){return new Intl.DateTimeFormat("en-CA",{year:"numeric",month:"2-digit",day:"2-digit",timeZone:s}).format(t)}function zp(){return Intl.DateTimeFormat().resolvedOptions().timeZone}const ce=()=>{const[t,s]=n.useState(null),[a,r]=n.useState(null),[i,o]=n.useState(!0),c=async u=>{try{const m=zp();await N.from("profiles").update({timezone:m}).eq("id",u)}catch(m){console.error("Failed to save timezone:",m)}};return n.useEffect(()=>{N.auth.getSession().then(({data:{session:m},error:p})=>{p&&console.error("Failed to get session:",p),r(m),s(m?.user??null),o(!1),m?.user&&c(m.user.id)}).catch(m=>{console.error("Unexpected auth error:",m),r(null),s(null),o(!1)});const{data:{subscription:u}}=N.auth.onAuthStateChange((m,p)=>{r(p),s(p?.user??null),o(!1),p?.user&&(m==="SIGNED_IN"||m==="TOKEN_REFRESHED")&&c(p.user.id)});return()=>u.unsubscribe()},[]),{user:t,session:a,loading:i,signOut:async()=>{try{await N.auth.signOut()}catch(u){throw console.error("Sign out error:",u),u}}}},Up=5,cr=()=>{const{user:t}=ce(),{data:s,isLoading:a}=ye({queryKey:["companion-care-signals",t?.id],queryFn:async()=>{if(!t?.id)return null;const{data:i,error:o}=await N.from("user_companion").select(`
          care_consistency,
          care_responsiveness,
          care_balance,
          care_intent,
          care_recovery,
          care_pattern,
          evolution_path,
          evolution_path_locked,
          path_determination_date,
          dormant_since,
          dormancy_count,
          dormancy_recovery_days,
          inactive_days,
          bond_level,
          total_interactions,
          last_interaction_at
        `).eq("user_id",t.id).maybeSingle();if(o)throw console.error("Failed to fetch care signals:",o),o;return i},enabled:!!t?.id,staleTime:6e4});return{care:n.useMemo(()=>{const i={consistency:s?.care_consistency??.5,responsiveness:s?.care_responsiveness??.5,balance:s?.care_balance??.5,intent:s?.care_intent??.5,recovery:s?.care_recovery??.5},o=i.consistency*.3+i.responsiveness*.15+i.balance*.2+i.intent*.2+i.recovery*.15,c={path:s?.evolution_path??null,isLocked:s?.evolution_path_locked??!1,determinedAt:s?.path_determination_date??null},l=s?.dormant_since,u=!!l,m=s?.dormancy_recovery_days??0,p=s?.inactive_days??0,d=!u&&p>=5?Math.max(1,7-p):null,g={isDormant:u,dormantSince:l??null,dormancyCount:s?.dormancy_count??0,recoveryDays:m,daysUntilWake:u?Math.max(0,Up-m):0,inactiveDays:p,daysUntilDormancy:d},y={level:s?.bond_level??0,totalInteractions:s?.total_interactions??0,lastInteractionAt:s?.last_interaction_at??null},b=s?.care_pattern?.dormancy_warning===!0;let x="content";return u?x="silent":o>.8?x="joyful":o>.6?x="content":o>.4?x="neutral":o>.2?x="reserved":x="quiet",{careSignals:i,overallCare:o,evolutionPath:c,dormancy:g,bond:y,hasDormancyWarning:b,dialogueTone:x}},[s]),isLoading:a}},Wp=t=>{switch(t){case"steady_guardian":return{name:"Steady Guardian",description:"Your consistent care has shaped a calm, protective companion.",icon:"ðŸ›¡ï¸",color:"text-amber-400",bgColor:"bg-amber-500/10",borderColor:"border-amber-500/30"};case"volatile_ascendant":return{name:"Volatile Ascendant",description:"Your intense but erratic energy has forged a powerful, passionate companion.",icon:"âš¡",color:"text-purple-400",bgColor:"bg-purple-500/10",borderColor:"border-purple-500/30"};case"neglected_wanderer":return{name:"Neglected Wanderer",description:"Time apart has made your companion independent but distant.",icon:"ðŸŒ™",color:"text-slate-400",bgColor:"bg-slate-500/10",borderColor:"border-slate-500/30"};case"balanced_architect":return{name:"Balanced Architect",description:"Perfect harmony in your care has awakened a rare, transcendent form.",icon:"âœ¨",color:"text-cyan-400",bgColor:"bg-cyan-500/10",borderColor:"border-cyan-500/30"};default:return{name:"Forming",description:"Your care patterns are still being observed...",icon:"ðŸŒ€",color:"text-muted-foreground",bgColor:"bg-muted/10",borderColor:"border-muted/30"}}},Fl={mood:"neutral",auraHue:45,auraOpacity:0,particleEffect:"none",particleCount:0,pulseRate:1,isPresent:!1,evolutionPath:null,needsAttention:!1,overallCare:.5},Ol=n.createContext({presence:Fl,isLoading:!0}),Qp={steady_guardian:45,volatile_ascendant:280,neglected_wanderer:210,balanced_architect:180},Kp={joyful:{particleEffect:"sparkle",particleCount:[6,8],opacity:[.04,.06]},content:{particleEffect:"gentle",particleCount:[4,6],opacity:[.03,.05]},neutral:{particleEffect:"gentle",particleCount:[3,4],opacity:[.02,.03]},reserved:{particleEffect:"minimal",particleCount:[2,3],opacity:[.01,.02]},quiet:{particleEffect:"minimal",particleCount:[1,2],opacity:[.005,.01]},dormant:{particleEffect:"none",particleCount:[0,0],opacity:[0,0]}},$l=n.memo(({children:t})=>{const{user:s}=ce(),{care:a,isLoading:r}=cr(),i=n.useMemo(()=>{if(!s||r)return Fl;const{overallCare:c,evolutionPath:l,dormancy:u,hasDormancyWarning:m,dialogueTone:p}=a,h=["joyful","content","neutral","reserved","quiet","dormant"],f=p,d=u.isDormant?"dormant":h.includes(f)?f:"neutral",g=l.path?Qp[l.path]??45:45,y=Kp[d],[v,b]=y.opacity,x=v+(b-v)*c,[j,w]=y.particleCount,D=Math.round(j+(w-j)*c),S=.7+c*.6;return{mood:d,auraHue:g,auraOpacity:x,particleEffect:y.particleEffect,particleCount:D,pulseRate:S,isPresent:!u.isDormant,evolutionPath:l.path,needsAttention:m||c<.3,overallCare:c}},[s,r,a]),o=n.useMemo(()=>({presence:i,isLoading:r}),[i,r]);return e.jsx(Ol.Provider,{value:o,children:t})});$l.displayName="CompanionPresenceProvider";const dr=()=>{const t=n.useContext(Ol);if(!t)throw new Error("useCompanionPresence must be used within CompanionPresenceProvider");return t},Vn=t=>{try{return t.startsWith("cosmiq://task/")?{type:"task",taskId:t.replace("cosmiq://task/","").split("?")[0],rawUrl:t}:{type:"unknown",rawUrl:t}}catch(s){return ee.error("[DeepLink] Failed to parse URL:",s),{type:"unknown",rawUrl:t}}},Gp=t=>{if(!Ke.isNativePlatform())return()=>{};let s=null;return Ka.getLaunchUrl().then(a=>{if(a?.url){ee.log("[DeepLink] App launched with URL:",a.url);const r=Vn(a.url);t(r)}}),Ka.addListener("appUrlOpen",a=>{ee.log("[DeepLink] App URL opened:",a.url);const r=Vn(a.url);t(r)}).then(a=>{s=a}),()=>{s?.remove()}},Bl=n.createContext({pendingTaskId:null,clearPendingTask:()=>{}}),Yp=()=>n.useContext(Bl),Vp=({children:t})=>{const[s,a]=n.useState(null),r=n.useCallback(o=>{ee.log("[DeepLinkProvider] Received deep link:",o),o.type==="task"&&o.taskId&&(a(o.taskId),window.dispatchEvent(new CustomEvent("deep-link-navigation",{detail:{path:"/journeys",taskId:o.taskId}})))},[]),i=n.useCallback(()=>{a(null)},[]);return n.useEffect(()=>Gp(r),[r]),e.jsx(Bl.Provider,{value:{pendingTaskId:s,clearPendingTask:i},children:t})},yt=()=>{const{user:t}=ce(),{data:s,isLoading:a,error:r,refetch:i}=ye({queryKey:["profile",t?.id],queryFn:async()=>{if(!t)return null;const{data:o,error:c}=await N.from("profiles").select("*").eq("id",t.id).maybeSingle();if(c)throw console.error("Error fetching profile:",c),c;if(!o){const{data:l,error:u}=await N.from("profiles").upsert({id:t.id,email:t.email??null},{onConflict:"id",ignoreDuplicates:!1}).select("*").maybeSingle();if(u)throw console.error("Error creating profile:",u),u;if(!l)throw new Error("Failed to create profile");return l}return o},enabled:!!t,staleTime:120*1e3,refetchOnWindowFocus:!1});return{profile:s??null,loading:a,error:r,refetch:i}},Xp=/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i,Hl=t=>typeof t=="object"&&t!==null&&!Array.isArray(t),zl=t=>{if(!t||!Hl(t.onboarding_data))return null;const s=t.onboarding_data.mentorId;if(typeof s!="string")return null;const a=s.trim();return a&&Xp.test(a)?a:null},Jp=t=>{if(!Hl(t))return{};const{mentorId:s,...a}=t;return a},Zp=t=>{if(!t)return!1;if(t.code==="23503")return!0;const s=`${t.message??""} ${t.details??""}`.toLowerCase();return s.includes("profiles_selected_mentor_id_fkey")||s.includes("foreign key")},Us=t=>{if(!t)return null;if(t.selected_mentor_id)return t.selected_mentor_id;const s=zl(t);return!s||t.onboarding_completed===!0?null:s},eh=["active","cancelled","past_due","trialing","incomplete"],th=["monthly","yearly"];function Xn(t){return typeof t=="string"&&eh.includes(t)}function Jn(t){return typeof t=="string"&&th.includes(t)}function sh(){const{user:t,loading:s}=ce(),{data:a,isLoading:r,error:i,refetch:o}=ye({queryKey:["subscription",t?.id],queryFn:async()=>{if(!t)return null;const{data:f,error:d}=await N.functions.invoke("check-apple-subscription");if(d)throw d;return f},enabled:!!t,staleTime:300*1e3,refetchInterval:!1}),c=s||!!t&&r,l=n.useMemo(()=>{if(!a||!a.subscribed)return null;const f=Xn(a.status)?a.status:"incomplete",d=Jn(a.plan)?a.plan:"monthly";return Xn(a.status)||ee.warn(`Unexpected subscription status: ${a.status}`),a.plan&&!Jn(a.plan)&&ee.warn(`Unexpected subscription plan: ${a.plan}`),{status:f,plan:d,current_period_end:a.subscription_end}},[a]),u=a?.subscribed||!1,m=l?.status==="cancelled",p=n.useMemo(()=>l?.current_period_end?new Date(l.current_period_end):null,[l?.current_period_end]),h=n.useMemo(()=>l?.plan==="yearly"?"$59.99/year":"$9.99/month",[l?.plan]);return{subscription:l,isLoading:c,error:i,refetch:o,isActive:u,isCancelled:m,hasPremium:u,nextBillingDate:p,planPrice:h,plan:l?.plan}}function ah(){const{profile:t,loading:s}=yt(),{isActive:a,isLoading:r}=sh();return n.useMemo(()=>{if(s||r||!t)return{hasAccess:!0,isSubscribed:!1,isInTrial:!1,trialExpired:!1,trialDaysRemaining:0,accessSource:"none",trialEndsAt:null,loading:!0};let o=null;t.trial_ends_at?o=new Date(t.trial_ends_at):t.created_at&&(o=new Date(new Date(t.created_at).getTime()+10080*60*1e3));const c=new Date,l=o?c>o:!1;return o&&!l&&o.getTime()-c.getTime(),{hasAccess:!0,isSubscribed:a,isInTrial:!1,trialExpired:!1,trialDaysRemaining:0,accessSource:a?"subscription":"none",trialEndsAt:o,loading:!1}},[t,s,a,r])}const ts=n.forwardRef(({className:t,value:s,...a},r)=>e.jsx(po,{ref:r,className:E("relative h-2 w-full overflow-hidden rounded-full bg-secondary/50",t),...a,children:e.jsx(cu,{className:"h-full w-full flex-1 bg-gradient-to-r from-primary to-accent transition-all duration-500 ease-out shadow-glow",style:{transform:`translateX(-${100-(s||0)}%)`}})}));ts.displayName=po.displayName;const xa=Hs("inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-[14px] text-sm font-semibold ring-offset-background transition-colors duration-200 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 disabled:shadow-none [&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0 active:scale-[0.985]",{variants:{variant:{default:"bg-primary text-primary-foreground shadow-[0_10px_20px_hsl(var(--primary)/0.28)] hover:bg-primary/92 active:bg-primary/88",destructive:"bg-destructive text-destructive-foreground shadow-[0_10px_20px_hsl(var(--destructive)/0.25)] hover:bg-destructive/92 active:bg-destructive/88",outline:"border border-border/70 bg-card/70 text-foreground hover:bg-card/90",secondary:"bg-secondary text-secondary-foreground hover:bg-secondary/85",ghost:"text-foreground/85 hover:bg-foreground/5 hover:text-foreground",link:"text-royal-purple underline-offset-4 hover:underline",cta:"bg-gradient-to-r from-royal-purple via-accent-purple to-nebula-pink text-pure-white shadow-[0_12px_24px_hsl(var(--royal-purple)/0.32)] hover:brightness-105",gradient:"bg-gradient-to-r from-primary to-accent text-pure-white shadow-[0_12px_24px_hsl(var(--primary)/0.25)] hover:brightness-105",accent:"bg-gradient-to-r from-amber-500 to-orange-500 text-white shadow-[0_10px_20px_hsl(28_96%_56%/0.3)] hover:brightness-105"},size:{default:"h-11 px-4",sm:"h-9 rounded-[12px] px-3 text-xs",lg:"h-12 rounded-[16px] px-6 text-base",icon:"h-10 w-10"}},defaultVariants:{variant:"default",size:"default"}}),B=n.forwardRef(({className:t,variant:s,size:a,asChild:r=!1,...i},o)=>{const c=r?du:"button";return e.jsx(c,{className:E(xa({variant:s,size:a,className:t})),ref:o,...i})});B.displayName="Button";const Me=n.forwardRef(({className:t,...s},a)=>e.jsx("div",{ref:a,className:E("rounded-2xl border text-card-foreground","bg-card/78 backdrop-blur-lg","border-border/60","shadow-[0_12px_28px_rgba(0,0,0,0.22)]","transition-colors duration-200",t),...s}));Me.displayName="Card";const rh=n.forwardRef(({className:t,...s},a)=>e.jsx("div",{ref:a,className:E("flex flex-col space-y-1.5 p-4 sm:p-6",t),...s}));rh.displayName="CardHeader";const nh=n.forwardRef(({className:t,...s},a)=>e.jsx("h3",{ref:a,className:E("text-xl sm:text-2xl font-semibold leading-none tracking-tight",t),...s}));nh.displayName="CardTitle";const ih=n.forwardRef(({className:t,...s},a)=>e.jsx("p",{ref:a,className:E("text-sm text-muted-foreground",t),...s}));ih.displayName="CardDescription";const wn=n.forwardRef(({className:t,...s},a)=>e.jsx("div",{ref:a,className:E("p-4 sm:p-6 pt-0",t),...s}));wn.displayName="CardContent";const oh=n.forwardRef(({className:t,...s},a)=>e.jsx("div",{ref:a,className:E("flex items-center p-4 sm:p-6 pt-0",t),...s}));oh.displayName="CardFooter";const ns={MONTHLY:"cosmiq_premium_monthly",YEARLY:"cosmiq_premium_yearly"},Pt=()=>Ke.isNativePlatform()&&Ke.getPlatform()==="ios",lh=async t=>{if(!Pt())throw new Error("In-App Purchases are only available on iOS");try{return await Ja.purchaseProduct({productIdentifier:t})}catch(s){throw console.error("Purchase failed:",s),s}},ch=async()=>{if(!Pt())throw new Error("In-App Purchases are only available on iOS");try{return(await Ja.restorePurchases())?.purchases||[]}catch(t){throw console.error("Restore failed:",t),t}},dh=async t=>{if(console.log("[IAP DEBUG] getProducts called with:",t),console.log("[IAP DEBUG] isIAPAvailable:",Pt()),console.log("[IAP DEBUG] Platform:",Ke.getPlatform()),console.log("[IAP DEBUG] isNative:",Ke.isNativePlatform()),!Pt())return console.log("[IAP DEBUG] IAP not available, returning empty array"),[];try{console.log("[IAP DEBUG] Calling NativePurchases.getProducts...");const s=await Ja.getProducts({productIdentifiers:t});console.log("[IAP DEBUG] Raw result from NativePurchases:",JSON.stringify(s,null,2));const a=s?.products||[];return console.log("[IAP DEBUG] Parsed products count:",a.length),console.log("[IAP DEBUG] Parsed products:",JSON.stringify(a,null,2)),a}catch(s){return console.error("[IAP DEBUG] Get products failed:",s),console.error("[IAP DEBUG] Error details:",JSON.stringify(s,Object.getOwnPropertyNames(s))),[]}},uh=async()=>{if(Pt()){await Ja.manageSubscriptions();return}window.open("https://apps.apple.com/account/subscriptions","_blank")},Zn="Premium subscriptions are temporarily unavailable. Please try again later.";function mh(){const t=Se(),{toast:s}=Ut(),[a,r]=n.useState(!1),[i,o]=n.useState([]),[c,l]=n.useState(!1),[u,m]=n.useState(null),[p,h]=n.useState(!1),[f,d]=n.useState(!1),g=n.useCallback(async()=>{if(console.log("[HOOK DEBUG] fetchProducts called"),console.log("[HOOK DEBUG] IAP_PRODUCTS:",JSON.stringify(ns)),console.log("[HOOK DEBUG] isIAPAvailable:",Pt()),!Pt())return console.log("[HOOK DEBUG] IAP not available, setting error"),o([]),m("In-App Purchases are only available on iOS devices"),h(!0),[];l(!0),m(null);try{console.log("[HOOK DEBUG] About to call getProducts...");const j=await dh(Object.values(ns));if(console.log("[HOOK DEBUG] getProducts returned:",j.length,"products"),console.log("[HOOK DEBUG] Products:",JSON.stringify(j)),!j.length)throw console.log("[HOOK DEBUG] No products returned, throwing error"),new Error("No App Store products were returned");return o(j),console.log("[HOOK DEBUG] Products set successfully"),j}catch(j){return console.error("[HOOK DEBUG] Product load error:",j),o([]),m(Zn),[]}finally{l(!1),h(!0),console.log("[HOOK DEBUG] fetchProducts complete")}},[]);n.useEffect(()=>{g()},[g]);const y=n.useCallback(async()=>{if(console.log("[ENSURE DEBUG] ensureProductsAvailable called"),console.log("[ENSURE DEBUG] hasAttemptedProductFetch:",p),console.log("[ENSURE DEBUG] products.length:",i.length),!p||i.length===0){console.log("[ENSURE DEBUG] Condition met - calling fetchProducts()");const j=await g();console.log("[ENSURE DEBUG] fetchProducts returned:",j.length,"products");const w=j.length?j:null;return console.log("[ENSURE DEBUG] Returning:",w?"products":"NULL"),w}return console.log("[ENSURE DEBUG] Using existing products:",i.length),i},[g,p,i]);return{handlePurchase:async j=>{if(console.log("[PURCHASE DEBUG] ========== handlePurchase START =========="),console.log("[PURCHASE DEBUG] productId:",j),console.log("[PURCHASE DEBUG] isIAPAvailable():",Pt()),console.log("[PURCHASE DEBUG] Current products state:",i.length),console.log("[PURCHASE DEBUG] hasAttemptedProductFetch:",p),!Pt())return console.log("[PURCHASE DEBUG] IAP not available - returning false"),s({title:"Not Available",description:"In-App Purchases are only available on iOS devices",variant:"destructive"}),!1;r(!0);try{console.log("[PURCHASE DEBUG] Calling ensureProductsAvailable...");const w=await y();if(console.log("[PURCHASE DEBUG] ensureProductsAvailable returned:",w?w.length+" products":"NULL"),!w)return s({title:"Unavailable",description:Zn,variant:"destructive"}),!1;console.log("[HOOK DEBUG] Checking productId:",j),console.log("[HOOK DEBUG] Available identifiers:",w.map(T=>T.identifier));const D=w.some(T=>T.identifier===j);if(console.log("[HOOK DEBUG] productExists result:",D),!D)return s({title:"Unavailable",description:"Selected premium plan is not ready yet. Please try again in a moment.",variant:"destructive"}),!1;const S=await lh(j);if(console.log("[IAP] Purchase response:",JSON.stringify(S,null,2)),!S)throw new Error("Purchase returned no data");const M=S.transactionId,C=S.receipt??S.transactionReceipt;if(console.log("[IAP] Verification payload:",{transactionId:!!M,receipt:!!C}),!M&&!C)throw new Error("No transaction ID or receipt data available");const{error:R}=await N.functions.invoke("verify-apple-receipt",{body:M?{transactionId:M}:{receipt:C}});if(R)throw R;return await t.invalidateQueries({queryKey:["subscription"]}),s({title:"Success!",description:"Your subscription is now active"}),!0}catch(w){console.error("Purchase error:",w);const D=w instanceof Error?w.message:"Please try again";return s({title:"Purchase Failed",description:D,variant:"destructive"}),!1}finally{r(!1)}},handleRestore:async()=>{if(!Pt()){s({title:"Not Available",description:"In-App Purchases are only available on iOS devices",variant:"destructive"});return}r(!0);try{const j=await ch();if(!j||!Array.isArray(j)||j.length===0){s({title:"No Purchases Found",description:"No previous purchases to restore"});return}const w=T=>typeof T=="object"&&T!==null,S=[...j].filter(w).sort((T,q)=>{const k=T.transactionDate||0;return(q.transactionDate||0)-k}).find(T=>T.productId?.includes("premium"));if(!S){s({title:"No Subscription Found",description:"No active subscription to restore"});return}const M=S.transactionId,C=S.transactionReceipt??S.receipt;if(!M&&!C)throw new Error("No transaction ID or receipt data available for subscription");const{error:R}=await N.functions.invoke("verify-apple-receipt",{body:M?{transactionId:M}:{receipt:C}});if(R)throw R;await t.invalidateQueries({queryKey:["subscription"]}),s({title:"Restored!",description:"Your subscription has been restored"})}catch(j){console.error("Restore error:",j);const w=j instanceof Error?j.message:"Please try again";s({title:"Restore Failed",description:w,variant:"destructive"})}finally{r(!1)}},handleManageSubscriptions:async()=>{d(!0);try{await uh(),s({title:"Manage Subscription",description:"Opening Apple's subscription settings..."})}catch(j){console.error("Manage subscription error:",j);const w=j instanceof Error?j.message:"Please try again";s({title:"Unable to open subscriptions",description:w,variant:"destructive"})}finally{d(!1)}},loading:a,manageLoading:f,products:i,productsLoading:c,productError:u,hasLoadedProducts:p,reloadProducts:g,isAvailable:Pt()}}const _a=mu,jv=pu,ph=uu,Ul=n.forwardRef(({className:t,...s},a)=>e.jsx(ho,{className:E("fixed inset-0 z-50 bg-black/80 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...s,ref:a}));Ul.displayName=ho.displayName;const Ws=n.forwardRef(({className:t,...s},a)=>e.jsxs(ph,{children:[e.jsx(Ul,{}),e.jsx(fo,{ref:a,className:E("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border bg-background p-6 shadow-lg duration-200 data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[48%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[48%] sm:rounded-lg",t),...s})]}));Ws.displayName=fo.displayName;const Qs=({className:t,...s})=>e.jsx("div",{className:E("flex flex-col space-y-2 text-center sm:text-left",t),...s});Qs.displayName="AlertDialogHeader";const Ks=({className:t,...s})=>e.jsx("div",{className:E("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...s});Ks.displayName="AlertDialogFooter";const Gs=n.forwardRef(({className:t,...s},a)=>e.jsx(go,{ref:a,className:E("text-lg font-semibold",t),...s}));Gs.displayName=go.displayName;const Ys=n.forwardRef(({className:t,...s},a)=>e.jsx(xo,{ref:a,className:E("text-sm text-muted-foreground",t),...s}));Ys.displayName=xo.displayName;const ws=n.forwardRef(({className:t,...s},a)=>e.jsx(yo,{ref:a,className:E(xa(),t),...s}));ws.displayName=yo.displayName;const Vs=n.forwardRef(({className:t,...s},a)=>e.jsx(bo,{ref:a,className:E(xa({variant:"outline"}),"mt-2 sm:mt-0",t),...s}));Vs.displayName=bo.displayName;const He=n.forwardRef(({className:t,type:s,...a},r)=>e.jsx("input",{type:s,className:E("flex h-11 sm:h-12 w-full rounded-lg border border-input bg-secondary/50 px-3 sm:px-4 py-2 text-sm sm:text-base font-medium text-foreground ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium file:text-foreground placeholder:text-muted-foreground/70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-primary focus-visible:ring-offset-2 focus-visible:border-primary disabled:cursor-not-allowed disabled:opacity-50 transition-all touch-manipulation",t),ref:r,...a}));He.displayName="Input";const hh=()=>{const[t,s]=n.useState("yearly"),[a,r]=n.useState(!1),[i,o]=n.useState(""),[c,l]=n.useState(!1),[u,m]=n.useState(!1),{handlePurchase:p,handleRestore:h,loading:f,isAvailable:d,products:g,productsLoading:y,productError:v,reloadProducts:b,hasLoadedProducts:x}=mh(),{toast:j}=Ut(),{signOut:w}=ce(),D=Ht(),S=n.useMemo(()=>g.reduce((P,A)=>(P[A.identifier]=A,P),{}),[g]),M=t==="yearly"?ns.YEARLY:ns.MONTHLY,C=S[M],R=async()=>{if(!C){j({title:"Almost ready",description:"We're still fetching Apple pricing details. Please try again in a moment.",variant:"destructive"});return}const P=t==="yearly"?ns.YEARLY:ns.MONTHLY;await p(P)},T=async()=>{m(!0);try{await w(),D("/auth")}catch{j({title:"Error",description:"Failed to sign out. Please try again.",variant:"destructive"})}finally{m(!1)}},q=async()=>{if(i!=="DELETE"){j({title:"Confirmation required",description:"Please type DELETE to confirm account deletion.",variant:"destructive"});return}l(!0);try{const{data:{session:P}}=await N.auth.getSession();if(!P?.access_token)throw new Error("No active session");const{error:A}=await N.functions.invoke("delete-user",{headers:{Authorization:`Bearer ${P.access_token}`}});if(A)throw A;await w(),D("/auth"),j({title:"Account deleted",description:"Your account has been permanently deleted."})}catch(P){console.error("Delete account error:",P),j({title:"Error",description:"Failed to delete account. Please try again.",variant:"destructive"})}finally{l(!1),r(!1),o("")}},k={monthly:{fallbackPrice:"$9.99",period:"/month",savings:null},yearly:{fallbackPrice:"$59.99",period:"/year",savings:"Save 50%"}};return e.jsxs("div",{className:"fixed inset-0 z-50 bg-background flex flex-col items-center justify-center p-6 overflow-y-auto",children:[e.jsxs("div",{className:"w-full max-w-md space-y-6",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"inline-flex items-center justify-center w-20 h-20 rounded-full bg-gradient-to-br from-primary to-accent shadow-glow",children:e.jsx(In,{className:"h-10 w-10 text-primary-foreground"})}),e.jsx("h1",{className:"font-display text-3xl text-foreground",children:"Your Free Trial Has Ended"}),e.jsx("p",{className:"text-muted-foreground",children:"Subscribe to continue your journey with your companion"})]}),e.jsx("div",{className:"flex gap-3",children:["monthly","yearly"].map(P=>e.jsxs(Me,{onClick:()=>s(P),className:E("flex-1 cursor-pointer transition-all relative overflow-hidden",t===P?"border-2 border-primary bg-primary/5 shadow-glow":"border border-border hover:border-primary/50"),children:[k[P].savings&&e.jsx("div",{className:"absolute top-0 right-0 bg-accent text-accent-foreground text-xs font-bold px-2 py-1 rounded-bl-lg",children:k[P].savings}),e.jsxs(wn,{className:"p-4 text-center",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground capitalize mb-1",children:P}),e.jsx("p",{className:"text-2xl font-bold text-foreground",children:(P==="yearly"?S[ns.YEARLY]?.price:S[ns.MONTHLY]?.price)??k[P].fallbackPrice}),e.jsx("p",{className:"text-xs text-muted-foreground",children:k[P].period})]})]},P))}),e.jsx("div",{className:"space-y-3 py-2",children:[{icon:se,text:"All 21 evolution stages"},{icon:Za,text:"Unlimited AI Mentor Chat"},{icon:er,text:"Unlimited Quests & Epics"},{icon:In,text:"All premium features"}].map((P,A)=>e.jsxs("div",{className:"flex items-center gap-3 text-sm",children:[e.jsx(P.icon,{className:"h-5 w-5 text-primary flex-shrink-0"}),e.jsx("span",{className:"text-foreground",children:P.text})]},A))}),!d&&e.jsx("div",{className:"bg-muted/30 rounded-lg p-4",children:e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"In-App Purchases are only available on iOS devices"})}),y&&e.jsxs("div",{className:"flex items-center gap-2 rounded-lg border border-dashed border-muted-foreground/30 px-3 py-2 text-sm text-muted-foreground",children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-muted-foreground"}),"Contacting the App Store..."]}),v&&e.jsxs("div",{className:"rounded-lg border border-destructive/40 bg-destructive/5 p-3 text-sm text-destructive flex flex-col gap-2",children:[e.jsx("span",{children:v}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx(B,{size:"sm",variant:"outline",onClick:()=>{b()},children:"Try Again"}),e.jsx(B,{size:"sm",variant:"ghost",onClick:()=>j({title:"Need help?",description:"Please ensure you're signed in to the App Store and retry."}),children:"Contact support"})]})]}),e.jsx(B,{onClick:R,disabled:f||!d||y||!x||!C,className:"w-full py-7 text-lg font-black uppercase tracking-wider bg-gradient-to-r from-primary to-accent hover:opacity-90 text-primary-foreground shadow-glow",size:"lg",children:f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary-foreground mr-2"}),"Processing..."]}):`Subscribe ${t==="yearly"?"Yearly":"Monthly"}`}),e.jsxs(B,{variant:"ghost",onClick:h,disabled:f,className:"w-full text-muted-foreground hover:text-foreground",children:[e.jsx(bs,{className:"h-4 w-4 mr-2"}),"Restore Purchases"]}),e.jsxs("p",{className:"text-xs text-center text-muted-foreground leading-relaxed",children:["Payment will be charged to your Apple ID account at confirmation of purchase. Subscription automatically renews unless canceled at least 24 hours before the end of the current period. Your account will be charged for renewal within 24 hours prior to the end of the current period. You can manage and cancel your subscriptions by going to Settings ",">"," [Your Name] ",">"," Subscriptions after purchase."]}),e.jsxs("div",{className:"flex justify-center gap-4 text-xs",children:[e.jsx("a",{href:"/privacy",className:"text-muted-foreground underline hover:text-foreground",children:"Privacy Policy"}),e.jsx("a",{href:"/terms",className:"text-muted-foreground underline hover:text-foreground",children:"Terms of Use"})]}),e.jsxs("div",{className:"relative flex items-center py-2",children:[e.jsx("div",{className:"flex-grow border-t border-muted"}),e.jsx("span",{className:"px-3 text-xs text-muted-foreground",children:"or"}),e.jsx("div",{className:"flex-grow border-t border-muted"})]}),e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsxs(B,{variant:"ghost",size:"sm",onClick:T,disabled:u,className:"text-muted-foreground hover:text-foreground",children:[u?e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-1.5"}):e.jsx(hu,{className:"h-4 w-4 mr-1.5"}),"Sign Out"]}),e.jsxs(B,{variant:"ghost",size:"sm",onClick:()=>r(!0),className:"text-muted-foreground hover:text-destructive",children:[e.jsx(es,{className:"h-4 w-4 mr-1.5"}),"Delete Account"]})]})]}),e.jsx(_a,{open:a,onOpenChange:r,children:e.jsxs(Ws,{children:[e.jsxs(Qs,{children:[e.jsx(Gs,{children:"Delete your account?"}),e.jsxs(Ys,{className:"space-y-3",children:[e.jsx("p",{children:"This action is permanent and cannot be undone. All your data, including your companion, progress, and achievements will be permanently deleted."}),e.jsxs("p",{className:"font-medium text-foreground",children:["Type ",e.jsx("span",{className:"font-bold text-destructive",children:"DELETE"})," to confirm:"]}),e.jsx(He,{value:i,onChange:P=>o(P.target.value),placeholder:"Type DELETE",className:"mt-2"})]})]}),e.jsxs(Ks,{children:[e.jsx(Vs,{disabled:c,children:"Cancel"}),e.jsx(ws,{onClick:q,disabled:c||i!=="DELETE",className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-current mr-2"}),"Deleting..."]}):"Delete Account"})]})]})})]})},Ve=({children:t,requireMentor:s=!0})=>{const{user:a,loading:r}=ce(),{hasAccess:i,loading:o}=ah(),c=Ht(),[l,u]=n.useState(0);return n.useEffect(()=>{!r&&!a&&c("/welcome")},[a,r,c]),n.useEffect(()=>{let m;return r||o?m=setInterval(()=>{u(p=>p>=90?p:p+Math.random()*15)},300):u(100),()=>{m&&clearInterval(m)}},[r,o]),r||o?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsxs("div",{className:"w-full max-w-md px-8 space-y-4",children:[e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx("div",{className:"h-12 w-12 mx-auto rounded-full border-4 border-primary border-t-transparent animate-spin"}),e.jsx("p",{className:"text-foreground",children:"Loading..."})]}),e.jsx(ts,{value:l,className:"w-full"})]})}):a?i?e.jsx(e.Fragment,{children:t}):e.jsx(hh,{}):null};class jt extends n.Component{constructor(s){super(s),this.state={hasError:!1,error:null}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,a){console.error("ErrorBoundary caught an error:",s,a)}handleReset=()=>{this.setState({hasError:!1,error:null}),window.location.href="/"};render(){return this.state.hasError?this.props.fallback?this.props.fallback:e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-b from-background to-muted/20 p-4",children:e.jsxs(Me,{className:"max-w-md w-full p-8 text-center",children:[e.jsx(ps,{className:"h-16 w-16 text-destructive mx-auto mb-4"}),e.jsx("h1",{className:"text-2xl font-heading font-bold text-foreground mb-2",children:"Something went wrong"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"We encountered an unexpected error. Don't worry, your data is safe."}),this.state.error&&e.jsxs("details",{className:"mb-6 text-left",children:[e.jsx("summary",{className:"cursor-pointer text-sm text-muted-foreground mb-2",children:"Technical details"}),e.jsx("pre",{className:"text-xs bg-muted p-3 rounded overflow-auto max-h-32",children:this.state.error.toString()})]}),e.jsx(B,{onClick:this.handleReset,className:"w-full",children:"Return to Home"})]})}):this.props.children}}const Wl=({error:t,resetError:s,title:a="Something went wrong",description:r="We encountered an error loading this component."})=>e.jsx(Me,{className:"p-6 border-destructive/50 bg-destructive/5",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:"rounded-full bg-destructive/10 p-3",children:e.jsx(js,{className:"h-6 w-6 text-destructive"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-semibold text-lg",children:a}),e.jsx("p",{className:"text-sm text-muted-foreground max-w-md",children:r}),t&&e.jsxs("details",{className:"text-xs text-left mt-4",children:[e.jsx("summary",{className:"cursor-pointer text-muted-foreground hover:text-foreground",children:"Technical details"}),e.jsx("pre",{className:"mt-2 p-2 bg-muted rounded text-left overflow-auto max-w-md",children:t.message})]})]}),e.jsxs("div",{className:"flex gap-2",children:[s&&e.jsxs(B,{onClick:s,variant:"outline",size:"sm",children:[e.jsx(bs,{className:"h-4 w-4 mr-2"}),"Try Again"]}),e.jsx(B,{onClick:()=>window.location.reload(),variant:"default",size:"sm",children:"Reload Page"})]})]})}),fh=({error:t,resetError:s})=>e.jsx(Wl,{error:t,resetError:s,title:"Missions Unavailable",description:"We couldn't load your daily missions. Don't worry, your progress is safe."}),gh=({error:t,onClose:s})=>e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-background/95 backdrop-blur-sm",children:e.jsx(Me,{className:"p-8 max-w-md mx-4 border-destructive/50 bg-card",children:e.jsxs("div",{className:"flex flex-col items-center text-center space-y-4",children:[e.jsx("div",{className:"rounded-full bg-destructive/10 p-4",children:e.jsx(js,{className:"h-8 w-8 text-destructive"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"font-bold text-xl",children:"Evolution Error"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"We encountered an issue during evolution. Your companion's progress has been saved."}),t&&e.jsxs("details",{className:"text-xs text-left mt-4",children:[e.jsx("summary",{className:"cursor-pointer text-muted-foreground hover:text-foreground",children:"Technical details"}),e.jsx("pre",{className:"mt-2 p-2 bg-muted rounded text-left overflow-auto",children:t.message})]})]}),e.jsx(B,{onClick:s||(()=>window.location.reload()),size:"lg",className:"w-full",children:"Close"})]})})}),xh=({error:t,resetError:s})=>e.jsx(Wl,{error:t,resetError:s,title:"Check-in Unavailable",description:"We couldn't load the check-in form. Please try again in a moment."}),ei={Fire:{name:"Inferno",glowA:"20, 100%, 55%",glowB:"35, 100%, 60%",particleStyle:"embers",confettiColors:["#FF6A3D","#FF9F1C","#FFD700","#FF4500"],confettiSpread:100,confettiGravity:.8,confettiParticleCount:150},Water:{name:"Tidal",glowA:"195, 90%, 55%",glowB:"210, 85%, 50%",particleStyle:"bubbles",confettiColors:["#4FC3F7","#29B6F6","#81D4FA","#B3E5FC"],confettiSpread:140,confettiGravity:.4,confettiParticleCount:120},Earth:{name:"Terran",glowA:"25, 40%, 45%",glowB:"100, 50%, 45%",particleStyle:"leaves",confettiColors:["#795548","#8BC34A","#4CAF50","#A1887F"],confettiSpread:90,confettiGravity:.9,confettiParticleCount:130},Air:{name:"Zephyr",glowA:"200, 80%, 80%",glowB:"190, 70%, 90%",particleStyle:"stardust",confettiColors:["#E3F2FD","#BBDEFB","#90CAF9","#E8F5E9"],confettiSpread:180,confettiGravity:.3,confettiParticleCount:100},Lightning:{name:"Storm",glowA:"50, 100%, 55%",glowB:"270, 70%, 60%",particleStyle:"sparks",confettiColors:["#FFD600","#FFFF00","#7C4DFF","#B388FF"],confettiSpread:120,confettiGravity:1,confettiParticleCount:160},Ice:{name:"Frost",glowA:"185, 70%, 70%",glowB:"190, 50%, 92%",particleStyle:"stardust",confettiColors:["#80DEEA","#B2EBF2","#E0F7FA","#FFFFFF"],confettiSpread:100,confettiGravity:.5,confettiParticleCount:130},Nature:{name:"Verdant",glowA:"120, 50%, 50%",glowB:"100, 50%, 70%",particleStyle:"leaves",confettiColors:["#66BB6A","#81C784","#A5D6A7","#DCEDC8"],confettiSpread:110,confettiGravity:.6,confettiParticleCount:140},Light:{name:"Radiant",glowA:"50, 100%, 75%",glowB:"0, 0%, 100%",particleStyle:"stardust",confettiColors:["#FFF59D","#FFEE58","#FFFFFF","#FFF9C4"],confettiSpread:150,confettiGravity:.4,confettiParticleCount:160},Shadow:{name:"Umbral",glowA:"270, 50%, 50%",glowB:"260, 60%, 25%",particleStyle:"sparks",confettiColors:["#7E57C2","#5E35B1","#9575CD","#D1C4E9"],confettiSpread:80,confettiGravity:.7,confettiParticleCount:120},Cosmic:{name:"Celestial",glowA:"285, 60%, 55%",glowB:"230, 50%, 40%",particleStyle:"stardust",confettiColors:["#AB47BC","#CE93D8","#5C6BC0","#7986CB"],confettiSpread:160,confettiGravity:.35,confettiParticleCount:180}},yh={name:"Hatch",glowA:"45, 100%, 60%",glowB:"35, 100%, 70%",particleStyle:"stardust",confettiColors:["#FFD700","#FFA500","#FFFACD","#FFE4B5","#F0E68C"],confettiSpread:140,confettiGravity:.6,confettiParticleCount:200},bh={name:"Cosmic",glowA:"270, 70%, 55%",glowB:"280, 80%, 65%",particleStyle:"stardust",confettiColors:["#A76CFF","#C084FC","#E879F9","#FFD700"],confettiSpread:120,confettiGravity:.6,confettiParticleCount:150},vh=(t,s)=>s?yh:t&&ei[t]?ei[t]:bh,wh=({phase:t,particleStyle:s})=>{const a=n.useMemo(()=>Array.from({length:12},(r,i)=>({id:i,angle:i/12*Math.PI*2,startRadius:180})),[]);return t==="settle"?null:e.jsx("div",{className:"absolute inset-0 flex items-center justify-center pointer-events-none",children:a.map(r=>e.jsx(_.div,{className:`absolute w-2 h-2 evo-particle evo-particle-${s}`,initial:{x:Math.cos(r.angle)*r.startRadius,y:Math.sin(r.angle)*r.startRadius,opacity:.3,scale:1},animate:{x:t==="impact"?0:Math.cos(r.angle)*60,y:t==="impact"?0:Math.sin(r.angle)*60,opacity:t==="impact"?0:.7,scale:t==="impact"?.2:.8},transition:{duration:t==="impact"?.6:1.2,ease:[.25,.1,.25,1]}},r.id))})},jh=({phase:t,show:s})=>{if(!s)return null;const a=t==="anticipation"||t==="impact",r=t==="impact";return e.jsxs("div",{className:"absolute inset-0 pointer-events-none z-10 flex items-center justify-center",children:[e.jsx(_.div,{className:"absolute inset-0",initial:{opacity:.6},animate:{opacity:t==="reveal"||t==="settle"?0:.4},transition:{duration:.5},style:{background:"radial-gradient(ellipse 60% 70% at 50% 50%, transparent 40%, hsl(45, 50%, 15%) 100%)"}}),e.jsxs("svg",{className:"absolute w-full h-full",viewBox:"0 0 400 400",preserveAspectRatio:"xMidYMid slice",children:[e.jsx(_.path,{d:"M200 100 L210 150 L195 180 L205 220 L190 280",fill:"none",stroke:"hsl(50, 100%, 80%)",strokeWidth:"3",className:a?"evo-crack-path drawing":"evo-crack-path",initial:{opacity:0},animate:{opacity:a?1:0},style:{filter:"drop-shadow(0 0 8px hsl(50, 100%, 70%))"}}),e.jsx(_.path,{d:"M200 100 L185 155 L200 190 L180 240 L195 300",fill:"none",stroke:"hsl(50, 100%, 80%)",strokeWidth:"2",className:a?"evo-crack-path drawing delay-100":"evo-crack-path",initial:{opacity:0},animate:{opacity:a?1:0},style:{filter:"drop-shadow(0 0 6px hsl(50, 100%, 70%))"}}),e.jsx(_.path,{d:"M200 100 L220 140 L210 200 L230 260",fill:"none",stroke:"hsl(50, 100%, 80%)",strokeWidth:"2",className:a?"evo-crack-path drawing delay-150":"evo-crack-path",initial:{opacity:0},animate:{opacity:a?1:0},style:{filter:"drop-shadow(0 0 6px hsl(50, 100%, 70%))"}})]}),r&&e.jsx(_.div,{className:"absolute left-1/2 top-1/2 -translate-x-1/2 -translate-y-1/2 w-2 h-48 evo-seam-flash",style:{background:"linear-gradient(180deg, transparent 0%, hsl(50, 100%, 90%) 50%, transparent 100%)"}}),t==="impact"&&e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:Array.from({length:8}).map((i,o)=>e.jsx(_.div,{className:"absolute w-3 h-4 bg-gradient-to-br from-amber-100 to-amber-200 rounded-sm",initial:{x:0,y:0,rotate:0,opacity:1,scale:1},animate:{x:Math.cos(o/8*Math.PI*2)*140,y:Math.sin(o/8*Math.PI*2)*110+40,rotate:Math.random()*360,opacity:0,scale:.3},transition:{duration:1,ease:"easeOut",delay:o*.02}},o))})]})},_h=({isEvolving:t,newStage:s,newImageUrl:a,mentorSlug:r,userId:i,element:o,onComplete:c})=>{const[l,u]=n.useState("anticipation"),[m,p]=n.useState(""),[h,f]=n.useState(!0),[d,g]=n.useState(!1),[y,v]=n.useState(!1),[b,x]=n.useState(!1),[j,w]=n.useState(!1),D=n.useRef(null),S=n.useRef(null),M=n.useRef(null),C=n.useRef([]),R=s===1,T=n.useMemo(()=>vh(o,R),[o,R]),q=n.useMemo(()=>typeof window<"u"&&window.matchMedia("(prefers-reduced-motion: reduce)").matches,[]),k=n.useCallback(()=>{if(D.current)try{D.current.pause(),D.current.currentTime=0,D.current.src=""}catch(L){console.error("Error cleaning up audio:",L)}finally{D.current=null}},[]);n.useEffect(()=>{if(!t||!a)return;x(!1);const L=new Image;L.src=a,L.onload=()=>x(!0),L.onerror=()=>x(!0);const H=setTimeout(()=>x(!0),2e3);return()=>clearTimeout(H)},[t,a]),n.useEffect(()=>{if(!t||!b)return;let L=!0;return u("anticipation"),g(!1),Dp(),$e.light(),(async()=>{if(!r||!i){L&&f(!1);return}try{const{data:I,error:te}=await N.functions.invoke("generate-evolution-voice",{body:{mentorSlug:r,newStage:s,userId:i,isFirstEvolution:R}});if(te)throw te;if(!L)return;I?.voiceLine&&p(I.voiceLine),I?.audioContent&&(D.current=new Audio(`data:audio/mp3;base64,${I.audioContent}`)),f(!1)}catch(I){console.error("Failed to generate evolution voice:",I),L&&(p(R?"A new companion has hatched! Your journey together begins now.":"Your companion has evolved to a new stage!"),f(!1))}})(),M.current=window.setTimeout(()=>{L&&(console.warn("Evolution modal timeout reached, showing emergency exit"),v(!0))},15e3),C.current=[],C.current.push(setTimeout(()=>{L&&(u("impact"),$e.heavy(),S.current&&!q&&(S.current.classList.add("animate-evolution-pulse-hit"),setTimeout(()=>{S.current?.classList.remove("animate-evolution-pulse-hit")},600)))},1200)),C.current.push(setTimeout(()=>{L&&(u("reveal"),Pp(),D.current&&!h&&!sn.getMuted()&&D.current.play().catch(I=>console.error("Audio play failed:",I)),q||setTimeout(()=>{ut({particleCount:T.confettiParticleCount,spread:T.confettiSpread,origin:{y:.5},colors:T.confettiColors,ticks:400,gravity:T.confettiGravity,scalar:R?1.8:1.5}),$e.medium(),setTimeout(()=>{ut({particleCount:50,spread:60,origin:{y:.7,x:.25},colors:T.confettiColors.slice(0,2)}),ut({particleCount:50,spread:60,origin:{y:.7,x:.75},colors:T.confettiColors.slice(2)})},200)},100))},2200)),C.current.push(setTimeout(()=>{L&&(u("settle"),setTimeout(()=>{L&&g(!0)},800))},3600)),()=>{L=!1,C.current.forEach(clearTimeout),C.current=[],M.current&&(clearTimeout(M.current),M.current=null),k()}},[t,b,h,r,i,s,k,q,R,T]);const P=L=>{if(!d){L.preventDefault(),L.stopPropagation();return}k(),console.log("[CompanionEvolution] Dispatching evolution events and closing modal"),window.dispatchEvent(new CustomEvent("companion-evolved")),window.dispatchEvent(new CustomEvent("evolution-complete")),window.dispatchEvent(new CustomEvent("evolution-modal-closed")),c()},A=()=>{console.log("[CompanionEvolution] Emergency exit triggered"),k(),M.current&&(clearTimeout(M.current),M.current=null),window.dispatchEvent(new CustomEvent("evolution-modal-closed")),c()};return t?b?e.jsx(be,{mode:"wait",children:t&&e.jsxs(_.div,{ref:S,initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.5},role:"alertdialog","aria-labelledby":"evolution-title","aria-describedby":"evolution-description",className:`fixed inset-0 z-[9999] flex items-center justify-center overflow-hidden gpu-layer evo-card ${d?"cursor-pointer":""}`,onClick:P,onTouchStart:L=>!d&&L.preventDefault(),"data-particles":T.particleStyle,style:{pointerEvents:"auto",touchAction:d?"auto":"none",background:R?"radial-gradient(circle at center, rgba(50, 40, 0, 0.8) 0%, rgba(0, 0, 0, 0.95) 60%, black 100%)":"radial-gradient(circle at center, rgba(0, 0, 0, 0.7) 0%, rgba(0, 0, 0, 0.95) 70%, black 100%)",paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)",paddingLeft:"env(safe-area-inset-left)",paddingRight:"env(safe-area-inset-right)","--evo-glow-a":T.glowA,"--evo-glow-b":T.glowB},children:[e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"radial-gradient(ellipse at center, transparent 40%, rgba(0,0,0,0.6) 100%)"}}),(l==="reveal"||l==="settle")&&!q&&e.jsx(_.div,{className:"absolute inset-0 will-change-transform evo-glow",initial:{opacity:0,scale:.8},animate:{opacity:[.3,.5,.3],scale:[1,1.1,1]},transition:{duration:3,repeat:1/0,ease:"easeInOut"}}),!q&&e.jsx(wh,{phase:l,particleStyle:T.particleStyle}),R&&e.jsx(jh,{phase:l,show:l!=="settle"}),e.jsxs("div",{className:"flex flex-col items-center justify-center gap-6 max-w-4xl w-full px-6 relative z-10",children:[e.jsx(be,{mode:"wait",children:l==="anticipation"&&e.jsx(_.div,{initial:{opacity:0,scale:.9,filter:"blur(10px)"},animate:{opacity:1,scale:1,filter:"blur(0px)"},exit:{opacity:0,scale:1.05,filter:"blur(5px)"},transition:{duration:.6},className:"text-center will-change-transform",children:e.jsx("h2",{id:"evolution-title",className:"text-3xl sm:text-4xl md:text-5xl font-black text-white tracking-wider",style:{textShadow:`0 0 30px hsl(${T.glowA}), 0 0 60px hsl(${T.glowB} / 0.6)`},children:R?"Something Stirs Within...":"Evolution Awakens..."})},"prophetic-text")}),e.jsx(be,{children:(l==="reveal"||l==="settle")&&e.jsxs(_.div,{initial:{opacity:0,scale:.92,filter:"blur(12px)"},animate:{opacity:1,scale:1,filter:"blur(0px)"},transition:{duration:1,ease:[.22,1,.36,1]},className:"relative flex items-center justify-center will-change-transform",style:{width:"100%",maxWidth:"600px",height:"55vh",maxHeight:"450px"},children:[e.jsx(_.div,{className:"absolute inset-0 will-change-transform",animate:l==="settle"?{scale:[1,1.08,1],opacity:[.4,.6,.4]}:{},transition:{duration:3,repeat:1/0,ease:"easeInOut"},style:{background:`radial-gradient(circle, hsl(${T.glowA} / 0.35) 0%, transparent 70%)`,filter:"blur(30px)"}}),e.jsx(se,{className:"absolute -top-4 -left-4 w-10 h-10 text-primary animate-pulse will-change-transform",style:{filter:"drop-shadow(0 0 12px currentColor)"}}),e.jsx(se,{className:"absolute -top-4 -right-4 w-10 h-10 text-accent animate-pulse will-change-transform",style:{filter:"drop-shadow(0 0 12px currentColor)",animationDelay:"0.2s"}}),e.jsx(se,{className:"absolute -bottom-4 -left-4 w-10 h-10 text-accent animate-pulse will-change-transform",style:{filter:"drop-shadow(0 0 12px currentColor)",animationDelay:"0.4s"}}),e.jsx(se,{className:"absolute -bottom-4 -right-4 w-10 h-10 text-primary animate-pulse will-change-transform",style:{filter:"drop-shadow(0 0 12px currentColor)",animationDelay:"0.6s"}}),e.jsxs(_.div,{className:"relative rounded-2xl overflow-hidden will-change-transform",animate:l==="settle"?{scale:[1,1.01,1]}:{},transition:{duration:3,repeat:1/0,ease:"easeInOut"},style:{width:"100%",height:"100%",maxWidth:"520px",border:`3px solid hsl(${T.glowA} / 0.6)`,boxShadow:`0 0 40px hsl(${T.glowA} / 0.4), inset 0 0 30px hsl(${T.glowB} / 0.1)`},children:[!q&&e.jsx(_.div,{className:"absolute inset-0 pointer-events-none z-10",animate:{backgroundPosition:["200% 0%","-200% 0%"]},transition:{duration:2.5,repeat:1/0,ease:"linear"},style:{background:"linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.15) 50%, transparent 100%)",backgroundSize:"200% 100%"}}),e.jsx("img",{src:a,alt:"Evolved companion",className:"w-full h-full object-cover transition-opacity duration-300",style:{opacity:j?1:0},loading:"eager",onLoad:()=>w(!0)})]})]},"companion-wrapper")}),e.jsx(be,{children:(l==="reveal"||l==="settle")&&e.jsxs(_.div,{initial:{opacity:0,y:20,scale:.95},animate:{opacity:1,y:0,scale:1},transition:{type:"spring",stiffness:150,damping:18,delay:.2},className:"text-center space-y-3 will-change-transform",children:[e.jsx(_.h1,{className:"text-4xl sm:text-5xl md:text-6xl font-black uppercase tracking-tight",style:{background:R?"linear-gradient(135deg, #FFD700, #FFA500, #FFD700)":`linear-gradient(135deg, hsl(${T.glowA}), hsl(${T.glowB}), hsl(${T.glowA}))`,backgroundSize:"200% 200%",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent",backgroundClip:"text",filter:`drop-shadow(0 0 20px hsl(${T.glowA} / 0.6))`},animate:{backgroundPosition:["0% 50%","100% 50%","0% 50%"]},transition:{duration:4,repeat:1/0,ease:"linear"},children:R?"Hatched!":"Evolved!"}),e.jsx("p",{id:"evolution-description",className:"text-lg sm:text-xl md:text-2xl font-semibold text-white/90",style:{textShadow:"0 0 15px rgba(255, 255, 255, 0.5)"},children:R?"Your companion has emerged!":"Your companion grows stronger!"}),l==="settle"&&m&&e.jsx(_.div,{initial:{opacity:0,y:15,scale:.95},animate:{opacity:1,y:0,scale:1},transition:{delay:.3,duration:.4},className:"max-w-lg mx-auto mt-5",children:e.jsx("div",{className:"relative p-5 rounded-xl bg-white/5 border border-white/20 backdrop-blur-md",style:{boxShadow:"0 8px 32px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255,255,255,0.1)"},children:e.jsxs("p",{className:"text-base sm:text-lg text-white/95 font-medium italic leading-relaxed",children:['"',m,'"']})})})]},"announcement")}),e.jsx(be,{children:d&&!y&&e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0},transition:{delay:.2},className:"absolute left-1/2 transform -translate-x-1/2",style:{bottom:"calc(1.5rem + env(safe-area-inset-bottom, 0px))"},children:e.jsx(_.p,{className:"text-white/90 text-base sm:text-lg font-medium",animate:{opacity:[.6,1,.6]},transition:{duration:2,repeat:1/0},children:"Tap anywhere to continue âœ¨"})})}),y&&e.jsx(_.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"absolute z-[10002]",style:{top:"calc(1rem + env(safe-area-inset-top, 0px))",right:"calc(1rem + env(safe-area-inset-right, 0px))"},children:e.jsx("button",{onClick:L=>{L.stopPropagation(),A()},className:"bg-destructive/90 hover:bg-destructive text-destructive-foreground font-bold px-4 py-2 rounded-lg shadow-lg transition-colors","aria-label":"Close evolution modal",children:"âœ• Close"})})]})]})}):e.jsx("div",{className:"fixed inset-0 z-[9999] flex items-center justify-center bg-black/90",style:{paddingTop:"env(safe-area-inset-top)",paddingBottom:"env(safe-area-inset-bottom)"},children:e.jsx(_.div,{animate:{scale:[1,1.1,1],opacity:[.5,1,.5]},transition:{duration:1.5,repeat:1/0},className:"text-primary text-xl font-medium",children:"Preparing evolution..."})}):null},Nh=t=>e.jsx(jt,{fallback:e.jsx(gh,{onClose:t.onComplete}),children:e.jsx(_h,{...t})}),kh=()=>{const{user:t}=ce(),{profile:s}=yt(),a=Se(),{setIsEvolvingLoading:r,onEvolutionComplete:i}=lr(),{setEvolutionInProgress:o}=Bp(),[c,l]=n.useState(!1),u=Us(s),[m,p]=n.useState(null),[h,f]=n.useState(null);return n.useEffect(()=>{if(!t)return;const d=N.channel("companion-evolution").on("postgres_changes",{event:"UPDATE",schema:"public",table:"user_companion",filter:`user_id=eq.${t.id}`},async g=>{const y=g.new,v=g.old;if(!y||!v){ee.warn("Evolution listener: Missing payload data");return}const b=typeof y.current_stage=="number"?y.current_stage:null,x=typeof v.current_stage=="number"?v.current_stage:null;if(b===null||x===null){ee.warn("Evolution listener: Invalid stage values");return}if(b>x){const j=typeof y.id=="string"?y.id:null;if(!j){ee.warn("Evolution listener: Missing companion id");return}const[w,D]=await Promise.all([N.from("companion_evolutions").select("image_url").eq("companion_id",j).eq("stage",b).order("evolved_at",{ascending:!1}).limit(1).maybeSingle(),N.from("user_companion").select("core_element").eq("id",j).maybeSingle()]),S=typeof y.current_image_url=="string"?y.current_image_url:"",M=w.data?.image_url||S,C=D.data?.core_element||void 0;let R;if(u){const{data:k}=await N.from("mentors").select("slug").eq("id",u).maybeSingle();R=k?.slug}f(x),p({stage:b,imageUrl:M,mentorSlug:R,element:C}),l(!0),o(!0),window.dispatchEvent(new CustomEvent("evolution-loading-start"));const T=new Date().toISOString().split("T")[0],q=b===1;N.from("companion_memories").insert({user_id:t.id,companion_id:j,memory_type:q?"first_evolution":"evolution",memory_date:T,memory_context:{title:q?"First Evolution":`Evolved to Stage ${b}`,description:q?"The first transformation - proof of our growing bond.":`Another beautiful transformation, reaching stage ${b}.`,emotion:q?"pride":"joy",details:{stage:b,previousStage:x}},referenced_count:0}).then(({error:k})=>{k&&ee.error("Failed to create evolution memory:",k)}),t?.id&&a.invalidateQueries({queryKey:["companion",t.id]})}}).subscribe((g,y)=>{g==="SUBSCRIBED"||(g==="CHANNEL_ERROR"||g==="TIMED_OUT")&&ee.warn("Evolution listener subscription error",{status:g,error:y?.message})});return()=>{N.removeChannel(d)}},[t,t?.id,u,a,o]),!c||!m?null:e.jsx(Nh,{isEvolving:c,newStage:m.stage,newImageUrl:m.imageUrl,mentorSlug:m.mentorSlug,element:m.element,userId:t?.id,onComplete:()=>{l(!1),p(null),f(null),r(!1),o(!1),i&&i()}})},Ch=()=>{const{user:t}=ce(),s=Se();n.useEffect(()=>{if(!t?.id)return;const a=N.channel(`habits-sync-${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"habits",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["habits",t.id]}),s.invalidateQueries({queryKey:["habits"]}),s.invalidateQueries({queryKey:["habit-surfacing"]}),s.invalidateQueries({queryKey:["epics"]})}).on("postgres_changes",{event:"*",schema:"public",table:"habit_completions",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["habit-completions",t.id]}),s.invalidateQueries({queryKey:["habit-completions"]}),s.invalidateQueries({queryKey:["habits",t.id]}),s.invalidateQueries({queryKey:["habits"]}),s.invalidateQueries({queryKey:["quest-autocomplete-habits",t.id]})}).subscribe((r,i)=>{(r==="CHANNEL_ERROR"||r==="TIMED_OUT")&&ee.warn("Habits realtime subscription error",{status:r,error:i?.message})});return()=>{N.removeChannel(a)}},[t?.id,s])},Sh=()=>{const{user:t}=ce(),s=Se();n.useEffect(()=>{if(!t?.id)return;const a=N.channel(`epics-sync-${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"epics",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["epics",t.id]}),s.invalidateQueries({queryKey:["epics"]}),s.invalidateQueries({queryKey:["epic-progress"]}),s.invalidateQueries({queryKey:["habit-surfacing"]})}).subscribe((r,i)=>{(r==="CHANNEL_ERROR"||r==="TIMED_OUT")&&ee.warn("Epics realtime subscription error",{status:r,error:i?.message})});return()=>{N.removeChannel(a)}},[t?.id,s])},Th=()=>{const{user:t}=ce(),s=Se();n.useEffect(()=>{if(!t?.id)return;const a=N.channel(`daily-tasks-sync-${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"daily_tasks",filter:`user_id=eq.${t.id}`},()=>{s.invalidateQueries({queryKey:["daily-tasks"]}),s.invalidateQueries({queryKey:["tasks"]}),s.invalidateQueries({queryKey:["calendar-tasks"]}),s.invalidateQueries({queryKey:["habit-surfacing"]})}).subscribe((r,i)=>{(r==="CHANNEL_ERROR"||r==="TIMED_OUT")&&ee.warn("Daily tasks realtime subscription error",{status:r,error:i?.message})});return()=>{N.removeChannel(a)}},[t?.id,s])},Eh=({children:t})=>(ce(),Ch(),Sh(),Th(),e.jsx(e.Fragment,{children:t})),Mh=()=>{const[t,s]=n.useState(null),[a,r]=n.useState(!1);n.useEffect(()=>{const c=l=>{l.preventDefault(),s(l),r(!0)};return window.addEventListener("beforeinstallprompt",c),()=>window.removeEventListener("beforeinstallprompt",c)},[]);const i=async()=>{if(!t)return;t.prompt();const{outcome:c}=await t.userChoice;c==="accepted"&&(s(null),r(!1))},o=()=>{r(!1),qe.setItem("pwa-install-dismissed","true")};return!a||qe.getItem("pwa-install-dismissed")?null:e.jsxs(Me,{className:"fixed bottom-36 left-4 right-4 p-4 z-50 bg-card border-border shadow-lg md:left-auto md:right-4 md:max-w-sm",children:[e.jsx("button",{onClick:o,className:"absolute top-2 right-2 p-1 hover:bg-muted rounded-full transition-colors",children:e.jsx(Qe,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 bg-primary/10 rounded-lg",children:e.jsx(fu,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-semibold text-sm mb-1",children:"Install Cosmiq"}),e.jsx("p",{className:"text-xs text-muted-foreground mb-3",children:"Add to your home screen for quick access and offline support"}),e.jsx(B,{onClick:i,size:"sm",className:"w-full",children:"Install App"})]})]})]})},Dh=async()=>{if(Ke.isNativePlatform())try{await vo.lock({orientation:"portrait"}),console.log("Orientation locked to portrait")}catch(t){console.error("Failed to lock orientation:",t)}},_v=async()=>{if(Ke.isNativePlatform())try{await vo.lock({orientation:"landscape"}),console.log("Orientation locked to landscape")}catch(t){console.error("Failed to lock to landscape:",t)}};function ur(){try{const t=Ke.isNativePlatform(),s=Ke.getPlatform(),a=t&&s==="ios";return console.log("[NativePush] Platform check:",{isNative:t,platform:s,isSupported:a}),ee.info("[NativePush] Platform check:",{isNative:t,platform:s,isSupported:a}),a}catch(t){return console.log("[NativePush] Platform check error:",t),ee.info("Native push not available:",t),!1}}async function Ph(t){if(console.log("[NativePush] ========== INIT START =========="),console.log("[NativePush] User ID:",t),!ur()){console.log("[NativePush] Not supported on this platform, aborting"),ee.info("Native push not supported on this platform");return}try{console.log("[NativePush] Step 1: Requesting permissions...");const s=await Gt.requestPermissions();if(console.log("[NativePush] Permission result:",s),console.log("[NativePush] Permission receive status:",s.receive),s.receive!=="granted")throw console.log("[NativePush] Permission DENIED - user did not grant access"),ee.log("Push notification permission denied"),new Error("Push notification permission denied. Please enable in Settings.");console.log("[NativePush] Step 2: Permission granted, registering with APNs..."),await Gt.register(),console.log("[NativePush] Step 3: Registration initiated, setting up listeners..."),await Gt.addListener("registration",async a=>{console.log("[NativePush] âœ… REGISTRATION SUCCESS"),console.log("[NativePush] Device token received"),ee.log("Push registration success");try{await Ah(t,a.value),console.log("[NativePush] Token saved to database successfully")}catch(r){console.log("[NativePush] âŒ Failed to save token:",r)}}),await Gt.addListener("registrationError",a=>{console.log("[NativePush] âŒ REGISTRATION ERROR"),console.log("[NativePush] Error details:",JSON.stringify(a)),ee.error("Push registration error:",a)}),await Gt.addListener("pushNotificationReceived",a=>{console.log("[NativePush] Notification received:",a),ee.log("Push notification received:",a)}),await Gt.addListener("pushNotificationActionPerformed",a=>{console.log("[NativePush] Notification action performed:",a),ee.log("Push notification action performed:",a);const r=a.notification.data;r?.url&&window.dispatchEvent(new CustomEvent("native-push-navigation",{detail:r.url}))}),console.log("[NativePush] ========== INIT COMPLETE ==========")}catch(s){throw console.log("[NativePush] âŒ INIT FAILED"),console.log("[NativePush] Error:",s),ee.error("Error initializing native push:",s),s}}async function Ah(t,s){console.log("[NativePush] Saving token to database..."),console.log("[NativePush] User:",t),console.log("[NativePush] Token (first 20 chars):",s.substring(0,20)+"...");try{const{error:a}=await N.from("push_device_tokens").upsert({user_id:t,device_token:s,platform:"ios",user_agent:navigator.userAgent},{onConflict:"user_id,device_token"});if(a)throw console.log("[NativePush] Database error:",a),ee.error("Error saving device token:",a),a;console.log("[NativePush] âœ… Device token saved successfully"),ee.log("Device token saved successfully")}catch(a){throw console.log("[NativePush] âŒ Error saving device token:",a),ee.error("Error saving device token:",a),a}}async function Nv(t){if(console.log("[NativePush] Unregistering..."),!!ur())try{await Gt.removeAllListeners();const s=await Gt.getDeliveredNotifications();console.log("[NativePush] Delivered notifications:",s);const{error:a}=await N.from("push_device_tokens").delete().eq("user_id",t).eq("platform","ios");a?(console.log("[NativePush] Error deleting token:",a),ee.error("Error deleting device token:",a)):console.log("[NativePush] Token deleted from database")}catch(s){throw console.log("[NativePush] Unregister error:",s),ee.error("Error unregistering from push:",s),s}}async function kv(t){try{const{data:s,error:a}=await N.from("push_device_tokens").select("id").eq("user_id",t).eq("platform","ios").limit(1);if(a)throw a;const r=(s?.length||0)>0;return console.log("[NativePush] Has active subscription:",r),r}catch(s){return console.log("[NativePush] Error checking subscription:",s),ee.error("Error checking native push subscription:",s),!1}}async function Cv(t){const s=Ke.getPlatform(),a=Ke.isNativePlatform(),r=ur();let i="unknown",o;try{r&&(i=(await Gt.checkPermissions()).receive)}catch(l){o=l instanceof Error?l.message:String(l)}const c={platform:s,isNative:a,isSupported:r,permissionStatus:i,error:o};return console.log("[NativePush] Debug info:",c),c}const ct=jo,Rh=xu,Ih=wo,Ql=n.forwardRef(({className:t,...s},a)=>e.jsx(tr,{ref:a,className:E("fixed inset-0 z-50 bg-black/58 backdrop-blur-[2px] data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...s}));Ql.displayName=tr.displayName;const ot=n.forwardRef(({className:t,children:s,hideCloseButton:a,...r},i)=>e.jsxs(Ih,{children:[e.jsx(Ql,{}),e.jsxs(sr,{ref:i,className:E("fixed left-[50%] top-[50%] z-50 grid w-full max-w-lg translate-x-[-50%] translate-y-[-50%] gap-4 border border-border/70 bg-card/92 p-6 shadow-[0_20px_44px_rgba(0,0,0,0.34)] backdrop-blur-xl duration-200 overscroll-contain data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:slide-out-to-left-1/2 data-[state=closed]:slide-out-to-top-[49%] data-[state=open]:slide-in-from-left-1/2 data-[state=open]:slide-in-from-top-[51%] sm:rounded-2xl",t),...r,children:[s,!a&&e.jsxs(gu,{className:"absolute right-4 top-4 rounded-sm opacity-70 ring-offset-background transition-opacity data-[state=open]:bg-accent data-[state=open]:text-muted-foreground hover:opacity-100 focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2 disabled:pointer-events-none",children:[e.jsx(Qe,{className:"h-4 w-4"}),e.jsx("span",{className:"sr-only",children:"Close"})]})]})]}));ot.displayName=sr.displayName;const as=({className:t,...s})=>e.jsx("div",{className:E("flex flex-col space-y-1.5 text-center sm:text-left",t),...s});as.displayName="DialogHeader";const St=n.forwardRef(({className:t,...s},a)=>e.jsx(ar,{ref:a,className:E("text-lg font-semibold leading-none tracking-tight",t),...s}));St.displayName=ar.displayName;const _s=n.forwardRef(({className:t,...s},a)=>e.jsx(rr,{ref:a,className:E("text-sm text-muted-foreground",t),...s}));_s.displayName=rr.displayName;const qh={common:45,uncommon:60,rare:75,epic:90,legendary:120},Lh={common:{playerHP:100,adversaryHP:80,attackDamage:12},uncommon:{playerHP:100,adversaryHP:100,attackDamage:15},rare:{playerHP:100,adversaryHP:120,attackDamage:18},epic:{playerHP:100,adversaryHP:150,attackDamage:22},legendary:{playerHP:100,adversaryHP:180,attackDamage:28}},Sv={tap_sequence:{levelComplete:20,perfectLevel:30},galactic_match:{levelComplete:20,perfectLevel:30},soul_serpent:{scoreMilestone:25},starfall_dodge:{survivalMilestone:20},energy_beam:{waveComplete:25,bossKill:15},orb_match:{scoreTarget:35,specialActivation:10},eclipse_timing:{songComplete:999,tooManyMisses:999},astral_frequency:{distanceMilestone:12}},Fh={perfect:70};function Oh(t,s,a){return a?"fail":t/s*100>=Fh.perfect?"perfect":"good"}const $h={0:"Egg",1:"Hatchling",2:"Sproutling",3:"Cub",4:"Juvenile",5:"Apprentice",6:"Scout",7:"Fledgling",8:"Warrior",9:"Guardian",10:"Champion",11:"Ascended",12:"Vanguard",13:"Titan",14:"Mythic",15:"Prime",16:"Regal",17:"Eternal",18:"Transcendent",19:"Apex",20:"Ultimate Form"},mr=t=>$h[t]||`Stage ${t}`,ti={common:{primary:"hsl(220, 13%, 50%)",glow:"rgba(100, 116, 139, 0.5)",bg:"from-slate-500/20 to-slate-700/10"},uncommon:{primary:"hsl(142, 76%, 46%)",glow:"rgba(34, 197, 94, 0.5)",bg:"from-emerald-500/20 to-emerald-700/10"},rare:{primary:"hsl(217, 91%, 60%)",glow:"rgba(59, 130, 246, 0.5)",bg:"from-blue-500/20 to-blue-700/10"},epic:{primary:"hsl(271, 91%, 65%)",glow:"rgba(168, 85, 247, 0.5)",bg:"from-purple-500/20 to-purple-700/10"},legendary:{primary:"hsl(38, 92%, 50%)",glow:"rgba(245, 158, 11, 0.6)",bg:"from-amber-500/20 to-orange-600/10"}},Bh=({companionImageUrl:t,companionName:s="Companion",companionStage:a=0,adversary:r,adversaryImageUrl:i,isLoadingImage:o,onReady:c,onPass:l})=>{const u=ti[r.tier]||ti.common,m=n.useMemo(()=>Array.from({length:15},(h,f)=>({id:f,top:f*7+3,duration:.6+f%5*.15,delay:f%7*.1})),[]),p=n.useMemo(()=>Array.from({length:20},(h,f)=>({id:f,x:f%5*25,y:Math.floor(f/5)*25,size:2+f%3,duration:2+f%3,delay:f%5*.3})),[]);return e.jsxs("div",{className:"relative w-full h-[520px] overflow-hidden bg-gradient-to-b from-background via-background/95 to-background",children:[e.jsxs("div",{className:"absolute inset-0",children:[p.map(h=>e.jsx(_.div,{className:"absolute rounded-full bg-white/60",style:{left:`${h.x}%`,top:`${h.y}%`,width:h.size,height:h.size},animate:{opacity:[.2,.8,.2],scale:[1,1.5,1]},transition:{duration:h.duration,repeat:1/0,delay:h.delay}},h.id)),m.map(h=>e.jsx(_.div,{className:"absolute h-[1px] w-full",style:{top:`${h.top}%`,background:"linear-gradient(90deg, transparent 0%, hsl(var(--primary) / 0.4) 50%, transparent 100%)"},animate:{x:["-100%","100%"],opacity:[0,1,0]},transition:{duration:h.duration,repeat:1/0,delay:h.delay,ease:"linear"}},h.id)),e.jsxs("svg",{className:"absolute inset-0 w-full h-full",preserveAspectRatio:"none",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"dividerGradient",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"hsl(var(--primary))",stopOpacity:"0.3"}),e.jsx("stop",{offset:"50%",stopColor:"white",stopOpacity:"0.1"}),e.jsx("stop",{offset:"100%",style:{stopColor:u.primary},stopOpacity:"0.3"})]})}),e.jsx(_.line,{x1:"50%",y1:"0",x2:"50%",y2:"100%",stroke:"url(#dividerGradient)",strokeWidth:"2",initial:{pathLength:0},animate:{pathLength:1},transition:{duration:.8,delay:.2}})]}),e.jsx("div",{className:"absolute inset-y-0 left-0 w-1/2 bg-gradient-to-r from-primary/10 via-primary/5 to-transparent"}),e.jsx("div",{className:"absolute inset-y-0 right-0 w-1/2",style:{background:`linear-gradient(to left, ${u.glow}, transparent)`}})]}),e.jsxs("div",{className:"relative z-10 h-full flex flex-col",children:[e.jsxs("div",{className:"flex-1 flex items-center relative min-h-0",children:[e.jsxs(_.div,{className:"flex-1 h-full flex flex-col items-center justify-center px-3",initial:{x:"-100%",opacity:0},animate:{x:0,opacity:1},transition:{type:"spring",stiffness:70,damping:18,delay:.1},children:[e.jsxs(_.div,{className:"relative w-36 h-36 sm:w-44 sm:h-44",animate:{y:[0,-6,0]},transition:{duration:3.5,repeat:1/0,ease:"easeInOut"},children:[e.jsx(_.div,{className:"absolute -inset-4 rounded-full",style:{background:"radial-gradient(circle, hsl(var(--primary) / 0.3) 0%, transparent 70%)"},animate:{scale:[1,1.2,1],opacity:[.4,.7,.4]},transition:{duration:2.5,repeat:1/0}}),e.jsx("div",{className:"relative w-full h-full rounded-2xl overflow-hidden border-2 border-primary/40 shadow-[0_0_30px_hsl(var(--primary)/0.3)]",children:t?e.jsx("img",{src:t,alt:s,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center",children:e.jsx(se,{className:"w-12 h-12 text-primary"})})})]}),e.jsxs(_.div,{className:"mt-3 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5},children:[e.jsx("p",{className:"text-base font-bold text-foreground",children:s}),e.jsx("p",{className:"text-[10px] text-primary/80 font-medium uppercase tracking-wider",children:mr(a)})]})]}),e.jsxs(_.div,{className:"absolute left-[43%] top-[35%] -translate-x-1/2 -translate-y-1/2 z-20",initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",stiffness:300,damping:20,delay:.3},children:[e.jsx(_.div,{className:"absolute inset-0 rounded-lg blur-xl",style:{background:`${u.primary}40`},animate:{scale:[1,1.3,1],opacity:[.5,.8,.5]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx("div",{className:"relative px-3 py-1.5 bg-background/95 border border-primary/50 rounded-md backdrop-blur-sm",style:{boxShadow:`0 0 20px ${u.glow}`},children:e.jsx("span",{className:"text-lg sm:text-xl font-black tracking-tight",style:{background:`linear-gradient(135deg, hsl(var(--primary)) 0%, ${u.primary} 100%)`,backgroundClip:"text",WebkitBackgroundClip:"text",WebkitTextFillColor:"transparent"},children:"VS"})})]}),e.jsxs(_.div,{className:"flex-1 h-full flex flex-col items-center justify-center px-3",initial:{x:"100%",opacity:0},animate:{x:0,opacity:1},transition:{type:"spring",stiffness:70,damping:18,delay:.1},children:[e.jsxs(_.div,{className:"relative w-36 h-36 sm:w-44 sm:h-44",animate:{y:[0,-6,0]},transition:{duration:3.5,repeat:1/0,ease:"easeInOut",delay:.5},children:[e.jsx(_.div,{className:"absolute -inset-4 rounded-full",style:{background:`radial-gradient(circle, ${u.glow} 0%, transparent 70%)`},animate:{scale:[1,1.2,1],opacity:[.4,.7,.4]},transition:{duration:2.5,repeat:1/0}}),e.jsx("div",{className:"relative w-full h-full rounded-2xl overflow-hidden border-2",style:{borderColor:u.primary+"60",boxShadow:`0 0 30px ${u.glow}`},children:o?e.jsxs("div",{className:"w-full h-full bg-gradient-to-br from-muted/30 to-muted/10 flex flex-col items-center justify-center gap-2",children:[e.jsx(ze,{className:"w-8 h-8 animate-spin",style:{color:u.primary}}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"Materializing..."})]}):i?e.jsx("img",{src:i,alt:r.name,className:"w-full h-full object-cover"}):e.jsx("div",{className:`w-full h-full bg-gradient-to-br ${u.bg} flex items-center justify-center`,children:e.jsx(va,{className:"w-12 h-12",style:{color:u.primary,filter:`drop-shadow(0 0 10px ${u.glow})`}})})}),e.jsx(_.div,{className:"absolute -top-1 -right-1 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase text-white shadow-lg",style:{backgroundColor:u.primary},initial:{scale:0},animate:{scale:1},transition:{delay:.6,type:"spring"},children:r.tier})]}),e.jsxs(_.div,{className:"mt-3 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5},children:[e.jsx("p",{className:"text-base font-bold",style:{color:u.primary},children:r.name}),e.jsxs("p",{className:"text-[10px] font-medium uppercase tracking-wider",style:{color:u.primary+"cc"},children:[r.theme," Adversary"]})]})]})]}),e.jsxs(_.div,{className:"px-5 pb-5 pt-3 bg-gradient-to-t from-background via-background/95 to-transparent",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.7},children:[e.jsx("div",{className:"flex justify-center gap-6 mb-3",children:[{label:"Phases",value:r.phases},{label:"Essence",value:r.statType},{label:"Boost",value:`+${r.statBoost}`}].map(h=>e.jsxs("div",{className:"text-center px-3 py-1.5 rounded-lg bg-muted/30 backdrop-blur-sm",children:[e.jsx("p",{className:"text-[10px] text-muted-foreground uppercase tracking-wider",children:h.label}),e.jsx("p",{className:"text-sm font-bold text-primary capitalize",children:h.value})]},h.label))}),e.jsxs("p",{className:"text-center text-xs text-muted-foreground italic mb-4 line-clamp-2 px-2",children:['"',r.lore,'"']}),e.jsxs("div",{className:"flex gap-3 w-full overflow-hidden",children:[l&&e.jsxs(B,{onClick:l,variant:"ghost",size:"lg",className:"h-12 px-4 text-muted-foreground hover:text-foreground",children:[e.jsx(ua,{className:"w-5 h-5 mr-1"}),"Pass"]}),e.jsxs(B,{onClick:c,size:"lg",className:"flex-1 min-w-0 h-12 text-sm sm:text-base font-bold bg-gradient-to-r from-primary via-accent to-primary bg-[length:200%_100%] hover:bg-[position:100%_0] transition-all duration-500 shadow-lg shadow-primary/30",children:[e.jsx(Be,{className:"w-5 h-5 mr-2 flex-shrink-0"}),"Begin Harmonization"]})]})]})]})]})},si={mind:{icon:Rt,color:"text-cyan-400",bg:"from-cyan-500/30 to-blue-500/30",glow:"shadow-cyan-500/50"},body:{icon:on,color:"text-amber-400",bg:"from-amber-500/30 to-orange-500/30",glow:"shadow-amber-500/50"},soul:{icon:Xt,color:"text-purple-400",bg:"from-purple-500/30 to-pink-500/30",glow:"shadow-purple-500/50"}},Hh={perfect:{title:"Perfect Victory!",icon:nn,color:"text-amber-400",textGradient:"from-amber-300 via-yellow-400 to-orange-400",confettiColors:["#fbbf24","#f59e0b","#d97706","#fcd34d"]},good:{title:"Victory!",icon:et,color:"text-primary",textGradient:"from-primary via-accent to-primary",confettiColors:["#8b5cf6","#a855f7","#c084fc","#6366f1"]},fail:{title:"Overcome by Shadow",icon:va,color:"text-slate-400",textGradient:"from-slate-400 via-purple-400 to-slate-500",confettiColors:[]}},ai=["steadies their resolve beside you","refuses to give up","gathers strength for the next attempt","stands ready to try again","believes in your strength"],zh=()=>{const t=n.useMemo(()=>Array.from({length:12},(s,a)=>({id:a,left:Math.random()*100,delay:Math.random()*3,duration:4+Math.random()*3,size:2+Math.random()*3})),[]);return e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:t.map(s=>e.jsx(_.div,{className:"absolute rounded-full",style:{left:`${s.left}%`,top:"-5%",width:s.size,height:s.size,background:"radial-gradient(circle, rgba(168, 85, 247, 0.8), rgba(100, 50, 150, 0.4))",boxShadow:"0 0 6px rgba(168, 85, 247, 0.5)"},animate:{y:["0vh","110vh"],opacity:[0,.8,.6,0],x:[0,Math.sin(s.id)*20,Math.cos(s.id)*15,0]},transition:{duration:s.duration,delay:s.delay,repeat:1/0,ease:"linear"}},s.id))})},Uh=({adversary:t,result:s,accuracy:a,xpEarned:r,onClose:i,retryAvailableAt:o,tiltBonus:c,companionImageUrl:l,companionName:u})=>{const m=Hh[s],p=m.icon,h=s!=="fail",f=si[t.statType]||si.soul,d=f.icon,g=n.useMemo(()=>ai[Math.floor(Math.random()*ai.length)],[]);n.useEffect(()=>{if(h){Ct.impact({style:it.Heavy}).catch(()=>{});const b=Date.now()+2e3,x=()=>{ut({particleCount:3,angle:60,spread:55,origin:{x:0,y:.6},colors:m.confettiColors}),ut({particleCount:3,angle:120,spread:55,origin:{x:1,y:.6},colors:m.confettiColors}),Date.now()<b&&requestAnimationFrame(x)};x(),setTimeout(()=>{ut({particleCount:100,spread:100,origin:{y:.5},colors:m.confettiColors})},300)}else Ct.impact({style:it.Light}).catch(()=>{})},[h,m.confettiColors]);const y=()=>{if(!o)return"";const v=new Date(o),b=new Date;return`Retry in ${Math.ceil((v.getTime()-b.getTime())/(1e3*60*60))}h`};return e.jsxs("div",{className:"flex flex-col items-center gap-4 p-6 text-center overflow-hidden relative",children:[e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx(_.div,{className:`absolute top-1/4 left-1/2 -translate-x-1/2 w-64 h-64 rounded-full blur-3xl ${h?"bg-primary/20":"bg-purple-900/30"}`,animate:{scale:[1,1.2,1],opacity:[.3,.5,.3]},transition:{duration:3,repeat:1/0}}),!h&&e.jsx(_.div,{className:"absolute inset-0 pointer-events-none",initial:{opacity:0},animate:{opacity:1},style:{background:"radial-gradient(ellipse at center, transparent 20%, rgba(15, 10, 30, 0.6) 80%)"}})]}),!h&&e.jsx(zh,{}),e.jsxs(_.div,{className:"relative",initial:{scale:0,rotate:h?-180:0},animate:{scale:1,rotate:0},transition:{type:"spring",duration:.8},children:[e.jsx("div",{className:`absolute inset-0 blur-xl ${h?m.color:"text-purple-500"} opacity-50`}),e.jsx(p,{className:`w-16 h-16 ${m.color} relative z-10 drop-shadow-lg`}),!h&&e.jsx(_.div,{className:"absolute inset-0 rounded-full border-2 border-purple-500/30",animate:{scale:[1,1.5,1],opacity:[.5,0,.5]},transition:{duration:2,repeat:1/0}})]}),e.jsx(_.h2,{className:`text-3xl font-black bg-gradient-to-r ${m.textGradient} bg-clip-text text-transparent`,initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:.2},children:m.title}),l&&e.jsxs(_.div,{className:"relative my-2",initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.3,type:"spring"},children:[e.jsx(_.div,{className:`absolute inset-0 rounded-full bg-gradient-to-r ${h?f.bg:"from-slate-600/30 to-purple-900/30"} blur-xl`,animate:{scale:[1,1.3,1],opacity:h?[.5,.8,.5]:[.3,.5,.3]},transition:{duration:2,repeat:1/0}}),e.jsxs("div",{className:`relative w-28 h-28 rounded-full overflow-hidden border-2 ${h?"border-primary/50 shadow-lg shadow-primary/30":"border-slate-500/40 shadow-lg shadow-purple-900/30"}`,children:[e.jsx("img",{src:l,alt:u||"Companion",className:`w-full h-full object-cover ${h?"":"saturate-75"}`}),!h&&e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-purple-900/30 to-transparent"})]}),h&&e.jsx(_.div,{className:"absolute -top-1 -right-1",animate:{rotate:360},transition:{duration:4,repeat:1/0,ease:"linear"},children:e.jsx(se,{className:`w-5 h-5 ${f.color}`})}),!h&&e.jsx(_.div,{className:"absolute -bottom-1 -right-1",initial:{scale:0},animate:{scale:1},transition:{delay:.5},children:e.jsx("div",{className:"w-8 h-8 rounded-full bg-slate-800/80 border border-purple-500/40 flex items-center justify-center",children:e.jsx(Bt,{className:"w-4 h-4 text-purple-400"})})})]}),e.jsx(_.p,{className:`text-sm italic ${h?"text-muted-foreground":"text-purple-300/80"}`,initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},children:h?`${u||"Your companion"} radiates with newfound power!`:`${u||"Your companion"} ${g}`}),e.jsx(_.div,{className:"w-full",initial:{y:30,opacity:0},animate:{y:0,opacity:1},transition:{delay:.5},children:e.jsxs("div",{className:`relative p-4 rounded-xl ${h?`bg-gradient-to-br ${f.bg}`:"bg-gradient-to-br from-slate-800/50 to-purple-900/30"} border ${h?"border-white/10":"border-slate-600/30"} backdrop-blur-sm overflow-hidden`,children:[e.jsx(_.div,{className:`absolute inset-0 rounded-xl border-2 ${h?f.color.replace("text","border"):"border-slate-500/30"} opacity-50`,animate:{opacity:h?[.3,.7,.3]:[.1,.3,.1]},transition:{duration:2,repeat:1/0}}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("div",{className:"flex items-center justify-center gap-2 mb-2",children:h?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:`w-4 h-4 ${f.color}`}),e.jsx("p",{className:`text-sm font-bold uppercase tracking-wider ${f.color}`,children:"Essence Absorbed"}),e.jsx(se,{className:`w-4 h-4 ${f.color}`})]}):e.jsxs(e.Fragment,{children:[e.jsx(qn,{className:"w-4 h-4 text-slate-400"}),e.jsx("p",{className:"text-sm font-bold uppercase tracking-wider text-slate-400",children:"Essence Slipped Away"}),e.jsx(qn,{className:"w-4 h-4 text-slate-400"})]})}),e.jsx("h3",{className:`text-xl font-bold ${h?"text-foreground":"text-slate-400"} mb-1`,children:t.essenceName}),e.jsxs("p",{className:`text-sm ${h?"text-muted-foreground":"text-slate-500"} mb-3 line-clamp-2`,children:['"',t.essenceDescription,'"']}),e.jsxs("div",{className:`inline-flex items-center gap-2 px-4 py-2 rounded-full ${h?"bg-background/50":"bg-slate-800/50"} border ${h?"border-white/10":"border-slate-600/30"}`,children:[e.jsx(d,{className:`w-5 h-5 ${h?f.color:"text-slate-500"}`}),e.jsx("span",{className:`text-sm font-medium ${h?"text-muted-foreground":"text-slate-500"} capitalize`,children:t.statType}),e.jsxs("span",{className:`text-lg font-bold ${h?f.color:"text-slate-500 line-through"}`,children:["+",t.statBoost]}),!h&&e.jsx("span",{className:"text-xs text-slate-500 ml-1",children:"(Not earned)"})]})]})]})}),h&&e.jsxs(_.div,{className:"flex flex-col items-center gap-1",initial:{scale:0},animate:{scale:1},transition:{delay:.7,type:"spring"},children:[e.jsxs("div",{className:"flex items-center gap-2 text-xl",children:[e.jsx(se,{className:"w-5 h-5 text-primary"}),e.jsxs("span",{className:"font-bold text-primary",children:["+",r," XP"]})]}),c&&e.jsxs(_.div,{className:"flex items-center gap-1 text-xs text-cyan-400",initial:{opacity:0},animate:{opacity:1},transition:{delay:1},children:[e.jsx("span",{children:"ðŸ“±"}),e.jsx("span",{children:"+25% Tilt Bonus!"})]})]}),e.jsxs(_.div,{className:"w-full mt-2",initial:{opacity:0},animate:{opacity:1},transition:{delay:.8},children:[e.jsxs("div",{className:"flex justify-between text-sm mb-1",children:[e.jsx("span",{className:"text-muted-foreground",children:"Accuracy"}),e.jsxs("span",{className:`font-bold ${h?"text-foreground":"text-slate-400"}`,children:[a,"%"]})]}),e.jsx("div",{className:"h-2 bg-muted/30 rounded-full overflow-hidden",children:e.jsx(_.div,{className:`h-full rounded-full ${h?"bg-gradient-to-r from-primary to-accent":"bg-gradient-to-r from-slate-600 to-purple-700/50"}`,initial:{width:0},animate:{width:`${a}%`},transition:{delay:.9,duration:.8,ease:"easeOut"}})})]}),!h&&o&&e.jsxs(_.div,{className:"flex items-center justify-center gap-2 text-sm text-purple-300/70",initial:{y:10,opacity:0},animate:{y:0,opacity:1},transition:{delay:1},children:[e.jsx(_.div,{animate:{rotate:360},transition:{duration:3,repeat:1/0,ease:"linear"},children:e.jsx(bs,{className:"w-4 h-4"})}),e.jsx("span",{children:y()})]}),e.jsx(_.div,{initial:{y:20,opacity:0},animate:{y:0,opacity:1},transition:{delay:1.1},className:"mt-2",children:e.jsx(B,{onClick:i,className:`px-8 ${h?"bg-gradient-to-r from-primary to-accent hover:opacity-90":"bg-gradient-to-r from-slate-700 to-purple-800 hover:from-slate-600 hover:to-purple-700 border border-purple-500/30"}`,variant:h?"default":"outline",size:"lg",children:h?"Continue":"Return to Safety"})})]})},Wh={energy_beam:{icon:Be,title:"Star Defender",goal:"Survive endless alien waves!",howToPlay:["Move left/right to dodge attacks","Auto-fire destroys enemies","3 lives - survive as long as possible","Waves get harder - how far can you go?"],statBonus:"body",statIcon:Xt},tap_sequence:{icon:nr,title:"Memory Sequence",goal:"How far can your memory take you?",howToPlay:["Watch orbs light up in sequence","Numbers hide - tap from memory!","Wrong tap = lose a life, sequence replays","3 lives total - survive endless levels!"],statBonus:"mind",statIcon:Rt},astral_frequency:{icon:Ga,title:"Cosmiq Dash",goal:"Survive the endless cosmic tunnel!",howToPlay:["Swipe or tap â—€ â–¶ to switch lanes","ðŸ”´ RED ASTEROIDS = DANGER! Lose a life","ðŸŸ¡ GOLD CRYSTALS = Points! Collect them","ðŸ”µ CYAN SHIELDS = Protection for 1 hit","Speed increases - survive as long as you can!"],statBonus:"soul",statIcon:se},eclipse_timing:{icon:ju,title:"Stellar Beats",goal:"Hit the notes in rhythm as they fall!",howToPlay:["Watch notes scroll down the 3 lanes","Tap the lane when notes reach the glowing line","Chain combos for multiplied points!"],statBonus:"soul",statIcon:se},starfall_dodge:{icon:wu,title:"Starfall Dodge",goal:"Survive the endless starfall!",howToPlay:["ðŸ“± Tilt or swipe to dodge debris","3 lives - debris hits cost one!","Collect ðŸ’Ž crystals for bonus points","Speed increases - how long can you last?"],statBonus:"body",statIcon:Xt},soul_serpent:{icon:Be,title:"Soul Serpent",goal:"Guide the serpent and survive as long as possible!",howToPlay:["Swipe or use D-Pad to change direction","Collect glowing stardust to grow longer","Game ends when you hit yourself!"],statBonus:"body",statIcon:Xt},orb_match:{icon:vu,title:"Starburst",goal:"Match orbs before time runs out!",howToPlay:["Touch and drag any orb across the grid","Orbs swap positions as you pass through","Match 3+ of the same color to score","Chain combos for bonus points!"],statBonus:"soul",statIcon:se},galactic_match:{icon:bu,title:"Galactic Match",goal:"Memorize cards, match pairs, survive endless levels!",howToPlay:["All cards revealed at start - MEMORIZE!","Cards hide - match pairs from memory","Wrong match = lose a life (3 total)","Clear level â†’ more cards next level!"],statBonus:"mind",statIcon:Rt},cosmiq_grid:{icon:yu,title:"Cosmiq Grid",goal:"Fill the grid with numbers 1-4!",howToPlay:["Each row must have 1, 2, 3, 4","Each column must have 1, 2, 3, 4","Each 2Ã—2 box must have 1, 2, 3, 4","Tap a cell, then tap a number to place"],statBonus:"mind",statIcon:Rt},stellar_flow:{icon:Ze,title:"Pathfinder",goal:"Connect matching orbs with flowing paths!",howToPlay:["Drag from one orb to its matching pair","Paths cannot cross each other","Fill every cell to complete the puzzle","Faster times = higher scores!"],statBonus:"soul",statIcon:se}},Qh={mind:"hsl(217, 91%, 60%)",body:"hsl(0, 84%, 60%)",soul:"hsl(271, 91%, 65%)"},Kh=({gameType:t,onReady:s})=>{const a=Wh[t],r=a.icon,i=a.statIcon,o=Qh[a.statBonus];return e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"p-6 flex flex-col items-center",children:[e.jsxs(_.div,{className:"relative mb-6",initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200,damping:15},children:[e.jsx(_.div,{className:"absolute inset-0 rounded-full blur-xl opacity-50",style:{backgroundColor:o},animate:{scale:[1,1.3,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx("div",{className:"relative p-5 rounded-full",style:{background:`linear-gradient(135deg, ${o}40, ${o}20)`,border:`2px solid ${o}60`},children:e.jsx(r,{className:"w-12 h-12",style:{color:o,filter:`drop-shadow(0 0 8px ${o})`}})})]}),e.jsx(_.h3,{className:"text-2xl font-bold text-foreground mb-2 text-center",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.1},children:a.title}),e.jsx(_.p,{className:"text-muted-foreground text-center mb-6",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.2},children:a.goal}),e.jsxs(_.div,{className:"w-full max-w-xs space-y-3 mb-6",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.3},children:[e.jsx("h4",{className:"text-sm font-semibold text-foreground uppercase tracking-wide text-center",children:"How to Play"}),e.jsx("div",{className:"space-y-2",children:a.howToPlay.map((c,l)=>e.jsxs(_.div,{className:"flex items-start gap-3 text-sm text-muted-foreground",initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:.4+l*.1},children:[e.jsx("span",{className:"flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center text-xs font-bold text-white",style:{backgroundColor:o},children:l+1}),e.jsx("span",{children:c})]},l))})]}),e.jsxs(_.div,{className:"flex items-center gap-2 mb-6 px-4 py-2 rounded-full",style:{backgroundColor:`${o}15`,border:`1px solid ${o}30`},initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},transition:{delay:.5},children:[e.jsx(i,{className:"w-4 h-4",style:{color:o}}),e.jsxs("span",{className:"text-sm font-medium capitalize",style:{color:o},children:[a.statBonus," Stat Bonus"]})]}),e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.6},children:e.jsx(B,{onClick:s,size:"lg",className:"px-8 font-bold",style:{background:`linear-gradient(135deg, ${o}, ${o}cc)`,boxShadow:`0 0 20px ${o}50`},children:e.jsx(_.span,{animate:{scale:[1,1.05,1]},transition:{duration:1.5,repeat:1/0},children:"Ready!"})})})]})},ri=n.lazy(()=>me(()=>import("./EnergyBeamGame-CLTOGMKR.js"),__vite__mapDeps([0,1,2,3,4])).then(t=>({default:t.EnergyBeamGame}))),Gh=n.lazy(()=>me(()=>import("./TapSequenceGame-Bxu43lFI.js"),__vite__mapDeps([5,1,2,3,4])).then(t=>({default:t.TapSequenceGame}))),Yh=n.lazy(()=>me(()=>import("./AstralFrequencyGame-Dc9Ov7No.js"),__vite__mapDeps([6,1,2,3,4])).then(t=>({default:t.AstralFrequencyGame}))),Vh=n.lazy(()=>me(()=>import("./EclipseTimingGame-CdXXG3Da.js"),__vite__mapDeps([7,1,2,3,4])).then(t=>({default:t.EclipseTimingGame}))),Xh=n.lazy(()=>me(()=>import("./StarfallDodgeGame-BvuTVzja.js"),__vite__mapDeps([8,1,2,3,4])).then(t=>({default:t.StarfallDodgeGame}))),Jh=n.lazy(()=>me(()=>import("./SoulSerpentGame-Bv_3BKdx.js"),__vite__mapDeps([9,1,2,3,4])).then(t=>({default:t.SoulSerpentGame}))),Zh=n.lazy(()=>me(()=>import("./OrbMatchGame-C3ujbT9L.js"),__vite__mapDeps([10,1,2,3,4])).then(t=>({default:t.OrbMatchGame}))),ef=n.lazy(()=>me(()=>import("./GalacticMatchGame-CBrJsOdG.js"),__vite__mapDeps([11,1,2,3,4])).then(t=>({default:t.GalacticMatchGame}))),tf=["starfall_dodge","astral_frequency"],sf=12,Kl=n.memo(()=>e.jsx(_.div,{className:"absolute top-0 left-0 right-0 z-50 flex justify-center",initial:{y:-50,opacity:0},animate:{y:0,opacity:1},transition:{type:"spring",stiffness:300,damping:25},children:e.jsx("div",{className:"bg-gradient-to-r from-amber-500 via-yellow-500 to-amber-500 px-6 py-2 rounded-b-xl shadow-lg",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(_.span,{animate:{scale:[1,1.2,1]},transition:{duration:1,repeat:1/0},className:"text-lg",children:"ðŸŽ¯"}),e.jsx("span",{className:"font-bold text-black text-sm uppercase tracking-wider",children:"Practice Round"}),e.jsx(_.span,{animate:{scale:[1,1.2,1]},transition:{duration:1,repeat:1/0,delay:.5},className:"text-lg",children:"ðŸŽ¯"})]})})}));Kl.displayName="PracticeBanner";const Gl=n.memo(({gameType:t,onStart:s,onSkip:a})=>{const r={energy_beam:"Star Defender",tap_sequence:"Tap Sequence",astral_frequency:"Cosmiq Dash",eclipse_timing:"Stellar Beats",starfall_dodge:"Starfall Dodge",soul_serpent:"Soul Serpent",orb_match:"Starburst",galactic_match:"Galactic Match"}[t];return e.jsxs(_.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},className:"flex flex-col items-center justify-center p-8 text-center min-h-[400px]",children:[e.jsx(_.div,{className:"mb-6 p-4 rounded-full bg-gradient-to-br from-amber-500/20 to-yellow-500/20 border border-amber-500/30",animate:{boxShadow:["0 0 20px rgba(245, 158, 11, 0.3)","0 0 40px rgba(245, 158, 11, 0.5)","0 0 20px rgba(245, 158, 11, 0.3)"]},transition:{duration:2,repeat:1/0},children:e.jsx("span",{className:"text-5xl",children:"ðŸŽ®"})}),e.jsx("h3",{className:"text-2xl font-bold text-foreground mb-2",children:"Practice Round"}),e.jsxs("p",{className:"text-muted-foreground mb-2",children:["Try ",e.jsx("span",{className:"text-amber-400 font-semibold",children:r})," before the real battle!"]}),e.jsx("p",{className:"text-sm text-muted-foreground/70 mb-8 max-w-xs",children:"This is a quick practice session to warm up. Your score won't count yet!"}),e.jsxs("div",{className:"flex gap-3",children:[e.jsxs(B,{onClick:s,size:"lg",className:"px-8 font-bold bg-gradient-to-r from-amber-500 to-yellow-500 text-black hover:from-amber-600 hover:to-yellow-600",children:[e.jsx(Vt,{className:"w-5 h-5 mr-2"}),"Start Practice"]}),e.jsxs(B,{onClick:a,variant:"ghost",size:"lg",className:"text-muted-foreground hover:text-foreground",children:[e.jsx(ua,{className:"w-4 h-4 mr-1"}),"Skip"]})]})]})});Gl.displayName="PracticeIntro";const Yl=n.memo(({onContinue:t})=>(n.useEffect(()=>{const s=setTimeout(t,2e3);return()=>clearTimeout(s)},[t]),e.jsxs(_.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"flex flex-col items-center justify-center p-8 text-center min-h-[400px]",children:[e.jsx(_.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:200,damping:15},className:"mb-6",children:e.jsx("span",{className:"text-6xl",children:"âœ¨"})}),e.jsx(_.h3,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.2},className:"text-2xl font-bold text-foreground mb-2",children:"Nice Warm-Up!"}),e.jsx(_.p,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"text-muted-foreground mb-6",children:"Now let's do it for real!"}),e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},className:"flex items-center gap-2 text-sm text-muted-foreground/70",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Starting real battle..."})]})]})));Yl.displayName="PracticeComplete";const Vl=n.memo(()=>e.jsx("div",{className:"pt-2 min-h-[400px] flex items-center justify-center",children:e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground/70",children:[e.jsx("div",{className:"w-4 h-4 border-2 border-primary border-t-transparent rounded-full animate-spin"}),e.jsx("span",{children:"Loading practice game..."})]})}));Vl.displayName="PracticeLoadingFallback";const ni=({gameType:t,companionStats:s,onPracticeComplete:a,onSkipPractice:r,isFullscreen:i=!1})=>{const[o,c]=n.useState("intro"),l=i||tf.includes(t),u=n.useCallback(()=>{c("playing")},[]),m=n.useCallback(h=>{c("complete")},[]),p=()=>{const h={companionStats:s,onComplete:m,difficulty:"easy",questIntervalScale:0,isPractice:!0,maxTimer:sf};switch(t){case"energy_beam":return e.jsx(ri,{...h});case"tap_sequence":return e.jsx(Gh,{...h});case"astral_frequency":return e.jsx(Yh,{...h});case"eclipse_timing":return e.jsx(Vh,{...h});case"starfall_dodge":return e.jsx(Xh,{...h});case"soul_serpent":return e.jsx(Jh,{...h});case"orb_match":return e.jsx(Zh,{...h});case"galactic_match":return e.jsx(ef,{...h});default:return e.jsx(ri,{...h})}};return e.jsx("div",{className:l?"relative h-full":"relative",children:e.jsxs(be,{mode:"wait",children:[o==="intro"&&e.jsx(Gl,{gameType:t,onStart:u,onSkip:r},"intro"),o==="playing"&&e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:l?"relative h-full":"relative",children:[e.jsx(Kl,{}),e.jsx(n.Suspense,{fallback:e.jsx(Vl,{}),children:l?p():e.jsx("div",{className:"pt-2 min-h-[400px] max-h-[calc(100vh-120px)] overflow-y-auto",children:p()})})]},"playing"),o==="complete"&&e.jsx(Yl,{onContinue:a},"complete")]})})},af=Hs("inline-flex items-center rounded-full border px-2.5 py-0.5 text-xs font-semibold transition-colors focus:outline-none focus:ring-2 focus:ring-ring focus:ring-offset-2",{variants:{variant:{default:"border-transparent bg-primary text-primary-foreground hover:bg-primary/80",secondary:"border-transparent bg-secondary text-secondary-foreground hover:bg-secondary/80",destructive:"border-transparent bg-destructive text-destructive-foreground hover:bg-destructive/80",outline:"text-foreground",celestial:"border-celestial-blue/30 bg-celestial-blue/20 text-celestial-blue",gold:"border-stardust-gold/30 bg-stardust-gold/20 text-stardust-gold",info:"border-celestial-blue/40 bg-celestial-blue/10 text-celestial-blue",reward:"border-stardust-gold/40 bg-stardust-gold/10 text-stardust-gold"}},defaultVariants:{variant:"default"}});function Ne({className:t,variant:s,...a}){return e.jsx("div",{className:E(af({variant:s}),t),...a})}const rf={doubt:"from-gray-600 to-slate-800",fear:"from-purple-900 to-indigo-950",chaos:"from-red-600 to-orange-800",stagnation:"from-stone-600 to-zinc-800",anxiety:"from-violet-900 to-purple-950",distraction:"from-cyan-700 to-blue-900",laziness:"from-amber-700 to-orange-900",overthinking:"from-indigo-800 to-slate-900",confusion:"from-pink-800 to-rose-950",vulnerability:"from-emerald-800 to-teal-950",imbalance:"from-rose-700 to-red-900"},nf={doubt:na,fear:va,chaos:Be,stagnation:Bt,anxiety:na,distraction:se,laziness:Bt,overthinking:na,confusion:Be,vulnerability:Bt,imbalance:Be},of=({context:t,onBeginBattle:s,onCancel:a})=>{const[r,i]=n.useState("lore"),[o,c]=n.useState(!1),l=nf[t.bossTheme]||va,u=rf[t.bossTheme]||"from-slate-900 to-black";return n.useEffect(()=>{const m=setTimeout(()=>i("intel"),3e3),p=setTimeout(()=>i("ready"),6e3);return()=>{clearTimeout(m),clearTimeout(p)}},[]),e.jsx(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-background/95 backdrop-blur-md",children:e.jsxs("div",{className:"max-w-lg w-full mx-4",children:[e.jsxs(be,{mode:"wait",children:[r==="lore"&&e.jsxs(_.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"text-center space-y-6",children:[e.jsx(_.div,{animate:{scale:[1,1.1,1]},transition:{duration:2,repeat:1/0},children:e.jsx("div",{className:E("w-24 h-24 mx-auto rounded-full flex items-center justify-center","bg-gradient-to-br shadow-2xl",u),children:e.jsx(l,{className:"w-12 h-12 text-white/80"})})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Ne,{variant:"destructive",className:"text-xs",children:"Final Confrontation"}),e.jsx("h2",{className:"text-3xl font-bold",children:t.bossName}),e.jsxs("p",{className:"text-sm text-muted-foreground italic",children:['"',t.bookTitle,'"']})]}),e.jsx("p",{className:"text-sm text-foreground/80 leading-relaxed",children:t.bossLore})]},"lore"),r==="intel"&&e.jsxs(_.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,y:-20},className:"space-y-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsxs(Ne,{variant:"outline",className:"mb-2",children:[e.jsx(ln,{className:"w-3 h-3 mr-1"}),"Intel Gathered"]}),e.jsx("h3",{className:"text-xl font-semibold",children:"Your Journey Has Revealed..."})]}),e.jsxs(Me,{className:"p-4 space-y-3 bg-primary/5 border-primary/20",children:[e.jsxs("h4",{className:"font-semibold text-sm flex items-center gap-2",children:[e.jsx(se,{className:"w-4 h-4 text-primary"}),"Weakness Hints"]}),e.jsx("ul",{className:"space-y-2",children:t.weaknessHints.map((m,p)=>e.jsxs(_.li,{initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:p*.3},className:"text-sm text-foreground/80 flex items-start gap-2",children:[e.jsx(et,{className:"w-4 h-4 text-yellow-500 flex-shrink-0 mt-0.5"}),e.jsx("span",{children:m})]},p))})]}),t.prophecyLines.length>0&&e.jsxs(Me,{className:"p-4 space-y-3 bg-accent/5 border-accent/20",children:[e.jsxs("h4",{className:"font-semibold text-sm flex items-center gap-2",children:[e.jsx(na,{className:"w-4 h-4 text-accent"}),"Prophecy Fragments"]}),e.jsx("div",{className:"space-y-2",children:t.prophecyLines.map((m,p)=>e.jsxs(_.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5+p*.2},className:"text-sm italic text-foreground/70",children:['"',m,'"']},p))})]})]},"intel"),r==="ready"&&e.jsxs(_.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:1.1},className:"text-center space-y-6",children:[e.jsx(_.div,{animate:{boxShadow:["0 0 20px hsl(var(--destructive) / 0.3)","0 0 40px hsl(var(--destructive) / 0.6)","0 0 20px hsl(var(--destructive) / 0.3)"]},transition:{duration:2,repeat:1/0},className:E("w-32 h-32 mx-auto rounded-full flex items-center justify-center","bg-gradient-to-br",u),children:e.jsx(_u,{className:"w-16 h-16 text-white"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Face Your Destiny"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["All your preparations have led to this moment.",e.jsx("br",{}),"Are you ready to complete your story?"]})]}),e.jsxs("div",{className:"flex gap-3 justify-center",children:[e.jsx(B,{variant:"outline",onClick:a,children:"Not Yet"}),e.jsxs(B,{onClick:s,className:"bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700",children:["Begin Battle",e.jsx(tt,{className:"w-4 h-4 ml-1"})]})]})]},"ready")]}),r!=="ready"&&e.jsx(_.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:1},className:"mt-8 text-center",children:e.jsx(B,{variant:"ghost",size:"sm",onClick:()=>i("ready"),className:"text-muted-foreground",children:"Skip to Battle â†’"})})]})})},lf=n.memo(function({currentHP:s,maxHP:a,isPlayer:r,label:i,showNumbers:o=!0}){const[c,l]=n.useState(s),[u,m]=n.useState(!1),p=Math.max(0,s/a*100),h=s<=0,f=p<25,d=p<10;n.useEffect(()=>{if(s!==c){m(!0);const v=setTimeout(()=>{l(s),m(!1)},300);return()=>clearTimeout(v)}},[s,c]);const g=()=>h?"bg-gray-500":r?d?"bg-red-600 animate-pulse":f?"bg-orange-500":"bg-green-500":d?"bg-purple-400":f?"bg-purple-500":"bg-purple-600",y=()=>h?"":r?d?"shadow-[0_0_10px_rgba(220,38,38,0.6)]":f?"shadow-[0_0_8px_rgba(249,115,22,0.5)]":"shadow-[0_0_6px_rgba(34,197,94,0.4)]":"shadow-[0_0_8px_rgba(147,51,234,0.5)]";return e.jsxs("div",{className:`flex items-center gap-2 ${r?"flex-row":"flex-row-reverse"}`,children:[e.jsx("div",{className:`flex-shrink-0 ${h?"opacity-50":""}`,children:h?e.jsx(va,{className:"w-4 h-4 text-gray-400"}):e.jsx(Xt,{className:`w-4 h-4 ${r?"text-green-500":"text-purple-500"} ${f&&!h?"animate-pulse":""}`,fill:r?"rgb(34,197,94)":"rgb(147,51,234)"})}),e.jsxs("div",{className:"flex-1 flex flex-col gap-0.5",children:[i&&e.jsx("span",{className:`text-[10px] font-medium ${r?"text-left":"text-right"} text-muted-foreground truncate`,children:i}),e.jsxs("div",{className:`relative h-4 rounded-full overflow-hidden bg-muted/50 border border-border/50 ${y()}`,children:[e.jsx(be,{children:f&&!h&&r&&e.jsx(_.div,{initial:{opacity:0},animate:{opacity:[.3,.6,.3]},exit:{opacity:0},transition:{duration:1,repeat:1/0},className:"absolute inset-0 bg-red-500/20"})}),e.jsx(_.div,{className:`absolute inset-y-0 ${r?"left-0":"right-0"} ${g()}`,initial:!1,animate:{width:`${p}%`},transition:{duration:.4,ease:[.4,0,.2,1]},children:e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-white/30 to-transparent"})}),e.jsx(be,{children:u&&s<c&&e.jsx(_.div,{initial:{opacity:.8},animate:{opacity:0},exit:{opacity:0},transition:{duration:.3},className:"absolute inset-0 bg-red-500/40"})})]})]}),o&&e.jsxs("div",{className:`flex-shrink-0 min-w-[50px] ${r?"text-right":"text-left"}`,children:[e.jsx(_.span,{initial:{scale:1.2,color:s<c?"#ef4444":"#22c55e"},animate:{scale:1,color:"inherit"},className:"text-xs font-mono font-bold text-foreground",children:Math.max(0,s)},s),e.jsxs("span",{className:"text-xs font-mono text-muted-foreground",children:["/",a]})]})]})});n.memo(function({event:s,position:a="adversary"}){const[r,i]=n.useState(0);if(n.useEffect(()=>{s&&i(u=>u+1)},[s]),!s)return null;const o=s.target==="player",l=typeof a=="object"?a:a==="player"||o?{x:60,y:20}:{x:240,y:20};return e.jsx(be,{mode:"popLayout",children:e.jsx(_.div,{initial:{opacity:1,y:0,scale:.5,x:l.x},animate:{opacity:0,y:-40,scale:1.2,x:l.x+(Math.random()-.5)*20},exit:{opacity:0},transition:{duration:.8,ease:"easeOut"},className:"absolute pointer-events-none z-50",style:{top:l.y},children:e.jsxs("span",{className:`
          text-lg font-bold font-mono
          ${o?"text-red-500":"text-yellow-400"}
          drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)]
        `,children:[o?"-":"+",s.amount]})},r)})});const ii=n.memo(function({damageEvents:s,className:a=""}){const[r,i]=n.useState([]);return n.useEffect(()=>{if(s.length===0)return;const o=s[s.length-1],c=`${Date.now()}-${Math.random()}`,u=o.target==="player"?50:250,p={id:c,event:o,x:u+(Math.random()-.5)*30,y:30+(Math.random()-.5)*20};i(f=>[...f,p]);const h=setTimeout(()=>{i(f=>f.filter(d=>d.id!==c))},1e3);return()=>clearTimeout(h)},[s.length]),e.jsx("div",{className:`absolute inset-0 pointer-events-none overflow-hidden ${a}`,children:e.jsx(be,{children:r.map(o=>e.jsx(_.div,{initial:{opacity:1,y:o.y,x:o.x,scale:.5},animate:{opacity:0,y:o.y-50,x:o.x+(Math.random()-.5)*20,scale:1.3},exit:{opacity:0},transition:{duration:.9,ease:"easeOut"},className:"absolute pointer-events-none",children:e.jsxs("span",{className:`
              text-xl font-black font-mono
              ${o.event.target==="player"?"text-red-500 drop-shadow-[0_0_8px_rgba(239,68,68,0.6)]":"text-yellow-400 drop-shadow-[0_0_8px_rgba(250,204,21,0.6)]"}
            `,children:[o.event.target==="player"?"-":"+",o.event.amount]})},o.id))})})});n.memo(function({imageUrl:s,name:a,hpPercent:r,isDefeated:i,size:o="md"}){const c=n.useMemo(()=>i?4:r<=25?3:r<=50?2:r<=75?1:0,[r,i]),l={sm:"w-12 h-12",md:"w-14 h-14",lg:"w-20 h-20"},u=n.useMemo(()=>{const m=[];return c>=1&&m.push("M50,0 L45,30 L55,50 L48,80 L52,100"),c>=2&&(m.push("M0,40 L25,45 L50,50 L75,48 L100,45"),m.push("M30,0 L35,25 L28,60")),c>=3&&(m.push("M70,0 L65,35 L72,70 L68,100"),m.push("M0,70 L30,65 L60,72 L100,68"),m.push("M20,100 L25,70 L18,40")),m},[c]);return e.jsxs("div",{className:`relative ${l[o]}`,children:[e.jsxs(_.div,{className:`
          relative w-full h-full rounded-lg overflow-hidden
          border-2 border-purple-500/50
          ${i?"grayscale":""}
        `,animate:i?{scale:[1,.95,1.05,0],rotate:[0,-5,5,0],opacity:[1,1,1,0]}:{},transition:{duration:.6},children:[s?e.jsx("img",{src:s,alt:a,className:"w-full h-full object-cover"}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-purple-900 to-purple-600 flex items-center justify-center",children:e.jsx("span",{className:"text-2xl",children:"ðŸ‘¹"})}),e.jsx(_.div,{className:"absolute inset-0 bg-red-900",initial:{opacity:0},animate:{opacity:i?.8:Math.max(0,(100-r)/200)},transition:{duration:.3}}),e.jsx(be,{children:r<=25&&!i&&e.jsx(_.div,{initial:{opacity:0},animate:{opacity:[.2,.4,.2]},exit:{opacity:0},transition:{duration:1.5,repeat:1/0},className:"absolute inset-0 bg-red-500/30"})})]}),e.jsx(be,{children:c>0&&e.jsxs(_.svg,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 w-full h-full pointer-events-none",viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[u.map((m,p)=>e.jsx(_.path,{d:m,fill:"none",stroke:"rgba(0,0,0,0.8)",strokeWidth:"2",strokeLinecap:"round",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:.3,delay:p*.1,ease:"easeOut"}},p)),u.map((m,p)=>e.jsx(_.path,{d:m,fill:"none",stroke:"rgba(255,255,255,0.3)",strokeWidth:"1",strokeLinecap:"round",transform:"translate(1, 1)",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.5},transition:{duration:.3,delay:p*.1+.1,ease:"easeOut"}},`highlight-${p}`))]})}),e.jsx(be,{children:i&&e.jsx(e.Fragment,{children:Array.from({length:8}).map((m,p)=>e.jsx(_.div,{className:"absolute w-3 h-3 bg-purple-500/60 rounded-sm",initial:{x:"50%",y:"50%",scale:1,opacity:1},animate:{x:`${50+(Math.random()-.5)*200}%`,y:`${50+(Math.random()-.5)*200}%`,scale:0,opacity:0,rotate:Math.random()*360},transition:{duration:.8,delay:.2+p*.05,ease:"easeOut"}},p))})})]})});const cf=n.memo(function({imageUrl:s,name:a,hpPercent:r,isDefeated:i}){const o=n.useMemo(()=>i?4:r<=25?3:r<=50?2:r<=75?1:0,[r,i]),c=n.useMemo(()=>{const l=[];return o>=1&&(l.push("M50,0 L48,25 L52,50 L47,75 L50,100"),l.push("M25,0 L28,30 L22,60")),o>=2&&(l.push("M0,50 L20,48 L40,52 L60,49 L80,51 L100,50"),l.push("M75,0 L72,35 L78,70")),o>=3&&(l.push("M10,0 L15,40 L8,80 L12,100"),l.push("M90,0 L85,45 L92,90"),l.push("M0,25 L30,28 L60,24 L100,27"),l.push("M0,75 L25,72 L50,78 L75,74 L100,76")),l},[o]);return e.jsxs("div",{className:"relative w-full aspect-[2.5/1] max-h-[140px] overflow-hidden rounded-xl",children:[e.jsxs(_.div,{className:`
          relative w-full h-full
          ${i?"grayscale":""}
        `,animate:i?{scale:[1,.98,1.02,.95],opacity:[1,1,.8,0]}:{},transition:{duration:.8},children:[s?e.jsx("img",{src:s,alt:a,className:"w-full h-full object-cover object-center"}):e.jsx("div",{className:"w-full h-full bg-gradient-to-br from-purple-900 via-purple-800 to-purple-600 flex items-center justify-center",children:e.jsx("span",{className:"text-5xl",children:"ðŸ‘¹"})}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background via-transparent to-background/40"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-background/30 via-transparent to-background/30"}),e.jsx(_.div,{className:"absolute inset-0 bg-red-900",initial:{opacity:0},animate:{opacity:i?.7:Math.max(0,(100-r)/150)},transition:{duration:.3}}),e.jsx(be,{children:r<=25&&!i&&e.jsx(_.div,{initial:{opacity:0},animate:{opacity:[.1,.3,.1]},exit:{opacity:0},transition:{duration:1.2,repeat:1/0},className:"absolute inset-0 bg-red-500/40"})}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",style:{background:"radial-gradient(ellipse at center, transparent 20%, rgba(0,0,0,0.5) 100%)"}})]}),e.jsx(be,{children:o>0&&e.jsxs(_.svg,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 w-full h-full pointer-events-none",viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[c.map((l,u)=>e.jsx(_.path,{d:l,fill:"none",stroke:"rgba(0,0,0,0.9)",strokeWidth:"1.5",strokeLinecap:"round",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:.4,delay:u*.08,ease:"easeOut"}},u)),c.map((l,u)=>e.jsx(_.path,{d:l,fill:"none",stroke:"rgba(255,255,255,0.25)",strokeWidth:"0.8",strokeLinecap:"round",transform:"translate(0.5, 0.5)",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:.6},transition:{duration:.4,delay:u*.08+.1,ease:"easeOut"}},`highlight-${u}`))]})}),e.jsx(be,{children:i&&e.jsx(e.Fragment,{children:Array.from({length:12}).map((l,u)=>e.jsx(_.div,{className:"absolute w-3 h-3 bg-purple-500/50 rounded-sm",style:{left:`${u%4*25+12}%`,top:`${Math.floor(u/4)*33+16}%`},initial:{scale:1,opacity:1},animate:{x:(Math.random()-.5)*150,y:(Math.random()-.5)*100+50,scale:0,opacity:0,rotate:Math.random()*360},transition:{duration:.7,delay:.1+u*.03,ease:"easeOut"}},u))})}),e.jsx("div",{className:"absolute inset-0 rounded-xl border border-purple-500/30 pointer-events-none"}),e.jsx(_.div,{className:"absolute inset-0 rounded-xl pointer-events-none",animate:r<=25&&!i?{boxShadow:["inset 0 0 15px rgba(239,68,68,0.2)","inset 0 0 25px rgba(239,68,68,0.4)","inset 0 0 15px rgba(239,68,68,0.2)"]}:{boxShadow:"inset 0 0 15px rgba(147,51,234,0.2)"},transition:{duration:1.5,repeat:1/0}})]})}),oi=n.memo(function({battleState:s,adversaryImageUrl:a,adversaryName:r,showScreenShake:i=!1,battleTimeLeft:o,battleTimeTotal:c}){const l=s.playerHPPercent<25;return e.jsxs(_.div,{className:"relative w-full",animate:i?{x:[0,-3,3,-2,2,0],y:[0,2,-2,1,-1,0]}:{},transition:{duration:.3},children:[e.jsx(be,{children:l&&!s.isPlayerDefeated&&e.jsx(_.div,{initial:{opacity:0},animate:{opacity:[.3,.5,.3]},exit:{opacity:0},transition:{duration:2,repeat:1/0},className:"fixed inset-0 pointer-events-none z-40",style:{background:"radial-gradient(ellipse at center, transparent 40%, rgba(220,38,38,0.4) 100%)"}})}),e.jsx("div",{className:"w-full bg-gradient-to-b from-background via-background/95 to-transparent",style:{paddingTop:"max(env(safe-area-inset-top, 0px), 8px)",paddingLeft:"env(safe-area-inset-left, 0px)",paddingRight:"env(safe-area-inset-right, 0px)"},children:e.jsxs("div",{className:"px-2 pt-0.5 pb-1",children:[e.jsx(cf,{imageUrl:a,name:r,hpPercent:s.adversaryHPPercent,isDefeated:s.isAdversaryDefeated}),e.jsxs(_.div,{className:"flex items-center justify-center gap-1.5 mt-1 mb-0.5",initial:{opacity:0,y:-10},animate:{opacity:1,y:0},transition:{delay:.2},children:[e.jsx("span",{className:"text-purple-400 text-xs",children:"âš”ï¸"}),e.jsx("h2",{className:"text-sm font-bold text-purple-300 tracking-wide uppercase truncate max-w-[200px]",children:r}),e.jsx("span",{className:"text-purple-400 text-xs",children:"âš”ï¸"})]}),e.jsx("div",{className:"w-full px-1",children:e.jsx(lf,{currentHP:s.adversaryHP,maxHP:s.adversaryMaxHP,isPlayer:!1,showNumbers:!0})}),o!==void 0&&c!==void 0&&e.jsx("div",{className:"w-full px-1 mt-1",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"flex-1 h-1.5 bg-muted/30 rounded-full overflow-hidden",children:e.jsx(_.div,{className:"h-full rounded-full",style:{width:`${o/c*100}%`,background:o<=10?"linear-gradient(90deg, #ef4444, #f87171)":"linear-gradient(90deg, hsl(var(--primary)), hsl(var(--accent)))"},animate:o<=10?{opacity:[1,.6,1]}:{},transition:{duration:.5,repeat:1/0}})}),e.jsxs("span",{className:`text-xs font-mono font-bold min-w-[32px] text-right ${o<=10?"text-red-400":"text-muted-foreground"}`,children:[o,"s"]})]})})]})})]})}),pr=()=>{const{user:t}=ce(),s=n.useRef(new Set),a=n.useCallback(async v=>{if(t&&!s.current.has(v.type)){s.current.add(v.type);try{const{data:b,error:x}=await N.from("achievements").upsert({user_id:t.id,achievement_type:v.type,title:v.title,description:v.description,icon:v.icon,tier:v.tier,metadata:v.metadata||{}},{onConflict:"user_id,achievement_type",ignoreDuplicates:!0}).select("id").maybeSingle();b&&!x&&(X.success("ðŸ† Achievement Unlocked!",{description:v.title}),Rp())}catch(b){console.error("Error awarding achievement:",b)}}},[t]),r=async v=>{v===3?await a({type:"three_day_streak",title:"Getting Started",description:"3 days of consistency",icon:"flame",tier:"silver",metadata:{streak:v,pepTalkDuration:"2-3 min",pepTalkMessage:"You're showing effort today. Keep that energy.",pepTalkCategory:"encouragement"}}):v===7?await a({type:"week_streak",title:"Week of Discipline",description:"7 days of unwavering commitment",icon:"trophy",tier:"gold",metadata:{streak:v,pepTalkDuration:"4-5 min",pepTalkMessage:"You're not who you were last week. You're growing.",pepTalkCategory:"discipline"}}):v===14?await a({type:"two_week_streak",title:"Fortnight Fighter",description:"14 days of unwavering discipline",icon:"trophy",tier:"gold",metadata:{streak:v,pepTalkDuration:"4-5 min",pepTalkMessage:"Two weeks of showing up. That's the discipline talking.",pepTalkCategory:"discipline"}}):v===30&&await a({type:"month_streak",title:"Transformed",description:"30 days - You're not the same person anymore",icon:"crown",tier:"platinum",metadata:{streak:v,pepTalkDuration:"7-10 min",pepTalkMessage:"A month ago, you started. Today, you're different. This is transformation.",pepTalkCategory:"breakthrough"}})},i=async v=>{v===1?await a({type:"first_challenge",title:"Challenge Accepted",description:"Completed your first challenge",icon:"target",tier:"bronze"}):v===5?await a({type:"challenge_veteran",title:"Challenge Veteran",description:"Completed 5 challenges",icon:"target",tier:"silver"}):v===10&&await a({type:"challenge_master",title:"Challenge Master",description:"Completed 10 challenges",icon:"target",tier:"gold"})},o=async v=>{await a({habit:{type:"first_habit",title:"First Step",description:"Created your first habit",icon:"check",tier:"bronze",metadata:{pepTalkDuration:"1 min",pepTalkMessage:"Welcome. Every journey starts with one step.",pepTalkCategory:"welcome"}},checkin:{type:"first_checkin",title:"Good Morning",description:"Completed your first check-in",icon:"sunrise",tier:"bronze",metadata:{pepTalkDuration:"1 min",pepTalkMessage:"You showed up today. That matters.",pepTalkCategory:"welcome"}},peptalk:{type:"first_peptalk",title:"Listening",description:"Listened to your first pep talk",icon:"headphones",tier:"bronze",metadata:{pepTalkDuration:"1 min",pepTalkMessage:"You're here. You're listening. Keep going.",pepTalkCategory:"welcome"}},mission:{type:"first_mission",title:"Mission Accepted",description:"Completed your first mission",icon:"target",tier:"bronze",metadata:{pepTalkDuration:"1 min",pepTalkMessage:"One mission down. This is how change happens.",pepTalkCategory:"welcome"}}}[v])},c=async v=>{v===3?await a({type:"companion_stage_3",title:"Growing Together",description:"Your companion reached Stage 3",icon:"sparkles",tier:"silver",metadata:{stage:v,pepTalkDuration:"2-3 min",pepTalkMessage:"Watch how your companion changes as you do.",pepTalkCategory:"growth"}}):v===5?await a({type:"companion_stage_5",title:"Deep Bond",description:"Your companion reached Stage 5",icon:"sparkles",tier:"gold",metadata:{stage:v,pepTalkDuration:"4-5 min",pepTalkMessage:"Stage 5. You're both different now.",pepTalkCategory:"discipline"}}):v===10?await a({type:"companion_stage_10",title:"Evolution Master",description:"Your companion reached Stage 10",icon:"star",tier:"gold",metadata:{stage:v,pepTalkDuration:"4-5 min",pepTalkMessage:"Stage 10. This is discipline and consistency made visible.",pepTalkCategory:"discipline"}}):v===15?await a({type:"companion_stage_15",title:"Transcendent Bond",description:"Your companion reached Stage 15",icon:"crown",tier:"platinum",metadata:{stage:v,pepTalkDuration:"7-10 min",pepTalkMessage:"You've come so far together. This bond is real.",pepTalkCategory:"breakthrough"}}):v===20&&await a({type:"companion_max",title:"Legendary Bond",description:"Your companion reached maximum evolution",icon:"crown",tier:"platinum",metadata:{stage:v,pepTalkDuration:"7-10 min",pepTalkMessage:"Stage 20. You didn't just evolve your companion. You evolved yourself.",pepTalkCategory:"breakthrough"}})},l=async(v,b)=>{const x=v.charAt(0).toUpperCase()+v.slice(1);b===5?await a({type:`${v}_5`,title:`${x} Awakening`,description:`${x} attribute reached 5`,icon:"zap",tier:"silver",metadata:{attribute:v,value:b,pepTalkDuration:"2-3 min",pepTalkMessage:`Your ${v} is growing. You're feeling it, aren't you?`,pepTalkCategory:"growth"}}):b===10?await a({type:`${v}_10`,title:`${x} Mastery`,description:`${x} attribute reached 10`,icon:"zap",tier:"gold",metadata:{attribute:v,value:b,pepTalkDuration:"4-5 min",pepTalkMessage:`${x} at 10. This is what discipline looks like.`,pepTalkCategory:"discipline"}}):b===15&&await a({type:`${v}_15`,title:`${x} Transcendence`,description:`${x} attribute reached 15`,icon:"crown",tier:"platinum",metadata:{attribute:v,value:b,pepTalkDuration:"7-10 min",pepTalkMessage:`${x} at 15. You're operating at a different level now.`,pepTalkCategory:"breakthrough"}})},u=async v=>{v>=50&&await a({type:"total_attributes_50",title:"Balanced Transformation",description:"Total attributes reached 50",icon:"crown",tier:"platinum",metadata:{total:v,pepTalkDuration:"7-10 min",pepTalkMessage:"Mind, Body, Soul - all growing together. This is true transformation.",pepTalkCategory:"breakthrough"}})},m=async v=>{v===3?await a({type:"peptalk_listener_3",title:"Active Listener",description:"Listened to 3 pep talks this week",icon:"headphones",tier:"silver",metadata:{count:v,pepTalkDuration:"2-3 min",pepTalkMessage:"You're not just listening. You're absorbing.",pepTalkCategory:"encouragement"}}):v===10&&await a({type:"peptalk_listener_10",title:"Devoted Student",description:"Listened to 10 pep talks",icon:"headphones",tier:"gold",metadata:{count:v,pepTalkDuration:"4-5 min",pepTalkMessage:"Ten talks. You're committed to this growth.",pepTalkCategory:"discipline"}})},p=async()=>{await a({type:"all_tasks_complete",title:"Perfect Day",description:"Completed every task today",icon:"check-circle",tier:"silver",metadata:{pepTalkDuration:"2-3 min",pepTalkMessage:"You did it all today. Every. Single. Thing.",pepTalkCategory:"encouragement"}})},h=async v=>{await a({type:`story_chapter_${v}`,title:`Chapter ${v} Complete`,description:`Finished story chapter ${v}`,icon:"book",tier:"gold",metadata:{chapter:v,pepTalkDuration:"4-5 min",pepTalkMessage:"Another chapter. Your story is unfolding.",pepTalkCategory:"discipline"}})},f=async()=>{await a({type:"full_storyline",title:"Story Complete",description:"Completed the entire companion storyline",icon:"crown",tier:"platinum",metadata:{pepTalkDuration:"7-10 min",pepTalkMessage:"The full story. From beginning to now. Look at how far you've come.",pepTalkCategory:"breakthrough"}})},d=async()=>{await a({type:"comeback_arc",title:"The Comeback",description:"Returned stronger after a break",icon:"crown",tier:"platinum",metadata:{pepTalkDuration:"7-10 min",pepTalkMessage:"You came back. That's what matters. Welcome home.",pepTalkCategory:"breakthrough"}})},g=n.useCallback(async()=>{await a({type:"arcade_explorer",title:"Arcade Explorer",description:"Discovered the hidden Astral Arcade",icon:"gamepad-2",tier:"silver",metadata:{pepTalkMessage:"You found the secret arcade. Nice work, explorer.",pepTalkCategory:"discovery"}})},[a]),y=n.useCallback(async(v,b)=>{const x={distraction:{prefix:"Focus",icon:"target"},stagnation:{prefix:"Momentum",icon:"waves"},anxiety:{prefix:"Serenity",icon:"heart"},doubt:{prefix:"Confidence",icon:"shield"},chaos:{prefix:"Order",icon:"zap"},laziness:{prefix:"Drive",icon:"flame"},overthinking:{prefix:"Clarity",icon:"brain"},fear:{prefix:"Courage",icon:"shield"},confusion:{prefix:"Wisdom",icon:"sparkles"},vulnerability:{prefix:"Resilience",icon:"gem"},imbalance:{prefix:"Harmony",icon:"scale"}},{prefix:j,icon:w}=x[v];let D=!1,S=null;return b===3?await a({type:`astral_${v}_3`,title:`${j} Initiate`,description:`Defeated 3 ${v} adversaries`,icon:w,tier:"bronze",metadata:{theme:v,count:3}}):b===10?(await a({type:`astral_${v}_10`,title:`${j} Warrior`,description:`Defeated 10 ${v} adversaries`,icon:w,tier:"silver",metadata:{theme:v,count:10}}),D=!0,S="rare"):b===25?(await a({type:`astral_${v}_25`,title:`${j} Champion`,description:`Defeated 25 ${v} adversaries`,icon:w,tier:"gold",metadata:{theme:v,count:25}}),D=!0,S="epic"):b===50&&(await a({type:`astral_${v}_50`,title:`${j} Transcendent`,description:`Defeated 50 ${v} adversaries`,icon:w,tier:"platinum",metadata:{theme:v,count:50}}),D=!0,S="legendary"),{shouldRollLoot:D,lootTier:S}},[a]);return{awardAchievement:a,checkStreakAchievements:r,checkChallengeAchievements:i,checkFirstTimeAchievements:o,checkCompanionAchievements:c,checkAttributeAchievements:l,checkTotalAttributesAchievement:u,checkPepTalkListeningAchievements:m,checkDailyCompletionAchievement:p,checkStoryChapterAchievement:h,checkFullStorylineAchievement:f,checkComebackAchievement:d,checkArcadeDiscovery:g,checkAdversaryDefeatAchievements:y}},df={maxAttempts:3,initialDelay:1e3,maxDelay:1e4,backoffFactor:2,shouldRetry:t=>{const s=t;return!!(s.message?.includes("fetch")||s.message?.includes("network")||typeof s.status=="number"&&s.status>=500&&s.status<600)}};async function uf(t,s={}){const a={...df,...s};let r;for(let i=1;i<=a.maxAttempts;i++)try{return await t()}catch(o){if(r=o,!a.shouldRetry(o)||i===a.maxAttempts)throw o;const c=Math.min(a.initialDelay*Math.pow(a.backoffFactor,i-1),a.maxDelay);await new Promise(l=>setTimeout(l,c))}throw r}const mf=()=>{const{data:t,isLoading:s,error:a}=ye({queryKey:["evolution-thresholds"],queryFn:async()=>{const{data:l,error:u}=await N.from("evolution_thresholds").select("*").order("stage",{ascending:!0});if(u)throw u;return l},staleTime:1/0,gcTime:1/0}),r=t?.reduce((l,u)=>(l[u.stage]=u.xp_required,l),{}),i=l=>r?.[l]??null;return{thresholds:t,thresholdMap:r,isLoading:s,error:a,getThreshold:i,shouldEvolve:(l,u)=>{const m=i(l+1);return m!==null&&u>=m},getStageName:l=>t?.find(u=>u.stage===l)?.stage_name??`Stage ${l}`}},Rr={EASY:15,MEDIUM:16,HARD:18},Ir={EASY:7,MEDIUM:14,HARD:24},pf={HABIT_COMPLETE:7,ALL_HABITS_COMPLETE:15,CHALLENGE_COMPLETE:25,WEEKLY_CHALLENGE:60,PEP_TALK_LISTEN:8,CHECK_IN:3,EVENING_REFLECTION:3,WEEKLY_RECAP_VIEWED:5,STREAK_MILESTONE:15,WELCOME_BACK_BONUS:25},hf={XP_PER_DAY:10},Tv={MORNING_WARRIOR:10,DEEP_WORK:20},Ft={SESSION_COMPLETE:20,PERFECT_FOCUS_BONUS:5,DAILY_SESSION_CAP:4,CAPPED_SESSION_XP:3},qr={SUBTASK_COMPLETE:3,ALL_SUBTASKS_BONUS:10},Aa={TOP_THREE_COMPLETE:15,ALL_TOP_THREE_BONUS:30,URGENT_IMPORTANT:10,NOT_URGENT_IMPORTANT:12},Ra={PROCESS_INBOX:2,INBOX_ZERO:10,VOICE_CAPTURE:3},ta={WEEKLY_REVIEW:25,DAILY_REVIEW:8,HIGH_PRODUCTIVITY_DAY:20,PERFECT_DAY:35},Lr={ON_TIME_COMPLETION:5,CONTEXT_MATCH:3},xs={REGULAR:20,POSTCARD:35,PHASE_COMPLETE:50,EPIC_COMPLETE:150};function ff(t){return{easy:Rr.EASY,medium:Rr.MEDIUM,hard:Rr.HARD}[t]}function gf(t){return t<=3?1:t===4?.75:t===5?.5:t===6?.35:t===7?.25:t===8?.15:t<=10?.1:.05}function li(t,s){const a=ff(t),r=gf(s);return Math.round(a*r)}async function Xl(t,s={}){const{onRetry:a,onValidating:r}=s;r?.();const{data:i,error:o}=await N.functions.invoke("generate-companion-image",{body:t});if(o){const m=o.message||String(o);throw console.error("[Validation] Image generation error:",m),m.includes("INSUFFICIENT_CREDITS")||m.includes("Insufficient AI credits")?new Error("The companion creation service is temporarily unavailable. Please contact support."):m.includes("RATE_LIMITED")||m.includes("busy")?new Error("The service is currently busy. Please wait a moment and try again."):m.includes("NO_AUTH_HEADER")||m.includes("INVALID_AUTH")?new Error("Your session has expired. Please refresh the page and try again."):new Error(m||"Failed to generate companion image. Please try again.")}if(!i?.imageUrl)throw console.error("[Validation] No image URL in result:",i),new Error("Unable to create your companion's image. Please try again.");const c=i.qualityScore,l=c?.retryCount||0;l>0&&a&&a(l);const u=c?c.overallScore>=70||!c.shouldRetry:!0;return console.log(`[Validation] Complete - Score: ${c?.overallScore||"N/A"}, Retries: ${l}, Passed: ${u}`),{imageUrl:i.imageUrl,validationPassed:u,retryCount:l}}const Lt=pf,st=()=>{const{user:t}=ce(),s=Se(),{checkCompanionAchievements:a}=pr(),{isEvolvingLoading:r,setIsEvolvingLoading:i}=lr(),{getThreshold:o,shouldEvolve:c}=mf(),l=n.useRef(!1),u=n.useRef(null),m=n.useRef(!1),p=n.useRef(!1),{data:h,isLoading:f,error:d,refetch:g}=ye({queryKey:["companion",t?.id],queryFn:async()=>{if(!t)return null;const{data:C,error:R}=await N.from("user_companion").select("*").eq("user_id",t.id).maybeSingle();if(R)throw R;return C},enabled:!!t,staleTime:6e4,gcTime:1800*1e3,placeholderData:C=>C,retry:3,retryDelay:C=>Math.min(1e3*2**C,5e3)}),y=ie({mutationFn:async C=>{if(!t)throw new Error("Not authenticated");if(p.current)throw new Error("Companion creation already in progress");p.current=!0;try{ee.log("Starting companion creation process...");const R=`glowing ${C.favoriteColor}`,T=C.favoriteColor;ee.log("Generating companion image with validation...");const{imageUrl:q,validationPassed:k,retryCount:P}=await Xl({favoriteColor:C.favoriteColor,spiritAnimal:C.spiritAnimal,element:C.coreElement,stage:0,eyeColor:R,furColor:T,storyTone:C.storyTone},{maxRetries:2,onRetry:z=>{ee.log(`Validation failed, retrying image generation (attempt ${z})...`)},onValidating:()=>{ee.log("Validating generated image for anatomical issues...")}});P>0?ee.log(`Image generated after ${P} validation retry(ies), passed: ${k}`):ee.log(`Image generated on first attempt, validation passed: ${k}`);const A={imageUrl:q};ee.log("Image generated successfully, creating companion record...");const L=await N.rpc("create_companion_if_not_exists",{p_user_id:t.id,p_favorite_color:C.favoriteColor,p_spirit_animal:C.spiritAnimal,p_core_element:C.coreElement,p_story_tone:C.storyTone,p_current_image_url:A.imageUrl,p_initial_image_url:A.imageUrl,p_eye_color:R,p_fur_color:T});if(L.error)throw console.error("Database error creating companion:",L.error),new Error(`Failed to save companion to database: ${L.error.message}`);const H=L.data;if(ee.log("RPC call successful, result:",H),!H||H.length===0)throw ee.error("No companion data returned from function"),new Error("Failed to create companion record. Please try again.");const I=H[0],te=I.is_new;ee.log(`Companion ${te?"created":"already exists"}:`,I.id);const{data:V}=await N.from("companion_evolutions").select("id").eq("companion_id",I.id).eq("stage",0).maybeSingle();if(!V){ee.log("Creating stage 0 evolution...");const{data:z,error:W}=await N.from("companion_evolutions").insert({companion_id:I.id,stage:0,image_url:A.imageUrl,xp_at_evolution:0}).select().maybeSingle();if(W)throw console.error("Failed to create stage 0 evolution:",W),new Error(`Unable to record stage 0 evolution: ${W.message}`);if(!z)throw console.error("Stage 0 evolution insert returned no data"),new Error("Unable to record stage 0 evolution");(async()=>{try{const{data:U}=await N.from("user_companion").select("*").eq("id",I.id).single();await N.functions.invoke("generate-evolution-card",{body:{companionId:I.id,evolutionId:z.id,stage:0,species:I.spirit_animal,element:I.core_element,color:I.favorite_color,userAttributes:{vitality:U?.vitality||300,wisdom:U?.wisdom||300,discipline:U?.discipline||300,resolve:U?.resolve||300,creativity:U?.creativity||300,alignment:U?.alignment||300}}}),s.invalidateQueries({queryKey:["evolution-cards"]})}catch(U){console.error("Stage 0 card generation failed (non-critical):",U)}})()}return te&&(async(W=3)=>{for(let Q=1;Q<=W;Q++)try{const{data:U,error:$}=await N.functions.invoke("generate-companion-story",{body:{companionId:I.id,stage:0}});if($)throw $;ee.log("Stage 0 story generation started"),s.invalidateQueries({queryKey:["companion-story"]}),s.invalidateQueries({queryKey:["companion-stories-all"]});return}catch(U){const $=U instanceof Error?U.message:String(U),J=$.includes("network")||$.includes("timeout")||$.includes("temporarily unavailable");if(Q<W&&J){ee.log(`Story generation attempt ${Q} failed, retrying...`),await new Promise(O=>setTimeout(O,2e3*Q));continue}console.error(`Failed to auto-generate stage 0 story after ${Q} attempts:`,U);break}})().catch(W=>{console.warn("Story generation failed (non-critical):",W?.message||W)}),I}catch(R){throw p.current=!1,R}},onSuccess:()=>{p.current=!1,s.invalidateQueries({queryKey:["companion"]}),ee.log("Companion creation successful!")},onError:C=>{p.current=!1,console.error("Failed to create companion:",C)}}),v=ie({mutationFn:async({eventType:C,xpAmount:R,metadata:T={}})=>{if(!t)throw new Error("No user found");if(m.current)throw new Error("XP award already in progress");m.current=!0;try{let q=h;if(!q&&(ee.warn("Companion not loaded yet, fetching..."),await s.refetchQueries({queryKey:["companion",t.id]}),q=s.getQueryData(["companion",t.id]),!q))throw new Error("No companion found. Please create one first.");return await b(q,R,C,T,t)}finally{m.current=!1}},onSuccess:async({shouldEvolve:C,newStage:R,newXP:T})=>{s.invalidateQueries({queryKey:["companion"]}),C&&h&&(await a(R),X.success("âœ¨ Your companion is ready to evolve! Visit your companion page.",{duration:5e3}))},onError:C=>{console.error("XP award failed:",C),X.error("Failed to award XP. Please try again.")}}),b=async(C,R,T,q,k)=>{if(!k?.id)throw new Error("Not authenticated");const P=C.current_xp+R,A=C.current_stage+1,L=o(A);ee.log("[XP Award Debug]",{currentStage:C.current_stage,currentXP:C.current_xp,xpAmount:R,newXP:P,nextStage:A,nextThreshold:L,willEvolve:L&&P>=L});const H=c(C.current_stage,P);let I=C.current_stage;H&&(I=A,ee.log("[Evolution Triggered]",{newStage:I,newXP:P,nextThreshold:L}));const{error:te}=await N.from("user_companion").update({current_xp:P}).eq("id",C.id).eq("user_id",k.id);if(te)throw te;return{shouldEvolve:H,newStage:I,newXP:P}},x=async()=>{if(t)try{const{data:C,error:R}=await N.from("profiles").select("referred_by").eq("id",t.id).maybeSingle();if(R){console.error("Error fetching profile for referral validation:",R);return}if(!C?.referred_by)return;const T=await uf(async()=>{const q=await N.rpc("complete_referral_stage3",{p_referee_id:t.id,p_referrer_id:C.referred_by}),{data:k,error:P}=q;if(P)throw P;if(!k)throw new Error("No data returned from referral completion");return k},{maxAttempts:3,initialDelay:1e3,shouldRetry:q=>{const k=q instanceof Error?q.message:String(q);return k.includes("already_completed")||k.includes("concurrent_completion")||k.includes("not found")?!1:k.includes("network")||k.includes("timeout")||k.includes("temporarily unavailable")||k.includes("connection")||k.includes("ECONNRESET")||k.includes("fetch")}});if(!T||!T.success){ee.log("Referral not completed:",T?.reason??"unknown",T?.message??"");return}ee.log("Referral completed successfully:",{newCount:T.new_count??0,milestoneReached:T.milestone_reached??!1,skinUnlocked:T.skin_unlocked??!1})}catch(C){console.error("Failed to validate referral after retries:",C)}},j=ie({mutationFn:async({newStage:C,currentXP:R})=>{if(l.current)return ee.log("Evolution already in progress, rejecting duplicate request"),u.current&&await u.current,null;l.current=!0;const T=(async()=>{if(!t||!h)throw l.current=!1,new Error("No companion found");i(!0);try{const{data:q,error:k}=await N.functions.invoke("generate-companion-evolution",{body:{userId:t.id}});if(k)throw l.current=!1,k;if(!q?.evolved)return l.current=!1,i(!1),ee.log("Evolution not triggered:",q?.message),null;const P=q.evolution_id,A=q.new_stage;h.current_stage<3&&A>=3&&await x();try{const{data:I}=await N.from("companion_evolution_cards").select("evolution_stage").eq("companion_id",h.id),te=new Set(I?.map(V=>V.evolution_stage)||[]);for(let V=0;V<=A;V++)if(!te.has(V)){ee.log(`Generating card for stage ${V}`);const{data:z}=await N.from("companion_evolutions").select("id").eq("companion_id",h.id).eq("stage",V).maybeSingle();let W=z?.id;if(V===0&&!z){ee.log("Stage 0 evolution record not found, creating one...");const{data:Q}=await N.from("user_companion").select("initial_image_url, created_at").eq("id",h.id).maybeSingle(),{data:U,error:$}=await N.from("companion_evolutions").insert({companion_id:h.id,stage:0,image_url:Q?.initial_image_url||null,xp_at_evolution:0,evolved_at:Q?.created_at||new Date().toISOString()}).select().maybeSingle();!$&&U?(W=U.id,ee.log("Created stage 0 evolution record:",W)):console.error("Failed to create stage 0 evolution record:",$)}W?await N.functions.invoke("generate-evolution-card",{body:{companionId:h.id,evolutionId:W,stage:V,species:h.spirit_animal,element:h.core_element,color:h.favorite_color,userAttributes:{vitality:h.vitality||300,wisdom:h.wisdom||300,discipline:h.discipline||300,resolve:h.resolve||300,creativity:h.creativity||300,alignment:h.alignment||300}}}):ee.warn(`Skipping card generation for stage ${V} - no evolution record found`)}}catch(I){console.error("Failed to generate evolution card:",I)}const{data:H}=await N.from("companion_stories").select("id").eq("companion_id",h.id).eq("stage",A).maybeSingle();return H||(async()=>{try{await N.functions.invoke("generate-companion-story",{body:{companionId:h.id,stage:A,tonePreference:"heroic",themeIntensity:"moderate"}}),ee.log(`Stage ${A} story generation started`),s.invalidateQueries({queryKey:["companion-story"]}),s.invalidateQueries({queryKey:["companion-stories-all"]})}catch(I){const te=I instanceof Error?I.message:String(I);console.warn(`Failed to auto-generate story for stage ${A} (non-critical):`,te)}})().catch(I=>{console.warn("Story generation promise rejected:",I?.message||I)}),q.image_url}catch(q){throw l.current=!1,i(!1),q}})();u.current=T;try{return await T}finally{u.current=null}},onSuccess:C=>{l.current=!1,C&&(s.invalidateQueries({queryKey:["companion"]}),s.invalidateQueries({queryKey:["companion-stories-all"]}),s.invalidateQueries({queryKey:["evolution-cards"]}),s.invalidateQueries({queryKey:["current-evolution-card"]}))},onError:C=>{l.current=!1,i(!1),console.error("Evolution failed:",C),X.error(C instanceof Error?C.message:"Unable to evolve your companion. Please try again.")}}),w=n.useMemo(()=>h?o(h.current_stage+1):null,[h,o]),D=n.useMemo(()=>{if(!h||!w)return 0;const C=h.current_xp/w*100;return Math.min(100,Math.max(0,C))},[h,w]),S=n.useMemo(()=>h?c(h.current_stage,h.current_xp):!1,[h,c]),M=n.useCallback(()=>{if(!h||!S)return;const C=h.current_stage+1;i(!0),window.dispatchEvent(new CustomEvent("evolution-loading-start")),X.success("ðŸŽ‰ Let's evolve!"),j.mutate({newStage:C,currentXP:h.current_xp})},[h,S,i,j]);return{companion:h,isLoading:f,error:d,refetch:g,createCompanion:y,awardXP:v,evolveCompanion:j,nextEvolutionXP:w,progressToNext:D,isEvolvingLoading:r,canEvolve:S,triggerManualEvolution:M}},xf=({theme:t,tier:s,name:a,enabled:r=!0})=>{const[i,o]=n.useState(null),[c,l]=n.useState(!1),[u,m]=n.useState(null);return n.useEffect(()=>{if(!r||!t||!s)return;(async()=>{l(!0),m(null);try{const{data:h}=await N.from("adversary_images").select("image_url").eq("theme",t).eq("tier",s).maybeSingle();if(h?.image_url){console.log(`Using cached adversary image for ${t}/${s}`),o(h.image_url),l(!1);return}console.log(`Generating new adversary image for ${t}/${s}`);const{data:f,error:d}=await N.functions.invoke("generate-adversary-image",{body:{theme:t,tier:s,name:a}});if(d)throw new Error(d.message);if(f?.imageUrl)o(f.imageUrl);else if(f?.error)throw new Error(f.error)}catch(h){console.error("Failed to get adversary image:",h),m(h instanceof Error?h.message:"Failed to load image")}finally{l(!1)}})()},[t,s,a,r]),{imageUrl:i,isLoading:c,error:u}};function yf({tier:t,onPlayerDefeated:s,onAdversaryDefeated:a,onDamageDealt:r}){const i=Lh[t],o=n.useRef({onPlayerDefeated:s,onAdversaryDefeated:a,onDamageDealt:r});o.current={onPlayerDefeated:s,onAdversaryDefeated:a,onDamageDealt:r};const[c,l]=n.useState(i.playerHP),[u,m]=n.useState(i.adversaryHP),[p,h]=n.useState([]),f=c<=0,d=u<=0,g=n.useMemo(()=>({playerHP:Math.max(0,c),playerMaxHP:i.playerHP,adversaryHP:Math.max(0,u),adversaryMaxHP:i.adversaryHP,isPlayerDefeated:f,isAdversaryDefeated:d,playerHPPercent:Math.max(0,c/i.playerHP*100),adversaryHPPercent:Math.max(0,u/i.adversaryHP*100)}),[c,u,i,f,d]),y=n.useCallback(x=>{f||d||(h(j=>[...j,x]),o.current.onDamageDealt?.(x),x.target==="player"?l(j=>{const w=j-x.amount;return w<=0&&setTimeout(()=>o.current.onPlayerDefeated?.(),0),Math.max(0,w)}):m(j=>{const w=j-x.amount;return w<=0&&setTimeout(()=>o.current.onAdversaryDefeated?.(),0),Math.max(0,w)}))},[f,d]),v=n.useCallback(()=>{l(i.playerHP),m(i.adversaryHP),h([])},[i]),b=n.useCallback(()=>Oh(c,i.playerHP,f),[c,i.playerHP,f]);return{battleState:g,dealDamage:y,resetBattle:v,getResult:b,tierAttackDamage:i.attackDamage,damageEvents:p}}const bf={distraction:"tap_sequence",chaos:"galactic_match",stagnation:"energy_beam",laziness:"energy_beam",anxiety:"orb_match",overthinking:"galactic_match",doubt:"tap_sequence",fear:"energy_beam",confusion:"orb_match",vulnerability:"energy_beam",imbalance:"tap_sequence"},Jl={distraction:"mind",chaos:"mind",stagnation:"body",laziness:"body",anxiety:"soul",overthinking:"soul",doubt:"mind",fear:"body",confusion:"soul",vulnerability:"body",imbalance:"mind"},jn={common:{phases:1,statBoost:1,xpBase:35},uncommon:{phases:1,statBoost:2,xpBase:45},rare:{phases:2,statBoost:3,xpBase:55},epic:{phases:2,statBoost:4,xpBase:75},legendary:{phases:3,statBoost:5,xpBase:100}},vf={perfect:1.5,good:1,fail:0},wf=[{name:"Doomscrolling",icon:"ðŸ“±",theme:"distraction"},{name:"Sugar Cravings",icon:"ðŸ¬",theme:"laziness"},{name:"Skipping Workouts",icon:"ðŸƒ",theme:"stagnation"},{name:"Stress Eating",icon:"ðŸ•",theme:"anxiety"},{name:"Procrastination",icon:"â°",theme:"stagnation"},{name:"Negative Self-Talk",icon:"ðŸ’­",theme:"doubt"},{name:"Nail Biting",icon:"ðŸ’…",theme:"anxiety"},{name:"Junk Food",icon:"ðŸ”",theme:"laziness"},{name:"Social Media",icon:"ðŸ“²",theme:"distraction"},{name:"Overthinking",icon:"ðŸ§ ",theme:"overthinking"}],jf={distraction:["Riftling","Scatter","Flickering","Wandering"],chaos:["Vortex","Maelstrom","Turbulent","Entropic"],stagnation:["Mire","Stillborn","Frozen","Anchored"],laziness:["Slumber","Drift","Languor","Torpid"],anxiety:["Tremor","Spiral","Frantic","Restless"],overthinking:["Echo","Loop","Recursive","Tangled"],doubt:["Shadow","Whisper","Fading","Hollow"],fear:["Dread","Creeping","Lurking","Umbral"],confusion:["Maze","Veiled","Obscured","Fogbound"],vulnerability:["Exposed","Piercing","Breaching","Unshielded"],imbalance:["Tilting","Wavering","Unstable","Teetering"]},_f={common:["Wisp","Shade","Specter","Phantom"],uncommon:["Wraith","Spirit","Haunt","Revenant"],rare:["Fiend","Demon","Harbinger","Herald"],epic:["Lord","Tyrant","Sovereign","Monarch"],legendary:["Titan","Colossus","Primordial","Ancient"]},Nf={distraction:["Born from scattered thoughts and fractured focus, this entity feeds on mental chaos.","A creature of fleeting moments, it thrives where attention wavers and concentration breaks."],chaos:["Manifested from the entropy of unordered days, this being revels in disorder.","Where plans crumble and routines shatter, this adversary grows stronger."],stagnation:["Formed in the depths of inaction, this entity chains the willing to the unchanging.","A manifestation of paralysis, it whispers that tomorrow is always better."],laziness:["Born from abandoned intentions and forsaken goals, it lulls the ambitious to sleep.","This creature grows fat on postponed dreams and delayed action."],anxiety:["Woven from racing heartbeats and sleepless nights, it amplifies every worry.","A storm of what-ifs given form, feeding on uncertainty and dread."],overthinking:["Created from endless mental loops and circular reasoning, it traps minds in analysis.","This entity spins thoughts into mazes with no exit."],doubt:["A shadow of self-belief, it whispers inadequacy to those who dare to dream.","Born from hesitation and second-guessing, it erodes confidence grain by grain."],fear:["Materialized from primal terrors and modern anxieties, it paralyzes the brave.","This ancient adversary has hunted dreamers since the first star was wished upon."],confusion:["A living labyrinth, this entity thrives when paths blur and direction fades.","Born from lost purpose and wandering souls, it delights in disorientation."],vulnerability:["Forged from moments of exposure and defenselessness, it strikes at unguarded hearts.","This predator hunts those who lower their shields, feeding on raw weakness."],imbalance:["Spawned from tilted scales and unstable foundations, it topples the centered.","Where equilibrium falters and harmony breaks, this adversary finds its strength."]},kf={distraction:["Focus Essence","Clarity Core","Concentration Crystal"],chaos:["Order Essence","Harmony Shard","Balance Core"],stagnation:["Motion Essence","Momentum Crystal","Flow Core"],laziness:["Vigor Essence","Energy Shard","Drive Core"],anxiety:["Calm Essence","Serenity Crystal","Peace Core"],overthinking:["Stillness Essence","Simplicity Shard","Clarity Core"],doubt:["Confidence Essence","Belief Crystal","Courage Core"],fear:["Bravery Essence","Valor Shard","Fearless Core"],confusion:["Direction Essence","Pathfinder Shard","Clarity Star"],vulnerability:["Shield Essence","Guardian Core","Protection Crystal"],imbalance:["Equilibrium Essence","Stability Shard","Center Core"]},Cf={distraction:"Sharpens mental acuity and strengthens focus.",chaos:"Brings order to turbulent thoughts.",stagnation:"Ignites the spark of movement and progress.",laziness:"Fuels the body with renewed energy.",anxiety:"Soothes the spirit and calms racing thoughts.",overthinking:"Quiets the endless mental chatter.",doubt:"Reinforces self-belief and inner strength.",fear:"Transforms terror into courageous resolve.",confusion:"Illuminates the path forward with clarity.",vulnerability:"Fortifies inner defenses and builds resilience.",imbalance:"Restores harmony and centers the spirit."},Ds=t=>t[Math.floor(Math.random()*t.length)],Sf=(t,s)=>t==="weekly"?"uncommon":t==="quest_milestone"?"common":t==="urge_resist"?Math.random()>.7?"uncommon":"common":t==="epic_checkpoint"&&s!==void 0?s>=100?"legendary":s>=75?"epic":s>=50?"rare":"uncommon":"common",Tf=(t,s)=>{if(t==="urge_resist"&&s&&["distraction","chaos","stagnation","laziness","anxiety","overthinking","doubt","fear","confusion","vulnerability","imbalance"].includes(s))return s;if(t==="epic_checkpoint"&&s){const r={fitness:["stagnation","laziness"],health:["stagnation","laziness"],body:["stagnation","laziness"],mind:["distraction","overthinking"],learning:["distraction","overthinking"],focus:["distraction","chaos"],soul:["anxiety","fear"],spiritual:["anxiety","doubt"],wellness:["anxiety","fear"],productivity:["chaos","laziness"],creative:["doubt","fear"]},i=s.toLowerCase();for(const[o,c]of Object.entries(r))if(i.includes(o))return Ds(c)}return Ds(["distraction","chaos","stagnation","laziness","anxiety","overthinking","doubt","fear","confusion","vulnerability","imbalance"])},Ef=(t,s,a,r)=>{const i=Sf(t,s),o=Tf(t,a),c=jn[i],l=Ds(jf[o]),u=Ds(_f[i]),m=`${l} ${u}`,p=Ds(Nf[o]),h=Ds(kf[o]),f=Cf[o];return{name:m,theme:o,tier:i,lore:p,miniGameType:bf[o],phases:c.phases,essenceName:h,essenceDescription:f,statType:Jl[o],statBoost:c.statBoost}},Zl=(t,s,a)=>{const r=jn[t].xpBase,i=ec(s),o=vf[i],c=a?1.25:1;return Math.round(r*o*c)},ec=t=>t>=90?"perfect":t>=50?"good":"fail";function ue({className:t,...s}){return e.jsx("div",{className:E("relative overflow-hidden rounded-md bg-muted/40",t),...s,children:e.jsx("div",{className:"absolute inset-0 -translate-x-full animate-shimmer bg-gradient-to-r from-transparent via-muted/20 to-transparent"})})}const Mf=()=>e.jsxs("div",{className:"min-h-screen bg-background p-4 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between pt-4",children:[e.jsxs("div",{className:"space-y-1",children:[e.jsx(ue,{className:"h-6 w-32"}),e.jsx(ue,{className:"h-4 w-48"})]}),e.jsx(ue,{className:"h-10 w-10 rounded-full"})]}),e.jsxs(Me,{className:"p-6 space-y-3",children:[e.jsx(ue,{className:"h-4 w-full"}),e.jsx(ue,{className:"h-4 w-5/6"}),e.jsx(ue,{className:"h-3 w-24 ml-auto"})]}),e.jsxs(Me,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ue,{className:"h-12 w-12 rounded-full"}),e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx(ue,{className:"h-5 w-36"}),e.jsx(ue,{className:"h-4 w-24"})]})]}),e.jsx(ue,{className:"h-2 w-full rounded-full"}),e.jsx(ue,{className:"h-10 w-full rounded-md"})]}),e.jsxs(Me,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ue,{className:"h-6 w-32"}),e.jsx(ue,{className:"h-6 w-6 rounded-full"})]}),e.jsx("div",{className:"flex justify-between",children:[...Array(5)].map((t,s)=>e.jsx(ue,{className:"h-10 w-10 rounded-full"},s))})]}),e.jsxs(Me,{className:"p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ue,{className:"h-10 w-10 rounded-full"}),e.jsx(ue,{className:"h-5 w-40"})]}),e.jsx(ue,{className:"h-12 w-full rounded-lg"})]}),e.jsxs(Me,{className:"p-6 space-y-4",children:[e.jsx(ue,{className:"h-6 w-36"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{className:"h-4 w-full"}),e.jsx(ue,{className:"h-4 w-3/4"})]})]})]}),Df=()=>e.jsxs("div",{className:"w-full max-w-md mx-auto space-y-4 p-4",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx(ue,{className:"h-6 w-16 rounded-full"}),e.jsx(ue,{className:"h-8 w-20"}),e.jsx(ue,{className:"h-6 w-16 rounded-full"})]}),e.jsx(ue,{className:"h-2 w-full rounded-full"}),e.jsxs("div",{className:"relative aspect-square rounded-2xl overflow-hidden",children:[e.jsx(ue,{className:"absolute inset-0"}),e.jsx("div",{className:"absolute inset-0 flex items-center justify-center",children:e.jsx(ue,{className:"h-24 w-24 rounded-full"})}),e.jsx(ue,{className:"absolute top-4 left-4 h-10 w-10 rounded-full"}),e.jsx(ue,{className:"absolute top-4 right-4 h-10 w-10 rounded-full"}),e.jsx(ue,{className:"absolute bottom-4 left-4 h-10 w-10 rounded-full"}),e.jsx(ue,{className:"absolute bottom-4 right-4 h-10 w-10 rounded-full"})]}),e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx(ue,{className:"h-5 w-48 mx-auto"}),e.jsx(ue,{className:"h-4 w-32 mx-auto"})]}),e.jsx(ue,{className:"h-12 w-full rounded-lg"})]}),Pf=()=>e.jsxs(Me,{className:"p-5 md:p-6 space-y-4 animate-pulse",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(ue,{className:"h-10 w-10 rounded-full"}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{className:"h-5 w-32"}),e.jsx(ue,{className:"h-3 w-20"})]})]})}),e.jsx(ue,{className:"h-2 w-full"}),e.jsx("div",{className:"space-y-2",children:[1,2,3].map(t=>e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg border",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1",children:[e.jsx(ue,{className:"h-5 w-5 rounded-full"}),e.jsx(ue,{className:"h-4 w-full max-w-xs"})]}),e.jsx(ue,{className:"h-9 w-24"})]},t))})]}),ci=n.lazy(()=>me(()=>import("./EnergyBeamGame-CLTOGMKR.js"),__vite__mapDeps([0,1,2,3,4])).then(t=>({default:t.EnergyBeamGame}))),Af=n.lazy(()=>me(()=>import("./TapSequenceGame-Bxu43lFI.js"),__vite__mapDeps([5,1,2,3,4])).then(t=>({default:t.TapSequenceGame}))),Rf=n.lazy(()=>me(()=>import("./AstralFrequencyGame-Dc9Ov7No.js"),__vite__mapDeps([6,1,2,3,4])).then(t=>({default:t.AstralFrequencyGame}))),If=n.lazy(()=>me(()=>import("./EclipseTimingGame-CdXXG3Da.js"),__vite__mapDeps([7,1,2,3,4])).then(t=>({default:t.EclipseTimingGame}))),qf=n.lazy(()=>me(()=>import("./StarfallDodgeGame-BvuTVzja.js"),__vite__mapDeps([8,1,2,3,4])).then(t=>({default:t.StarfallDodgeGame}))),Lf=n.lazy(()=>me(()=>import("./SoulSerpentGame-Bv_3BKdx.js"),__vite__mapDeps([9,1,2,3,4])).then(t=>({default:t.SoulSerpentGame}))),Ff=n.lazy(()=>me(()=>import("./OrbMatchGame-C3ujbT9L.js"),__vite__mapDeps([10,1,2,3,4])).then(t=>({default:t.OrbMatchGame}))),Of=n.lazy(()=>me(()=>import("./GalacticMatchGame-CBrJsOdG.js"),__vite__mapDeps([11,1,2,3,4])).then(t=>({default:t.GalacticMatchGame}))),Fr=new Set,$f=({open:t,onOpenChange:s,encounter:a,adversary:r,questInterval:i=3,onComplete:o,onPass:c,isBossBattle:l=!1,bossBattleContext:u,onBossBattleCancel:m})=>{const[p,h]=n.useState("reveal"),[f,d]=n.useState(0),[g,y]=n.useState([]),[v,b]=n.useState(!1),[x,j]=n.useState(null),[w,D]=n.useState(!1),[S,M]=n.useState(0),[C,R]=n.useState(0),{companion:T,refetch:q}=st(),k=n.useRef(!1);n.useEffect(()=>{t&&q()},[t,q]);const{data:P}=ye({queryKey:["current-evolution-card",T?.id,T?.current_stage],queryFn:async()=>{if(!T?.id)return null;const{data:ge}=await N.from("companion_evolution_cards").select("creature_name").eq("companion_id",T.id).eq("evolution_stage",T.current_stage||0).maybeSingle();return ge},enabled:!!T?.id&&t}),{battleState:A,dealDamage:L,resetBattle:H,getResult:I,tierAttackDamage:te,damageEvents:V}=yf({tier:r?.tier||"common",onPlayerDefeated:()=>{k.current||(k.current=!0,z("fail"))},onAdversaryDefeated:()=>{k.current||(k.current=!0,z("victory"))},onDamageDealt:ge=>{ge.target==="player"&&(D(!0),setTimeout(()=>D(!1),300))}}),z=n.useCallback(async ge=>{if(!r||!a)return;const Te=ge==="fail"?"fail":I(),Le=ge==="fail"?0:Math.round(A.playerHPPercent),F=ge==="fail"?0:Zl(r.tier,Le,v);if(!await o({encounterId:a.id,accuracy:Le,phasesCompleted:ge==="fail"?f:r.phases})){s(!1);return}j({result:Te,accuracy:Le,xpEarned:F,tiltBonus:v}),h("result")},[r,a,I,A.playerHPPercent,o,f,v,s]);n.useEffect(()=>{if(t){h(l?"boss_intro":"reveal"),d(0),y([]),j(null),b(!1),k.current=!1,H();const ge=r?.tier||"common",Te=qh[ge];M(Te),R(Te)}},[t,l,H,r?.tier]),n.useEffect(()=>{if(p!=="battle"||k.current)return;if(S<=0){if(!k.current){k.current=!0;const Te=100-A.adversaryHPPercent,Le=100-A.playerHPPercent,F=Te>Le?"victory":"fail";z(F)}return}const ge=setInterval(()=>{M(Te=>Math.max(0,Te-1))},1e3);return()=>clearInterval(ge)},[p,S,A.adversaryHPPercent,A.playerHPPercent,z]);const{imageUrl:W,isLoading:Q}=xf({theme:r?.theme||"",tier:r?.tier||"",name:r?.name||"",enabled:!!r&&t}),U={mind:Math.floor(((T?.wisdom??300)+(T?.creativity??300))/12),body:Math.floor(((T?.vitality??300)+(T?.discipline??300))/12),soul:Math.floor(((T?.resolve??300)+(T?.alignment??300))/12)},$=n.useCallback(()=>{if(!r)return"energy_beam";const Te={mind:["tap_sequence","galactic_match","orb_match"],body:["energy_beam"],soul:["orb_match","galactic_match"]}[r.statType]||["energy_beam","tap_sequence"];return r.phases===1?r.miniGameType:Te[f%Te.length]},[r,f]),J=n.useCallback(()=>{s(!1)},[s]),O=n.useCallback(()=>{h("reveal")},[]),le=n.useCallback(()=>{m?.(),J()},[m,J]),G=n.useCallback(()=>{h("instructions"),d(0),y([]),k.current=!1,H()},[H]),Z=n.useCallback(()=>{const ge=$();Fr.has(ge)?h("battle"):h("practice")},[$]),he=n.useCallback(()=>{const ge=$();Fr.add(ge),h("battle")},[$]),ve=n.useCallback(()=>{const ge=$();Fr.add(ge),h("battle")},[$]),we=n.useCallback(ge=>{k.current||L(ge)},[L]),je=n.useCallback(ge=>{if(!r||!a||k.current)return;ge.usedTiltControls&&b(!0);const Te=[...g,ge];y(Te),!(A.isPlayerDefeated||A.isAdversaryDefeated)&&(f<r.phases-1?(d(Le=>Le+1),h("instructions")):(d(0),h("instructions")))},[r,a,f,g,A.isPlayerDefeated,A.isAdversaryDefeated]),ke=n.useCallback(()=>{if(!r)return null;const ge=$(),Te=r.tier==="legendary"||r.tier==="epic"?"hard":r.tier==="rare"?"medium":"easy",Le=(i-3)*.15,F={companionStats:U,onComplete:je,difficulty:Te,questIntervalScale:Le,onDamage:we,tierAttackDamage:te,compact:!0},de=(()=>{switch(ge){case"energy_beam":return ci;case"tap_sequence":return Af;case"astral_frequency":return Rf;case"eclipse_timing":return If;case"starfall_dodge":return qf;case"soul_serpent":return Lf;case"orb_match":return Ff;case"galactic_match":return Of;default:return ci}})();return e.jsx(n.Suspense,{fallback:e.jsx(Df,{}),children:e.jsx(de,{...F})})},[r,$,U,je,i,we,te]);if(!a||!r)return null;const Ae=[],Re=$(),Ge=(p==="battle"||p==="practice")&&Ae.includes(Re);return e.jsxs(e.Fragment,{children:[t&&Ge&&e.jsxs("div",{className:"fixed inset-0 z-[100] bg-background",children:[p==="practice"&&e.jsx(ni,{gameType:Re,companionStats:U,onPracticeComplete:he,onSkipPractice:ve,isFullscreen:!0}),p==="battle"&&e.jsxs(e.Fragment,{children:[e.jsx(oi,{battleState:A,adversaryImageUrl:W||void 0,adversaryName:r.name,showScreenShake:w,battleTimeLeft:S,battleTimeTotal:C}),e.jsx(ii,{damageEvents:V,className:"z-50"}),r.phases>1&&e.jsx("div",{className:"fixed top-24 left-1/2 -translate-x-1/2 z-50 flex gap-2",children:Array.from({length:r.phases}).map((ge,Te)=>e.jsx("div",{className:`w-3 h-3 rounded-full ${Te<f?"bg-green-500":Te===f?"bg-primary animate-pulse":"bg-muted"}`},Te))}),ke()]})]}),e.jsx(ct,{open:t&&!Ge,onOpenChange:J,children:e.jsx(ot,{className:"sm:max-w-lg p-0 overflow-hidden bg-background border-border",children:e.jsxs(_.div,{className:"relative min-h-[500px] max-h-[90dvh] overflow-hidden flex flex-col",style:{paddingBottom:"env(safe-area-inset-bottom, 24px)"},animate:w?{x:[0,-4,4,-2,2,0]}:{},transition:{duration:.3},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/5 via-background to-accent/5"}),p==="battle"&&!Ge&&e.jsx(ii,{damageEvents:V,className:"z-50"}),e.jsx("div",{className:"relative z-10 flex flex-col h-full min-h-[500px]",children:e.jsxs(be,{mode:"wait",children:[p==="boss_intro"&&l&&u&&e.jsx(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsx(of,{context:u,onBeginBattle:O,onCancel:le})},"boss_intro"),p==="reveal"&&e.jsx(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},children:e.jsx(Bh,{adversary:r,adversaryImageUrl:W||void 0,isLoadingImage:Q,companionImageUrl:T?.current_image_url||void 0,companionName:P?.creature_name||T?.spirit_animal||"Companion",companionStage:T?.current_stage||0,onReady:G,onPass:c})},"reveal"),p==="instructions"&&e.jsx(_.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},children:e.jsx(Kh,{gameType:$(),onReady:Z})},`instructions-${f}`),p==="practice"&&e.jsx(_.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.95},children:e.jsx(ni,{gameType:$(),companionStats:U,onPracticeComplete:he,onSkipPractice:ve})},`practice-${f}`),p==="battle"&&!Ge&&e.jsxs(_.div,{initial:{opacity:0,x:50},animate:{opacity:1,x:0},exit:{opacity:0,x:-50},className:"flex flex-col flex-1 min-h-0",children:[e.jsx(oi,{battleState:A,adversaryImageUrl:W||void 0,adversaryName:r.name,battleTimeLeft:S,battleTimeTotal:C}),r.phases>1&&e.jsx("div",{className:"flex justify-center gap-2 py-2",children:Array.from({length:r.phases}).map((ge,Te)=>e.jsx("div",{className:`w-3 h-3 rounded-full ${Te<f?"bg-green-500":Te===f?"bg-primary animate-pulse":"bg-muted"}`},Te))}),e.jsx("div",{className:"flex-1 min-h-0",children:ke()})]},`battle-${f}`),p==="result"&&x&&e.jsx(_.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0},children:e.jsx(Uh,{adversary:r,result:x.result,accuracy:x.accuracy,xpEarned:x.xpEarned,onClose:J,retryAvailableAt:x.result==="fail"?new Date(Date.now()+14400*1e3).toISOString():void 0,tiltBonus:x.tiltBonus,companionImageUrl:T?.current_image_url||void 0,companionName:P?.creature_name||T?.spirit_animal||"Your companion"})},"result")]})})]})})})]})},Bf={common:{primary:"hsl(var(--muted))",secondary:"hsl(var(--muted-foreground))",glow:"rgba(156, 163, 175, 0.5)"},uncommon:{primary:"hsl(142, 76%, 46%)",secondary:"hsl(142, 76%, 60%)",glow:"rgba(34, 197, 94, 0.5)"},rare:{primary:"hsl(217, 91%, 60%)",secondary:"hsl(217, 91%, 75%)",glow:"rgba(59, 130, 246, 0.5)"},epic:{primary:"hsl(271, 91%, 65%)",secondary:"hsl(271, 91%, 80%)",glow:"rgba(168, 85, 247, 0.5)"},legendary:{primary:"hsl(38, 92%, 50%)",secondary:"hsl(38, 92%, 70%)",glow:"rgba(245, 158, 11, 0.5)"}},Hf=({isVisible:t,tier:s="common",onComplete:a})=>{const r=Bf[s],i=n.useRef(!1),o=n.useRef(null),c=n.useRef(!1);return n.useEffect(()=>{t&&!i.current&&(i.current=!0,Ip()),t||(i.current=!1,c.current=!1,o.current&&(clearTimeout(o.current),o.current=null))},[t]),n.useEffect(()=>()=>{o.current&&(clearTimeout(o.current),o.current=null)},[]),t?e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},onAnimationComplete:()=>{c.current||(c.current=!0,o.current=setTimeout(()=>{o.current=null,a()},2500))},className:"fixed inset-0 z-[9999] flex items-center justify-center overflow-hidden",style:{background:`linear-gradient(135deg, hsl(var(--background)) 0%, ${r.primary}20 50%, hsl(var(--background)) 100%)`,pointerEvents:"auto",touchAction:"none"},children:[e.jsx(_.div,{className:"absolute inset-0",style:{background:`radial-gradient(circle at center, ${r.glow} 0%, transparent 70%)`},animate:{scale:[1,1.5,1],opacity:[.3,.6,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx(_.div,{className:"absolute w-96 h-96 rounded-full border-2",style:{borderColor:r.primary},initial:{scale:0,opacity:1},animate:{scale:[0,3,3],opacity:[1,.5,0]},transition:{duration:2,repeat:1/0,ease:"easeOut"}}),e.jsx(_.div,{className:"absolute w-64 h-64 rounded-full border",style:{borderColor:r.secondary},initial:{scale:0,opacity:1},animate:{scale:[0,4,4],opacity:[1,.3,0]},transition:{duration:2.5,repeat:1/0,delay:.3,ease:"easeOut"}}),e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(40)].map((l,u)=>e.jsx(_.div,{className:"absolute w-1.5 h-1.5 rounded-full",style:{backgroundColor:u%2===0?r.primary:r.secondary,boxShadow:`0 0 8px ${r.glow}`},initial:{x:Math.random()*(typeof window<"u"?window.innerWidth:400),y:(typeof window<"u"?window.innerHeight:800)+50},animate:{y:-50,x:Math.random()*(typeof window<"u"?window.innerWidth:400),scale:[0,1.5,0],opacity:[0,1,0]},transition:{duration:1.2+Math.random()*1.3,repeat:1/0,delay:Math.random()*1.5}},u))}),e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(12)].map((l,u)=>e.jsx(_.div,{className:"absolute w-3 h-3 rounded-full",style:{backgroundColor:r.secondary,boxShadow:`0 0 12px ${r.glow}`,left:"50%",top:"50%"},animate:{x:[0,Math.cos(u*30*Math.PI/180)*150,0],y:[0,Math.sin(u*30*Math.PI/180)*150,0],scale:[0,1,0],opacity:[0,1,0]},transition:{duration:2,repeat:1/0,delay:u*.1,ease:"easeInOut"}},`swirl-${u}`))}),e.jsxs("div",{className:"flex flex-col items-center gap-6 relative z-10",children:[e.jsxs(_.div,{className:"relative",initial:{scale:0,rotate:-180},animate:{scale:1,rotate:0},transition:{type:"spring",stiffness:200,damping:15,delay:.2},children:[e.jsx(_.div,{className:"absolute inset-0 rounded-full blur-xl",style:{backgroundColor:r.glow},animate:{scale:[1,1.5,1],opacity:[.5,.8,.5]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"}}),e.jsx(_.div,{className:"relative p-6 rounded-full",style:{background:`linear-gradient(135deg, ${r.primary}, ${r.secondary})`,boxShadow:`0 0 40px ${r.glow}`},animate:{rotate:[0,5,-5,0]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx(_o,{className:"w-16 h-16 text-white",style:{filter:"drop-shadow(0 0 10px white)"}})}),e.jsx(_.div,{className:"absolute -top-4 -right-4",animate:{scale:[0,1,0],opacity:[0,1,0]},transition:{duration:.8,repeat:1/0,delay:.5},children:e.jsx(Be,{className:"w-8 h-8",style:{color:r.secondary,filter:`drop-shadow(0 0 8px ${r.glow})`}})}),e.jsx(_.div,{className:"absolute -bottom-4 -left-4",animate:{scale:[0,1,0],opacity:[0,1,0]},transition:{duration:.8,repeat:1/0,delay:.8},children:e.jsx(Be,{className:"w-8 h-8",style:{color:r.secondary,filter:`drop-shadow(0 0 8px ${r.glow})`}})})]}),e.jsxs(_.div,{className:"text-center space-y-3",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.5},children:[e.jsx(_.h2,{className:"text-3xl md:text-4xl font-black text-foreground",style:{textShadow:`0 0 30px ${r.glow}`},animate:{opacity:[.8,1,.8]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"},children:"Astral Entity Detected!"}),e.jsx(_.p,{className:"text-lg text-muted-foreground",animate:{opacity:[.6,1,.6]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:"Prepare for battle..."})]})]})]}):null},hr=n.forwardRef(({className:t,children:s,...a},r)=>e.jsxs(No,{ref:r,className:E("relative overflow-hidden",t),...a,children:[e.jsx(Nu,{className:"h-full w-full rounded-[inherit]",children:s}),e.jsx(tc,{}),e.jsx(ku,{})]}));hr.displayName=No.displayName;const tc=n.forwardRef(({className:t,orientation:s="vertical",...a},r)=>e.jsx(ko,{ref:r,orientation:s,className:E("flex touch-none select-none transition-colors",s==="vertical"&&"h-full w-2.5 border-l border-l-transparent p-[1px]",s==="horizontal"&&"h-2.5 flex-col border-t border-t-transparent p-[1px]",t),...a,children:e.jsx(Cu,{className:"relative flex-1 rounded-full bg-border"})}));tc.displayName=ko.displayName;const di={vitality:{icon:"ðŸ’ª",name:"Vitality",color:"text-red-400",progressColor:"bg-red-400",whatItMeans:"Your life force, energy, and physical health. The engine of transformation.",boostedBy:["Fitness quests (gym, running, yoga)","Sleep rituals and rest goals","Nutrition and hydration habits","Cold showers and morning routines","Walking and step tracking"],whenGrows:"You build raw power and endurance. Your body becomes a vessel of strength and vitality."},wisdom:{icon:"ðŸ“š",name:"Wisdom",color:"text-blue-400",progressColor:"bg-blue-400",whatItMeans:"Pattern recognition, learning, and clarity. The foundation of insight.",boostedBy:["Reading books and articles","Studying and taking courses","Learning new skills","Mentor interactions and guidance","Reflection and journaling"],whenGrows:"You gain insight and understanding. Your mind sharpens and hidden patterns become clear."},discipline:{icon:"ðŸŽ¯",name:"Discipline",color:"text-green-400",progressColor:"bg-green-400",whatItMeans:"Reliability of action and consistency. The backbone of transformation.",boostedBy:["Completing daily rituals","Maintaining streaks","Showing up on hard days","Following through on plans","Deep work and Pomodoro sessions"],whenGrows:"You become someone who follows through. Your word to yourself becomes unbreakable."},resolve:{icon:"ðŸ›¡ï¸",name:"Resolve",color:"text-purple-400",progressColor:"bg-purple-400",whatItMeans:"Your ability to withstand pressure and resist urges. Inner fortitude.",boostedBy:["Resist victories","Astral Encounter wins","Comebacks after lapses","Staying strong during temptation","Overcoming setbacks"],whenGrows:"You become unshakeable. Pressure forges you into something stronger."},creativity:{icon:"ðŸŽ¨",name:"Creativity",color:"text-orange-400",progressColor:"bg-orange-400",whatItMeans:"Your ability to imagine, create, and express. The spark of originality.",boostedBy:["Shipping and building things","Writing and journaling","Art and design projects","Music and creative hobbies","Problem-solving and brainstorming"],whenGrows:"You see possibilities others miss. Your unique voice emerges."},alignment:{icon:"âœ¨",name:"Alignment",color:"text-celestial-blue",progressColor:"bg-celestial-blue",whatItMeans:"How aligned your actions are with who you want to be. Purpose and identity.",boostedBy:["Long-term campaign progress","Identity-based quests","Weekly reflections","Purpose journaling","Living by your values"],whenGrows:"You live with intention and meaning. Your actions reflect your truest self."}},zf={vitality:["discipline","alignment"],wisdom:["creativity","alignment"],discipline:["resolve"],resolve:["discipline","alignment"],creativity:["wisdom","discipline"],alignment:["resolve"]},Or=100,ui=1e3,$r=300,sc=()=>{const{user:t}=ce(),s=Se(),a=ie({mutationFn:async({companionId:d,attribute:g,amount:y,applyEchoGains:v=!0})=>{if(!t)throw new Error("Not authenticated");const{data:b,error:x}=await N.from("user_companion").select("vitality, wisdom, discipline, resolve, creativity, alignment").eq("id",d).eq("user_id",t.id).maybeSingle();if(x)throw x;if(!b)throw new Error("Companion not found");const j=b[g]??$r,w=Math.max(Or,Math.min(ui,j+y)),D={[g]:w,last_energy_update:new Date().toISOString()};if(v&&y>0){const M=zf[g]||[],C=Math.min(20,Math.floor(y*.2));if(C>0)for(const R of M){const T=b[R]??$r;D[R]=Math.min(ui,Math.max(Or,T+C))}}const{error:S}=await N.from("user_companion").update(D).eq("id",d).eq("user_id",t.id);if(S)throw S;return{attribute:g,newValue:w,change:y}},onSuccess:d=>{if(s.invalidateQueries({queryKey:["companion"]}),Math.abs(d.change)>=50){const g=d.change>0?"â¬†ï¸":"â¬‡ï¸",y=d.change>0?"increased":"decreased",v=Uf[d.attribute];X.success(`${g} ${v?.name||d.attribute} ${y}!`,{duration:2e3})}},onError:d=>{console.error("Attribute update failed:",d)}}),r=ie({mutationFn:async d=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:d,attribute:"vitality",amount:12})}}),i=ie({mutationFn:async d=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:d,attribute:"wisdom",amount:8})}}),o=ie({mutationFn:async d=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:d,attribute:"discipline",amount:15})}}),c=ie({mutationFn:async d=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:d,attribute:"discipline",amount:10})}}),l=ie({mutationFn:async d=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:d,attribute:"resolve",amount:20})}}),u=ie({mutationFn:async d=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:d,attribute:"creativity",amount:10})}}),m=ie({mutationFn:async d=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:d,attribute:"alignment",amount:6})}}),p=ie({mutationFn:async({companionId:d,streakDays:g})=>{if(!t)throw new Error("Not authenticated");let y=0;g===7?y=15:g===14?y=25:g===30?y=40:g%7===0&&(y=5),y>0&&await a.mutateAsync({companionId:d,attribute:"discipline",amount:y})}}),h=ie({mutationFn:async d=>{if(!t)throw new Error("Not authenticated");await a.mutateAsync({companionId:d,attribute:"alignment",amount:8,applyEchoGains:!0})}}),f=ie({mutationFn:async d=>{if(!t)throw new Error("Not authenticated");const{data:g,error:y}=await N.from("user_companion").select("vitality, wisdom, discipline, resolve, creativity, alignment").eq("id",d).eq("user_id",t.id).maybeSingle();if(y)throw y;if(!g)throw new Error("Companion not found");const v={discipline:40,vitality:30,creativity:25,resolve:20,wisdom:15,alignment:15},b={last_energy_update:new Date().toISOString()};for(const[j,w]of Object.entries(v)){const D=g[j]??$r;b[j]=Math.max(Or,D-w)}const{error:x}=await N.from("user_companion").update(b).eq("id",d).eq("user_id",t.id);if(x)throw x}});return{updateAttribute:a.mutateAsync,updateVitalityFromFitness:r.mutateAsync,updateWisdomFromLearning:i.mutateAsync,updateDisciplineFromRitual:o.mutateAsync,updateDisciplineFromWork:c.mutateAsync,updateResolveFromResist:l.mutateAsync,updateCreativityFromShipping:u.mutateAsync,updateAlignmentFromReflection:m.mutateAsync,updateFromStreakMilestone:p.mutateAsync,updateFromPerfectDay:h.mutateAsync,decayStats:f.mutateAsync}},Uf={vitality:{name:"Vitality"},wisdom:{name:"Wisdom"},discipline:{name:"Discipline"},resolve:{name:"Resolve"},creativity:{name:"Creativity"},alignment:{name:"Alignment"}},fr=()=>{const{profile:t}=yt();return n.useMemo(()=>{const s=t?.current_habit_streak??0,a=t?.longest_habit_streak??0;let r=1;s>=30?r=2:s>=7&&(r=1.5);let i;return s<7?i={days:7,multiplier:1.5,daysRemaining:7-s}:s<30?i={days:30,multiplier:2,daysRemaining:30-s}:i={days:30,multiplier:2,daysRemaining:0},{currentStreak:s,longestStreak:a,multiplier:r,nextMilestone:i}},[t?.current_habit_streak,t?.longest_habit_streak])},mi={quest:1,ritual:2,resist:3,pomodoro:1,mentor:1},Wf=5,Qf=7,Kf="momentum_gain",pi={quest:"quest_count",ritual:"ritual_count",resist:"resist_count",pomodoro:"pomodoro_count",mentor:"mentor_count"},Gf=()=>{const{user:t}=ce(),s=n.useCallback(()=>new Date().toISOString().split("T")[0],[]),a=n.useCallback(async o=>{if(!t?.id)return{canShow:!1,sourceCount:0,totalCount:0,sourceLimit:mi[o]};const c=s(),l=pi[o],u=mi[o],{data:m,error:p}=await N.from("user_reaction_budget").select("*").eq("user_id",t.id).eq("budget_date",c).maybeSingle();if(p)return console.error("Failed to check reaction budget:",p),{canShow:!1,sourceCount:0,totalCount:0,sourceLimit:u};if(!m)return{canShow:!0,sourceCount:0,totalCount:0,sourceLimit:u};const h=m[l]||0,f=m.total_count||0;return{canShow:h<u&&f<Wf,sourceCount:h,totalCount:f,sourceLimit:u}},[t?.id,s]),r=n.useCallback(async o=>{if(!t?.id)return!1;const c=s(),l=pi[o],{data:u}=await N.from("user_reaction_budget").select("*").eq("user_id",t.id).eq("budget_date",c).maybeSingle();if(u){const m=u[l]||0,p=u.total_count||0,{error:h}=await N.from("user_reaction_budget").update({[l]:m+1,total_count:p+1,updated_at:new Date().toISOString()}).eq("id",u.id);if(h)return console.error("Failed to update reaction budget:",h),!1}else{const{error:m}=await N.from("user_reaction_budget").insert({user_id:t.id,budget_date:c,[l]:1,total_count:1,updated_at:new Date().toISOString()});if(m)return console.error("Failed to insert reaction budget:",m),!1}return!0},[t?.id,s]),i=n.useCallback(async()=>{if(!t?.id)return null;const o=s(),{data:c}=await N.from("user_reaction_budget").select("*").eq("user_id",t.id).eq("budget_date",o).maybeSingle();return c},[t?.id,s]);return{checkBudget:a,incrementBudget:r,getBudgetStatus:i}},Yf=()=>{const{user:t}=ce(),s=n.useCallback(async()=>{if(!t?.id)return null;const{data:c}=await N.from("user_reaction_history").select("tone_tag").eq("user_id",t.id).order("shown_at",{ascending:!1}).limit(1).maybeSingle();return c?.tone_tag||null},[t?.id]),a=n.useCallback(async()=>{if(!t?.id)return!1;const c=new Date;c.setDate(c.getDate()-Qf);const{data:l}=await N.from("user_reaction_history").select("reaction_id").eq("user_id",t.id).gte("shown_at",c.toISOString());if(!l||l.length===0)return!1;const u=l.map(p=>p.reaction_id).filter(Boolean);if(u.length===0)return!1;const{data:m}=await N.from("companion_reactions").select("id").in("id",u).contains("context_tags",["rare"]);return(m?.length||0)>0},[t?.id]),r=n.useCallback(async()=>{if(!t?.id)return new Set;const c=new Date;c.setDate(c.getDate()-7);const{data:l}=await N.from("user_reaction_history").select("reaction_id, shown_at").eq("user_id",t.id).gte("shown_at",c.toISOString());if(!l)return new Set;const u=l.map(d=>d.reaction_id).filter(Boolean);if(u.length===0)return new Set;const{data:m}=await N.from("companion_reactions").select("id, cooldown_hours").in("id",u);if(!m)return new Set;const p=new Map(m.map(d=>[d.id,d.cooldown_hours])),h=Date.now(),f=new Set;for(const d of l){if(!d.reaction_id)continue;const g=p.get(d.reaction_id)||12,y=new Date(d.shown_at).getTime(),v=g*60*60*1e3;h-y<v&&f.add(d.reaction_id)}return f},[t?.id]),i=n.useCallback(async(c,l,u=[])=>{if(!t?.id)return{reaction:null,reason:"No user"};const m=N.from("companion_reactions").select("id, text, tone_tag, context_tags, cooldown_hours").eq("is_active",!0).contains("source_systems",[c]),{data:p,error:h}=await m;if(h||!p||p.length===0)return{reaction:null,reason:"No reactions available"};let f=p;const{data:d}=await N.from("companion_reactions").select("id, text, tone_tag, context_tags, cooldown_hours").eq("is_active",!0).contains("source_systems",[c]).or(`moment_types.cs.{${l}},moment_types.eq.{}`);d&&d.length>0&&(f=d);const g=await r();if(f=f.filter(x=>!g.has(x.id)),f.length===0)return{reaction:null,reason:"All reactions on cooldown"};if(await a()&&(f=f.filter(x=>!x.context_tags?.includes("rare"))),f.length===0)return{reaction:null,reason:"No non-rare reactions available"};const v=await s();if(v){const x=f.filter(j=>j.tone_tag!==v);x.length>0&&(f=x)}if(u.length>0){const x=f.filter(j=>u.some(w=>j.context_tags?.includes(w)));x.length>0&&(f=x)}return{reaction:f[Math.floor(Math.random()*f.length)]}},[t?.id,r,a,s]),o=n.useCallback(async(c,l,u)=>{t?.id&&await N.from("user_reaction_history").insert({user_id:t.id,reaction_id:c.id,source_system:l,moment_type:u,reaction_text_snapshot:c.text,tone_tag:c.tone_tag})},[t?.id]);return{selectReaction:i,recordReaction:o}},qs=n.forwardRef(({className:t,...s},a)=>e.jsx(Co,{ref:a,className:E("relative flex h-10 w-10 shrink-0 overflow-hidden rounded-full",t),...s}));qs.displayName=Co.displayName;const Ls=n.forwardRef(({className:t,...s},a)=>e.jsx(So,{ref:a,className:E("aspect-square h-full w-full",t),...s}));Ls.displayName=So.displayName;const Fs=n.forwardRef(({className:t,...s},a)=>e.jsx(To,{ref:a,className:E("flex h-full w-full items-center justify-center rounded-full bg-muted",t),...s}));Fs.displayName=To.displayName;const Vf=t=>{const s=t.length;return Math.min(5,Math.max(3.2,3+s/50))},ac=n.memo(({isVisible:t,onDismiss:s,message:a,companionName:r,companionImageUrl:i})=>{const[o,c]=n.useState(0),l=Vf(a),u=typeof window<"u"&&window.matchMedia?.("(prefers-reduced-motion: reduce)").matches;n.useEffect(()=>{if(!t){c(0);return}const p=Date.now(),h=l*1e3,f=setInterval(()=>{const d=Date.now()-p,g=Math.min(100,d/h*100);c(g),d>=h&&(clearInterval(f),s())},50);return()=>clearInterval(f)},[t,l,s]);const m=n.useCallback(()=>{s()},[s]);return n.useEffect(()=>{if(!t)return;const p=h=>{(h.key==="Escape"||h.key==="Enter"||h.key===" ")&&(h.preventDefault(),m())};return window.addEventListener("keydown",p),()=>window.removeEventListener("keydown",p)},[t,m]),e.jsx(be,{children:t&&e.jsx(_.div,{initial:u?{opacity:1}:{opacity:0,y:20},animate:{opacity:1,y:0},exit:u?{opacity:0}:{opacity:0,y:10},transition:{duration:.2,ease:"easeOut"},className:E("fixed left-4 right-4 z-50 cursor-pointer","max-w-[680px] mx-auto","bottom-[calc(64px+env(safe-area-inset-bottom,0px)+12px)]"),onClick:m,role:"dialog","aria-modal":"false","aria-label":`${r} says: ${a}`,children:e.jsxs("div",{className:E("relative rounded-2xl overflow-hidden","bg-card/95 backdrop-blur-lg","border border-primary/20","shadow-lg shadow-primary/10"),children:[e.jsxs("div",{className:"flex items-start gap-4 p-4",children:[e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:E("rounded-xl overflow-hidden","ring-2 ring-primary/30","shadow-md shadow-primary/20"),children:e.jsxs(qs,{className:"h-16 w-16 rounded-xl",children:[i?e.jsx(Ls,{src:i,alt:r,className:"object-cover"}):null,e.jsx(Fs,{className:"rounded-xl bg-primary/20 text-primary text-lg font-bold",children:r.charAt(0)})]})}),e.jsx("div",{className:"absolute inset-0 rounded-xl bg-primary/10 blur-xl -z-10"})]}),e.jsxs("div",{className:"flex-1 min-w-0 pt-1",children:[e.jsxs("p",{className:"text-foreground text-base leading-relaxed",children:['"',a,'"']}),e.jsxs("p",{className:"mt-2 text-sm text-muted-foreground flex items-center gap-1",children:["â€” ",r," ",e.jsx("span",{className:"text-primary",children:"âœ¨"})]})]}),e.jsx("button",{onClick:p=>{p.stopPropagation(),m()},className:E("flex-shrink-0 p-1.5 rounded-full","text-muted-foreground hover:text-foreground","hover:bg-muted/50 transition-colors","focus:outline-none focus:ring-2 focus:ring-primary/50"),"aria-label":"Dismiss",children:e.jsx(Qe,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"px-4 pb-3",children:e.jsx(ts,{value:o,className:"h-1 bg-muted/30"})})]})})})});ac.displayName="CompanionTalkPopup";const rc=n.createContext(null),Xf=t=>t.replace(/\b\w/g,s=>s.toUpperCase()),nc=n.memo(({children:t})=>{const{companion:s}=st(),[a,r]=n.useState(!1),[i,o]=n.useState(""),[c,l]=n.useState("Companion"),[u,m]=n.useState(null),p=n.useRef([]),h=n.useRef(!1),f=n.useCallback(async()=>{if(!s)return"Companion";const y=s.cached_creature_name;if(y)return y;try{const{data:v}=await N.from("companion_evolution_cards").select("creature_name").eq("companion_id",s.id).eq("evolution_stage",s.current_stage).maybeSingle();if(v?.creature_name)return N.from("user_companion").update({cached_creature_name:v.creature_name}).eq("id",s.id).then(()=>{}),v.creature_name}catch(v){console.error("Failed to fetch creature name:",v)}return s.spirit_animal?Xf(s.spirit_animal):"Companion"},[s]),d=n.useCallback(async y=>{if(h.current){p.current.push(y);return}h.current=!0;const v=y.companionName||await f(),b=y.companionImageUrl||s?.current_image_url||null;o(y.message),l(v),m(b),r(!0)},[s,f]),g=n.useCallback(()=>{r(!1),h.current=!1;const y=p.current.shift();y&&setTimeout(()=>d(y),300)},[d]);return e.jsxs(rc.Provider,{value:{show:d,dismiss:g,isVisible:a},children:[t,e.jsx(ac,{isVisible:a,onDismiss:g,message:i,companionName:c,companionImageUrl:u})]})});nc.displayName="TalkPopupProvider";const Jf=()=>{const t=n.useContext(rc);return t||{show:async()=>{},dismiss:()=>{},isVisible:!1}},Na=()=>{const{user:t}=ce(),s=Jf(),{checkBudget:a,incrementBudget:r}=Gf(),{selectReaction:i,recordReaction:o}=Yf();s.isVisible;const c=n.useCallback(async(d,g={})=>{if(!t?.id)return!1;const{momentType:y=Kf,contextTags:v=[],force:b=!1}=g;if(!b&&!(await a(d)).canShow)return console.log(`[LivingCompanion] Budget exceeded for ${d}`),!1;const{reaction:x,reason:j}=await i(d,y,v);return x?(await s.show({message:x.text}),await Promise.all([o(x,d,y),r(d)]),console.log(`[LivingCompanion] Showed reaction: "${x.text}" (${x.tone_tag})`),!0):(console.log(`[LivingCompanion] No reaction available: ${j}`),!1)},[t?.id,a,i,s,o,r]),l=n.useCallback(()=>{const d=new Date().getHours();return d>=23||d<4},[]),u=n.useCallback(async()=>{const d=l()?["late_night"]:[];return c("resist",{momentType:"urge_defeated",contextTags:d})},[c,l]),m=n.useCallback(async(d=!1)=>d?c("quest",{momentType:"momentum_gain"}):!1,[c]),p=n.useCallback(async(d=!1,g=!1)=>!d&&!g?!1:c("ritual",{momentType:g?"breakthrough":"discipline_win"}),[c]),h=n.useCallback(async d=>d<15?!1:c("pomodoro",{momentType:"focus_proof"}),[c]),f=n.useCallback(async()=>c("quest",{momentType:"comeback"}),[c]);return{triggerReaction:c,triggerResistVictory:u,triggerQuestComplete:m,triggerRitualComplete:p,triggerPomodoroComplete:h,triggerComeback:f,isLateNight:l}},Ia=async t=>{const s=new Date().toISOString().split("T")[0];await N.from("user_companion").update({last_activity_date:s,inactive_days:0,current_mood:"happy"}).eq("user_id",t)},bt=()=>{const{user:t}=ce(),{companion:s,awardXP:a}=st(),{showXPToast:r}=Al(),i=Se(),{multiplier:o}=fr(),{updateDisciplineFromRitual:c,updateWisdomFromLearning:l,updateAlignmentFromReflection:u,updateFromStreakMilestone:m}=sc(),{triggerQuestComplete:p}=Na(),h=async()=>{if(!t?.id)return!1;const O=new Date().toISOString().split("T")[0],{count:le}=await N.from("daily_tasks").select("*",{count:"exact",head:!0}).eq("user_id",t.id).eq("task_date",O).eq("completed",!0);return(le??0)<=1},f=O=>Math.round(O*(o??1)),{data:d}=ye({queryKey:["profile",t?.id],queryFn:async()=>{if(!t)return null;const{data:O}=await N.from("profiles").select("current_habit_streak").eq("id",t.id).maybeSingle();return O},enabled:!!t}),g=async()=>{if(!(!s||a.isPending))try{t?.id&&Ia(t.id).then(()=>{i.invalidateQueries({queryKey:["companion-health"]})});const O=f(Lt.HABIT_COMPLETE);r(O,"Habit Completed!"),a.mutate({eventType:"habit_complete",xpAmount:O});const le=s.id;le&&(l(le).catch(G=>{ee.error("Wisdom update failed:",G)}),c(le).catch(G=>{ee.error("Discipline update failed:",G)})),h().then(G=>{p(G).catch(Z=>ee.log("[LivingCompanion] Quest reaction failed:",Z))})}catch(O){ee.error("Error awarding habit completion:",O)}},y=()=>{if(!s)return;const O=f(Lt.ALL_HABITS_COMPLETE);r(O,"All Habits Complete!"),a.mutate({eventType:"all_habits_complete",xpAmount:O})},v=()=>{if(!s)return;t?.id&&Ia(t.id).then(()=>{i.invalidateQueries({queryKey:["companion-health"]})});const O=f(Lt.CHALLENGE_COMPLETE);r(O,"Challenge Complete!"),a.mutate({eventType:"challenge_complete",xpAmount:O})},b=()=>{if(!s)return;t?.id&&Ia(t.id).then(()=>{i.invalidateQueries({queryKey:["companion-health"]})});const O=f(Lt.WEEKLY_CHALLENGE);r(O,"Weekly Challenge Done!"),a.mutate({eventType:"weekly_challenge",xpAmount:O})},x=O=>{if(!s)return;const le=f(Lt.PEP_TALK_LISTEN);r(le,"Pep Talk Listened!"),a.mutate({eventType:"pep_talk_listen",xpAmount:le,metadata:O})},j=async()=>{if(!(!s||a.isPending))try{t?.id&&Ia(t.id).then(()=>{i.invalidateQueries({queryKey:["companion-health"]})});const O=f(Lt.CHECK_IN);r(O,"Check-In Complete!"),a.mutate({eventType:"check_in",xpAmount:O});const le=s.id;le&&(u(le).catch(G=>{ee.error("Alignment update failed:",G)}),c(le).catch(G=>{ee.error("Discipline update failed:",G)}))}catch(O){ee.error("Error awarding check-in:",O)}};return{awardHabitCompletion:g,awardAllHabitsComplete:y,awardChallengeCompletion:v,awardWeeklyChallengeCompletion:b,awardPepTalkListened:x,awardCheckInComplete:j,awardStreakMilestone:async O=>{if(!(!s||a.isPending))try{const le=f(Lt.STREAK_MILESTONE);r(le,`${O} Day Streak!`),a.mutate({eventType:"streak_milestone",xpAmount:le,metadata:{milestone:O}});const G=s.id;if(G&&(m({companionId:G,streakDays:O}).catch(Z=>ee.error("Discipline streak update failed:",Z)),O===7||O===30||O===100)){const Z=new Date().toISOString().split("T")[0];N.from("companion_memories").insert({user_id:t?.id,companion_id:G,memory_type:"streak",memory_date:Z,memory_context:{title:`${O}-Day Streak`,description:`${O} days of dedication and growth together.`,emotion:O>=30?"joy":"pride",details:{streakDays:O}},referenced_count:0}).then(({error:he})=>{he&&ee.error("Failed to create streak memory:",he)})}}catch(le){ee.error("Error awarding streak milestone:",le)}},awardReflectionComplete:async()=>{if(!(!s||a.isPending))try{const O=f(Lt.CHECK_IN);r(O,"Reflection Saved!"),a.mutate({eventType:"reflection",xpAmount:O});const le=s.id;le&&u(le).catch(G=>ee.error("Alignment update failed:",G))}catch(O){ee.error("Error awarding reflection:",O)}},awardQuoteShared:()=>{if(!s)return;const O=f(Lt.PEP_TALK_LISTEN);r(O,"Quote Shared!"),a.mutate({eventType:"quote_shared",xpAmount:O})},awardCustomXP:async(O,le,G,Z)=>{if(!s){ee.warn("Cannot award XP: companion not loaded yet");return}if(a.isPending){ee.warn("Cannot award XP: previous award still in progress");return}G&&O>0&&r(O,G);try{await a.mutateAsync({eventType:le,xpAmount:O,metadata:Z})}catch(he){ee.error("Error awarding custom XP:",he)}},awardFocusSessionComplete:(O=!1,le=!0)=>{if(!s||a.isPending)return;let G,Z;le?(G=Ft.SESSION_COMPLETE,Z="Focus Session Complete!",O&&(G+=Ft.PERFECT_FOCUS_BONUS,Z="Perfect Focus! ðŸŽ¯")):(G=Ft.CAPPED_SESSION_XP,Z=O?"Bonus Focus! ðŸŽ¯":"Bonus Focus Session!");const he=f(G);r(he,Z),a.mutate({eventType:"focus_session",xpAmount:he,metadata:{isPerfect:O,isUnderCap:le}})},awardSubtaskComplete:()=>{if(!s)return;const O=qr.SUBTASK_COMPLETE;r(O,"Subtask Done!"),a.mutate({eventType:"subtask_complete",xpAmount:O})},awardAllSubtasksComplete:()=>{if(!s)return;const O=f(qr.ALL_SUBTASKS_BONUS);r(O,"All Subtasks Complete! ðŸŽ‰"),a.mutate({eventType:"all_subtasks_complete",xpAmount:O})},awardTopThreeComplete:()=>{if(!s)return;const O=f(Aa.TOP_THREE_COMPLETE);r(O,"Top 3 Task Done! ðŸŽ¯"),a.mutate({eventType:"top_three_complete",xpAmount:O})},awardAllTopThreeComplete:()=>{if(!s)return;const O=f(Aa.ALL_TOP_THREE_BONUS);r(O,"All Top 3 Complete! ðŸ†"),a.mutate({eventType:"all_top_three_complete",xpAmount:O})},awardUrgentTaskComplete:()=>{if(!s)return;const O=f(Aa.URGENT_IMPORTANT);r(O,"Urgent Task Done!"),a.mutate({eventType:"urgent_task_complete",xpAmount:O})},awardInboxProcessed:()=>{if(!s)return;const O=Ra.PROCESS_INBOX;a.mutate({eventType:"inbox_processed",xpAmount:O})},awardInboxZero:()=>{if(!s)return;const O=f(Ra.INBOX_ZERO);r(O,"Inbox Zero! ðŸ“­"),a.mutate({eventType:"inbox_zero",xpAmount:O})},awardVoiceCapture:()=>{if(!s)return;const O=Ra.VOICE_CAPTURE;a.mutate({eventType:"voice_capture",xpAmount:O})},awardWeeklyReview:()=>{if(!s)return;const O=f(ta.WEEKLY_REVIEW);r(O,"Weekly Review Complete! ðŸ“Š"),a.mutate({eventType:"weekly_review",xpAmount:O})},awardDailyReview:()=>{if(!s)return;const O=f(ta.DAILY_REVIEW);r(O,"Daily Review Done!"),a.mutate({eventType:"daily_review",xpAmount:O})},awardHighProductivityDay:()=>{if(!s)return;const O=f(ta.HIGH_PRODUCTIVITY_DAY);r(O,"Productive Day! ðŸ“ˆ"),a.mutate({eventType:"high_productivity_day",xpAmount:O})},awardPerfectDay:()=>{if(!s)return;const O=f(ta.PERFECT_DAY);r(O,"Perfect Day! â­"),a.mutate({eventType:"perfect_day",xpAmount:O})},awardOnTimeCompletion:()=>{if(!s)return;const O=Lr.ON_TIME_COMPLETION;a.mutate({eventType:"on_time_completion",xpAmount:O})},awardContextMatch:()=>{if(!s)return;const O=Lr.CONTEXT_MATCH;a.mutate({eventType:"context_match",xpAmount:O})},awardMilestoneComplete:(O=!1)=>{if(!s||a.isPending)return;const le=O?xs.POSTCARD:xs.REGULAR,G=f(le);r(G,O?"Celebration Milestone!":"Milestone Complete!"),a.mutate({eventType:O?"postcard_milestone":"milestone_complete",xpAmount:G})},awardPhaseComplete:O=>{if(!s||a.isPending)return;const le=f(xs.PHASE_COMPLETE);r(le,`Phase Complete: ${O}!`),a.mutate({eventType:"phase_complete",xpAmount:le,metadata:{phaseName:O}})},awardEpicComplete:O=>{if(!s||a.isPending)return;const le=f(xs.EPIC_COMPLETE);r(le,"Epic Complete! ðŸ†"),a.mutate({eventType:"epic_complete",xpAmount:le,metadata:{epicTitle:O}});const G=s.id;if(G&&t?.id){const Z=new Date().toISOString().split("T")[0];N.from("companion_memories").insert({user_id:t.id,companion_id:G,memory_type:"epic_complete",memory_date:Z,memory_context:{title:"Epic Complete",description:`We conquered "${O}" together!`,emotion:"pride",details:{epicTitle:O}},referenced_count:0}).then(({error:he})=>{he&&ee.error("Failed to create epic memory:",he)})}},awardCheckIn:j,awardChallengeComplete:v,awardWeeklyChallenge:b,awardPepTalkListen:x,XP_REWARDS:Lt,FOCUS_XP_REWARDS:Ft,SUBTASK_XP_REWARDS:qr,PRIORITY_XP_REWARDS:Aa,INBOX_XP_REWARDS:Ra,PRODUCTIVITY_XP_REWARDS:ta,SCHEDULING_XP_REWARDS:Lr,MILESTONE_XP_REWARDS:xs}},Zf=()=>{const{user:t}=ce(),{companion:s}=st(),{awardCustomXP:a}=bt(),{checkAdversaryDefeatAchievements:r}=pr(),i=Se(),{triggerResistVictory:o}=Na(),c=n.useCallback((k,P)=>{if(k)throw new Error(`${P}: ${k.message}`)},[]),l=n.useCallback(k=>{if(!k||typeof k!="object")return!1;const P=k,A=P.code??"",L=P.message??"";return A==="23505"||L.includes("idx_astral_encounters_one_active_per_user")},[]),[u,m]=n.useState(null),[p,h]=n.useState(!1),[f,d]=n.useState(!1),g=n.useRef(!1),{data:y,isLoading:v}=ye({queryKey:["astral-encounters",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:k,error:P}=await N.from("astral_encounters").select("*").eq("user_id",t.id).order("created_at",{ascending:!1}).limit(50);if(P)throw P;return k},enabled:!!t?.id}),{data:b,isLoading:x}=ye({queryKey:["adversary-essences",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:k,error:P}=await N.from("adversary_essences").select("*").eq("user_id",t.id).order("absorbed_at",{ascending:!1});if(P)throw P;return k},enabled:!!t?.id}),{data:j,isLoading:w}=ye({queryKey:["cosmic-codex",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:k,error:P}=await N.from("cosmic_codex_entries").select("*").eq("user_id",t.id).order("times_defeated",{ascending:!1});if(P)throw P;return k},enabled:!!t?.id}),D=b?.reduce((k,P)=>{const A=P.stat_type;return k[A]=(k[A]||0)+P.stat_boost,k},{mind:0,body:0,soul:0})||{mind:0,body:0,soul:0},S=ie({mutationFn:async k=>{if(!t?.id||!s?.id)throw new Error("User or companion not found");const P=Ef(k.triggerType,k.epicProgress,k.epicCategory),{data:A,error:L}=await N.from("astral_encounters").insert({user_id:t.id,companion_id:s.id,adversary_name:P.name,adversary_theme:P.theme,adversary_tier:P.tier,adversary_lore:P.lore,mini_game_type:P.miniGameType,trigger_type:k.triggerType,trigger_source_id:k.triggerSourceId||null,total_phases:P.phases}).select().single();if(L)throw L;return{encounter:A,adversary:P,questInterval:k.questInterval}},onSuccess:({encounter:k,adversary:P,questInterval:A})=>{m({encounter:k,adversary:P,questInterval:A}),h(!1),i.invalidateQueries({queryKey:["astral-encounters"]})},onError:k=>{console.error("Failed to start encounter:",k),l(k)||X.error("Failed to start encounter")}}),M=ie({mutationFn:async k=>{if(!t?.id||!s?.id||!u)throw new Error("Missing required data");const P=ec(k.accuracy),A=Zl(u.adversary.tier,k.accuracy),{error:L}=await N.from("astral_encounters").update({result:P,accuracy_score:k.accuracy,xp_earned:A,essence_earned:P!=="fail"?u.adversary.essenceName:null,stat_boost_type:P!=="fail"?u.adversary.statType:null,stat_boost_amount:P!=="fail"?u.adversary.statBoost:0,phases_completed:k.phasesCompleted,completed_at:new Date().toISOString(),retry_available_at:P==="fail"?new Date(Date.now()+14400*1e3).toISOString():null}).eq("id",k.encounterId);if(L)throw L;if(P!=="fail"){const{error:H}=await N.from("adversary_essences").insert({user_id:t.id,companion_id:s.id,encounter_id:k.encounterId,essence_name:u.adversary.essenceName,essence_description:u.adversary.essenceDescription,stat_type:u.adversary.statType,stat_boost:u.adversary.statBoost,adversary_name:u.adversary.name,adversary_theme:u.adversary.theme,rarity:u.adversary.tier});c(H,"Failed to insert adversary essence");const{data:I,error:te}=await N.from("cosmic_codex_entries").select("id, times_defeated").eq("user_id",t.id).eq("adversary_theme",u.adversary.theme).maybeSingle();c(te,"Failed to query cosmic codex entry");let V=1;if(I){V=I.times_defeated+1;const{error:he}=await N.from("cosmic_codex_entries").update({times_defeated:V,last_defeated_at:new Date().toISOString()}).eq("id",I.id);c(he,"Failed to update cosmic codex entry")}else{const{error:he}=await N.from("cosmic_codex_entries").insert({user_id:t.id,adversary_theme:u.adversary.theme,adversary_name:u.adversary.name,adversary_lore:u.adversary.lore});c(he,"Failed to insert cosmic codex entry")}const z=u.adversary.theme,{shouldRollLoot:W,lootTier:Q}=await r(z,V);if(W&&Q){const he=Q==="legendary"?["rare","epic","legendary"]:Q==="epic"?["rare","epic"]:["rare"],{data:ve,error:we}=await N.from("epic_rewards").select("*").eq("adversary_theme",z).in("rarity",he);if(c(we,"Failed to fetch theme loot"),ve&&ve.length>0){const je=ve.reduce((ge,Te)=>ge+(Te.drop_weight||100),0);let ke=Math.random()*je,Ae=ve[0];for(const ge of ve)if(ke-=ge.drop_weight||100,ke<=0){Ae=ge;break}const{data:Re,error:Ge}=await N.from("user_epic_rewards").select("id").eq("user_id",t.id).eq("reward_id",Ae.id).maybeSingle();if(c(Ge,"Failed to check existing epic reward"),!Re){const{error:ge}=await N.from("user_epic_rewards").insert({user_id:t.id,reward_id:Ae.id});c(ge,"Failed to award epic reward"),X.success(`ðŸŽ New Loot: ${Ae.name}!`,{description:Ae.description})}}}const U={mind:"wisdom",body:"vitality",soul:"resolve"},$=u.adversary.statType,J=U[$];if(!J)return console.error("Invalid stat type:",$),{result:P,xpEarned:A};const le={vitality:s?.vitality??300,wisdom:s?.wisdom??300,discipline:s?.discipline??300,resolve:s?.resolve??300,creativity:s?.creativity??300,alignment:s?.alignment??300}[J],G=Math.min(1e3,le+u.adversary.statBoost*3),{error:Z}=await N.from("user_companion").update({[J]:G}).eq("id",s.id);c(Z,"Failed to update companion stats"),A>0&&await a(A,"astral_encounter",`Defeated ${u.adversary.name}`)}if(u.encounter.trigger_type==="urge_resist"){const H=u.encounter.trigger_source_id;if(H){const{data:I,error:te}=await N.from("user_bad_habits").select("*").eq("id",H).maybeSingle();if(c(te,"Failed to fetch bad habit"),I){const V=P!=="fail",z=V?.05:0,{error:W}=await N.from("resist_log").insert({user_id:t.id,habit_id:H,encounter_id:k.encounterId,result:P,xp_earned:A,care_boost:z});c(W,"Failed to write resist log");const Q=new Date,U=I.last_resisted_at?new Date(I.last_resisted_at):null,$=U?.toDateString()===Q.toDateString(),J=U?.toDateString()===new Date(Date.now()-864e5).toDateString();let O=I.current_streak;V?O=J?I.current_streak+1:$?I.current_streak:1:O=0;const{error:le}=await N.from("user_bad_habits").update({times_resisted:I.times_resisted+(V?1:0),current_streak:O,longest_streak:Math.max(I.longest_streak,O),last_resisted_at:Q.toISOString()}).eq("id",H);if(c(le,"Failed to update bad habit stats"),V&&s){const G=s.care_recovery??0,{error:Z}=await N.from("user_companion").update({care_recovery:Math.min(1,G+z)}).eq("id",s.id);c(Z,"Failed to update companion care recovery")}V&&X.success("You resisted! Your companion grows stronger.",{description:`+${A} XP â€¢ Streak: ${O}`})}}}return{result:P,xpEarned:A}},onSuccess:({result:k,xpEarned:P})=>{i.invalidateQueries({queryKey:["astral-encounters"]}),i.invalidateQueries({queryKey:["adversary-essences"]}),i.invalidateQueries({queryKey:["cosmic-codex"]}),i.invalidateQueries({queryKey:["companion"]}),i.invalidateQueries({queryKey:["bad-habits"]}),i.invalidateQueries({queryKey:["resist-log"]}),k!=="fail"&&u?.encounter.trigger_type!=="urge_resist"&&X.success(`Victory! +${P} XP`),k!=="fail"&&u?.encounter.trigger_type==="urge_resist"&&o().catch(A=>console.log("[LivingCompanion] Resist trigger failed:",A))},onError:k=>{console.error("Failed to complete encounter:",k),X.error("Failed to complete encounter")}}),C=n.useCallback(k=>{const P=k.adversary_theme,A=k.adversary_tier;return{name:k.adversary_name,theme:P,tier:A,lore:k.adversary_lore||"",miniGameType:k.mini_game_type,phases:k.total_phases||1,essenceName:`Essence of ${k.adversary_name}`,essenceDescription:`Power absorbed from defeating ${k.adversary_name}`,statType:Jl[P]||"mind",statBoost:jn[A]?.statBoost||1}},[]),R=n.useCallback(async(k,P,A,L,H)=>{if(!t?.id)return{ok:!1,started:!1,resumed:!1,reason:"not_authenticated"};if(!s?.id)return console.warn("Encounter trigger skipped: companion not ready"),{ok:!1,started:!1,resumed:!1,reason:"companion_not_ready"};if(g.current)return{ok:!1,started:!1,resumed:!1,reason:"trigger_in_progress"};g.current=!0,d(!0);try{const{data:I,error:te}=await N.from("astral_encounters").select("*").eq("user_id",t.id).is("completed_at",null).order("created_at",{ascending:!1}).limit(20);if(te)return console.error("Failed to lookup pending encounters:",te),{ok:!1,started:!1,resumed:!1,reason:"pending_lookup_failed"};const V=I??[],z=V[0]??null,W=V.slice(1).map(Q=>Q.id);if(W.length>0){const{error:Q}=await N.from("astral_encounters").update({completed_at:new Date().toISOString()}).in("id",W).is("completed_at",null);Q&&console.error("Failed to close stale pending encounters:",Q)}if(z){const Q=C(z);return m({encounter:z,adversary:Q,questInterval:H??3}),h(!1),{ok:!0,started:!1,resumed:!0}}return await S.mutateAsync({triggerType:k,triggerSourceId:P,epicProgress:A,epicCategory:L,questInterval:H}),{ok:!0,started:!0,resumed:!1}}catch(I){if(l(I)){const{data:te,error:V}=await N.from("astral_encounters").select("*").eq("user_id",t.id).is("completed_at",null).order("created_at",{ascending:!1}).limit(1);if(V)return console.error("Failed to recover pending encounter after duplicate create:",V),{ok:!1,started:!1,resumed:!1,reason:"pending_lookup_failed"};const z=te?.[0];if(z){const W=C(z);return m({encounter:z,adversary:W,questInterval:H??3}),h(!1),{ok:!0,started:!1,resumed:!0}}}return console.error("Failed to trigger encounter:",I),{ok:!1,started:!1,resumed:!1,reason:"start_failed"}}finally{g.current=!1,d(!1)}},[t?.id,s?.id,C,l,S]),T=n.useCallback(()=>{h(!1),m(null)},[]),q=n.useCallback(async()=>{if(!u)return!1;try{const{error:k}=await N.from("astral_encounters").delete().eq("id",u.encounter.id);return c(k,"Failed to delete encounter"),m(null),h(!1),i.invalidateQueries({queryKey:["astral-encounters"]}),!0}catch(k){return console.error("Failed to pass encounter:",k),X.error("Failed to pass encounter"),!1}},[u,i,c]);return{activeEncounter:u,showEncounterModal:p,encounters:y,essences:b,codexEntries:j,totalStatBoosts:D,isLoading:v||x||w,isStarting:S.isPending,isTriggeringEncounter:f,isCompleting:M.isPending,startEncounter:S.mutate,startEncounterAsync:S.mutateAsync,completeEncounter:M.mutate,completeEncounterAsync:M.mutateAsync,checkEncounterTrigger:R,closeEncounter:T,passEncounter:q,setShowEncounterModal:h}},ic=n.createContext(null),eg=({children:t})=>{const s=Zf();return e.jsx(ic.Provider,{value:s,children:t})},oc=()=>{const t=n.useContext(ic);if(!t)throw new Error("useAstralEncounterContext must be used within AstralEncounterContextProvider");return t},lc="encounter_passes",hi=3,fi=()=>new Date().toISOString().split("T")[0],tg=()=>{const t=qe.getItem(lc);if(!t)return null;try{return JSON.parse(t)}catch{return null}},gi=t=>{qe.setItem(lc,JSON.stringify(t))},sg=()=>{const[t,s]=n.useState(0);n.useEffect(()=>{const i=fi(),o=tg();o&&o.date===i?s(o.count):(gi({date:i,count:0}),s(0))},[]);const a=n.useCallback(()=>{const i=fi(),o=t+1;return gi({date:i,count:o}),s(o),o},[t]),r=t>=hi;return{passCount:t,recordPass:a,shouldPromptDisable:r,promptThreshold:hi}},ag=({open:t,onDisable:s,onKeepOn:a,passCount:r})=>e.jsx(_a,{open:t,onOpenChange:i=>!i&&a(),children:e.jsxs(Ws,{className:"sm:max-w-md",children:[e.jsxs(Qs,{children:[e.jsx("div",{className:"flex items-center justify-center mb-2",children:e.jsx("div",{className:"p-3 rounded-full bg-primary/10",children:e.jsx(ma,{className:"w-8 h-8 text-primary"})})}),e.jsx(Gs,{className:"text-center",children:"Taking a Break from Encounters?"}),e.jsxs(Ys,{className:"text-center",children:["You've passed on ",r," encounters today. Would you like to disable Astral Encounters? You can re-enable them anytime in your Profile settings."]})]}),e.jsxs(Ks,{className:"flex-col gap-2 sm:flex-col",children:[e.jsxs(ws,{onClick:s,className:"w-full",children:[e.jsx(ma,{className:"w-4 h-4 mr-2"}),"Disable Encounters"]}),e.jsxs(Vs,{onClick:a,className:"w-full mt-0",children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"Keep Them On"]})]})]})}),rg=({children:t})=>{const[s,a]=n.useState(!1),[r,i]=n.useState("common"),[o,c]=n.useState(!1),l=n.useRef(null),{user:u}=ce(),{passCount:m,recordPass:p}=sg(),{activeEncounter:h,showEncounterModal:f,setShowEncounterModal:d,completeEncounterAsync:g,closeEncounter:y,passEncounter:v}=oc();n.useEffect(()=>{const M=h?.encounter.id??null;if(!M){l.current=null,a(!1);return}l.current!==M&&(l.current=M,i(h?.adversary.tier||"common"),d(!1),a(!0))},[h?.encounter.id,h?.adversary.tier,d]);const b=n.useCallback(()=>{a(!1),d(!0)},[d]),x=n.useCallback(M=>{if(!M){y();return}d(!0)},[y,d]),j=n.useCallback(async M=>{try{return await g(M),!0}catch{return!1}},[g]),w=n.useCallback(async()=>{if(!await v())return;p()>=3&&c(!0)},[p,v]),D=n.useCallback(async()=>{if(u?.id)try{const{error:M}=await N.from("profiles").update({astral_encounters_enabled:!1}).eq("id",u.id);if(M)throw M;c(!1),X.success("Astral Encounters disabled. Re-enable in Profile settings.")}catch(M){console.error("Failed to disable encounters:",M),X.error("Failed to disable encounters")}},[u?.id]),S=n.useCallback(()=>{c(!1)},[]);return e.jsxs(e.Fragment,{children:[t,e.jsx(Hf,{isVisible:s,tier:r,onComplete:b}),e.jsx($f,{open:f,onOpenChange:x,encounter:h?.encounter||null,adversary:h?.adversary||null,questInterval:h?.questInterval,onComplete:j,onPass:w}),e.jsx(ag,{open:o,onDisable:D,onKeepOn:S,passCount:m})]})},ng=({children:t})=>e.jsx(eg,{children:e.jsx(rg,{children:t})}),Ms=n.memo(({icon:t,label:s,value:a,maxValue:r,color:i,animate:o=!1,compact:c=!1})=>e.jsxs(_.div,{className:`flex items-center gap-1.5 rounded-xl stat-pill ${c?"px-2 py-1":"px-3 py-1.5"}`,animate:o?{scale:[1,1.08,1]}:{},transition:{duration:.25},children:[e.jsx("div",{className:c?"p-1 rounded-md":"p-1.5 rounded-lg",style:{backgroundColor:`${i}20`},children:t}),e.jsxs("div",{className:"flex flex-col",children:[!c&&e.jsx("span",{className:"text-[10px] uppercase tracking-wider text-white/50 font-medium",children:s}),e.jsxs("span",{className:`font-bold ${c?"text-xs":"text-sm"}`,style:{color:i},children:[a,r!==void 0&&e.jsxs("span",{className:"text-white/40 font-normal",children:["/",r]})]})]})]}));Ms.displayName="StatBadge";const ig=n.memo(({score:t,maxScore:s,timeLeft:a,totalTime:r,combo:i=0,showCombo:o=!1,phase:c,totalPhases:l,isPaused:u,onPauseToggle:m,title:p,subtitle:h,primaryStat:f,secondaryStat:d,compact:g=!1})=>{const[y,v]=n.useState(t),[b,x]=n.useState(!1);n.useEffect(()=>{t!==y&&t!==void 0&&t>(y||0)&&(x(!0),setTimeout(()=>x(!1),250)),v(t)},[t,y]);const j=r&&a!==void 0?a/r*100:100,w=a!==void 0&&a<=3;return e.jsxs("div",{className:`w-full ${g?"px-2 py-1 mb-1":"px-3 py-2 mb-2"}`,children:[!g&&e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-base font-bold text-white tracking-tight",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"},children:p}),h&&e.jsx("p",{className:"text-[10px] text-white/60 font-medium tracking-wide",children:h})]}),m&&e.jsx(_.button,{onClick:m,className:"p-2.5 rounded-full transition-all",style:{background:"linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%)",border:"1px solid rgba(255,255,255,0.12)",boxShadow:"0 4px 15px rgba(0,0,0,0.2), inset 0 1px 0 rgba(255,255,255,0.08)"},whileHover:{scale:1.05},whileTap:{scale:.92},children:u?e.jsx(Vt,{className:"w-4 h-4 text-white"}):e.jsx(Rs,{className:"w-4 h-4 text-white"})})]}),e.jsxs("div",{className:`flex items-center justify-between gap-1.5 overflow-x-auto scrollbar-hide ${g?"mb-1":"mb-2"}`,children:[t!==void 0&&e.jsx(Ms,{icon:e.jsx(et,{className:`${g?"w-3 h-3":"w-3.5 h-3.5"} text-purple-400`}),label:"Score",value:t,maxValue:s,color:"#a855f7",animate:b,compact:g}),e.jsx(be,{children:o&&i>1&&e.jsx(_.div,{initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},exit:{scale:0,opacity:0},children:e.jsx(Ms,{icon:e.jsx(Be,{className:`${g?"w-3 h-3":"w-3.5 h-3.5"} text-yellow-400`}),label:"Combo",value:`Ã—${i}`,color:"#fbbf24",animate:!0,compact:g})})}),f&&e.jsx(Ms,{icon:e.jsx("div",{className:`${g?"w-2 h-2":"w-2.5 h-2.5"} rounded-full`,style:{backgroundColor:f.color}}),label:f.label,value:f.value,color:f.color,compact:g}),d&&e.jsx(Ms,{icon:e.jsx("div",{className:`${g?"w-2 h-2":"w-2.5 h-2.5"} rounded-full`,style:{backgroundColor:d.color}}),label:d.label,value:d.value,color:d.color,compact:g}),a!==void 0&&e.jsx(_.div,{animate:w?{scale:[1,1.05,1]}:{},transition:{duration:.4,repeat:w?1/0:0},children:e.jsx(Ms,{icon:e.jsx(ir,{className:`${g?"w-3 h-3":"w-3.5 h-3.5"} ${w?"text-red-400":"text-white/60"}`}),label:"Time",value:`${a}s`,color:w?"#ef4444":"#94a3b8",compact:g})}),g&&m&&e.jsx(_.button,{onClick:m,className:"p-1.5 rounded-full transition-all flex-shrink-0",style:{background:"linear-gradient(135deg, rgba(255,255,255,0.08) 0%, rgba(255,255,255,0.02) 100%)",border:"1px solid rgba(255,255,255,0.12)"},whileHover:{scale:1.05},whileTap:{scale:.92},children:u?e.jsx(Vt,{className:"w-3 h-3 text-white"}):e.jsx(Rs,{className:"w-3 h-3 text-white"})})]}),r!==void 0&&a!==void 0&&e.jsx("div",{className:`${g?"h-1.5":"h-2.5"} rounded-full overflow-hidden`,style:{background:"linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.06))",border:"1px solid rgba(255,255,255,0.08)",boxShadow:"inset 0 2px 4px rgba(0,0,0,0.4)"},children:e.jsx(_.div,{className:"h-full rounded-full",style:{background:w?"linear-gradient(90deg, #ef4444, #f97316, #ef4444)":"linear-gradient(90deg, hsl(var(--primary)), hsl(var(--accent)), hsl(var(--primary)))",backgroundSize:"200% 100%",boxShadow:w?"0 0 20px rgba(239, 68, 68, 0.6), inset 0 1px 0 rgba(255,255,255,0.3)":"0 0 20px hsl(var(--primary) / 0.5), inset 0 1px 0 rgba(255,255,255,0.3)"},animate:{width:`${j}%`,backgroundPosition:["0% center","200% center"]},transition:{width:{duration:.3},backgroundPosition:{duration:2.5,repeat:1/0,ease:"linear"}}})}),!g&&c!==void 0&&l!==void 0&&l>1&&e.jsx("div",{className:"flex justify-center gap-1.5 mt-3",children:Array.from({length:l}).map((D,S)=>e.jsx(_.div,{className:`rounded-full transition-all duration-300 ${S<c?"bg-green-400 w-3 h-2":S===c?"bg-gradient-to-r from-primary to-accent w-5 h-2":"bg-white/10 w-2 h-2"}`,style:{boxShadow:S===c?"0 0 10px hsl(var(--primary))":"none"},animate:S===c?{opacity:[1,.7,1]}:{},transition:{duration:1,repeat:1/0}},S))}),e.jsx("style",{children:`
        .stat-pill {
          background: linear-gradient(135deg, rgba(255, 255, 255, 0.06) 0%, rgba(255, 255, 255, 0.02) 100%);
          border: 1px solid rgba(255, 255, 255, 0.1);
          backdrop-filter: blur(12px);
          -webkit-backdrop-filter: blur(12px);
          box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2), inset 0 1px 0 rgba(255, 255, 255, 0.08);
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
      `})]})});ig.displayName="GameHUD";const og=n.memo(({count:t,onComplete:s})=>{const[a,r]=n.useState(t);return n.useEffect(()=>{if(a<=0){s();return}const i=setTimeout(()=>{r(o=>o-1)},1e3);return()=>clearTimeout(i)},[a,s]),e.jsx(be,{children:a>0&&e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 z-50 flex items-center justify-center",style:{background:"radial-gradient(circle at center, rgba(0,0,0,0.92) 0%, rgba(5,5,15,0.97) 100%)",backdropFilter:"blur(12px) saturate(120%)"},children:[e.jsxs(_.div,{initial:{scale:2.5,opacity:0,rotate:-15},animate:{scale:1,opacity:1,rotate:0},exit:{scale:.5,opacity:0,rotate:15},transition:{type:"spring",stiffness:350,damping:22},className:"relative",children:[[0,1,2].map(i=>e.jsx(_.div,{className:"absolute inset-0 rounded-full",style:{border:"2px solid",borderColor:`hsl(var(--primary) / ${.6-i*.2})`},initial:{scale:1,opacity:.8},animate:{scale:2+i*.5,opacity:0},transition:{duration:1,delay:i*.15}},i)),e.jsxs("div",{className:"w-36 h-36 rounded-full flex items-center justify-center relative",style:{background:"linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--accent)) 100%)",boxShadow:"0 0 60px hsl(var(--primary) / 0.6), 0 0 120px hsl(var(--primary) / 0.3), inset 0 2px 0 rgba(255,255,255,0.25), inset 0 -2px 0 rgba(0,0,0,0.15)"},children:[e.jsx("div",{className:"absolute inset-2 rounded-full bg-gradient-to-br from-white/25 to-transparent"}),e.jsx("span",{className:"text-7xl font-black text-white relative z-10",style:{textShadow:"0 4px 20px rgba(0,0,0,0.4), 0 0 40px rgba(255,255,255,0.2)"},children:a})]})]},a),e.jsx(_.p,{className:"absolute bottom-[30%] text-lg font-semibold text-white/70 tracking-wide",initial:{opacity:0,y:15},animate:{opacity:1,y:0},transition:{delay:.3},children:"Get Ready"})]})})});og.displayName="CountdownOverlay";const lg=n.memo(({value:t,x:s,y:a,type:r})=>{const o={perfect:{color:"#fbbf24",bg:"rgba(251, 191, 36, 0.15)",emoji:"âœ¨"},good:{color:"#22c55e",bg:"rgba(34, 197, 94, 0.15)",emoji:"ðŸ‘"},miss:{color:"#ef4444",bg:"rgba(239, 68, 68, 0.15)",emoji:"âŒ"},combo:{color:"#a855f7",bg:"rgba(168, 85, 247, 0.15)",emoji:"ðŸ”¥"}}[r];return e.jsxs(_.div,{className:"absolute pointer-events-none flex items-center gap-1.5 px-3 py-1.5 rounded-full font-bold text-base",style:{left:s,top:a,color:o.color,backgroundColor:o.bg,border:`1px solid ${o.color}40`,boxShadow:`0 4px 20px ${o.color}40`},initial:{opacity:1,y:0,scale:1},animate:{opacity:0,y:-50,scale:1.2},exit:{opacity:0},transition:{duration:.7,ease:"easeOut"},children:[e.jsx("span",{children:o.emoji}),e.jsx("span",{children:t>0?`+${t}`:t})]})});lg.displayName="ScorePopup";const cg=n.memo(({onResume:t})=>e.jsx(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"absolute inset-0 z-50 flex flex-col items-center justify-center",style:{background:"radial-gradient(circle at center, rgba(0,0,0,0.94) 0%, rgba(5,5,15,0.98) 100%)",backdropFilter:"blur(16px) saturate(120%)"},children:e.jsxs(_.div,{initial:{scale:.8,opacity:0,y:20},animate:{scale:1,opacity:1,y:0},transition:{type:"spring",stiffness:300,damping:25},className:"text-center",children:[e.jsx("div",{className:"w-24 h-24 rounded-full mx-auto mb-6 flex items-center justify-center",style:{background:"linear-gradient(135deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.03) 100%)",border:"1px solid rgba(255,255,255,0.15)",boxShadow:"0 12px 40px rgba(0,0,0,0.4), 0 0 60px hsl(var(--primary) / 0.1), inset 0 1px 0 rgba(255,255,255,0.1)"},children:e.jsx(Rs,{className:"w-12 h-12 text-white/85"})}),e.jsx("h3",{className:"text-2xl font-bold text-white mb-1.5 tracking-tight",style:{textShadow:"0 2px 10px rgba(0,0,0,0.5)"},children:"Paused"}),e.jsx("p",{className:"text-white/50 mb-8 text-sm font-medium",children:"Take your time"}),e.jsxs(_.button,{onClick:t,className:"px-8 py-3.5 rounded-full font-bold flex items-center gap-2.5 mx-auto text-white",style:{background:"linear-gradient(135deg, hsl(var(--primary)) 0%, hsl(var(--accent)) 100%)",boxShadow:"0 8px 30px hsl(var(--primary) / 0.5), 0 0 60px hsl(var(--primary) / 0.2), inset 0 1px 0 rgba(255,255,255,0.25)"},whileHover:{scale:1.03,y:-2},whileTap:{scale:.97},children:[e.jsx(Vt,{className:"w-5 h-5"}),"Resume"]})]})}));cg.displayName="PauseOverlay";const dg=n.memo(({type:t})=>{const a={perfect:{text:"PERFECT!",emoji:"ðŸŒŸ",color:"#fbbf24",gradient:"from-yellow-500/20 to-amber-500/10",border:"border-yellow-400/50",glow:"rgba(251, 191, 36, 0.4)"},good:{text:"GOOD!",emoji:"ðŸ‘",color:"#22c55e",gradient:"from-green-500/20 to-emerald-500/10",border:"border-green-400/50",glow:"rgba(34, 197, 94, 0.4)"},miss:{text:"MISS",emoji:"âŒ",color:"#ef4444",gradient:"from-red-500/20 to-orange-500/10",border:"border-red-400/50",glow:"rgba(239, 68, 68, 0.4)"}}[t];return e.jsx(_.div,{initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1},exit:{scale:1.2,opacity:0},transition:{type:"spring",stiffness:400,damping:25},className:`px-8 py-4 rounded-2xl bg-gradient-to-br ${a.gradient} border-2 ${a.border}`,style:{boxShadow:`0 0 40px ${a.glow}`},children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("span",{className:"text-3xl",children:a.emoji}),e.jsx("span",{className:"text-3xl font-black tracking-tight",style:{color:a.color,textShadow:`0 0 20px ${a.glow}`},children:a.text})]})})});dg.displayName="FeedbackOverlay";const cc=n.createContext(null),ug=({children:t})=>{const[s,a]=n.useState(!1),[r,i]=n.useState(null),o=n.useCallback(u=>{i(u),a(!0)},[]),c=n.useCallback(()=>{a(!1),i(null)},[]),l=n.useMemo(()=>({isModalOpen:s,selectedRecap:r,openRecap:o,closeRecap:c}),[s,r,o,c]);return e.jsx(cc.Provider,{value:l,children:t})},mg=()=>{const t=n.useContext(cc);if(!t)throw new Error("useWeeklyRecapContext must be used within a WeeklyRecapProvider");return t},dc=()=>{const{user:t}=ce(),s=Se(),{awardCustomXP:a}=bt(),{isModalOpen:r,selectedRecap:i,openRecap:o,closeRecap:c}=mg(),l=()=>{const b=new Date,x=b.getDay(),j=x===0?6:x-1,w=new Date(b);w.setDate(b.getDate()-j);const D=new Date(w);D.setDate(w.getDate()-7);const S=new Date(D);return S.setDate(D.getDate()+6),{start:Y(D,"yyyy-MM-dd"),end:Y(S,"yyyy-MM-dd")}},{start:u}=l(),m=new Date().getDay()===0,{data:p,isLoading:h}=ye({queryKey:["weekly-recap",t?.id,u],queryFn:async()=>{if(!t?.id)return null;const{data:b,error:x}=await N.from("weekly_recaps").select("*").eq("user_id",t.id).eq("week_start_date",u).maybeSingle();if(x)throw x;return b},enabled:!!t?.id}),{data:f}=ye({queryKey:["weekly-recaps-all",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:b,error:x}=await N.from("weekly_recaps").select("*").eq("user_id",t.id).order("week_start_date",{ascending:!1});if(x)throw x;return b},enabled:!!t?.id}),d=ie({mutationFn:async()=>{if(!t?.id)throw new Error("Not authenticated");const{data:b,error:x}=await N.functions.invoke("generate-weekly-recap",{body:{userId:t.id}});if(x)throw x;return b},onSuccess:()=>{s.invalidateQueries({queryKey:["weekly-recap"]}),s.invalidateQueries({queryKey:["weekly-recaps-all"]})}}),g=ie({mutationFn:async b=>{const{error:x}=await N.from("weekly_recaps").update({viewed_at:new Date().toISOString()}).eq("id",b);if(x)throw x},onSuccess:()=>{s.invalidateQueries({queryKey:["weekly-recap"]}),s.invalidateQueries({queryKey:["weekly-recaps-all"]})}});return n.useEffect(()=>{if(m&&p&&!p.viewed_at&&!h){const b=`recap-dismissed-${p.week_start_date}`;qe.getItem(b)||o(p)}},[m,p,h,o]),n.useEffect(()=>{(async()=>{if(!m||p||h||!t?.id||d.isPending)return;const{count:x}=await N.from("daily_check_ins").select("id",{count:"exact",head:!0}).eq("user_id",t.id);x&&x>0&&d.mutate()})()},[m,p,h,t?.id,d.isPending]),{isSunday:m,currentRecap:p,pastRecaps:f||[],isLoading:h,isModalOpen:r,selectedRecap:i,openRecap:b=>{o(b),b.viewed_at||(a(5,"weekly_recap_viewed","Weekly Recap"),g.mutate(b.id))},closeRecap:()=>{if(i){const b=`recap-dismissed-${i.week_start_date}`;qe.setItem(b,"true"),i.viewed_at||g.mutate(i.id)}c()},isGenerating:d.isPending,generateRecap:d.mutate}},sa={tough:{buttonText:t=>`${t}. Now.`,emptyState:t=>`No excuses. Start ${t}.`,encouragement:()=>"You're tougher than this. Prove it.",nudge:()=>"Stop waiting. Act."},direct:{buttonText:t=>t,emptyState:t=>`Time to ${t}.`,encouragement:()=>"Keep pushing forward.",nudge:()=>"Get it done."},empathetic:{buttonText:t=>`${t} when you're ready`,emptyState:t=>`Take your time with ${t}. I'm here.`,encouragement:()=>"You're doing great. Keep going.",nudge:()=>"Just checking in on you."},supportive:{buttonText:t=>`Let's ${t.toLowerCase()}`,emptyState:t=>`Ready to ${t}? I believe in you.`,encouragement:()=>"You've got this!",nudge:()=>"How are you feeling today?"},wise:{buttonText:t=>`${t} mindfully`,emptyState:t=>`Consider ${t} as your next step.`,encouragement:()=>"Every step forward is progress.",nudge:()=>"Reflect on your path."}},ka=()=>{const{profile:t}=yt(),s=Us(t),{data:a}=ye({queryKey:["mentor-personality",s],queryFn:async()=>{if(!s)return null;const{data:c,error:l}=await N.from("mentors").select("name, slug, tone_description, style, avatar_url, primary_color").eq("id",s).maybeSingle();if(l)throw l;return c},enabled:!!s});if(!a)return null;const i=a.tone_description?.toLowerCase()??"";let o=sa.supportive;return i.includes("tough")||i.includes("hard")?o=sa.tough:i.includes("direct")?o=sa.direct:i.includes("empathetic")?o=sa.empathetic:(i.includes("wise")||i.includes("calm"))&&(o=sa.wise),{name:a.name,slug:a.slug||"",tone:a.tone_description??"",style:a.style||"",avatar_url:a.avatar_url||void 0,primary_color:a.primary_color||"#000",buttonText:o.buttonText,emptyState:o.emptyState,encouragement:o.encouragement,nudge:o.nudge}},pg=async(t,s,a)=>{try{if(Ke.isNativePlatform()){const i=await(await fetch(t)).blob(),o=await fg(i),c=await Mo.writeFile({path:s,data:o,directory:Do.Cache});await Po.share({title:a?.title||"Companion Card",text:a?.text||"Check out my companion!",url:c.uri,dialogTitle:a?.dialogTitle||"Share Companion Card"}),X.success("Image ready to share!")}else{const r=document.createElement("a");r.href=t,r.download=s,r.click(),X.success("Image downloaded!")}}catch(r){console.error("Error downloading image:",r),X.error("Failed to save image")}},hg=async(t,s,a)=>{try{X.loading("Capturing card...");const r=await Eo(t,{quality:1,pixelRatio:2,backgroundColor:"transparent"});if(X.dismiss(),Ke.isNativePlatform()){const i=r.split(",")[1],o=await Mo.writeFile({path:s,data:i,directory:Do.Cache});await Po.share({title:a?.title||"Companion Card",text:a?.text||"Check out my companion!",url:o.uri,dialogTitle:a?.dialogTitle||"Share Companion Card"}),X.success("Card ready to share!")}else{const i=document.createElement("a");i.href=r,i.download=s,i.click(),X.success("Card downloaded!")}}catch(r){X.dismiss(),console.error("Error capturing card:",r),X.error("Failed to capture card")}},fg=t=>new Promise((s,a)=>{const r=new FileReader;r.onloadend=()=>{const o=r.result.split(",")[1];s(o)},r.onerror=a,r.readAsDataURL(t)}),gg=({trend:t})=>{const s={improving:{icon:zt,label:"Rising Week",className:"text-emerald-300 bg-emerald-500/20 border-emerald-400/30"},declining:{icon:ia,label:"Reflective Week",className:"text-amber-300 bg-amber-500/20 border-amber-400/30"},stable:{icon:Eu,label:"Steady Week",className:"text-sky-300 bg-sky-500/20 border-sky-400/30"}},{icon:a,label:r,className:i}=s[t]||s.stable;return e.jsxs(_.span,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:.3},className:`inline-flex items-center gap-1.5 px-3 py-1 rounded-full text-xs font-medium border backdrop-blur-sm ${i}`,children:[e.jsx(a,{className:"h-3 w-3"}),r]})},qa=({value:t,label:s,color:a})=>e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex flex-col items-center gap-0.5",children:[e.jsx("span",{className:`text-lg font-bold ${a}`,children:t}),e.jsx("span",{className:"text-[10px] text-muted-foreground/70 uppercase tracking-wider",children:s})]}),xg=()=>{const{isModalOpen:t,selectedRecap:s,closeRecap:a}=dc(),r=ka(),i=n.useRef(null),[o,c]=n.useState(!1);if(!s)return null;const l=At(s.week_start_date),u=At(s.week_end_date),m=`${Y(l,"MMMM d")} â€“ ${Y(u,"d, yyyy")}`,p=s.mentor_story||s.mentor_insight,h=p?.split(`

`).filter(y=>y.trim())||[],f=async()=>{if(i.current)try{const y=await Eo(i.current,{quality:.95,backgroundColor:"#0a0a0f"});await pg(y,`cosmiq-recap-${s.week_start_date}.png`)}catch(y){console.error("Failed to share recap:",y)}},d=()=>{if(!p)return;if(o){window.speechSynthesis.cancel(),c(!1);return}const y=new SpeechSynthesisUtterance(p);y.rate=.9,y.pitch=1,y.onend=()=>c(!1),y.onerror=()=>c(!1),window.speechSynthesis.speak(y),c(!0)},g=()=>{window.speechSynthesis.cancel(),c(!1),a()};return e.jsx(be,{children:t&&e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center p-4 pb-20",onClick:g,children:[e.jsx(_.div,{className:"absolute inset-0 bg-black/90 backdrop-blur-md",initial:{opacity:0},animate:{opacity:1}}),e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx(_.div,{className:"absolute top-1/4 left-1/4 w-96 h-96 bg-amber-500/10 rounded-full blur-3xl",animate:{scale:[1,1.2,1],opacity:[.3,.5,.3]},transition:{duration:8,repeat:1/0,ease:"easeInOut"}}),e.jsx(_.div,{className:"absolute bottom-1/4 right-1/4 w-96 h-96 bg-purple-500/10 rounded-full blur-3xl",animate:{scale:[1.2,1,1.2],opacity:[.3,.5,.3]},transition:{duration:8,repeat:1/0,ease:"easeInOut",delay:4}})]}),e.jsxs(_.div,{initial:{scale:.9,opacity:0,y:40},animate:{scale:1,opacity:1,y:0},exit:{scale:.9,opacity:0,y:40},transition:{type:"spring",damping:30,stiffness:300},onClick:y=>y.stopPropagation(),className:"relative w-full max-w-lg max-h-[75dvh] flex flex-col rounded-3xl overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-background/95 via-background/90 to-background/95 backdrop-blur-xl border border-white/10 rounded-3xl"}),e.jsx("div",{className:"absolute top-0 left-0 right-0 h-1 bg-gradient-to-r from-transparent via-amber-400/50 to-transparent"}),e.jsxs("div",{className:"relative flex items-center justify-between px-6 py-5",children:[e.jsxs(_.div,{className:"flex items-center gap-4",initial:{opacity:0,x:-20},animate:{opacity:1,x:0},transition:{delay:.1},children:[e.jsxs("div",{className:"relative",children:[e.jsx("div",{className:"h-12 w-12 rounded-2xl bg-gradient-to-br from-amber-400 via-orange-500 to-rose-500 flex items-center justify-center shadow-lg shadow-amber-500/20",children:e.jsx(pa,{className:"h-6 w-6 text-white"})}),e.jsx(_.div,{className:"absolute -top-1 -right-1 h-4 w-4 rounded-full bg-gradient-to-br from-amber-300 to-amber-500 flex items-center justify-center",animate:{scale:[1,1.2,1]},transition:{duration:2,repeat:1/0},children:e.jsx(se,{className:"h-2.5 w-2.5 text-white"})})]}),e.jsxs("div",{children:[e.jsxs("h2",{className:"font-semibold text-lg text-foreground",children:[r?.name||"Your Mentor"," Reflects"]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(mt,{className:"h-3.5 w-3.5"}),e.jsx("span",{children:m})]})]})]}),e.jsxs(_.div,{className:"flex items-center gap-1",initial:{opacity:0,x:20},animate:{opacity:1,x:0},transition:{delay:.2},children:[p&&e.jsx(B,{variant:"ghost",size:"icon",onClick:d,className:`rounded-xl transition-colors ${o?"text-amber-400 bg-amber-400/10":"hover:bg-white/5"}`,children:o?e.jsx(Su,{className:"h-4 w-4"}):e.jsx(Tu,{className:"h-4 w-4"})}),e.jsx(B,{variant:"ghost",size:"icon",onClick:f,className:"rounded-xl hover:bg-white/5",children:e.jsx(Ao,{className:"h-4 w-4"})}),e.jsx(B,{variant:"ghost",size:"icon",onClick:g,className:"rounded-xl hover:bg-white/5",children:e.jsx(Qe,{className:"h-4 w-4"})})]})]}),e.jsx(hr,{className:"relative flex-1 min-h-0",children:e.jsxs("div",{ref:i,className:"px-4 pb-6 space-y-6",children:[e.jsx("div",{className:"flex items-center justify-center pt-2",children:e.jsx(gg,{trend:s.mood_data.trend})}),h.length>0?e.jsx("div",{className:"space-y-5",children:h.map((y,v)=>e.jsx(_.p,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.4+v*.1,duration:.5},className:`text-[15px] leading-[1.8] text-foreground/90 ${v===0?"first-letter:text-3xl first-letter:font-serif first-letter:font-bold first-letter:text-amber-400 first-letter:mr-1 first-letter:float-left first-letter:leading-none":""}`,children:y},v))}):e.jsxs(_.div,{className:"text-center py-12",initial:{opacity:0},animate:{opacity:1},children:[e.jsx("div",{className:"inline-flex items-center justify-center w-16 h-16 rounded-2xl bg-muted/30 mb-4",children:e.jsx(pa,{className:"h-8 w-8 text-muted-foreground/50"})}),e.jsx("p",{className:"text-muted-foreground",children:"No story available for this week yet."})]}),e.jsxs(_.div,{className:"flex items-center justify-center gap-3 py-4",initial:{opacity:0,scaleX:0},animate:{opacity:1,scaleX:1},transition:{delay:.8},children:[e.jsx("div",{className:"h-px flex-1 bg-gradient-to-r from-transparent via-border to-transparent"}),e.jsx(se,{className:"h-3 w-3 text-amber-400/50"}),e.jsx("div",{className:"h-px flex-1 bg-gradient-to-r from-transparent via-border to-transparent"})]}),e.jsxs(_.div,{className:"flex items-center justify-around py-4 px-2 rounded-2xl bg-white/[0.02] border border-white/5",initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.9},children:[e.jsx(qa,{value:s.stats.checkIns,label:"Check-ins",color:"text-sky-400"}),e.jsx("div",{className:"w-px h-8 bg-border/30"}),e.jsx(qa,{value:s.stats.reflections,label:"Reflections",color:"text-violet-400"}),e.jsx("div",{className:"w-px h-8 bg-border/30"}),e.jsx(qa,{value:s.stats.quests,label:"Quests",color:"text-emerald-400"}),e.jsx("div",{className:"w-px h-8 bg-border/30"}),e.jsx(qa,{value:s.stats.habits,label:"Habits",color:"text-amber-400"})]}),e.jsx(_.div,{className:"text-center pt-2 pb-4",initial:{opacity:0},animate:{opacity:1},transition:{delay:1},children:e.jsx("p",{className:"text-[10px] text-muted-foreground/40 tracking-widest uppercase",children:"Cosmiq Weekly Journal"})})]})}),e.jsx("div",{className:"relative px-6 py-5 pb-6 border-t border-white/5",children:e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5},children:e.jsx(B,{onClick:g,className:"w-full h-12 rounded-xl bg-gradient-to-r from-amber-500 via-orange-500 to-rose-500 hover:from-amber-400 hover:via-orange-400 hover:to-rose-400 text-white font-medium shadow-lg shadow-orange-500/20 transition-all duration-300 hover:shadow-orange-500/30 hover:scale-[1.02]",children:"Continue Your Journey"})})})]})]})})},yg=()=>{const t=Se();n.useEffect(()=>{const{data:{subscription:s}}=N.auth.onAuthStateChange(a=>{(a==="SIGNED_IN"||a==="TOKEN_REFRESHED")&&setTimeout(async()=>{try{await t.refetchQueries({queryKey:["profile"]}),await Promise.all([t.invalidateQueries({queryKey:["mentor-page-data"]}),t.invalidateQueries({queryKey:["mentor-personality"]}),t.invalidateQueries({queryKey:["mentor"]}),t.invalidateQueries({queryKey:["selected-mentor"]})])}catch(r){console.error("Auth sync refresh failed:",r)}},0),a==="SIGNED_OUT"&&t.clear()});return()=>s.unsubscribe()},[t])},xi=1e4,bg=()=>{const t=Se(),s=n.useRef(0),a=n.useCallback(async r=>{ee.debug(`${r} - refreshing critical data`),await t.refetchQueries({queryKey:["profile"]}),await Promise.all([t.invalidateQueries({queryKey:["mentor-page-data"]}),t.invalidateQueries({queryKey:["mentor-personality"]}),t.invalidateQueries({queryKey:["mentor"]}),t.invalidateQueries({queryKey:["selected-mentor"]})]),await Promise.all([t.invalidateQueries({queryKey:["habits"]}),t.invalidateQueries({queryKey:["habit-surfacing"]}),t.invalidateQueries({queryKey:["epics"]}),t.invalidateQueries({queryKey:["epic-progress"]})])},[t]);n.useEffect(()=>{if(!Ke.isNativePlatform())return;let r=!1,i=null;const o=async({isActive:l})=>{if(!l)return;const u=Date.now();if(u-s.current<xi){ee.debug("App resume refresh skipped (cooldown)");return}s.current=u;try{await a("App resumed")}catch(p){ee.warn("App resume refresh failed",{error:p instanceof Error?p.message:String(p)})}};return(async()=>{const l=await Ka.addListener("appStateChange",o);if(r){await l.remove();return}i=l})(),()=>{r=!0,i&&i.remove()}},[a]),n.useEffect(()=>{if(Ke.isNativePlatform())return;const r=async()=>{if(document.visibilityState!=="visible")return;const i=Date.now();if(!(i-s.current<xi)){s.current=i;try{await a("Tab became visible")}catch(c){ee.warn("Visibility refresh failed",{error:c instanceof Error?c.message:String(c)})}}};return document.addEventListener("visibilitychange",r),()=>document.removeEventListener("visibilitychange",r)},[a])},is=[{id:"create_quest",taskText:"Create Your First Quest ðŸŽ¯",title:"Create your first quest",description:"Schedule one quest with a time so it appears in Quests.",checklist:["Stay on the QUESTS tab.","Tap + in the lower-right corner.","Set a time, enter a title, then tap Create Quest."],successHint:"If time is missing, it becomes an Inbox item.",actionLabel:"Go to Quests",route:"/journeys",navSelector:'[data-tour="quests-tab"]',inRouteSelector:'[data-tour="add-quest-fab"]',completion:{type:"event",eventName:"task-added",requireRoute:!0}},{id:"meet_companion",taskText:"Meet Your Companion âœ¨",title:"Meet your companion",description:"Find your companion and confirm your bond/progress panel is visible.",checklist:["Tap COMPANION in the bottom navigation bar.","Wait for the companion page to fully load.","Look at the progress area to confirm you're in the right place."],successHint:"This step auto-completes once the Companion page opens.",actionLabel:"Go to Companion",route:"/companion",navSelector:'[data-tour="companion-tab"]',inRouteSelector:'[data-tour="companion-page"]',completion:{type:"route_visit"}},{id:"morning_checkin",taskText:"Morning Check-in ðŸŒ…",title:"Complete morning check-in",description:"Open Mentor and submit one morning reflection.",checklist:["Tap MENTOR in the bottom navigation bar.","Open the Morning Check-in card.","Answer and submit your check-in."],successHint:"This step auto-completes after your check-in is submitted.",actionLabel:"Go to Mentor",route:"/mentor",navSelector:'[data-tour="mentor-tab"]',inRouteSelector:'[data-tour="morning-checkin"]',completion:{type:"event",eventName:"morning-checkin-completed",requireRoute:!0}}],vg=new Set(is.map(t=>t.id)),yi=t=>typeof t=="string"&&vg.has(t),bi=new Map(is.map(t=>[t.taskText,t.id])),uc=t=>`guided_tutorial_progress_${t}`,vi=t=>{if(!t)return null;const s=qe.getItem(uc(t));if(!s)return null;try{return JSON.parse(s)}catch{return null}},wi=t=>t==="/welcome"||t==="/preview"||t.startsWith("/auth")||t.startsWith("/onboarding"),wg=()=>{const{user:t}=ce(),{profile:s,loading:a}=yt(),{awardCustomXP:r}=bt(),i=Se(),o=cn(),c=Ht(),l=n.useRef(null),u=n.useRef(!1),[m,p]=n.useState([]),[h,f]=n.useState(null),d=s?.onboarding_data??null,g=d?.walkthrough_completed===!0,y=n.useMemo(()=>vi(t?.id),[t?.id]),v=n.useMemo(()=>{const z=d?.guided_tutorial;return!z||typeof z!="object"?null:z},[d]);n.useEffect(()=>{p([]),f(null),u.current=!1},[t?.id]);const{data:b=[],isLoading:x}=ye({queryKey:["guided-tutorial-tasks",t?.id],enabled:!!t?.id&&g,queryFn:async()=>{if(!t?.id)return[];const z=is.map(U=>U.taskText),{data:W,error:Q}=await N.from("daily_tasks").select("id, task_text, completed, xp_reward").eq("user_id",t.id).eq("source","onboarding").in("task_text",z);if(Q)throw Q;return W??[]},staleTime:60*1e3,refetchOnWindowFocus:!1}),j=n.useMemo(()=>{const z=[];for(const W of b){if(!W.completed)continue;const Q=bi.get(W.task_text);Q&&z.push(Q)}return z},[b]),w=n.useMemo(()=>{const z=new Map;for(const W of b){const Q=bi.get(W.task_text);Q&&z.set(Q,{id:W.id,completed:!!W.completed,xpReward:W.xp_reward??0})}return z},[b]),D=n.useMemo(()=>{const z=(v?.completedSteps??[]).filter(yi),W=(y?.completedSteps??[]).filter(yi);return Array.from(new Set([...z,...W]))},[v?.completedSteps,y?.completedSteps]),S=n.useMemo(()=>h!==null?h:!!(v?.dismissed??y?.dismissed??!1),[h,y?.dismissed,v?.dismissed]),M=n.useMemo(()=>new Set([...D,...j,...m]),[j,D,m]),C=n.useMemo(()=>is.find(z=>!M.has(z.id)),[M]),R=!!t?.id&&!a&&g&&!x&&b.length>0,T=R&&!C,q=n.useCallback(async z=>{if(!t?.id)return;const Q={...vi(t.id)??{},...z,lastUpdatedAt:new Date().toISOString()};qe.setItem(uc(t.id),JSON.stringify(Q));const U=s?.onboarding_data??{},J={...U.guided_tutorial??{},...z,lastUpdatedAt:new Date().toISOString()},{error:O}=await N.from("profiles").update({onboarding_data:{...U,guided_tutorial:J}}).eq("id",t.id);O||i.invalidateQueries({queryKey:["profile",t.id]})},[s?.onboarding_data,i,t?.id]),k=n.useCallback(z=>{if(!R||M.has(z))return;p(J=>J.includes(z)?J:[...J,z]);const W=new Set([...M,z]),Q=Array.from(W),U=is.every(J=>W.has(J.id)),$=w.get(z);t?.id&&$&&!$.completed&&(async()=>{const{data:J,error:O}=await N.from("daily_tasks").update({completed:!0,completed_at:new Date().toISOString()}).eq("id",$.id).eq("user_id",t.id).eq("source","onboarding").eq("completed",!1).select("id").maybeSingle();O||!J||(await r($.xpReward,"task_complete",void 0,{task_id:$.id,source:"onboarding_auto"}),i.invalidateQueries({queryKey:["daily-tasks"]}),i.invalidateQueries({queryKey:["guided-tutorial-tasks",t.id]}))})(),f(!1),q({completedSteps:Q,dismissed:!1,completed:U,completedAt:U?new Date().toISOString():void 0})},[r,M,w,q,i,R,t?.id]);n.useEffect(()=>{!T||u.current||(u.current=!0,f(!1),q({completedSteps:is.map(z=>z.id),dismissed:!1,completed:!0,completedAt:new Date().toISOString()}))},[q,T]),n.useEffect(()=>{if(!C||C.completion.type!=="route_visit"||o.pathname!==C.route)return;const z=window.setTimeout(()=>{k(C.id)},700);return()=>{window.clearTimeout(z)}},[C,o.pathname,k]),n.useEffect(()=>{if(!C)return;const z=C.completion;if(z.type!=="event")return;const W=Q=>{if(!(z.requireRoute&&o.pathname!==C.route)){if(C.id==="create_quest"){const U=Q.detail;if(!U?.taskDate||!U?.scheduledTime)return}k(C.id)}};return window.addEventListener(z.eventName,W),()=>{window.removeEventListener(z.eventName,W)}},[C,o.pathname,k]);const P=n.useMemo(()=>C?o.pathname===C.route?C.inRouteSelector:C.navSelector:null,[C,o.pathname]);n.useEffect(()=>{if(l.current&&(l.current.classList.remove("tutorial-guide-spotlight"),l.current.classList.remove("tutorial-guide-fab-spotlight"),l.current=null),!R||!C||S||wi(o.pathname)||!P)return;const z=document.querySelector(P);if(z)return z.classList.add("tutorial-guide-spotlight"),P==='[data-tour="add-quest-fab"]'&&z.classList.add("tutorial-guide-fab-spotlight"),l.current=z,o.pathname===C.route&&window.requestAnimationFrame(()=>{z.scrollIntoView({block:"center",inline:"center",behavior:"smooth"})}),()=>{z.classList.remove("tutorial-guide-spotlight"),z.classList.remove("tutorial-guide-fab-spotlight"),l.current===z&&(l.current=null)}},[P,C,S,o.pathname,R]);const A=n.useCallback(()=>{if(!C)return;if(o.pathname!==C.route){c(C.route);return}const z=document.querySelector(C.inRouteSelector);z&&z.scrollIntoView({block:"center",inline:"center",behavior:"smooth"})},[C,o.pathname,c]),L=n.useCallback(()=>{f(!0),q({dismissed:!0})},[q]),H=n.useCallback(()=>{f(!1),q({dismissed:!1})},[q]);if(!R||T||wi(o.pathname)||!C)return null;const te=`Step ${is.findIndex(z=>z.id===C.id)+1} of ${is.length}`,V=o.pathname==="/journeys"&&C.id==="create_quest";return S?e.jsx("div",{className:"fixed right-4 z-[70]",style:{bottom:"calc(6.5rem + env(safe-area-inset-bottom, 0px))"},children:e.jsx(B,{size:"sm",variant:"secondary",className:"rounded-full bg-card/90 backdrop-blur-md border border-primary/30 text-xs",onClick:H,children:"Resume Tutorial"})}):e.jsx("div",{className:"fixed left-0 right-0 z-[70] px-3",style:V?{top:"calc(1rem + env(safe-area-inset-top, 0px))"}:{bottom:"calc(6.5rem + env(safe-area-inset-bottom, 0px))"},children:e.jsxs("div",{className:E("mx-auto rounded-2xl border border-primary/30 bg-card/92 backdrop-blur-xl shadow-[0_10px_30px_rgba(0,0,0,0.35)] p-3",V?"max-w-md":"max-w-lg"),children:[e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-[10px] uppercase tracking-[0.18em] text-primary/90 font-semibold",children:te}),e.jsx("h3",{className:"mt-1 text-sm font-semibold text-foreground",children:C.title}),e.jsx("p",{className:"mt-1 text-xs text-muted-foreground leading-relaxed",children:C.description}),e.jsxs("div",{className:"mt-2 rounded-lg border border-border/60 bg-background/35 px-2.5 py-2",children:[e.jsx("p",{className:"text-[10px] font-semibold uppercase tracking-[0.12em] text-primary/80",children:"Do this now"}),e.jsx("ol",{className:"mt-1.5 space-y-1",children:C.checklist.map((z,W)=>e.jsxs("li",{className:"text-[11px] text-foreground/90 leading-relaxed",children:[e.jsxs("span",{className:"mr-1 text-primary/90 font-semibold",children:[W+1,"."]}),z]},z))})]}),e.jsx("p",{className:"mt-2 text-[11px] text-primary/90 leading-relaxed",children:C.successHint})]}),e.jsx("button",{className:E("text-[11px] text-muted-foreground hover:text-foreground transition-colors px-2 py-1 rounded-md","hover:bg-muted/50"),onClick:L,children:"Hide"})]}),e.jsx("div",{className:"mt-3",children:e.jsx(B,{size:"sm",className:"w-full",onClick:A,children:C.actionLabel})})]})})},aa=n.forwardRef(({className:t,activeClassName:s,pendingClassName:a,to:r,...i},o)=>e.jsx(Mu,{ref:o,to:r,className:({isActive:c,isPending:l})=>E(t,c&&s,l&&a),...i}));aa.displayName="NavLink";const Br=new Map,mc=async t=>{if(Br.has(t))return Br.get(t);try{let s;switch(t.toLowerCase()){case"atlas":s=await me(()=>import("./atlas-sage-CL7hL_Ez.js"),[]);break;case"eli":s=await me(()=>import("./darius-sage-2XcD16mi.js"),[]);break;case"sienna":s=await me(()=>import("./sienna-sage-CppN60cS.js"),[]);break;case"stryker":s=await me(()=>import("./stryker-sage-B3PlAZKv.js"),[]);break;case"carmen":s=await me(()=>import("./carmen-sage-CZySZiFo.js"),[]);break;case"reign":s=await me(()=>import("./reign-sage-D4nrVOuM.js"),[]);break;case"solace":s=await me(()=>import("./solace-sage-CJdBfLhM.js"),[]);break;default:s=await me(()=>import("./atlas-sage-CL7hL_Ez.js"),[])}const a=s.default;return Br.set(t,a),a}catch(s){return console.error(`Failed to load mentor image for ${t}:`,s),""}},jg={atlas:"center 20%",eli:"center 15%",sienna:"center 30%",stryker:"center 25%",carmen:"center 20%",reign:"center 20%",solace:"center 25%"},_g={sm:"w-16 h-16",md:"w-24 h-24 md:w-32 md:h-32",lg:"w-32 h-32 md:w-40 md:h-40",xl:"w-48 h-48 md:w-56 md:h-56"},ca=n.memo(({mentorSlug:t,mentorName:s,primaryColor:a,avatarUrl:r,size:i="md",className:o="",showBorder:c=!0,showGlow:l=!1,style:u})=>{const[m,p]=n.useState(r||"");n.useEffect(()=>{if(r){p(r);return}const v=(t||"").trim().toLowerCase();v&&mc(v).then(p).catch(()=>{})},[t,r]);const h=(t||"").trim().toLowerCase(),f=(s||"").trim().toLowerCase().replace(/\s+/g,"-"),g=jg[h||f]||"center 25%",y=v=>v.split(" ").map(b=>b[0]).join("").toUpperCase();return e.jsx("div",{className:`relative ${_g[i]} rounded-full overflow-hidden ${o}`,style:{...u,border:c?`4px solid ${a}`:void 0,boxShadow:u?.boxShadow||(l?`0 0 40px ${a}60`:c?`0 0 20px ${a}40`:void 0)},children:m?e.jsx("img",{src:m,alt:s,className:"w-full h-full object-cover",style:{objectPosition:g},loading:"lazy",decoding:"async"}):e.jsx("div",{className:"w-full h-full flex items-center justify-center text-pure-white text-4xl font-black",style:{backgroundColor:a},children:y(s)})})}),Ng={joyful:{saturation:80,lightness:65,glowIntensity:.4},content:{saturation:60,lightness:55,glowIntensity:.3},neutral:{saturation:40,lightness:50,glowIntensity:.2},reserved:{saturation:25,lightness:45,glowIntensity:.15},quiet:{saturation:15,lightness:40,glowIntensity:.1},dormant:{saturation:5,lightness:30,glowIntensity:0}},pc=()=>{const{presence:t}=dr();return n.useMemo(()=>{const{auraHue:s,mood:a,auraOpacity:r}=t,i=Ng[a],o=`hsl(${s}, ${i.saturation}%, ${i.lightness}%)`,c=`hsl(${(s+30)%360}, ${i.saturation*.8}%, ${i.lightness}%)`,l=i.glowIntensity>0?`0 0 20px hsla(${s}, ${i.saturation}%, ${i.lightness}%, ${i.glowIntensity}), 
         0 0 40px hsla(${s}, ${i.saturation}%, ${i.lightness}%, ${i.glowIntensity*.5})`:"none",u=`radial-gradient(
      ellipse at 50% 30%,
      hsla(${s}, ${i.saturation}%, ${i.lightness}%, ${r}),
      transparent 70%
    )`,m=`hsla(${s}, ${i.saturation}%, ${i.lightness+15}%, 0.8)`,p=i.glowIntensity>0?`0 0 12px hsla(${s}, ${i.saturation}%, ${i.lightness}%, ${i.glowIntensity*.8})`:"none";return{primaryAura:o,secondaryAura:c,glowShadow:l,gradientOverlay:u,particleColor:m,navGlow:p}},[t])},hc=n.memo(({isActive:t=!1})=>{const{presence:s,isLoading:a}=dr(),{navGlow:r,primaryAura:i}=pc(),[o,c]=n.useState(!1);if(n.useEffect(()=>{const m=window.matchMedia("(prefers-reduced-motion: reduce)");c(m.matches);const p=()=>c(m.matches);return m.addEventListener("change",p),()=>m.removeEventListener("change",p)},[]),a||!s.isPresent)return null;const l=!o&&(s.mood==="joyful"||s.mood==="content"),u=s.needsAttention&&!t;return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute inset-0 rounded-full -z-10",style:{boxShadow:r,animation:l?`companion-nav-breathe ${3/s.pulseRate}s ease-in-out infinite`:"none",willChange:l?"box-shadow":"auto"}}),u&&e.jsx("div",{className:"absolute -top-0.5 -right-0.5 w-2 h-2 rounded-full",style:{backgroundColor:i,boxShadow:`0 0 6px ${i}`,animation:o?"none":"companion-attention-pulse 2s ease-in-out infinite"}}),e.jsx("style",{children:`
        @keyframes companion-nav-breathe {
          0%, 100% {
            opacity: 0.6;
            transform: scale(1);
          }
          50% {
            opacity: 1;
            transform: scale(1.05);
          }
        }

        @keyframes companion-attention-pulse {
          0%, 100% {
            opacity: 0.7;
            transform: scale(1);
          }
          50% {
            opacity: 1;
            transform: scale(1.3);
          }
        }
      `})]})});hc.displayName="CompanionNavPresence";const ji="inbox-tasks",fc="inbox-count",kg=()=>{const{user:t}=ce(),s=Se(),a=n.useCallback(()=>{s.invalidateQueries({queryKey:[ji]}),s.invalidateQueries({queryKey:[fc]})},[s]),{data:r=[],isLoading:i}=ye({queryKey:[ji,t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:u,error:m}=await N.from("daily_tasks").select("*").eq("user_id",t.id).is("task_date",null).eq("completed",!1).order("created_at",{ascending:!1});if(m)throw m;return u||[]},enabled:!!t?.id,staleTime:30*1e3,gcTime:1800*1e3,placeholderData:u=>u,refetchOnWindowFocus:!1}),o=ie({mutationFn:async({taskId:u,targetDate:m})=>{const{error:p}=await N.from("daily_tasks").update({task_date:m}).eq("id",u);if(p)throw p},onSuccess:()=>{a(),s.invalidateQueries({queryKey:["daily-tasks"]})}}),c=ie({mutationFn:async({taskId:u,completed:m})=>{const{error:p}=await N.from("daily_tasks").update({completed:m,completed_at:m?new Date().toISOString():null}).eq("id",u);if(p)throw p},onSuccess:()=>{a()}}),l=ie({mutationFn:async u=>{const{error:m}=await N.from("daily_tasks").delete().eq("id",u);if(m)throw m},onSuccess:()=>{a()}});return{inboxTasks:r,inboxCount:r.length,isLoading:i,scheduleTask:o.mutate,toggleInboxTask:c.mutate,deleteInboxTask:l.mutate}},Cg=()=>{const{user:t}=ce(),{data:s=0}=ye({queryKey:[fc,t?.id],queryFn:async()=>{if(!t?.id)return 0;const{count:a,error:r}=await N.from("daily_tasks").select("id",{count:"exact",head:!0}).eq("user_id",t.id).is("task_date",null).eq("completed",!1);if(r)throw r;return a??0},enabled:!!t?.id,staleTime:30*1e3,gcTime:1800*1e3,placeholderData:a=>a,refetchOnWindowFocus:!1});return{inboxCount:s}},Sg={mentor:()=>Promise.resolve(),inbox:()=>Promise.resolve(),journeys:()=>Promise.resolve(),companion:()=>Promise.resolve()},Ca=n.memo(()=>{const{profile:t}=yt(),{companion:s,progressToNext:a}=st(),{inboxCount:r}=Cg(),i=n.useCallback(u=>{Sg[u]?.()},[]),o=Us(t),{data:c,isLoading:l}=ye({queryKey:["selected-mentor",o],enabled:!!o,staleTime:600*1e3,queryFn:async()=>{if(!o)throw new Error("No mentor selected");const{data:u,error:m}=await N.from("mentors").select("slug, name, primary_color").eq("id",o).maybeSingle();if(m)throw m;return u}});return e.jsx(e.Fragment,{children:e.jsx("nav",{className:"fixed bottom-0 left-0 right-0 cosmiq-glass-nav z-50 border-t border-border/40 transition-transform duration-200",role:"navigation","aria-label":"Main navigation",style:{paddingBottom:"env(safe-area-inset-bottom, 0px)"},children:e.jsxs("div",{className:"max-w-lg mx-auto flex items-center justify-around px-2 sm:px-4 py-2.5",children:[e.jsx(aa,{to:"/mentor",className:"flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition-all duration-200 active:scale-95 touch-manipulation min-w-[58px] min-h-[56px]",activeClassName:"bg-orange-500/12","data-tour":"mentor-tab",onClick:()=>$e.light(),onMouseEnter:()=>i("mentor"),onFocus:()=>i("mentor"),children:({isActive:u})=>e.jsxs(e.Fragment,{children:[l?e.jsx("div",{className:"h-7 w-7 rounded-full bg-muted animate-pulse","aria-hidden":!0}):c?e.jsx(ca,{mentorSlug:c.slug||"",mentorName:c.name,primaryColor:c.primary_color||"#000",size:"sm",className:"w-7 h-7",showBorder:!1}):e.jsx(Ro,{className:`h-6 w-6 transition-colors duration-200 ${u?"text-orange-300":"text-muted-foreground"}`}),e.jsx("span",{className:`text-[11px] font-medium transition-colors duration-200 ${u?"text-orange-200":"text-muted-foreground/85"}`,children:"Mentor"})]})}),e.jsx(aa,{to:"/inbox",className:"flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition-all duration-200 active:scale-95 touch-manipulation min-w-[58px] min-h-[56px] relative",activeClassName:"bg-celestial-blue/12",onClick:()=>$e.light(),onMouseEnter:()=>i("inbox"),onFocus:()=>i("inbox"),children:({isActive:u})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(dn,{className:`h-6 w-6 transition-colors duration-200 ${u?"text-celestial-blue":"text-muted-foreground"}`}),r>0&&e.jsx(Ne,{className:"absolute -top-1 -right-2 h-4 min-w-[16px] px-1 p-0 flex items-center justify-center text-[9px] bg-celestial-blue text-white border-0",children:r>9?"9+":r})]}),e.jsx("span",{className:`text-[11px] font-medium transition-colors duration-200 ${u?"text-celestial-blue":"text-muted-foreground/85"}`,children:"Inbox"})]})}),e.jsx(aa,{to:"/journeys",className:"flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition-all duration-200 active:scale-95 touch-manipulation min-w-[58px] min-h-[56px]",activeClassName:"bg-cosmiq-glow/12","data-tour":"quests-tab",onClick:()=>$e.light(),onMouseEnter:()=>i("journeys"),onFocus:()=>i("journeys"),children:({isActive:u})=>e.jsxs(e.Fragment,{children:[e.jsx(Io,{className:`h-6 w-6 transition-colors duration-200 ${u?"text-cosmiq-glow":"text-muted-foreground"}`}),e.jsx("span",{className:`text-[11px] font-medium transition-colors duration-200 ${u?"text-cosmiq-glow":"text-muted-foreground/85"}`,children:"Quests"})]})}),e.jsx(aa,{to:"/companion",className:"flex flex-col items-center gap-1 px-3 py-2 rounded-2xl transition-all duration-200 active:scale-95 touch-manipulation min-w-[58px] min-h-[56px] relative",activeClassName:"bg-stardust-gold/12","data-tour":"companion-tab",onClick:()=>$e.light(),onMouseEnter:()=>i("companion"),onFocus:()=>i("companion"),children:({isActive:u})=>e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"relative",children:[e.jsx(hc,{isActive:u}),e.jsx(Du,{fill:"currentColor",className:`h-6 w-6 -rotate-45 transition-colors duration-200 ${u?"text-stardust-gold":"text-muted-foreground"}`}),s&&a>90&&e.jsx(Ne,{className:"absolute -top-1 -right-1 h-4 w-4 p-0 flex items-center justify-center text-[9px] bg-stardust-gold text-black animate-pulse",children:"!"})]}),e.jsx("span",{className:`text-[11px] font-medium transition-colors duration-200 ${u?"text-stardust-gold":"text-muted-foreground/85"}`,children:"Companion"})]})})]})})})});Ca.displayName="BottomNav";const Tg=[.25,.1,.25,1],Sa=n.memo(({children:t,mode:s="animated"})=>ss()||s==="instant"?e.jsx("div",{style:{width:"100%",height:"100%"},children:t}):e.jsx(_.div,{initial:!1,animate:{opacity:1,y:0},exit:{opacity:0,y:-6},transition:{duration:.18,ease:Tg},style:{width:"100%",height:"100%"},children:t}));Sa.displayName="PageTransition";const Eg=n.memo(({children:t,delay:s=0})=>{const a=ss();return e.jsx(_.div,{initial:{opacity:a?1:0},animate:{opacity:1},transition:{duration:a?0:.24,delay:a?0:s},children:t})});Eg.displayName="FadeIn";const Mg=n.memo(({children:t,delay:s=0})=>{const a=ss();return e.jsx(_.div,{initial:{opacity:a?1:0,scale:a?1:.97},animate:{opacity:1,scale:1},transition:{duration:a?0:.2,delay:a?0:s},children:t})});Mg.displayName="ScaleIn";const Dg=n.memo(({children:t,delay:s=0})=>{const a=ss();return e.jsx(_.div,{initial:{opacity:a?1:0,y:a?0:16},animate:{opacity:1,y:0},transition:{duration:a?0:.24,delay:a?0:s,ease:"easeOut"},children:t})});Dg.displayName="SlideUp";const Pg=["What should I focus on today?","How can I stay motivated?","I need a mindset shift","Give me a pep talk","Help me overcome self-doubt","How do I build better habits?","I'm feeling stuck","What's my next step?","Help me start strong today","Keep me on track","I need encouragement","Give me the hard truth"],gc=n.memo(()=>{const t=Ht(),s=ka(),[a,r]=n.useState([]),[i,o]=n.useState("");n.useEffect(()=>{const u=[...Pg].sort(()=>Math.random()-.5);r(u.slice(0,3))},[]);const c=u=>{t("/mentor-chat",{state:{initialMessage:u}})},l=u=>{u.preventDefault(),i.trim()&&t("/mentor-chat",{state:{initialMessage:i}})};return e.jsxs(Me,{className:"p-6 space-y-5 rounded-3xl bg-card/25 backdrop-blur-2xl border-white/[0.08] relative overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/5 via-transparent to-accent/5"}),e.jsxs("div",{className:"relative z-10 space-y-5",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Za,{className:"h-6 w-6 text-primary"}),e.jsx("div",{className:"absolute inset-0 bg-primary/20 blur-md rounded-full animate-pulse-slow"})]}),e.jsx("h3",{className:"text-lg font-bold text-foreground",children:s?.name?`Ask ${s.name}`:"Quick Chat"})]}),e.jsx("div",{className:"space-y-3",children:a.map((u,m)=>e.jsx("button",{onClick:()=>c(u),className:"group relative w-full text-center px-6 py-4 rounded-full bg-white/[0.03] backdrop-blur-xl hover:bg-white/[0.06] border border-white/[0.08] hover:border-primary/30 transition-all text-sm font-medium text-foreground hover:scale-[1.02] active:scale-[0.98]",children:e.jsx("span",{className:"relative",children:u})},m))}),e.jsxs("form",{onSubmit:l,className:"flex gap-2",children:[e.jsx(He,{value:i,onChange:u=>o(u.target.value),placeholder:"Or type your own...",className:"flex-1 rounded-full border-2 focus:border-primary/50 transition-all"}),e.jsx(B,{type:"submit",size:"icon",disabled:!i.trim(),className:"rounded-full h-10 w-10 shadow-soft hover:shadow-glow transition-all hover:scale-110 disabled:opacity-50","aria-label":"Send question",children:e.jsx(qo,{className:"h-4 w-4"})})]})]})]})});gc.displayName="MentorQuickChat";class Ag extends n.Component{constructor(s){super(s),this.state={hasError:!1,error:null}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,a){console.error("Companion Error:",s,a)}render(){return this.state.hasError?this.props.fallback||e.jsx(Rg,{error:this.state.error}):this.props.children}}const Rg=({error:t})=>{const s=Ht();return e.jsx(Me,{className:"p-8 text-center bg-gradient-to-br from-destructive/5 to-destructive/10 border-destructive/30",role:"alert","aria-live":"assertive",children:e.jsxs("div",{className:"flex flex-col items-center gap-4 max-w-md mx-auto",children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-destructive/20 flex items-center justify-center","aria-hidden":"true",children:e.jsx(js,{className:"h-8 w-8 text-destructive"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl font-heading font-bold text-foreground",children:"Companion Unavailable"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Your companion is taking a quick nap. Let's try waking them up!"})]}),e.jsxs("div",{className:"flex gap-3 mt-4",children:[e.jsxs(B,{onClick:()=>window.location.reload(),className:"gap-2","aria-label":"Reload page to retry loading companion",children:[e.jsx(bs,{className:"h-4 w-4","aria-hidden":"true"}),"Retry"]}),e.jsxs(B,{variant:"outline",onClick:()=>s("/"),className:"gap-2","aria-label":"Return to home page",children:[e.jsx(Pu,{className:"h-4 w-4","aria-hidden":"true"}),"Go Home"]})]}),t&&e.jsxs("details",{className:"mt-4 text-xs text-muted-foreground max-w-full",children:[e.jsx("summary",{className:"cursor-pointer hover:text-foreground focus:outline-none focus:ring-2 focus:ring-primary rounded",children:"More details"}),e.jsx("pre",{className:"mt-2 p-3 bg-background/50 rounded text-left overflow-auto max-h-32","aria-label":"Error details",children:t.message})]})]})})},xc=Ag,yc=n.forwardRef(({className:t,...s},a)=>e.jsxs(Lo,{ref:a,className:E("relative flex w-full touch-none select-none items-center",t),...s,children:[e.jsx(Au,{className:"relative h-2 w-full grow overflow-hidden rounded-full bg-secondary",children:e.jsx(Ru,{className:"absolute h-full bg-primary"})}),e.jsx(Iu,{className:"block h-5 w-5 rounded-full border-2 border-primary bg-background ring-offset-background transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50"})]}));yc.displayName=Lo.displayName;const bc=n.memo(()=>{const{profile:t}=yt(),s=ka(),a=Ht(),{awardPepTalkListened:r}=bt(),[i,o]=n.useState(null),[c,l]=n.useState(!0),[u,m]=n.useState(!1),[p,h]=n.useState(!1),[f,d]=n.useState(0),[g,y]=n.useState(0),[v,b]=n.useState(!1),[x,j]=n.useState(-1),[w,D]=n.useState(!1),[S,M]=n.useState(!1),[C,R]=n.useState("idle"),[T,q]=n.useState(!1),[k,P]=n.useState(null),[A,L]=n.useState(!1),H=n.useRef(null),I=n.useRef(null),te=n.useRef(null),V=n.useRef(null);n.useEffect(()=>{L(!1)},[i?.audio_url]),n.useEffect(()=>{if(!i?.audio_url||A)return;const G=setTimeout(()=>{!A&&H.current&&(console.log("Audio ready timeout - enabling play button"),L(!0))},5e3);return()=>clearTimeout(G)},[i?.audio_url,A]);const z=Us(t);n.useEffect(()=>{(async()=>{if(!z){l(!1);return}try{m(!1),q(!1);const Z=new Date().toLocaleDateString("en-CA"),{data:he,error:ve}=await N.from("mentors").select("slug, name").eq("id",z).maybeSingle();if(ve){console.error("Error fetching mentor:",ve),m(!0),l(!1);return}if(!he){l(!1);return}P(he.slug);const{data:we,error:je}=await N.from("daily_pep_talks").select("*").eq("for_date",Z).eq("mentor_slug",he.slug).maybeSingle();let ke=we;if(je){console.error("Error fetching pep talk:",je),m(!0),l(!1);return}if(!ke){console.log("No pep talk for today, fetching most recent...");const{data:Ae,error:Re}=await N.from("daily_pep_talks").select("*").eq("mentor_slug",he.slug).order("for_date",{ascending:!1}).limit(1).maybeSingle();Re?console.error("Error fetching fallback pep talk:",Re):Ae&&(ke=Ae,q(!0),console.log("Using fallback pep talk from:",Ae.for_date))}if(ke){let Ae=[];Array.isArray(ke.transcript)&&(Ae=ke.transcript.filter(Re=>Re&&typeof Re=="object"&&typeof Re.word=="string"&&typeof Re.start=="number"&&typeof Re.end=="number")),o({...ke,mentor_name:he.name,transcript:Ae})}}catch(Z){console.error("Unexpected error fetching pep talk:",Z),m(!0)}finally{l(!1)}})()},[z]);const W=async()=>{if(!k){X.error("No mentor selected");return}M(!0),R("script");try{const{data:G,error:Z}=await N.functions.invoke("generate-single-daily-pep-talk",{body:{mentorSlug:k}});if(R("audio"),Z)throw console.error("Generation error:",Z),new Error(Z.message||"Failed to generate pep talk");if(G?.pepTalk){R("loading");const{data:he}=await N.from("mentors").select("name").eq("slug",k).maybeSingle();let ve=[];Array.isArray(G.pepTalk.transcript)&&(ve=G.pepTalk.transcript.filter(we=>we&&typeof we=="object"&&typeof we.word=="string"&&typeof we.start=="number"&&typeof we.end=="number")),o({...G.pepTalk,mentor_name:he?.name,transcript:ve}),m(!1),q(!1),X.success("Your pep talk is ready!")}else throw new Error("No pep talk data returned")}catch(G){console.error("Error generating pep talk:",G);const Z=G instanceof Error?G.message:"Failed to generate pep talk";X.error(Z)}finally{M(!1),R("idle")}};n.useEffect(()=>{(async()=>{if(!(!i?.id||!i?.audio_url))try{const{data:Z,error:he}=await N.functions.invoke("sync-daily-pep-talk-transcript",{body:{id:i.id}});if(he){console.warn("Transcript sync returned error:",he);return}Z?.script&&o(ve=>{if(!ve)return ve;let we=[];return Array.isArray(Z.transcript)&&(we=Z.transcript.filter(ke=>ke&&typeof ke=="object"&&typeof ke.word=="string"&&typeof ke.start=="number"&&typeof ke.end=="number")),Z.script!==ve.script||JSON.stringify(we)!==JSON.stringify(ve.transcript)?{...ve,script:Z.script,transcript:we}:ve})}catch(Z){console.error("Transcript sync failed:",Z)}})()},[i?.id,i?.audio_url]),n.useEffect(()=>{(async()=>{if(!i?.id||!t?.id)return;const{data:Z}=await N.from("xp_events").select("id").eq("user_id",t.id).eq("event_type","pep_talk_listen").eq("event_metadata->>pep_talk_id",i.id).maybeSingle();D(!!Z)})()},[i?.id,t?.id]),n.useEffect(()=>{const G=H.current;if(!G)return;const Z=()=>{const we=G.currentTime;d(we);const je=G.duration;if(!w&&je>0&&we>=je*.8&&i?.id&&t?.id&&(D(!0),r({pep_talk_id:i.id})),i?.transcript&&Array.isArray(i.transcript)&&i.transcript.length>0){const ke=i.transcript.findIndex(Ae=>we>=Ae.start&&we<=Ae.end);ke>=0&&j(Ae=>ke!==Ae?ke:Ae)}},he=()=>y(G.duration),ve=()=>{h(!1),j(-1)};return G.addEventListener("timeupdate",Z),G.addEventListener("loadedmetadata",he),G.addEventListener("ended",ve),()=>{G.removeEventListener("timeupdate",Z),G.removeEventListener("loadedmetadata",he),G.removeEventListener("ended",ve)}},[i?.transcript,w,r,i?.id,t?.id]),n.useEffect(()=>()=>{V.current&&clearTimeout(V.current)},[]),n.useEffect(()=>{if(I.current&&te.current&&v){const G=te.current,Z=I.current,he=G.getBoundingClientRect(),ve=Z.getBoundingClientRect();(ve.top<he.top||ve.bottom>he.bottom)&&Z.scrollIntoView({behavior:"smooth",block:"center"})}},[x,v]);const Q=async()=>{const G=H.current;if(!G){console.error("Audio element not found");return}if(p)G.pause(),h(!1);else try{console.log("Attempting to play audio from:",i?.audio_url),await G.play(),h(!0)}catch(Z){console.error("Audio play failed:",Z),G.load();try{await G.play(),h(!0)}catch(he){console.error("Audio play retry failed:",he)}}},U=n.useCallback(G=>{const Z=H.current;Z&&(d(G[0]),V.current&&clearTimeout(V.current),V.current=window.setTimeout(()=>{Z&&(Z.currentTime=G[0])},100))},[]),$=G=>{const Z=H.current;Z&&(Z.currentTime=Math.max(0,Math.min(Z.duration,Z.currentTime+G)))},J=G=>{if(isNaN(G))return"0:00";const Z=Math.floor(G/60),he=Math.floor(G%60);return`${Z}:${he.toString().padStart(2,"0")}`},O=()=>{if(!i?.script)return e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"No transcript available"});const Z=i.script.split(" ").slice(0,20);return e.jsxs("div",{className:"text-sm leading-relaxed text-foreground/70",children:[Z.join(" "),"..."]})},le=()=>!i?.transcript||!Array.isArray(i.transcript)?i?.script?e.jsx("div",{ref:te,className:"text-sm leading-relaxed max-h-64 overflow-y-auto scroll-smooth pr-2 text-foreground/80",children:i.script}):null:e.jsx("div",{ref:te,className:"text-sm leading-relaxed max-h-64 overflow-y-auto scroll-smooth pr-2 text-foreground/80",children:i.transcript.map((G,Z)=>e.jsxs("span",{ref:Z===x?I:null,className:E("transition-colors duration-200",Z===x?"text-primary font-semibold bg-primary/10 px-1 rounded":"text-foreground/80"),children:[G.word," "]},Z))});return c?e.jsx(Me,{className:"p-6 animate-pulse",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"h-4 bg-muted rounded w-1/3"}),e.jsx("div",{className:"h-20 bg-muted rounded"})]})}):u||!i?e.jsxs(Me,{className:"relative overflow-hidden rounded-3xl border-2 p-6",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/10 via-accent/5 to-primary/5"}),e.jsxs("div",{className:"relative space-y-4 text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsx(se,{className:"h-5 w-5 text-muted-foreground"}),e.jsx("h2",{className:"text-lg font-semibold text-muted-foreground",children:s?.name?`${s.name}'s Daily Message`:"Today's Pep Talk"})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:u?"Unable to load today's pep talk":"No pep talk available today"}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2 justify-center",children:[e.jsx(B,{onClick:W,disabled:S||!k,className:"rounded-full min-w-[200px]",children:S?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"h-4 w-4 mr-2 animate-spin"}),C==="script"&&"Generating script...",C==="audio"&&"Creating audio...",C==="loading"&&"Loading..."]}):e.jsxs(e.Fragment,{children:[e.jsx(us,{className:"h-4 w-4 mr-2"}),"Generate Today's Pep Talk"]})}),e.jsx(B,{variant:"outline",size:"default",className:"rounded-full",onClick:()=>a("/pep-talks"),children:"Browse Library"})]})]})]}):e.jsxs(Me,{className:"relative overflow-hidden group animate-fade-in rounded-3xl border-2",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/25 via-accent/15 to-primary/10 animate-gradient-shift"}),p&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute top-1/4 left-1/4 w-1 h-1 bg-primary rounded-full animate-sparkle"}),e.jsx("div",{className:"absolute top-1/3 right-1/4 w-1.5 h-1.5 bg-accent rounded-full animate-sparkle",style:{animationDelay:"0.3s"}}),e.jsx("div",{className:"absolute bottom-1/3 left-1/3 w-1 h-1 bg-primary rounded-full animate-sparkle",style:{animationDelay:"0.6s"}}),e.jsx("div",{className:"absolute top-1/2 right-1/3 w-1.5 h-1.5 bg-accent rounded-full animate-sparkle",style:{animationDelay:"0.9s"}})]}),e.jsx("div",{className:"absolute -top-20 -right-20 w-40 h-40 bg-primary/20 blur-3xl rounded-full animate-pulse-slow"}),e.jsx("div",{className:"absolute -bottom-20 -left-20 w-40 h-40 bg-accent/20 blur-3xl rounded-full animate-pulse-slow",style:{animationDelay:"1.5s"}}),e.jsxs("div",{className:"relative p-6 md:p-8 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2",children:[e.jsxs("div",{className:"relative",children:[e.jsx(se,{className:"h-6 w-6 text-primary animate-pulse-slow"}),e.jsx("div",{className:"absolute inset-0 bg-primary/30 blur-md rounded-full"})]}),e.jsx("h2",{className:"text-xl font-bold bg-gradient-to-r from-primary via-accent to-primary bg-clip-text text-transparent animate-gradient-text",children:s?.name?`${s.name}'s Daily Message`:"Today's Pep Talk"})]}),e.jsxs("div",{className:"space-y-6 p-6 rounded-2xl bg-gradient-to-br from-card/90 to-card/70 backdrop-blur-sm border-2 border-primary/30 shadow-glow",children:[T&&e.jsxs("div",{className:"flex items-center justify-center gap-2 text-xs text-muted-foreground bg-muted/50 rounded-full px-3 py-1 mx-auto w-fit",children:[e.jsxs("span",{children:["From ",new Date(i.for_date+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric",year:"numeric"})]}),e.jsx(B,{variant:"ghost",size:"sm",className:"h-auto py-0 px-2 text-xs text-primary hover:text-primary/80",onClick:W,disabled:S,children:S?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"h-3 w-3 mr-1 animate-spin"}),C==="script"&&"Writing...",C==="audio"&&"Recording...",C==="loading"&&"Loading..."]}):"Generate today's"})]}),e.jsxs("div",{className:"space-y-3 text-center",children:[e.jsx("h3",{className:"text-xl md:text-2xl font-bold text-foreground",children:i.title}),e.jsx("p",{className:"text-sm text-muted-foreground leading-relaxed",children:i.summary})]}),e.jsx("audio",{ref:H,src:i.audio_url,preload:"auto",onCanPlay:()=>L(!0),onError:()=>{ee.error("Audio loading error",{audioUrl:i.audio_url,errorCode:H.current?.error?.code,errorMessage:H.current?.error?.message})},onLoadedMetadata:()=>{ee.log("Audio loaded successfully"),ee.log("Duration:",H.current?.duration),H.current?.duration&&H.current.duration>0&&L(!0)}}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"flex items-center justify-center",children:e.jsx(B,{size:"icon",onClick:Q,disabled:!A,className:E("h-20 w-20 rounded-full transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed",p?"bg-gradient-to-br from-accent to-primary shadow-glow-lg scale-110":"bg-gradient-to-br from-primary to-accent shadow-glow hover:scale-110"),"aria-label":A?p?"Pause pep talk":"Play pep talk":"Loading audio",children:A?p?e.jsx(Rs,{className:"h-8 w-8",fill:"currentColor"}):e.jsx(Vt,{className:"h-8 w-8 ml-1",fill:"currentColor"}):e.jsx(ze,{className:"h-8 w-8 animate-spin"})})}),e.jsxs("div",{className:"flex items-center justify-center gap-3",children:[e.jsx(B,{variant:"ghost",size:"icon",onClick:()=>$(-10),disabled:!1,className:"h-10 w-10 rounded-full hover:bg-primary/20 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:scale-105","aria-label":"Skip back 10 seconds",children:e.jsx(qu,{className:"h-4 w-4"})}),e.jsxs("div",{className:"text-xs text-muted-foreground font-medium",children:[J(f)," / ",J(g)]}),e.jsx(B,{variant:"ghost",size:"icon",onClick:()=>$(10),disabled:!1,className:"h-10 w-10 rounded-full hover:bg-primary/20 disabled:opacity-50 disabled:cursor-not-allowed transition-all hover:scale-105","aria-label":"Skip forward 10 seconds",children:e.jsx(ua,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"space-y-2 px-2",children:e.jsx(yc,{value:[f],max:g>0?g:1,step:.1,onValueChange:U,disabled:g===0,className:"w-full"})}),e.jsxs("div",{className:"space-y-2 p-4 rounded-2xl bg-background/60 backdrop-blur-sm border border-primary/20 shadow-soft",children:[v?le():O(),i?.script&&e.jsxs(B,{variant:"ghost",size:"sm",onClick:()=>b(!v),className:"w-full justify-between mt-2 rounded-full hover:bg-primary/10 transition-all",children:[e.jsx("span",{className:"text-xs font-medium",children:v?"Show Less":"Show Full Transcript"}),v?e.jsx(un,{className:"h-4 w-4"}):e.jsx(Jt,{className:"h-4 w-4"})]})]})]}),e.jsx(B,{variant:"outline",size:"lg",className:"w-full rounded-full border-2 hover:bg-primary/10 hover:scale-105 transition-all shadow-soft",onClick:()=>a("/pep-talks"),children:"Browse More Pep Talks"})]})]})]})});bc.displayName="TodaysPepTalk";const xt=n.forwardRef(({className:t,...s},a)=>e.jsx("textarea",{className:E("flex min-h-[80px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),ref:a,...s}));xt.displayName="Textarea";const Ig=({onSelect:t,selected:s})=>{const a=[{id:"unmotivated",label:"Unmotivated",icon:Lu,color:"text-red-500",borderColor:"border-red-500/50",bgColor:"bg-red-500/10"},{id:"overthinking",label:"Overthinking",icon:Rt,color:"text-purple-500",borderColor:"border-purple-500/50",bgColor:"bg-purple-500/10"},{id:"stressed",label:"Stressed",icon:Be,color:"text-orange-500",borderColor:"border-orange-500/50",bgColor:"bg-orange-500/10"},{id:"low_energy",label:"Low Energy",icon:Fu,color:"text-gray-400",borderColor:"border-gray-400/50",bgColor:"bg-gray-400/10"},{id:"content",label:"Content",icon:Ou,color:"text-blue-400",borderColor:"border-blue-400/50",bgColor:"bg-blue-400/10"},{id:"disciplined",label:"Disciplined",icon:Ze,color:"text-green-500",borderColor:"border-green-500/50",bgColor:"bg-green-500/10"},{id:"focused",label:"Focused",icon:$u,color:"text-teal-500",borderColor:"border-teal-500/50",bgColor:"bg-teal-500/10"},{id:"inspired",label:"Inspired",icon:se,color:"text-yellow-500",borderColor:"border-yellow-500/50",bgColor:"bg-yellow-500/10"}];return e.jsx("div",{className:"grid grid-cols-4 gap-2.5",children:a.map(r=>{const i=r.icon,o=s===r.id;return e.jsxs("button",{type:"button",onClick:()=>{t(r.id),window.dispatchEvent(new CustomEvent("mood-selected"))},className:E("flex flex-col items-center justify-center gap-1.5 p-3 rounded-xl border-2 transition-all duration-200 active:scale-95",o?`${r.bgColor} ${r.borderColor} shadow-md`:"bg-card/50 border-border/50 hover:border-primary/40 hover:bg-card/80"),children:[e.jsx("div",{className:E("w-9 h-9 rounded-full flex items-center justify-center transition-all duration-200",r.bgColor),children:e.jsx(i,{className:E("h-5 w-5",r.color)})}),e.jsx("span",{className:E("text-[10px] font-medium leading-none text-center",o?"text-foreground":"text-muted-foreground"),children:r.label})]},r.id)})})},qg=()=>{const{user:t}=ce(),{toast:s}=Ut(),a=ka(),r=Se(),{awardCheckInComplete:i,XP_REWARDS:o}=bt(),{checkFirstTimeAchievements:c}=pr(),{triggerReaction:l}=Na(),[u,m]=n.useState(""),[p,h]=n.useState(""),[f,d]=n.useState(!1),g=n.useRef(null),y=new Date().toLocaleDateString("en-CA"),v=3e4,{data:b}=ye({queryKey:["morning-check-in",y,t?.id],queryFn:async()=>{if(!t)return null;const{data:j}=await N.from("daily_check_ins").select("*").eq("user_id",t.id).eq("check_in_type","morning").eq("check_in_date",y).maybeSingle();return j},enabled:!!t,refetchInterval:j=>{const w=j.state.data;if(w?.completed_at&&!w?.mentor_response){const D=g.current;return D&&Date.now()-D>v?(ee.warn("Mentor response polling timeout exceeded"),!1):2e3}return!1}}),x=async()=>{if(!t||!u||!p.trim()){s({title:"Please complete all fields",variant:"destructive"});return}if(b||f){s({title:"Already checked in",description:"You've already completed your check-in today",variant:"destructive"});return}d(!0);try{const{data:j}=await N.from("daily_check_ins").select("id").eq("user_id",t.id).eq("check_in_type","morning").eq("check_in_date",y).maybeSingle();if(j){s({title:"Already checked in",description:"You've already completed your check-in today",variant:"destructive"}),d(!1),r.invalidateQueries({queryKey:["morning-check-in"]});return}const{data:w,error:D}=await N.from("daily_check_ins").insert({user_id:t.id,check_in_type:"morning",check_in_date:y,mood:u,intention:p.trim(),completed_at:new Date().toISOString()}).select().maybeSingle();if(D)throw ee.error("Check-in error:",D),D;i(),l("mentor",{momentType:"discipline_win"}).catch(M=>ee.log("[LivingCompanion] Mentor reaction failed:",M));const{count:S}=await N.from("daily_check_ins").select("*",{count:"exact",head:!0}).eq("user_id",t.id);S===1&&await c("checkin"),window.dispatchEvent(new CustomEvent("quest-completed")),window.dispatchEvent(new CustomEvent("morning-checkin-completed")),g.current=Date.now();try{const{error:M}=await N.functions.invoke("generate-check-in-response",{body:{checkInId:w.id}});M&&ee.error("Edge function invocation error:",M)}catch(M){ee.error("Edge function invocation failed:",M)}r.invalidateQueries({queryKey:["morning-check-in"]})}catch(j){ee.error("Check-in save error:",j),s({title:"Error",description:j instanceof Error?j.message:"Failed to save check-in",variant:"destructive"})}finally{d(!1)}};return b?.completed_at?e.jsx(Me,{"data-tour":"morning-checkin",className:"p-6 bg-card/25 backdrop-blur-2xl border-celestial-blue/20",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"h-12 w-12 rounded-full bg-stardust-gold/20 flex items-center justify-center flex-shrink-0 ring-2 ring-stardust-gold/30",children:e.jsx(Ln,{className:"h-6 w-6 text-stardust-gold"})}),e.jsxs("div",{className:"flex-1 space-y-3",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-lg",children:"Check-in Complete"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Focus: ",b.intention]})]}),a&&e.jsx("div",{className:"bg-white/[0.03] backdrop-blur-xl rounded-2xl p-4 border border-white/[0.08]",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(ca,{mentorSlug:(a.slug||"").toLowerCase(),mentorName:a.name,primaryColor:a.primary_color||"#000",avatarUrl:a.avatar_url||void 0,size:"sm",className:"flex-shrink-0",showBorder:!0}),e.jsxs("div",{className:"flex-1 space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("p",{className:"text-sm font-semibold text-foreground",children:a.name}),e.jsx(se,{className:"h-3 w-3 text-stardust-gold"})]}),b.mentor_response?e.jsxs("p",{className:"text-sm italic text-foreground/90 leading-relaxed",children:['"',b.mentor_response,'"']}):g.current&&Date.now()-g.current>v?e.jsx("p",{className:"text-sm text-foreground/80 italic leading-relaxed",children:'"Great work on setting your intention today. Stay focused and crush it."'}):e.jsx("p",{className:"text-sm text-muted-foreground italic",children:"Preparing your personalized message..."})]})]})})]})]})}):e.jsxs("div",{"data-tour":"morning-checkin",className:"rounded-2xl bg-card/25 backdrop-blur-2xl border border-white/[0.08] overflow-hidden animate-scale-in shadow-[0_8px_32px_rgba(0,0,0,0.12)]",children:[e.jsx("div",{className:"px-5 py-4 border-b border-white/[0.06] bg-gradient-to-r from-orange-500/5 to-amber-500/[0.02]",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-11 w-11 rounded-xl bg-gradient-to-br from-orange-500/20 to-amber-500/20 flex items-center justify-center border border-orange-500/30",children:e.jsx(Ln,{className:"h-5 w-5 text-orange-500"})}),e.jsx("h3",{className:"font-heading font-black text-2xl tracking-wide text-orange-500",children:"CHECK-IN"})]})}),e.jsxs("div",{className:"p-5 space-y-5",children:[e.jsxs("div",{"data-tour":"checkin-mood",className:"space-y-3",children:[e.jsx("label",{className:"text-sm font-bold text-foreground",children:"How are you feeling?"}),e.jsx(Ig,{selected:u,onSelect:m})]}),e.jsx("div",{className:"h-px bg-border/30"}),e.jsxs("div",{"data-tour":"checkin-intention",className:"space-y-3",children:[e.jsxs("label",{className:"text-sm font-bold flex items-center gap-2 text-foreground",children:[e.jsx(Ze,{className:"h-4 w-4 text-primary"}),"What's your main focus today?"]}),e.jsx(xt,{placeholder:"I will...",value:p,onChange:j=>h(j.target.value),rows:3,className:"resize-none transition-all duration-200 focus:shadow-glow bg-muted/30 border-border/50"})]}),e.jsx(B,{onClick:x,disabled:f||!u||!p.trim()||!!b,variant:"cta",className:"w-full h-13 text-base",size:"lg",children:f?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"h-4 w-4 animate-spin rounded-full border-2 border-background border-t-transparent"}),"Setting Intention..."]}):e.jsxs(e.Fragment,{children:["Check in",e.jsxs("span",{className:"ml-1 px-2 py-0.5 rounded-full bg-white/20 text-xs",children:["+",o.CHECK_IN," XP"]})]})})]})]})},vc=n.memo(()=>e.jsx(jt,{fallback:e.jsx(xh,{}),children:e.jsx(qg,{})}));vc.displayName="MorningCheckIn";const Lg=()=>{const{user:t}=ce(),{profile:s}=yt(),a=Se(),r=n.useMemo(()=>{const h=s?.timezone||"UTC";try{return new Intl.DateTimeFormat("en-CA",{timeZone:h,year:"numeric",month:"2-digit",day:"2-digit"}).format(new Date)}catch{return new Date().toLocaleDateString("en-CA")}},[s?.timezone]),{data:i,isLoading:o,error:c,refetch:l}=ye({queryKey:["morning-briefing",r,t?.id],queryFn:async()=>{if(!t)return null;const{data:h}=await N.from("morning_briefings").select("*").eq("user_id",t.id).eq("briefing_date",r).maybeSingle();return h},enabled:!!t,staleTime:1e3*60*5}),u=ie({mutationFn:async()=>{const{data:h}=await N.from("morning_briefings").select("id").eq("user_id",t?.id).eq("briefing_date",r).maybeSingle();if(h)return await l(),null;const{data:f,error:d}=await N.functions.invoke("generate-morning-briefing");if(d)throw d;if(f.error)throw new Error(f.error);return f.briefing},onSuccess:()=>{a.invalidateQueries({queryKey:["morning-briefing"]})}}),m=ie({mutationFn:async h=>{const{error:f}=await N.from("morning_briefings").update({viewed_at:new Date().toISOString()}).eq("id",h);if(f)throw f},onSuccess:()=>{a.invalidateQueries({queryKey:["morning-briefing"]})}}),p=ie({mutationFn:async h=>{const{error:f}=await N.from("morning_briefings").update({dismissed_at:new Date().toISOString()}).eq("id",h);if(f)throw f},onSuccess:()=>{a.invalidateQueries({queryKey:["morning-briefing"]})}});return{briefing:i,isLoading:o,error:c,refetch:l,generateBriefing:u,markViewed:m,dismissBriefing:p,isGenerating:u.isPending}},wc=n.memo(({onAskMore:t,className:s})=>{const a=Ht(),{toast:r}=Ut(),i=ka(),{briefing:o,isLoading:c,generateBriefing:l,dismissBriefing:u,markViewed:m,isGenerating:p}=Lg(),[h,f]=n.useState(!1),[d,g]=n.useState(!1);n.useEffect(()=>{o&&!o.viewed_at&&m.mutate(o.id)},[o?.id]),n.useEffect(()=>{o?.dismissed_at&&g(!0)},[o?.dismissed_at]);const y=async()=>{try{await l.mutateAsync()}catch(j){console.error("Failed to generate briefing:",j),r({title:"Couldn't generate briefing",description:j instanceof Error?j.message:"Please try again later",variant:"destructive"})}},v=async()=>{if(o){g(!0);try{await u.mutateAsync(o.id)}catch(j){console.error("Failed to dismiss briefing:",j)}}},b=()=>{if(o){if(t){t(o.content,o.action_prompt||"");return}a("/mentor-chat",{state:{initialMessage:o.action_prompt||"Let's discuss my morning briefing",briefingContext:o.content,comprehensiveMode:!0}})}};if(d&&o)return e.jsx(Me,{className:E("p-4 bg-card/25 backdrop-blur-2xl border-white/[0.08] cursor-pointer hover:border-primary/20 transition-colors",s),onClick:()=>g(!1),children:e.jsxs("div",{className:"flex items-center gap-3",children:[i&&e.jsx(ca,{mentorSlug:(i.slug||"").toLowerCase(),mentorName:i.name,primaryColor:i.primary_color||"#000",avatarUrl:i.avatar_url||void 0,size:"sm",showBorder:!0}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h3",{className:"font-semibold text-sm",children:"Morning Briefing"}),e.jsx(Xe,{className:"h-4 w-4 text-primary"})]}),o.todays_focus&&e.jsxs("p",{className:"text-xs text-muted-foreground truncate",children:["Focus: ",o.todays_focus]})]}),e.jsx(Jt,{className:"h-5 w-5 text-muted-foreground flex-shrink-0"})]})});if(c)return e.jsx(Me,{className:E("p-6 animate-pulse bg-card/25 backdrop-blur-2xl border-white/[0.08]",s),children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-12 w-12 rounded-full bg-muted"}),e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx("div",{className:"h-4 bg-muted rounded w-1/3"}),e.jsx("div",{className:"h-3 bg-muted rounded w-2/3"})]})]})});if(!o)return e.jsxs("div",{className:E("rounded-2xl bg-card/25 backdrop-blur-2xl border border-white/[0.08] overflow-hidden shadow-[0_8px_32px_rgba(0,0,0,0.12)]",s),children:[e.jsx("div",{className:"px-4 py-3 sm:px-5 sm:py-4 border-b border-white/[0.06] bg-gradient-to-r from-primary/5 to-accent/[0.02]",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-9 w-9 sm:h-11 sm:w-11 rounded-xl bg-gradient-to-br from-primary/20 to-accent/20 flex items-center justify-center border border-primary/30",children:e.jsx(Rt,{className:"h-4 w-4 sm:h-5 sm:w-5 text-primary"})}),e.jsx("h3",{className:"font-heading font-black text-lg sm:text-2xl tracking-wide text-primary",children:"MORNING BRIEFING"})]})}),e.jsx("div",{className:"p-4 sm:p-5",children:e.jsxs("div",{className:"flex flex-col items-center gap-4",children:[i&&e.jsxs("div",{className:"relative flex-shrink-0",children:[e.jsx("div",{className:"absolute -inset-1 rounded-full bg-gradient-to-br from-red-500 to-pink-500 opacity-70"}),e.jsx(ca,{mentorSlug:(i.slug||"").toLowerCase(),mentorName:i.name,primaryColor:i.primary_color||"#000",avatarUrl:i.avatar_url||void 0,size:"md",showBorder:!1,className:"relative"})]}),e.jsxs("div",{className:"w-full space-y-4 text-center",children:[e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Get personalized insights from ",i?.name||"your mentor"," based on your activity"]}),e.jsx(B,{onClick:y,disabled:p,variant:"cta",className:"w-full h-10 sm:h-12",size:"lg",children:p?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"h-4 w-4 animate-spin"}),"Analyzing your progress..."]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"h-5 w-5"}),"Generate My Briefing"]})})]})]})})]});const x=Array.isArray(o.inferred_goals)?o.inferred_goals:[];return e.jsxs(Me,{className:E("overflow-hidden bg-card/25 backdrop-blur-2xl border-white/[0.08]",s),children:[e.jsx("div",{className:"p-4 sm:p-6 border-b border-white/[0.06]",children:e.jsxs("div",{className:"flex items-start gap-4",children:[i&&e.jsx(ca,{mentorSlug:(i.slug||"").toLowerCase(),mentorName:i.name,primaryColor:i.primary_color||"#000",avatarUrl:i.avatar_url||void 0,size:"md",showBorder:!0,className:"flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("h3",{className:"font-bold text-base sm:text-lg truncate",children:[i?.name||"Your Mentor","'s Briefing"]}),e.jsx(se,{className:"h-4 w-4 text-primary flex-shrink-0"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Personalized insights for today"})]})]})}),x.length>0&&e.jsxs("div",{className:"px-4 sm:px-6 py-3 bg-white/[0.02] border-b border-white/[0.06]",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(zt,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wide",children:"What I see you working toward"})]}),e.jsx("div",{className:"flex flex-wrap gap-2",children:x.map((j,w)=>e.jsx(Ne,{variant:"secondary",className:"bg-primary/10 text-primary border-primary/20",children:j},w))})]}),e.jsxs("div",{className:"p-4 sm:p-6 space-y-4",children:[e.jsx("div",{className:E("text-sm leading-relaxed text-foreground/90 whitespace-pre-wrap",!h&&"line-clamp-4"),children:o.content}),o.content.length>300&&e.jsx(B,{variant:"ghost",size:"sm",onClick:()=>f(!h),className:"text-primary hover:text-primary/80 -ml-2",children:h?"Show less":"Read more"}),o.todays_focus&&e.jsx("div",{className:"bg-white/[0.03] backdrop-blur-xl rounded-2xl p-4 border border-white/[0.08]",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(Ze,{className:"h-5 w-5 text-primary flex-shrink-0 mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground uppercase tracking-wide mb-1",children:"Today's Focus"}),e.jsx("p",{className:"text-sm font-medium text-foreground",children:o.todays_focus})]})]})})]}),e.jsxs("div",{className:"px-4 sm:px-6 pb-4 sm:pb-6 flex flex-col sm:flex-row gap-3",children:[e.jsxs(B,{variant:"outline",onClick:v,className:"flex-1 sm:flex-none",children:[e.jsx(Xe,{className:"h-4 w-4 mr-2"}),"Done"]}),e.jsxs(B,{onClick:b,className:"flex-1 bg-primary hover:bg-primary/90",children:[e.jsx(Za,{className:"h-4 w-4 mr-2"}),"Ask ",i?.name||"Mentor"," More"]})]})]})});wc.displayName="MorningBriefing";const jc=()=>{const{user:t}=ce(),s=Se(),{awardCustomXP:a}=bt(),[r,i]=n.useState(!1),o=Y(new Date,"yyyy-MM-dd"),c=new Date().getHours()>=18,{data:l,isLoading:u}=ye({queryKey:["evening-reflection",t?.id,o],queryFn:async()=>{if(!t?.id)return null;const{data:f,error:d}=await N.from("evening_reflections").select("*").eq("user_id",t.id).eq("reflection_date",o).maybeSingle();if(d)throw d;return f},enabled:!!t?.id}),m=!!l,p=c&&!m&&!u,h=ie({mutationFn:async f=>{if(!t?.id)throw new Error("Not authenticated");const{data:d,error:g}=await N.from("evening_reflections").insert({user_id:t.id,reflection_date:o,mood:f.mood,wins:f.wins||null,gratitude:f.gratitude||null}).select().single();if(g)throw g;return N.functions.invoke("generate-evening-response",{body:{reflectionId:d.id}}).catch(console.error),d},onSuccess:()=>{s.invalidateQueries({queryKey:["evening-reflection"]}),a(3,"evening_reflection","Evening Reflection"),i(!1)}});return{isEvening:c,hasCompletedToday:m,shouldShowBanner:p,todaysReflection:l,isLoading:u,isDrawerOpen:r,setIsDrawerOpen:i,submitReflection:h.mutate,isSubmitting:h.isPending}},Ns=({shouldScaleBackground:t=!0,repositionInputs:s,...a})=>e.jsx(It.Root,{shouldScaleBackground:t,repositionInputs:s,...a});Ns.displayName="Drawer";const _n=It.Trigger,Fg=It.Portal,_c=n.forwardRef(({className:t,...s},a)=>e.jsx(It.Overlay,{ref:a,className:E("fixed inset-0 z-50 bg-black/58 backdrop-blur-[2px]",t),style:{touchAction:"none",WebkitTapHighlightColor:"transparent"},...s}));_c.displayName=It.Overlay.displayName;const ks=n.forwardRef(({className:t,children:s,...a},r)=>e.jsxs(Fg,{children:[e.jsx(_c,{}),e.jsxs(It.Content,{ref:r,className:E("fixed inset-x-0 bottom-0 z-50 mt-24 flex h-auto max-h-[85dvh] flex-col rounded-t-[20px] border border-border/70 bg-card/95 backdrop-blur-xl isolate shadow-[0_-14px_34px_rgba(0,0,0,0.34)]",t),style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent",willChange:"transform"},...a,children:[e.jsx(It.Handle,{className:"mx-auto mt-4 h-1.5 w-[88px] rounded-full bg-muted-foreground/45"}),s]})]}));ks.displayName="DrawerContent";const Cs=({className:t,...s})=>e.jsx("div",{className:E("grid gap-1.5 p-4 text-center sm:text-left",t),...s});Cs.displayName="DrawerHeader";const Nc=({className:t,...s})=>e.jsx("div",{className:E("mt-auto flex flex-col gap-2 p-4",t),...s});Nc.displayName="DrawerFooter";const Ss=n.forwardRef(({className:t,...s},a)=>e.jsx(It.Title,{ref:a,className:E("text-lg font-semibold leading-none tracking-tight",t),...s}));Ss.displayName=It.Title.displayName;const Nn=n.forwardRef(({className:t,...s},a)=>e.jsx(It.Description,{ref:a,className:E("text-sm text-muted-foreground",t),...s}));Nn.displayName=It.Description.displayName;const Og=()=>typeof navigator>"u"?!1:/iPad|iPhone|iPod/.test(navigator.userAgent)||navigator.platform==="MacIntel"&&navigator.maxTouchPoints>1,$g=()=>typeof window.Capacitor<"u",Bg=()=>{if(typeof document>"u")return 0;try{const t=document.createElement("div");t.style.paddingBottom="env(safe-area-inset-bottom, 0px)",document.body.appendChild(t);const s=parseInt(getComputedStyle(t).paddingBottom)||0;return document.body.removeChild(t),s}catch{return 0}};function Hg(t={}){const{enabled:s=!0,offsetBuffer:a=0,animationDuration:r=200}=t,[i,o]=n.useState(0),[c,l]=n.useState(0),u=n.useRef(!1),m=n.useRef([]),p=n.useMemo(()=>Og(),[]),h=n.useMemo(()=>$g(),[]),f=i>0,d=s?i+a:0,g=n.useCallback(()=>{if(!s||!window.visualViewport||u.current)return;u.current=!0;const w=window.visualViewport.height,D=window.innerHeight,S=window.visualViewport.offsetTop,M=Math.max(0,D-w-S);o(C=>Math.abs(C-M)>10||M===0?M:C),u.current=!1},[s]),y=n.useCallback(()=>{m.current.forEach(D=>clearTimeout(D)),m.current=[],[50,150,300,500].forEach(D=>{const S=setTimeout(g,D);m.current.push(S)})},[g]);n.useEffect(()=>{l(Bg())},[]),n.useEffect(()=>{if(!s||!window.visualViewport)return;window.visualViewport.addEventListener("resize",g),window.visualViewport.addEventListener("scroll",g);const w=S=>{const M=S.target;(M?.tagName==="INPUT"||M?.tagName==="TEXTAREA")&&y()},D=()=>{setTimeout(()=>{(!document.activeElement||document.activeElement.tagName!=="INPUT"&&document.activeElement.tagName!=="TEXTAREA")&&o(0)},100)};return document.addEventListener("focusin",w),document.addEventListener("focusout",D),g(),()=>{window.visualViewport?.removeEventListener("resize",g),window.visualViewport?.removeEventListener("scroll",g),document.removeEventListener("focusin",w),document.removeEventListener("focusout",D),m.current.forEach(S=>clearTimeout(S))}},[s,g,y]);const v=n.useCallback(w=>{w.current&&setTimeout(()=>{w.current?.scrollIntoView({behavior:"smooth",block:"center"})},300)},[]),b=n.useCallback(()=>{document.activeElement instanceof HTMLElement&&document.activeElement.blur()},[]),x=n.useMemo(()=>({bottom:d>0?`${d}px`:"0px",transition:`bottom ${r}ms ease-out`}),[d,r]),j=n.useMemo(()=>({touchAction:"manipulation",WebkitTapHighlightColor:"transparent"}),[]);return{keyboardHeight:i,isKeyboardVisible:f,safeAreaBottom:c,totalOffset:d,isIOS:p,isNative:h,containerStyle:x,inputStyle:j,scrollInputIntoView:v,dismissKeyboard:b}}const zg=[{emoji:"ðŸ˜Š",label:"Great",value:"great"},{emoji:"ðŸ™‚",label:"Good",value:"good"},{emoji:"ðŸ˜",label:"Okay",value:"okay"},{emoji:"ðŸ˜”",label:"Low",value:"low"},{emoji:"ðŸ˜¢",label:"Rough",value:"rough"}],Ug=({open:t,onOpenChange:s})=>{const{submitReflection:a,isSubmitting:r}=jc(),[i,o]=n.useState(""),[c,l]=n.useState(""),[u,m]=n.useState(""),p=n.useRef(null),h=n.useRef(null),{containerStyle:f,inputStyle:d,scrollInputIntoView:g}=Hg({offsetBuffer:10}),y=x=>{x||(o(""),l(""),m("")),s(x)},v=()=>{i&&(a({mood:i,wins:c.trim()||void 0,gratitude:u.trim()||void 0}),o(""),l(""),m(""))},b=i.length>0;return e.jsx(Ns,{open:t,onOpenChange:y,shouldScaleBackground:!1,handleOnly:!0,repositionInputs:!1,children:e.jsx(ks,{className:"max-h-[85dvh]",style:f,children:e.jsxs("div",{className:"mx-auto w-full max-w-lg px-4 pb-8 overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",maxHeight:"calc(85dvh - 80px)"},"data-vaul-no-drag":!0,children:[e.jsxs(Cs,{className:"text-center",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-2",children:[e.jsx(ma,{className:"h-6 w-6 text-purple-400"}),e.jsx(Ss,{className:"text-xl",children:"Evening Reflection"})]}),e.jsx(Nn,{children:"Take a moment to reflect on your day"})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsx("label",{className:"text-sm font-medium text-foreground",children:"How are you feeling tonight?"}),e.jsx("div",{className:"flex justify-center gap-2",children:zg.map(x=>e.jsxs("button",{onClick:()=>o(x.value),className:`flex flex-col items-center gap-1 p-3 rounded-xl transition-all ${i===x.value?"bg-primary/20 border-2 border-primary scale-105":"bg-muted/50 border-2 border-transparent hover:bg-muted"}`,children:[e.jsx("span",{className:"text-2xl",children:x.emoji}),e.jsx("span",{className:"text-xs text-muted-foreground",children:x.label})]},x.value))})]}),e.jsxs("div",{className:"space-y-2","data-vaul-no-drag":!0,children:[e.jsxs("label",{className:"text-sm font-medium text-foreground",children:["What went well today? ",e.jsx("span",{className:"text-muted-foreground",children:"(optional)"})]}),e.jsx(xt,{ref:p,placeholder:"A small win, a moment of joy, something you accomplished...",value:c,onChange:x=>l(x.target.value.slice(0,280)),onFocus:()=>g(p),className:"resize-none h-20 bg-muted/30 border-border/50",style:d}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[c.length,"/280"]})]}),e.jsxs("div",{className:"space-y-2","data-vaul-no-drag":!0,children:[e.jsxs("label",{className:"text-sm font-medium text-foreground",children:["What are you grateful for? ",e.jsx("span",{className:"text-muted-foreground",children:"(optional)"})]}),e.jsx(xt,{ref:h,placeholder:"Something or someone you appreciate today...",value:u,onChange:x=>m(x.target.value.slice(0,280)),onFocus:()=>g(h),className:"resize-none h-20 bg-muted/30 border-border/50",style:d}),e.jsxs("p",{className:"text-xs text-muted-foreground text-right",children:[u.length,"/280"]})]}),e.jsx(B,{onClick:v,disabled:!b||r,className:"w-full h-12 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-500 hover:to-pink-500",children:r?"Saving...":e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4"}),"Complete Reflection",e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-white/20",children:"+3 XP"})]})})]})]})})})},kc=n.memo(()=>{const{shouldShowBanner:t,isDrawerOpen:s,setIsDrawerOpen:a}=jc();return t?e.jsxs(e.Fragment,{children:[e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mx-4",children:e.jsxs("button",{onClick:()=>a(!0),className:"relative w-full p-4 rounded-2xl bg-gradient-to-r from-indigo-600/30 via-purple-600/30 to-pink-600/30 border border-purple-500/40 backdrop-blur-sm hover:border-purple-400/60 hover:shadow-lg hover:shadow-purple-500/20 transition-all duration-300 group overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 overflow-hidden rounded-2xl",children:e.jsx("div",{className:"absolute inset-0 -translate-x-full animate-[shimmer-sweep_3s_ease-in-out_infinite] bg-gradient-to-r from-transparent via-white/20 to-transparent skew-x-12"})}),e.jsxs("div",{className:"absolute inset-0 overflow-hidden rounded-2xl pointer-events-none",children:[e.jsx(_.div,{animate:{opacity:[.3,.7,.3],scale:[.8,1.1,.8]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},className:"absolute top-2 right-8",children:e.jsx(se,{className:"h-3 w-3 text-purple-300/60"})}),e.jsx(_.div,{animate:{opacity:[.5,.9,.5],scale:[1,1.2,1]},transition:{duration:2.5,repeat:1/0,ease:"easeInOut",delay:.5},className:"absolute bottom-3 right-16",children:e.jsx(se,{className:"h-2 w-2 text-pink-300/50"})})]}),e.jsx("div",{className:"absolute inset-0 rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-300 bg-gradient-to-r from-indigo-500/10 via-purple-500/10 to-pink-500/10"}),e.jsxs("div",{className:"relative flex items-center gap-3",children:[e.jsx(_.div,{className:"p-2.5 rounded-full bg-gradient-to-br from-purple-500/30 to-indigo-500/30 border border-purple-400/30 group-hover:border-purple-300/50 transition-all duration-300",animate:{boxShadow:["0 0 0 0 rgba(168, 85, 247, 0)","0 0 15px 2px rgba(168, 85, 247, 0.3)","0 0 0 0 rgba(168, 85, 247, 0)"]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx(ma,{className:"h-5 w-5 text-purple-200 group-hover:text-purple-100 transition-colors"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-semibold text-foreground group-hover:text-white transition-colors",children:"Evening Reflection"}),e.jsx("p",{className:"text-sm text-muted-foreground group-hover:text-purple-200/80 transition-colors",children:"How was your day? âœ¨"})]}),e.jsx(_.div,{className:"text-xs px-3 py-1.5 rounded-full bg-gradient-to-r from-primary/30 to-purple-500/30 text-primary font-bold border border-primary/30 group-hover:border-primary/50 transition-all",animate:{scale:[1,1.05,1]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"},children:"+3 XP"})]})]})}),e.jsx(Ug,{open:s,onOpenChange:a})]}):null});kc.displayName="EveningReflectionBanner";const Cc=n.memo(()=>{const{currentRecap:t,openRecap:s}=dc();if(!t)return null;const a=At(t.week_start_date),r=At(t.week_end_date),i=`${Y(a,"MMM d")} - ${Y(r,"MMM d")}`;return e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mx-4",children:e.jsx("button",{onClick:()=>s(t),className:"w-full p-4 rounded-2xl bg-gradient-to-r from-stardust-gold/10 via-amber-500/5 to-celestial-blue/5 border border-white/[0.08] backdrop-blur-2xl hover:border-stardust-gold/30 transition-all group shadow-[0_8px_32px_rgba(0,0,0,0.12)]",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full bg-stardust-gold/20 group-hover:bg-stardust-gold/30 transition-colors",children:e.jsx(se,{className:"h-5 w-5 text-stardust-gold"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-medium text-foreground",children:"Your Week in Review"}),e.jsx("p",{className:"text-sm text-celestial-blue",children:i})]}),!t.viewed_at&&e.jsx("div",{className:"text-xs px-2 py-1 rounded-full bg-stardust-gold/20 text-stardust-gold font-medium",children:"+5 XP"}),e.jsx(tt,{className:"h-5 w-5 text-muted-foreground group-hover:text-stardust-gold transition-colors"})]})})})});Cc.displayName="WeeklyRecapCard";function Wg(){const{user:t}=ce(),s=Se(),{data:a,isLoading:r,error:i,refetch:o}=ye({queryKey:["daily-plan-optimization",t?.id],queryFn:async()=>{if(!t)return null;const{data:f,error:d}=await N.functions.invoke("optimize-daily-plan");if(d)throw console.error("Error fetching daily plan optimization:",d),d;return f},enabled:!!t,staleTime:300*1e3,gcTime:900*1e3,refetchOnWindowFocus:!1}),c=ie({mutationFn:async f=>{const{data:d,error:g}=await N.functions.invoke("generate-daily-plan",{body:f});if(g)throw console.error("Error generating daily plan:",g),g;return d},onSuccess:()=>{s.invalidateQueries({queryKey:["daily-tasks"]}),s.invalidateQueries({queryKey:["calendar-tasks"]})}}),l=n.useCallback(async f=>{if(!t)return null;const d=f?{energyLevel:f.energyLevel,dayType:f.dayType,focusArea:f.focusArea}:{},{data:g,error:y}=await N.functions.invoke("optimize-daily-plan",{body:d});if(y)throw console.error("Error fetching daily plan optimization with answers:",y),y;return g},[t]),u=a?.insights??[],m=u.filter(f=>f.priority==="high"),p=u.some(f=>f.type==="warning"),h=u.some(f=>f.type==="encouragement");return{insights:u,highPriorityInsights:m,energyForecast:a?.energyForecast,overallReadiness:a?.overallReadiness??0,suggestedSchedule:a?.suggestedSchedule,hasWarnings:p,hasEncouragement:h,isLoading:r,error:i instanceof Error?i.message:null,refetch:o,optimizeWithAnswers:l,generatePlan:c.mutateAsync,isGenerating:c.isPending,generateError:c.error}}const Qg={optimization:{icon:Be,color:"text-blue-500",bgColor:"bg-blue-500/10",borderColor:"border-blue-500/30"},warning:{icon:ps,color:"text-amber-500",bgColor:"bg-amber-500/10",borderColor:"border-amber-500/30"},encouragement:{icon:zt,color:"text-green-500",bgColor:"bg-green-500/10",borderColor:"border-green-500/30"},suggestion:{icon:mn,color:"text-purple-500",bgColor:"bg-purple-500/10",borderColor:"border-purple-500/30"}},Kg=n.memo(function({insight:s,onAction:a,onDismiss:r}){const i=Qg[s.type],o=i.icon;return e.jsx(_.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},exit:{opacity:0,x:10},children:e.jsx("div",{className:E("rounded-2xl backdrop-blur-2xl border-l-4 border-t border-r border-b bg-card/25 p-4",i.borderColor.replace("border-","border-l-"),"border-t-white/[0.08] border-r-white/[0.08] border-b-white/[0.08]"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:E("p-2 rounded-lg flex-shrink-0",i.bgColor),children:e.jsx(o,{className:E("h-4 w-4",i.color)})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center justify-between gap-2 mb-1",children:[e.jsx("p",{className:"text-sm font-bold text-foreground",children:s.title}),r&&s.priority!=="high"&&e.jsx(B,{variant:"ghost",size:"icon",className:"h-6 w-6 opacity-50 hover:opacity-100",onClick:()=>r(s),children:e.jsx(Qe,{className:"h-3 w-3"})})]}),e.jsx("p",{className:"text-xs text-muted-foreground leading-relaxed",children:s.message}),s.actionLabel&&a&&e.jsxs("button",{className:E("mt-2 text-xs font-bold uppercase tracking-wide flex items-center gap-1",i.color),onClick:()=>a(s),children:[s.actionLabel,e.jsx(tt,{className:"h-3 w-3"})]})]})]})})})}),Gg=n.memo(function({compact:s=!1,maxInsights:a=3,onInsightAction:r}){const{insights:i,isLoading:o}=Wg();if(o)return e.jsx("div",{className:"rounded-2xl bg-card/25 backdrop-blur-2xl border border-white/[0.08] p-4",children:e.jsxs("div",{className:"flex items-center gap-2 text-muted-foreground",children:[e.jsx(se,{className:"h-4 w-4 animate-pulse"}),e.jsx("span",{className:"text-sm",children:"Analyzing your day..."})]})});if(i.length===0)return null;const c=i.slice(0,a);return e.jsx("div",{className:"space-y-4",children:e.jsx(be,{mode:"popLayout",children:e.jsx("div",{className:"space-y-3",children:c.map((l,u)=>e.jsx(Kg,{insight:l,onAction:r},`${l.type}-${l.title}-${u}`))})})})}),_i={primary:{glow:"bg-primary/30",iconWrap:"from-primary/20 to-primary/5",icon:"text-primary",featureWrap:"bg-primary/10",featureIcon:"text-primary",button:"bg-primary hover:bg-primary/90 shadow-primary/25"},accent:{glow:"bg-accent/30",iconWrap:"from-accent/20 to-accent/5",icon:"text-accent",featureWrap:"bg-accent/10",featureIcon:"text-accent",button:"bg-accent hover:bg-accent/90 shadow-accent/25"},"celestial-blue":{glow:"bg-celestial-blue/30",iconWrap:"from-celestial-blue/20 to-celestial-blue/5",icon:"text-celestial-blue",featureWrap:"bg-celestial-blue/10",featureIcon:"text-celestial-blue",button:"bg-celestial-blue hover:bg-celestial-blue/90 shadow-celestial-blue/25"},"stardust-gold":{glow:"bg-stardust-gold/25",iconWrap:"from-stardust-gold/20 to-stardust-gold/5",icon:"text-stardust-gold",featureWrap:"bg-stardust-gold/10",featureIcon:"text-stardust-gold",button:"bg-stardust-gold hover:bg-stardust-gold/90 shadow-stardust-gold/25 text-black"},destructive:{glow:"bg-destructive/25",iconWrap:"from-destructive/20 to-destructive/5",icon:"text-destructive",featureWrap:"bg-destructive/10",featureIcon:"text-destructive",button:"bg-destructive hover:bg-destructive/90 shadow-destructive/25"}};function Sc({open:t,onClose:s,icon:a,title:r,subtitle:i,features:o,footerHint:c,buttonText:l="Continue",accentColor:u="primary"}){const m=_i[u]??_i.primary;return e.jsx(ct,{open:t,onOpenChange:p=>!p&&s(),children:e.jsx(ot,{className:"max-w-sm rounded-3xl border-border/70 bg-card/90 p-0 shadow-[0_24px_46px_rgba(0,0,0,0.34)] backdrop-blur-2xl overflow-hidden",hideCloseButton:!0,children:e.jsxs(_.div,{initial:{opacity:0,y:40,scale:.95},animate:{opacity:1,y:0,scale:1},transition:{type:"spring",damping:25,stiffness:300},children:[e.jsxs("div",{className:"pt-8 pb-4 flex flex-col items-center",children:[e.jsxs(_.div,{initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.1,type:"spring",damping:15},className:"relative",children:[e.jsx("div",{className:E("absolute inset-0 rounded-full blur-2xl scale-150",m.glow)}),e.jsx("div",{className:E("relative w-16 h-16 rounded-2xl bg-gradient-to-br flex items-center justify-center border border-white/10 shadow-lg",m.iconWrap),children:e.jsx(a,{className:E("w-8 h-8",m.icon)})})]}),e.jsx(_.h2,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.15},className:"mt-5 text-xl font-semibold tracking-tight text-foreground",children:r}),e.jsx(_.p,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.2},className:"mt-2 text-sm text-muted-foreground text-center px-6 leading-relaxed",children:i})]}),e.jsx("div",{className:"px-5 pb-4",children:e.jsx("div",{className:"rounded-2xl bg-card/50 backdrop-blur-sm divide-y divide-border/30 overflow-hidden",children:o.map((p,h)=>{const f=p.icon;return e.jsxs(_.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:.25+h*.05},className:"flex items-center gap-3 px-4 py-3.5",children:[e.jsx("div",{className:E("w-8 h-8 rounded-xl flex items-center justify-center flex-shrink-0",m.featureWrap),children:e.jsx(f,{className:E("w-4 h-4",m.featureIcon)})}),e.jsx("span",{className:"text-sm text-foreground/90",children:p.text})]},h)})})}),c&&e.jsx(_.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.4},className:"px-6 pb-2 text-xs text-muted-foreground text-center",children:c}),e.jsx("div",{className:"px-5 pb-6 pt-2",children:e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.45},children:e.jsx(B,{onClick:s,className:E("w-full h-12 rounded-full text-base shadow-lg transition-all duration-200 active:scale-[0.98]",m.button),children:l})})})]})})})}const Yg=[{icon:pn,text:"Listen to daily pep talks for motivation"},{icon:Fo,text:"Morning & evening check-ins to track your mood"},{icon:hn,text:"Ask questions anytime for personalized guidance"},{icon:se,text:"Unlock unique mentor personalities and styles"}];function Vg({open:t,onClose:s}){return e.jsx(Sc,{open:t,onClose:s,icon:Za,title:"Meet Your Mentor",subtitle:"Your personal guide to motivate and help you stay on track with your goals.",features:Yg,footerHint:"Chat with your mentor below to get started!",buttonText:"Continue"})}function kn(t){const{user:s}=ce(),a=s?.id,[r,i]=n.useState(!1),o=n.useRef(!1);n.useEffect(()=>{o.current=!1},[a]),n.useEffect(()=>{if(!a||o.current)return;o.current=!0;const l=`tab_intro_${t}_${a}`;qe.getItem(l)||i(!0)},[a,t]);const c=n.useCallback(()=>{if(i(!1),a){const l=`tab_intro_${t}_${a}`;qe.setItem(l,"true")}},[a,t]);return{showModal:r,dismissModal:c}}const Dt=({children:t,offset:s=20,stiffness:a=100,damping:r=30,className:i})=>{const o=n.useRef(null),c=ss(),l=n.useMemo(()=>{if(typeof window>"u")return!1;const y=window.Capacitor;return!!(y?.isNativePlatform?.()&&y?.getPlatform?.()==="ios")},[]),u=c||l,{scrollYProgress:m}=Bu({target:o,offset:["start end","end start"]}),p=Yt(m,[0,1],[s*.65,-s*.65]),h=Fn(p,{stiffness:a,damping:r}),f=Yt(m,[0,.5,1],[.992,1,.992]),d=Fn(f,{stiffness:170,damping:36}),g=Yt(m,[0,.3,.7,1],[.9,1,1,.9]);return u?e.jsx("div",{className:E(i),children:t}):e.jsx(_.div,{ref:o,style:{y:h,scale:d,opacity:g,willChange:"transform, opacity"},className:E(i),children:t})},Ni=.15,Xg=({enabled:t=!0}={})=>{const[s,a]=n.useState({gamma:0,beta:0,permitted:!1,available:typeof DeviceOrientationEvent<"u"}),r=n.useRef(0),i=n.useRef(0),o=n.useRef(0),c=n.useRef(0),l=n.useCallback(async()=>{if(!t)return!1;if(typeof DeviceOrientationEvent<"u"&&typeof DeviceOrientationEvent.requestPermission=="function")try{return await DeviceOrientationEvent.requestPermission()==="granted"?(a(f=>({...f,permitted:!0})),!0):!1}catch{return!1}return a(h=>({...h,permitted:!0})),!0},[t]);n.useEffect(()=>{if(!t||!s.available)return;const h=f=>{o.current=f.gamma??0,c.current=f.beta??0,r.current=r.current+Ni*(o.current-r.current),i.current=i.current+Ni*(c.current-i.current),a(d=>({...d,gamma:r.current,beta:i.current,permitted:!0}))};return window.addEventListener("deviceorientation",h),()=>{window.removeEventListener("deviceorientation",h)}},[t,s.available]);const u=n.useCallback((h=5,f=2.5)=>{const{gamma:d}=s,y=(Math.abs(d)<h?0:d)/30*50*f;return Math.max(8,Math.min(92,50+y))},[s]),m=n.useCallback((h=8,f=1.5)=>{const{beta:d}=s,g=d>=0?1:-1,y=Math.abs(d),b=(y<h?g*(y*y/h):g*y)/50*50*f;return Math.max(3,Math.min(97,50+b))},[s]),p=n.useCallback(()=>({gamma:o.current,beta:c.current}),[]);return{...s,requestPermission:l,getPositionFromTilt:u,getLandscapePositionFromTilt:m,getRawOrientation:p}},Jg={dawn:{white:.35,blue:.1,pink:.2,gold:.25,teal:.05,orange:.05},morning:{white:.4,blue:.25,pink:.1,gold:.1,teal:.1,orange:.05},afternoon:{white:.35,blue:.15,pink:.1,gold:.2,teal:.15,orange:.05},sunset:{white:.25,blue:.05,pink:.25,gold:.2,teal:.05,orange:.2},night:{white:.4,blue:.25,pink:.15,gold:.1,teal:.1,orange:0}},Zg=()=>{const{period:t,progress:s,colors:a,rotationHue:r}=wp(),i=n.useMemo(()=>Jg[t],[t]),o=n.useMemo(()=>()=>{const m=Math.random(),p=i;let h=0;return(h+=p.orange)>m&&p.orange>0?"orange":(h+=p.gold)>m?"gold":(h+=p.teal)>m?"teal":(h+=p.pink)>m?"pink":(h+=p.blue)>m?"blue":"white"},[i]),c=(m,p=0)=>{const h={white:[0,0,100],blue:[200,85,70],pink:[320,60,75],gold:[45,100,65],teal:[175,70,60],orange:[25,90,65]},[f,d,g]=h[m];return`hsl(${m==="white"?f:(f+p)%360}, ${d}%, ${g}%)`};return{period:t,progress:s,colors:a,rotationHue:r,starDistribution:i,getStarColorForPeriod:o,getStarHSL:c,getStarGlow:(m,p,h=0)=>{const f=c(m,h);return m==="white"?`0 0 6px hsla(0, 0%, 100%, ${p})`:`0 0 8px ${f.replace(")",` / ${p})`).replace("hsl","hsla")}, 0 0 16px ${f.replace(")",` / ${p*.5})`).replace("hsl","hsla")}`},getNebulaGradient:m=>{const p=`nebula${m}`;return a[p]}}},Hr=(t,s,a,r,i)=>Array.from({length:t},(o,c)=>({id:c,x:Math.random()*100,y:Math.random()*100,size:Math.random()*(a-s)+s,opacity:Math.random()*(i-r)+r,animationDelay:Math.random()*10,animationDuration:Math.random()*4+4,colorSeed:Math.random()})),ex=t=>Array.from({length:t},(s,a)=>({id:a,x:Math.random()*100,y:Math.random()*100,size:Math.random()*.5+.5,opacity:Math.random()*.15+.1,driftDuration:Math.random()*60+60,driftDelay:Math.random()*30})),tx=()=>[{id:1,delay:5,duration:90,startX:15,startY:10,angle:35},{id:2,delay:45,duration:120,startX:85,startY:8,angle:145},{id:3,delay:75,duration:150,startX:50,startY:5,angle:80}],fs={deepNebulae:1,dust:2,backgroundStars:3,midNebulae:4,midStars:5,foregroundNebulae:6,brightStars:8},Ta=n.memo(()=>{const[t,s]=n.useState(!1),a=n.useRef(null),r=n.useRef(null),i=n.useRef({x:0,y:0}),o=n.useMemo(()=>{if(typeof window>"u")return!1;const k=window.Capacitor;return!!(k?.isNativePlatform?.()&&k?.getPlatform?.()==="ios")},[]),c=t||o,{gamma:l,beta:u,permitted:m}=Xg({enabled:!c}),{period:p,colors:h,rotationHue:f,starDistribution:d,getStarHSL:g,getStarGlow:y}=Zg(),{presence:v}=dr(),b=n.useMemo(()=>{const{mood:k}=v;let P=0;switch(k){case"joyful":P=10;break;case"content":P=5;break;case"neutral":P=0;break;case"reserved":P=-5;break;case"quiet":P=-10;break;case"dormant":P=0;break}return P},[v]);n.useEffect(()=>{const k=window.matchMedia("(prefers-reduced-motion: reduce)");s(k.matches);const P=()=>s(k.matches);return k.addEventListener("change",P),()=>k.removeEventListener("change",P)},[]);const x=n.useCallback((k,P)=>{i.current={x:k,y:P},r.current===null&&(r.current=requestAnimationFrame(()=>{r.current=null,a.current&&(a.current.style.setProperty("--parallax-x",String(i.current.x)),a.current.style.setProperty("--parallax-y",String(i.current.y)))}))},[]);n.useEffect(()=>{if(c){x(0,0);return}const k=P=>{const A=(P.clientX/window.innerWidth-.5)*2,L=(P.clientY/window.innerHeight-.5)*2;x(A,L)};return window.addEventListener("mousemove",k,{passive:!0}),()=>window.removeEventListener("mousemove",k)},[x,c]),n.useEffect(()=>{if(c||!m)return;const k=Math.max(-1,Math.min(1,l/30)),P=Math.max(-1,Math.min(1,(u-45)/30));x(k,P)},[l,u,m,x,c]),n.useEffect(()=>()=>{r.current!==null&&cancelAnimationFrame(r.current)},[]);const j=n.useCallback(k=>c?{}:{transform:`translate(calc(var(--parallax-x, 0) * ${k}px), calc(var(--parallax-y, 0) * ${k}px))`,transition:"transform 0.22s ease-out",willChange:"transform"},[c]),w=n.useCallback(k=>{const P=d;let A=0;return(A+=P.orange)>k&&P.orange>0?"orange":(A+=P.gold)>k?"gold":(A+=P.teal)>k?"teal":(A+=P.pink)>k?"pink":(A+=P.blue)>k?"blue":"white"},[d]),D=n.useMemo(()=>ex(c?8:14),[c]),S=n.useMemo(()=>Hr(c?10:14,.8,1.5,.3,.5),[c]),M=n.useMemo(()=>Hr(c?5:8,1.5,2.5,.4,.7),[c]),C=n.useMemo(()=>Hr(c?2:4,2.5,4,.7,1),[c]),R=n.useMemo(()=>c?[]:tx(),[c]),T=n.useMemo(()=>({dawn:"linear-gradient(to bottom, hsl(350, 30%, 12%), hsl(25, 25%, 10%), hsl(240, 15%, 8%))",morning:"linear-gradient(to bottom, hsl(200, 35%, 12%), hsl(190, 25%, 10%), hsl(240, 15%, 8%))",afternoon:"linear-gradient(to bottom, hsl(35, 30%, 12%), hsl(180, 20%, 10%), hsl(240, 15%, 8%))",sunset:"linear-gradient(to bottom, hsl(340, 35%, 15%), hsl(20, 30%, 12%), hsl(270, 25%, 10%))",night:"linear-gradient(to bottom, hsl(240, 30%, 10%), hsl(250, 20%, 8%), hsl(0, 0%, 5%))"})[p],[p]),q=f*.1+b;return e.jsxs("div",{ref:a,className:"fixed inset-0 overflow-hidden pointer-events-none -z-10",children:[e.jsx("div",{className:"absolute inset-0 transition-all [transition-duration:3000ms]",style:{background:T}}),e.jsxs("div",{className:"absolute inset-0",style:j(fs.deepNebulae),children:[e.jsx("div",{className:"absolute w-[900px] h-[900px] rounded-full blur-[150px] transition-colors [transition-duration:5000ms]",style:{top:"-15%",right:"-10%",background:`radial-gradient(ellipse at center, ${h.nebula1.replace(")"," / 0.25)")}, transparent 70%)`,animation:c?"none":"nebula-drift-slow 55s ease-in-out infinite"}}),e.jsx("div",{className:"absolute w-[800px] h-[800px] rounded-full blur-[140px] transition-colors [transition-duration:5000ms]",style:{bottom:"-20%",left:"-15%",background:`radial-gradient(ellipse at center, ${h.nebula2.replace(")"," / 0.2)")}, transparent 70%)`,animation:c?"none":"nebula-drift-slow 65s ease-in-out infinite reverse"}})]}),e.jsx("div",{className:"absolute inset-0",style:j(fs.dust),children:D.map(k=>e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:3000ms]",style:{left:`${k.x}%`,top:`${k.y}%`,width:`${k.size}px`,height:`${k.size}px`,opacity:k.opacity,backgroundColor:`${h.nebula3.replace(")"," / 0.4)")}`}},`dust-${k.id}`))}),e.jsx("div",{className:"absolute inset-0",style:j(fs.backgroundStars),children:S.map(k=>{const P=w(k.colorSeed);return e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:2000ms]",style:{left:`${k.x}%`,top:`${k.y}%`,width:`${k.size}px`,height:`${k.size}px`,opacity:k.opacity,backgroundColor:g(P,q),boxShadow:y(P,k.opacity*.5,q),animation:c?"none":`twinkle ${k.animationDuration}s ease-in-out ${k.animationDelay}s infinite`}},`bg-star-${k.id}`)})}),e.jsxs("div",{className:"absolute inset-0 opacity-30",style:j(fs.midNebulae),children:[e.jsx("div",{className:"absolute w-[600px] h-[300px] blur-[100px] -rotate-12 transition-colors [transition-duration:5000ms]",style:{top:"10%",right:"5%",background:`linear-gradient(135deg, ${h.nebula1.replace(")"," / 0.35)")}, ${h.nebula3.replace(")"," / 0.15)")}, transparent)`}}),e.jsx("div",{className:"absolute w-[500px] h-[250px] blur-[90px] rotate-12 transition-colors [transition-duration:5000ms]",style:{bottom:"15%",left:"10%",background:`linear-gradient(135deg, ${h.nebula2.replace(")"," / 0.3)")}, ${h.accent.replace(")"," / 0.15)")}, transparent)`}})]}),e.jsx("div",{className:"absolute inset-0",style:j(fs.midStars),children:M.map(k=>{const P=w(k.colorSeed);return e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:2000ms]",style:{left:`${k.x}%`,top:`${k.y}%`,width:`${k.size}px`,height:`${k.size}px`,opacity:k.opacity,backgroundColor:g(P,q),boxShadow:y(P,k.opacity,q)}},`mid-star-${k.id}`)})}),e.jsxs("div",{className:"absolute inset-0 opacity-25",style:j(fs.foregroundNebulae),children:[e.jsx("div",{className:"absolute w-[350px] h-[350px] rounded-full blur-[70px] transition-colors [transition-duration:5000ms]",style:{top:"25%",right:"20%",background:`radial-gradient(ellipse at center, ${h.primary.replace(")"," / 0.5)")}, transparent 60%)`,animation:c?"none":"nebula-pulse 25s ease-in-out infinite"}}),e.jsx("div",{className:"absolute w-[300px] h-[300px] rounded-full blur-[60px] transition-colors [transition-duration:5000ms]",style:{bottom:"30%",left:"25%",background:`radial-gradient(ellipse at center, ${h.accent.replace(")"," / 0.45)")}, transparent 60%)`,animation:c?"none":"nebula-pulse 30s ease-in-out 8s infinite reverse"}})]}),e.jsx("div",{className:"absolute inset-0",style:j(fs.brightStars),children:C.map(k=>{const P=w(k.colorSeed),A=g(P,q);return e.jsx("div",{className:"absolute rounded-full transition-colors [transition-duration:2000ms]",style:{left:`${k.x}%`,top:`${k.y}%`,width:`${k.size}px`,height:`${k.size}px`,backgroundColor:A,boxShadow:`${y(P,1,q)}, 0 0 20px ${A}`}},`bright-star-${k.id}`)})}),!c&&R.map(k=>e.jsx("div",{className:"absolute w-[3px] h-[3px] rounded-full",style:{left:`${k.startX}%`,top:`${k.startY}%`,background:"linear-gradient(to right, transparent, white, white)",boxShadow:"0 0 6px 2px rgba(255, 255, 255, 0.9), -20px 0 15px rgba(255, 255, 255, 0.4), -40px 0 25px rgba(255, 255, 255, 0.2)",animation:`shooting-star-${k.id} ${k.duration}s ease-out ${k.delay}s infinite`}},`shooting-${k.id}`))]})});Ta.displayName="StarfieldBackground";const sx=({enableOnboardingGuard:t=!1})=>{const{user:s}=ce(),{profile:a,loading:r}=yt(),{companion:i,isLoading:o}=st(),{isTransitioning:c}=hp(),l=Ht(),u=Se(),{showModal:m,dismissModal:p}=kn("mentor");n.useEffect(()=>{window.scrollTo(0,0)},[]);const h=n.useMemo(()=>Us(a),[a]);n.useEffect(()=>{(async()=>{if(!s||!a)return;const S=zl(a);if(!(a.onboarding_completed&&!a.selected_mentor_id&&S))return;const{error:C}=await N.from("profiles").update({selected_mentor_id:S}).eq("id",s.id);if(C){if(console.error("Failed to backfill mentor selection:",C),Zp(C)){const R=Jp(a.onboarding_data),{error:T}=await N.from("profiles").update({onboarding_data:R}).eq("id",s.id);T?console.error("Failed to clear stale onboarding mentor ID:",T):await u.refetchQueries({queryKey:["profile",s.id]})}return}await u.refetchQueries({queryKey:["profile",s.id]})})()},[a,u,s]);const{data:f,isLoading:d,isError:g}=ye({queryKey:["mentor-page-data",h],queryFn:async()=>{if(!h)return null;const{data:D,error:S}=await N.from("mentors").select("avatar_url, slug").eq("id",h).maybeSingle();if(S)throw S;if(!D)return null;const M=D.avatar_url||await mc(D.slug||"atlas"),C=new Date().toLocaleDateString("en-CA"),{data:R,error:T}=await N.from("daily_pep_talks").select("topic_category").eq("for_date",C).eq("mentor_slug",D.slug).maybeSingle();if(T)throw T;let q=null;if(R?.topic_category){const{data:k,error:P}=await N.from("quotes").select("text, author").eq("category",R.topic_category).limit(10);if(P)throw P;let A=k;if(!A||A.length===0){const{data:L,error:H}=await N.from("quotes").select("text, author").limit(20);if(H)throw H;A=L}A&&A.length>0&&(q=A[Math.floor(Math.random()*A.length)])}return{mentorImage:M,todaysQuote:q}},enabled:!!h,staleTime:300*1e3,placeholderData:D=>D}),y=f?.mentorImage||"",v=f?.todaysQuote||null,b=n.useMemo(()=>s?!r&&!o&&(!!!h||!!f||!d):!1,[s,r,o,h,f,d]),x=!t&&(!h||!!h&&!d&&!f&&!g),j=!t&&!!h&&!d&&!f&&g,w=n.useCallback(D=>{switch(D.actionType){default:l("/journeys")}},[l]);return n.useEffect(()=>{if(!t||!s||!b||!a||a.onboarding_completed===!0)return;const D=!h,S=a.onboarding_completed===!1;(D||S||!i&&!o)&&l("/onboarding")},[t,s,b,a,i,o,l,h]),c||!b?e.jsx(Mf,{}):!r&&!o&&!a?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background p-4",children:e.jsxs("div",{className:"text-center space-y-4 max-w-md",children:[e.jsx("div",{className:"h-12 w-12 mx-auto rounded-full bg-destructive/10 flex items-center justify-center",children:e.jsx("span",{className:"text-2xl",children:"âš ï¸"})}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold mb-2",children:"Unable to Load Profile"}),e.jsx("p",{className:"text-muted-foreground mb-4",children:"We couldn't load your profile data. Please check your connection and try again."}),e.jsx("button",{onClick:()=>window.location.reload(),className:"px-4 py-2 bg-primary text-primary-foreground rounded-lg hover:bg-primary/90",children:"Retry"})]})]})}):e.jsxs(Sa,{mode:t?"animated":"instant",children:[e.jsx(Ta,{}),y&&e.jsxs("div",{className:"fixed inset-0 z-0 pointer-events-none",children:[e.jsx("img",{src:y,alt:"Mentor background",className:"w-full h-full object-cover object-center",loading:"eager",decoding:"async"}),e.jsx("div",{className:"absolute inset-0 bg-background/85"})]}),e.jsx("div",{className:"relative z-10 min-h-screen pb-nav-safe pt-safe",children:e.jsxs("div",{className:"max-w-6xl mx-auto px-3 sm:px-4 pt-28 sm:pt-24 md:pt-20 space-y-4 sm:space-y-6 md:space-y-8",children:[j&&e.jsx("div",{className:"mx-4 sm:mx-6 rounded-2xl border border-destructive/45 bg-card/40 backdrop-blur-2xl p-4 sm:p-5 shadow-[0_8px_30px_rgba(0,0,0,0.18)]",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-base sm:text-lg font-bold",children:"Mentor temporarily unavailable"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"We could not refresh your mentor data right now. Try again in a moment."})]}),e.jsx(B,{onClick:()=>{u.refetchQueries({queryKey:["mentor-page-data"]}),u.refetchQueries({queryKey:["mentor-personality"]})},className:"sm:self-start",variant:"outline",children:"Retry"})]})}),x&&e.jsx("div",{className:"mx-4 sm:mx-6 rounded-2xl border border-primary/35 bg-card/40 backdrop-blur-2xl p-4 sm:p-5 shadow-[0_8px_30px_rgba(0,0,0,0.18)]",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-base sm:text-lg font-bold",children:"Mentor connection lost"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Reconnect a mentor to restore personalized briefings, pep talks, and chat."})]}),e.jsx(B,{onClick:()=>l("/mentor-selection"),className:"sm:self-start",children:"Reconnect Mentor"})]})}),v&&e.jsx("div",{className:"text-right px-4 sm:px-6",children:e.jsxs("blockquote",{className:"max-w-2xl ml-auto",children:[e.jsxs("p",{className:"font-serif italic text-lg sm:text-xl md:text-2xl text-foreground/90 leading-relaxed",children:['"',v.text,'"']}),v.author&&e.jsxs("footer",{className:"mt-2 font-serif italic text-sm sm:text-base text-muted-foreground",children:["â€” ",v.author]})]})}),e.jsx(Dt,{offset:14,children:e.jsx(jt,{children:e.jsx(vc,{})})}),e.jsx(Dt,{offset:12,children:e.jsx(jt,{children:e.jsx(wc,{})})}),e.jsx(Dt,{offset:10,children:e.jsx(jt,{children:e.jsx(kc,{})})}),e.jsx(Dt,{offset:10,children:e.jsx(jt,{children:e.jsx(Cc,{})})}),e.jsx(Dt,{offset:9,children:e.jsx(jt,{children:e.jsx(Gg,{maxInsights:3,onInsightAction:w})})}),e.jsx(Dt,{offset:8,children:e.jsx(jt,{children:e.jsx(bc,{})})}),e.jsx(Dt,{offset:8,children:e.jsx(xc,{children:e.jsx(jt,{children:e.jsx("div",{className:"cosmiq-glass-ultra rounded-2xl",children:e.jsx(gc,{})})})})})]})}),e.jsx(jt,{children:e.jsx(Ca,{})}),e.jsx(Vg,{open:m,onClose:p})]})},ax=()=>e.jsx(sx,{enableOnboardingGuard:!1}),rx=()=>{const{user:t}=ce(),s=Se(),{data:a,isLoading:r}=ye({queryKey:["referral-stats",t?.id],staleTime:300*1e3,queryFn:async()=>{if(!t)return null;const{data:m,error:p}=await N.from("profiles").select("referral_code, referral_count, referred_by_code").eq("id",t.id).maybeSingle();if(p)throw p;return m?{referral_code:m.referral_code||null,referral_count:m.referral_count||0,referred_by:m.referred_by_code}:null},enabled:!!t}),{data:i}=ye({queryKey:["unlocked-skins",t?.id],staleTime:300*1e3,queryFn:async()=>{if(!t)return[];const{data:m,error:p}=await N.from("user_companion_skins").select(`
          *,
          companion_skins (*)
        `).eq("user_id",t.id).order("acquired_at",{ascending:!1}).limit(100);if(p)throw p;return m},enabled:!!t}),{data:o}=ye({queryKey:["available-skins"],staleTime:600*1e3,queryFn:async()=>{const{data:m,error:p}=await N.from("companion_skins").select("*").eq("unlock_type","referral").order("unlock_requirement",{ascending:!0}).limit(100);if(p)throw p;return m}}),c=ie({mutationFn:async m=>{if(!t)throw new Error("User not authenticated");const p=m.trim().toUpperCase(),{data:h,error:f}=await N.rpc("apply_referral_code_secure",{p_user_id:t.id,p_referral_code:p});if(f)throw new Error("Unable to apply referral code. Please try again.");const d=h?.[0]||h;if(!d?.success)throw new Error(d?.message||"Failed to apply referral code");return{success:!0}},onSuccess:()=>{s.invalidateQueries({queryKey:["referral-stats"]}),X.success("Referral code applied! Your friend will earn rewards when you reach Stage 3.")},onError:m=>{X.error(m.message)}}),l=ie({mutationFn:async m=>{if(!t)throw new Error("User not authenticated");const{data:p,error:h}=await N.from("user_companion_skins").select("id").eq("user_id",t.id).eq("skin_id",m).maybeSingle();if(h)throw h;if(!p)throw new Error("You don't own this skin");await N.from("user_companion_skins").update({is_equipped:!1}).eq("user_id",t.id);const{error:f}=await N.from("user_companion_skins").update({is_equipped:!0}).eq("user_id",t.id).eq("skin_id",m);if(f)throw f},onSuccess:()=>{s.invalidateQueries({queryKey:["unlocked-skins"]}),X.success("Skin equipped!")}}),u=ie({mutationFn:async()=>{if(!t)throw new Error("User not authenticated");const{error:m}=await N.from("user_companion_skins").update({is_equipped:!1}).eq("user_id",t.id).eq("is_equipped",!0);if(m)throw m},onSuccess:()=>{s.invalidateQueries({queryKey:["unlocked-skins"]}),X.success("Skin unequipped")}});return{referralStats:a,unlockedSkins:i,availableSkins:o,isLoading:r,applyReferralCode:c,equipSkin:l,unequipSkin:u}},Tc=()=>{const{user:t}=ce(),{companion:s}=st(),a=Se(),{data:r,isLoading:i}=ye({queryKey:["companion-health",t?.id],queryFn:async()=>{if(!t?.id)return null;const{data:d,error:g}=await N.from("user_companion").select("inactive_days, last_activity_date, neglected_image_url, current_mood, body, mind, soul, current_image_url, is_alive, hunger, happiness, care_score, recovery_progress").eq("user_id",t.id).maybeSingle();if(g)throw console.error("Failed to fetch companion health:",g),g;return d},enabled:!!t?.id,staleTime:6e4}),{data:o,isLoading:c}=ye({queryKey:["streak-freezes",t?.id],queryFn:async()=>{if(!t?.id)return null;const{data:d,error:g}=await N.from("profiles").select("streak_freezes_available, last_streak_freeze_used, streak_freezes_reset_at").eq("id",t.id).maybeSingle();if(g)throw console.error("Failed to fetch streak freeze data:",g),g;return d},enabled:!!t?.id,staleTime:6e4}),l=d=>d===0?"happy":d===1?"neutral":d===2?"worried":d>=3&&d<5?"sad":d>=5?"sick":"happy",u=n.useMemo(()=>{const d=r?.body??100,g=r?.mind??0,y=r?.soul??0,v=r?.inactive_days??0,b=r?.is_alive??!0,x=r?.hunger??100,j=r?.happiness??100,w=r?.care_score??100,D=r?.recovery_progress??100,S=Math.round((d+g+y)/3),M=l(v),C=v>=3,R=D<100,T=v>=5,k=C&&r?.neglected_image_url?r.neglected_image_url:r?.current_image_url||s?.current_image_url||null;return{healthPercentage:S,moodState:M,isNeglected:C,daysInactive:v,imageUrl:k,neglectedImageUrl:r?.neglected_image_url||null,body:d,mind:g,soul:y,lastActivityDate:r?.last_activity_date||null,isAlive:b,hunger:x,happiness:j,careScore:w,recoveryProgress:D,isRecovering:R,isCritical:T}},[r,s]),m=n.useMemo(()=>{const d=o?.streak_freezes_reset_at;let g=7;if(d){const y=new Date(d),v=new Date,b=y.getTime()-v.getTime();g=Math.max(0,Math.ceil(b/(1e3*60*60*24)))}return{streakFreezesAvailable:o?.streak_freezes_available??1,lastStreakFreezeUsed:o?.last_streak_freeze_used||null,streakFreezesResetAt:d||null,daysUntilReset:g}},[o]),p=async()=>{if(t?.id)try{const d=new Date().toISOString().split("T")[0];await N.from("user_companion").update({last_activity_date:d,inactive_days:0,current_mood:"happy"}).eq("user_id",t.id),a.invalidateQueries({queryKey:["companion-health"]}),a.invalidateQueries({queryKey:["companion"]})}catch(d){console.error("Failed to mark user active:",d)}},h=u.daysInactive>=2;return{health:u,streakFreeze:m,isLoading:i||c,markUserActive:p,needsWelcomeBack:h,getMoodFilterStyles:d=>{switch(d){case"happy":case"content":return{};case"neutral":return{filter:"saturate(0.9) brightness(0.95)"};case"worried":return{filter:"saturate(0.7) brightness(0.9)"};case"sad":return{filter:"saturate(0.5) brightness(0.85)"};case"sick":return{filter:"saturate(0.3) brightness(0.7) sepia(0.2)"};default:return{}}}}},nx=(t,s,a,r,i)=>{const{care:o}=cr(),c=n.useMemo(()=>{if(!r)return{filter:"grayscale(1) brightness(0.5)",animation:"none",animationDuration:"0s",opacity:.7,saturation:0,posture:"curled",eyeContact:"closed"};if(o.dormancy.isDormant)return{filter:"grayscale(0.5) brightness(0.6) blur(0.5px)",animation:"dormant-breathe",animationDuration:"6s",opacity:.75,saturation:.5,posture:"sleeping",eyeContact:"closed"};if(o.dormancy.recoveryDays>0&&o.dormancy.recoveryDays<5){const p=o.dormancy.recoveryDays/5;return{filter:`saturate(${.5+p*.5}) brightness(${.8+p*.2})`,animation:"pulse",animationDuration:"4s",opacity:.8+p*.2,saturation:.5+p*.5,posture:p>.5?"neutral":"withdrawn",eyeContact:p>.5?"occasional":"averted"}}if(o.dormancy.daysUntilDormancy!==null){const h=o.dormancy.daysUntilDormancy===1?.6:.3;return{filter:`saturate(${.7-h*.2}) brightness(${.85-h*.1}) sepia(${h*.15})`,animation:"droop",animationDuration:"5s",opacity:.9-h*.1,saturation:.7-h*.2,posture:"withdrawn",eyeContact:"averted"}}const m=o.overallCare;return m>.8?{filter:"saturate(1.25) brightness(1.1)",animation:"bounce",animationDuration:"2s",opacity:1,saturation:1.25,posture:"confident",eyeContact:"direct"}:m>.6?{filter:"saturate(1.1) brightness(1.05)",animation:"pulse",animationDuration:"3s",opacity:1,saturation:1.1,posture:"relaxed",eyeContact:"friendly"}:m>.4?{filter:"saturate(0.95) brightness(0.98)",animation:"pulse",animationDuration:"5s",opacity:.95,saturation:.95,posture:"neutral",eyeContact:"occasional"}:m>.2?{filter:"saturate(0.75) brightness(0.88) sepia(0.08)",animation:"droop",animationDuration:"4s",opacity:.88,saturation:.75,posture:"withdrawn",eyeContact:"averted"}:{filter:"saturate(0.5) brightness(0.75) sepia(0.15)",animation:"shiver",animationDuration:"0.4s",opacity:.75,saturation:.5,posture:"curled",eyeContact:"none"}},[o,r]),l=n.useMemo(()=>({filter:c.filter,opacity:c.opacity,transition:"filter 0.8s ease, opacity 0.8s ease"}),[c]),u=n.useMemo(()=>{if(c.animation==="none")return"";switch(c.animation){case"bounce":return"animate-companion-bounce";case"pulse":return"animate-companion-pulse";case"shiver":return"animate-companion-shiver";case"droop":return"animate-companion-droop";case"dormant-breathe":return"animate-companion-dormant";default:return""}},[c.animation]);return{visualState:c,cssStyles:l,animationClass:u,care:o,overallCare:o.overallCare,evolutionPath:o.evolutionPath,dialogueTone:o.dialogueTone,isDormant:o.dormancy.isDormant,hasDormancyWarning:o.hasDormancyWarning,bondLevel:o.bond.level}},zr=2,ix=()=>{const{user:t}=ce(),s=Se(),[a,r]=n.useState(!1),[i,o]=n.useState("starting"),[c,l]=n.useState(0),u=ie({mutationFn:async p=>{if(!t)throw new Error("Not authenticated");o("starting"),l(0);const{data:h,error:f}=await N.from("user_companion").select("image_regenerations_used").eq("id",p.id).eq("user_id",t.id).maybeSingle();if(f)throw console.error("Failed to verify regeneration count:",f),new Error("Unable to verify regeneration status. Please try again.");const d=h?.image_regenerations_used??0;if(d>=zr)throw new Error("You've used all your regenerations");o("generating");const{imageUrl:g,validationPassed:y,retryCount:v}=await Xl({favoriteColor:p.favorite_color,spiritAnimal:p.spirit_animal,element:p.core_element,stage:p.current_stage,eyeColor:p.eye_color,furColor:p.fur_color},{onRetry:w=>{o("retrying"),l(w)},onValidating:()=>{o("validating")}});l(v),o("finalizing");const{data:b,error:x}=await N.from("user_companion").update({current_image_url:g,image_regenerations_used:d+1}).eq("id",p.id).eq("user_id",t.id).eq("image_regenerations_used",d).select("image_regenerations_used").single();if(x)throw x?.code==="PGRST116"?new Error("Regeneration already consumed. Please refresh to continue."):x;const j=b?.image_regenerations_used??d+1;return o(y?"complete":"warning"),{imageUrl:g,regenerationsRemaining:Math.max(0,zr-j),validationPassed:y,retryCount:c}},onSuccess:p=>{s.invalidateQueries({queryKey:["companion"]}),p.validationPassed?X.success(`New look unlocked! ${p.regenerationsRemaining} regeneration${p.regenerationsRemaining===1?"":"s"} remaining.`):X.success(`Companion created! ${p.regenerationsRemaining} regeneration${p.regenerationsRemaining===1?"":"s"} remaining. You can regenerate again if needed.`),setTimeout(()=>r(!1),1500)},onError:p=>{console.error("Regeneration failed:",p),o("starting"),X.error(p instanceof Error?p.message:"Failed to regenerate")}}),m=()=>{o("starting"),l(0)};return{regenerate:u.mutate,isRegenerating:u.isPending,showConfirmDialog:a,setShowConfirmDialog:r,maxRegenerations:zr,generationPhase:i,retryCount:c,resetProgress:m}},ox="companion_wake_up_seen";function lx(){const{user:t}=ce(),{companion:s}=st(),{care:a,isLoading:r}=cr(),[i,o]=n.useState(!1),c=n.useRef(null),l=n.useRef(!1),u=n.useRef(!1),m=n.useCallback(()=>s?.id?`${ox}_${s.id}`:null,[s?.id]),p=n.useCallback(()=>{const d=m();d&&localStorage.setItem(d,Date.now().toString())},[m]),h=n.useCallback(()=>{const d=m();if(!d)return!1;const g=localStorage.getItem(d);if(!g)return!1;const y=parseInt(g,10);return(Date.now()-y)/(1e3*60*60)<24},[m]);n.useEffect(()=>{if(r||!a)return;const d=a.dormancy.isDormant;if(!l.current){c.current=d,l.current=!0;return}if(c.current===!0&&d===!1&&!h()&&(o(!0),p(),!u.current&&t?.id&&s?.id)){u.current=!0;const g=new Date().toISOString().split("T")[0];N.from("companion_memories").insert({user_id:t.id,companion_id:s.id,memory_type:"recovery",memory_date:g,memory_context:{title:"Awakening",description:"You came back and brought me out of the darkness. I will never forget.",emotion:"relief"},referenced_count:0}).then(({error:y})=>{y&&console.error("[WakeUp] Failed to create recovery memory:",y)})}c.current=d},[a,r,h,p,t?.id,s?.id]);const f=n.useCallback(()=>{o(!1),u.current=!1},[]);return{showCelebration:i,dismissCelebration:f,companionName:s?.spirit_animal||"companion",companionImageUrl:s?.current_image_url||"",dormantImageUrl:s?.dormant_image_url||null,bondLevel:a?.bond?.level||1}}const ki={treasure_hunt:{achievementType:"story_treasure_hunt_complete",title:"Fortune Seeker",description:"Completed a Treasure Hunt epic",icon:"ðŸ’Ž",tier:"gold"},mystery:{achievementType:"story_mystery_complete",title:"Truth Unveiler",description:"Completed a Mystery epic",icon:"ðŸ”®",tier:"gold"},pilgrimage:{achievementType:"story_pilgrimage_complete",title:"Soul Pilgrim",description:"Completed a Pilgrimage epic",icon:"ðŸ§˜",tier:"gold"},heroes_journey:{achievementType:"story_heroes_journey_complete",title:"Legendary Hero",description:"Completed a Heroes Journey epic",icon:"âš”ï¸",tier:"platinum"},rescue_mission:{achievementType:"story_rescue_mission_complete",title:"Cosmic Savior",description:"Completed a Rescue Mission epic",icon:"ðŸ›¡ï¸",tier:"gold"},exploration:{achievementType:"story_exploration_complete",title:"Star Cartographer",description:"Completed an Exploration epic",icon:"ðŸŒŒ",tier:"gold"}},cx={common:{label:"Common",color:"hsl(220, 10%, 60%)",glowClass:"shadow-gray-500/30",bgClass:"from-gray-400/20 to-gray-600/20"},rare:{label:"Rare",color:"hsl(210, 80%, 60%)",glowClass:"shadow-blue-500/40",bgClass:"from-blue-400/20 to-blue-600/20"},epic:{label:"Epic",color:"hsl(280, 70%, 60%)",glowClass:"shadow-purple-500/50",bgClass:"from-purple-400/20 to-purple-600/20"},legendary:{label:"Legendary",color:"hsl(45, 90%, 55%)",glowClass:"shadow-yellow-500/60",bgClass:"from-yellow-400/30 to-orange-500/30"}},Ec=()=>{const{user:t}=ce(),s=Se(),{data:a=[]}=ye({queryKey:["epic-rewards"],queryFn:async()=>{const{data:m,error:p}=await N.from("epic_rewards").select("*").order("rarity",{ascending:!0});if(p)throw p;return m},staleTime:1e3*60*60}),{data:r=[],isLoading:i}=ye({queryKey:["user-epic-rewards",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:m,error:p}=await N.from("user_epic_rewards").select("*, epic_rewards(*)").eq("user_id",t.id).order("unlocked_at",{ascending:!1});if(p)throw p;return m},enabled:!!t?.id}),o={background:r.find(m=>m.is_equipped&&m.epic_rewards?.reward_type==="background")||null,frame:r.find(m=>m.is_equipped&&m.epic_rewards?.reward_type==="frame")||null,effect:r.find(m=>m.is_equipped&&m.epic_rewards?.reward_type==="effect")||null},c=ie({mutationFn:async({rewardId:m,equip:p})=>{if(!t?.id)throw new Error("Not authenticated");const h=r.find(g=>g.reward_id===m);if(!h)throw new Error("Reward not found");const f=h.epic_rewards?.reward_type;p&&f&&await N.from("user_epic_rewards").update({is_equipped:!1}).eq("user_id",t.id).eq("is_equipped",!0).in("reward_id",a.filter(g=>g.reward_type===f).map(g=>g.id));const{error:d}=await N.from("user_epic_rewards").update({is_equipped:p}).eq("id",h.id);if(d)throw d},onSuccess:()=>{s.invalidateQueries({queryKey:["user-epic-rewards"]})},onError:m=>{console.error("Failed to equip reward:",m),X.error("Failed to update equipped item")}}),l=async(m,p)=>{if(!t?.id)return{reward:null,isDuplicate:!1};const h=a.filter(v=>v.story_type_slug===null||v.story_type_slug===m);if(h.length===0)return{reward:null,isDuplicate:!1};const f=new Set(r.map(v=>v.reward_id));let d=null,g=0;const y=3;for(;g<y&&(d=dx(h),!(!d||!f.has(d.id)));)g++;if(d&&f.has(d.id)){const v=ux(d.rarity);return{reward:d,isDuplicate:!0,bonusXP:v}}if(d){const{error:v}=await N.from("user_epic_rewards").insert({user_id:t.id,reward_id:d.id,epic_id:p});if(v)return console.error("Failed to award reward:",v),{reward:null,isDuplicate:!1};s.invalidateQueries({queryKey:["user-epic-rewards"]})}return{reward:d,isDuplicate:!1}},u=async(m,p)=>{const f=ki[m||"treasure_hunt"]||ki.treasure_hunt,{reward:d,isDuplicate:g,bonusXP:y}=await l(m,p);return{badge:{title:f.title,description:f.description,icon:f.icon,tier:f.tier},loot:d,isDuplicate:g,bonusXP:y}};return{allRewards:a,userRewards:r,equippedRewards:o,isLoading:i,equipReward:c.mutate,isEquipping:c.isPending,rollLootReward:l,generateRewardReveal:u}};function dx(t){if(t.length===0)return null;const s=t.reduce((r,i)=>r+i.drop_weight,0);let a=Math.random()*s;for(const r of t)if(a-=r.drop_weight,a<=0)return r;return t[t.length-1]}function ux(t){switch(t){case"common":return 25;case"rare":return 50;case"epic":return 100;case"legendary":return 200;default:return 25}}const mx=()=>e.jsxs(Me,{className:"relative overflow-hidden shadow-glow-lg border-primary/40 animate-pulse bg-gradient-to-br from-card via-card to-secondary/50",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-primary/5 via-accent/5 to-primary/10 opacity-60"}),e.jsxs("div",{className:"relative p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{className:"h-8 w-40"}),e.jsx(ue,{className:"h-4 w-24"})]}),e.jsx(ue,{className:"h-10 w-10 rounded-full"})]}),e.jsx("div",{className:"flex justify-center py-8",children:e.jsx(ue,{className:"h-64 w-64 rounded-2xl"})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{className:"h-4 w-16"}),e.jsx(ue,{className:"h-6 w-24"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{className:"h-4 w-16"}),e.jsx(ue,{className:"h-6 w-24"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{className:"h-4 w-16"}),e.jsx(ue,{className:"h-6 w-24"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ue,{className:"h-4 w-16"}),e.jsx(ue,{className:"h-6 w-24"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx(ue,{className:"h-4 w-32"}),e.jsx(ue,{className:"h-4 w-20"})]}),e.jsx(ue,{className:"h-3 w-full rounded-full"})]})]})]}),Wt=zu,Qt=Uu,qt=n.forwardRef(({className:t,align:s="center",sideOffset:a=4,...r},i)=>e.jsx(Hu,{children:e.jsx(Oo,{ref:i,align:s,sideOffset:a,className:E("z-[60] w-72 rounded-md border bg-popover p-4 text-popover-foreground shadow-md outline-none data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...r})}));qt.displayName=Oo.displayName;const px={"Spirit Animal":"Your companion's spirit represents your inner strength and personality. It influences how your companion appears as it evolves.",Element:"The elemental force that powers your companion's growth. Each element brings unique visual themes to your companion's evolution.","Favorite Color":"The primary color that defines your companion's appearance and energy. This was chosen based on your personal preferences.",Stage:"Your companion's current evolution stage. There are 21 stages total, from Egg to Ultimate. Earn XP to unlock the next stage!","XP Progress":"Experience points earned through completing habits, missions, and challenges. Fill the bar to trigger your companion's next evolution!"},hx=({title:t,description:s})=>{const a=px[t]||s;return e.jsxs(Wt,{children:[e.jsx(Qt,{asChild:!0,children:e.jsx("button",{type:"button",className:"inline-flex items-center justify-center ml-1.5 opacity-60 hover:opacity-100 transition-opacity touch-manipulation active:scale-95","aria-label":`More information about ${t}`,children:e.jsx(hn,{className:"h-4 w-4"})})}),e.jsx(qt,{className:"w-80 cosmiq-glass border-primary/30 shadow-xl",side:"top",sideOffset:8,children:e.jsxs("div",{className:"space-y-2",children:[e.jsx("h4",{className:"font-semibold text-sm text-primary",children:t}),e.jsx("p",{className:"text-sm leading-relaxed text-foreground/90",children:a})]})})]})},fx={fire:pt,water:Ku,earth:wa,air:Qu,light:et,nature:Wu,energy:Be,spirit:se},Ci={fire:"bg-gradient-to-r from-orange-500/20 to-red-500/20 text-orange-300 border-orange-500/30",water:"bg-gradient-to-r from-blue-500/20 to-cyan-500/20 text-blue-300 border-blue-500/30",earth:"bg-gradient-to-r from-amber-600/20 to-yellow-700/20 text-amber-300 border-amber-600/30",air:"bg-gradient-to-r from-sky-400/20 to-indigo-400/20 text-sky-300 border-sky-400/30",light:"bg-gradient-to-r from-yellow-300/20 to-amber-300/20 text-yellow-200 border-yellow-300/30",nature:"bg-gradient-to-r from-green-500/20 to-emerald-500/20 text-green-300 border-green-500/30",energy:"bg-gradient-to-r from-purple-500/20 to-pink-500/20 text-purple-300 border-purple-500/30",spirit:"bg-gradient-to-r from-indigo-500/20 to-violet-500/20 text-indigo-300 border-indigo-500/30"},gx=({element:t,stage:s=1,showStage:a=!0,className:r=""})=>{const i=fx[t.toLowerCase()]||se,o=Ci[t.toLowerCase()]||Ci.spirit,c=mr(s),l=()=>s>=16?"bg-gradient-to-r from-stage-tier-4-start/10 via-stage-tier-4-mid/10 to-stage-tier-4-end/10":s>=11?"bg-gradient-to-r from-stage-tier-3/10":s>=6?"bg-gradient-to-r from-stage-tier-2/10":"";return e.jsxs(Ne,{variant:"outline",className:`px-3 py-1 ${o} ${l()} ${r} flex items-center gap-2`,children:[e.jsx(i,{className:"h-3 w-3"}),e.jsx("span",{className:"text-xs font-semibold capitalize",children:t}),a&&s!==void 0&&e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"text-xs opacity-50",children:"â€¢"}),e.jsx("span",{className:"text-xs font-medium",children:c})]})]})},La=[{level:1,name:"Acquaintance",description:"A new journey begins...",icon:"ðŸŒ±"},{level:2,name:"Companion",description:"Trust is forming between you.",icon:"ðŸ¤"},{level:3,name:"Friend",description:"Your bond grows stronger each day.",icon:"ðŸ’«"},{level:4,name:"Close Friend",description:"A deep understanding develops.",icon:"âœ¨"},{level:5,name:"Soul Bond",description:"An unbreakable connection.",icon:"ðŸ’Ž"},{level:6,name:"Eternal Partner",description:"Together through all realms.",icon:"ðŸŒŸ"},{level:7,name:"Legendary Bond",description:"A bond that transcends time.",icon:"ðŸ‘‘"}],Si={joy:["That was such a happy day!","I still feel warm thinking about it.","One of our best moments!"],pride:["You worked so hard for that.","I was so proud of you!","Look how far we've come."],gratitude:["Thank you for that moment.","I treasure that memory.","You've given me so much."],wonder:["That was magical!","I still can't believe it happened.","What an adventure!"],relief:["We made it through together.","I'm so glad you came back.","Everything is okay now."]},xx=t=>{let s=0;for(let a=0;a<t.length;a++)s=(s<<5)-s+t.charCodeAt(a),s|=0;return Math.abs(s%1e3)/1e3};function Cn(){const{user:t}=ce(),{companion:s}=st(),a=Se(),{data:r,isLoading:i}=ye({queryKey:["companion-memories",s?.id],queryFn:async()=>{if(!s?.id)return[];const{data:b,error:x}=await N.from("companion_memories").select("*").eq("companion_id",s.id).order("memory_date",{ascending:!1}).limit(50);if(x)throw console.error("Failed to fetch memories:",x),x;return b||[]},enabled:!!s?.id,staleTime:300*1e3}),{data:o,isLoading:c}=ye({queryKey:["companion-bond",s?.id],queryFn:async()=>{if(!s?.id||!t?.id)return null;const{data:b,error:x}=await N.from("user_companion").select("bond_level, total_interactions, last_interaction_at").eq("user_id",t.id).maybeSingle();return x?(console.error("Failed to fetch bond data:",x),null):b},enabled:!!s?.id&&!!t?.id,staleTime:60*1e3}),l=ie({mutationFn:async b=>{if(!t?.id||!s?.id)throw new Error("No user or companion");const x={user_id:t.id,companion_id:s.id,memory_type:b.memoryType,memory_context:b.context||null,memory_date:new Date().toISOString().split("T")[0],referenced_count:0},{data:j,error:w}=await N.from("companion_memories").insert(x).select().single();if(w)throw w;return j},onSuccess:()=>{a.invalidateQueries({queryKey:["companion-memories",s?.id]})}}),u=ie({mutationFn:async b=>{const{data:x}=await N.from("companion_memories").select("referenced_count").eq("id",b).maybeSingle(),j=(x?.referenced_count||0)+1,{error:w}=await N.from("companion_memories").update({referenced_count:j,last_referenced_at:new Date().toISOString()}).eq("id",b);if(w)throw w}}),m=n.useMemo(()=>{const b=o?.bond_level||1;return La.map(x=>({...x,unlockedAt:x.level<=b?x.level===b?"now":"past":null}))},[o?.bond_level]),p=n.useMemo(()=>{const b=o?.bond_level||1,x=La.find(w=>w.level===b)||La[0],j=La.find(w=>w.level===b+1);return{level:b,...x,nextMilestone:j,totalInteractions:o?.total_interactions||0,lastInteractionAt:o?.last_interaction_at}},[o]),h=n.useCallback(()=>{if(!r||r.length===0)return null;const b=Math.max(...r.map(D=>D.referenced_count||0),1),x=r.map(D=>({memory:D,weight:b-(D.referenced_count||0)+1})),j=x.reduce((D,S)=>D+S.weight,0);let w=Math.random()*j;for(const{memory:D,weight:S}of x)if(w-=S,w<=0)return D;return r[0]},[r]),f=n.useCallback(b=>{const x=b.memory_context;if(!x)return null;const j=x.emotion||"joy",w=Si[j]||Si.joy,D=`${b.id}-${new Date().toDateString()}`,S=Math.floor(xx(D)*w.length),M=w[S];return x.title?`Remember when ${x.title.toLowerCase()}? ${M}`:M},[]),d=n.useCallback((b,x)=>l.mutateAsync({memoryType:b,context:x}),[l]),g=n.useCallback(b=>u.mutate(b),[u]),y=n.useMemo(()=>r?r.reduce((b,x)=>{const j=x.memory_type;return b[j]||(b[j]=[]),b[j].push(x),b},{}):{},[r]),v=n.useMemo(()=>r?r.filter(b=>["first_meeting","first_evolution","evolution","bond_milestone","recovery"].includes(b.memory_type)):[],[r]);return{memories:r||[],memoriesByType:y,specialMemories:v,isLoading:i||c,currentBond:p,bondMilestones:m,createMemory:d,referenceMemory:g,getRandomMemory:h,getMemoryDialogue:f}}const Mc=n.memo(({className:t})=>{const{currentBond:s,isLoading:a}=Cn();return a||!s?null:e.jsxs(Tl,{children:[e.jsx(El,{asChild:!0,children:e.jsxs(_.div,{className:E("flex items-center gap-2 px-3 py-1.5 rounded-full","bg-card/50 backdrop-blur-sm border border-border/30","hover:border-primary/40 transition-all cursor-default",t),initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},whileHover:{scale:1.02},children:[e.jsx("span",{className:"text-lg","aria-hidden":!0,children:s.icon}),e.jsxs("div",{className:"flex flex-col leading-tight",children:[e.jsx("span",{className:"text-xs font-medium",children:s.name}),e.jsxs("span",{className:"text-[10px] text-muted-foreground",children:["Lvl ",s.level]})]})]})}),e.jsxs(yn,{side:"bottom",children:[e.jsx("p",{className:"text-xs",children:s.description}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[s.totalInteractions," interactions"]})]})]})});Mc.displayName="CompanionBondBadge";const yx=({isOpen:t,onClose:s})=>{const{health:a,markUserActive:r}=Tc(),{companion:i}=st(),{awardCustomXP:o,XP_REWARDS:c}=bt(),{triggerComeback:l}=Na(),[u,m]=n.useState(!1),[p,h]=n.useState(!1),f=Math.min(a.daysInactive*5,50),d=y=>{switch(y){case"happy":return"ðŸ˜Š";case"content":return"ðŸ™‚";case"neutral":return"ðŸ˜";case"worried":return"ðŸ˜Ÿ";case"sad":return"ðŸ˜¢";case"sick":return"ðŸ¤’";default:return"ðŸ˜Š"}},g=async()=>{m(!0),await r(),p||(await o(c.WELCOME_BACK_BONUS,"welcome_back_bonus","Welcome Back Bonus! ðŸŽ‰",{days_inactive:a.daysInactive}),h(!0)),a.daysInactive>=3&&l().catch(y=>console.log("[LivingCompanion] Comeback reaction failed:",y)),setTimeout(()=>{s(),m(!1)},2e3)};return n.useEffect(()=>{t&&(h(!1),m(!1))},[t]),i?e.jsx(ct,{open:t,onOpenChange:s,children:e.jsxs(ot,{className:"cosmiq-glass border-celestial-blue/40 max-w-md",children:[e.jsxs(as,{children:[e.jsx(St,{className:"text-2xl font-heading text-center",children:u?"Welcome Back! ðŸŽ‰":`${d(a.moodState)} We Missed You!`}),e.jsx(_s,{className:"text-center text-muted-foreground",children:u?"Your companion is so happy to see you!":`Your companion has been waiting for you for ${a.daysInactive} day${a.daysInactive!==1?"s":""}...`})]}),e.jsxs("div",{className:"space-y-6 py-4",children:[e.jsx("div",{className:"flex justify-center",children:e.jsx(be,{mode:"wait",children:u?e.jsxs(_.div,{initial:{opacity:0,scale:.8,rotate:-10},animate:{opacity:1,scale:[1,1.1,1],rotate:[0,5,-5,0]},transition:{duration:.5},className:"relative",children:[e.jsx("img",{src:i.current_image_url||"",alt:"Your happy companion",className:"w-48 h-48 object-cover rounded-2xl ring-4 ring-primary/50"}),e.jsx(_.div,{className:"absolute -top-2 -right-2 text-4xl",animate:{scale:[1,1.3,1],rotate:[0,15,-15,0]},transition:{repeat:1/0,duration:1},children:"â¤ï¸"}),e.jsx(se,{className:"absolute -top-4 left-1/2 -translate-x-1/2 h-8 w-8 text-stardust-gold animate-pulse"})]},"happy"):e.jsxs(_.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"relative",children:[e.jsx("img",{src:a.neglectedImageUrl||i.current_image_url||"",alt:"Your sad companion",className:"w-48 h-48 object-cover rounded-2xl",style:{filter:a.neglectedImageUrl?void 0:"saturate(0.4) brightness(0.8)"}}),e.jsx("div",{className:"absolute -bottom-2 -right-2 text-4xl",children:"ðŸ’”"})]},"sad")})}),!u&&e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"text-sm font-medium text-center text-muted-foreground",children:"While you were away..."}),e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs("div",{className:"text-center p-2 rounded-lg bg-destructive/10 border border-destructive/20",children:[e.jsx(ia,{className:"h-4 w-4 mx-auto text-destructive mb-1"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Body"}),e.jsxs("p",{className:"text-sm font-bold text-destructive",children:["-",f]})]}),e.jsxs("div",{className:"text-center p-2 rounded-lg bg-destructive/10 border border-destructive/20",children:[e.jsx(ia,{className:"h-4 w-4 mx-auto text-destructive mb-1"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Mind"}),e.jsxs("p",{className:"text-sm font-bold text-destructive",children:["-",f]})]}),e.jsxs("div",{className:"text-center p-2 rounded-lg bg-destructive/10 border border-destructive/20",children:[e.jsx(ia,{className:"h-4 w-4 mx-auto text-destructive mb-1"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Soul"}),e.jsxs("p",{className:"text-sm font-bold text-destructive",children:["-",f]})]})]}),e.jsxs("div",{className:"p-3 rounded-lg bg-stardust-gold/10 border border-stardust-gold/20",children:[e.jsxs("div",{className:"flex items-center gap-2 justify-center",children:[e.jsx(zt,{className:"h-4 w-4 text-stardust-gold"}),e.jsx("span",{className:"text-sm font-medium",children:"Come back and earn:"})]}),e.jsxs("div",{className:"flex items-center gap-4 justify-center mt-2",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"+10 to all stats"}),e.jsx("span",{className:"text-sm text-stardust-gold font-bold",children:"+25 XP bonus!"})]})]})]}),u&&e.jsxs(_.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"text-center space-y-2",children:[e.jsx("p",{className:"text-lg font-medium text-stardust-gold",children:"Your companion is overjoyed!"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"+10 Body, +10 Mind, +10 Soul restored"}),e.jsx("p",{className:"text-sm font-bold text-stardust-gold",children:"+25 XP Welcome Back Bonus!"})]}),!u&&e.jsxs(B,{onClick:g,className:"w-full rounded-2xl min-h-[48px] bg-gradient-to-r from-stardust-gold to-amber-500 text-black hover:from-stardust-gold/90 hover:to-amber-500/90",children:[e.jsx(Xt,{className:"h-5 w-5 mr-2"}),"Reunite with Your Companion"]})]})]})}):null},Ti={starting:["Preparing to create your companion...","Gathering magical energy...","Initiating the summoning ritual..."],generating:["Creating your companion's form...","Weaving magical essence...","Bringing your companion to life...","Shaping the elemental energy..."],validating:["Perfecting the details...","Ensuring magical accuracy...","Checking the enchantment..."],retrying:["Refining the form...","Adding final touches...","Polishing the magic...","Making adjustments..."],finalizing:["Almost there...","Completing the transformation...","Your companion is nearly ready..."],complete:["Your companion is ready!"],warning:["Your companion has been created with some variations."]},Ei=["This is taking a bit longer than usual...","Still working on perfecting your companion...","Quality takes time - almost there...","Your companion is being carefully crafted..."],bx=({phase:t,retryCount:s=0,className:a,estimatedTime:r})=>{const[i,o]=n.useState(0),[c,l]=n.useState(0),[u,m]=n.useState(!1);n.useEffect(()=>{t==="starting"&&(o(0),l(0),m(!1))},[t]),n.useEffect(()=>{const y=Ti[t];if(y.length<=1)return;const v=setInterval(()=>{o(b=>(b+1)%y.length)},3e3);return()=>clearInterval(v)},[t]),n.useEffect(()=>{if(t==="complete"||t==="warning")return;const y=setInterval(()=>{l(v=>v+1)},1e3);return()=>clearInterval(y)},[t]),n.useEffect(()=>{c>=15&&t!=="complete"&&t!=="warning"&&m(!0)},[c,t]);const p=Ti[t],h=p[i%p.length],f=Ei[Math.floor(c/10)%Ei.length],d=()=>{switch(t){case"complete":return e.jsx(Gu,{className:"h-5 w-5 text-green-500"});case"warning":return e.jsx(ps,{className:"h-5 w-5 text-yellow-500"});case"retrying":return e.jsx(bs,{className:"h-5 w-5 text-primary animate-spin"});default:return e.jsx(ze,{className:"h-5 w-5 text-primary animate-spin"})}},g=()=>{switch(t){case"starting":return"10%";case"generating":return"40%";case"validating":return"60%";case"retrying":return`${60+s*15}%`;case"finalizing":return"90%";case"complete":case"warning":return"100%";default:return"0%"}};return e.jsxs("div",{className:E("space-y-3",a),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[d(),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-sm font-medium text-foreground",children:u&&t!=="complete"&&t!=="warning"?f:h}),s>0&&t==="retrying"&&e.jsxs("p",{className:"text-xs text-muted-foreground mt-0.5",children:["Attempt ",s+1," of 3 - ensuring quality"]})]})]}),t!=="complete"&&t!=="warning"&&e.jsx("div",{className:"w-full h-1.5 bg-muted rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-primary to-primary/70 rounded-full transition-all duration-500 ease-out",style:{width:g()}})}),r&&t!=="complete"&&t!=="warning"&&e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:s>0?`Taking a bit longer to ensure quality (${Math.max(0,r-c)}s remaining)`:`Usually takes ${r}-${r+10} seconds`}),t==="complete"&&e.jsx("div",{className:"flex justify-center",children:e.jsx(se,{className:"h-4 w-4 text-primary animate-pulse"})})]})},vx=({isOpen:t,onClose:s,onConfirm:a,isRegenerating:r,regenerationsRemaining:i,generationPhase:o="starting",retryCount:c=0})=>{const l=o==="complete"||o==="warning";return e.jsx(_a,{open:t,onOpenChange:u=>!u&&!r&&s(),children:e.jsxs(Ws,{className:"cosmic-glass border-primary/30",children:[e.jsxs(Qs,{children:[e.jsxs(Gs,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-5 w-5 text-primary"}),r?"Creating New Look...":"Regenerate Companion?"]}),e.jsx(Ys,{className:"space-y-3",children:r?e.jsxs("div",{className:"py-2",children:[e.jsx(bx,{phase:o,retryCount:c,estimatedTime:15}),c>0&&e.jsx("p",{className:"text-xs text-muted-foreground mt-3 text-center",children:"We're ensuring your companion looks perfect"})]}):e.jsxs(e.Fragment,{children:[e.jsx("p",{children:"This will create a new unique appearance for your companion while keeping all stats, XP, and progress intact."}),e.jsxs("p",{className:"text-sm text-muted-foreground/80",children:["You have ",e.jsx("span",{className:"font-semibold text-primary",children:i})," regeneration",i===1?"":"s"," remaining (lifetime limit)."]}),e.jsx("p",{className:"text-xs text-muted-foreground/60",children:"Generation usually takes 10-20 seconds. We'll ensure quality by validating the result."})]})})]}),e.jsxs(Ks,{children:[!r&&!l&&e.jsxs(e.Fragment,{children:[e.jsx(Vs,{disabled:r,children:"Cancel"}),e.jsxs(ws,{onClick:u=>{u.preventDefault(),a()},disabled:r||i<=0,className:"bg-primary hover:bg-primary/90",children:[e.jsx(se,{className:"h-4 w-4 mr-2"}),"Regenerate"]})]}),l&&e.jsx(ws,{onClick:u=>{u.preventDefault(),s()},className:"bg-primary hover:bg-primary/90",children:"Done"})]})]})})},Dc=n.memo(({onEvolve:t,isEvolving:s})=>{const{isEvolvingLoading:a}=lr(),r=()=>{!s&&!a&&t()};return e.jsx(_.div,{initial:{opacity:0,y:-10,scale:.98},animate:{opacity:1,y:0,scale:1},exit:{opacity:0,y:-10,scale:.98},transition:{duration:.3,ease:"easeOut"},className:"pt-4",children:e.jsxs("button",{onClick:r,disabled:s||a,className:`
          relative w-full py-5 rounded-xl
          font-heading font-black text-3xl sm:text-4xl tracking-[0.35em]
          uppercase overflow-hidden
          transition-all duration-300
          hover:scale-[1.02] active:scale-[0.98]
          disabled:cursor-not-allowed disabled:opacity-70
          border border-white/20
        `,style:{background:`linear-gradient(90deg, 
            rgba(255,0,0,0.2), 
            rgba(255,64,0,0.2),
            rgba(255,128,0,0.2), 
            rgba(255,192,0,0.2),
            rgba(255,255,0,0.2), 
            rgba(128,255,0,0.2),
            rgba(0,255,0,0.2), 
            rgba(0,255,128,0.2),
            rgba(0,255,255,0.2), 
            rgba(0,128,255,0.2), 
            rgba(0,0,255,0.2),
            rgba(128,0,255,0.2), 
            rgba(255,0,255,0.2),
            rgba(255,0,128,0.2), 
            rgba(255,0,0,0.2)
          )`,backgroundSize:"300% 100%",animation:"rainbow-slide 3s linear infinite",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)"},children:[e.jsx("div",{className:"absolute inset-0 rounded-xl pointer-events-none",style:{background:"linear-gradient(135deg, rgba(255,255,255,0.3) 0%, transparent 40%, transparent 60%, rgba(255,255,255,0.15) 100%)"}}),e.jsx("div",{className:"absolute inset-0 rounded-xl pointer-events-none overflow-hidden",children:e.jsx("div",{className:"absolute inset-0",style:{background:"linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.4) 50%, transparent 100%)",animation:"shimmer-sweep 2s ease-in-out infinite"}})}),e.jsxs("div",{className:"absolute inset-0 rounded-xl pointer-events-none overflow-hidden",children:[e.jsx("div",{className:"absolute w-3 h-3 bg-white star-sparkle-4 animate-sparkle-1",style:{top:"20%",left:"15%"}}),e.jsx("div",{className:"absolute w-4 h-4 bg-white star-sparkle-4 animate-sparkle-2",style:{top:"60%",left:"75%"}}),e.jsx("div",{className:"absolute w-3 h-3 bg-white star-sparkle-4 animate-sparkle-3",style:{top:"40%",left:"45%"}}),e.jsx("div",{className:"absolute w-2 h-2 bg-white star-sparkle-4 animate-sparkle-4",style:{top:"70%",left:"25%"}}),e.jsx("div",{className:"absolute w-3 h-3 bg-white star-sparkle-4 animate-sparkle-5",style:{top:"30%",left:"85%"}})]}),e.jsx("div",{className:"absolute inset-0 -z-10 rounded-xl opacity-60",style:{background:"linear-gradient(90deg, #ff0000, #ff4000, #ff8000, #ffc000, #ffff00, #80ff00, #00ff00, #00ff80, #00ffff, #0080ff, #0000ff, #8000ff, #ff00ff, #ff0080, #ff0000)",backgroundSize:"300% 100%",animation:"rainbow-slide 3s linear infinite",filter:"blur(8px)",transform:"scale(1.02)"}}),e.jsx("div",{className:"relative z-10 h-[1.2em]",children:a?e.jsx(_.span,{className:"absolute inset-0 flex items-center justify-center text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.3)]",style:{textShadow:"0 0 20px rgba(255,255,255,0.5), 0 0 40px rgba(255,255,255,0.3)"},animate:{opacity:[1,.5,1]},transition:{duration:1,repeat:1/0,ease:"easeInOut"},children:"EVOLVING..."}):e.jsx("span",{className:"absolute inset-0 flex items-center justify-center text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.3)]",style:{textShadow:"0 0 20px rgba(255,255,255,0.5), 0 0 40px rgba(255,255,255,0.3)"},children:"EVOLVE"})})]})})});Dc.displayName="EvolveButton";const Pc=n.memo(({path:t,isLocked:s=!1,className:a,showDescription:r=!1})=>{const i=Wp(t),o=e.jsxs("div",{className:E("inline-flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm font-medium transition-all",i.bgColor,i.borderColor,"border",s&&"ring-1 ring-offset-1 ring-offset-background ring-primary/30",a),children:[e.jsx("span",{className:"text-base",children:i.icon}),e.jsx("span",{className:i.color,children:i.name}),s&&e.jsx("span",{className:"text-xs opacity-60",children:"ðŸ”’"})]});return r?e.jsxs("div",{className:"flex flex-col items-center gap-2",children:[o,e.jsx("p",{className:"text-xs text-muted-foreground text-center max-w-[200px]",children:i.description})]}):e.jsx(Sl,{children:e.jsxs(Tl,{children:[e.jsx(El,{asChild:!0,children:o}),e.jsxs(yn,{side:"bottom",className:"max-w-[250px]",children:[e.jsx("p",{className:"text-sm",children:i.description}),s&&e.jsx("p",{className:"text-xs text-muted-foreground mt-1",children:"This path is now permanent."})]})]})})});Pc.displayName="EvolutionPathBadge";const wx=({daysUntilDormancy:t=2,show:s})=>s?e.jsx(be,{children:e.jsx(_.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"absolute top-2 left-2 right-2 z-20",children:e.jsxs("div",{className:"bg-orange-500/20 border border-orange-500/50 rounded-lg px-3 py-2 backdrop-blur-sm",children:[e.jsxs("div",{className:"flex items-center gap-2 text-orange-300",children:[e.jsx(ps,{className:"w-4 h-4 animate-pulse"}),e.jsx("span",{className:"text-xs font-medium",children:t===1?"Your companion feels forgotten...":`${t} days until dormancy`})]}),e.jsx("p",{className:"text-[10px] text-orange-200/70 mt-1 pl-6",children:"Complete any activity to reconnect"})]})})}):null,Mi={0:"Be active for 5 consecutive days to wake them",1:"A faint light stirs within...",2:"Dreams are beginning to form...",3:"Memories of you are returning...",4:"Almost there... keep going...",5:"Ready to wake!"},jx=({isDormant:t,recoveryDays:s,daysUntilWake:a})=>{if(!t)return null;const r=Mi[Math.min(s,5)]||Mi[0];return e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},className:"absolute inset-0 z-10 flex flex-col items-center justify-center bg-slate-900/60 backdrop-blur-sm rounded-2xl overflow-hidden",children:[s>0&&e.jsx(_.div,{className:"absolute inset-0 pointer-events-none",animate:{background:["radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 50%)","radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.15) 0%, transparent 60%)","radial-gradient(circle at 50% 50%, rgba(245, 158, 11, 0.05) 0%, transparent 50%)"]},transition:{duration:3,repeat:1/0,ease:"easeInOut"}}),s>0&&e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[...Array(Math.min(s*2,8))].map((i,o)=>e.jsx(_.div,{className:"absolute w-1.5 h-1.5 rounded-full bg-amber-400/50",style:{left:`${20+Math.random()*60}%`},animate:{y:["100%","-20%"],opacity:[0,.8,0],scale:[.5,1,.5]},transition:{duration:2.5+Math.random(),repeat:1/0,delay:o*.4,ease:"easeOut"}},o))}),e.jsx(_.div,{animate:s>0?{scale:[1,1.05,1],opacity:[.8,1,.8]}:void 0,transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx(ma,{className:"w-12 h-12 text-slate-400 mb-3"})}),e.jsx("span",{className:"text-slate-300 font-medium text-lg",children:"Dormant"}),e.jsx("p",{className:"text-slate-400 text-sm mt-1 text-center px-4",children:"Your companion has fallen into a deep sleep"}),s>0&&e.jsxs("div",{className:"mt-4 px-4 w-full max-w-[200px]",children:[e.jsxs("div",{className:"flex justify-between text-xs text-slate-400 mb-1",children:[e.jsx("span",{children:"Awakening..."}),e.jsxs("span",{children:[s,"/5 days"]})]}),e.jsx("div",{className:"h-2 bg-slate-700 rounded-full overflow-hidden",children:e.jsx(_.div,{initial:{width:0},animate:{width:`${s/5*100}%`},className:"h-full bg-gradient-to-r from-amber-500 to-amber-400"})}),e.jsx(_.p,{initial:{opacity:0,y:5},animate:{opacity:1,y:0},className:"text-xs text-amber-400/80 mt-2 text-center italic",children:r},s)]}),s===0&&e.jsx("p",{className:"text-xs text-amber-400/70 mt-3 text-center px-6",children:r})]})},Di=t=>{let s=0;for(let a=0;a<t.length;a++)s=(s<<5)-s+t.charCodeAt(a),s|=0;return Math.abs(s%1e3)/1e3};function _x(){const{companion:t}=st(),{care:s,isLoading:a}=cr(),{data:r,isLoading:i}=ye({queryKey:["companion-voice-template"],queryFn:async()=>{const{data:d,error:g}=await N.from("companion_voice_templates").select("*").eq("species","universal").maybeSingle();return g?(console.error("Failed to fetch voice template:",g),null):d?{species:d.species,voice_style:d.voice_style,personality_traits:d.personality_traits||[],greeting_templates:d.greeting_templates||[],encouragement_templates:d.encouragement_templates||[],concern_templates:d.concern_templates||[],care_high_greetings:d.care_high_greetings||[],care_medium_greetings:d.care_medium_greetings||[],care_low_greetings:d.care_low_greetings||[],care_critical_greetings:d.care_critical_greetings||[],recovery_greetings:d.recovery_greetings||[],path_greetings:d.path_greetings||{},bond_level_dialogue:d.bond_level_dialogue||{}}:null},staleTime:1e3*60*5}),o={1:"...is someone there?",2:"I can feel you... don't leave...",3:"Your warmth... it's bringing me back...",4:"I remember now... we had so many days together...",5:"I'm almost ready... thank you for not giving up on me..."},c=n.useMemo(()=>{if(!s)return"content";if(s.dormancy?.isDormant&&s.dormancy.recoveryDays>0)return"recovering";if(s.dormancy?.isDormant)return"desperate";const d=s.overallCare;return d>=.8?"thriving":d>=.5?"content":d>=.25?"concerned":"desperate"},[s]),l=n.useMemo(()=>{if(!s?.dormancy?.isDormant||s.dormancy.recoveryDays===0)return null;const d=Math.min(s.dormancy.recoveryDays,5);return o[d]||null},[s?.dormancy]),u=t?.spirit_animal||"companion",m=n.useCallback((d,g)=>{if(!d||d.length===0)return"";const y=`${new Date().toDateString()}-${g}-${u}`,v=Math.floor(Di(y)*d.length);return d[v]},[u]),p=n.useMemo(()=>{if(!r)return"Hello, friend.";if(c==="recovering"&&l)return l;if(c==="recovering"&&r.recovery_greetings?.length)return m(r.recovery_greetings,"recovery");const d=s?.evolutionPath?.path;if(d&&s?.evolutionPath?.isLocked){const g=r.path_greetings?.[d];if(g?.length&&Di(`${new Date().toDateString()}-path-chance`)<.2)return m(g,`path-${d}`)}switch(c){case"thriving":return m(r.care_high_greetings,"thriving")||m(r.greeting_templates,"default");case"content":return m(r.care_medium_greetings,"content")||m(r.greeting_templates,"default");case"concerned":return m(r.care_low_greetings,"concerned")||m(r.concern_templates,"concern");case"desperate":return m(r.care_critical_greetings,"desperate")||m(r.concern_templates,"concern");default:return m(r.greeting_templates,"default")}},[r,c,s?.evolutionPath,l,m]),h=n.useMemo(()=>{if(!r||!s?.bond)return null;const d=Math.min(5,Math.max(1,s.bond.level)),g=r.bond_level_dialogue?.[String(d)];return!g||g.length===0?null:m(g,`bond-${d}`)},[r,s?.bond,m]),f=n.useMemo(()=>r?m(r.encouragement_templates,"encouragement"):null,[r,m]);return{greeting:p,bondDialogue:h,encouragement:f,dialogueMood:c,voiceStyle:r?.voice_style||"",personalityTraits:r?.personality_traits||[],isLoading:i||a}}const Nx={thriving:{color:"text-cosmiq-glow",ringColor:"ring-cosmiq-glow/50",bgColor:"bg-cosmiq-glow/10"},content:{color:"text-celestial-blue",ringColor:"ring-celestial-blue/50",bgColor:"bg-celestial-blue/10"},concerned:{color:"text-amber-400",ringColor:"ring-amber-400/50",bgColor:"bg-amber-400/10"},desperate:{color:"text-destructive",ringColor:"ring-destructive/50",bgColor:"bg-destructive/10"},recovering:{color:"text-green-400",ringColor:"ring-green-400/50",bgColor:"bg-green-400/10"}},Ac=n.memo(({className:t,showBondInfo:s=!1})=>{const{greeting:a,bondDialogue:r,dialogueMood:i,isLoading:o}=_x(),{companion:c}=st(),l=c?.current_image_url,u=c?.spirit_animal||"Companion",[m,p]=n.useState(a),[h,f]=n.useState(!1);if(n.useEffect(()=>{if(a!==m&&!h){f(!0);const y=setTimeout(()=>{p(a),f(!1)},300);return()=>clearTimeout(y)}},[a,m,h]),o)return e.jsx("div",{className:E("h-16 bg-card/30 rounded-xl animate-pulse",t)});const d=Nx[i],g=s?r:null;return e.jsxs(_.div,{className:E("relative overflow-hidden rounded-xl border border-border/30",d.bgColor,t),initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent pointer-events-none"}),e.jsx("div",{className:"relative p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:E("flex-shrink-0 rounded-lg overflow-hidden","ring-2",d.ringColor),children:e.jsxs(qs,{className:"h-10 w-10 rounded-lg",children:[l?e.jsx(Ls,{src:l,alt:u,className:"object-cover"}):null,e.jsx(Fs,{className:"rounded-lg bg-primary/20 text-primary",children:u.charAt(0).toUpperCase()})]})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(be,{mode:"wait",children:e.jsxs(_.p,{className:"text-sm text-foreground/90 leading-relaxed",initial:{opacity:0,y:5},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},transition:{duration:.2},children:['"',m,'"']},m)}),g&&e.jsxs(_.p,{className:"text-xs text-muted-foreground mt-2 italic",initial:{opacity:0},animate:{opacity:1},transition:{delay:.3},children:['"',g,'"']})]})]})})]})});Ac.displayName="CompanionDialogue";const Pi=["I... I can see you again! You came back for me...","You didn't give up on me... I'll never forget this.","The darkness is fading... because of you.","I dreamed of this moment. You're really here.","My heart feels warm again. Thank you for believing in me."],Ai={1:"A bond has been renewed.",2:"Your connection deepens through adversity.",3:"Trust restored through dedication.",4:"An unbreakable bond forged through care.",5:"A legendary bond â€” you never abandoned them."},Rc=n.memo(({isOpen:t,onClose:s,companionName:a,companionImageUrl:r,dormantImageUrl:i,bondLevel:o})=>{const[c,l]=n.useState(!1),[u,m]=n.useState(0),p=Pi[Math.floor(Math.random()*Pi.length)],h=Ai[Math.min(5,o)]||Ai[1];return n.useEffect(()=>{if(!t){l(!1),m(0);return}const f=setTimeout(()=>m(1),500),d=setTimeout(()=>{l(!0),m(2);const v=Date.now()+3e3,b=["#FFD700","#FF69B4","#00CED1","#9370DB"];(function x(){ut({particleCount:3,angle:60,spread:55,origin:{x:0},colors:b}),ut({particleCount:3,angle:120,spread:55,origin:{x:1},colors:b}),Date.now()<v&&requestAnimationFrame(x)})()},2e3),g=setTimeout(()=>m(3),3500);return()=>{clearTimeout(f),clearTimeout(d),clearTimeout(g)}},[t]),e.jsx(ct,{open:t,onOpenChange:f=>!f&&s(),children:e.jsx(ot,{className:"sm:max-w-md bg-gradient-to-br from-slate-900 via-purple-900/50 to-slate-900 border-amber-500/30",hideCloseButton:!0,children:e.jsxs("div",{className:"flex flex-col items-center py-6 space-y-6",children:[e.jsx(_.div,{className:"absolute inset-0 overflow-hidden rounded-lg",initial:{opacity:0},animate:{opacity:u>=1?1:0},children:e.jsx(_.div,{className:"absolute inset-0 bg-gradient-radial from-amber-500/20 via-transparent to-transparent",animate:{scale:[1,1.2,1],opacity:[.3,.6,.3]},transition:{duration:3,repeat:1/0,ease:"easeInOut"}})}),e.jsxs(_.div,{className:"text-center z-10",initial:{opacity:0,y:-20},animate:{opacity:u>=1?1:0,y:0},transition:{delay:.3},children:[e.jsx(Fo,{className:"w-8 h-8 text-amber-400 mx-auto mb-2 animate-pulse"}),e.jsx("h2",{className:"text-2xl font-heading font-bold bg-gradient-to-r from-amber-300 via-yellow-200 to-amber-300 bg-clip-text text-transparent",children:"Awakening"})]}),e.jsxs("div",{className:"relative w-48 h-48 z-10",children:[e.jsx(be,{children:!c&&i&&e.jsx(_.img,{src:i,alt:`Sleeping ${a}`,className:"absolute inset-0 w-full h-full object-cover rounded-2xl",style:{filter:"grayscale(0.5) brightness(0.6)"},initial:{opacity:1,scale:.95},exit:{opacity:0,scale:.8,filter:"grayscale(0) brightness(1.5)"},transition:{duration:1}})}),e.jsxs(_.div,{className:"absolute inset-0",initial:{opacity:0,scale:.8},animate:{opacity:c?1:0,scale:c?1:.8},transition:{duration:1,delay:.5},children:[e.jsx(_.div,{className:"absolute inset-0 rounded-2xl",animate:{boxShadow:["0 0 20px rgba(255, 215, 0, 0.3)","0 0 40px rgba(255, 215, 0, 0.5)","0 0 20px rgba(255, 215, 0, 0.3)"]},transition:{duration:2,repeat:1/0}}),e.jsx("img",{src:r,alt:`Awakened ${a}`,className:"w-full h-full object-cover rounded-2xl ring-4 ring-amber-400/50"}),[...Array(6)].map((f,d)=>e.jsx(_.div,{className:"absolute",style:{top:`${20+Math.random()*60}%`,left:`${10+Math.random()*80}%`},animate:{opacity:[0,1,0],scale:[.5,1,.5],y:[0,-10,0]},transition:{duration:1.5,repeat:1/0,delay:d*.3},children:e.jsx(et,{className:"w-4 h-4 text-amber-300"})},d))]})]}),e.jsx(be,{children:u>=3&&e.jsxs(_.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"text-center space-y-4 z-10 px-4",children:[e.jsx("div",{className:"p-4 rounded-xl bg-muted/20 border border-amber-500/20",children:e.jsxs("p",{className:"text-foreground/90 italic",children:['"',p,'"']})}),e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},className:"flex items-center justify-center gap-2 text-amber-400",children:[e.jsx(Xt,{className:"w-4 h-4"}),e.jsx("span",{className:"text-sm font-medium",children:h})]}),e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},transition:{delay:1},className:"flex items-center justify-center gap-2 text-purple-400 text-sm",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsx("span",{children:"Your companion will remember this moment"})]})]})}),e.jsx(be,{children:u>=3&&e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:1.5},children:e.jsx(B,{onClick:s,className:"bg-gradient-to-r from-amber-500 to-yellow-500 hover:from-amber-600 hover:to-yellow-600 text-slate-900 font-bold px-8",children:"Welcome Back"})})})]})})})});Rc.displayName="WakeUpCelebration";const kx=["vitality","wisdom","discipline","resolve","creativity","alignment"],Ri=100,Ii=1e3,Cx=300,Sx=({companion:t})=>{const[s,a]=n.useState(null),r=c=>t[c]??Cx,i=c=>(c-Ri)/(Ii-Ri)*100,o=s?di[s]:null;return e.jsxs(e.Fragment,{children:[e.jsx(Me,{className:"p-3 bg-gradient-to-br from-secondary/30 to-secondary/10 border-primary/20",children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("h3",{className:"text-xs font-bold text-center text-muted-foreground uppercase tracking-wide",children:"Companion Stats"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:kx.map(c=>{const l=di[c],u=r(c),m=i(u);return e.jsxs("button",{onClick:()=>a(c),className:"p-2 rounded-lg bg-background/50 hover:bg-background/80 transition-all text-left space-y-1.5 border border-transparent hover:border-primary/20",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-sm",children:l.icon}),e.jsx("span",{className:E("text-xs font-medium",l.color),children:l.name})]}),e.jsx("span",{className:"text-[10px] text-muted-foreground font-mono",children:u})]}),e.jsx("div",{className:"relative h-1.5 bg-secondary/50 rounded-full overflow-hidden",children:e.jsx("div",{className:E("absolute inset-y-0 left-0 rounded-full transition-all duration-500",l.progressColor),style:{width:`${m}%`}})})]},c)})}),e.jsx("p",{className:"text-[10px] text-center text-muted-foreground/70 italic",children:"Tap a stat to learn more"})]})}),e.jsx(ct,{open:!!s,onOpenChange:c=>!c&&a(null),children:e.jsxs(ot,{className:"max-w-md",children:[e.jsxs(as,{children:[e.jsxs(St,{className:"flex items-center gap-2 text-xl",children:[o?.icon," ",o?.name]}),e.jsxs(_s,{className:"sr-only",children:["Learn about the ",o?.name," attribute"]})]}),o&&s&&e.jsxs("div",{className:"space-y-4 text-sm",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Current Level:"}),e.jsxs("span",{className:"font-mono font-semibold",children:[r(s)," / ",Ii]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-foreground mb-1",children:"What it means:"}),e.jsx("p",{className:"text-muted-foreground",children:o.whatItMeans})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold text-foreground mb-2",children:"Boosted by:"}),e.jsx("ul",{className:"space-y-1.5 text-muted-foreground",children:o.boostedBy.map((c,l)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-primary mt-0.5",children:"â€¢"}),e.jsx("span",{children:c})]},l))})]}),e.jsxs("div",{className:"pt-2 border-t border-border/50",children:[e.jsx("h4",{className:"font-semibold text-foreground mb-1",children:"When it grows:"}),e.jsx("p",{className:"text-muted-foreground italic",children:o.whenGrows})]})]})]})})]})},Tx=800,qi=12,Ex="/placeholder-companion.svg",Mx=t=>{const s={"#FF0000":"Red","#FF4500":"Orange Red","#FF6347":"Tomato","#FFA500":"Orange","#FFD700":"Gold","#FFFF00":"Yellow","#00FF00":"Lime","#00FA9A":"Spring Green","#008000":"Green","#00FFFF":"Cyan","#00CED1":"Turquoise","#4169E1":"Royal Blue","#0000FF":"Blue","#000080":"Navy","#4B0082":"Indigo","#9370DB":"Purple","#8B008B":"Dark Magenta","#FF00FF":"Magenta","#FF1493":"Deep Pink","#FF69B4":"Hot Pink","#FFC0CB":"Pink","#FFFFFF":"White","#C0C0C0":"Silver","#808080":"Gray","#000000":"Black","#A52A2A":"Brown","#D2691E":"Chocolate"},a=t.toUpperCase();if(s[a])return s[a];const r=t.replace("#",""),i=parseInt(r.substring(0,2),16),o=parseInt(r.substring(2,4),16),c=parseInt(r.substring(4,6),16),l=Math.max(i,o,c),u=Math.min(i,o,c);return l-u<30?l>200?"White":l>150?"Light Gray":l>100?"Gray":l>50?"Dark Gray":"Black":i===l?o>c?o>150?"Yellow":"Orange":i>150?"Red":"Dark Red":o===l?i>c?"Yellow Green":o>150?"Green":"Dark Green":i>o?c>150?"Purple":"Dark Purple":c>150?"Blue":"Dark Blue"},Ic=n.memo(()=>{ce(),yt();const{companion:t,nextEvolutionXP:s,progressToNext:a,evolveCompanion:r,isLoading:i,canEvolve:o,triggerManualEvolution:c}=st(),{unlockedSkins:l}=rx(),{health:u,needsWelcomeBack:m}=Tc(),{regenerate:p,isRegenerating:h,maxRegenerations:f,generationPhase:d,retryCount:g}=ix(),{equippedRewards:y}=Ec(),{isEvolvingLoading:v}=lr(),{showCelebration:b,dismissCelebration:x,companionName:j,companionImageUrl:w,dormantImageUrl:D,bondLevel:S}=lx(),{cssStyles:M,animationClass:C,care:R,evolutionPath:T,isDormant:q,hasDormancyWarning:k}=nx(u.moodState,u.hunger,u.happiness,u.isAlive,u.recoveryProgress),[P,A]=n.useState(!1),[L,H]=n.useState(!1),[I,te]=n.useState(0),[V,z]=n.useState(!1),[W,Q]=n.useState(!1),[U,$]=n.useState(!1),[J,O]=n.useState(!1),[le,G]=n.useState(null),Z=n.useRef(null),he=n.useRef(!1),ve=n.useRef(null),we=n.useRef(null),je=t?.image_regenerations_used??0,ke=Math.max(0,f-je),Ae=n.useCallback(oe=>{if(!(!t||h||ke<=0)){if("touches"in oe&&oe.touches[0]){const Ee=oe.touches[0];ve.current={x:Ee.clientX,y:Ee.clientY}}else ve.current=null;he.current=!1,Z.current=setTimeout(()=>{he.current=!0,O(!0)},Tx)}},[t,h,ke]),Re=n.useCallback(()=>{Z.current&&(clearTimeout(Z.current),Z.current=null),ve.current=null},[]),Ge=n.useCallback(oe=>{if(!ve.current||!Z.current)return;const Ee=oe.touches[0];if(!Ee)return;const Ue=Math.abs(Ee.clientX-ve.current.x),ft=Math.abs(Ee.clientY-ve.current.y);(Ue>qi||ft>qi)&&Re()},[Re]),ge=n.useCallback(oe=>{oe.key!=="Enter"&&oe.key!==" "||(oe.preventDefault(),!(!t||h||ke<=0)&&O(!0))},[t,h,ke]),Te=n.useCallback(()=>{t&&(p({id:t.id,spirit_animal:t.spirit_animal,core_element:t.core_element,favorite_color:t.favorite_color,current_stage:t.current_stage,eye_color:t.eye_color,fur_color:t.fur_color}),O(!1))},[t,p]),Le=n.useMemo(()=>l?.find(oe=>oe.is_equipped)?.companion_skins,[l]),F=n.useMemo(()=>{if(!Le?.css_effect)return{};try{const oe=Le.css_effect;if(Le.skin_type==="aura"&&oe.glowColor&&typeof oe.glowColor=="string")return{boxShadow:`0 0 30px ${oe.glowColor}, 0 0 60px ${oe.glowColor}`,filter:`drop-shadow(0 0 20px ${oe.glowColor})`};if(Le.skin_type==="frame"&&oe.borderColor&&typeof oe.borderColor=="string")return{border:`${oe.borderWidth||"3px"} solid ${oe.borderColor}`,boxShadow:oe.shimmer?`0 0 20px ${oe.borderColor}`:void 0}}catch(oe){return console.error("Failed to parse skin effects:",oe),{}}return{}},[Le]),de=n.useMemo(()=>{const oe={};if(y.frame?.epic_rewards?.css_effect){const Ee=y.frame.epic_rewards.css_effect;Ee.borderColor&&(oe.borderColor=Ee.borderColor,oe.borderWidth=Ee.borderWidth||"4px",oe.borderStyle="solid")}if(y.effect?.epic_rewards?.css_effect){const Ee=y.effect.epic_rewards.css_effect;Ee.glowColor&&(oe.boxShadow=`0 0 30px ${Ee.glowColor}, 0 0 60px ${Ee.glowColor}`)}return oe},[y]),ae=n.useMemo(()=>y.background?.epic_rewards?.css_effect&&y.background.epic_rewards.css_effect.gradient||null,[y]);n.useEffect(()=>{const oe=window.matchMedia("(prefers-reduced-motion: reduce)");z(oe.matches);const Ee=Ue=>z(Ue.matches);return oe.addEventListener("change",Ee),()=>oe.removeEventListener("change",Ee)},[]),n.useEffect(()=>{m&&!U&&t&&Q(!0)},[m,U,t]);const fe=n.useMemo(()=>q&&t?.dormant_image_url?t.dormant_image_url:u.isNeglected&&u.neglectedImageUrl?u.neglectedImageUrl:t?.current_image_url,[q,t?.dormant_image_url,u.isNeglected,u.neglectedImageUrl,t?.current_image_url])||Ex;if(n.useEffect(()=>{we.current!==fe&&(we.current=fe,A(!1),H(!1))},[fe]),n.useEffect(()=>()=>{Z.current&&clearTimeout(Z.current)},[]),n.useEffect(()=>{(async()=>{if(!t)return;if(t.cached_creature_name){G(t.cached_creature_name);return}const{data:Ee}=await N.from("companion_evolution_cards").select("creature_name").eq("companion_id",t.id).eq("evolution_stage",t.current_stage).maybeSingle();Ee?.creature_name?(G(Ee.creature_name),N.from("user_companion").update({cached_creature_name:Ee.creature_name}).eq("id",t.id)):G(t.spirit_animal.charAt(0).toUpperCase()+t.spirit_animal.slice(1))})()},[t?.id,t?.current_stage,t?.cached_creature_name]),i)return e.jsx(mx,{});if(!t)return null;const Ce=mr(t.current_stage),De=Mx(t.favorite_color),re=s??t.current_xp,_e=t.current_stage>=20;return e.jsxs(e.Fragment,{children:[e.jsxs(Me,{className:"relative overflow-hidden bg-card/25 backdrop-blur-2xl border-celestial-blue/20 hover:border-nebula-pink/40 transition-all duration-500 animate-scale-in",children:[ae?e.jsx("div",{className:"absolute inset-0 opacity-70 transition-opacity duration-500",style:{background:ae}}):e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-nebula-pink/10 via-celestial-blue/10 to-cosmiq-glow/10 opacity-60 animate-nebula-shift"}),e.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(circle_at_top_right,hsl(var(--celestial-blue)/0.2),transparent_50%)]"}),e.jsx("div",{className:"absolute inset-0 bg-[radial-gradient(circle_at_bottom_left,hsl(var(--nebula-pink)/0.2),transparent_50%)]"})]}),e.jsxs("div",{className:"relative p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col gap-1",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("h2",{className:`text-3xl font-heading font-black bg-gradient-to-r from-primary via-accent to-primary bg-clip-text text-transparent ${V?"":"animate-gradient"}`,children:Ce}),e.jsx(hx,{title:"Stage",description:"Your companion's evolution stage"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground font-medium",children:["Stage ",t.current_stage]})]}),e.jsx("div",{className:`h-14 w-14 rounded-full bg-gradient-to-br from-primary/30 to-accent/30 flex items-center justify-center shadow-glow ${V?"":"animate-pulse"}`,"aria-hidden":"true",children:e.jsx(se,{className:"h-7 w-7 text-primary"})})]}),e.jsx("p",{className:"text-center text-2xl font-semibold text-primary/90 tracking-wide -mt-1",children:le||"Companion"}),e.jsxs("div",{className:"flex justify-center py-2 relative group",role:"img","aria-label":`Your companion at stage ${t.current_stage}: ${Ce}`,children:[e.jsx("div",{className:`absolute inset-0 blur-3xl opacity-50 group-hover:opacity-70 transition-opacity duration-500 ${V?"animate-none":"animate-orbit"}`,style:{background:`radial-gradient(circle, hsl(var(--celestial-blue) / ${(t.vitality??300)/600}), hsl(var(--nebula-pink) / ${(t.vitality??300)/600}), transparent)`},"aria-hidden":"true"}),e.jsx("div",{className:`absolute inset-0 bg-gradient-to-r from-celestial-blue/20 via-nebula-pink/20 to-cosmiq-glow/20 blur-3xl opacity-50 group-hover:opacity-70 transition-opacity duration-500 ${V?"animate-none":""}`,"aria-hidden":"true"}),e.jsxs("div",{className:"relative select-none focus-visible:ring-2 focus-visible:ring-primary/70 rounded-2xl outline-none",role:"button",tabIndex:0,"aria-label":`Press and hold to regenerate your companion. ${ke} regeneration${ke===1?"":"s"} remaining.`,onMouseDown:Ae,onMouseUp:Re,onMouseLeave:Re,onTouchStart:Ae,onTouchMove:Ge,onTouchEnd:Re,onTouchCancel:Re,onKeyDown:ge,children:[e.jsx("div",{className:`absolute inset-0 rounded-2xl ${V?"":"star-shimmer"}`,"aria-hidden":"true"}),e.jsx("div",{className:`absolute inset-0 bg-gradient-to-br from-nebula-pink/30 to-celestial-blue/30 rounded-2xl blur-xl ${V?"":"animate-pulse"}`,"aria-hidden":"true"}),!P&&!L&&e.jsxs("div",{className:"relative w-64 h-64 rounded-2xl bg-gradient-to-br from-primary/20 to-accent/20 animate-pulse flex items-center justify-center",role:"status","aria-live":"polite","aria-label":"Loading companion image",children:[e.jsx(se,{className:"h-12 w-12 text-primary/50 animate-spin","aria-hidden":"true"}),e.jsx("span",{className:"sr-only",children:"Loading companion image"})]}),L&&e.jsx("div",{className:"relative w-64 h-64 rounded-2xl bg-gradient-to-br from-destructive/20 to-destructive/10 flex items-center justify-center border-2 border-destructive/30",role:"alert","aria-live":"assertive",children:e.jsxs("div",{className:"text-center p-4",children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",id:"image-error-message",children:"Image unavailable"}),e.jsx("button",{onClick:()=>{H(!1),A(!1),te(oe=>oe+1)},className:"text-xs text-primary hover:underline focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 rounded px-2 py-1","aria-label":"Retry loading companion image","aria-describedby":"image-error-message",children:"Try again"})]})}),e.jsx("img",{src:fe,alt:`${Ce} companion at stage ${t.current_stage}`,className:`relative w-64 h-64 object-cover rounded-2xl shadow-2xl ring-4 transition-all duration-500 group-hover:scale-105 ${P?"opacity-100":"opacity-0 absolute"} ${u.isNeglected?"ring-destructive/50":"ring-primary/30"} ${h?"animate-pulse":""} ${C}`,style:{...F,...M,...de},onLoad:()=>{A(!0),H(!1)},onError:()=>{H(!0),A(!1)},loading:"lazy",decoding:"async",draggable:!1},I),e.jsx(wx,{show:k&&!q,daysUntilDormancy:R.dormancy.daysUntilDormancy??void 0}),e.jsx(jx,{isDormant:R.dormancy.isDormant,recoveryDays:R.dormancy.recoveryDays,daysUntilWake:R.dormancy.daysUntilWake})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-center items-center gap-3 mb-3 flex-wrap",children:[e.jsx(gx,{element:t.core_element,stage:t.current_stage,showStage:!0}),e.jsx(Mc,{})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-sm font-medium text-muted-foreground mb-2",id:"xp-progress-label",children:_e?`Stage ${t.current_stage} maxed`:`${t.current_xp} / ${re} XP to next evolution`}),e.jsx(ts,{value:a,className:"h-3 rounded-full shadow-inner","aria-labelledby":"xp-progress-label","aria-valuenow":t.current_xp,"aria-valuemin":0,"aria-valuemax":re})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-3 pt-2",children:[e.jsxs("div",{className:"text-center p-3 rounded-xl bg-gradient-to-br from-primary/5 to-accent/5 border border-primary/10 hover:border-primary/30 transition-all",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Color"}),e.jsx("p",{className:"font-medium text-sm",children:De})]}),e.jsxs("div",{className:"text-center p-3 rounded-xl bg-gradient-to-br from-accent/5 to-primary/5 border border-accent/10 hover:border-accent/30 transition-all",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Spirit"}),e.jsx("p",{className:"font-medium text-sm capitalize",children:t.spirit_animal})]}),e.jsxs("div",{className:"text-center p-3 rounded-xl bg-gradient-to-br from-primary/5 to-accent/5 border border-primary/10 hover:border-primary/30 transition-all",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-1",children:"Element"}),e.jsx("p",{className:"font-medium text-sm capitalize",children:t.core_element})]})]}),e.jsx(Sx,{companion:t})]}),e.jsx("div",{className:"flex items-center justify-center gap-3",children:T.path&&e.jsx(Pc,{path:T.path,isLocked:T.isLocked})}),e.jsx(Ac,{showBondInfo:!0,className:"mt-2"}),e.jsx(be,{children:o&&e.jsx(Dc,{onEvolve:c,isEvolving:r.isPending})})]})]}),e.jsx(yx,{isOpen:W,onClose:()=>{Q(!1),$(!0)}}),e.jsx(Rc,{isOpen:b,onClose:x,companionName:j,companionImageUrl:w,dormantImageUrl:D,bondLevel:S}),e.jsx(vx,{isOpen:J,onClose:()=>O(!1),onConfirm:Te,isRegenerating:h,regenerationsRemaining:ke,generationPhase:d,retryCount:g})]})});Ic.displayName="CompanionDisplay";const Dx=[{action:"Complete a habit",xp:"7-24 XP",icon:"âœ“"},{action:"Finish all daily habits",xp:"+15 XP bonus",icon:"ðŸŽ¯"},{action:"Complete daily missions",xp:"8-28 XP (Main Quest 1.5x)",icon:"âš¡"},{action:"Challenge day bonus",xp:"25 XP",icon:"ðŸ’ª"},{action:"Streak milestones",xp:"15 XP",icon:"ðŸ”¥"},{action:"Weekly challenge complete",xp:"60 XP",icon:"ðŸ†"}],qc=n.memo(({currentStage:t,currentXP:s,nextEvolutionXP:a,progressPercent:r,showBondProgress:i=!0})=>{const o=Math.min(t+1,20),c=mr(o),l=a-s,u=t>=20,{currentBond:m,isLoading:p}=Cn(),h=n.useMemo(()=>{if(!m?.nextMilestone)return 100;const f=b=>Math.round(25*Math.pow(1.8,b-2)),d=m.level===1?0:f(m.level),y=f(m.level+1)-d,v=m.totalInteractions-d;return Math.min(100,Math.max(0,v/y*100))},[m]);return u?e.jsx(Me,{className:"p-5 bg-card/25 backdrop-blur-2xl border-accent/20",children:e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-accent/20 flex items-center justify-center",children:e.jsx(se,{className:"h-5 w-5 text-accent"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-heading font-bold text-sm",children:"Maximum Evolution!"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Your companion has reached its final form"})]})]})}):e.jsx(Me,{className:"p-5 bg-card/25 backdrop-blur-2xl border-primary/20 hover:border-primary/40 transition-all duration-300",children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-primary/20 flex items-center justify-center",children:e.jsx(zt,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-heading font-bold text-sm",children:"Next Evolution"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:c})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsx("span",{className:"text-muted-foreground",children:"Progress"}),e.jsx("span",{className:"font-medium text-primary",children:l>0?`${l} XP needed`:"Ready!"})]}),e.jsx(ts,{value:r,className:"h-2"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s," / ",a," XP"]})]}),i&&m&&!p&&e.jsx("div",{className:"space-y-2 pt-3 border-t border-border/30",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-lg",children:m.icon}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex justify-between text-xs",children:[e.jsxs("span",{className:"text-muted-foreground",children:["Bond: ",m.name]}),m.nextMilestone&&e.jsxs("span",{className:"font-medium text-primary/80",children:["â†’ ",m.nextMilestone.name]})]}),e.jsx(ts,{value:h,className:"h-1.5 mt-1"})]})]})}),e.jsxs("div",{className:"space-y-2 pt-2 border-t border-border/50",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground",children:"Quick XP Tips:"}),e.jsx("div",{className:"space-y-1.5",children:Dx.slice(0,3).map((f,d)=>e.jsxs("div",{className:"flex items-center justify-between text-xs",children:[e.jsxs("span",{className:"text-muted-foreground flex items-center gap-1.5",children:[e.jsx("span",{children:f.icon}),f.action]}),e.jsx("span",{className:"font-medium text-primary",children:f.xp})]},d))})]})]})})});qc.displayName="NextEvolutionPreview";const Lc=n.memo(()=>{const{user:t}=ce(),{currentStreak:s=0,multiplier:a=1,nextMilestone:r}=fr(),i=new Date,o=i.toLocaleDateString("en-CA"),c=new Date(i.getFullYear(),i.getMonth(),i.getDate()).toISOString(),{data:l}=ye({queryKey:["xp-breakdown",o,t?.id],queryFn:async()=>{if(!t)return null;const{data:m}=await N.from("xp_events").select("*").eq("user_id",t.id).gte("created_at",c).order("created_at",{ascending:!1});if(!m)return{total:0,byType:{}};const p=m.reduce((f,d)=>(f[d.event_type]=(f[d.event_type]||0)+d.xp_earned,f),{});return{total:m.reduce((f,d)=>f+d.xp_earned,0),byType:p,events:m}},enabled:!!t,staleTime:60*1e3}),u={habit_complete:"Habits",task_complete:"Quests",check_in:"Check-in",pep_talk:"Pep Talk",pep_talk_listen:"Pep Talk Listen",all_habits_complete:"All Habits Bonus",mission_check_in:"Mission",mission_pep_talk:"Mission",mission_habits_3:"Mission",mission_all_habits:"Mission",mission_profile_update:"Profile Update"};return e.jsx(Me,{className:"p-5 md:p-6 bg-card/25 backdrop-blur-2xl border-primary/20 select-none",children:e.jsxs("div",{className:"space-y-4",onContextMenu:m=>m.preventDefault(),children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(se,{className:"h-5 w-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-heading font-black text-lg",children:"Today's XP"}),e.jsxs("p",{className:"text-2xl font-bold text-primary",children:[l?.total||0," XP"]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between p-3 rounded-lg bg-accent/10 border border-accent/20",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pt,{className:"h-5 w-5 text-orange-500"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm font-bold",children:[s," Day Streak"]}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[a,"x XP Multiplier"]})]})]}),r.daysRemaining>0&&e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-xs text-muted-foreground",children:"Next milestone"}),e.jsxs("p",{className:"text-sm font-bold",children:[r.daysRemaining," days"]})]})]}),l&&Object.keys(l.byType).length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-xs font-bold text-muted-foreground",children:"XP Sources"}),Object.entries(l.byType).map(([m,p])=>e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:u[m]||m}),e.jsxs("span",{className:"font-bold text-primary",children:["+",p," XP"]})]},m))]}),l&&l.total>0&&e.jsxs("div",{className:"flex items-center gap-2 p-3 rounded-lg bg-primary/5 border border-primary/10",children:[e.jsx(zt,{className:"h-4 w-4 text-primary"}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:["Keep this up for 7 days = ",(l.total*7).toFixed(0)," XP"]})]})]})})});Lc.displayName="XPBreakdown";const Px=()=>{const{user:t}=ce(),{toast:s}=Ut(),a=Se(),{awardCustomXP:r}=bt(),{checkFirstTimeAchievements:i}=pr(),o=Ll(),[c,l]=n.useState(null),[u,m]=n.useState(null),{data:p,isLoading:h,error:f}=ye({queryKey:["daily-missions",o,t?.id],queryFn:async()=>{if(!t)return[];l(null);const{data:b,error:x}=await N.from("daily_missions").select("*").eq("user_id",t.id).eq("mission_date",o);if(x)throw x;if(!b||b.length===0){const{data:j,error:w}=await N.functions.invoke("generate-daily-missions",{body:{userId:t.id}});if(w){console.error("Mission generation failed:",w);const S=w.message||"Unable to generate missions right now.";throw l(S),new Error(S)}const D=j?.missions||[];if(D.length===0){const S="No missions available right now. Please try again soon.";throw l(S),new Error(S)}return j?.theme&&m(j.theme),D}return l(null),b},enabled:!!t,staleTime:300*1e3,refetchOnWindowFocus:!1});n.useEffect(()=>{f&&s({title:c?"Mission generation failed":"Unable to load daily missions",description:c||f.message,variant:"destructive"})},[f,c,s]);const d=ie({mutationFn:async()=>{if(!t)throw new Error("Not authenticated");l(null);const{data:b,error:x}=await N.functions.invoke("generate-daily-missions",{body:{userId:t.id,forceRegenerate:!0}});if(x){const w=x.message||"Unable to regenerate missions right now.";throw l(w),new Error(w)}const j=b?.missions||[];if(j.length===0){const w="No missions were generated. Please try again soon.";throw l(w),new Error(w)}return j},onSuccess:()=>{a.invalidateQueries({queryKey:["daily-missions"]}),s({title:"Daily missions refreshed",description:"Fresh challenges are ready for you!"}),l(null)},onError:b=>{s({title:"Mission generation failed",description:b.message,variant:"destructive"})}}),g=ie({mutationFn:async b=>{if(!t?.id)throw new Error("User not authenticated");const x=p?.find(S=>S.id===b);if(!x)throw new Error("Mission not found");if(x.completed)throw new Error("Mission already completed");const{data:j,error:w}=await N.from("daily_missions").update({completed:!0,completed_at:new Date().toISOString()}).eq("id",b).eq("user_id",t.id).eq("completed",!1).select().maybeSingle();if(w)throw w;if(!j)throw new Error("Mission already completed");await r(x.xp_reward,`mission_${x.mission_type}`,"Mission Complete!",{mission_id:x.id});const{count:D}=await N.from("daily_missions").select("*",{count:"exact",head:!0}).eq("user_id",t.id).eq("completed",!0);return D===1&&await i("mission"),j},onSuccess:()=>{a.invalidateQueries({queryKey:["daily-missions"]}),s({title:"Mission Complete!",description:"XP awarded!"}),vn(),window.dispatchEvent(new CustomEvent("quest-completed"))},onError:b=>{s({title:"Mission not completed",description:b.message,variant:"destructive"})}}),y=p?.filter(b=>b.completed).length||0,v=p?.length||0;return{missions:p||[],isLoading:h,completeMission:g.mutateAsync,isCompleting:g.isPending,completedCount:y,totalCount:v,allComplete:y===v&&v>0,regenerateMissions:d.mutateAsync,isRegenerating:d.isPending,generationErrorMessage:c,missionTheme:u}},Ax=()=>{const{user:t}=ce(),s=Se(),{data:a,isLoading:r}=ye({queryKey:["activity-feed",t?.id],queryFn:async()=>{if(!t)return[];const{data:c,error:l}=await N.from("activity_feed").select("*").eq("user_id",t.id).order("created_at",{ascending:!1}).limit(50);if(l)throw l;return c},enabled:!!t}),i=ie({mutationFn:async({type:c,data:l})=>{if(!t)throw new Error("Not authenticated");const{data:u,error:m}=await N.from("activity_feed").insert([{user_id:t.id,activity_type:c,activity_data:l}]).select().maybeSingle();if(m)throw m;if(!u)throw new Error("Failed to create activity");return N.functions.invoke("generate-activity-comment",{body:{activityId:u.id}}).then(({error:p})=>{p&&console.error("Failed to generate activity comment:",p)}).catch(p=>{console.error("Activity comment generation failed:",p)}),u},onSuccess:()=>{s.invalidateQueries({queryKey:["activity-feed"]})}}),o=ie({mutationFn:async c=>{if(!t)throw new Error("Not authenticated");const{error:l}=await N.from("activity_feed").update({is_read:!0}).eq("id",c).eq("user_id",t.id);if(l)throw l},onSuccess:()=>{s.invalidateQueries({queryKey:["activity-feed"]})}});return{activities:a||[],isLoading:r,logActivity:i.mutate,markAsRead:o.mutate}},Rx={0:{name:"Reset Sunday",emoji:"ðŸŒ…",categories:["identity","wellness","growth"]},1:{name:"Momentum Monday",emoji:"ðŸš€",categories:["quick_win","growth","identity"]},2:{name:"Connection Tuesday",emoji:"ðŸ’œ",categories:["connection","gratitude","wellness"]},3:{name:"Wellness Wednesday",emoji:"ðŸ§˜",categories:["wellness","gratitude","quick_win"]},4:{name:"Gratitude Thursday",emoji:"âœ¨",categories:["gratitude","connection","identity"]},5:{name:"Future Friday",emoji:"ðŸ”®",categories:["identity","growth","quick_win"]},6:{name:"Soul Saturday",emoji:"ðŸŒŸ",categories:["wellness","gratitude","connection"]}},Ix={identity_complete_all_quests:{activityType:"all_quests_completed"},identity_complete_all_habits:{activityType:"all_habits_completed"},habit_complete_1:{activityType:"habit_completed",validator:(t,s,a)=>s>=a},habit_complete_3:{activityType:"habit_completed",validator:(t,s,a)=>s>=a},habit_complete_5:{activityType:"habit_completed",validator:(t,s,a)=>s>=a},all_habits:{activityType:"all_habits_completed"},habit_early_bird:{activityType:"habit_completed",validator:t=>new Date(t.completedAt||t.timestamp).getHours()<9},habit_night_owl:{activityType:"habit_completed",validator:t=>new Date(t.completedAt||t.timestamp).getHours()>=20},check_in_morning:{activityType:"check_in_completed"},mood_log:{activityType:"mood_logged",validator:(t,s,a)=>s>=a},reflection_write:{activityType:"reflection_created"},reflection_detailed:{activityType:"reflection_created",validator:t=>(t.note||"").split(/\s+/).length>=100},pep_talk_listen:{activityType:"pep_talk_listened"},pep_talk_full:{activityType:"pep_talk_listened",validator:t=>(t.completion||0)>=100},mentor_chat_start:{activityType:"mentor_message_sent"},mentor_chat_deep:{activityType:"mentor_message_sent",validator:(t,s,a)=>s>=a},library_explore:{activityType:"library_visited"},quote_favorite:{activityType:"quote_favorited"},quote_share:{activityType:"quote_shared"},pep_talk_share:{activityType:"pep_talk_shared"},companion_visit:{activityType:"companion_visited"},companion_interact:{activityType:["companion_visited","companion_evolved"],validator:(t,s,a)=>s>=a},challenge_join:{activityType:"challenge_started"},challenge_complete_day:{activityType:"challenge_day_completed"},streak_maintain:{activityType:"habit_completed",validator:t=>(t.currentStreak||0)>0},bonus_habit_streak:{activityType:"habit_completed",validator:t=>(t.currentStreak||0)>=3},bonus_perfect_day:{activityType:"all_habits_completed"},bonus_triple_threat:{activityType:"mission_completed",validator:t=>new Set(t.completedCategories||[]).size>=3}},qx=()=>{const t=new Date().getDay();return Rx[t]},Lx=()=>{const{user:t}=ce(),{activities:s}=Ax(),{awardCustomXP:a}=bt(),{toast:r}=Ut(),i=Se(),o=new Date,c=o.toLocaleDateString("en-CA"),l=new Date(o.getFullYear(),o.getMonth(),o.getDate()).getTime();n.useEffect(()=>{if(!t||!s||s.length===0)return;let u=!0;return(async()=>{try{const{data:p,error:h}=await N.from("daily_missions").select("*").eq("user_id",t.id).eq("mission_date",c).eq("completed",!1).eq("auto_complete",!0);if(h){console.error("Error fetching missions:",h);return}if(!p||p.length===0||!u)return;const f=s.filter(d=>new Date(d.created_at).getTime()>=l);for(const d of p){if(!u)break;const g=Ix[d.mission_type];if(!g)continue;const y=Array.isArray(g.activityType)?g.activityType:[g.activityType],v=f.filter(j=>y.includes(j.activity_type));let b=!1,x=d.progress_current;if(g.validator){for(const j of v)if(g.validator(j.activity_data,x,d.progress_target)&&(x++,x>=d.progress_target)){b=!0;break}}else x=v.length,b=x>=d.progress_target;if(x!==d.progress_current&&u){const{error:j}=await N.from("daily_missions").update({progress_current:x}).eq("id",d.id).eq("user_id",t.id);j||i.invalidateQueries({queryKey:["daily-missions"]})}if(b&&!d.completed&&u){const{data:j,error:w}=await N.from("daily_missions").update({completed:!0,completed_at:new Date().toISOString(),progress_current:d.progress_target}).eq("id",d.id).eq("user_id",t.id).eq("completed",!1).select();!w&&j&&j.length>0&&u&&(await a(d.xp_reward,`mission_${d.mission_type}`,`Mission Complete! ${d.mission_text}`,{mission_id:d.id,source:"auto_complete"}),r({title:"Mission Auto-Completed! ðŸŽ¯",description:`${d.mission_text} (+${d.xp_reward} XP)`}),vn(),ut({particleCount:50,spread:60,origin:{y:.7},colors:["#A76CFF","#C084FC","#E879F9"]}),i.invalidateQueries({queryKey:["daily-missions"]}))}}}catch(p){console.error("Error in mission auto-complete:",p)}})(),()=>{u=!1}},[s,t,c,l,a,r,i])},Fx=({onRetry:t,isRetrying:s,errorMessage:a})=>{const r=()=>{!t||s||t()};return e.jsx(Me,{className:"p-8 text-center bg-gradient-to-br from-accent/5 to-primary/5 border-dashed border-2 border-muted-foreground/20",children:e.jsxs("div",{className:"flex flex-col items-center gap-4 max-w-md mx-auto",children:[e.jsx("div",{className:"h-16 w-16 rounded-full bg-accent/10 flex items-center justify-center animate-pulse",children:e.jsx(Ze,{className:"h-8 w-8 text-accent"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl font-heading font-bold text-foreground",children:"Missions Refresh Daily"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Complete daily missions to earn bonus XP and help your companion evolve faster! Check back tomorrow for new challenges."})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx(se,{className:"h-3 w-3"}),e.jsx("span",{children:"New missions arrive at midnight"})]}),a&&e.jsx("p",{className:"text-xs text-destructive mt-2",children:a}),t&&e.jsx(B,{variant:"outline",size:"sm",onClick:r,disabled:s,className:"mt-2 gap-2",children:s?e.jsxs(e.Fragment,{children:[e.jsx(On,{className:"h-3 w-3 animate-spin"}),"Retrying..."]}):e.jsxs(e.Fragment,{children:[e.jsx(On,{className:"h-3 w-3"}),"Retry Generation"]})})]})})},Fc=n.memo(()=>{const{missions:t,isLoading:s,completeMission:a,isCompleting:r,completedCount:i,totalCount:o,allComplete:c,regenerateMissions:l,isRegenerating:u,generationErrorMessage:m,missionTheme:p}=Px();Lx();const h=p||qx();if(s)return e.jsx(Pf,{});if(t.length===0)return e.jsx(Fx,{onRetry:l,isRetrying:u,errorMessage:m});const f=i/o*100,d=t.filter(b=>!b.is_bonus),g=t.filter(b=>b.is_bonus),y=async b=>{$e.medium();try{await a(b),t.map(w=>w.id===b?{...w,completed:!0}:w).every(w=>w.completed)&&setTimeout(()=>{ut({particleCount:150,spread:120,origin:{y:.6},colors:["#A76CFF","#C084FC","#E879F9","#FFD700","#FFA500"],ticks:400,gravity:.6,scalar:1.5})},500)}catch(x){console.error("Failed to complete mission:",x),$e.light()}},v=b=>{const x=b.progress_target>1,j=x?b.progress_current/b.progress_target*100:0,w=b.auto_complete;return e.jsxs("div",{onContextMenu:D=>D.preventDefault(),className:`flex items-center justify-between p-2.5 sm:p-3 rounded-lg border transition-all select-none ${b.completed?"bg-accent/5 border-accent/20 opacity-60":"bg-background border-border hover:border-accent/40"} ${b.is_bonus?"border-yellow-500/30 bg-gradient-to-r from-yellow-500/5 to-orange-500/5":""}`,children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3 flex-1 min-w-0",children:[b.completed&&e.jsx(ms,{className:"h-4 w-4 sm:h-5 sm:w-5 text-accent flex-shrink-0"}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1 flex-wrap",children:[e.jsx("p",{className:`text-sm font-medium ${b.completed?"line-through":""}`,children:b.mission_text}),w&&!b.completed&&e.jsxs(Ne,{variant:"outline",className:"text-xs px-1.5 py-0",children:[e.jsx(Be,{className:"h-2.5 w-2.5 mr-1"}),"Auto"]}),b.is_bonus&&e.jsxs(Ne,{variant:"gold",className:"text-xs px-1.5 py-0",children:[e.jsx(se,{className:"h-2.5 w-2.5 mr-1"}),"Bonus"]}),b.difficulty==="hard"&&!b.completed&&e.jsxs(Ne,{variant:"outline",className:"text-xs px-1.5 py-0 border-red-500/50 text-red-600",children:[e.jsx(zt,{className:"h-2.5 w-2.5 mr-1"}),"Hard"]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("p",{className:"text-xs text-muted-foreground",children:["+",b.xp_reward," XP"]}),x&&!b.completed&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["â€¢ ",b.progress_current,"/",b.progress_target]})]}),x&&!b.completed&&e.jsx(ts,{value:j,className:"h-1 mt-1.5"})]})]}),!b.completed&&!w&&e.jsx(B,{size:"sm",variant:"outline",onClick:()=>y(b.id),disabled:r,className:"transition-transform hover:scale-105 active:scale-95 hover:bg-accent/10 hover:border-accent/60 min-w-[90px]",children:r?e.jsx("div",{className:"h-3 w-3 animate-spin rounded-full border-2 border-accent border-t-transparent"}):"Complete"})]},b.id)};return e.jsxs(Me,{className:"p-4 sm:p-5 md:p-6 bg-card/25 backdrop-blur-2xl border-accent/20 hover:border-accent/40 transition-all duration-500 hover:shadow-[0_0_40px_hsl(var(--accent)/0.15)] relative overflow-hidden group",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-accent/10 to-primary/10 pointer-events-none"}),e.jsxs("div",{className:"relative space-y-3 sm:space-y-4 z-10",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2 sm:gap-3",children:[e.jsx("div",{className:"h-9 w-9 sm:h-10 sm:w-10 rounded-full bg-accent/20 flex items-center justify-center flex-shrink-0",children:e.jsx(Ze,{className:"h-4 w-4 sm:h-5 sm:w-5 text-accent"})}),e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-1",children:e.jsx("h3",{className:"font-heading font-black text-base sm:text-lg",children:"Daily Missions"})}),e.jsxs("div",{className:"flex items-center gap-1.5 mt-0.5",children:[e.jsx("span",{className:"text-sm",children:h.emoji}),e.jsx("span",{className:"text-xs text-muted-foreground font-medium",children:h.name})]})]}),e.jsxs("p",{className:"text-[10px] sm:text-xs text-muted-foreground ml-auto",children:[i,"/",o," complete"]})]}),c&&e.jsx("div",{className:"text-[10px] sm:text-xs font-bold text-stardust-gold animate-pulse",children:"All Done! ðŸŽ‰"})]}),e.jsx(ts,{value:f,className:"h-2"}),e.jsx("div",{className:"space-y-2",children:d.map(v)}),g.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsx(se,{className:"h-3.5 w-3.5 text-stardust-gold"}),e.jsx("span",{className:"text-xs font-semibold text-stardust-gold",children:"Streak Bonus"})]}),g.map(v)]})]})]})});Fc.displayName="DailyMissionsContent";const Oc=n.memo(()=>e.jsx(jt,{fallback:e.jsx(fh,{}),children:e.jsx(Fc,{})}));Oc.displayName="DailyMissions";const Sn=Yu,gr=n.forwardRef(({className:t,...s},a)=>e.jsx($o,{ref:a,className:E("inline-flex h-11 items-center justify-center rounded-xl border border-border/50 bg-muted/45 p-1 text-muted-foreground backdrop-blur-sm",t),...s}));gr.displayName=$o.displayName;const Ot=n.forwardRef(({className:t,...s},a)=>e.jsx(Bo,{ref:a,className:E("inline-flex items-center justify-center whitespace-nowrap rounded-[10px] px-3 py-1.5 text-sm font-medium ring-offset-background transition-colors data-[state=active]:bg-card data-[state=active]:text-foreground data-[state=active]:shadow-[0_4px_12px_rgba(0,0,0,0.18)] data-[state=active]:border data-[state=active]:border-border/60 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50",t),...s}));Ot.displayName=Bo.displayName;const $t=n.forwardRef(({className:t,...s},a)=>e.jsx(Ho,{ref:a,className:E("mt-2 ring-offset-background focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2",t),...s}));$t.displayName=Ho.displayName;const Fa=[{id:"three_day_streak",achievementType:"streak_3_day",title:"Getting Started",description:"Maintained a 3-day streak",icon:"ðŸ”¥",tier:"bronze",category:"streaks",unlockHint:"Maintain a 3-day streak"},{id:"week_streak",achievementType:"streak_7_day",title:"Week of Discipline",description:"Maintained a 7-day streak",icon:"ðŸ†",tier:"silver",category:"streaks",unlockHint:"Maintain a 7-day streak"},{id:"two_week_streak",achievementType:"streak_14_day",title:"Fortnight Force",description:"Maintained a 14-day streak",icon:"âš¡",tier:"gold",category:"streaks",unlockHint:"Maintain a 14-day streak"},{id:"month_streak",achievementType:"streak_30_day",title:"Monthly Master",description:"Maintained a 30-day streak",icon:"ðŸ‘‘",tier:"platinum",category:"streaks",unlockHint:"Maintain a 30-day streak"},{id:"companion_stage_3",achievementType:"companion_stage_3",title:"First Evolution",description:"Reached companion stage 3",icon:"âœ¨",tier:"bronze",category:"companion",unlockHint:"Evolve your companion to Stage 3 (Cub)"},{id:"companion_stage_5",achievementType:"companion_stage_5",title:"Rising Star",description:"Reached companion stage 5",icon:"ðŸŒŸ",tier:"silver",category:"companion",unlockHint:"Evolve your companion to Stage 5 (Apprentice)"},{id:"companion_stage_10",achievementType:"companion_stage_10",title:"Champion Bond",description:"Reached companion stage 10",icon:"ðŸ…",tier:"gold",category:"companion",unlockHint:"Evolve your companion to Stage 10 (Champion)"},{id:"companion_stage_15",achievementType:"companion_stage_15",title:"Prime Evolution",description:"Reached companion stage 15",icon:"ðŸ’Ž",tier:"platinum",category:"companion",unlockHint:"Evolve your companion to Stage 15 (Prime)"},{id:"companion_stage_20",achievementType:"companion_stage_20",title:"Ultimate Form",description:"Reached companion stage 20",icon:"ðŸŒŒ",tier:"platinum",category:"companion",unlockHint:"Evolve your companion to Stage 20 (Ultimate)"},{id:"first_habit",achievementType:"first_habit",title:"Habit Starter",description:"Completed your first habit",icon:"âœ…",tier:"bronze",category:"firsts",unlockHint:"Complete your first habit"},{id:"first_quest",achievementType:"first_quest",title:"Quest Beginner",description:"Completed your first quest",icon:"âš”ï¸",tier:"bronze",category:"firsts",unlockHint:"Complete your first quest"},{id:"first_pep_talk",achievementType:"first_pep_talk",title:"First Listen",description:"Listened to your first pep talk",icon:"ðŸŽ§",tier:"bronze",category:"firsts",unlockHint:"Listen to a pep talk"},{id:"first_check_in",achievementType:"first_check_in",title:"Self Aware",description:"Completed your first check-in",icon:"ðŸªž",tier:"bronze",category:"firsts",unlockHint:"Complete a daily check-in"},{id:"first_epic",achievementType:"first_epic",title:"Epic Starter",description:"Created your first epic",icon:"ðŸš€",tier:"bronze",category:"firsts",unlockHint:"Create your first epic"},{id:"starpath_detox_warrior",achievementType:"starpath_detox_warrior",title:"Detox Warrior",description:"Completed the Detox Warrior star path",icon:"âš”ï¸",tier:"silver",category:"starpaths",unlockHint:"Complete the Detox Warrior star path"},{id:"starpath_dawn_champion",achievementType:"starpath_dawn_champion",title:"Dawn Champion",description:"Completed the Dawn Champion star path",icon:"ðŸŒ…",tier:"silver",category:"starpaths",unlockHint:"Complete the Dawn Champion star path"},{id:"starpath_mindful_master",achievementType:"starpath_mindful_master",title:"Mindful Master",description:"Completed the Mindful Master star path",icon:"ðŸ§˜",tier:"silver",category:"starpaths",unlockHint:"Complete the Mindful Master star path"},{id:"starpath_iron_mind",achievementType:"starpath_iron_mind",title:"Iron Mind",description:"Completed the Iron Mind star path",icon:"ðŸ§ ",tier:"gold",category:"starpaths",unlockHint:"Complete the Iron Mind star path"},{id:"starpath_body_forge",achievementType:"starpath_body_forge",title:"Body Forge",description:"Completed the Body Forge star path",icon:"ðŸ’ª",tier:"gold",category:"starpaths",unlockHint:"Complete the Body Forge star path"},{id:"starpath_clean_machine",achievementType:"starpath_clean_machine",title:"Clean Machine",description:"Completed the Clean Machine star path",icon:"ðŸ¥—",tier:"gold",category:"starpaths",unlockHint:"Complete the Clean Machine star path"},{id:"starpath_digital_minimalist",achievementType:"starpath_digital_minimalist",title:"Digital Minimalist",description:"Completed the Digital Minimalist star path",icon:"ðŸ“µ",tier:"gold",category:"starpaths",unlockHint:"Complete the Digital Minimalist star path"},{id:"starpath_scholars_path",achievementType:"starpath_scholars_path",title:"Scholar's Path",description:"Completed the Scholar's Path star path",icon:"ðŸ“š",tier:"platinum",category:"starpaths",unlockHint:"Complete the Scholar's Path star path"},{id:"starpath_sleep_sovereign",achievementType:"starpath_sleep_sovereign",title:"Sleep Sovereign",description:"Completed the Sleep Sovereign star path",icon:"ðŸ˜´",tier:"platinum",category:"starpaths",unlockHint:"Complete the Sleep Sovereign star path"},{id:"starpath_social_butterfly",achievementType:"starpath_social_butterfly",title:"Social Butterfly",description:"Completed the Social Butterfly star path",icon:"ðŸ¦‹",tier:"platinum",category:"starpaths",unlockHint:"Complete the Social Butterfly star path"},{id:"story_treasure_hunt",achievementType:"story_treasure_hunt_complete",title:"Fortune Seeker",description:"Completed a Treasure Hunt epic and defeated the boss",icon:"ðŸ’Ž",tier:"gold",category:"starpaths",unlockHint:"Complete a Treasure Hunt star path and defeat the final boss"},{id:"story_mystery",achievementType:"story_mystery_complete",title:"Truth Unveiler",description:"Completed a Mystery epic and defeated the boss",icon:"ðŸ”®",tier:"gold",category:"starpaths",unlockHint:"Complete a Mystery star path and defeat the final boss"},{id:"story_pilgrimage",achievementType:"story_pilgrimage_complete",title:"Soul Pilgrim",description:"Completed a Pilgrimage epic and defeated the boss",icon:"ðŸ§˜",tier:"gold",category:"starpaths",unlockHint:"Complete a Pilgrimage star path and defeat the final boss"},{id:"story_heroes_journey",achievementType:"story_heroes_journey_complete",title:"Legendary Hero",description:"Completed a Heroes Journey epic and defeated the boss",icon:"âš”ï¸",tier:"platinum",category:"starpaths",unlockHint:"Complete a Heroes Journey star path and defeat the final boss"},{id:"story_rescue_mission",achievementType:"story_rescue_mission_complete",title:"Cosmic Savior",description:"Completed a Rescue Mission epic and defeated the boss",icon:"ðŸ›¡ï¸",tier:"gold",category:"starpaths",unlockHint:"Complete a Rescue Mission star path and defeat the final boss"},{id:"story_exploration",achievementType:"story_exploration_complete",title:"Star Cartographer",description:"Completed an Exploration epic and defeated the boss",icon:"ðŸŒŒ",tier:"gold",category:"starpaths",unlockHint:"Complete an Exploration star path and defeat the final boss"},{id:"challenge_complete",achievementType:"challenge_complete",title:"Challenge Accepted",description:"Completed a challenge",icon:"ðŸŽ¯",tier:"silver",category:"challenges",unlockHint:"Complete any challenge"},{id:"challenge_5",achievementType:"challenge_5_complete",title:"Challenge Seeker",description:"Completed 5 challenges",icon:"ðŸ¹",tier:"gold",category:"challenges",unlockHint:"Complete 5 challenges"},{id:"perfect_day",achievementType:"perfect_day",title:"Perfect Day",description:"Completed all daily activities",icon:"ðŸŒˆ",tier:"gold",category:"special",unlockHint:"Complete all quests, habits, and check-in in one day"},{id:"comeback",achievementType:"comeback",title:"Comeback King",description:"Returned after a break",icon:"ðŸ¦‹",tier:"silver",category:"special",unlockHint:"Return to the app after 7+ days away"},{id:"story_reader",achievementType:"story_chapter",title:"Story Lover",description:"Read a companion story chapter",icon:"ðŸ“–",tier:"bronze",category:"special",unlockHint:"Read a companion story chapter"},{id:"full_storyline",achievementType:"full_storyline",title:"Lore Master",description:"Read all available story chapters",icon:"ðŸ“š",tier:"platinum",category:"special",unlockHint:"Read all companion story chapters"},{id:"attribute_master_mind",achievementType:"attribute_master_mind",title:"Mind Master",description:"Reached 100 Mind attribute",icon:"ðŸ§ ",tier:"gold",category:"special",unlockHint:"Reach 100 Mind attribute"},{id:"attribute_master_body",achievementType:"attribute_master_body",title:"Body Master",description:"Reached 100 Body attribute",icon:"ðŸ’ª",tier:"gold",category:"special",unlockHint:"Reach 100 Body attribute"},{id:"attribute_master_soul",achievementType:"attribute_master_soul",title:"Soul Master",description:"Reached 100 Soul attribute",icon:"âœ¨",tier:"gold",category:"special",unlockHint:"Reach 100 Soul attribute"},{id:"total_attributes",achievementType:"total_attributes_250",title:"Well Rounded",description:"Reached 250 total attributes",icon:"â­",tier:"platinum",category:"special",unlockHint:"Reach 250 combined Mind/Body/Soul"},{id:"pep_talk_listener_10",achievementType:"pep_talk_listener_10",title:"Avid Listener",description:"Listened to 10 pep talks",icon:"ðŸŽµ",tier:"silver",category:"special",unlockHint:"Listen to 10 pep talks"},{id:"pep_talk_listener_50",achievementType:"pep_talk_listener_50",title:"Wisdom Seeker",description:"Listened to 50 pep talks",icon:"ðŸŽ¶",tier:"gold",category:"special",unlockHint:"Listen to 50 pep talks"},{id:"arcade_explorer",achievementType:"arcade_explorer",title:"Arcade Explorer",description:"Discovered the hidden Astral Arcade",icon:"ðŸ•¹ï¸",tier:"silver",category:"special",unlockHint:"???"},{id:"astral_distraction_3",achievementType:"astral_distraction_3",title:"Focus Initiate",description:"Defeated 3 Distraction adversaries",icon:"ðŸŽ¯",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Distraction-themed adversaries"},{id:"astral_distraction_10",achievementType:"astral_distraction_10",title:"Focus Warrior",description:"Defeated 10 Distraction adversaries",icon:"ðŸŽ¯",tier:"silver",category:"astral",unlockHint:"Defeat 10 Distraction-themed adversaries"},{id:"astral_distraction_25",achievementType:"astral_distraction_25",title:"Focus Champion",description:"Defeated 25 Distraction adversaries",icon:"ðŸŽ¯",tier:"gold",category:"astral",unlockHint:"Defeat 25 Distraction-themed adversaries"},{id:"astral_distraction_50",achievementType:"astral_distraction_50",title:"Focus Transcendent",description:"Defeated 50 Distraction adversaries",icon:"ðŸŽ¯",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Distraction-themed adversaries"},{id:"astral_stagnation_3",achievementType:"astral_stagnation_3",title:"Momentum Starter",description:"Defeated 3 Stagnation adversaries",icon:"ðŸŒŠ",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Stagnation-themed adversaries"},{id:"astral_stagnation_10",achievementType:"astral_stagnation_10",title:"Momentum Warrior",description:"Defeated 10 Stagnation adversaries",icon:"ðŸŒŠ",tier:"silver",category:"astral",unlockHint:"Defeat 10 Stagnation-themed adversaries"},{id:"astral_stagnation_25",achievementType:"astral_stagnation_25",title:"Momentum Champion",description:"Defeated 25 Stagnation adversaries",icon:"ðŸŒŠ",tier:"gold",category:"astral",unlockHint:"Defeat 25 Stagnation-themed adversaries"},{id:"astral_stagnation_50",achievementType:"astral_stagnation_50",title:"Momentum Transcendent",description:"Defeated 50 Stagnation adversaries",icon:"ðŸŒŠ",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Stagnation-themed adversaries"},{id:"astral_anxiety_3",achievementType:"astral_anxiety_3",title:"Serenity Seeker",description:"Defeated 3 Anxiety adversaries",icon:"ðŸ§˜",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Anxiety-themed adversaries"},{id:"astral_anxiety_10",achievementType:"astral_anxiety_10",title:"Serenity Warrior",description:"Defeated 10 Anxiety adversaries",icon:"ðŸ§˜",tier:"silver",category:"astral",unlockHint:"Defeat 10 Anxiety-themed adversaries"},{id:"astral_anxiety_25",achievementType:"astral_anxiety_25",title:"Serenity Champion",description:"Defeated 25 Anxiety adversaries",icon:"ðŸ§˜",tier:"gold",category:"astral",unlockHint:"Defeat 25 Anxiety-themed adversaries"},{id:"astral_anxiety_50",achievementType:"astral_anxiety_50",title:"Serenity Transcendent",description:"Defeated 50 Anxiety adversaries",icon:"ðŸ§˜",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Anxiety-themed adversaries"},{id:"astral_doubt_3",achievementType:"astral_doubt_3",title:"Confidence Seeker",description:"Defeated 3 Doubt adversaries",icon:"ðŸ’ª",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Doubt-themed adversaries"},{id:"astral_doubt_10",achievementType:"astral_doubt_10",title:"Confidence Warrior",description:"Defeated 10 Doubt adversaries",icon:"ðŸ’ª",tier:"silver",category:"astral",unlockHint:"Defeat 10 Doubt-themed adversaries"},{id:"astral_doubt_25",achievementType:"astral_doubt_25",title:"Confidence Champion",description:"Defeated 25 Doubt adversaries",icon:"ðŸ’ª",tier:"gold",category:"astral",unlockHint:"Defeat 25 Doubt-themed adversaries"},{id:"astral_doubt_50",achievementType:"astral_doubt_50",title:"Confidence Transcendent",description:"Defeated 50 Doubt adversaries",icon:"ðŸ’ª",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Doubt-themed adversaries"},{id:"astral_chaos_3",achievementType:"astral_chaos_3",title:"Order Initiate",description:"Defeated 3 Chaos adversaries",icon:"âš¡",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Chaos-themed adversaries"},{id:"astral_chaos_10",achievementType:"astral_chaos_10",title:"Order Warrior",description:"Defeated 10 Chaos adversaries",icon:"âš¡",tier:"silver",category:"astral",unlockHint:"Defeat 10 Chaos-themed adversaries"},{id:"astral_chaos_25",achievementType:"astral_chaos_25",title:"Order Champion",description:"Defeated 25 Chaos adversaries",icon:"âš¡",tier:"gold",category:"astral",unlockHint:"Defeat 25 Chaos-themed adversaries"},{id:"astral_chaos_50",achievementType:"astral_chaos_50",title:"Order Transcendent",description:"Defeated 50 Chaos adversaries",icon:"âš¡",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Chaos-themed adversaries"},{id:"astral_laziness_3",achievementType:"astral_laziness_3",title:"Drive Initiate",description:"Defeated 3 Laziness adversaries",icon:"ðŸ”¥",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Laziness-themed adversaries"},{id:"astral_laziness_10",achievementType:"astral_laziness_10",title:"Drive Warrior",description:"Defeated 10 Laziness adversaries",icon:"ðŸ”¥",tier:"silver",category:"astral",unlockHint:"Defeat 10 Laziness-themed adversaries"},{id:"astral_laziness_25",achievementType:"astral_laziness_25",title:"Drive Champion",description:"Defeated 25 Laziness adversaries",icon:"ðŸ”¥",tier:"gold",category:"astral",unlockHint:"Defeat 25 Laziness-themed adversaries"},{id:"astral_laziness_50",achievementType:"astral_laziness_50",title:"Drive Transcendent",description:"Defeated 50 Laziness adversaries",icon:"ðŸ”¥",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Laziness-themed adversaries"},{id:"astral_overthinking_3",achievementType:"astral_overthinking_3",title:"Clarity Seeker",description:"Defeated 3 Overthinking adversaries",icon:"ðŸ§ ",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Overthinking-themed adversaries"},{id:"astral_overthinking_10",achievementType:"astral_overthinking_10",title:"Clarity Warrior",description:"Defeated 10 Overthinking adversaries",icon:"ðŸ§ ",tier:"silver",category:"astral",unlockHint:"Defeat 10 Overthinking-themed adversaries"},{id:"astral_overthinking_25",achievementType:"astral_overthinking_25",title:"Clarity Champion",description:"Defeated 25 Overthinking adversaries",icon:"ðŸ§ ",tier:"gold",category:"astral",unlockHint:"Defeat 25 Overthinking-themed adversaries"},{id:"astral_overthinking_50",achievementType:"astral_overthinking_50",title:"Clarity Transcendent",description:"Defeated 50 Overthinking adversaries",icon:"ðŸ§ ",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Overthinking-themed adversaries"},{id:"astral_fear_3",achievementType:"astral_fear_3",title:"Courage Initiate",description:"Defeated 3 Fear adversaries",icon:"ðŸ›¡ï¸",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Fear-themed adversaries"},{id:"astral_fear_10",achievementType:"astral_fear_10",title:"Courage Warrior",description:"Defeated 10 Fear adversaries",icon:"ðŸ›¡ï¸",tier:"silver",category:"astral",unlockHint:"Defeat 10 Fear-themed adversaries"},{id:"astral_fear_25",achievementType:"astral_fear_25",title:"Courage Champion",description:"Defeated 25 Fear adversaries",icon:"ðŸ›¡ï¸",tier:"gold",category:"astral",unlockHint:"Defeat 25 Fear-themed adversaries"},{id:"astral_fear_50",achievementType:"astral_fear_50",title:"Courage Transcendent",description:"Defeated 50 Fear adversaries",icon:"ðŸ›¡ï¸",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Fear-themed adversaries"},{id:"astral_confusion_3",achievementType:"astral_confusion_3",title:"Wisdom Initiate",description:"Defeated 3 Confusion adversaries",icon:"âœ¨",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Confusion-themed adversaries"},{id:"astral_confusion_10",achievementType:"astral_confusion_10",title:"Wisdom Warrior",description:"Defeated 10 Confusion adversaries",icon:"âœ¨",tier:"silver",category:"astral",unlockHint:"Defeat 10 Confusion-themed adversaries"},{id:"astral_confusion_25",achievementType:"astral_confusion_25",title:"Wisdom Champion",description:"Defeated 25 Confusion adversaries",icon:"âœ¨",tier:"gold",category:"astral",unlockHint:"Defeat 25 Confusion-themed adversaries"},{id:"astral_confusion_50",achievementType:"astral_confusion_50",title:"Wisdom Transcendent",description:"Defeated 50 Confusion adversaries",icon:"âœ¨",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Confusion-themed adversaries"},{id:"astral_vulnerability_3",achievementType:"astral_vulnerability_3",title:"Resilience Initiate",description:"Defeated 3 Vulnerability adversaries",icon:"ðŸ’Ž",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Vulnerability-themed adversaries"},{id:"astral_vulnerability_10",achievementType:"astral_vulnerability_10",title:"Resilience Warrior",description:"Defeated 10 Vulnerability adversaries",icon:"ðŸ’Ž",tier:"silver",category:"astral",unlockHint:"Defeat 10 Vulnerability-themed adversaries"},{id:"astral_vulnerability_25",achievementType:"astral_vulnerability_25",title:"Resilience Champion",description:"Defeated 25 Vulnerability adversaries",icon:"ðŸ’Ž",tier:"gold",category:"astral",unlockHint:"Defeat 25 Vulnerability-themed adversaries"},{id:"astral_vulnerability_50",achievementType:"astral_vulnerability_50",title:"Resilience Transcendent",description:"Defeated 50 Vulnerability adversaries",icon:"ðŸ’Ž",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Vulnerability-themed adversaries"},{id:"astral_imbalance_3",achievementType:"astral_imbalance_3",title:"Harmony Initiate",description:"Defeated 3 Imbalance adversaries",icon:"â˜¯ï¸",tier:"bronze",category:"astral",unlockHint:"Defeat 3 Imbalance-themed adversaries"},{id:"astral_imbalance_10",achievementType:"astral_imbalance_10",title:"Harmony Warrior",description:"Defeated 10 Imbalance adversaries",icon:"â˜¯ï¸",tier:"silver",category:"astral",unlockHint:"Defeat 10 Imbalance-themed adversaries"},{id:"astral_imbalance_25",achievementType:"astral_imbalance_25",title:"Harmony Champion",description:"Defeated 25 Imbalance adversaries",icon:"â˜¯ï¸",tier:"gold",category:"astral",unlockHint:"Defeat 25 Imbalance-themed adversaries"},{id:"astral_imbalance_50",achievementType:"astral_imbalance_50",title:"Harmony Transcendent",description:"Defeated 50 Imbalance adversaries",icon:"â˜¯ï¸",tier:"platinum",category:"astral",unlockHint:"Defeat 50 Imbalance-themed adversaries"}],Ox={streaks:"Streaks",companion:"Companion",starpaths:"Star Paths",challenges:"Challenges",firsts:"First Steps",special:"Special",astral:"Astral Hunters"},$c={bronze:"from-orange-500 to-orange-700",silver:"from-gray-300 to-gray-500",gold:"from-yellow-400 to-yellow-600",platinum:"from-purple-400 to-purple-600"},$x=()=>{const{user:t}=ce(),[s,a]=n.useState("all"),[r,i]=n.useState(null),{data:o,isLoading:c}=ye({queryKey:["achievements",t?.id],enabled:!!t,queryFn:async()=>{if(!t?.id)return[];const{data:g,error:y}=await N.from("achievements").select("achievement_type, earned_at").eq("user_id",t.id);if(y)throw y;return g||[]}}),l=n.useMemo(()=>new Set(o?.map(g=>g.achievement_type)||[]),[o]),u=n.useMemo(()=>s==="all"?Fa:Fa.filter(g=>g.category===s),[s]),m=n.useMemo(()=>u.filter(g=>l.has(g.achievementType)),[u,l]),p=n.useMemo(()=>u.filter(g=>!l.has(g.achievementType)),[u,l]),h=Fa.filter(g=>l.has(g.achievementType)).length,f=Fa.length,d=["all","streaks","companion","starpaths","firsts","special"];return c?e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsx(ue,{className:"h-24 w-full"}),e.jsx(ue,{className:"h-12 w-full"}),e.jsx(ue,{className:"h-48 w-full"})]}):e.jsxs("div",{className:"space-y-6 mt-6",children:[e.jsxs(Me,{className:"p-6 bg-gradient-to-br from-primary/10 to-accent/10 border-primary/20",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx(Vr,{className:"h-6 w-6 text-primary"}),e.jsx("h3",{className:"text-lg font-semibold",children:"Your Badges"})]}),e.jsxs("p",{className:"text-2xl font-bold",children:[e.jsx("span",{className:"text-primary",children:h}),e.jsxs("span",{className:"text-muted-foreground text-lg font-normal",children:[" / ",f," collected"]})]})]}),e.jsx("div",{className:"flex gap-2 overflow-x-auto pb-2 scrollbar-hide",children:d.map(g=>e.jsx("button",{onClick:()=>a(g),className:`px-3 py-1.5 rounded-full text-sm font-medium whitespace-nowrap transition-colors ${s===g?"bg-primary text-primary-foreground":"bg-secondary/50 text-muted-foreground hover:bg-secondary"}`,children:g==="all"?"All":Ox[g]},g))}),m.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"text-sm font-semibold text-muted-foreground flex items-center gap-2",children:[e.jsx("span",{className:"text-primary",children:"âœ¨"})," EARNED (",m.length,")"]}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 gap-3",children:m.map(g=>e.jsx(Li,{badge:g,earned:!0,onSelect:y=>i({badge:y,earned:!0})},g.id))})]}),p.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("h4",{className:"text-sm font-semibold text-muted-foreground flex items-center gap-2",children:[e.jsx(er,{className:"h-4 w-4"})," LOCKED (",p.length,")"]}),e.jsx("div",{className:"grid grid-cols-3 sm:grid-cols-4 gap-3",children:p.map(g=>e.jsx(Li,{badge:g,earned:!1,onSelect:y=>i({badge:y,earned:!1})},g.id))})]}),u.length===0&&e.jsxs(Me,{className:"p-8 text-center",children:[e.jsx(Vr,{className:"h-12 w-12 mx-auto mb-3 text-muted-foreground/50"}),e.jsx("p",{className:"text-muted-foreground",children:"No badges in this category yet"})]}),e.jsx(ct,{open:!!r,onOpenChange:()=>i(null),children:e.jsxs(ot,{className:"max-w-[300px] rounded-xl",children:[e.jsx(as,{children:e.jsx(St,{className:"text-center",children:r?.earned?r.badge.title:"Locked Badge"})}),r&&e.jsxs("div",{className:"text-center space-y-4 py-2",children:[e.jsx("div",{className:`text-6xl ${r.earned?"":"grayscale"}`,children:r.earned?r.badge.icon:"ðŸ”’"}),r.earned?e.jsxs(e.Fragment,{children:[e.jsx("p",{className:"text-muted-foreground",children:r.badge.description}),e.jsx(Ne,{className:`capitalize bg-gradient-to-br ${$c[r.badge.tier]} text-white border-0`,children:r.badge.tier})]}):e.jsxs("div",{className:"space-y-2",children:[e.jsx("p",{className:"text-sm font-medium",children:"How to unlock:"}),e.jsx("p",{className:"text-muted-foreground",children:r.badge.unlockHint})]})]})]})})]})},Li=({badge:t,earned:s,onSelect:a})=>{const r=$c[t.tier];return e.jsxs(Me,{onClick:()=>a(t),className:`relative p-3 text-center transition-all cursor-pointer active:scale-95 ${s?"bg-gradient-to-br from-primary/10 to-accent/10 border-primary/30 hover:border-primary/50":"bg-secondary/30 border-border/50 opacity-60 hover:opacity-80"}`,children:[e.jsx("div",{className:`text-3xl mb-2 ${s?"":"grayscale"}`,children:s?t.icon:"ðŸ”’"}),e.jsx("p",{className:`text-xs font-medium line-clamp-2 ${s?"text-foreground":"text-muted-foreground"}`,children:s?t.title:"???"}),s&&e.jsx("div",{className:`absolute top-1 right-1 w-2 h-2 rounded-full bg-gradient-to-br ${r}`})]})},Tn=()=>{const t=n.useCallback(()=>{$e.light()},[]),s=n.useCallback(()=>{$e.medium()},[]),a=n.useCallback(()=>{$e.heavy()},[]),r=n.useCallback(()=>{$e.success()},[]),i=n.useCallback(()=>{$e.error()},[]),o=n.useCallback(()=>{$e.light()},[]),c=n.useCallback(()=>{$e.medium()},[]),l=n.useCallback(()=>{$e.success()},[]),u=n.useCallback(()=>{$e.error()},[]),m=n.useCallback(p=>{p?$e.light():$e.medium()},[]);return{light:t,medium:s,heavy:a,success:r,error:i,tap:o,press:c,complete:l,fail:u,toggle:m}},Bx=({cssEffect:t,className:s})=>{const{cornerStyle:a,glowColor:r,glowAnimation:i}=t;if(!a)return null;const o=i==="pulse"?"animate-frame-pulse":i==="breathe"?"animate-frame-breathe":i==="flicker"?"animate-frame-flicker":"";return e.jsxs("div",{className:E("absolute inset-0 pointer-events-none z-30",s),children:[e.jsx(Oa,{position:"top-left",cornerStyle:a,glowColor:r,glowClass:o}),e.jsx(Oa,{position:"top-right",cornerStyle:a,glowColor:r,glowClass:o}),e.jsx(Oa,{position:"bottom-left",cornerStyle:a,glowColor:r,glowClass:o}),e.jsx(Oa,{position:"bottom-right",cornerStyle:a,glowColor:r,glowClass:o})]})},Oa=({position:t,cornerStyle:s,glowColor:a,glowClass:r})=>{const i={"top-left":"top-0 left-0","top-right":"top-0 right-0","bottom-left":"bottom-0 left-0","bottom-right":"bottom-0 right-0"},o={"top-left":"rotate-0","top-right":"rotate-90","bottom-left":"-rotate-90","bottom-right":"rotate-180"},c=Hx(s,a);return e.jsx("div",{className:E("absolute w-14 h-14",i[t],o[t],r),style:{filter:a?`drop-shadow(0 0 6px ${a})`:void 0},children:c})},Hx=(t,s)=>{const a=s||"hsl(var(--primary))";switch(t){case"ornate":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 4 L20 4 Q28 4 28 12 L28 20 Q28 28 20 28 L12 28 Q4 28 4 20 Z",fill:"none",stroke:a,strokeWidth:"2",className:"animate-frame-shimmer"}),e.jsx("circle",{cx:"8",cy:"8",r:"3",fill:a}),e.jsx("path",{d:"M12 4 Q16 8 12 12 Q8 8 12 4",fill:a,opacity:"0.6"})]});case"crystal":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("polygon",{points:"4,4 20,4 4,20",fill:a,opacity:"0.3"}),e.jsx("polygon",{points:"4,4 16,4 4,16",fill:a,opacity:"0.5"}),e.jsx("polygon",{points:"4,4 12,4 4,12",fill:a,opacity:"0.7"}),e.jsx("line",{x1:"4",y1:"4",x2:"24",y2:"24",stroke:a,strokeWidth:"1",opacity:"0.4"})]});case"flame":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M8 28 Q8 16 16 8 Q12 16 16 20 Q16 12 24 8 Q20 16 20 24 Q28 16 28 8",fill:"none",stroke:a,strokeWidth:"2",className:"animate-frame-flicker"}),e.jsx("circle",{cx:"12",cy:"20",r:"2",fill:a,opacity:"0.8"}),e.jsx("circle",{cx:"20",cy:"12",r:"1.5",fill:a,opacity:"0.6"})]});case"circuit":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 24 L4 8 L8 4 L24 4",fill:"none",stroke:a,strokeWidth:"2"}),e.jsx("circle",{cx:"8",cy:"8",r:"3",fill:a}),e.jsx("path",{d:"M8 16 L16 16 L16 8",fill:"none",stroke:a,strokeWidth:"1.5",opacity:"0.6"}),e.jsx("circle",{cx:"16",cy:"16",r:"2",fill:a,opacity:"0.6"})]});case"scale":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("ellipse",{cx:"8",cy:"8",rx:"6",ry:"4",fill:a,opacity:"0.3",transform:"rotate(-45 8 8)"}),e.jsx("ellipse",{cx:"16",cy:"8",rx:"6",ry:"4",fill:a,opacity:"0.4",transform:"rotate(-45 16 8)"}),e.jsx("ellipse",{cx:"8",cy:"16",rx:"6",ry:"4",fill:a,opacity:"0.4",transform:"rotate(-45 8 16)"}),e.jsx("ellipse",{cx:"16",cy:"16",rx:"6",ry:"4",fill:a,opacity:"0.5",transform:"rotate(-45 16 16)"})]});case"deity":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 4 C12 4 16 8 20 4 C16 12 20 16 16 24 L8 28 L4 20 Z",fill:a,opacity:"0.4"}),e.jsx("circle",{cx:"12",cy:"12",r:"4",fill:a,opacity:"0.7"}),e.jsx("path",{d:"M4 8 L8 4 M8 8 L12 4 M12 8 L16 4",stroke:a,strokeWidth:"1",opacity:"0.5"})]});case"dimensional":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("defs",{children:e.jsxs("linearGradient",{id:"dimGrad",x1:"0%",y1:"0%",x2:"100%",y2:"100%",children:[e.jsx("stop",{offset:"0%",stopColor:"hsl(300, 80%, 55%)"}),e.jsx("stop",{offset:"50%",stopColor:"hsl(180, 80%, 55%)"}),e.jsx("stop",{offset:"100%",stopColor:"hsl(60, 80%, 55%)"})]})}),e.jsx("path",{d:"M4 4 L24 4 M4 4 L4 24",stroke:"url(#dimGrad)",strokeWidth:"3",className:"animate-frame-shift"}),e.jsx("polygon",{points:"4,4 12,8 8,12",fill:"url(#dimGrad)",opacity:"0.6"}),e.jsx("circle",{cx:"16",cy:"16",r:"3",fill:"url(#dimGrad)",opacity:"0.4"})]});case"treasure":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 16 L4 4 L16 4",fill:"none",stroke:a,strokeWidth:"3"}),e.jsx("polygon",{points:"8,8 12,4 16,8 12,12",fill:a}),e.jsx("circle",{cx:"12",cy:"8",r:"2",fill:"hsl(45, 100%, 80%)"})]});case"mystery":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("circle",{cx:"16",cy:"16",r:"10",fill:"none",stroke:a,strokeWidth:"2",opacity:"0.4"}),e.jsx("circle",{cx:"16",cy:"16",r:"6",fill:"none",stroke:a,strokeWidth:"2",opacity:"0.6"}),e.jsx("line",{x1:"4",y1:"4",x2:"10",y2:"10",stroke:a,strokeWidth:"3"}),e.jsx("circle",{cx:"6",cy:"6",r:"3",fill:a})]});case"lotus":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("ellipse",{cx:"12",cy:"16",rx:"6",ry:"10",fill:a,opacity:"0.3",transform:"rotate(-30 12 16)"}),e.jsx("ellipse",{cx:"16",cy:"12",rx:"6",ry:"10",fill:a,opacity:"0.4",transform:"rotate(-60 16 12)"}),e.jsx("circle",{cx:"10",cy:"10",r:"4",fill:a,opacity:"0.6"})]});case"heroic":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M4 4 L4 20 L8 24 L12 20 L12 8 L20 4 L4 4",fill:a,opacity:"0.4"}),e.jsx("path",{d:"M8 8 L8 16 L12 12 L12 8 Z",fill:a,opacity:"0.6"}),e.jsx("line",{x1:"8",y1:"4",x2:"8",y2:"12",stroke:a,strokeWidth:"2"})]});case"shield":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("path",{d:"M12 4 L4 8 L4 20 L12 28 L20 20 L20 8 L12 4",fill:a,opacity:"0.3"}),e.jsx("path",{d:"M12 8 L8 10 L8 18 L12 22 L16 18 L16 10 Z",fill:a,opacity:"0.5"})]});case"compass":return e.jsxs("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:[e.jsx("circle",{cx:"16",cy:"16",r:"12",fill:"none",stroke:a,strokeWidth:"1",opacity:"0.3"}),e.jsx("line",{x1:"16",y1:"4",x2:"16",y2:"28",stroke:a,strokeWidth:"1",opacity:"0.4"}),e.jsx("line",{x1:"4",y1:"16",x2:"28",y2:"16",stroke:a,strokeWidth:"1",opacity:"0.4"}),e.jsx("polygon",{points:"16,8 14,16 16,14 18,16",fill:a}),e.jsx("circle",{cx:"16",cy:"16",r:"2",fill:a})]});default:return e.jsx("svg",{viewBox:"0 0 56 56",className:"w-full h-full",children:e.jsx("path",{d:"M4 20 L4 4 L20 4",fill:"none",stroke:a,strokeWidth:"2"})})}},Ur={Common:"from-gray-400 to-gray-600",Rare:"from-blue-400 to-blue-600",Epic:"from-purple-400 to-purple-600",Legendary:"from-amber-400 to-amber-600",Mythic:"from-pink-500 to-rose-600",Celestial:"from-cyan-400 to-blue-500",Primal:"from-emerald-400 to-teal-600",Origin:"from-violet-500 to-fuchsia-600"},Fi={fire:"ðŸ”¥",water:"ðŸ’§",earth:"ðŸª¨",air:"ðŸ’¨",lightning:"âš¡",ice:"â„ï¸",nature:"ðŸŒ¿",shadow:"ðŸŒ‘",light:"âœ¨"},zx=t=>t<=9?1:t<=14?2:3;function Ux({card:t,equippedFrame:s}){const[a,r]=n.useState(!1),[i,o]=n.useState(!1),{tap:c}=Tn(),l=n.useRef(null),u=t.stats,m=t.energy_cost??zx(t.evolution_stage),p=t.bond_level??null,h=()=>{c(),r(!0),o(!1)},f=b=>{b.stopPropagation(),c(),o(!i)},d=async b=>{b.stopPropagation(),l.current&&await hg(l.current,`cosmiq-${t.creature_name.toLowerCase().replace(/\s+/g,"-")}-stage-${t.evolution_stage}.png`,{title:`${t.creature_name} - Cosmiq`,text:`Check out my ${t.creature_name}! âœ¨ #Cosmiq`,dialogTitle:"Share Companion Card"})},g=s&&s.cornerStyle,y=s?.glowAnimation==="pulse"?"animate-frame-pulse":s?.glowAnimation==="breathe"?"animate-frame-breathe":s?.glowAnimation==="flicker"?"animate-frame-flicker":s?.glowAnimation==="shift"?"animate-frame-shift":"",v=s?{borderColor:s.gradientBorder?"transparent":s.borderColor,borderWidth:s.borderWidth||"8px",borderStyle:s.borderStyle||"solid",boxShadow:s.glowColor?`0 0 20px ${s.glowColor}, 0 0 40px ${s.glowColor}40`:void 0}:{};return e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"relative h-[280px] cursor-pointer rounded-xl overflow-hidden",onClick:h,children:e.jsx("div",{className:`h-full rounded-xl border-2 bg-gradient-to-br ${Ur[t.rarity]} p-[2px] shadow-lg`,children:e.jsxs("div",{className:"h-full rounded-lg bg-card relative overflow-hidden",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.creature_name,className:"absolute inset-0 w-full h-full object-cover",loading:"lazy",decoding:"async"}):e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-muted/50 to-muted flex items-center justify-center text-muted-foreground text-xs",children:"No Image"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/80 via-black/20 to-transparent"}),e.jsx(Ne,{className:"absolute top-2 left-2 bg-background/90 backdrop-blur-sm text-xs",children:Fi[t.element.toLowerCase()]||"âœ¨"}),e.jsxs(Ne,{className:"absolute top-2 right-2 bg-background/90 backdrop-blur-sm text-xs",children:["Stage ",t.evolution_stage]}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 p-3 space-y-2",children:[e.jsx("h3",{className:"font-bold text-sm text-white drop-shadow-lg",children:t.creature_name}),e.jsxs("div",{className:"flex items-center justify-between text-[10px] text-white/80 bg-black/30 rounded-md px-2 py-1",children:[e.jsxs("span",{className:"flex items-center gap-1",children:["âš¡",e.jsx("span",{className:"font-semibold",children:m})]}),p!==null&&e.jsxs("span",{className:"flex items-center gap-1",children:["ðŸ¤ ",e.jsx("span",{className:"font-semibold",children:p})]})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-1 text-xs bg-black/40 backdrop-blur-sm rounded-lg p-2",children:[e.jsxs("div",{className:"flex flex-col items-center text-white/90",children:[e.jsx("span",{children:"ðŸ§ "}),e.jsx("span",{className:"font-semibold",children:u.mind||0})]}),e.jsxs("div",{className:"flex flex-col items-center text-white/90",children:[e.jsx("span",{children:"ðŸ’ª"}),e.jsx("span",{className:"font-semibold",children:u.body||0})]}),e.jsxs("div",{className:"flex flex-col items-center text-white/90",children:[e.jsx("span",{children:"ðŸ”¥"}),e.jsx("span",{className:"font-semibold",children:u.soul||0})]})]})]})]})})}),e.jsx(ct,{open:a,onOpenChange:b=>{r(b),b||o(!1)},children:e.jsxs(ot,{className:"max-w-[95vw] max-h-[95vh] p-0 bg-transparent border-0 overflow-hidden","aria-describedby":"evolution-card-description",children:[e.jsxs(St,{className:"sr-only",children:[t.creature_name," - Evolution Card"]}),e.jsxs("span",{id:"evolution-card-description",className:"sr-only",children:["Detailed view of ",t.creature_name,", a ",t.rarity," ",t.element," ",t.species," at evolution stage ",t.evolution_stage]}),e.jsx("div",{className:"absolute inset-0 z-40",onClick:()=>r(!1)}),e.jsxs("div",{className:"relative w-full h-[80vh] flex items-center justify-center",children:[e.jsx("button",{onClick:d,className:"absolute top-4 right-20 z-50 p-3 rounded-full bg-black/70 backdrop-blur-sm text-white hover:bg-black/90 active:bg-black transition-colors touch-manipulation",children:e.jsx(Ao,{className:"w-6 h-6"})}),e.jsx("button",{onClick:b=>{b.stopPropagation(),r(!1)},className:"absolute top-4 right-4 z-50 p-3 rounded-full bg-black/70 backdrop-blur-sm text-white hover:bg-black/90 active:bg-black transition-colors touch-manipulation",children:e.jsx(Qe,{className:"w-6 h-6"})}),e.jsx("div",{className:"relative w-full max-w-[320px] aspect-[2.5/3.5] cursor-pointer perspective-1000",onClick:f,children:e.jsxs(_.div,{className:"relative w-full h-full preserve-3d",animate:{rotateY:i?180:0},transition:{duration:.6,type:"spring"},children:[e.jsx("div",{className:"absolute w-full h-full backface-hidden",style:{transform:"rotateY(0deg)"},children:e.jsxs("div",{ref:l,className:E("h-full rounded-2xl p-0 shadow-2xl overflow-hidden relative",g?y:`border-[8px] bg-gradient-to-br ${Ur[t.rarity]}`,s?.shimmer&&"animate-frame-shimmer",s?.animatedGradient&&"animate-gradient-border"),style:g?v:{},children:[s?.gradientBorder&&e.jsx("div",{className:E("absolute inset-0 rounded-2xl -z-10",s.animatedGradient&&"animate-gradient-border"),style:{background:s.gradientBorder,backgroundSize:"200% 200%"}}),g&&s?e.jsx(Bx,{cssEffect:s}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"absolute top-0 left-0 w-12 h-12 z-30 pointer-events-none backface-hidden",children:[e.jsx("div",{className:"absolute inset-0 border-t-2 border-l-2 border-white/40 rounded-tl-xl"}),e.jsx("div",{className:"absolute top-1 left-1 w-8 h-8 border-t border-l border-white/20 rounded-tl-lg"})]}),e.jsxs("div",{className:"absolute top-0 right-0 w-12 h-12 z-30 pointer-events-none backface-hidden",children:[e.jsx("div",{className:"absolute inset-0 border-t-2 border-r-2 border-white/40 rounded-tr-xl"}),e.jsx("div",{className:"absolute top-1 right-1 w-8 h-8 border-t border-r border-white/20 rounded-tr-lg"})]}),e.jsxs("div",{className:"absolute bottom-0 left-0 w-12 h-12 z-30 pointer-events-none backface-hidden",children:[e.jsx("div",{className:"absolute inset-0 border-b-2 border-l-2 border-white/40 rounded-bl-xl"}),e.jsx("div",{className:"absolute bottom-1 left-1 w-8 h-8 border-b border-l border-white/20 rounded-bl-lg"})]}),e.jsxs("div",{className:"absolute bottom-0 right-0 w-12 h-12 z-30 pointer-events-none backface-hidden",children:[e.jsx("div",{className:"absolute inset-0 border-b-2 border-r-2 border-white/40 rounded-br-xl"}),e.jsx("div",{className:"absolute bottom-1 right-1 w-8 h-8 border-b border-r border-white/20 rounded-br-lg"})]})]}),s?.shimmer&&e.jsx("div",{className:"absolute inset-0 pointer-events-none z-20 overflow-hidden rounded-2xl",children:e.jsx("div",{className:"absolute inset-0 animate-frame-shimmer bg-gradient-to-r from-transparent via-white/20 to-transparent",style:{transform:"skewX(-20deg)",width:"200%",marginLeft:"-50%"}})}),e.jsx("div",{className:"absolute inset-2 border border-white/20 rounded-lg z-20 pointer-events-none backface-hidden"}),e.jsxs("div",{className:"h-full rounded-xl relative overflow-hidden",children:[t.image_url?e.jsx("img",{src:t.image_url,alt:t.creature_name,className:"absolute inset-0 w-full h-full object-cover",loading:"lazy",decoding:"async"}):e.jsx("div",{className:"absolute inset-0 bg-gradient-to-br from-muted/50 to-muted flex items-center justify-center",children:"No Image"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-black/90 via-transparent to-black/60"}),e.jsxs("div",{className:"absolute top-0 left-0 right-0 z-10 flex items-center justify-between p-3",children:[e.jsxs(Ne,{className:"bg-black/70 backdrop-blur-sm text-white text-sm px-3 py-1 border border-white/20",children:[Fi[t.element.toLowerCase()]||"âœ¨"," ",t.element]}),e.jsxs(Ne,{className:"bg-black/70 backdrop-blur-sm text-white text-sm px-3 py-1 border border-white/20",children:["Stage ",t.evolution_stage]})]}),e.jsxs("div",{className:"absolute top-14 left-2 z-10 flex gap-1.5",children:[e.jsxs("div",{className:"bg-black/40 backdrop-blur-sm rounded-full px-1.5 py-0.5 flex items-center gap-0.5 text-white/80 text-[10px] border border-white/10",children:[e.jsx("span",{className:"text-[10px]",children:"ðŸ§ "}),e.jsx("span",{className:"font-medium",children:u.mind||0})]}),e.jsxs("div",{className:"bg-black/40 backdrop-blur-sm rounded-full px-1.5 py-0.5 flex items-center gap-0.5 text-white/80 text-[10px] border border-white/10",children:[e.jsx("span",{className:"text-[10px]",children:"ðŸ’ª"}),e.jsx("span",{className:"font-medium",children:u.body||0})]}),e.jsxs("div",{className:"bg-black/40 backdrop-blur-sm rounded-full px-1.5 py-0.5 flex items-center gap-0.5 text-white/80 text-[10px] border border-white/10",children:[e.jsx("span",{className:"text-[10px]",children:"ðŸ”¥"}),e.jsx("span",{className:"font-medium",children:u.soul||0})]})]}),e.jsxs("div",{className:"absolute bottom-0 left-0 right-0 z-10 p-4 space-y-2 pb-12 backface-hidden",children:[e.jsxs("h3",{className:"font-bold text-2xl text-center text-white drop-shadow-[0_2px_8px_rgba(0,0,0,0.8)] tracking-wide",children:["â˜… ",t.creature_name.toUpperCase()," â˜…"]}),e.jsxs("div",{className:"text-sm text-center text-white/90 drop-shadow-lg",children:["Stage ",t.evolution_stage," â€¢ ",t.rarity]})]})]}),e.jsx("div",{className:"absolute bottom-0 left-1/2 -translate-x-1/2 z-30 flex items-center justify-center backface-hidden",children:e.jsxs("div",{className:"relative px-6 py-2",children:[e.jsx("div",{className:"absolute left-0 top-1/2 -translate-y-1/2 w-4 h-[2px] bg-gradient-to-r from-transparent to-white/60"}),e.jsx("div",{className:"absolute right-0 top-1/2 -translate-y-1/2 w-4 h-[2px] bg-gradient-to-l from-transparent to-white/60"}),e.jsx("span",{className:"text-[11px] font-bold tracking-[0.3em] text-white drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] relative z-10",children:"âœ¦ COSMIQ âœ¦"})]})})]})}),e.jsx("div",{className:"absolute w-full h-full backface-hidden rotate-y-180",children:e.jsx("div",{className:`h-full rounded-2xl border-4 bg-gradient-to-br ${Ur[t.rarity]} p-1 shadow-2xl`,children:e.jsx("div",{className:"h-full rounded-xl bg-card p-6 flex flex-col overflow-hidden",children:e.jsxs("div",{className:"space-y-4 flex-1 overflow-y-auto",children:[e.jsxs("div",{className:"text-center pb-4 border-b border-border",children:[e.jsx("h3",{className:"font-bold text-xl",children:t.creature_name}),e.jsxs("p",{className:"text-sm text-muted-foreground capitalize mt-1",children:[t.species," of ",t.element]})]}),t.traits&&t.traits.length>0&&e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold mb-2 text-primary",children:"Traits"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:t.traits.map((b,x)=>e.jsx(Ne,{variant:"secondary",className:"text-xs",children:b},x))})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-semibold mb-2 text-primary",children:"Lore"}),e.jsx("p",{className:"text-sm text-muted-foreground leading-relaxed",children:t.story_text})]})]})})})})]})})]})]})})]})}const Bc=n.memo(()=>{const{user:t}=ce(),{data:s,isLoading:a}=ye({queryKey:["evolution-cards",t?.id],queryFn:async()=>{if(!t)return[];const{data:r,error:i}=await N.from("companion_evolution_cards").select("*").eq("user_id",t.id).order("evolution_stage",{ascending:!0});if(i)throw i;const o=(r||[]).map(p=>p.evolution_id).filter(p=>!!p);let c={};if(o.length>0){const{data:p,error:h}=await N.from("companion_evolutions").select("id, image_url").in("id",o);if(h)throw h;c=(p||[]).reduce((f,d)=>(f[d.id]=d.image_url??null,f),{})}const l=(r||[]).map(p=>{const h=p.image_url,f=p.evolution_id?c[p.evolution_id]:null;return{...p,image_url:h||f}}),u=new Map;return l.forEach(p=>{u.has(p.card_id)||u.set(p.card_id,p)}),Array.from(u.values())},enabled:!!t,staleTime:300*1e3});return a?e.jsx("div",{className:"grid grid-cols-3 gap-3",children:[1,2,3].map(r=>e.jsx(ue,{className:"h-[280px] rounded-xl"},r))}):!s||s.length===0?e.jsxs(Me,{className:"p-8 text-center",children:[e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx(se,{className:"h-12 w-12 text-muted-foreground"})}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Evolution Cards Yet"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Cards are created when your companion evolves. Keep growing to unlock your first card!"})]}):e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"font-semibold text-foreground",children:"Your Collection"}),e.jsx("div",{className:"grid grid-cols-3 gap-3",children:s.map(r=>e.jsx(Ux,{card:r},r.id))})]})});Bc.displayName="EvolutionCardGallery";const Wx={background:Ju,frame:Xu,effect:us,artifact:Vu},$a={background:"Backgrounds",frame:"Frames",effect:"Effects",artifact:"Artifacts"},Hc=n.memo(({className:t})=>{const{allRewards:s,userRewards:a,equipReward:r,isEquipping:i,isLoading:o}=Ec(),[c,l]=n.useState("background"),u=a.reduce((h,f)=>{const d=f.epic_rewards?.reward_type;return d&&(h[d]||(h[d]=[]),h[d].push(f)),h},{}),m=s.reduce((h,f)=>(h[f.reward_type]||(h[f.reward_type]=[]),h[f.reward_type].push(f),h),{}),p=h=>{r({rewardId:h.reward_id,equip:!h.is_equipped})};return o?e.jsx(Me,{className:E("p-6 cosmiq-glass",t),children:e.jsx("div",{className:"flex items-center justify-center h-40",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})})}):e.jsxs(Me,{className:E("cosmiq-glass overflow-hidden",t),children:[e.jsxs("div",{className:"p-4 border-b border-border/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-5 h-5 text-primary"}),e.jsx("h3",{className:"font-bold text-lg",children:"Reward Collection"})]}),e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:[a.length," / ",s.length," rewards collected"]})]}),e.jsxs(Sn,{value:c,onValueChange:h=>l(h),children:[e.jsx(gr,{className:"w-full justify-start rounded-none border-b border-border/50 bg-transparent p-0",children:Object.keys($a).map(h=>{const f=Wx[h],d=u[h]?.length||0;return e.jsxs(Ot,{value:h,className:"flex-1 rounded-none border-b-2 border-transparent data-[state=active]:border-primary data-[state=active]:bg-transparent py-3",children:[e.jsx(f,{className:"w-4 h-4 mr-1.5"}),e.jsx("span",{className:"hidden sm:inline",children:$a[h]}),d>0&&e.jsx(Ne,{variant:"secondary",className:"ml-1.5 h-5 px-1.5 text-xs",children:d})]},h)})}),Object.keys($a).map(h=>e.jsxs($t,{value:h,className:"p-4 mt-0",children:[e.jsx("div",{className:"grid grid-cols-2 sm:grid-cols-3 gap-3",children:e.jsxs(be,{mode:"popLayout",children:[u[h]?.map(f=>e.jsx(Qx,{userReward:f,isEquipped:f.is_equipped,onToggleEquip:()=>p(f),isEquipping:i},f.id)),m[h]?.filter(f=>!a.some(d=>d.reward_id===f.id)).map(f=>e.jsx(Kx,{reward:f},f.id))]})}),!u[h]?.length&&!m[h]?.length&&e.jsx("div",{className:"text-center py-8 text-muted-foreground",children:e.jsxs("p",{children:["No ",$a[h].toLowerCase()," available yet"]})})]},h))]})]})});Hc.displayName="RewardInventory";const Qx=({userReward:t,isEquipped:s,onToggleEquip:a,isEquipping:r})=>{const i=t.epic_rewards;if(!i)return null;const o=cx[i.rarity];return e.jsx(_.div,{layout:!0,initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.9},children:e.jsxs(Me,{className:E("relative p-3 cursor-pointer transition-all hover:scale-105","border-2",s?"border-primary bg-primary/10":"border-border/50 hover:border-primary/50"),onClick:a,children:[s&&e.jsx("div",{className:"absolute -top-2 -right-2 w-6 h-6 rounded-full bg-primary flex items-center justify-center",children:e.jsx(Xe,{className:"w-4 h-4 text-primary-foreground"})}),e.jsx("div",{className:E("aspect-square rounded-lg mb-2 flex items-center justify-center","bg-gradient-to-br",o.bgClass),style:{boxShadow:s?`0 0 20px ${o.color}40`:void 0},children:i.reward_type==="artifact"&&i.css_effect?.icon?e.jsx("span",{className:"text-4xl",children:i.css_effect.icon}):e.jsx(se,{className:"w-8 h-8",style:{color:o.color}})}),e.jsx("p",{className:"font-medium text-sm truncate",children:i.name}),e.jsx("p",{className:"text-xs truncate",style:{color:o.color},children:o.label}),r&&e.jsx("div",{className:"absolute inset-0 bg-background/50 flex items-center justify-center rounded-lg",children:e.jsx("div",{className:"animate-spin rounded-full h-5 w-5 border-b-2 border-primary"})})]})})},Kx=({reward:t})=>e.jsx(_.div,{layout:!0,initial:{opacity:0},animate:{opacity:1},children:e.jsxs(Me,{className:"relative p-3 border-2 border-dashed border-border/30 bg-muted/20",children:[e.jsx("div",{className:"absolute -top-2 -right-2 w-6 h-6 rounded-full bg-muted flex items-center justify-center",children:e.jsx(er,{className:"w-3 h-3 text-muted-foreground"})}),e.jsx("div",{className:"aspect-square rounded-lg mb-2 flex items-center justify-center bg-muted/50",children:e.jsx(se,{className:"w-8 h-8 text-muted-foreground/30"})}),e.jsx("p",{className:"font-medium text-sm truncate text-muted-foreground",children:"???"}),e.jsx("p",{className:"text-xs text-muted-foreground/50",children:"Complete epics to unlock"})]})}),zc=n.memo(()=>{const[t,s]=n.useState("badges");return e.jsx("div",{className:"space-y-4 mt-4",children:e.jsxs(Sn,{value:t,onValueChange:a=>s(a),children:[e.jsxs(gr,{className:"grid w-full grid-cols-3 h-10",children:[e.jsxs(Ot,{value:"badges",className:"flex items-center gap-2",children:[e.jsx(Vr,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Badges"})]}),e.jsxs(Ot,{value:"cards",className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Cards"})]}),e.jsxs(Ot,{value:"loot",className:"flex items-center gap-2",children:[e.jsx(Zu,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Loot"})]})]}),e.jsx($t,{value:"badges",className:"mt-4",children:e.jsx($x,{})}),e.jsx($t,{value:"cards",className:"mt-4",children:e.jsx(Bc,{})}),e.jsx($t,{value:"loot",className:"mt-4",children:e.jsx(Hc,{})})]})})});zc.displayName="CollectionTab";const Mt={pomodoro:25,short_break:5,long_break:15,custom:30},Gx=300;function Yx(){const{user:t}=ce(),{toast:s}=Ut(),a=Se(),{awardFocusSessionComplete:r}=bt(),i=n.useRef(null),o=n.useRef(null),{triggerPomodoroComplete:c}=Na(),[l,u]=n.useState({isRunning:!1,isPaused:!1,timeRemaining:Mt.pomodoro*60,totalTime:Mt.pomodoro*60,sessionType:"pomodoro",currentSessionId:null,distractionsCount:0,isCooldown:!1,cooldownTimeRemaining:0}),{data:m=[],isLoading:p}=ye({queryKey:["focus-sessions",t?.id,"today"],queryFn:async()=>{if(!t?.id)return[];const A=new Date().toISOString().split("T")[0],{data:L,error:H}=await N.from("focus_sessions").select("*").eq("user_id",t.id).gte("started_at",`${A}T00:00:00`).order("started_at",{ascending:!1});if(H)throw H;return L},enabled:!!t?.id}),h=ie({mutationFn:async({taskId:A,durationType:L,customDuration:H})=>{if(!t?.id)throw new Error("Not authenticated");const I=H||Mt[L],{data:te,error:V}=await N.from("focus_sessions").insert({user_id:t.id,task_id:A||null,duration_type:L,planned_duration:I,started_at:new Date().toISOString(),status:"active",distractions_count:0}).select().single();if(V)throw V;return te},onSuccess:A=>{a.invalidateQueries({queryKey:["focus-sessions"]}),u(L=>({...L,isRunning:!0,isPaused:!1,timeRemaining:A.planned_duration*60,totalTime:A.planned_duration*60,sessionType:A.duration_type,currentSessionId:A.id,distractionsCount:0,isCooldown:!1,cooldownTimeRemaining:0}))},onError:A=>{console.error("Failed to start session:",A),s({title:"Failed to start focus session",variant:"destructive"})}}),f=m.filter(A=>A.status==="completed").length,d=f<Ft.DAILY_SESSION_CAP,g=Math.max(0,Ft.DAILY_SESSION_CAP-f),y=ie({mutationFn:async({sessionId:A,actualDuration:L,distractionsCount:H,isPerfect:I,underCap:te})=>{let V;te?(V=Ft.SESSION_COMPLETE,I&&(V+=Ft.PERFECT_FOCUS_BONUS)):V=Ft.CAPPED_SESSION_XP;const{data:z,error:W}=await N.from("focus_sessions").update({status:"completed",completed_at:new Date().toISOString(),actual_duration:L,distractions_count:H,xp_earned:V}).eq("id",A).select().single();if(W)throw W;return{session:z,isPerfect:I,underCap:te}},onSuccess:({session:A,isPerfect:L,underCap:H})=>{a.invalidateQueries({queryKey:["focus-sessions"]}),r(L,H),A.planned_duration>=15&&c(A.planned_duration).catch(I=>console.log("[LivingCompanion] Pomodoro trigger failed:",I)),j()}}),v=ie({mutationFn:async A=>{const{data:L,error:H}=await N.from("focus_sessions").update({status:"paused",paused_at:new Date().toISOString()}).eq("id",A).select().single();if(H)throw H;return L},onSuccess:()=>{a.invalidateQueries({queryKey:["focus-sessions"]})}}),b=ie({mutationFn:async A=>{const{data:L,error:H}=await N.from("focus_sessions").update({status:"active",paused_at:null}).eq("id",A).select().single();if(H)throw H;return L},onSuccess:()=>{a.invalidateQueries({queryKey:["focus-sessions"]})}}),x=ie({mutationFn:async A=>{const{data:L,error:H}=await N.from("focus_sessions").update({status:"cancelled",completed_at:new Date().toISOString()}).eq("id",A).select().single();if(H)throw H;return L},onSuccess:()=>{a.invalidateQueries({queryKey:["focus-sessions"]}),T()}}),j=n.useCallback(()=>{i.current&&clearInterval(i.current),u(A=>({...A,isRunning:!1,isPaused:!1,isCooldown:!0,cooldownTimeRemaining:Gx,currentSessionId:null,distractionsCount:0}))},[]),w=n.useCallback(()=>{o.current&&clearInterval(o.current),u(A=>({...A,isCooldown:!1,cooldownTimeRemaining:0,timeRemaining:Mt.pomodoro*60,totalTime:Mt.pomodoro*60}))},[]),D=n.useCallback(()=>{u(A=>({...A,distractionsCount:A.distractionsCount+1}))},[]);n.useEffect(()=>(l.isCooldown&&l.cooldownTimeRemaining>0&&(o.current=setInterval(()=>{u(A=>A.cooldownTimeRemaining<=1?{...A,isCooldown:!1,cooldownTimeRemaining:0,timeRemaining:Mt.pomodoro*60,totalTime:Mt.pomodoro*60}:{...A,cooldownTimeRemaining:A.cooldownTimeRemaining-1})},1e3)),()=>{o.current&&clearInterval(o.current)}),[l.isCooldown,l.cooldownTimeRemaining>0]),n.useEffect(()=>(l.isRunning&&!l.isPaused&&(i.current=setInterval(()=>{u(A=>{if(A.timeRemaining<=1){if(A.currentSessionId){const L=Math.round((A.totalTime-A.timeRemaining)/60),H=A.distractionsCount===0;y.mutate({sessionId:A.currentSessionId,actualDuration:L,distractionsCount:A.distractionsCount,isPerfect:H,underCap:d})}return{...A,isRunning:!1,timeRemaining:0}}return{...A,timeRemaining:A.timeRemaining-1}})},1e3)),()=>{i.current&&clearInterval(i.current)}),[l.isRunning,l.isPaused,d]);const S=n.useCallback((A,L="pomodoro",H)=>{h.mutate({taskId:A,durationType:L,customDuration:H})},[]),M=n.useCallback(()=>{l.currentSessionId&&(v.mutate(l.currentSessionId),u(A=>({...A,isPaused:!0})))},[l.currentSessionId]),C=n.useCallback(()=>{l.currentSessionId&&(b.mutate(l.currentSessionId),u(A=>({...A,isPaused:!1})))},[l.currentSessionId]),R=n.useCallback(()=>{l.currentSessionId&&x.mutate(l.currentSessionId)},[l.currentSessionId]),T=n.useCallback(()=>{i.current&&clearInterval(i.current),o.current&&clearInterval(o.current),u({isRunning:!1,isPaused:!1,timeRemaining:Mt.pomodoro*60,totalTime:Mt.pomodoro*60,sessionType:"pomodoro",currentSessionId:null,distractionsCount:0,isCooldown:!1,cooldownTimeRemaining:0})},[]),q=n.useCallback((A,L)=>{const H=L||Mt[A];u(I=>({...I,sessionType:A,timeRemaining:H*60,totalTime:H*60}))},[]),k=m.filter(A=>A.status==="completed"&&A.duration_type==="pomodoro").reduce((A,L)=>A+(L.actual_duration||0),0),P=m.filter(A=>A.status==="completed").reduce((A,L)=>A+(L.xp_earned||0),0);return{timerState:l,todaySessions:m,isLoading:p,startSession:S,pauseSession:M,resumeSession:C,cancelSession:R,resetTimer:T,setSessionType:q,logDistraction:D,skipCooldown:w,stats:{completedToday:f,totalFocusMinutes:k,totalXPToday:P,sessionsUntilCap:g,dailyCap:Ft.DAILY_SESSION_CAP},DURATION_PRESETS:Mt}}function Vx({taskId:t,taskName:s,compact:a=!1,onComplete:r}){const{timerState:i,startSession:o,pauseSession:c,resumeSession:l,cancelSession:u,logDistraction:m,skipCooldown:p,stats:h}=Yx(),f=b=>{const x=Math.floor(b/60),j=b%60;return`${x.toString().padStart(2,"0")}:${j.toString().padStart(2,"0")}`},d=i.isCooldown?(300-i.cooldownTimeRemaining)/300*100:i.totalTime>0?(i.totalTime-i.timeRemaining)/i.totalTime*100:0,g=i.isCooldown?i.cooldownTimeRemaining:i.timeRemaining,y=()=>{o(t,"pomodoro")},v=()=>{i.isPaused?l():c()};return a?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"text-lg font-mono font-bold text-foreground",children:f(g)}),!i.isRunning&&!i.isCooldown?e.jsx(B,{size:"sm",variant:"ghost",onClick:y,children:e.jsx(Vt,{className:"w-4 h-4"})}):i.isCooldown?e.jsx(B,{size:"sm",variant:"ghost",onClick:p,children:e.jsx(ua,{className:"w-4 h-4"})}):e.jsx(B,{size:"sm",variant:"ghost",onClick:v,children:i.isPaused?e.jsx(Vt,{className:"w-4 h-4"}):e.jsx(Rs,{className:"w-4 h-4"})})]}):e.jsx(Me,{className:"overflow-hidden",children:e.jsxs(wn,{className:"p-6",children:[!i.isRunning&&!i.isCooldown&&e.jsxs("div",{className:"flex items-start gap-3 mb-6 p-3 rounded-lg bg-muted/50",children:[e.jsx(Rt,{className:"w-5 h-5 text-primary shrink-0 mt-0.5"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-foreground",children:"Pomodoro Technique:"})," ","Focus for 25 minutes, then take a 5-minute break. This helps maintain concentration and avoid burnout."]})]}),i.isCooldown&&e.jsxs("div",{className:"flex items-center justify-center gap-2 mb-6 p-3 rounded-lg bg-green-500/10",children:[e.jsx(em,{className:"w-5 h-5 text-green-500"}),e.jsx("p",{className:"text-sm font-medium text-green-600 dark:text-green-400",children:"Take a break! Stretch, hydrate, rest your eyes."})]}),e.jsx("div",{className:"relative flex justify-center mb-6",children:e.jsxs("div",{className:"relative w-48 h-48",children:[e.jsxs("svg",{className:"w-full h-full transform -rotate-90",children:[e.jsx("circle",{cx:"96",cy:"96",r:"88",fill:"none",stroke:"currentColor",strokeWidth:"8",className:"text-muted/20"}),e.jsx(_.circle,{cx:"96",cy:"96",r:"88",fill:"none",stroke:"currentColor",strokeWidth:"8",strokeLinecap:"round",className:E(i.isCooldown?"text-green-500":"text-primary"),strokeDasharray:553,strokeDashoffset:553-553*d/100,initial:!1,animate:{strokeDashoffset:553-553*d/100},transition:{duration:.5}})]}),e.jsxs("div",{className:"absolute inset-0 flex flex-col items-center justify-center",children:[e.jsx(be,{mode:"wait",children:e.jsx(_.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:"text-4xl font-mono font-bold text-foreground",children:f(g)},g)}),e.jsx("span",{className:E("text-sm mt-1",i.isCooldown?"text-green-500 font-medium":"text-muted-foreground"),children:i.isCooldown?"Cooldown":"Focus Time"})]})]})}),s&&!i.isCooldown&&e.jsxs("div",{className:"text-center mb-4",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:"Working on:"}),e.jsx("p",{className:"font-medium text-foreground truncate",children:s})]}),e.jsx("div",{className:"flex justify-center gap-3",children:i.isCooldown?e.jsxs(B,{onClick:p,variant:"outline",size:"lg",className:"gap-2",children:[e.jsx(ua,{className:"w-5 h-5"}),"Skip Break"]}):i.isRunning?e.jsxs(e.Fragment,{children:[e.jsx(B,{variant:"outline",size:"icon",onClick:u,className:"h-12 w-12",children:e.jsx(tm,{className:"w-5 h-5"})}),e.jsx(B,{size:"lg",onClick:v,className:"gap-2 px-8",children:i.isPaused?e.jsxs(e.Fragment,{children:[e.jsx(Vt,{className:"w-5 h-5"}),"Resume"]}):e.jsxs(e.Fragment,{children:[e.jsx(Rs,{className:"w-5 h-5"}),"Pause"]})}),e.jsx(B,{variant:"outline",size:"icon",onClick:m,className:"h-12 w-12",title:"Log distraction",children:e.jsx(Be,{className:"w-5 h-5"})})]}):e.jsxs(B,{onClick:y,size:"lg",className:"gap-2",children:[e.jsx(Vt,{className:"w-5 h-5"}),"Start Focus"]})}),i.isRunning&&i.distractionsCount>0&&e.jsx("div",{className:"text-center mt-4",children:e.jsxs("span",{className:"text-sm text-muted-foreground",children:["Distractions: ",i.distractionsCount]})}),h.sessionsUntilCap>0?e.jsxs("div",{className:"text-center mt-4 text-sm text-muted-foreground",children:[e.jsx("span",{className:"font-medium text-primary",children:h.sessionsUntilCap})," full XP session",h.sessionsUntilCap!==1?"s":""," remaining today"]}):e.jsxs("div",{className:"text-center mt-4 text-sm text-muted-foreground",children:["Daily cap reached â€” sessions now award ",e.jsx("span",{className:"font-medium",children:"3 XP"})]}),e.jsxs("div",{className:"flex justify-center gap-6 mt-6 pt-4 border-t border-border",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-foreground",children:h.completedToday}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Sessions"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-foreground",children:h.totalFocusMinutes}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Minutes"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-primary",children:h.totalXPToday}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"XP"})]})]})]})})}const Xx=Hs("rounded-2xl border transition-all duration-300",{variants:{variant:{default:["bg-card/78 backdrop-blur-lg","border-border/60","shadow-[0_10px_24px_rgba(0,0,0,0.22)]"],elevated:["bg-card/86 backdrop-blur-2xl","border-border/70","shadow-[0_14px_34px_rgba(0,0,0,0.28),0_2px_8px_rgba(0,0,0,0.12)]"],inset:["bg-background/60 backdrop-blur-lg","border-border/45","shadow-inner"],hero:["bg-gradient-to-br from-primary/[0.12] to-accent/[0.07] backdrop-blur-2xl","border-border/60","shadow-[0_16px_38px_rgba(0,0,0,0.24)]"],subtle:["bg-card/62 backdrop-blur-md","border-border/45","shadow-[0_6px_16px_rgba(0,0,0,0.16)]"],ultra:["bg-card/70 backdrop-blur-2xl","border-border/55","shadow-[0_10px_28px_rgba(0,0,0,0.24)]"]},glow:{none:"",soft:"shadow-[0_0_30px_rgba(255,255,255,0.05)]",accent:"shadow-[0_0_40px_hsl(var(--accent)/0.15)]",primary:"shadow-[0_0_40px_hsl(var(--primary)/0.2)]"}},defaultVariants:{variant:"default",glow:"none"}}),ls=n.forwardRef(({className:t,variant:s,glow:a,...r},i)=>e.jsx("div",{ref:i,className:E(Xx({variant:s,glow:a}),t),...r}));ls.displayName="GlassCard";const Uc=n.memo(({habit:t,onResist:s,onRemove:a,isLoading:r})=>e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:e.jsx(ls,{variant:"subtle",className:"p-4",children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"text-2xl flex-shrink-0",children:t.icon}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("h4",{className:"font-medium text-sm text-foreground truncate",children:t.name}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{children:["Resisted ",t.times_resisted,"Ã—"]}),t.current_streak>0&&e.jsxs("span",{className:"flex items-center gap-1 text-orange-400",children:[e.jsx(pt,{className:"h-3 w-3"}),t.current_streak," streak"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx(B,{variant:"ghost",size:"icon",className:"h-8 w-8 text-muted-foreground hover:text-destructive",onClick:a,disabled:r,children:e.jsx(es,{className:"h-4 w-4"})}),e.jsxs(B,{size:"sm",onClick:s,disabled:r,className:"gap-1.5",children:[e.jsx(Bt,{className:"h-4 w-4"}),"Resist"]})]})]})})}));Uc.displayName="HabitResistCard";const Jx=Hs("text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70"),Fe=n.forwardRef(({className:t,...s},a)=>e.jsx(zo,{ref:a,className:E(Jx(),t),...s}));Fe.displayName=zo.displayName;const ya=om,ba=lm,Os=n.forwardRef(({className:t,children:s,...a},r)=>e.jsxs(Uo,{ref:r,className:E("flex h-11 w-full items-center justify-between rounded-lg border border-input bg-secondary/50 px-4 py-2 text-sm font-medium text-foreground ring-offset-background placeholder:text-muted-foreground focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:border-primary disabled:cursor-not-allowed disabled:opacity-50 [&>span]:line-clamp-1 transition-all",t),...a,children:[s,e.jsx(sm,{asChild:!0,children:e.jsx(Jt,{className:"h-4 w-4 opacity-50"})})]}));Os.displayName=Uo.displayName;const Wc=n.forwardRef(({className:t,...s},a)=>e.jsx(Wo,{ref:a,className:E("flex cursor-default items-center justify-center py-1",t),...s,children:e.jsx(un,{className:"h-4 w-4"})}));Wc.displayName=Wo.displayName;const Qc=n.forwardRef(({className:t,...s},a)=>e.jsx(Qo,{ref:a,className:E("flex cursor-default items-center justify-center py-1",t),...s,children:e.jsx(Jt,{className:"h-4 w-4"})}));Qc.displayName=Qo.displayName;const $s=n.forwardRef(({className:t,children:s,position:a="popper",...r},i)=>e.jsx(am,{children:e.jsxs(Ko,{ref:i,className:E("relative z-[100] max-h-96 min-w-[8rem] overflow-hidden rounded-lg border bg-popover text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",a==="popper"&&"data-[side=bottom]:translate-y-1 data-[side=left]:-translate-x-1 data-[side=right]:translate-x-1 data-[side=top]:-translate-y-1",t),position:a,...r,children:[e.jsx(Wc,{}),e.jsx(rm,{className:E("p-1",a==="popper"&&"h-[var(--radix-select-trigger-height)] w-full min-w-[var(--radix-select-trigger-width)]"),children:s}),e.jsx(Qc,{})]})}));$s.displayName=Ko.displayName;const Zx=n.forwardRef(({className:t,...s},a)=>e.jsx(Go,{ref:a,className:E("py-1.5 pl-8 pr-2 text-sm font-semibold",t),...s}));Zx.displayName=Go.displayName;const ds=n.forwardRef(({className:t,children:s,...a},r)=>e.jsxs(Yo,{ref:r,className:E("relative flex w-full cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",t),...a,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(nm,{children:e.jsx(Xe,{className:"h-4 w-4"})})}),e.jsx(im,{children:s})]}));ds.displayName=Yo.displayName;const e0=n.forwardRef(({className:t,...s},a)=>e.jsx(Vo,{ref:a,className:E("-mx-1 my-1 h-px bg-muted",t),...s}));e0.displayName=Vo.displayName;const t0=[{value:"distraction",label:"Distraction"},{value:"laziness",label:"Laziness"},{value:"stagnation",label:"Stagnation"},{value:"anxiety",label:"Anxiety"},{value:"overthinking",label:"Overthinking"},{value:"doubt",label:"Self-Doubt"},{value:"fear",label:"Fear"}],Kc=n.memo(({onAdd:t,isLoading:s})=>{const[a,r]=n.useState(!1),[i,o]=n.useState("preset"),[c,l]=n.useState(""),[u,m]=n.useState("ðŸš«"),[p,h]=n.useState("distraction"),f=g=>{t({name:g.name,icon:g.icon,theme:g.theme}),r(!1)},d=()=>{c.trim()&&(t({name:c.trim(),icon:u,theme:p}),l(""),m("ðŸš«"),h("distraction"),r(!1))};return e.jsxs(ct,{open:a,onOpenChange:r,children:[e.jsx(Rh,{asChild:!0,children:e.jsxs(B,{variant:"outline",className:"w-full gap-2",children:[e.jsx(ha,{className:"h-4 w-4"}),"Add Bad Habit"]})}),e.jsxs(ot,{className:"sm:max-w-md",children:[e.jsx(as,{children:e.jsxs(St,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-5 w-5 text-primary"}),"Track a Bad Habit"]})}),e.jsxs("div",{className:"flex gap-2 mb-4",children:[e.jsx(B,{variant:i==="preset"?"default":"outline",size:"sm",onClick:()=>o("preset"),className:"flex-1",children:"Quick Select"}),e.jsx(B,{variant:i==="custom"?"default":"outline",size:"sm",onClick:()=>o("custom"),className:"flex-1",children:"Custom"})]}),i==="preset"?e.jsx("div",{className:"grid grid-cols-2 gap-2 max-h-[300px] overflow-y-auto",children:wf.map(g=>e.jsx(ls,{variant:"subtle",className:"p-3 cursor-pointer hover:bg-primary/10 transition-colors",onClick:()=>f(g),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xl",children:g.icon}),e.jsx("span",{className:"text-sm font-medium",children:g.name})]})},g.name))}):e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{htmlFor:"habit-name",children:"Habit Name"}),e.jsx(He,{id:"habit-name",placeholder:"e.g., Late night snacking",value:c,onChange:g=>l(g.target.value)})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{htmlFor:"habit-icon",children:"Icon"}),e.jsx(He,{id:"habit-icon",placeholder:"ðŸš«",value:u,onChange:g=>m(g.target.value),maxLength:2,className:"text-center text-xl"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{htmlFor:"habit-theme",children:"Category"}),e.jsxs(ya,{value:p,onValueChange:g=>h(g),children:[e.jsx(Os,{id:"habit-theme",children:e.jsx(ba,{})}),e.jsx($s,{children:t0.map(g=>e.jsx(ds,{value:g.value,children:g.label},g.value))})]})]})]}),e.jsx(B,{className:"w-full",onClick:d,disabled:!c.trim()||s,children:"Add Habit"})]})]})]})});Kc.displayName="AddBadHabitDialog";const s0=()=>{const{user:t}=ce(),s=Se(),{data:a,isLoading:r}=ye({queryKey:["bad-habits",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:p,error:h}=await N.from("user_bad_habits").select("*").eq("user_id",t.id).eq("is_active",!0).order("created_at",{ascending:!1});if(h)throw h;return p},enabled:!!t?.id}),{data:i,isLoading:o}=ye({queryKey:["resist-log",t?.id],queryFn:async()=>{if(!t?.id)return[];const p=new Date;p.setDate(p.getDate()-30);const{data:h,error:f}=await N.from("resist_log").select("*").eq("user_id",t.id).gte("created_at",p.toISOString()).order("created_at",{ascending:!1});if(f)throw f;return h},enabled:!!t?.id}),c=ie({mutationFn:async p=>{if(!t?.id)throw new Error("User not found");const{data:h,error:f}=await N.from("user_bad_habits").insert({user_id:t.id,name:p.name,icon:p.icon,habit_theme:p.theme}).select().single();if(f)throw f;return h},onSuccess:p=>{s.setQueryData(["bad-habits",t?.id],h=>[p,...h??[]]),s.invalidateQueries({queryKey:["bad-habits"]}),X.success("Bad habit added! Ready to resist.")},onError:p=>{console.error("Failed to add habit:",p),X.error("Failed to add habit")}}),l=ie({mutationFn:async p=>{if(!t?.id)throw new Error("User not found");const{error:h}=await N.from("user_bad_habits").update({is_active:!1}).eq("id",p).eq("user_id",t.id);if(h)throw h},onSuccess:(p,h)=>{s.setQueryData(["bad-habits",t?.id],f=>(f??[]).filter(d=>d.id!==h)),s.invalidateQueries({queryKey:["bad-habits"]}),X.success("Habit removed")},onError:p=>{console.error("Failed to remove habit:",p),X.error("Failed to remove habit")}}),u=n.useCallback(p=>a?.find(h=>h.id===p),[a]),m=n.useMemo(()=>{const p=a?.reduce((g,y)=>g+y.times_resisted,0)??0,h=i?.filter(g=>g.result!=="fail").length??0,f=i?.filter(g=>new Date(g.created_at).toDateString()===new Date().toDateString()&&g.result!=="fail").length??0,d=Math.max(...a?.map(g=>g.longest_streak)??[0]);return{totalResisted:p,successfulResists:h,todayResists:f,bestStreak:d}},[a,i]);return{habits:a,resistHistory:i,stats:m,isLoading:r||o,isAddingHabit:c.isPending,isRemovingHabit:l.isPending,addHabit:c.mutate,removeHabit:l.mutate,getHabit:u}},Gc=n.memo(()=>{const{habits:t,stats:s,isLoading:a,addHabit:r,removeHabit:i,isAddingHabit:o}=s0(),{checkEncounterTrigger:c,isTriggeringEncounter:l}=oc(),[u,m]=n.useState(null),[p,h]=n.useState(!1),f=n.useCallback(async y=>{if(!(p||l)){m(y.id),h(!0);try{await c("urge_resist",y.id,void 0,y.habit_theme)}finally{m(null),h(!1)}}},[c,p,l]),d=n.useCallback(y=>{r(y)},[r]),g=n.useCallback(y=>{i(y)},[i]);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs(ls,{variant:"subtle",className:"p-4 text-center space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-primary",children:[e.jsx(Bt,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium",children:"Resist urges to grow stronger"}),e.jsx(Bt,{className:"h-5 w-5"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Beat a quick game instead of giving in to bad habits"})]}),(s.totalResisted>0||s.bestStreak>0)&&e.jsxs("div",{className:"grid grid-cols-3 gap-2",children:[e.jsxs(ls,{variant:"inset",className:"p-3 text-center",children:[e.jsx("div",{className:"flex items-center justify-center gap-1 text-primary mb-1",children:e.jsx(Ze,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"text-lg font-bold",children:s.totalResisted}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Total"})]}),e.jsxs(ls,{variant:"inset",className:"p-3 text-center",children:[e.jsx("div",{className:"flex items-center justify-center gap-1 text-orange-400 mb-1",children:e.jsx(pt,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"text-lg font-bold",children:s.bestStreak}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Best Streak"})]}),e.jsxs(ls,{variant:"inset",className:"p-3 text-center",children:[e.jsx("div",{className:"flex items-center justify-center gap-1 text-green-400 mb-1",children:e.jsx(Be,{className:"h-3.5 w-3.5"})}),e.jsx("div",{className:"text-lg font-bold",children:s.todayResists}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Today"})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(be,{mode:"popLayout",children:t?.map(y=>e.jsx(Uc,{habit:y,onResist:()=>f(y),onRemove:()=>g(y.id),isLoading:p||l||u===y.id},y.id))}),!a&&(!t||t.length===0)&&e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},className:"py-8 text-center",children:[e.jsx(Bt,{className:"h-12 w-12 mx-auto text-muted-foreground/50 mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-1",children:"No habits tracked yet"}),e.jsx("p",{className:"text-xs text-muted-foreground/70",children:"Add a bad habit to start building resistance"})]})]}),e.jsx(Kc,{onAdd:d,isLoading:o})]})});Gc.displayName="ResistModePanel";const Yc=n.memo(()=>{const[t,s]=n.useState("focus");return e.jsxs("div",{className:"space-y-6 mt-6",children:[e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(B,{variant:t==="focus"?"default":"outline",size:"sm",onClick:()=>s("focus"),className:"flex-1 gap-2",children:[e.jsx(ir,{className:"h-4 w-4"}),"Focus"]}),e.jsxs(B,{variant:t==="resist"?"default":"outline",size:"sm",onClick:()=>s("resist"),className:"flex-1 gap-2",children:[e.jsx(Bt,{className:"h-4 w-4"}),"Resist"]})]}),t==="focus"?e.jsxs(e.Fragment,{children:[e.jsxs(ls,{variant:"subtle",className:"p-4 text-center space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-center gap-2 text-primary",children:[e.jsx(se,{className:"h-5 w-5"}),e.jsx("span",{className:"text-sm font-medium",children:"Focus to grow your companion"}),e.jsx(se,{className:"h-5 w-5"})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"XP earned from focus sessions helps your companion evolve"})]}),e.jsx(Vx,{})]}):e.jsx(Gc,{})]})});Yc.displayName="FocusTab";const Vc=n.memo(({className:t,chance:s=.15})=>{const{getRandomMemory:a,getMemoryDialogue:r,referenceMemory:i,memories:o}=Cn(),{presence:c}=dr(),{primaryAura:l}=pc(),[u,m]=n.useState(null),[p,h]=n.useState(!1),f=n.useRef(!1);return n.useEffect(()=>{if(!c.isPresent||c.mood==="dormant"||o.length===0||f.current||Math.random()>s)return;const d=setTimeout(()=>{const g=a();if(g){const y=r(g);y&&(m(y),h(!0),i(g.id),f.current=!0)}},2e3);return()=>clearTimeout(d)},[o.length,c.isPresent,c.mood,s]),!u||!p?null:e.jsx(be,{children:e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-5},transition:{duration:.3},className:E("mt-2 p-2 rounded-lg","bg-primary/5 border border-primary/10",t),style:{boxShadow:`inset 0 0 20px ${l}15`},children:e.jsxs("p",{className:"text-xs text-muted-foreground italic",children:['ðŸ’­ "',u,'"']})})})});Vc.displayName="MemoryWhisper";const a0=[{icon:Ze,text:"Complete quests to earn XP and level up"},{icon:cm,text:"Stats reflect your Mind, Body, and Soul focus"},{icon:pt,text:"Keep streaks going to boost evolution speed"},{icon:Xt,text:"Don't neglect themâ€”they'll miss you!"}];function r0({open:t,onClose:s}){return e.jsx(Sc,{open:t,onClose:s,icon:se,title:"Your Companion Awaits",subtitle:"A magical creature that evolves through 21 stages as you grow and complete quests.",features:a0,footerHint:"View your companion's stats, cards, and story below!",buttonText:"Continue"})}const Xc=n.memo(({companion:t,nextEvolutionXP:s,progressToNext:a})=>e.jsxs("div",{className:"space-y-6 mt-6",children:[e.jsx(Vc,{chance:.2,className:"px-2"}),e.jsx(Dt,{offset:30,children:e.jsx(Ic,{})}),e.jsx(Dt,{offset:22,children:e.jsx(qc,{currentXP:t?.current_xp||0,nextEvolutionXP:s||0,currentStage:t?.current_stage||0,progressPercent:a})}),e.jsx(Dt,{offset:16,children:e.jsx(Oc,{})}),e.jsx(Dt,{offset:12,children:e.jsx(Lc,{})})]}));Xc.displayName="OverviewTab";const n0=n.lazy(()=>me(()=>import("./CompanionStoryJournal-D-2D_7jp.js"),__vite__mapDeps([12,1,2,3])).then(t=>({default:t.CompanionStoryJournal}))),i0=n.lazy(()=>me(()=>import("./CompanionPostcards-DcyMqcgw.js"),__vite__mapDeps([13,1,2,3])).then(t=>({default:t.CompanionPostcards}))),Oi=()=>e.jsxs("div",{className:"space-y-4 mt-6",children:[e.jsx(ue,{className:"h-48 w-full rounded-xl"}),e.jsx(ue,{className:"h-32 w-full rounded-xl"})]}),o0=()=>e.jsxs("div",{className:"space-y-6 mt-6",children:[e.jsxs("div",{className:"rounded-xl border border-cosmiq-glow/10 p-6",children:[e.jsx(ue,{className:"h-48 w-48 rounded-full mx-auto"}),e.jsx(ue,{className:"h-6 w-32 mx-auto mt-4"})]}),e.jsx(ue,{className:"h-32 w-full rounded-xl"}),e.jsx(ue,{className:"h-40 w-full rounded-xl"}),e.jsx(ue,{className:"h-24 w-full rounded-xl"})]}),l0=()=>{const t=ss(),{companion:s,nextEvolutionXP:a,progressToNext:r,isLoading:i,error:o,refetch:c}=st(),[l,u]=n.useState("overview"),{showModal:m,dismissModal:p}=kn("companion"),h=Ht(),f=()=>o?e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs("div",{className:"text-center space-y-4 p-6",children:[e.jsx(se,{className:"h-16 w-16 mx-auto text-destructive"}),e.jsx("h2",{className:"text-2xl font-bold",children:"Error Loading Companion"}),e.jsx("p",{className:"text-muted-foreground max-w-md",children:o instanceof Error?o.message:"Unable to load your companion data. Please try refreshing the page."}),e.jsx(B,{variant:"default",onClick:()=>{c()},className:"mt-4 h-11 px-6",children:"Retry"})]})}):!i&&!s?e.jsx("div",{className:"flex items-center justify-center min-h-[60vh]",children:e.jsxs("div",{className:"text-center space-y-4 p-6",children:[e.jsx(se,{className:"h-16 w-16 mx-auto text-primary"}),e.jsx("h2",{className:"text-2xl font-bold",children:"No Companion Found"}),e.jsx("p",{className:"text-muted-foreground max-w-md",children:"It looks like you haven't created your companion yet. Please complete the onboarding process to get started."}),e.jsx(B,{variant:"default",onClick:()=>h("/onboarding"),className:"mt-4 h-11 px-6",children:"Start Onboarding"})]})}):e.jsxs(Sn,{value:l,onValueChange:u,className:"container pb-6",children:[e.jsxs(gr,{className:"grid w-full grid-cols-5 bg-card/80 backdrop-blur-md border border-border/60",children:[e.jsxs(Ot,{value:"overview",className:"flex items-center gap-2",children:[e.jsx(zt,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Overview"})]}),e.jsxs(Ot,{value:"focus",className:"flex items-center gap-2",children:[e.jsx(ir,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Focus"})]}),e.jsxs(Ot,{value:"stories",className:"flex items-center gap-2",children:[e.jsx(pa,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Stories"})]}),e.jsxs(Ot,{value:"postcards",className:"flex items-center gap-2",children:[e.jsx(zs,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Postcards"})]}),e.jsxs(Ot,{value:"collection",className:"flex items-center gap-2",children:[e.jsx(um,{className:"h-4 w-4"}),e.jsx("span",{className:"hidden sm:inline",children:"Collection"})]})]}),e.jsx(be,{mode:"wait",children:i?e.jsx(_.div,{initial:{opacity:1},exit:{opacity:0},transition:{duration:t?0:.15},children:e.jsx(o0,{})},"skeleton"):e.jsxs(_.div,{initial:t?!1:{opacity:0},animate:{opacity:1},transition:{duration:t?0:.2},children:[e.jsx($t,{value:"overview",children:l==="overview"&&e.jsx(Xc,{companion:s,nextEvolutionXP:a,progressToNext:r})}),e.jsx($t,{value:"focus",children:l==="focus"&&e.jsx(Yc,{})}),e.jsx($t,{value:"stories",children:l==="stories"&&e.jsx(n.Suspense,{fallback:e.jsx(Oi,{}),children:e.jsx(n0,{})})}),e.jsx($t,{value:"postcards",children:l==="postcards"&&e.jsx(n.Suspense,{fallback:e.jsx(Oi,{}),children:e.jsx(i0,{})})}),e.jsx($t,{value:"collection",children:l==="collection"&&e.jsx(zc,{})})]},"content")})]});return e.jsxs(Sa,{mode:"instant",children:[e.jsxs(xc,{children:[e.jsx(Ta,{}),e.jsxs("div",{className:"min-h-screen pb-nav-safe relative z-10","data-tour":"companion-page",children:[e.jsx("header",{className:"fixed top-0 left-0 right-0 z-40 w-full cosmiq-glass-header safe-area-top",children:e.jsxs("div",{className:"container flex items-center justify-between py-4",children:[e.jsx("h1",{className:"text-2xl font-semibold tracking-tight",children:"Companion"}),e.jsx(B,{variant:"ghost",size:"icon",onClick:()=>h("/profile"),className:"h-8 w-8 rounded-full bg-muted/50 hover:bg-muted text-muted-foreground hover:text-foreground transition-colors","aria-label":"Settings",children:e.jsx(dm,{className:"h-4 w-4"})})]})}),e.jsx("div",{className:"pt-safe",style:{height:"calc(env(safe-area-inset-top, 0px) + 72px)"}}),f()]})]}),e.jsx(Ca,{}),e.jsx(r0,{open:m,onClose:p})]})},c0=({icon:t,title:s,description:a,actionLabel:r,onAction:i})=>e.jsxs("div",{className:"flex flex-col items-center justify-center text-center space-y-6 py-20",children:[e.jsx("div",{className:"mx-auto w-20 h-20 rounded-full bg-celestial-blue/10 flex items-center justify-center",children:e.jsx(t,{className:"h-10 w-10 text-celestial-blue"})}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("h3",{className:"text-xl font-bold text-foreground",children:s}),e.jsx("p",{className:"text-muted-foreground max-w-md mx-auto",children:a})]}),r&&i&&e.jsx(B,{onClick:i,size:"lg",className:"mt-4",children:r})]}),$i="add-quest-fab-position",d0=500,u0={"top-left":{top:"calc(env(safe-area-inset-top, 0px) + 80px)",left:"16px",bottom:"auto",right:"auto"},"top-right":{top:"calc(env(safe-area-inset-top, 0px) + 80px)",right:"16px",bottom:"auto",left:"auto"},"bottom-left":{bottom:"144px",left:"16px",top:"auto",right:"auto"},"bottom-right":{bottom:"144px",right:"16px",top:"auto",left:"auto"}},Bi=async(t=it.Medium)=>{if(Ke.isNativePlatform())try{await Ct.impact({style:t})}catch{}},m0=(t,s)=>{const a=window.innerWidth/2,r=window.innerHeight/2;return s<r&&t<a?"top-left":s<r?"top-right":t<a?"bottom-left":"bottom-right"},p0=({defaultPosition:t="bottom-right",onDragStart:s,onDragEnd:a}={})=>{const[r,i]=n.useState(()=>{const S=qe.getItem($i);return S&&["top-left","top-right","bottom-left","bottom-right"].includes(S)?S:t}),[o,c]=n.useState(!1),[l,u]=n.useState(!1),[m,p]=n.useState({x:0,y:0}),h=n.useRef(null),f=n.useRef(null);n.useEffect(()=>()=>{h.current&&clearTimeout(h.current)},[]),n.useEffect(()=>{qe.setItem($i,r)},[r]);const d=n.useCallback(()=>{h.current&&(clearTimeout(h.current),h.current=null)},[]),g=n.useCallback(S=>{S.preventDefault();const M=S.target.getBoundingClientRect();f.current={x:M.left+M.width/2,y:M.top+M.height/2},h.current=setTimeout(()=>{u(!0),Bi(it.Medium)},d0)},[]),y=n.useCallback(()=>{d(),o||u(!1)},[d,o]),v=n.useCallback(()=>{d(),u(!1)},[d]),b=n.useCallback(()=>{l&&(c(!0),s?.())},[l,s]),x=n.useCallback((S,M)=>{if(!o){u(!1);return}const C=(f.current?.x||window.innerWidth/2)+M.offset.x,R=(f.current?.y||window.innerHeight/2)+M.offset.y,T=m0(C,R);i(T),c(!1),u(!1),p({x:0,y:0}),Bi(it.Light),a?.(T)},[o,a]),j=n.useMemo(()=>u0[r],[r]),w=n.useMemo(()=>({drag:l,dragConstraints:{top:-500,left:-500,right:500,bottom:500},dragElastic:.1,dragMomentum:!1,onDragStart:b,onDragEnd:x}),[l,b,x]),D=n.useMemo(()=>({onPointerDown:g,onPointerUp:y,onPointerCancel:v}),[g,y,v]);return{position:r,isDragging:o,isLongPressing:l,dragControls:w,longPressHandlers:D,positionStyles:j,dragOffset:m}},Jc=({onTap:t})=>{const{isDragging:s,isLongPressing:a,dragControls:r,longPressHandlers:i,positionStyles:o}=p0(),c=()=>{!s&&!a&&t()},l=u=>{u.preventDefault()};return e.jsx(_.button,{"data-tour":"add-quest-fab",initial:{scale:0,opacity:0},animate:{scale:s?1.15:1,opacity:1,boxShadow:s?"0 8px 30px rgba(0,0,0,0.3)":"0 2px 8px rgba(0,0,0,0.1)"},whileTap:a?void 0:{scale:.9},onClick:c,onTouchStart:l,style:{position:"fixed",zIndex:50,WebkitTouchCallout:"none",WebkitUserSelect:"none",userSelect:"none",...o},className:"w-11 h-11 rounded-full bg-muted/60 backdrop-blur-sm border border-border/50 flex items-center justify-center hover:bg-muted/80 transition-colors touch-none select-none",...r,...i,children:e.jsx(ha,{className:"w-5 h-5 text-muted-foreground"})})},Bs=n.forwardRef(({className:t,...s},a)=>e.jsx(Xo,{ref:a,className:E("peer h-4 w-4 shrink-0 rounded-sm border border-primary ring-offset-background data-[state=checked]:bg-primary data-[state=checked]:text-primary-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...s,children:e.jsx(mm,{className:E("flex items-center justify-center text-current"),children:e.jsx(Xe,{className:"h-4 w-4"})})}));Bs.displayName=Xo.displayName;const En=n.forwardRef(({className:t,onCheckedChange:s,...a},r)=>e.jsx(Jo,{className:E("peer inline-flex h-6 w-11 shrink-0 cursor-pointer items-center rounded-full border-2 border-transparent transition-colors data-[state=checked]:bg-primary data-[state=unchecked]:bg-input focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 focus-visible:ring-offset-background disabled:cursor-not-allowed disabled:opacity-50",t),onCheckedChange:i=>{$e.light(),s?.(i)},...a,ref:r,children:e.jsx(pm,{className:E("pointer-events-none block h-5 w-5 rounded-full bg-background shadow-lg ring-0 transition-transform data-[state=checked]:translate-x-5 data-[state=unchecked]:translate-x-0")})}));En.displayName=Jo.displayName;const h0=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],f0=({selectedDays:t,onDaysChange:s})=>{const a=i=>{t.includes(i)?s(t.filter(o=>o!==i)):s([...t,i].sort())},r=()=>{s([0,1,2,3,4,5,6])};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h4",{className:"text-sm font-medium text-foreground",children:["Select days (",t.length,"/7)"]}),e.jsx("button",{onClick:r,className:"text-xs text-primary hover:text-primary/80 font-medium",children:"Select all"})]}),e.jsx("div",{className:"grid grid-cols-7 gap-2",children:h0.map((i,o)=>e.jsx("button",{onClick:()=>a(o),className:E("aspect-square rounded-full flex items-center justify-center text-xs font-bold transition-all border-2",t.includes(o)?"bg-primary border-primary text-primary-foreground shadow-glow":"border-border bg-card text-muted-foreground hover:border-primary/50"),children:i.charAt(0)},i))})]})};function g0(){const[t,s]=n.useState([]),[a,r]=n.useState(!1),[i,o]=n.useState(null),c=n.useCallback(async(u,m=30,p="medium")=>{r(!0),o(null);try{const{data:h,error:f}=await N.functions.invoke("suggest-task-times",{body:{task_date:Y(u,"yyyy-MM-dd"),estimated_duration:m,difficulty:p}});if(f)throw new Error(f.message);s(h?.suggestedSlots||[])}catch(h){console.error("[useSmartScheduling] Error fetching suggestions:",h),o(h instanceof Error?h.message:"Failed to get suggestions"),s([])}finally{r(!1)}},[]),l=n.useCallback(()=>{s([]),o(null)},[]);return{suggestedSlots:t,isLoading:a,error:i,getSuggestedSlots:c,clearSuggestions:l}}function x0(t){const[s,a]=t.split(":").map(Number),r=s>=12?"PM":"AM";return`${s%12||12}:${a.toString().padStart(2,"0")} ${r}`}const Mn=t=>{const{suggestedSlots:s,getSuggestedSlots:a,isLoading:r}=g0(),[i,o]=n.useState(!1),c=[{value:15,label:"15 min"},{value:30,label:"30 min"},{value:45,label:"45 min"},{value:60,label:"1 hr"},{value:90,label:"1.5 hrs"},{value:120,label:"2 hrs"}],l=[{value:5,label:"5 minutes before"},{value:10,label:"10 minutes before"},{value:15,label:"15 minutes before"},{value:30,label:"30 minutes before"},{value:60,label:"1 hour before"},{value:120,label:"2 hours before"},{value:1440,label:"1 day before"},{value:10080,label:"1 week before"}],u=[{value:"none",label:"None"},{value:"daily",label:"Daily"},{value:"weekly",label:"Weekly"},{value:"custom",label:"Custom Days"}],[m,p]=n.useState(!1),[h,f]=n.useState(!1),[d,g]=n.useState(!1),y=async()=>{t.selectedDate&&(await a(t.selectedDate,t.estimatedDuration||30,t.taskDifficulty),o(!0))},v=s.slice(0,3),b=x=>{t.onScheduledTimeChange(x),o(!1)};return e.jsxs("div",{className:"space-y-4 border-t pt-4",children:[!t.hideScheduledTime&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(lt,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(Fe,{className:"text-sm font-medium",children:"Scheduled Time"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(He,{type:"time",value:t.scheduledTime||"",onChange:x=>t.onScheduledTimeChange(x.target.value||null),className:"flex-1"}),t.selectedDate&&e.jsxs(Wt,{open:i,onOpenChange:o,children:[e.jsx(Qt,{asChild:!0,children:e.jsx(B,{type:"button",variant:"outline",size:"icon",onClick:y,disabled:r,className:"shrink-0",children:r?e.jsx(ze,{className:"h-4 w-4 animate-spin"}):e.jsx(se,{className:"h-4 w-4 text-primary"})})}),e.jsx(qt,{className:"w-64 p-2",align:"end",children:e.jsxs("div",{className:"space-y-1",children:[e.jsx("p",{className:"text-xs font-medium text-muted-foreground px-2 py-1",children:"Suggested Times"}),v.length===0?e.jsx("p",{className:"text-sm text-muted-foreground px-2 py-2",children:"No suggestions available"}):v.map((x,j)=>e.jsx("button",{type:"button",onClick:()=>b(x.time),className:"w-full flex items-start gap-2 px-2 py-2 text-left rounded-md hover:bg-accent transition-colors",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[j===0&&e.jsx(et,{className:"h-3 w-3 text-amber-500 fill-amber-500"}),e.jsx("span",{className:"font-medium text-sm",children:x0(x.time)})]}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:x.reason})]})},x.time))]})})]})]})]}),!t.hideDuration&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(mt,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(Fe,{className:"text-sm font-medium",children:"Estimated Duration"})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>p(!m),className:"w-full px-3 py-2 text-sm text-left border rounded-lg bg-background hover:bg-accent transition-colors flex items-center justify-between",children:[e.jsx("span",{children:t.estimatedDuration?c.find(x=>x.value===t.estimatedDuration)?.label||`${t.estimatedDuration} min`:"Select duration"}),e.jsx(Jt,{className:"w-4 h-4 text-muted-foreground"})]}),m&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-popover border rounded-lg shadow-lg max-h-48 overflow-y-auto",children:c.map(x=>e.jsx("button",{type:"button",onClick:()=>{t.onEstimatedDurationChange(x.value),p(!1)},className:`w-full px-3 py-2 text-sm text-left hover:bg-accent transition-colors ${t.estimatedDuration===x.value?"bg-accent":""}`,children:x.label},x.value))})]})]}),t.scheduledTime&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(hm,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(Fe,{className:"text-sm font-medium",children:"Early Reminder"})]}),e.jsx(En,{checked:t.reminderEnabled,onCheckedChange:t.onReminderEnabledChange})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"You'll be notified when the quest starts. Add an early reminder to prepare ahead."}),t.reminderEnabled&&e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>g(!d),className:"w-full px-3 py-2 text-sm text-left border rounded-lg bg-background hover:bg-accent transition-colors flex items-center justify-between",children:[e.jsx("span",{children:l.find(x=>x.value===t.reminderMinutesBefore)?.label||"Select time"}),e.jsx(Jt,{className:"w-4 h-4 text-muted-foreground"})]}),d&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-popover border rounded-lg shadow-lg max-h-48 overflow-y-auto",children:l.map(x=>e.jsx("button",{type:"button",onClick:()=>{t.onReminderMinutesBeforeChange(x.value),g(!1)},className:`w-full px-3 py-2 text-sm text-left hover:bg-accent transition-colors ${t.reminderMinutesBefore===x.value?"bg-accent":""}`,children:x.label},x.value))})]})]}),!t.hideRecurrence&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(vs,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(Fe,{className:"text-sm font-medium",children:"Recurrence"})]}),e.jsxs("div",{className:"relative",children:[e.jsxs("button",{type:"button",onClick:()=>f(!h),className:"w-full px-3 py-2 text-sm text-left border rounded-lg bg-background hover:bg-accent transition-colors flex items-center justify-between",children:[e.jsx("span",{children:u.find(x=>x.value===(t.recurrencePattern||"none"))?.label||"None"}),e.jsx(Jt,{className:"w-4 h-4 text-muted-foreground"})]}),h&&e.jsx("div",{className:"absolute z-10 w-full mt-1 bg-popover border rounded-lg shadow-lg",children:u.map(x=>e.jsx("button",{type:"button",onClick:()=>{t.onRecurrencePatternChange(x.value==="none"?null:x.value),f(!1)},className:`w-full px-3 py-2 text-sm text-left hover:bg-accent transition-colors ${(t.recurrencePattern||"none")===x.value?"bg-accent":""}`,children:x.label},x.value))})]}),(t.recurrencePattern==="custom"||t.recurrencePattern==="weekly")&&e.jsx(f0,{selectedDays:t.recurrenceDays,onDaysChange:t.onRecurrenceDaysChange})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(zs,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(Fe,{className:"text-sm font-medium",children:"Location"})]}),e.jsx(He,{value:t.location||"",onChange:x=>t.onLocationChange(x.target.value||null),placeholder:"Where will this happen? (optional)",className:"bg-muted/30 border-border/50"})]}),!t.hideMoreInformation&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ln,{className:"w-4 h-4 text-muted-foreground"}),e.jsx(Fe,{className:"text-sm font-medium",children:"More Information"})]}),e.jsx(xt,{value:t.moreInformation||"",onChange:x=>t.onMoreInformationChange(x.target.value||null),placeholder:"Add extra context, notes, or details (optional)",className:"min-h-[100px] resize-none bg-muted/30 border-border/50",style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent"},"data-vaul-no-drag":!0})]})]})},Zc=n.forwardRef(({className:t,...s},a)=>e.jsx(ht,{ref:a,className:E("flex h-full w-full flex-col overflow-hidden rounded-md bg-popover text-popover-foreground",t),...s}));Zc.displayName=ht.displayName;const ed=n.forwardRef(({className:t,...s},a)=>e.jsxs("div",{className:"flex items-center border-b px-3","cmdk-input-wrapper":"",children:[e.jsx(fm,{className:"mr-2 h-4 w-4 shrink-0 opacity-50"}),e.jsx(ht.Input,{ref:a,className:E("flex h-11 w-full rounded-md bg-transparent py-3 text-sm outline-none placeholder:text-muted-foreground disabled:cursor-not-allowed disabled:opacity-50",t),...s})]}));ed.displayName=ht.Input.displayName;const td=n.forwardRef(({className:t,...s},a)=>e.jsx(ht.List,{ref:a,className:E("max-h-[300px] overflow-y-auto overflow-x-hidden",t),...s}));td.displayName=ht.List.displayName;const sd=n.forwardRef((t,s)=>e.jsx(ht.Empty,{ref:s,className:"py-6 text-center text-sm",...t}));sd.displayName=ht.Empty.displayName;const ad=n.forwardRef(({className:t,...s},a)=>e.jsx(ht.Group,{ref:a,className:E("overflow-hidden p-1 text-foreground [&_[cmdk-group-heading]]:px-2 [&_[cmdk-group-heading]]:py-1.5 [&_[cmdk-group-heading]]:text-xs [&_[cmdk-group-heading]]:font-medium [&_[cmdk-group-heading]]:text-muted-foreground",t),...s}));ad.displayName=ht.Group.displayName;const y0=n.forwardRef(({className:t,...s},a)=>e.jsx(ht.Separator,{ref:a,className:E("-mx-1 h-px bg-border",t),...s}));y0.displayName=ht.Separator.displayName;const rd=n.forwardRef(({className:t,...s},a)=>e.jsx(ht.Item,{ref:a,className:E("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[disabled=true]:pointer-events-none data-[selected='true']:bg-accent data-[selected=true]:text-accent-foreground data-[disabled=true]:opacity-50",t),...s}));rd.displayName=ht.Item.displayName;const gt={contacts:{all:["contacts"],byUser:t=>["contacts",t],detail:t=>["contacts","detail",t]},contactInteractions:{all:["contact-interactions"],byContact:t=>["contact-interactions",t]},contactReminders:{all:["contact-reminders"],byContact:t=>["contact-reminders",t],upcoming:()=>["contact-reminders","upcoming"]}};function b0(){const{user:t}=ce(),s=Se(),a=ye({queryKey:gt.contacts.byUser(t?.id??""),queryFn:async()=>{const{data:l,error:u}=await N.from("contacts").select("*").eq("user_id",t.id).order("name",{ascending:!0});if(u)throw u;return l},enabled:!!t}),r=ie({mutationFn:async l=>{const{data:u,error:m}=await N.from("contacts").insert({...l,user_id:t.id}).select().single();if(m)throw m;return u},onSuccess:()=>{s.invalidateQueries({queryKey:gt.contacts.all}),X.success("Contact created")},onError:l=>{X.error("Failed to create contact"),console.error(l)}}),i=ie({mutationFn:async({id:l,...u})=>{const{data:m,error:p}=await N.from("contacts").update(u).eq("id",l).select().single();if(p)throw p;return m},onSuccess:()=>{s.invalidateQueries({queryKey:gt.contacts.all}),X.success("Contact updated")},onError:l=>{X.error("Failed to update contact"),console.error(l)}}),o=ie({mutationFn:async l=>{const{error:u}=await N.from("contacts").delete().eq("id",l);if(u)throw u},onSuccess:()=>{s.invalidateQueries({queryKey:gt.contacts.all}),X.success("Contact deleted")},onError:l=>{X.error("Failed to delete contact"),console.error(l)}}),c=ie({mutationFn:async({id:l,is_favorite:u})=>{const{error:m}=await N.from("contacts").update({is_favorite:u}).eq("id",l);if(m)throw m},onMutate:async({id:l,is_favorite:u})=>{await s.cancelQueries({queryKey:gt.contacts.byUser(t?.id??"")});const m=s.getQueryData(gt.contacts.byUser(t?.id??""));return s.setQueryData(gt.contacts.byUser(t?.id??""),p=>p?.map(h=>h.id===l?{...h,is_favorite:u}:h)),{previous:m}},onError:(l,u,m)=>{s.setQueryData(gt.contacts.byUser(t?.id??""),m?.previous),X.error("Failed to update favorite")},onSettled:()=>{s.invalidateQueries({queryKey:gt.contacts.all})}});return{contacts:a.data??[],isLoading:a.isLoading,createContact:r,updateContact:i,deleteContact:o,toggleFavorite:c}}function v0({value:t,onChange:s,placeholder:a="Link to contact...",disabled:r=!1}){const[i,o]=n.useState(!1),{contacts:c,isLoading:l}=b0(),u=n.useMemo(()=>!t||!c?null:c.find(p=>p.id===t)||null,[t,c]),m=p=>p.split(" ").map(h=>h[0]).join("").toUpperCase().slice(0,2);return e.jsxs(Wt,{open:i,onOpenChange:o,children:[e.jsx(Qt,{asChild:!0,children:e.jsxs(B,{variant:"outline",role:"combobox","aria-expanded":i,className:E("w-full justify-between bg-background/50",!u&&"text-muted-foreground"),disabled:r||l,children:[u?e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(qs,{className:"h-5 w-5",children:[e.jsx(Ls,{src:u.avatar_url||void 0}),e.jsx(Fs,{className:"text-[10px]",children:m(u.name)})]}),e.jsx("span",{className:"truncate",children:u.name})]}):e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Ro,{className:"h-4 w-4"}),e.jsx("span",{children:a})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[u&&e.jsx(Qe,{className:"h-4 w-4 opacity-50 hover:opacity-100",onClick:p=>{p.stopPropagation(),s(null)}}),e.jsx(gm,{className:"h-4 w-4 shrink-0 opacity-50"})]})]})}),e.jsx(qt,{className:"w-[300px] p-0",align:"start",children:e.jsxs(Zc,{children:[e.jsx(ed,{placeholder:"Search contacts..."}),e.jsxs(td,{children:[e.jsx(sd,{children:"No contacts found."}),e.jsx(ad,{children:c?.map(p=>e.jsxs(rd,{value:p.name,onSelect:()=>{s(p.id===t?null:p.id),o(!1)},children:[e.jsxs("div",{className:"flex items-center gap-2 flex-1",children:[e.jsxs(qs,{className:"h-6 w-6",children:[e.jsx(Ls,{src:p.avatar_url||void 0}),e.jsx(Fs,{className:"text-[10px]",children:m(p.name)})]}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm",children:p.name}),p.company&&e.jsx("span",{className:"text-xs text-muted-foreground",children:p.company})]})]}),e.jsx(Xe,{className:E("ml-auto h-4 w-4",t===p.id?"opacity-100":"opacity-0")})]},p.id))})]})]})})]})}function Xs({className:t,classNames:s,showOutsideDays:a=!0,...r}){return e.jsx(xm,{showOutsideDays:a,className:E("p-3",t),classNames:{months:"flex flex-col sm:flex-row space-y-4 sm:space-x-4 sm:space-y-0",month:"space-y-4",caption:"flex justify-center pt-1 relative items-center",caption_label:"text-sm font-medium hidden",caption_dropdowns:"flex gap-2 items-center",dropdown:"appearance-none bg-transparent border border-white/20 rounded-lg px-3 py-1.5 text-sm font-medium text-white cursor-pointer hover:border-white/40 hover:bg-white/5 focus:outline-none focus:ring-2 focus:ring-white/30 transition-all",dropdown_month:"",dropdown_year:"",dropdown_icon:"hidden",vhidden:"hidden",nav:"space-x-1 flex items-center",nav_button:E(xa({variant:"outline"}),"h-7 w-7 bg-transparent p-0 opacity-50 hover:opacity-100"),nav_button_previous:"absolute left-1",nav_button_next:"absolute right-1",table:"w-full border-collapse space-y-1",head_row:"flex",head_cell:"text-white/70 rounded-md w-9 font-normal text-[0.8rem]",row:"flex w-full mt-2",cell:"h-9 w-9 text-center text-sm p-0 relative [&:has([aria-selected].day-range-end)]:rounded-r-md [&:has([aria-selected].day-outside)]:bg-accent/50 [&:has([aria-selected])]:bg-accent first:[&:has([aria-selected])]:rounded-l-md last:[&:has([aria-selected])]:rounded-r-md focus-within:relative focus-within:z-20",day:E(xa({variant:"ghost"}),"h-9 w-9 p-0 font-normal aria-selected:opacity-100 text-white hover:bg-white/10 hover:text-white"),day_range_end:"day-range-end",day_selected:"bg-primary text-primary-foreground hover:bg-primary hover:text-primary-foreground focus:bg-primary focus:text-primary-foreground",day_today:"bg-accent text-accent-foreground",day_outside:"day-outside text-white/30 opacity-50 aria-selected:bg-accent/50 aria-selected:text-muted-foreground aria-selected:opacity-30",day_disabled:"text-white/30 opacity-50",day_range_middle:"aria-selected:bg-accent aria-selected:text-accent-foreground",day_hidden:"invisible",...s},components:{IconLeft:({...i})=>e.jsx(ys,{className:"h-4 w-4"}),IconRight:({...i})=>e.jsx(tt,{className:"h-4 w-4"})},...r})}Xs.displayName="Calendar";const Dn=ym,nd=bm,xr=n.forwardRef(({className:t,children:s,...a},r)=>e.jsx(Zo,{ref:r,className:E("overflow-hidden","data-[state=open]:animate-collapsible-down","data-[state=closed]:animate-collapsible-up",t),...a,children:s}));xr.displayName=Zo.displayName;const Pn=jo,w0=wo,id=n.forwardRef(({className:t,...s},a)=>e.jsx(tr,{className:E("fixed inset-0 z-50 bg-black/58 backdrop-blur-[2px] data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0",t),...s,ref:a}));id.displayName=tr.displayName;const j0=Hs("fixed z-50 gap-4 border-border/70 bg-card/95 p-6 shadow-[0_20px_40px_rgba(0,0,0,0.34)] backdrop-blur-xl transition ease-in-out data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:duration-200 data-[state=open]:duration-300",{variants:{side:{top:"inset-x-0 top-0 border-b data-[state=closed]:slide-out-to-top data-[state=open]:slide-in-from-top",bottom:"inset-x-0 bottom-0 border-t data-[state=closed]:slide-out-to-bottom data-[state=open]:slide-in-from-bottom",left:"inset-y-0 left-0 h-full w-3/4 border-r data-[state=closed]:slide-out-to-left data-[state=open]:slide-in-from-left sm:max-w-sm",right:"inset-y-0 right-0 h-full w-3/4  border-l data-[state=closed]:slide-out-to-right data-[state=open]:slide-in-from-right sm:max-w-sm"}},defaultVariants:{side:"right"}}),yr=n.forwardRef(({side:t="right",className:s,children:a,...r},i)=>e.jsxs(w0,{children:[e.jsx(id,{}),e.jsx(sr,{ref:i,className:E(j0({side:t}),s),...r,children:a})]}));yr.displayName=sr.displayName;const od=({className:t,...s})=>e.jsx("div",{className:E("flex flex-col space-y-2 text-center sm:text-left",t),...s});od.displayName="SheetHeader";const ld=({className:t,...s})=>e.jsx("div",{className:E("flex flex-col-reverse sm:flex-row sm:justify-end sm:space-x-2",t),...s});ld.displayName="SheetFooter";const cd=n.forwardRef(({className:t,...s},a)=>e.jsx(ar,{ref:a,className:E("text-lg font-semibold text-foreground",t),...s}));cd.displayName=ar.displayName;const _0=n.forwardRef(({className:t,...s},a)=>e.jsx(rr,{ref:a,className:E("text-sm text-muted-foreground",t),...s}));_0.displayName=rr.displayName;const dd={easy:{bg:"bg-emerald-600",text:"text-emerald-400",pill:"bg-emerald-500",border:"border-emerald-500/40"},medium:{bg:"bg-amber-500",text:"text-amber-400",pill:"bg-amber-500",border:"border-amber-500/40"},hard:{bg:"bg-violet-500",text:"text-violet-400",pill:"bg-violet-500",border:"border-violet-500/40"}},N0={easy:Be,medium:pt,hard:wa};function cs(t){const[s,a]=t.split(":").map(Number),r=s>=12?"PM":"AM";return`${s%12||12}:${String(a).padStart(2,"0")} ${r}`}function k0(){const t=[];for(let s=6;s<24;s++)for(let a=0;a<60;a+=15)t.push(`${String(s).padStart(2,"0")}:${String(a).padStart(2,"0")}`);return t}const As=k0(),Xa=[{label:"1m",value:1},{label:"15m",value:15},{label:"30m",value:30},{label:"45m",value:45},{label:"1h",value:60},{label:"1.5h",value:90},{label:"All Day",value:1440},{label:"Custom",value:-1}],C0=({difficulty:t})=>{const s=N0[t];return e.jsx(s,{className:"h-5 w-5"})},ud=n.memo(function({open:s,onOpenChange:a,selectedDate:r,prefilledTime:i,onAdd:o,isAdding:c=!1,onCreateCampaign:l}){const[u,m]=n.useState(1),[p,h]=n.useState(""),[f,d]=n.useState("medium"),[g,y]=n.useState(!1),[v,b]=n.useState(i??null),[x,j]=n.useState(30),[w,D]=n.useState(null),[S,M]=n.useState([]),[C,R]=n.useState(!1),[T,q]=n.useState(15),[k,P]=n.useState(null),[A,L]=n.useState(null),[H,I]=n.useState(null),[te,V]=n.useState(!0),[z,W]=n.useState(Y(r,"yyyy-MM-dd")),[Q,U]=n.useState(!1),[$,J]=n.useState(!1),[O,le]=n.useState([]),[G,Z]=n.useState(""),he=n.useRef(null),ve=n.useRef(null),we=n.useRef(null),je=n.useRef([]);n.useEffect(()=>{i&&b(i)},[i]),n.useEffect(()=>{s?W(Y(r,"yyyy-MM-dd")):(m(1),h(""),d("medium"),y(!1),b(null),j(30),D(null),M([]),R(!1),q(15),P(null),L(null),I(null),V(!0),U(!1),J(!1),le([]))},[s,r]),n.useEffect(()=>{s&&setTimeout(()=>he.current?.focus(),300)},[s]),n.useEffect(()=>{$&&we.current&&setTimeout(()=>{we.current?.scrollIntoView({block:"center",behavior:"smooth"})},150)},[$,v]);const ke=n.useMemo(()=>{if(!v||!x)return null;const re=xl(v,"HH:mm",new Date);return Y(yl(re,x),"HH:mm")},[v,x]),Ae=x!==null&&!Xa.some(re=>re.value===x),Re=n.useMemo(()=>x?x===1440?"All Day":x>=60?`${x/60}h`:`${x} min`:"No duration",[x]),Ge=n.useMemo(()=>{const re=Re;if(z){const _e=new Date(z+"T00:00:00");return fn(_e)?`${re} - Today`:`${re} - ${Y(_e,"EEE, MMM d")}`}return`${re} - Inbox`},[Re,z]),ge=dd[f],Te=z?new Date(z+"T00:00:00"):r,Le=!!z&&!!v,F=!!p.trim()&&Le,de=n.useCallback((re,_e)=>{le(oe=>{const Ee=[...oe];return Ee[re]=_e,Ee})},[]),ae=n.useCallback((re,_e)=>{_e.key==="Enter"&&O[re]?.trim()&&(_e.preventDefault(),le(oe=>{const Ee=[...oe];return Ee.splice(re+1,0,""),Ee}),setTimeout(()=>je.current[re+1]?.focus(),50)),_e.key==="Backspace"&&!O[re]&&O.length>0&&(_e.preventDefault(),le(oe=>oe.filter((Ee,Ue)=>Ue!==re)),setTimeout(()=>je.current[Math.max(0,re-1)]?.focus(),50))},[O]),K=n.useCallback(re=>{le(_e=>_e.filter((oe,Ee)=>Ee!==re))},[]),fe=n.useCallback(()=>{le(re=>[...re,""]),setTimeout(()=>je.current[O.length]?.focus(),50)},[O.length]),Ce=n.useCallback(async()=>{p.trim()&&(await o({text:p,taskDate:z,difficulty:f,scheduledTime:v,estimatedDuration:x,recurrencePattern:w,recurrenceDays:S,reminderEnabled:C,reminderMinutesBefore:T,moreInformation:k,location:A,contactId:H,autoLogInteraction:te,sendToInbox:!1,subtasks:O.filter(re=>re.trim())}),a(!1))},[p,z,f,v,x,w,S,C,T,k,A,H,te,O,o,a]),De=n.useCallback(async()=>{p.trim()&&(await o({text:p,taskDate:null,difficulty:f,scheduledTime:null,estimatedDuration:x,recurrencePattern:w,recurrenceDays:S,reminderEnabled:C,reminderMinutesBefore:T,moreInformation:k,location:A,contactId:H,autoLogInteraction:te,sendToInbox:!0,subtasks:O.filter(re=>re.trim())}),a(!1))},[p,f,x,w,S,C,T,k,A,H,te,O,o,a]);return e.jsx(Pn,{open:s,onOpenChange:a,children:e.jsx(yr,{side:"bottom",className:"h-[92vh] rounded-t-2xl flex flex-col p-0 gap-0 overflow-hidden",children:u===1?e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:E("relative px-5 pt-4 pb-5 flex-shrink-0",ge.bg),children:[e.jsx("button",{onClick:()=>a(!1),className:"absolute top-3 right-3 p-1.5 rounded-full bg-black/20 hover:bg-black/30 transition-colors text-white z-10","aria-label":"Close",children:e.jsx(Qe,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex flex-col items-center text-center pt-2 text-white",children:[e.jsx(C0,{difficulty:f}),e.jsx("p",{className:"text-sm opacity-80 mt-1.5",children:"New Quest"}),e.jsx(He,{ref:he,placeholder:"Quest Title",value:p,onChange:re=>h(re.target.value),onKeyDown:re=>{re.key==="Enter"&&p.trim()&&(re.preventDefault(),m(2))},disabled:c,className:"mt-2 text-center text-lg font-bold bg-white/10 border-white/20 text-white placeholder:text-white/50 focus-visible:ring-white/30 h-11"})]}),e.jsx("div",{className:"flex justify-center gap-3 mt-3",children:[{value:"easy",icon:Be,label:"Easy"},{value:"medium",icon:pt,label:"Medium"},{value:"hard",icon:wa,label:"Hard"}].map(({value:re,icon:_e,label:oe})=>e.jsxs("button",{onClick:()=>d(re),className:E("w-14 h-12 rounded-xl flex flex-col items-center justify-center gap-0.5 transition-all border-2",f===re?"bg-white/30 border-white scale-110":"bg-white/10 border-transparent hover:bg-white/20"),children:[e.jsx(_e,{className:"h-4 w-4 text-white"}),e.jsx("span",{className:"text-[10px] font-medium text-white/80 leading-none",children:oe})]},re))})]}),e.jsx("div",{className:"flex-1"}),e.jsx("div",{className:"px-5 pt-4 pb-6 flex-shrink-0 flex flex-col gap-3 border-t border-border/50",children:e.jsx(B,{onClick:()=>m(2),disabled:!p.trim(),className:E("w-full text-white",p.trim()?E(ge.pill,"hover:opacity-90"):""),children:"Next"})})]}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:E("relative px-5 pt-3 pb-3 flex-shrink-0 flex items-center gap-3",ge.bg),children:[e.jsx("button",{onClick:()=>m(1),className:"p-1.5 rounded-full bg-black/20 hover:bg-black/30 transition-colors text-white","aria-label":"Back",children:e.jsx(el,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-white font-bold text-base truncate",children:p}),e.jsx("p",{className:"text-white/70 text-xs",children:Ge})]}),e.jsx("button",{onClick:()=>a(!1),className:"p-1.5 rounded-full bg-black/20 hover:bg-black/30 transition-colors text-white","aria-label":"Close",children:e.jsx(Qe,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4 space-y-3",children:[e.jsxs("button",{onClick:()=>U(!Q),className:"w-full flex items-center justify-between bg-card rounded-xl px-4 py-3 border border-border/50 hover:bg-muted/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2.5 text-sm font-medium",children:[e.jsx(lt,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:Re})]}),e.jsx(tt,{className:E("h-4 w-4 text-muted-foreground transition-transform",Q&&"rotate-90")})]}),Q&&e.jsxs("div",{className:"space-y-2 px-1",children:[e.jsx("div",{className:"flex gap-2 flex-wrap",children:Xa.map(re=>{const _e=re.value===-1?Ae:x===re.value;return e.jsx("button",{onClick:()=>{re.value===-1?(Z(""),j(null)):(Z(""),j(re.value))},className:E("px-4 py-2 rounded-lg text-sm font-bold transition-all duration-150",_e?E(ge.pill,"text-white shadow-md"):"bg-muted/50 text-muted-foreground hover:bg-muted"),children:re.label},re.value)})}),(Ae||x===null&&G!==void 0)&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(He,{type:"number",inputMode:"numeric",placeholder:"Minutes",value:G,onChange:re=>{const _e=re.target.value;Z(_e);const oe=parseInt(_e,10);!isNaN(oe)&&oe>0?j(oe):j(null)},className:"w-28 h-9 text-sm",autoFocus:!0}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"min"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Wt,{children:[e.jsx(Qt,{asChild:!0,children:e.jsxs("button",{className:E("flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border text-sm font-medium transition-colors",z?"bg-card border-border/50 text-foreground":"bg-muted/30 border-dashed border-border/50 text-muted-foreground"),children:[e.jsx(mt,{className:"h-4 w-4"}),z?Y(Te,"MMM d"):"Date"]})}),e.jsx(qt,{className:"w-auto p-0 z-[100]",align:"start",children:e.jsx(Xs,{mode:"single",selected:Te,onSelect:re=>W(re?Y(re,"yyyy-MM-dd"):null),className:"pointer-events-auto"})})]}),e.jsxs("button",{onClick:()=>{if(!v){const re=new Date,_e=Math.ceil(re.getMinutes()/15)*15,oe=new Date(re);oe.setMinutes(_e,0,0),_e>=60&&oe.setHours(oe.getHours()+1,0,0,0),b(Y(oe,"HH:mm"))}J(!$)},className:E("flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border text-sm font-medium transition-colors",v?"bg-card border-border/50 text-foreground":"bg-muted/30 border-dashed border-border/50 text-muted-foreground"),children:[e.jsx(lt,{className:"h-4 w-4"}),v?cs(v):"Time"]})]}),$&&e.jsxs("div",{ref:ve,className:"relative h-[180px] overflow-y-auto rounded-xl bg-card border border-border/50 snap-y snap-mandatory scrollbar-none",style:{scrollbarWidth:"none"},children:[e.jsx("div",{className:"sticky top-0 h-12 bg-gradient-to-b from-card to-transparent z-10 pointer-events-none"}),e.jsx("div",{className:"flex flex-col items-center py-1",children:As.map(re=>{const _e=v===re,oe=v?As.indexOf(v):-1,Ee=As.indexOf(re),Ue=oe>=0?Math.abs(Ee-oe):0,ft=_e?1:Math.max(.25,1-Ue*.15);return e.jsx("button",{ref:_e?we:void 0,onClick:()=>b(re),className:E("w-[85%] py-2.5 rounded-xl text-center text-sm font-semibold snap-center transition-all duration-150 my-0.5",_e?E(ge.pill,"text-white shadow-lg scale-[1.02]"):"text-foreground hover:bg-muted/50"),style:{opacity:_e?1:ft},children:_e&&ke?`${cs(re)} â€“ ${cs(ke)}`:cs(re)},re)})}),e.jsx("div",{className:"sticky bottom-0 h-12 bg-gradient-to-t from-card to-transparent z-10 pointer-events-none"})]}),e.jsxs("div",{className:"bg-card rounded-xl border border-border/50 overflow-hidden",children:[O.map((re,_e)=>e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b border-border/30 group",children:[e.jsx(Bs,{disabled:!0,className:"h-4 w-4 opacity-50"}),e.jsx("input",{ref:oe=>{je.current[_e]=oe},value:re,onChange:oe=>de(_e,oe.target.value),onKeyDown:oe=>ae(_e,oe),placeholder:"Subtask",className:"flex-1 bg-transparent text-sm outline-none placeholder:text-muted-foreground/50"}),e.jsx("button",{onClick:()=>K(_e),className:"p-1 rounded opacity-0 group-hover:opacity-100 hover:bg-destructive/10 text-muted-foreground hover:text-destructive transition-all",children:e.jsx(es,{className:"h-3.5 w-3.5"})})]},_e)),e.jsxs("button",{onClick:fe,className:"flex items-center gap-2 px-3 py-2.5 w-full text-left hover:bg-muted/30 transition-colors border-b border-border/30",children:[e.jsx(Bs,{disabled:!0,className:"h-4 w-4 opacity-30"}),e.jsx("span",{className:"text-sm text-muted-foreground/60",children:"Add Subtask"})]}),e.jsx(xt,{value:k||"",onChange:re=>P(re.target.value||null),placeholder:"Add notes, meeting links or phone numbers...",className:"min-h-[70px] border-0 rounded-none bg-transparent resize-none focus-visible:ring-0 focus-visible:ring-offset-0 text-sm",style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent"},"data-vaul-no-drag":!0})]}),e.jsxs(Dn,{open:g,onOpenChange:y,children:[e.jsx(nd,{asChild:!0,children:e.jsxs(B,{variant:"ghost",size:"sm",className:"w-full justify-between text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(tl,{className:"w-4 h-4"}),"Advanced Settings"]}),e.jsx("span",{className:"text-xs",children:g?"â–²":"â–¼"})]})}),e.jsx(xr,{children:e.jsxs("div",{className:"mt-3 space-y-4",children:[e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium text-muted-foreground",children:[e.jsx(sl,{className:"w-4 h-4"}),e.jsx("span",{children:"Link to Contact"})]}),e.jsx(v0,{value:H,onChange:I,placeholder:"Select a contact..."}),H&&e.jsxs("div",{className:"flex items-center justify-between py-2 px-3 bg-muted/30 rounded-lg",children:[e.jsx(Fe,{htmlFor:"auto-log-add",className:"text-sm cursor-pointer",children:"Log as interaction when completed"}),e.jsx(En,{id:"auto-log-add",checked:te,onCheckedChange:V})]})]}),e.jsx(Mn,{scheduledTime:v,estimatedDuration:x,recurrencePattern:w,recurrenceDays:S,reminderEnabled:C,reminderMinutesBefore:T,onScheduledTimeChange:b,onEstimatedDurationChange:j,onRecurrencePatternChange:D,onRecurrenceDaysChange:M,onReminderEnabledChange:R,onReminderMinutesBeforeChange:q,moreInformation:k,onMoreInformationChange:P,location:A,onLocationChange:L,selectedDate:r,taskDifficulty:f,hideScheduledTime:!0,hideDuration:!0,hideMoreInformation:!0})]})})]})]})}),e.jsxs("div",{className:"px-5 pt-4 pb-6 flex-shrink-0 flex flex-col gap-3 border-t border-border/50",children:[e.jsx(B,{onClick:Ce,disabled:c||!F,className:E("w-full text-white",F?E(ge.pill,"hover:opacity-90"):""),children:c?"Creating...":"Create Quest"}),e.jsxs(B,{variant:"outline",onClick:De,disabled:c||!p.trim(),className:"w-full",children:[e.jsx(dn,{className:"mr-2 h-4 w-4"}),"Add to Inbox instead"]}),l&&e.jsxs("button",{onClick:()=>{a(!1),l()},className:"text-xs text-muted-foreground hover:text-foreground transition-colors flex items-center justify-center gap-1.5 py-1",children:[e.jsx(oa,{className:"w-3.5 h-3.5"}),"Or create a Campaign"]})]})]})})})});function S0({imageUrl:t,onRemove:s,size:a="md",className:r,removable:i=!0}){const[o,c]=n.useState(!0),[l,u]=n.useState(!1),[m,p]=n.useState(!1),h={sm:"w-10 h-10",md:"w-12 h-12",lg:"w-16 h-16"};return m?null:e.jsxs(e.Fragment,{children:[e.jsxs(_.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},exit:{opacity:0,scale:.8},className:E("relative group rounded-lg overflow-hidden border border-border bg-muted/50",h[a],r),children:[e.jsx(be,{children:o&&e.jsx(_.div,{initial:{opacity:1},exit:{opacity:0},className:"absolute inset-0 flex items-center justify-center bg-muted",children:e.jsx(ze,{className:"w-4 h-4 animate-spin text-muted-foreground"})})}),e.jsx("img",{src:t,alt:"Quest attachment",className:E("w-full h-full object-cover cursor-pointer transition-transform group-hover:scale-105",o&&"opacity-0"),onLoad:()=>c(!1),onError:()=>{c(!1),p(!0)},onClick:()=>u(!0)}),e.jsxs("div",{className:"absolute inset-0 bg-black/40 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-1",children:[e.jsx(B,{type:"button",variant:"ghost",size:"icon",onClick:()=>u(!0),className:"h-6 w-6 text-white hover:text-white hover:bg-white/20",children:e.jsx(vm,{className:"h-3 w-3"})}),i&&s&&e.jsx(B,{type:"button",variant:"ghost",size:"icon",onClick:f=>{f.stopPropagation(),s()},className:"h-6 w-6 text-white hover:text-destructive hover:bg-white/20",children:e.jsx(Qe,{className:"h-3 w-3"})})]}),i&&s&&e.jsx("button",{type:"button",onClick:f=>{f.stopPropagation(),s()},className:"absolute -top-1 -right-1 w-4 h-4 rounded-full bg-destructive text-destructive-foreground flex items-center justify-center shadow-sm md:hidden",children:e.jsx(Qe,{className:"h-2.5 w-2.5"})})]}),e.jsx(ct,{open:l,onOpenChange:u,children:e.jsxs(ot,{className:"max-w-3xl p-2 bg-background/95 backdrop-blur-sm",children:[e.jsx(St,{className:"sr-only",children:"Quest Image"}),e.jsx("div",{className:"relative",children:e.jsx("img",{src:t,alt:"Quest attachment full size",className:"w-full h-auto max-h-[80vh] object-contain rounded-lg"})})]})})]})}function md(){const{user:t}=ce(),[s,a]=n.useState(!1),[r,i]=n.useState(null),o=n.useCallback(async(u,m)=>{if(!t?.id)return i("User not authenticated"),null;a(!0),i(null);try{const p=Date.now(),h=m?.split(".").pop()||"jpg",f=`${t.id}/${p}_quest.${h}`,{error:d}=await N.storage.from("quest-attachments").upload(f,u,{contentType:u.type||"image/jpeg",upsert:!1});if(d)throw d;const{data:{publicUrl:g}}=N.storage.from("quest-attachments").getPublicUrl(f);return g}catch(p){const h=p instanceof Error?p.message:"Failed to upload image";return i(h),X.error(h),null}finally{a(!1)}},[t?.id]),c=n.useCallback(async()=>{if(!t?.id)return i("User not authenticated"),null;i(null);try{if(Ke.isNativePlatform()){const{Camera:u,CameraResultType:m,CameraSource:p}=await me(async()=>{const{Camera:v,CameraResultType:b,CameraSource:x}=await import("./vendor-CkzXtEGd.js").then(j=>j.ec);return{Camera:v,CameraResultType:b,CameraSource:x}},__vite__mapDeps([1,2,3])),h=await u.getPhoto({quality:80,allowEditing:!1,resultType:m.Base64,source:p.Prompt,width:1200,height:1200});if(!h.base64String)return null;const f=atob(h.base64String),d=new Array(f.length);for(let v=0;v<f.length;v++)d[v]=f.charCodeAt(v);const g=new Uint8Array(d),y=new Blob([g],{type:`image/${h.format||"jpeg"}`});return await o(y,`photo.${h.format||"jpg"}`)}else return new Promise(u=>{const m=document.createElement("input");m.type="file",m.accept="image/*",m.capture="environment",m.onchange=async p=>{const h=p.target.files?.[0];if(!h){u(null);return}const f=await o(h,h.name);u(f)},m.oncancel=()=>u(null),m.click()})}catch(u){if(u instanceof Error&&u.message.includes("cancelled"))return null;const m=u instanceof Error?u.message:"Failed to pick image";return i(m),X.error(m),null}},[t?.id,o]),l=n.useCallback(async u=>{if(!t?.id)return i("User not authenticated"),!1;try{const p=new URL(u).pathname.split("/"),h=p.findIndex(g=>g==="quest-attachments");if(h===-1)return!1;const f=p.slice(h+1).join("/"),{error:d}=await N.storage.from("quest-attachments").remove([f]);if(d)throw d;return!0}catch(m){const p=m instanceof Error?m.message:"Failed to delete image";return i(p),console.error("Delete image error:",m),!1}},[t?.id]);return{pickImage:c,uploadImage:o,deleteImage:l,isUploading:s,error:r}}function Hi({onImageSelected:t,className:s,variant:a="icon",disabled:r=!1}){const{pickImage:i,isUploading:o}=md(),{tap:c}=Tn(),l=async()=>{if(o||r)return;c();const u=await i();u&&t(u)};return a==="button"?e.jsxs(B,{type:"button",variant:"outline",size:"sm",onClick:l,disabled:o||r,className:E("gap-2",s),children:[o?e.jsx(ze,{className:"h-4 w-4 animate-spin"}):e.jsx($n,{className:"h-4 w-4"}),o?"Uploading...":"Add Photo"]}):e.jsx(B,{type:"button",variant:"ghost",size:"icon",onClick:l,disabled:o||r,className:E("h-5 w-5 rounded-full",o&&"animate-pulse",s),children:o?e.jsx(ze,{className:"h-3 w-3 animate-spin"}):e.jsx($n,{className:"h-3 w-3 text-muted-foreground"})})}const T0=t=>{const{user:s}=ce(),a=Se(),{data:r=[],isLoading:i}=ye({queryKey:["subtasks",t],queryFn:async()=>{if(!s?.id||!t)return[];const{data:d,error:g}=await N.from("subtasks").select("*").eq("task_id",t).eq("user_id",s.id).order("sort_order",{ascending:!0});if(g)throw g;return d},enabled:!!s?.id&&!!t}),o=ie({mutationFn:async d=>{if(!s?.id||!t)throw new Error("Missing required data");const g=r.length>0?Math.max(...r.map(b=>b.sort_order))+1:0,{data:y,error:v}=await N.from("subtasks").insert({task_id:t,user_id:s.id,title:d,sort_order:g}).select().single();if(v)throw v;return y},onSuccess:()=>{a.invalidateQueries({queryKey:["subtasks",t]})},onError:()=>{X.error("Failed to add subtask")}}),c=ie({mutationFn:async({subtaskId:d,completed:g})=>{const{error:y}=await N.from("subtasks").update({completed:g,completed_at:g?new Date().toISOString():null}).eq("id",d);if(y)throw y},onSuccess:()=>{a.invalidateQueries({queryKey:["subtasks",t]})}}),l=ie({mutationFn:async d=>{const{error:g}=await N.from("subtasks").delete().eq("id",d);if(g)throw g},onSuccess:()=>{a.invalidateQueries({queryKey:["subtasks",t]})}}),u=ie({mutationFn:async({subtaskId:d,title:g})=>{const{error:y}=await N.from("subtasks").update({title:g}).eq("id",d);if(y)throw y},onSuccess:()=>{a.invalidateQueries({queryKey:["subtasks",t]})},onError:()=>{X.error("Failed to update subtask")}}),m=ie({mutationFn:async d=>{if(!s?.id||!t)throw new Error("Missing required data");const g=r.length>0?Math.max(...r.map(b=>b.sort_order))+1:0,y=d.map((b,x)=>({task_id:t,user_id:s.id,title:b,sort_order:g+x})),{error:v}=await N.from("subtasks").insert(y);if(v)throw v},onSuccess:()=>{a.invalidateQueries({queryKey:["subtasks",t]}),X.success("Subtasks added!")},onError:()=>{X.error("Failed to add subtasks")}}),p=r.filter(d=>d.completed).length,h=r.length,f=h>0?Math.round(p/h*100):0;return{subtasks:r,isLoading:i,addSubtask:o.mutate,toggleSubtask:c.mutate,deleteSubtask:l.mutate,updateSubtask:u.mutate,bulkAddSubtasks:m.mutateAsync,isAdding:o.isPending,isBulkAdding:m.isPending,completedCount:p,totalCount:h,progressPercent:f}};function pd({task:t,open:s,onOpenChange:a,onSave:r,isSaving:i,onDelete:o,isDeleting:c}){const[l,u]=n.useState(""),[m,p]=n.useState(null),[h,f]=n.useState("medium"),[d,g]=n.useState(null),[y,v]=n.useState(30),[b,x]=n.useState(null),[j,w]=n.useState([]),[D,S]=n.useState(!1),[M,C]=n.useState(15),[R,T]=n.useState(null),[q,k]=n.useState(!1),[P,A]=n.useState(!1),[L,H]=n.useState(null),[I,te]=n.useState(null),[V,z]=n.useState(!1),[W,Q]=n.useState(!1),[U,$]=n.useState(""),[J,O]=n.useState(""),le=n.useRef(null),G=n.useRef(null),{deleteImage:Z}=md(),{subtasks:he,addSubtask:ve,toggleSubtask:we,deleteSubtask:je}=T0(t?.id??null);n.useEffect(()=>{t&&s&&(u(t.task_text),p(t.task_date||null),f(t.difficulty||"medium"),g(t.scheduled_time||null),v(t.estimated_duration??30),x(t.recurrence_pattern||null),w(t.recurrence_days||[]),S(t.reminder_enabled||!1),C(t.reminder_minutes_before||15),T(t.notes||null),H(t.image_url||null),te(t.location||null),z(!1),Q(!1),k(!!t.recurrence_pattern||!!t.reminder_enabled||!!t.location))},[t,s]),n.useEffect(()=>{W&&G.current&&setTimeout(()=>{G.current?.scrollIntoView({block:"center",behavior:"smooth"})},150)},[W,d]);const ke=n.useMemo(()=>{if(!d||!y)return null;const K=xl(d,"HH:mm",new Date);return Y(yl(K,y),"HH:mm")},[d,y]),Ae=y!==null&&!Xa.some(K=>K.value===y),Re=n.useMemo(()=>y?y===1440?"All Day":y>=60?`${y/60}h`:`${y} min`:"No duration",[y]),Ge=n.useMemo(()=>{const K=Re;if(m){const fe=new Date(m+"T00:00:00");return fn(fe)?`${K} Â· Today`:`${K} Â· ${Y(fe,"EEE, MMM d")}`}return`${K} Â· Inbox`},[Re,m]),ge=dd[h],Te=m?new Date(m+"T00:00:00"):new Date,Le=n.useCallback(async()=>{!t||!l.trim()||(await r(t.id,{task_text:l.trim(),task_date:m,difficulty:h,scheduled_time:d||null,estimated_duration:y,recurrence_pattern:b,recurrence_days:j,reminder_enabled:D,reminder_minutes_before:M,notes:R,category:t.category||null,image_url:L,location:I}),a(!1))},[t,l,m,h,d,y,b,j,D,M,R,L,I,r,a]),F=async()=>{L&&(await Z(L),H(null))},de=async()=>{!t||!o||(await o(t.id),A(!1),a(!1))},ae=n.useCallback(()=>{J.trim()&&(ve(J.trim()),O(""))},[J,ve]);return e.jsxs(Pn,{open:s,onOpenChange:a,children:[e.jsxs(yr,{side:"bottom",className:"h-[92vh] rounded-t-2xl flex flex-col p-0 gap-0 overflow-hidden",children:[e.jsxs("div",{className:E("relative px-5 pt-3 pb-3 flex-shrink-0",ge.bg),children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("button",{onClick:()=>a(!1),className:"p-1.5 rounded-full bg-black/20 hover:bg-black/30 transition-colors text-white","aria-label":"Close",children:e.jsx(el,{className:"h-4 w-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx(He,{value:l,onChange:K=>u(K.target.value),className:"text-base font-bold bg-white/10 border-white/20 text-white placeholder:text-white/50 focus-visible:ring-white/30 h-9",placeholder:"Quest title"}),e.jsx("p",{className:"text-white/70 text-xs mt-1",children:Ge})]}),e.jsx("button",{onClick:()=>a(!1),className:"p-1.5 rounded-full bg-black/20 hover:bg-black/30 transition-colors text-white","aria-label":"Close",children:e.jsx(Qe,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex justify-center gap-3 mt-2",children:[{value:"easy",icon:Be,label:"Easy"},{value:"medium",icon:pt,label:"Medium"},{value:"hard",icon:wa,label:"Hard"}].map(({value:K,icon:fe,label:Ce})=>e.jsxs("button",{onClick:()=>f(K),className:E("w-14 h-12 rounded-xl flex flex-col items-center justify-center gap-0.5 transition-all border-2",h===K?"bg-white/30 border-white scale-110":"bg-white/10 border-transparent hover:bg-white/20"),children:[e.jsx(fe,{className:"h-4 w-4 text-white"}),e.jsx("span",{className:"text-[10px] font-medium text-white/80 leading-none",children:Ce})]},K))})]}),e.jsx("div",{className:"flex-1 overflow-y-auto",children:e.jsxs("div",{className:"px-4 py-4 space-y-3",children:[e.jsxs("button",{onClick:()=>z(!V),className:"w-full flex items-center justify-between bg-card rounded-xl px-4 py-3 border border-border/50 hover:bg-muted/30 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-2.5 text-sm font-medium",children:[e.jsx(lt,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("span",{children:Re})]}),e.jsx(tt,{className:E("h-4 w-4 text-muted-foreground transition-transform",V&&"rotate-90")})]}),V&&e.jsxs("div",{className:"space-y-2 px-1",children:[e.jsx("div",{className:"flex gap-2 flex-wrap",children:Xa.map(K=>{const fe=K.value===-1?Ae:y===K.value;return e.jsx("button",{onClick:()=>{K.value===-1?($(""),v(null)):($(""),v(K.value))},className:E("px-4 py-2 rounded-lg text-sm font-bold transition-all duration-150",fe?E(ge.pill,"text-white shadow-md"):"bg-muted/50 text-muted-foreground hover:bg-muted"),children:K.label},K.value)})}),(Ae||y===null&&U!==void 0)&&e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(He,{type:"number",inputMode:"numeric",placeholder:"Minutes",value:U,onChange:K=>{const fe=K.target.value;$(fe);const Ce=parseInt(fe,10);!isNaN(Ce)&&Ce>0?v(Ce):v(null)},className:"w-28 h-9 text-sm",autoFocus:!0}),e.jsx("span",{className:"text-xs text-muted-foreground",children:"min"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(Wt,{children:[e.jsx(Qt,{asChild:!0,children:e.jsxs("button",{className:E("flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border text-sm font-medium transition-colors",m?"bg-card border-border/50 text-foreground":"bg-muted/30 border-dashed border-border/50 text-muted-foreground"),children:[e.jsx(mt,{className:"h-4 w-4"}),m?Y(Te,"MMM d"):"Date"]})}),e.jsx(qt,{className:"w-auto p-0 z-[100]",align:"start",children:e.jsx(Xs,{mode:"single",selected:Te,onSelect:K=>p(K?Y(K,"yyyy-MM-dd"):null),className:"pointer-events-auto"})})]}),e.jsxs("button",{onClick:()=>{if(!d){const K=new Date,fe=Math.ceil(K.getMinutes()/15)*15,Ce=new Date(K);Ce.setMinutes(fe,0,0),fe>=60&&Ce.setHours(Ce.getHours()+1,0,0,0),g(Y(Ce,"HH:mm"))}Q(!W)},className:E("flex-1 flex items-center justify-center gap-2 py-3 rounded-xl border text-sm font-medium transition-colors",d?"bg-card border-border/50 text-foreground":"bg-muted/30 border-dashed border-border/50 text-muted-foreground"),children:[e.jsx(lt,{className:"h-4 w-4"}),d?cs(d):"Time"]})]}),W&&e.jsxs("div",{ref:le,className:"relative h-[180px] overflow-y-auto rounded-xl bg-card border border-border/50 snap-y snap-mandatory scrollbar-none",style:{scrollbarWidth:"none"},children:[e.jsx("div",{className:"sticky top-0 h-12 bg-gradient-to-b from-card to-transparent z-10 pointer-events-none"}),e.jsx("div",{className:"flex flex-col items-center py-1",children:As.map(K=>{const fe=d===K,Ce=d?As.indexOf(d):-1,De=As.indexOf(K),re=Ce>=0?Math.abs(De-Ce):0,_e=fe?1:Math.max(.25,1-re*.15);return e.jsx("button",{ref:fe?G:void 0,onClick:()=>g(K),className:E("w-[85%] py-2.5 rounded-xl text-center text-sm font-semibold snap-center transition-all duration-150 my-0.5",fe?E(ge.pill,"text-white shadow-lg scale-[1.02]"):"text-foreground hover:bg-muted/50"),style:{opacity:fe?1:_e},children:fe&&ke?`${cs(K)} â€“ ${cs(ke)}`:cs(K)},K)})}),e.jsx("div",{className:"sticky bottom-0 h-12 bg-gradient-to-t from-card to-transparent z-10 pointer-events-none"})]}),e.jsxs("div",{className:"bg-card rounded-xl border border-border/50 overflow-hidden",children:[he.map(K=>e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b border-border/30 group",children:[e.jsx(Bs,{checked:K.completed,onCheckedChange:fe=>we({subtaskId:K.id,completed:!!fe}),className:"h-4 w-4"}),e.jsx("span",{className:E("flex-1 text-sm",K.completed&&"line-through text-muted-foreground"),children:K.title}),e.jsx("button",{onClick:()=>je(K.id),className:"p-1 rounded opacity-0 group-hover:opacity-100 hover:bg-destructive/10 text-muted-foreground hover:text-destructive transition-all",children:e.jsx(es,{className:"h-3.5 w-3.5"})})]},K.id)),e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2 border-b border-border/30",children:[e.jsx(Bs,{disabled:!0,className:"h-4 w-4 opacity-30"}),e.jsx("input",{value:J,onChange:K=>O(K.target.value),onKeyDown:K=>{K.key==="Enter"&&J.trim()&&(K.preventDefault(),ae())},placeholder:"Add Subtask",className:"flex-1 bg-transparent text-sm outline-none placeholder:text-muted-foreground/60"})]}),e.jsx(xt,{value:R||"",onChange:K=>T(K.target.value||null),placeholder:"Add notes, meeting links or phone numbers...",className:"min-h-[70px] border-0 rounded-none bg-transparent resize-none focus-visible:ring-0 focus-visible:ring-offset-0 text-sm",style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent"},"data-vaul-no-drag":!0})]}),e.jsx("div",{className:"flex items-center gap-3 px-1",children:L?e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(S0,{imageUrl:L,size:"lg",onRemove:F}),e.jsx(Hi,{onImageSelected:K=>H(K),variant:"button"})]}):e.jsx(Hi,{onImageSelected:K=>H(K),variant:"button"})}),e.jsxs(Dn,{open:q,onOpenChange:k,children:[e.jsx(nd,{asChild:!0,children:e.jsxs(B,{variant:"ghost",size:"sm",className:"w-full justify-between text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-2",children:[e.jsx(tl,{className:"w-4 h-4"}),"Advanced Settings"]}),e.jsx("span",{className:"text-xs",children:q?"â–²":"â–¼"})]})}),e.jsx(xr,{children:e.jsx("div",{className:"mt-3",children:e.jsx(Mn,{scheduledTime:d,estimatedDuration:y,recurrencePattern:b,recurrenceDays:j,reminderEnabled:D,reminderMinutesBefore:M,onScheduledTimeChange:g,onEstimatedDurationChange:v,onRecurrencePatternChange:x,onRecurrenceDaysChange:w,onReminderEnabledChange:S,onReminderMinutesBeforeChange:C,moreInformation:R,onMoreInformationChange:T,location:I,onLocationChange:te,hideScheduledTime:!0,hideDuration:!0,hideMoreInformation:!0})})})]})]})}),e.jsxs("div",{className:"px-5 pt-4 pb-6 flex-shrink-0 flex flex-col gap-3 border-t border-border/50",children:[e.jsx(B,{onClick:Le,disabled:i||!l.trim(),className:E("w-full text-white",l.trim()?E(ge.pill,"hover:opacity-90"):""),children:i?"Saving...":"Save Changes"}),o&&e.jsxs(B,{variant:"ghost",onClick:()=>A(!0),disabled:c,className:"w-full text-destructive hover:text-destructive hover:bg-destructive/10",children:[e.jsx(es,{className:"w-4 h-4 mr-2"}),"Delete"]})]})]}),e.jsx(_a,{open:P,onOpenChange:A,children:e.jsxs(Ws,{children:[e.jsxs(Qs,{children:[e.jsx(Gs,{children:"Delete this quest?"}),e.jsxs(Ys,{children:['This action cannot be undone. This will permanently delete "',t?.task_text,'".']})]}),e.jsxs(Ks,{children:[e.jsx(Vs,{children:"Cancel"}),e.jsx(ws,{onClick:de,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:c?"Deleting...":"Delete"})]})]})})]})}function E0(){const t=n.useCallback(async r=>{const{data:{user:i}}=await N.auth.getUser();if(!i){console.log("[SchedulingLearner] No user - skipping completion tracking");return}console.log("[SchedulingLearner] Tracking completion for user:",i.id),console.log("[SchedulingLearner] Data:",{taskText:r.taskText?.substring(0,30),category:r.category,difficulty:r.difficulty});try{const{data:o,error:c}=await N.functions.invoke("analyze-user-patterns",{body:{type:"task_completion",data:r}});c?console.error("[SchedulingLearner] Edge function error:",c):console.log("[SchedulingLearner] Completion saved:",o)}catch(o){console.error("[SchedulingLearner] Error tracking completion:",o)}},[]),s=n.useCallback(async(r,i,o)=>{const{data:{user:c}}=await N.auth.getUser();if(c)try{const l={suggestedTime:r,actualTime:i,taskDifficulty:o};await N.functions.invoke("analyze-user-patterns",{body:{type:"schedule_modification",data:l}})}catch(l){console.error("[useSchedulingLearner] Error tracking modification:",l)}},[]),a=n.useCallback(async(r,i,o,c)=>{const{data:{user:l}}=await N.auth.getUser();if(!l){console.log("[SchedulingLearner] No user - skipping creation tracking");return}console.log("[SchedulingLearner] Tracking creation:",{taskText:c?.substring(0,30),category:o,difficulty:i});try{const u={scheduledTime:r,difficulty:i,createdAt:new Date().toISOString(),hour:new Date().getHours(),taskText:c,category:o},{data:m,error:p}=await N.functions.invoke("analyze-user-patterns",{body:{type:"task_creation",data:u}});p?console.error("[SchedulingLearner] Edge function error:",p):console.log("[SchedulingLearner] Creation saved:",m)}catch(u){console.error("[SchedulingLearner] Error tracking creation:",u)}},[]);return{trackTaskCompletion:t,trackScheduleModification:s,trackTaskCreation:a}}const M0=async(t,s)=>{if(!t)return{bonusXP:0,toastReason:"Task Complete!"};try{const{data:a,error:r}=await N.from("epic_habits").select("epic_id, epics!inner(is_public, status)").eq("epics.status","active").eq("epics.is_public",!0);if(r)return console.error("Failed to fetch epic habits:",r),{bonusXP:0,toastReason:"Task Complete!"};if(!a||a.length===0)return{bonusXP:0,toastReason:"Task Complete!"};const{data:i,error:o}=await N.from("epic_members").select("epic_id").eq("user_id",t).in("epic_id",a.map(c=>c.epic_id));if(o)return console.error("Failed to fetch memberships:",o),{bonusXP:0,toastReason:"Task Complete!"};if(i&&i.length>0){const c=Math.round(s*.1),l=s>0?Math.max(1,c):0;return{bonusXP:l,toastReason:`Task Complete! +${l} Guild Bonus (10%) ðŸŽ¯`}}}catch(a){console.error("Unexpected error computing guild bonus:",a)}return{bonusXP:0,toastReason:"Task Complete!"}},hd=["mind","body","soul"],D0={body:["gym","run","exercise","workout","walk","yoga","stretch","fitness","sports"],soul:["meditate","journal","breathe","gratitude","reflect","pray","mindful","relax","rest"],mind:["read","learn","study","plan","organize","think","write","research","course"]};function Wr(t,s){if(s&&hd.includes(s))return s;const a=t.toLowerCase();for(const[r,i]of Object.entries(D0))if(i.some(o=>a.includes(o)))return r;return null}const fd=t=>{const{user:s}=ce(),{toast:a}=Ut(),r=Se(),{companion:i}=st(),{updateDisciplineFromRitual:o}=sc(),{showXPToast:c}=Al(),{awardCustomXP:l}=bt(),{trackTaskCompletion:u,trackTaskCreation:m}=E0(),p=n.useRef(!1),h=ie({mutationFn:async w=>{if(p.current)throw new Error("Please wait...");p.current=!0;try{if(!s?.id)throw new Error("User not authenticated");const D=w.taskDate!==void 0?w.taskDate:t;let S=N.from("daily_tasks").select("id").eq("user_id",s.id);D===null?S=S.is("task_date",null):S=S.eq("task_date",D);const{data:M,error:C}=await S;if(C)throw C;const R=(M?.length||0)+1,T=li(w.difficulty,R),q=Wr(w.taskText,w.category),{data:k,error:P}=await N.from("daily_tasks").insert({user_id:s.id,task_text:w.taskText,difficulty:w.difficulty,xp_reward:T,task_date:w.taskDate!==void 0?w.taskDate:t,is_main_quest:w.isMainQuest??!1,scheduled_time:w.scheduledTime||null,estimated_duration:w.estimatedDuration||null,recurrence_pattern:w.recurrencePattern||null,recurrence_days:w.recurrenceDays||null,recurrence_end_date:w.recurrenceEndDate||null,is_recurring:!!w.recurrencePattern,reminder_enabled:w.reminderEnabled??!1,reminder_minutes_before:w.reminderMinutesBefore??15,category:q,is_bonus:!1,notes:w.notes||null,contact_id:w.contactId||null,auto_log_interaction:w.autoLogInteraction??!0,image_url:w.imageUrl||null,location:w.location||null}).select().single();if(P)throw P.message?.includes("MAX_TASKS_REACHED")||P.message?.includes("Maximum quest limit")?new Error("Maximum quest limit reached for today"):P;const A=(w.subtasks||[]).map(L=>L.trim()).filter(L=>L.length>0);if(A.length>0&&k?.id){const{error:L}=await N.from("subtasks").insert(A.map((H,I)=>({task_id:k.id,user_id:s.id,title:H,sort_order:I})));if(L)throw await N.from("daily_tasks").delete().eq("id",k.id).eq("user_id",s.id),L}return k}finally{p.current=!1}},onMutate:async w=>{await r.cancelQueries({queryKey:["daily-tasks"]}),await r.cancelQueries({queryKey:["calendar-tasks"]});const D=r.getQueriesData({queryKey:["daily-tasks"]}),S=r.getQueriesData({queryKey:["calendar-tasks"]}),M={id:`temp-${Date.now()}`,user_id:s?.id,task_text:w.taskText,difficulty:w.difficulty,task_date:w.taskDate!==void 0?w.taskDate:t,completed:!1,completed_at:null,is_main_quest:w.isMainQuest??!1,scheduled_time:w.scheduledTime||null,estimated_duration:w.estimatedDuration||null,xp_reward:li(w.difficulty,1),created_at:new Date().toISOString(),category:Wr(w.taskText,w.category),is_bonus:!1,is_recurring:!!w.recurrencePattern,recurrence_pattern:w.recurrencePattern||null,recurrence_days:w.recurrenceDays||null,reminder_enabled:w.reminderEnabled??!1,reminder_minutes_before:w.reminderMinutesBefore??15,reminder_sent:!1,parent_template_id:null,notes:w.notes||null,location:w.location||null};return M.task_date&&r.setQueryData(["daily-tasks",s?.id,M.task_date],C=>!C||!Array.isArray(C)?C:[M,...C]),{previousDailyTasks:D,previousCalendarTasks:S}},onError:(w,D,S)=>{S?.previousDailyTasks&&S.previousDailyTasks.forEach(([M,C])=>{r.setQueryData(M,C)}),S?.previousCalendarTasks&&S.previousCalendarTasks.forEach(([M,C])=>{r.setQueryData(M,C)}),a({title:"Failed to add quest",description:w.message,variant:"destructive"})},onSettled:()=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),r.invalidateQueries({queryKey:["inbox-tasks"]}),r.invalidateQueries({queryKey:["inbox-count"]})},onSuccess:w=>{a({title:"Quest added!"}),window.dispatchEvent(new CustomEvent("task-added",{detail:{taskDate:w?.task_date??null,scheduledTime:w?.scheduled_time??null}})),w&&m(w.scheduled_time,w.difficulty||"medium",w.category,w.task_text)}}),f=ie({mutationFn:async({taskId:w,completed:D,xpReward:S,forceUndo:M=!1})=>{if(!s?.id)throw new Error("User not authenticated");const{data:C,error:R}=await N.from("daily_tasks").select(`
          completed_at, task_text, habit_source_id, task_date, difficulty, scheduled_time, category,
          contact_id, auto_log_interaction,
          contact:contacts!contact_id(id, name, avatar_url)
        `).eq("id",w).eq("user_id",s.id).maybeSingle();if(R)throw R;const T=C?.completed_at!==null,q=C?.task_text||"Task",k=C?.habit_source_id,P=C?.task_date||Y(new Date,"yyyy-MM-dd");if(T&&!D&&!M)throw new Error("Cannot uncheck completed tasks");if(!D&&M){const{error:J}=await N.from("daily_tasks").update({completed:!1,completed_at:null}).eq("id",w).eq("user_id",s.id);if(J)throw J;return S>0&&await l(-S,"task_undo","Quest undone",{task_id:w}),k&&await N.from("habit_completions").delete().eq("user_id",s.id).eq("habit_id",k).eq("date",P),{taskId:w,completed:!1,xpAwarded:0,wasAlreadyCompleted:!0,isUndo:!0,taskText:q,habitSourceId:k}}if(!D){const{error:J}=await N.from("daily_tasks").update({completed:!1,completed_at:null}).eq("id",w).eq("user_id",s.id);if(J)throw J;return k&&await N.from("habit_completions").delete().eq("user_id",s.id).eq("habit_id",k).eq("date",P),{taskId:w,completed:!1,xpAwarded:0,wasAlreadyCompleted:T,isUndo:!1,taskText:q,habitSourceId:k}}const{bonusXP:A,toastReason:L}=await M0(s.id,S),H=S+A,{data:I,error:te}=await N.from("daily_tasks").update({completed:!0,completed_at:new Date().toISOString()}).eq("id",w).eq("user_id",s.id).eq("completed",!1).select();if(te)throw te;if(!I||I.length===0)throw new Error("Task was already completed");if(await l(H,"task_complete",L,{task_id:w}),k){const{error:J}=await N.from("habit_completions").upsert({user_id:s.id,habit_id:k,date:P},{onConflict:"user_id,habit_id,date"});J?console.error("[Task Toggle] Failed to sync habit completion:",J):console.log("[Task Toggle] Synced habit completion for habit:",k)}const V=C?.difficulty||"medium",z=C?.scheduled_time||null,W=C?.category||null,Q=C?.contact_id||null,U=C?.auto_log_interaction??!0,$=C?.contact;return{taskId:w,completed:!0,xpAwarded:H,bonusXP:A,toastReason:L,wasAlreadyCompleted:T,isUndo:!1,taskText:q,habitSourceId:k,taskDifficulty:V,taskScheduledTime:z,taskCategory:W,contactId:Q,autoLogInteraction:U,contact:$}},onSuccess:async({completed:w,xpAwarded:D,toastReason:S,wasAlreadyCompleted:M,isUndo:C,taskId:R,taskText:T,habitSourceId:q,taskDifficulty:k,taskScheduledTime:P,taskCategory:A})=>{if(r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),q&&(r.invalidateQueries({queryKey:["habit-completions"]}),r.invalidateQueries({queryKey:["habits"]}),r.invalidateQueries({queryKey:["habit-surfacing"]}),r.invalidateQueries({queryKey:["epics"]})),C){a({title:"Quest undone",description:"XP has been adjusted"});return}if(w&&!M){D>0&&c(D,S||"Quest Complete!"),i?.id&&o(i.id).catch(console.error),window.dispatchEvent(new CustomEvent("mission-completed")),window.dispatchEvent(new CustomEvent("quest-completed"));const L=new Date;console.log("[TaskMutations] About to track completion:",{taskId:R,taskText:T?.substring(0,50),taskDifficulty:k,taskCategory:A});try{await u({taskId:R,completedAt:L.toISOString(),difficulty:k||"medium",scheduledTime:P,actualCompletionHour:L.getHours(),dayOfWeek:L.getDay(),wasOnTime:P?Math.abs(parseInt(P.split(":")[0])-L.getHours())<=1:null,category:A||void 0,taskText:T}),console.log("[TaskMutations] trackTaskCompletion succeeded")}catch(H){console.error("[TaskMutations] trackTaskCompletion failed:",H)}a({title:"Quest completed! âœ¨",description:T.length>40?T.substring(0,40)+"...":T,duration:5e3,action:n.createElement(_l,{altText:"Undo completion",onClick:()=>{f.mutate({taskId:R,completed:!1,xpReward:D,forceUndo:!0})}},"Undo")})}},onError:w=>{const D=w.message==="Please wait..."?"Please wait for the previous action to complete":w.message.includes("Failed to fetch")||w.message.includes("Load failed")?"Network error. Please check your connection and try again.":w.message;a({title:"Failed to toggle quest",description:D,variant:"destructive"})},retry:2,retryDelay:1e3}),d=ie({mutationFn:async w=>{if(!s?.id)throw new Error("User not authenticated");if(!w)throw new Error("Invalid task ID");const{error:D}=await N.from("daily_tasks").delete().eq("id",w).eq("user_id",s.id);if(D)throw D},onSuccess:()=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]})},onError:w=>{a({title:"Failed to delete quest",description:w.message,variant:"destructive"})}}),g=ie({mutationFn:async w=>{if(!s?.id)throw new Error("User not authenticated");const{data:D,error:S}=await N.from("daily_tasks").insert({user_id:s.id,task_text:w.task_text,task_date:w.task_date,xp_reward:w.xp_reward??10,difficulty:w.difficulty??"medium",scheduled_time:w.scheduled_time,estimated_duration:w.estimated_duration,is_main_quest:w.is_main_quest??!1,epic_id:w.epic_id,sort_order:w.sort_order,notes:w.notes,priority:w.priority,energy_level:w.energy_level,category:w.category,habit_source_id:w.habit_source_id,is_recurring:w.is_recurring??!1,recurrence_pattern:w.recurrence_pattern,recurrence_days:w.recurrence_days,reminder_enabled:w.reminder_enabled??!1,reminder_minutes_before:w.reminder_minutes_before}).select().single();if(S)throw S;return D},onSuccess:()=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]})},onError:w=>{a({title:"Failed to restore quest",description:w.message,variant:"destructive"})}}),y=ie({mutationFn:async w=>{if(!s?.id)throw new Error("User not authenticated");const{data:D,error:S}=await N.from("daily_tasks").select("id, user_id, task_date").eq("id",w).eq("user_id",s.id).eq("task_date",t).maybeSingle();if(S)throw S;if(!D)throw new Error("Task not found or access denied");await N.from("daily_tasks").update({is_main_quest:!1}).eq("user_id",s.id).eq("task_date",t);const{error:M}=await N.from("daily_tasks").update({is_main_quest:!0}).eq("id",w).eq("user_id",s.id);if(M)throw M},onSuccess:()=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),a({title:"Main quest updated!"})},onError:w=>{a({title:"Failed to update main quest",description:w.message,variant:"destructive"})}}),v=ie({mutationFn:async({taskId:w,updates:D})=>{if(!s?.id)throw new Error("User not authenticated");const S={};if(D.task_text!==void 0&&(S.task_text=D.task_text),D.task_date!==void 0&&(S.task_date=D.task_date),D.difficulty!==void 0&&(S.difficulty=D.difficulty),D.scheduled_time!==void 0&&(S.scheduled_time=D.scheduled_time),D.estimated_duration!==void 0&&(S.estimated_duration=D.estimated_duration),D.recurrence_pattern!==void 0&&(S.recurrence_pattern=D.recurrence_pattern),D.recurrence_days!==void 0&&(S.recurrence_days=D.recurrence_days),D.reminder_enabled!==void 0&&(S.reminder_enabled=D.reminder_enabled),D.reminder_minutes_before!==void 0&&(S.reminder_minutes_before=D.reminder_minutes_before),D.notes!==void 0&&(S.notes=D.notes),D.category!==void 0||D.task_text!==void 0){const C=D.category&&hd.includes(D.category)?D.category:D.task_text?Wr(D.task_text,D.category||void 0):D.category;S.category=C}if(D.image_url!==void 0&&(S.image_url=D.image_url),D.location!==void 0&&(S.location=D.location),Object.keys(S).length===0)return;const{error:M}=await N.from("daily_tasks").update(S).eq("id",w).eq("user_id",s.id);if(M)throw M},onSuccess:()=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]}),a({title:"Quest updated!"})},onError:w=>{a({title:"Failed to update quest",description:w.message,variant:"destructive"})}}),b=ie({mutationFn:async w=>{if(!s?.id)throw new Error("User not authenticated");for(const D of w){const{error:S}=await N.from("daily_tasks").update({sort_order:D.sort_order}).eq("id",D.id).eq("user_id",s.id);if(S)throw S}},onMutate:async w=>{await r.cancelQueries({queryKey:["daily-tasks"]}),await r.cancelQueries({queryKey:["calendar-tasks"]});const D=r.getQueriesData({queryKey:["daily-tasks"]}),S=r.getQueriesData({queryKey:["calendar-tasks"]}),M=new Map(w.map(C=>[C.id,C.sort_order]));return r.setQueriesData({queryKey:["daily-tasks"]},C=>!C||!Array.isArray(C)?C:[...C].map(R=>({...R,sort_order:M.has(R.id)?M.get(R.id):R.sort_order})).sort((R,T)=>(R.sort_order??999)-(T.sort_order??999))),r.setQueriesData({queryKey:["calendar-tasks"]},C=>!C||!Array.isArray(C)?C:[...C].map(R=>({...R,sort_order:M.has(R.id)?M.get(R.id):R.sort_order})).sort((R,T)=>(R.sort_order??999)-(T.sort_order??999))),{previousDailyTasks:D,previousCalendarTasks:S}},onError:(w,D,S)=>{S?.previousDailyTasks&&S.previousDailyTasks.forEach(([M,C])=>{r.setQueryData(M,C)}),S?.previousCalendarTasks&&S.previousCalendarTasks.forEach(([M,C])=>{r.setQueryData(M,C)}),a({title:"Failed to reorder quests",description:w.message,variant:"destructive"})},onSettled:()=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]})}}),x=ie({mutationFn:async({taskId:w,targetSection:D})=>{if(!s?.id)throw new Error("User not authenticated");const M={morning:"09:00",afternoon:"14:00",evening:"19:00",unscheduled:null}[D],{error:C}=await N.from("daily_tasks").update({scheduled_time:M,sort_order:0}).eq("id",w).eq("user_id",s.id);if(C)throw C},onSuccess:()=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]})},onError:w=>{a({title:"Failed to move quest",description:w.message,variant:"destructive"})}}),j=ie({mutationFn:async({taskId:w,targetDate:D})=>{if(!s?.id)throw new Error("User not authenticated");const{error:S}=await N.from("daily_tasks").update({task_date:D,sort_order:0}).eq("id",w).eq("user_id",s.id);if(S)throw S;return{taskId:w,targetDate:D}},onMutate:async()=>{await r.cancelQueries({queryKey:["daily-tasks"]}),await r.cancelQueries({queryKey:["calendar-tasks"]});const w=r.getQueriesData({queryKey:["daily-tasks"]}),D=r.getQueriesData({queryKey:["calendar-tasks"]});return{previousDaily:w,previousCalendar:D}},onError:(w,D,S)=>{S?.previousDaily&&S.previousDaily.forEach(([M,C])=>r.setQueryData(M,C)),S?.previousCalendar&&S.previousCalendar.forEach(([M,C])=>r.setQueryData(M,C)),a({title:"Failed to move quest",description:w.message,variant:"destructive"})},onSettled:()=>{r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["calendar-tasks"]})}});return{addTask:h.mutateAsync,toggleTask:f.mutate,deleteTask:d.mutateAsync,restoreTask:g.mutateAsync,setMainQuest:y.mutate,updateTask:v.mutateAsync,reorderTasks:b.mutate,moveTaskToSection:x.mutate,moveTaskToDate:j.mutate,isAdding:h.isPending,isToggling:f.isPending,isDeleting:d.isPending,isRestoring:g.isPending,isUpdating:v.isPending,isReordering:b.isPending,isMoving:x.isPending,isMovingDate:j.isPending}},P0=n.memo(function(){const s=ss(),{user:a}=ce(),r=Se(),{inboxTasks:i,inboxCount:o,isLoading:c,toggleInboxTask:l,deleteInboxTask:u}=kg(),[m,p]=n.useState(!1),[h,f]=n.useState(null),{addTask:d,updateTask:g,isUpdating:y}=fd(Y(new Date,"yyyy-MM-dd")),v=n.useCallback(async(x,j)=>{await g({taskId:x,updates:j}),r.invalidateQueries({queryKey:["inbox-tasks"]}),r.invalidateQueries({queryKey:["inbox-count"]}),f(null)},[g,r]),b=n.useCallback(async x=>{if(!a?.id)return;const j=x.sendToInbox?null:x.taskDate??Y(new Date,"yyyy-MM-dd");await d({taskText:x.text,difficulty:x.difficulty,taskDate:j,isMainQuest:!1,scheduledTime:x.scheduledTime,estimatedDuration:x.estimatedDuration,recurrencePattern:x.recurrencePattern,recurrenceDays:x.recurrenceDays,reminderEnabled:x.reminderEnabled,reminderMinutesBefore:x.reminderMinutesBefore,notes:x.moreInformation,location:x.location,contactId:x.contactId,autoLogInteraction:x.autoLogInteraction,subtasks:x.subtasks}),x.sendToInbox||r.invalidateQueries({queryKey:["daily-tasks"]}),r.invalidateQueries({queryKey:["inbox-tasks"]}),r.invalidateQueries({queryKey:["inbox-count"]}),p(!1)},[a?.id,d,r]);return e.jsx(Sa,{mode:"instant",children:e.jsxs("div",{className:"min-h-screen bg-transparent pb-24 pt-safe",children:[e.jsx(Ta,{}),e.jsx("div",{className:"max-w-lg mx-auto px-4 pt-6",style:{paddingTop:"max(1.5rem, env(safe-area-inset-top, 0px))"},children:e.jsxs(_.div,{initial:s?!1:{opacity:0,y:-12},animate:{opacity:1,y:0},transition:{duration:s?0:.24},className:"text-center mb-6",children:[e.jsx("h1",{className:"text-3xl font-semibold tracking-tight bg-gradient-to-r from-celestial-blue to-blue-400 bg-clip-text text-transparent",children:"Inbox"}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:"Capture now. Conquer later."}),o>0&&e.jsxs(Ne,{variant:"celestial",className:"text-xs mt-2",children:[o," quests"]})]})}),e.jsx("div",{className:"max-w-lg mx-auto px-4 pt-4",children:c?e.jsx("div",{className:"space-y-3",children:[1,2,3].map(x=>e.jsx("div",{className:"h-14 bg-muted/30 rounded-xl animate-pulse"},x))}):o===0?e.jsx(c0,{icon:dn,title:"Inbox is empty",description:"Capture quests with the + button â€” schedule them later when you're ready.",actionLabel:"Add a quest",onAction:()=>p(!0)}):e.jsx("div",{className:"space-y-2",children:i.map(x=>e.jsxs("div",{className:"flex items-center gap-3 py-3 px-3 rounded-2xl bg-card/82 backdrop-blur-lg border border-border/55 shadow-[0_8px_18px_rgba(0,0,0,0.16)]",children:[e.jsx("button",{onClick:()=>{l({taskId:x.id,completed:!x.completed}),$e.light()},className:"flex-shrink-0 w-6 h-6 rounded-full border-2 border-muted-foreground/40 hover:border-primary flex items-center justify-center transition-colors",children:x.completed&&e.jsx(Xe,{className:"w-4 h-4 text-primary"})}),e.jsx("span",{className:E("text-sm flex-1 min-w-0",x.completed&&"line-through text-muted-foreground"),children:x.task_text}),e.jsxs("div",{className:"flex items-center gap-1 flex-shrink-0",children:[e.jsx("button",{onClick:()=>{f(x),$e.light()},className:"p-2 rounded-xl hover:bg-muted/55 text-muted-foreground hover:text-foreground transition-colors touch-manipulation","aria-label":"Edit quest",children:e.jsx(al,{className:"w-4 h-4"})}),e.jsx("button",{onClick:()=>{u(x.id),$e.light()},className:"p-2 rounded-xl hover:bg-destructive/12 text-muted-foreground hover:text-destructive transition-colors touch-manipulation","aria-label":"Delete quest",children:e.jsx(es,{className:"w-4 h-4"})})]})]},x.id))})}),e.jsx(Jc,{onTap:()=>p(!0)}),e.jsx(ud,{open:m,onOpenChange:p,selectedDate:new Date,onAdd:b}),e.jsx(pd,{task:h,open:!!h,onOpenChange:x=>!x&&f(null),onSave:v,isSaving:y,onDelete:async x=>{u(x),f(null)},isDeleting:!1}),e.jsx(Ca,{})]})})});function A0({containerRef:t,edgeThreshold:s=80,scrollSpeed:a=8,enabled:r=!1}){const i=n.useRef(null),o=n.useRef(null),c=n.useRef(0),l=n.useCallback(()=>{i.current!==null&&(cancelAnimationFrame(i.current),i.current=null),o.current=null},[]),u=n.useCallback(()=>{if(!t.current||!o.current){l();return}const h=window.scrollY,f=document.documentElement.scrollHeight-window.innerHeight;o.current==="up"&&h>0?window.scrollBy(0,-a):o.current==="down"&&h<f&&window.scrollBy(0,a),i.current=requestAnimationFrame(u)},[t,a,l]),m=n.useCallback(p=>{if(!r)return;c.current=p;const h=window.innerHeight,f=p<s,d=p>h-s;f&&o.current!=="up"?(o.current="up",i.current===null&&(i.current=requestAnimationFrame(u))):d&&o.current!=="down"?(o.current="down",i.current===null&&(i.current=requestAnimationFrame(u))):!f&&!d&&l()},[r,s,u,l]);return n.useEffect(()=>(r||l(),()=>l()),[r,l]),{updatePosition:m,stopScroll:l}}const R0=40,zi=500,I0=10,Qr=async t=>{try{await Ct.impact({style:t})}catch{}},gd=t=>Math.max(0,Math.min(1430,t)),Ui=t=>{const[s,a]=t.split(":").map(Number);return s*60+a},Wi=t=>{const s=gd(t),a=Math.floor(s/60),r=s%60;return`${String(a).padStart(2,"0")}:${String(r).padStart(2,"0")}`};function q0({containerRef:t,onDrop:s}){const[a,r]=n.useState(null),[i,o]=n.useState(null),[c,l]=n.useState(0),u=n.useRef(null),m=n.useRef("09:00"),p=n.useRef(540),h=n.useRef(0),f=n.useRef(0),d=n.useRef(540),g=n.useRef(null),y=n.useRef(null),v=n.useRef(!1),b=n.useRef(null),x=n.useRef(null),[j,w]=n.useState(null),{updatePosition:D,stopScroll:S}=A0({containerRef:t,enabled:a!==null,edgeThreshold:80,scrollSpeed:8}),M=n.useCallback(Q=>{if(!u.current)return;f.current=Q;const U=Q-h.current;b.current||(b.current=requestAnimationFrame(()=>{l(f.current-h.current),b.current=null})),D(Q);const $=Math.round(U/R0)*10,J=gd(p.current+$);if(J!==d.current){d.current=J;const O=Wi(J);o(O),Qr(it.Light)}},[D]),C=n.useCallback(Q=>{M(Q.clientY)},[M]),R=n.useCallback(Q=>{if(!u.current)return;Q.preventDefault();const U=Q.touches[0];U&&M(U.clientY)},[M]),T=n.useCallback(()=>{window.removeEventListener("pointermove",C),window.removeEventListener("pointerup",k),window.removeEventListener("pointercancel",k),window.removeEventListener("touchmove",R),window.removeEventListener("touchend",P),window.removeEventListener("touchcancel",P)},[]),q=n.useCallback(()=>{const Q=u.current,U=d.current;if(Q){const $=Wi(U);Qr(it.Medium),s(Q,$),x.current=Q,w(Q),setTimeout(()=>{x.current=null,w(null)},300)}u.current=null,r(null),o(null),l(0),v.current=!1,S(),T()},[s,S,T]),k=n.useCallback(()=>{q()},[q]),P=n.useCallback(()=>{q()},[q]),A=n.useCallback((Q,U,$)=>{u.current=Q,m.current=U,p.current=Ui(U),d.current=Ui(U),h.current=$,f.current=$,r(Q),o(U),l(0),Qr(it.Medium),window.addEventListener("pointermove",C),window.addEventListener("pointerup",k),window.addEventListener("pointercancel",k),window.addEventListener("touchmove",R,{passive:!1}),window.addEventListener("touchend",P),window.addEventListener("touchcancel",P)},[C,k,R,P]),L=n.useCallback(()=>{g.current&&(clearTimeout(g.current),g.current=null),y.current=null},[]),H=n.useCallback((Q,U,$)=>{if(u.current)return;const J=Q.target;if(J.closest("button")||J.closest('[role="checkbox"]')||J.closest("[data-interactive]"))return;const O=Q.touches[0];y.current={x:O.clientX,y:O.clientY},g.current=setTimeout(()=>{v.current=!0,A(U,$,O.clientY)},zi)},[A]),I=n.useCallback(Q=>{if(v.current||u.current||!y.current)return;const U=Q.touches[0];Math.abs(U.clientY-y.current.y)>I0&&L()},[L]),te=n.useCallback(()=>{L(),v.current=!1},[L]),V=n.useCallback((Q,U,$)=>{if(u.current||Q.pointerType==="touch")return;const J=Q.target;J.closest("button")||J.closest('[role="checkbox"]')||J.closest("[data-interactive]")||(y.current={x:Q.clientX,y:Q.clientY},g.current=setTimeout(()=>{v.current=!0,A(U,$,Q.clientY)},zi))},[A]),z=n.useCallback(()=>{v.current||L()},[L]),W=n.useCallback(()=>{L()},[L]);return n.useEffect(()=>()=>{T(),L(),b.current&&cancelAnimationFrame(b.current)},[T,L]),{draggingTaskId:a,previewTime:i,dragOffsetY:c,justDroppedId:j,isDragging:a!==null,getRowHandlers:(Q,U)=>({onTouchStart:$=>H($,Q,U),onTouchMove:I,onTouchEnd:te,onTouchCancel:te,onPointerDown:$=>V($,Q,U),onPointerUp:z,onPointerCancel:W})}}const L0=jm,F0=_m,O0=n.forwardRef(({className:t,inset:s,children:a,...r},i)=>e.jsxs(rl,{ref:i,className:E("flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none data-[state=open]:bg-accent focus:bg-accent",s&&"pl-8",t),...r,children:[a,e.jsx(tt,{className:"ml-auto h-4 w-4"})]}));O0.displayName=rl.displayName;const $0=n.forwardRef(({className:t,...s},a)=>e.jsx(nl,{ref:a,className:E("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-lg data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...s}));$0.displayName=nl.displayName;const xd=n.forwardRef(({className:t,sideOffset:s=4,...a},r)=>e.jsx(wm,{children:e.jsx(il,{ref:r,sideOffset:s,className:E("z-50 min-w-[8rem] overflow-hidden rounded-md border bg-popover p-1 text-popover-foreground shadow-md data-[state=open]:animate-in data-[state=closed]:animate-out data-[state=closed]:fade-out-0 data-[state=open]:fade-in-0 data-[state=closed]:zoom-out-95 data-[state=open]:zoom-in-95 data-[side=bottom]:slide-in-from-top-2 data-[side=left]:slide-in-from-right-2 data-[side=right]:slide-in-from-left-2 data-[side=top]:slide-in-from-bottom-2",t),...a})}));xd.displayName=il.displayName;const ra=n.forwardRef(({className:t,inset:s,...a},r)=>e.jsx(ol,{ref:r,className:E("relative flex cursor-default select-none items-center rounded-sm px-2 py-1.5 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",s&&"pl-8",t),...a}));ra.displayName=ol.displayName;const B0=n.forwardRef(({className:t,children:s,checked:a,...r},i)=>e.jsxs(ll,{ref:i,className:E("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",t),checked:a,...r,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(cl,{children:e.jsx(Xe,{className:"h-4 w-4"})})}),s]}));B0.displayName=ll.displayName;const H0=n.forwardRef(({className:t,children:s,...a},r)=>e.jsxs(dl,{ref:r,className:E("relative flex cursor-default select-none items-center rounded-sm py-1.5 pl-8 pr-2 text-sm outline-none transition-colors data-[disabled]:pointer-events-none data-[disabled]:opacity-50 focus:bg-accent focus:text-accent-foreground",t),...a,children:[e.jsx("span",{className:"absolute left-2 flex h-3.5 w-3.5 items-center justify-center",children:e.jsx(cl,{children:e.jsx(nr,{className:"h-2 w-2 fill-current"})})}),s]}));H0.displayName=dl.displayName;const z0=n.forwardRef(({className:t,inset:s,...a},r)=>e.jsx(ul,{ref:r,className:E("px-2 py-1.5 text-sm font-semibold",s&&"pl-8",t),...a}));z0.displayName=ul.displayName;const U0=n.forwardRef(({className:t,...s},a)=>e.jsx(ml,{ref:a,className:E("-mx-1 my-1 h-px bg-muted",t),...s}));U0.displayName=ml.displayName;const W0=["January","February","March","April","May","June","July","August","September","October","November","December"],Q0=({selectedDate:t,onDateSelect:s,onMonthChange:a,tasks:r,milestones:i=[],onTaskClick:o,onMilestoneClick:c,onDateLongPress:l})=>{const[u,m]=n.useState(null),p=fa(t),h=ga(t),f=bl(p,{weekStartsOn:0}),d=vl(h,{weekStartsOn:0}),g=Jr({start:f,end:d}),y=new Date().getFullYear(),v=Array.from({length:8},(T,q)=>y-2+q),b=t.getMonth(),x=t.getFullYear(),j=T=>{const q=new Date(t);q.setMonth(parseInt(T)),(a||s)(q)},w=T=>{const q=new Date(t);q.setFullYear(parseInt(T)),(a||s)(q)},D=T=>{const q=setTimeout(()=>{Lp("pop"),l?.(T)},500);m(q)},S=()=>{u&&(clearTimeout(u),m(null))},M=T=>{const q=Y(T,"yyyy-MM-dd");return r.filter(k=>k.task_date===q)},C=T=>{const q=Y(T,"yyyy-MM-dd");return i.filter(k=>k.target_date===q)},R=T=>{const k=M(T).filter(P=>P.scheduled_time&&P.estimated_duration);for(let P=0;P<k.length;P++)for(let A=P+1;A<k.length;A++){const L=new Date(`2000-01-01T${k[P].scheduled_time}:00`),H=new Date(L.getTime()+k[P].estimated_duration*6e4),I=new Date(`2000-01-01T${k[A].scheduled_time}:00`),te=new Date(I.getTime()+k[A].estimated_duration*6e4);if(L<te&&I<H)return!0}return!1};return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsxs(ya,{value:b.toString(),onValueChange:j,children:[e.jsx(Os,{className:"w-[120px] h-9 text-xl font-bold border-0 bg-transparent hover:bg-muted/50 focus:ring-0 px-2",children:e.jsx(ba,{})}),e.jsx($s,{className:"bg-popover border border-border z-[110]",children:W0.map((T,q)=>e.jsx(ds,{value:q.toString(),children:T},T))})]}),e.jsxs(ya,{value:x.toString(),onValueChange:w,children:[e.jsx(Os,{className:"w-[80px] h-9 text-xl font-bold border-0 bg-transparent hover:bg-muted/50 focus:ring-0 px-2",children:e.jsx(ba,{})}),e.jsx($s,{className:"bg-popover border border-border z-[110]",children:v.map(T=>e.jsx(ds,{value:T.toString(),children:T},T))})]})]}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(B,{variant:"outline",size:"icon",onClick:()=>(a||s)(Wm(t)),children:e.jsx(ys,{className:"h-4 w-4"})}),e.jsx(B,{variant:"outline",size:"icon",onClick:()=>(a||s)(Ps(t,1)),children:e.jsx(tt,{className:"h-4 w-4"})})]})]}),e.jsxs("div",{className:"border border-border",children:[e.jsx("div",{className:"grid grid-cols-7 border-b border-border bg-muted/30",children:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"].map((T,q)=>e.jsx("div",{className:E("text-center text-sm font-medium text-muted-foreground p-2",q<6&&"border-r border-border"),children:T},T))}),e.jsx("div",{className:"grid grid-cols-7",children:g.map((T,q)=>{const k=M(T),P=C(T),A=Zr(T,t),L=Zr(T,new Date),H=R(T),I=(q+1)%7===0,te=q>=g.length-7,V=k.length+P.length,z=3;return e.jsxs("div",{className:E("min-h-[120px] p-2 cursor-pointer transition-colors bg-background",!I&&"border-r border-border",!te&&"border-b border-border",A&&"bg-primary/10",L&&"bg-primary/5",!Qm(T,t)&&"bg-muted/20 text-muted-foreground"),onClick:()=>s(T),onTouchStart:()=>D(T),onTouchEnd:S,onMouseDown:()=>D(T),onMouseUp:S,onMouseLeave:S,children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:E("text-sm font-medium",L&&"bg-celestial-blue text-white w-6 h-6 flex items-center justify-center rounded-full ring-2 ring-celestial-blue/30"),children:Y(T,"d")}),e.jsxs("div",{className:"flex items-center gap-1",children:[P.length>0&&e.jsx(et,{className:"h-3 w-3 text-amber-500"}),H&&e.jsx(js,{className:"h-3 w-3 text-destructive"})]})]}),e.jsxs("div",{className:"space-y-0.5",children:[P.slice(0,2).map(W=>e.jsxs("div",{onClick:Q=>{Q.stopPropagation(),c?.(W)},className:E("text-xs p-1 border-l-2 truncate transition-all hover:bg-amber-500/10","border-l-amber-500 bg-amber-500/5",W.completed_at&&"opacity-50 line-through"),children:[e.jsx(et,{className:"h-2 w-2 inline mr-1 text-amber-500"}),W.title]},W.id)),k.slice(0,Math.max(0,z-P.length)).map(W=>e.jsxs("div",{onClick:Q=>{Q.stopPropagation(),o(W)},className:E("text-xs p-1 border-l-2 truncate transition-all hover:bg-muted/50",W.completed&&"opacity-50 line-through",W.is_main_quest&&"border-l-amber-500 bg-amber-500/5",!W.is_main_quest&&W.difficulty==="easy"&&"border-l-emerald-500 bg-emerald-500/5",!W.is_main_quest&&W.difficulty==="medium"&&"border-l-amber-500 bg-amber-500/5",!W.is_main_quest&&W.difficulty==="hard"&&"border-l-rose-500 bg-rose-500/5"),children:[W.scheduled_time&&e.jsx(lt,{className:"h-2 w-2 inline mr-1"}),W.task_text]},W.id)),V>z&&e.jsxs(Ne,{variant:"secondary",className:"text-[10px] py-0",children:["+",V-z," more"]})]})]},T.toString())})})]})]})},K0=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],Qi=t=>{if(!t)return null;const s=new Date(t);return Number.isNaN(s.getTime())?null:s};function G0({selectedDate:t,onMonthSelect:s,onBack:a,onClose:r,onYearChange:i,tasks:o,milestones:c=[]}){const[l,u]=n.useState(!1),m=t.getFullYear(),p=new Date,h=new Date().getFullYear(),f=Array.from({length:16},(j,w)=>h-5+w),d=()=>{i(m-1)},g=()=>{i(m+1)},y=j=>{i(j),u(!1)},v=j=>{const w=Zt(Ba(new Date,m),j);s(w)},b=j=>{const w=fa(Zt(Ba(new Date,m),j)),D=ga(w),S=Jr({start:w,end:D});return o.filter(M=>{const C=Qi(M.task_date);return C?S.some(R=>Y(R,"yyyy-MM-dd")===Y(C,"yyyy-MM-dd")):!1})},x=j=>{const w=fa(Zt(Ba(new Date,m),j)),D=ga(w),S=Jr({start:w,end:D});return c.filter(M=>{const C=Qi(M.target_date);return C?S.some(R=>Y(R,"yyyy-MM-dd")===Y(C,"yyyy-MM-dd")):!1})};return e.jsxs("div",{className:"flex flex-col h-full",children:[e.jsxs("div",{className:"flex items-center justify-between px-5 py-4 border-b border-border/30",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(B,{variant:"ghost",size:"icon",onClick:d,className:"h-8 w-8",children:e.jsx(ys,{className:"h-5 w-5"})}),e.jsxs(Wt,{open:l,onOpenChange:u,children:[e.jsx(Qt,{asChild:!0,children:e.jsx("button",{className:"text-2xl font-bold text-primary hover:opacity-80 transition-opacity",children:m})}),e.jsx(qt,{className:"w-32 p-0 bg-background border border-border z-[70] pointer-events-auto",align:"start",onOpenAutoFocus:j=>j.preventDefault(),onPointerDownOutside:j=>j.preventDefault(),children:e.jsx("div",{className:"h-64 overflow-y-auto overscroll-contain p-2",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},onTouchMove:j=>j.stopPropagation(),onTouchStart:j=>j.stopPropagation(),children:e.jsx("div",{className:"space-y-1",children:f.map(j=>e.jsx("button",{onClick:w=>{w.stopPropagation(),y(j)},className:E("w-full text-left px-3 py-2 rounded-lg text-sm font-medium transition-colors",j===m?"bg-primary text-primary-foreground":"hover:bg-muted"),children:j},j))})})})]}),e.jsx(B,{variant:"ghost",size:"icon",onClick:g,className:"h-8 w-8",children:e.jsx(tt,{className:"h-5 w-5"})})]}),e.jsx(B,{variant:"ghost",size:"icon",onClick:r,className:"h-9 w-9 rounded-full bg-muted",children:e.jsx(Qe,{className:"h-5 w-5"})})]}),e.jsx("div",{className:"p-4 overflow-y-auto flex-1",children:e.jsx("div",{className:"grid grid-cols-3 gap-3",children:K0.map((j,w)=>{const D=b(w),S=x(w),M=p.getMonth()===w&&p.getFullYear()===m,C=t.getMonth()===w&&t.getFullYear()===m,R=D.filter(k=>!k.completed).length,T=D.filter(k=>k.completed).length,q=S.length>0;return e.jsxs("button",{onClick:()=>v(w),className:E("flex flex-col items-center justify-center py-4 px-2 rounded-xl transition-all min-h-[80px]",C?"bg-coral-500 text-white":M?"bg-coral-500/15 text-coral-500":"text-foreground hover:bg-muted/50"),children:[e.jsx("span",{className:E("text-base font-semibold",C&&"text-white"),children:j}),e.jsxs("div",{className:"flex items-center justify-center gap-1 mt-2 min-h-[8px]",children:[q&&e.jsx("div",{className:E("w-2 h-2 rounded-full",C?"bg-white/70":"bg-amber-500")}),R>0&&e.jsx("div",{className:E("w-2 h-2 rounded-full",C?"bg-white/70":"bg-coral-500")}),T>0&&e.jsx("div",{className:E("w-2 h-2 rounded-full",C?"bg-white/50":"bg-celestial-blue")})]})]},j)})})})]})}const Ki=t=>{if(!t)return null;const s=new Date(`${t}T00:00:00`);return Number.isNaN(s.getTime())?null:s},Y0=(t,s,a="")=>{try{return Number.isNaN(t.getTime())?a:Y(t,s)}catch{return a}};function V0({open:t,onOpenChange:s,selectedDate:a,onDateSelect:r,tasks:i,milestones:o=[],onTimeSlotLongPress:c}){const[l,u]=n.useState(!1),m=y=>{r(y),s(!1)},p=y=>{r(y)},h=y=>{const v=Ki(y.task_date);v&&(r(v),s(!1))},f=y=>{const v=Ki(y.target_date);v&&(r(v),s(!1))},d=y=>{r(Ba(a,y))},g=y=>{r(y),u(!1)};return e.jsx(ct,{open:t,onOpenChange:s,children:e.jsxs(ot,{className:"max-w-2xl w-full h-[90vh] p-0 gap-0 flex flex-col bg-background",hideCloseButton:!0,children:[e.jsxs("div",{className:"flex items-center justify-between px-4 py-3 border-b border-border shrink-0",children:[e.jsx(St,{className:"text-lg font-semibold",children:Y0(a,"MMMM yyyy","Calendar")}),e.jsx(B,{variant:"ghost",size:"icon",onClick:()=>s(!1),className:"h-8 w-8",children:e.jsx(Qe,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"px-4 py-2 text-sm text-muted-foreground border-b border-border/50 shrink-0",children:"Tap any date to view daily schedule"}),e.jsx("div",{className:"flex-1 overflow-y-auto px-4 py-3",children:l?e.jsx(G0,{selectedDate:a,onMonthSelect:g,onBack:()=>u(!1),onClose:()=>s(!1),onYearChange:d,tasks:i,milestones:o}):e.jsx(Q0,{selectedDate:a,onDateSelect:m,onMonthChange:p,tasks:i,milestones:o,onTaskClick:h,onMilestoneClick:f,onDateLongPress:y=>c?.(y,"09:00")})})]})})}const da=[{task_text:"Create Your First Quest ðŸŽ¯",xp_reward:4,difficulty:"easy",sort_order:0,category:"mind",estimated_duration:3,notes:`1. Stay on QUESTS.
2. Tap + in the lower-right corner.
3. Set a time (required for creating a Quest here).
4. Enter your quest title.
5. Tap Create Quest.
If time is missing, it becomes an Inbox item.`},{task_text:"Meet Your Companion âœ¨",xp_reward:3,difficulty:"easy",sort_order:1,category:"soul",estimated_duration:2,notes:`1. Tap COMPANION in the bottom navigation bar.
2. Wait for the companion page to load.
3. Check your bond/progress panel.
Done when this step auto-completes.`},{task_text:"Morning Check-in ðŸŒ…",xp_reward:3,difficulty:"easy",sort_order:2,category:"mind",estimated_duration:3,notes:`1. Tap MENTOR in the bottom navigation bar.
2. Open the Morning Check-in card.
3. Submit your reflection.
Done when this step auto-completes after submit.`}];function X0(t,s,a=!1){const r=Se(),[i,o]=n.useState(!1);n.useEffect(()=>{if(a){console.log("[Onboarding] Waiting for profile to load...");return}if(!t||!s){console.log("[Onboarding] Skipping schedule creation:",{hasUserId:!!t,hasCompletedWalkthrough:s,isProfileLoading:a});return}if(i){console.log("[Onboarding] Already creating tasks, skipping...");return}const c=3,l=`onboarding_schedule_version_${t}`;(async()=>{if(Number(qe.getItem(l)??"0")>=c){const{data:p}=await N.from("daily_tasks").select("id").eq("user_id",t).eq("source","onboarding").limit(1);if(p?.length){console.log("[Onboarding] Schedule already created (verified)");return}console.log("[Onboarding] Stale flag detected - clearing for retry"),qe.removeItem(l)}o(!0),console.log("[Onboarding] Creating onboarding schedule for new user");try{const p=Y(new Date,"yyyy-MM-dd"),h=da.map(b=>b.task_text),{data:f}=await N.from("daily_tasks").select("id, task_text").eq("user_id",t).eq("source","onboarding");if(f&&f.length>0){const b=new Map(f.map(j=>[j.task_text,j])),x=f.filter(j=>!h.includes(j.task_text)).map(j=>j.id);await Promise.all(da.map(j=>{const w=b.get(j.task_text);return w?N.from("daily_tasks").update({notes:j.notes,xp_reward:j.xp_reward,difficulty:j.difficulty,sort_order:j.sort_order,category:j.category,estimated_duration:j.estimated_duration,is_main_quest:!1}).eq("id",w.id).eq("user_id",t):N.from("daily_tasks").insert({user_id:t,task_text:j.task_text,xp_reward:j.xp_reward,difficulty:j.difficulty,task_date:p,is_main_quest:!1,sort_order:j.sort_order,source:"onboarding",notes:j.notes,category:j.category,estimated_duration:j.estimated_duration})})),x.length>0&&await N.from("daily_tasks").delete().eq("user_id",t).eq("source","onboarding").in("id",x),console.log("[Onboarding] Onboarding tasks synced to latest flow"),qe.setItem(l,String(c)),r.invalidateQueries({queryKey:["daily-tasks"]}),o(!1);return}const{data:d}=await N.from("daily_tasks").select("id").eq("user_id",t).eq("task_text","Join Cosmiq").maybeSingle();if(d){console.log("[Onboarding] Legacy user detected, skipping onboarding tasks"),qe.setItem(l,String(c)),o(!1);return}const g=da.map(b=>({user_id:t,task_text:b.task_text,xp_reward:b.xp_reward,difficulty:b.difficulty,task_date:p,is_main_quest:!1,sort_order:b.sort_order,source:"onboarding",notes:b.notes,category:b.category,estimated_duration:b.estimated_duration})),{data:y,error:v}=await N.from("daily_tasks").insert(g).select();if(v||!y?.length){console.error("[Onboarding] Failed to create onboarding schedule:",v),o(!1);return}console.log("[Onboarding] Successfully created",y.length,"onboarding tasks"),qe.setItem(l,String(c)),r.invalidateQueries({queryKey:["daily-tasks"]})}catch(p){console.error("[Onboarding] Error creating onboarding schedule:",p)}finally{o(!1)}})()},[t,s,a,r,i])}function Es(t){return da.some(s=>s.task_text===t)}da.map(t=>t.task_text);function J0({children:t,onSwipeDelete:s,onSwipeMoveToNextDay:a,disabled:r=!1}){const i=Nm(0),[o,c]=n.useState(!1),[l,u]=n.useState(!1),[m,p]=n.useState(!1),[h,f]=n.useState(!1),[d,g]=n.useState(null),y=n.useRef(null),v=140,b=1e3,x=180,j=300;n.useEffect(()=>()=>{y.current&&clearTimeout(y.current)},[]);const w=Yt(i,[-v,0],[1,0]),D=Yt(i,[-v,0],[1,.5]),S=Yt(i,[-v,0],["hsl(0 84% 60% / 0.15)","hsl(var(--background))"]),M=Yt(i,[0,v],[0,1]),C=Yt(i,[0,v],[.5,1]),R=Yt(i,[0,v],["hsl(var(--background))","hsl(var(--primary) / 0.15)"]),T=(k,P)=>{if(r||o||l)return;const A=P.offset.x<-v,L=P.offset.x>v&&a,H=A?"left":L?"right":null;(A||L)&&!m?(p(!0),g(H),y.current=setTimeout(async()=>{f(!0);try{await Ct.impact({style:it.Heavy})}catch{}},j)):!A&&!L&&m&&(p(!1),f(!1),g(null),y.current&&(clearTimeout(y.current),y.current=null))},q=(k,P)=>{if(r||o||l)return;if(y.current&&(clearTimeout(y.current),y.current=null),!h){p(!1),g(null);return}const A=P.offset.x<-v||P.velocity.x<-b,L=P.offset.x>v||P.velocity.x>b;A?(c(!0),setTimeout(()=>{s()},200)):L&&a&&(u(!0),setTimeout(()=>{a()},200)),p(!1),f(!1),g(null)};return e.jsxs("div",{className:"relative overflow-hidden",children:[e.jsx(_.div,{className:"absolute inset-0 flex items-center justify-start pl-5",style:{opacity:M,background:R},children:e.jsxs(_.div,{className:"flex items-center gap-2",style:{scale:C},children:[e.jsxs("div",{className:"relative w-10 h-10 rounded-full bg-primary flex items-center justify-center",children:[h&&d==="right"?e.jsx(_.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:25},children:e.jsx(Xe,{className:"w-5 h-5 text-primary-foreground"})}):e.jsx(km,{className:"w-5 h-5 text-primary-foreground"}),m&&!h&&d==="right"&&e.jsx(_.div,{className:"absolute inset-0 rounded-full border-2 border-primary-foreground",initial:{scale:1,opacity:.5},animate:{scale:1.3,opacity:0},transition:{duration:.3,repeat:1/0}})]}),e.jsx("span",{className:"text-primary font-semibold text-sm",children:h&&d==="right"?"Release!":m&&d==="right"?"Hold...":"Tomorrow"})]})}),e.jsx(_.div,{className:"absolute inset-0 flex items-center justify-end pr-5",style:{opacity:w,background:S},children:e.jsxs(_.div,{className:"flex items-center gap-2",style:{scale:D},children:[e.jsx("span",{className:"text-red-500 font-semibold text-sm",children:h&&d==="left"?"Release!":m&&d==="left"?"Hold...":"Delete"}),e.jsxs("div",{className:"relative w-10 h-10 rounded-full bg-red-500 flex items-center justify-center",children:[h&&d==="left"?e.jsx(_.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:25},children:e.jsx(Xe,{className:"w-6 h-6 text-white"})}):e.jsx(es,{className:"w-6 h-6 text-white"}),m&&!h&&d==="left"&&e.jsx(_.div,{className:"absolute inset-0 rounded-full border-2 border-white",initial:{scale:1,opacity:.5},animate:{scale:1.3,opacity:0},transition:{duration:.3,repeat:1/0}})]})]})}),e.jsx(_.div,{drag:r||o||l?!1:"x",dragConstraints:{left:-x,right:a?x:0},dragElastic:.15,dragDirectionLock:!0,dragSnapToOrigin:!o&&!l&&!m,style:{x:i},onDragStart:()=>{p(!1),f(!1),g(null)},onDrag:T,onDragEnd:q,animate:o?{x:-500,opacity:0}:l?{x:500,opacity:0}:{},transition:o||l?{duration:.2,ease:"easeOut"}:{},className:E("relative",!r&&!o&&!l&&"cursor-grab active:cursor-grabbing"),whileTap:r||o||l?{}:{scale:.99},children:t})]})}function Z0({text:t,className:s,speed:a=30,pauseDuration:r=2e3,initialDelay:i=3e3}){const o=n.useRef(null),c=n.useRef(null),[l,u]=n.useState(!1),[m,p]=n.useState(0);n.useEffect(()=>{const v=()=>{if(o.current&&c.current){const j=o.current.offsetWidth,w=c.current.scrollWidth,D=w>j;u(D),D&&p(w-j+20)}},b=setTimeout(v,100),x=new ResizeObserver(v);return o.current&&x.observe(o.current),()=>{clearTimeout(b),x.disconnect()}},[t]);const h=m/a,f=i/1e3+h+r*2/1e3,d=i/1e3/f,g=h/2/f,y=r/1e3/f;return e.jsx("div",{ref:o,className:E("overflow-hidden",s),children:e.jsx(_.span,{ref:c,className:"whitespace-nowrap inline-block",animate:l?{x:[0,0,-m,-m,0,0]}:{x:0},transition:l?{duration:f,times:[0,d,d+g,d+g+y,d+g*2+y,1],repeat:1/0,ease:"linear"}:{duration:0},children:t})})}const An=t=>{const{user:s}=ce(),a=Se(),{data:r,isLoading:i,error:o}=ye({queryKey:["journey-path",t],queryFn:async()=>{if(!t||!s?.id)return null;const{data:m,error:p}=await N.from("epic_journey_paths").select("*").eq("epic_id",t).order("milestone_index",{ascending:!1}).limit(1).maybeSingle();if(p)throw console.error("Error fetching journey path:",p),p;return m},enabled:!!t&&!!s?.id,staleTime:600*1e3}),c=ie({mutationFn:async({milestoneIndex:m})=>{if(!t||!s?.id)throw new Error("Missing epic or user");const{data:p,error:h}=await N.functions.invoke("generate-journey-path",{body:{epicId:t,milestoneIndex:m,userId:s.id}});if(h)throw h;if(p?.error)throw new Error(p.error);return p},onSuccess:()=>{a.invalidateQueries({queryKey:["journey-path",t]})},onError:m=>{console.error("Failed to generate journey path:",m)}}),l=n.useCallback(()=>{!t||!s?.id||!r&&!i&&c.mutate({milestoneIndex:0})},[t,s?.id,r,i,c]),u=n.useCallback(m=>{!t||!s?.id||c.mutate({milestoneIndex:m})},[t,s?.id,c]);return{pathImageUrl:r?.image_url||null,currentMilestoneIndex:r?.milestone_index??-1,isLoading:i,isGenerating:c.isPending,error:o,generateInitialPath:l,regeneratePathForMilestone:u}},Gi=[70,40,60,25,75,35,55,45],ey=t=>{const s=[];for(let a=0;a<t;a++){const r=t===1?.5:a/(t-1),i=8+r*84,o=Gi[a%Gi.length],c=Math.sin(r*Math.PI*2)*8,l=o+c,u=a===0||a===t-1?10:6+Math.random()*4;s.push({x:i,y:l,size:u})}return s},an=(t,s)=>{if(s.length<2)return{x:10,y:50};const a=Math.max(0,Math.min(100,t))/100,r=s.length-1,i=a*r,o=Math.min(Math.floor(i),r-1),c=i-o,l=s[o],u=s[o+1],m=(l.x+u.x)/2,p=(l.y+u.y)/2+(o%2===0?-10:10),h=1-c,f=h*h*l.x+2*h*c*m+c*c*u.x,d=h*h*l.y+2*h*c*p+c*c*u.y;return{x:f,y:d}},Yi=t=>{if(t.length<2)return"";let s=`M ${t[0].x} ${t[0].y}`;for(let a=1;a<t.length;a++){const r=t[a-1],i=t[a],o=(r.x+i.x)/2,c=(r.y+i.y)/2+(a%2===0?-12:12);if(a===Math.max(1,Math.floor(t.length*.4))){const l=o,u=(r.y+i.y)/2;s+=` Q ${o-5} ${c} ${l-4} ${u}`,s+=` C ${l-8} ${u-12} ${l+8} ${u-12} ${l+4} ${u}`,s+=` Q ${o+5} ${c} ${i.x} ${i.y}`}else s+=` Q ${o} ${c} ${i.x} ${i.y}`}return s},ty=(t,s)=>{if(t.length<2||s<=0)return"";const a=an(s,t),r=Math.max(0,Math.min(100,s))/100,i=t.length-1,o=r*i,c=Math.floor(o);let l=`M ${t[0].x} ${t[0].y}`;for(let u=1;u<=c&&u<t.length;u++){const m=t[u-1],p=t[u],h=(m.x+p.x)/2,f=(m.y+p.y)/2+(u%2===0?-12:12);if(u===Math.max(1,Math.floor(t.length*.4))){const d=h,g=(m.y+p.y)/2;l+=` Q ${h-5} ${f} ${d-4} ${g}`,l+=` C ${d-8} ${g-12} ${d+8} ${g-12} ${d+4} ${g}`,l+=` Q ${h+5} ${f} ${p.x} ${p.y}`}else l+=` Q ${h} ${f} ${p.x} ${p.y}`}return c<i&&(l+=` L ${a.x} ${a.y}`),l},sy=({milestone:t,currentProgress:s,isPostcard:a})=>{const[r,i]=n.useState(!1),o=t.milestone_percent-s,c=Math.min(100,Math.max(0,s/t.milestone_percent*100));n.useEffect(()=>(r&&(document.body.style.overflow="hidden"),()=>{document.body.style.overflow=""}),[r]);const l=async()=>{try{await Ct.impact({style:it.Medium})}catch{}i(!0)},u=()=>a?`A cosmic postcard is forming in the starlight... ${t.chapter_number?`Chapter ${t.chapter_number}`:"A new chapter"} of your companion's tale awaits.`:"A new milestone on your journey awaits... Keep going to discover what lies ahead.";return e.jsxs(Wt,{open:r,onOpenChange:i,children:[e.jsx(Qt,{asChild:!0,children:e.jsx("button",{onClick:l,className:E("w-11 h-11 -m-4 flex items-center justify-center","cursor-pointer focus:outline-none focus-visible:ring-2 focus-visible:ring-primary/50 rounded-full","group transition-all duration-200","active:scale-90 active:bg-white/5"),"aria-label":`Unlock milestone at ${t.milestone_percent}%`,children:e.jsx(_.div,{className:E("w-4 h-4 rounded-full flex items-center justify-center",a?"text-amber-400/70":"text-purple-400/70","group-hover:scale-125 transition-transform"),animate:{opacity:[.5,1,.5],scale:[1,1.1,1]},transition:{duration:2,repeat:1/0,ease:"easeInOut"},children:e.jsx(hn,{className:"w-3.5 h-3.5"})})})}),e.jsx(qt,{className:E("w-64 p-0 border overflow-hidden shadow-xl","supports-[backdrop-filter]:backdrop-blur-xl",a?"bg-gradient-to-br from-amber-950/98 via-yellow-950/95 to-slate-950/98 border-amber-500/20":"bg-gradient-to-br from-purple-950/98 via-slate-950/95 to-slate-950/98 border-purple-500/20"),sideOffset:12,collisionPadding:{top:50,bottom:50,left:16,right:16},children:e.jsxs(_.div,{initial:{opacity:0,scale:.95,y:-5},animate:{opacity:1,scale:1,y:0},transition:{type:"spring",stiffness:300,damping:25},children:[e.jsx(be,{children:r&&e.jsxs("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:[e.jsx(_.div,{className:E("absolute top-3 right-4",a?"text-amber-400/40":"text-purple-400/40"),initial:{opacity:0,scale:0},animate:{opacity:1,scale:1,rotate:360},exit:{opacity:0,scale:0},transition:{opacity:{duration:.3},rotate:{duration:4,repeat:1/0,ease:"linear"}},children:e.jsx(se,{className:"w-4 h-4"})}),e.jsx(_.div,{className:E("absolute bottom-6 left-3",a?"text-amber-400/25":"text-purple-400/25"),initial:{opacity:0,scale:0},animate:{opacity:1,scale:[1,1.3,1],rotate:-360},exit:{opacity:0,scale:0},transition:{opacity:{duration:.3,delay:.1},scale:{duration:3,repeat:1/0},rotate:{duration:5,repeat:1/0,ease:"linear"}},children:e.jsx(et,{className:"w-3 h-3"})}),e.jsx(_.div,{className:E("absolute top-1/2 right-6 w-1.5 h-1.5 rounded-full",a?"bg-amber-400/30":"bg-purple-400/30"),initial:{opacity:0},animate:{opacity:[0,1,0],y:[0,-10,0]},exit:{opacity:0},transition:{duration:2,repeat:1/0,delay:.5}})]})}),e.jsxs("div",{className:"p-4 relative z-10",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsx(_.div,{className:E("w-8 h-8 rounded-full flex items-center justify-center",a?"bg-amber-500/20 text-amber-400 shadow-[0_0_12px_rgba(251,191,36,0.3)]":"bg-purple-500/20 text-purple-400 shadow-[0_0_12px_rgba(168,85,247,0.3)]"),animate:{boxShadow:a?["0 0 12px rgba(251,191,36,0.3)","0 0 20px rgba(251,191,36,0.5)","0 0 12px rgba(251,191,36,0.3)"]:["0 0 12px rgba(168,85,247,0.3)","0 0 20px rgba(168,85,247,0.5)","0 0 12px rgba(168,85,247,0.3)"]},transition:{duration:2,repeat:1/0},children:e.jsx(er,{className:"w-4 h-4"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-bold text-white leading-tight",children:"Mystery Awaits..."}),e.jsx("p",{className:E("text-xs leading-tight",a?"text-amber-400/80":"text-purple-400/80"),children:a?"Postcard Milestone":"Journey Milestone"})]})]}),e.jsx("div",{className:E("h-px w-full mb-3",a?"bg-amber-400/20":"bg-purple-400/20")}),e.jsxs("div",{className:"flex items-center gap-4 mb-4",children:[e.jsxs("div",{className:"relative w-12 h-12 flex-shrink-0",children:[e.jsxs("svg",{className:"w-12 h-12 -rotate-90",viewBox:"0 0 36 36",children:[e.jsx("circle",{cx:"18",cy:"18",r:"14",fill:"none",stroke:"currentColor",strokeWidth:"2.5",className:"text-white/10"}),e.jsx(_.circle,{cx:"18",cy:"18",r:"14",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",className:a?"text-amber-400":"text-purple-400",initial:{strokeDasharray:"0 100"},animate:{strokeDasharray:`${c*.88} 100`},transition:{duration:.8,ease:"easeOut"}})]}),e.jsxs("span",{className:E("absolute inset-0 flex items-center justify-center text-xs font-bold",a?"text-amber-400":"text-purple-400"),children:[Math.round(c),"%"]})]}),e.jsxs("div",{className:"flex-1",children:[e.jsx("p",{className:"text-xs text-white/60 leading-snug",children:"Unlock at"}),e.jsxs("p",{className:E("text-lg font-bold leading-tight",a?"text-amber-400":"text-purple-400"),children:[t.milestone_percent,"%"]}),e.jsx("p",{className:"text-xs text-white/50 leading-snug",children:o>0?`${Math.round(o)}% to go`:"Almost there!"})]})]}),e.jsxs("p",{className:"text-xs text-white/75 leading-relaxed italic mb-3",children:['"',u(),'"']}),(t.phase_name||t.target_date)&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[t.phase_name&&e.jsx("span",{className:E("px-2 py-1 rounded-md text-[11px] font-medium",a?"bg-amber-400/10 text-amber-400/70":"bg-purple-400/10 text-purple-400/70"),children:t.phase_name}),t.target_date&&e.jsxs("span",{className:E("px-2 py-1 rounded-md text-[11px] font-medium",a?"bg-amber-400/10 text-amber-400/70":"bg-purple-400/10 text-purple-400/70"),children:["Est. ",Y(new Date(t.target_date),"MMM d")]})]})]})]})})]})},ay=({isRevealing:t,isPostcard:s,onComplete:a})=>(n.useEffect(()=>{if(t){(async()=>{try{await Ct.notification({type:Cm.Success})}catch{}})();const i=setTimeout(a,2e3);return()=>clearTimeout(i)}},[t,a]),e.jsx(be,{children:t&&e.jsxs(e.Fragment,{children:[e.jsx(_.div,{className:E("absolute inset-0 rounded-full border-2",s?"border-amber-400":"border-purple-400"),initial:{scale:.5,opacity:1},animate:{scale:4,opacity:0},exit:{opacity:0},transition:{duration:.8,ease:"easeOut"},style:{width:20,height:20,marginLeft:-10,marginTop:-10}}),e.jsx(_.div,{className:E("absolute inset-0 rounded-full border",s?"border-amber-400/50":"border-purple-400/50"),initial:{scale:.5,opacity:1},animate:{scale:5,opacity:0},exit:{opacity:0},transition:{duration:1,ease:"easeOut",delay:.1},style:{width:20,height:20,marginLeft:-10,marginTop:-10}}),e.jsx(_.div,{className:E("absolute rounded-full",s?"bg-amber-400":"bg-purple-400"),initial:{scale:0,opacity:.8},animate:{scale:[0,2.5,0],opacity:[.8,.4,0]},exit:{opacity:0},transition:{duration:.6,ease:"easeOut"},style:{width:24,height:24,marginLeft:-12,marginTop:-12,filter:"blur(6px)"}}),Array.from({length:8}).map((r,i)=>{const o=i/8*Math.PI*2,c=30+Math.random()*20;return e.jsx(_.div,{className:E("absolute w-1.5 h-1.5 rounded-full",s?"bg-amber-400":"bg-purple-400"),initial:{x:0,y:0,scale:1,opacity:1},animate:{x:Math.cos(o)*c,y:Math.sin(o)*c,scale:0,opacity:0},exit:{opacity:0},transition:{duration:.6+Math.random()*.3,ease:"easeOut",delay:Math.random()*.1},style:{marginLeft:-3,marginTop:-3}},`particle-${i}`)}),e.jsx(_.div,{className:E("absolute",s?"text-amber-400":"text-purple-400"),initial:{scale:0,rotate:0,opacity:1},animate:{scale:[0,1.5,0],rotate:180,opacity:[1,1,0]},exit:{opacity:0},transition:{duration:.8,ease:"easeOut"},style:{marginLeft:-8,marginTop:-30},children:e.jsx(se,{className:"w-4 h-4"})}),e.jsx(_.div,{className:E("absolute",s?"text-yellow-300":"text-purple-300"),initial:{scale:0,rotate:0,opacity:1},animate:{scale:[0,1.2,0],rotate:-90,opacity:[1,1,0]},exit:{opacity:0},transition:{duration:.7,ease:"easeOut",delay:.1},style:{marginLeft:15,marginTop:-20},children:e.jsx(et,{className:"w-3 h-3"})}),e.jsx(_.div,{className:E("absolute",s?"text-amber-300":"text-purple-300"),initial:{scale:0,y:0,opacity:1},animate:{scale:[0,1,0],y:-25,opacity:[1,1,0]},exit:{opacity:0},transition:{duration:.6,ease:"easeOut",delay:.15},style:{marginLeft:-20,marginTop:-15},children:e.jsx(Be,{className:"w-3 h-3"})})]})})),ry=({milestone:t,pos:s,index:a,progress:r,sortedMilestones:i})=>{const o=t.milestone_percent,c=r>=o||!!t.completed_at,l=a<i.length-1?i[a+1].milestone_percent:101,u=r>=o&&r<l,m=t.is_postcard_milestone,p=o===100||a===i.length-1,h=a===0,f=m?s.size*1.3:s.size,d=n.useRef(c),[g,y]=n.useState(!1);n.useEffect(()=>{c&&!d.current&&!h&&y(!0),d.current=c},[c,h]);const v=()=>{y(!1)};return e.jsxs(_.div,{className:"absolute transform -translate-x-1/2 -translate-y-1/2",style:{left:`${s.x}%`,top:`${s.y}%`},initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},transition:{delay:a*.1,duration:.5},children:[e.jsx(ay,{isRevealing:g,isPostcard:!!m,onComplete:v}),e.jsx(be,{children:c&&e.jsx(_.div,{className:E("absolute inset-0 rounded-full",m?u?"bg-yellow-400":"bg-yellow-400/50":u?"bg-primary":"bg-primary/50"),style:{width:f*3,height:f*3,marginLeft:-f,marginTop:-f,filter:"blur(8px)"},initial:g?{scale:0,opacity:0}:{scale:1,opacity:.5},animate:u?{scale:[1,1.3,1],opacity:[.5,.8,.5]}:{scale:1,opacity:.5},exit:{scale:0,opacity:0},transition:g?{scale:{duration:.5,ease:"easeOut"},opacity:{duration:.5,ease:"easeOut"}}:{duration:2,repeat:u?1/0:0,ease:"easeInOut"}})}),e.jsx(_.div,{className:E("rounded-full relative z-10",c?m?"bg-gradient-to-br from-yellow-400 via-amber-300 to-yellow-500 shadow-[0_0_10px_rgba(250,204,21,0.5)]":"bg-gradient-to-br from-primary via-purple-400 to-primary shadow-[0_0_10px_rgba(167,108,255,0.5)]":"bg-muted/30 border border-muted/50"),style:{width:f,height:f},animate:g?{scale:[.5,1.4,1],rotate:[0,180,360]}:u?{boxShadow:m?["0 0 10px rgba(250,204,21,0.5)","0 0 20px rgba(250,204,21,0.8)","0 0 10px rgba(250,204,21,0.5)"]:["0 0 10px rgba(167,108,255,0.5)","0 0 20px rgba(167,108,255,0.8)","0 0 10px rgba(167,108,255,0.5)"]}:{},transition:g?{duration:.6,ease:"easeOut"}:{duration:1.5,repeat:1/0,ease:"easeInOut"}}),e.jsx("div",{className:E("absolute top-full mt-1 left-1/2 -translate-x-1/2 text-[10px] font-medium whitespace-nowrap flex items-center gap-0.5 max-w-[60px] overflow-hidden",c?m?"text-yellow-400":"text-primary":"text-muted-foreground/50",p&&c&&"text-yellow-400"),children:e.jsx(be,{mode:"wait",children:h?e.jsx(_.span,{className:"font-semibold",initial:{opacity:1},animate:{opacity:1},children:"Start"},"start"):c?m?e.jsx(_.div,{initial:{opacity:0,scale:0,rotate:-180},animate:{opacity:1,scale:1,rotate:0},transition:{type:"spring",stiffness:300,damping:20,delay:g?.3:0},children:e.jsx(zs,{className:"w-3 h-3"})},"postcard"):e.jsx(_.span,{className:"truncate",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{type:"spring",stiffness:300,damping:20,delay:g?.3:0},children:t.title.slice(0,8)},"title"):e.jsx(_.div,{initial:{opacity:1},exit:{opacity:0,scale:0,rotate:180},transition:{duration:.3},children:e.jsx(sy,{milestone:t,currentProgress:r,isPostcard:!!m})},"mystery")})})]})},ny=t=>{switch(t){case"sick":return"saturate-50 brightness-75";case"sad":return"saturate-75 brightness-90";case"worried":return"saturate-90";default:return""}},iy=n.memo(function({progress:s,targetDays:a,className:r,companionImageUrl:i,companionMood:o,showCompanion:c=!0,milestones:l,epicId:u,transparentBackground:m=!1}){const{pathImageUrl:p,isGenerating:h}=An(u),f=n.useMemo(()=>!l||l.length===0?[{id:"start",title:"Start",milestone_percent:0,is_postcard_milestone:!1,completed_at:null},{id:"end",title:"Finish",milestone_percent:100,is_postcard_milestone:!0,completed_at:null}]:[{id:"start",title:"Start",milestone_percent:0,is_postcard_milestone:!1,completed_at:new Date().toISOString()},...l].sort((x,j)=>x.milestone_percent-j.milestone_percent),[l]),d=n.useMemo(()=>ey(f.length),[f.length]),g=n.useMemo(()=>{const b=x=>{const j=Math.sin(x*9999)*1e4;return j-Math.floor(j)};return Array.from({length:20},(x,j)=>({x:b(j*1)*100,y:b(j*2+.5)*100,size:1+b(j*3+.7)*2,delay:b(j*4+.3)*3,duration:2+b(j*5+.9)*2}))},[]),v=(b=>{const x=Math.max(0,Math.min(100,b)),j=Math.round(x/100*120);return{border:`hsl(${j}, 70%, 50%)`,glowStrong:`hsla(${j}, 80%, 60%, 0.4)`,glowMedium:`hsla(${j}, 80%, 60%, 0.3)`,glowSoft:`hsla(${j}, 70%, 40%, 0.2)`,glowInner:`hsla(${j}, 80%, 60%, 0.1)`}})(s);return e.jsxs("div",{className:E("relative w-full h-56 rounded-xl overflow-hidden",!m&&!p&&"bg-gradient-to-br from-slate-950 via-purple-950/50 to-slate-950",r),style:m?void 0:{boxShadow:`
          0 0 10px ${v.glowStrong},
          0 0 20px ${v.glowMedium},
          0 0 40px ${v.glowSoft},
          inset 0 0 15px ${v.glowInner}
        `},children:[p&&e.jsxs("div",{className:"absolute inset-0",children:[e.jsx("img",{src:p,alt:"Journey path",className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-slate-950/90 via-slate-950/50 to-slate-950/70"})]}),h&&!p&&e.jsxs("div",{className:"absolute inset-0 bg-gradient-to-br from-slate-950 via-purple-950/50 to-slate-950",children:[e.jsx(_.div,{className:"absolute inset-0 bg-gradient-to-r from-transparent via-primary/10 to-transparent",animate:{x:["-100%","100%"]},transition:{duration:2,repeat:1/0,ease:"linear"}}),e.jsxs("div",{className:"absolute bottom-2 left-2 text-xs text-primary/60 flex items-center gap-1",children:[e.jsx(se,{className:"w-3 h-3 animate-pulse"}),e.jsx("span",{children:"Mapping your path..."})]})]}),!p&&!m&&e.jsxs("div",{className:"absolute inset-0 opacity-40",children:[e.jsx("div",{className:"absolute top-1/2 left-1/3 w-24 h-24 bg-primary/30 rounded-full blur-xl"}),e.jsx("div",{className:"absolute top-1/3 right-1/4 w-16 h-16 bg-purple-500/20 rounded-full blur-lg"})]}),g.map((b,x)=>e.jsx(_.div,{className:"absolute rounded-full bg-white/60",style:{left:`${b.x}%`,top:`${b.y}%`,width:b.size,height:b.size},animate:{opacity:[.2,.8,.2],scale:[1,1.2,1]},transition:{duration:b.duration,delay:b.delay,repeat:1/0,ease:"easeInOut"}},`bg-${x}`)),e.jsxs("svg",{className:"absolute inset-0 w-full h-full",viewBox:"0 0 100 100",preserveAspectRatio:"none",children:[e.jsxs("defs",{children:[e.jsxs("linearGradient",{id:"pulseGradient",x1:"0%",y1:"0%",x2:"100%",y2:"0%",children:[e.jsx("stop",{offset:"0%",stopColor:"hsl(var(--primary) / 0.15)"}),e.jsx("stop",{offset:"40%",stopColor:"hsl(var(--primary) / 0.15)"}),e.jsx("stop",{offset:"50%",stopColor:"hsl(var(--primary) / 0.8)"}),e.jsx("stop",{offset:"60%",stopColor:"hsl(var(--primary) / 0.15)"}),e.jsx("stop",{offset:"100%",stopColor:"hsl(var(--primary) / 0.15)"}),e.jsx("animate",{attributeName:"x1",values:"-100%;100%",dur:"2.5s",repeatCount:"indefinite"}),e.jsx("animate",{attributeName:"x2",values:"0%;200%",dur:"2.5s",repeatCount:"indefinite"})]}),e.jsxs("filter",{id:"trailGlow",x:"-50%",y:"-50%",width:"200%",height:"200%",children:[e.jsx("feGaussianBlur",{stdDeviation:"1",result:"blur"}),e.jsxs("feMerge",{children:[e.jsx("feMergeNode",{in:"blur"}),e.jsx("feMergeNode",{in:"SourceGraphic"})]})]})]}),e.jsx("path",{d:Yi(d),fill:"none",stroke:"hsl(var(--muted) / 0.15)",strokeWidth:"1.5",strokeLinecap:"round",strokeLinejoin:"round"}),e.jsx("path",{d:Yi(d),fill:"none",stroke:"url(#pulseGradient)",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",opacity:"0.7"}),s>0&&e.jsx(_.path,{d:ty(d,s),fill:"none",stroke:"hsl(var(--primary))",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",filter:"url(#trailGlow)",initial:{pathLength:0,opacity:0},animate:{pathLength:1,opacity:1},transition:{duration:1.5,ease:"easeOut"}})]}),d.map((b,x)=>e.jsx(ry,{milestone:f[x],pos:b,index:x,progress:s,sortedMilestones:f},`star-${f[x].id}`)),c&&i&&e.jsxs(_.div,{className:"absolute transform -translate-x-1/2 -translate-y-1/2 z-20",style:{left:`${an(s,d).x}%`,top:`${an(s,d).y}%`},initial:{scale:0,opacity:0},animate:{scale:1,opacity:1,y:[0,-4,0]},transition:{scale:{duration:.5},opacity:{duration:.5},y:{duration:2,repeat:1/0,ease:"easeInOut"}},children:[e.jsx(_.div,{className:"absolute inset-0 rounded-full bg-primary/40",style:{width:36,height:36,marginLeft:-4,marginTop:-4,filter:"blur(6px)"},animate:{scale:[1,1.2,1],opacity:[.4,.7,.4]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}}),e.jsx("div",{className:E("w-7 h-7 rounded-full border-2 border-primary overflow-hidden bg-background shadow-lg",ny(o)),children:e.jsx("img",{src:i,alt:"Companion",className:"w-full h-full object-cover"})})]}),e.jsxs("div",{className:"absolute bottom-2 right-3 flex items-center gap-1.5",children:[e.jsxs("div",{className:"text-xs font-bold text-primary",children:[s,"%"]}),e.jsx("div",{className:"w-8 h-1 bg-muted/20 rounded-full overflow-hidden",children:e.jsx(_.div,{className:"h-full bg-gradient-to-r from-primary to-purple-400",initial:{width:0},animate:{width:`${s}%`},transition:{duration:1}})})]}),e.jsx("div",{className:"absolute top-2 left-3 text-[10px] uppercase tracking-wider text-muted-foreground/60 font-medium",children:"Star Path Journey"})]})}),br=t=>{const{user:s}=ce(),a=Se(),{data:r=[],isLoading:i,error:o}=ye({queryKey:["milestones",t],queryFn:async()=>{if(!s||!t)return[];const{data:S,error:M}=await N.from("epic_milestones").select("*").eq("epic_id",t).eq("user_id",s.id).order("phase_order",{ascending:!0,nullsFirst:!0}).order("milestone_percent",{ascending:!0});if(M)throw M;return S},enabled:!!s&&!!t,staleTime:180*1e3}),c=n.useMemo(()=>r.reduce((M,C)=>{const R=C.phase_name||"General",T=C.phase_order??0,q=M.find(k=>k.phaseName===R);return q?q.milestones.push(C):M.push({phaseName:R,phaseOrder:T,milestones:[C]}),M},[]).sort((M,C)=>M.phaseOrder-C.phaseOrder),[r]),l=r.filter(S=>S.completed_at).length,u=r.length,m=r.find(S=>!S.completed_at),p=r.filter(S=>S.is_postcard_milestone),h=n.useCallback(()=>{for(const S of c)if(S.milestones.filter(C=>!C.completed_at).length>0)return S.phaseName;return c[c.length-1]?.phaseName||null},[c]),f=n.useCallback(()=>{const S=new Date;S.setHours(0,0,0,0);const M=h();return c.map(C=>{const R=C.milestones.filter(I=>I.completed_at).length,T=C.milestones.length,q=T>0?R/T*100:0,k=C.milestones.filter(I=>I.target_date).map(I=>new Date(I.target_date)).sort((I,te)=>I.getTime()-te.getTime()),P=k[0]||null,A=k[k.length-1]||null,L=C.milestones.filter(I=>I.completed_at||!I.target_date?!1:new Date(I.target_date)<S),H=A?Je(A,S):null;return{phaseName:C.phaseName,phaseOrder:C.phaseOrder,completed:R,total:T,progress:q,isComplete:q===100,isCurrent:C.phaseName===M,isOnTrack:L.length===0,overdueMilestones:L.length,daysUntilEnd:H,startDate:P,endDate:A}})},[c,h]),d=n.useCallback(()=>f().find(C=>C.isCurrent)?.progress??0,[f]),g=n.useCallback((S,M)=>{if(!S||!M||u===0)return null;const C=new Date,R=new Date(S),T=new Date(M),q=Je(T,R),k=Je(C,R);if(Je(T,C),q<=0)return null;const P=u>0?l/u*100:0,A=Math.min(100,k/q*100),L=P-A,H=k>0?P/k:0;let I=null;if(H>0){const $=(100-P)/H;I=new Date,I.setDate(I.getDate()+$)}const te=H>0&&I?Je(T,I):0;let V;L>=10?V="A":L>=0?V="B":L>=-10?V="C":L>=-25?V="D":V="F";const W=f().find(U=>U.isCurrent);let Q="on_track";return W&&W.overdueMilestones>0&&(Q=W.overdueMilestones>1?"behind":"at_risk"),{score:V,overallProgress:P,expectedProgress:A,progressDelta:L,velocity:H,estimatedCompletionDate:I,daysAheadOrBehind:te,currentPhaseHealth:Q}},[l,u,f]),y=n.useCallback(S=>{if(S.completed_at||!S.target_date)return!1;const M=new Date(S.target_date),C=new Date;return C.setHours(0,0,0,0),M.setHours(0,0,0,0),M<C},[]),v=n.useCallback(S=>{if(!S.target_date)return null;const M=new Date(S.target_date),C=new Date;C.setHours(0,0,0,0),M.setHours(0,0,0,0);const R=M.getTime()-C.getTime();return Math.ceil(R/(1e3*60*60*24))},[]),b=n.useCallback(()=>r.find(S=>S.is_postcard_milestone&&!S.completed_at),[r]),x=n.useCallback(()=>{const S=b();if(!S)return null;const M=u>0?l/u*100:0,C=S.milestone_percent;return{current:M,target:C,remaining:Math.max(0,C-M),milestone:S}},[b,l,u]),j=ie({mutationFn:async({milestoneId:S,epicId:M,onPostcardTrigger:C})=>{if(!s)throw new Error("Not authenticated");const R=r.find(q=>q.id===S);if(!R)throw new Error("Milestone not found");const{error:T}=await N.from("epic_milestones").update({completed_at:new Date().toISOString(),updated_at:new Date().toISOString()}).eq("id",S).eq("user_id",s.id);if(T)throw T;return{milestone:R,onPostcardTrigger:C}},onSuccess:({milestone:S,onPostcardTrigger:M})=>{a.invalidateQueries({queryKey:["milestones",t]}),a.invalidateQueries({queryKey:["epics"]}),X.success(`Milestone completed: ${S.title}`),S.is_postcard_milestone&&M&&M(S)},onError:S=>{console.error("Failed to complete milestone:",S),X.error("Failed to complete milestone")}}),w=ie({mutationFn:async S=>{if(!s)throw new Error("Not authenticated");const{error:M}=await N.from("epic_milestones").update({completed_at:null,updated_at:new Date().toISOString()}).eq("id",S).eq("user_id",s.id);if(M)throw M},onSuccess:()=>{a.invalidateQueries({queryKey:["milestones",t]}),a.invalidateQueries({queryKey:["epics"]}),X.success("Milestone unmarked")},onError:S=>{console.error("Failed to uncomplete milestone:",S),X.error("Failed to update milestone")}}),D=ie({mutationFn:async S=>{if(!s)throw new Error("Not authenticated");let M=5;S.targetDays<=14?M=3:S.targetDays<=30?M=4:S.targetDays<=60?M=5:M=6;const C=new Date(S.startDate),R=Array.from({length:M},(q,k)=>{const P=Math.round((k+1)/M*100),A=Math.floor(S.targetDays*P/100),L=new Date(C);return L.setDate(L.getDate()+A),{epic_id:S.epicId,user_id:s.id,title:k===M-1?"The Finale":`Chapter ${k+1}`,description:k===M-1?"Complete your epic journey!":`Reach ${P}% of your goal`,target_date:L.toISOString().split("T")[0],milestone_percent:P,is_postcard_milestone:!0,phase_order:k+1,chapter_number:k+1}}),{error:T}=await N.from("epic_milestones").insert(R);if(T)throw T;return R},onSuccess:()=>{a.invalidateQueries({queryKey:["milestones",t]}),a.invalidateQueries({queryKey:["epics"]})},onError:S=>{console.error("Failed to backfill milestones:",S)}});return{milestones:r,milestonesByPhase:c,isLoading:i,error:o,completedCount:l,totalCount:u,nextMilestone:m,postcardMilestones:p,completeMilestone:j,uncompleteMilestone:w,getCurrentPhase:h,getPhaseStats:f,getCurrentPhaseProgress:d,getJourneyHealth:g,isMilestoneOverdue:y,getDaysUntilMilestone:v,getNextPostcardMilestone:b,getProgressToNextPostcard:x,backfillLegacyMilestones:D,isCompleting:j.isPending,isBackfilling:D.isPending}},oy=()=>{const{user:t}=ce(),s=Se(),[a,r]=n.useState(null),i=n.useCallback(()=>{r(null)},[]),{data:o,isLoading:c,error:l}=ye({queryKey:["companion-postcards",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:h,error:f}=await N.from("companion_postcards").select("*").eq("user_id",t.id).order("generated_at",{ascending:!1});if(f)throw f;return h},enabled:!!t?.id}),u=ie({mutationFn:async({companionId:h,epicId:f,milestonePercent:d,companionData:g,milestoneTitle:y})=>{if(!t?.id)throw new Error("Not authenticated");const{data:v,error:b}=await N.functions.invoke("generate-cosmic-postcard",{body:{userId:t.id,companionId:h,epicId:f,milestonePercent:d,companionData:g}});if(b)throw b;if(v?.error)throw new Error(v.error);return{...v,milestoneTitle:y}},onSuccess:async h=>{if(!h?.existing&&(s.invalidateQueries({queryKey:["companion-postcards"]}),r({milestoneTitle:h?.milestoneTitle,chapterNumber:h?.postcard?.chapter_number,locationName:h?.postcard?.location_name}),X.success("ðŸ“¸ New cosmic postcard unlocked!",{description:`Your companion visited ${h?.postcard?.location_name}!`}),h?.postcard?.chapter_number&&h?.postcard?.epic_id&&t?.id))try{await N.functions.invoke("generate-journey-path",{body:{epicId:h.postcard.epic_id,milestoneIndex:h.postcard.chapter_number,userId:t.id}}),s.invalidateQueries({queryKey:["journey-path",h.postcard.epic_id]})}catch(f){console.error("Failed to regenerate journey path:",f)}},onError:h=>{console.error("Failed to generate postcard:",h)}}),m=n.useCallback(async(h,f,d,g,y)=>{const v=[25,50,75,100];for(const b of v)if(d<b&&f>=b&&!o?.find(j=>j.epic_id===h&&j.milestone_percent===b)){u.mutate({companionId:g,epicId:h,milestonePercent:b,companionData:y});break}},[o,u]),p=n.useCallback(async(h,f,d,g)=>{if(!t?.id)return;const{data:y,error:v}=await N.from("epic_milestones").select("id, title, milestone_percent, is_postcard_milestone").eq("id",h).maybeSingle();if(v){console.error("Failed to fetch milestone:",v);return}if(!y){console.log("Milestone not found");return}if(!y.is_postcard_milestone){console.log("Milestone is not marked for postcard generation");return}if(o?.find(x=>x.epic_id===f&&x.milestone_percent===y.milestone_percent)){console.log("Postcard already exists for this milestone");return}u.mutate({companionId:d,epicId:f,milestonePercent:y.milestone_percent,companionData:g,milestoneTitle:y.title})},[t?.id,o,u]);return{postcards:o||[],isLoading:c,error:l,generatePostcard:u,checkAndGeneratePostcard:m,checkMilestoneForPostcard:p,isGenerating:u.isPending,postcardJustUnlocked:a,clearPostcardUnlocked:i}};function yd(){const[t,s]=n.useState(null),[a,r]=n.useState(!1),[i,o]=n.useState(null),c=n.useCallback(async b=>{r(!0),o(null);try{const{data:x,error:j}=await N.functions.invoke("generate-journey-schedule",{body:b});if(j)throw j;if(x?.error)throw new Error(x.error);const w=x;return s(w),w}catch(x){const j=x instanceof Error?x.message:"Failed to generate schedule";return o(j),console.error("Failed to generate schedule:",x),null}finally{r(!1)}},[]),l=n.useCallback(async b=>{r(!0),o(null);try{const{data:x,error:j}=await N.functions.invoke("generate-journey-schedule",{body:b});if(j)throw j;if(x?.error)throw new Error(x.error);const w=x;return s(w),w}catch(x){const j=x instanceof Error?x.message:"Failed to adjust schedule";return o(j),console.error("Failed to adjust schedule:",x),null}finally{r(!1)}},[]),u=7,m=n.useMemo(()=>t?.milestones.filter(b=>b.isPostcardMilestone).length??0,[t]),p=n.useCallback(b=>{s(x=>{if(!x)return x;const j=x.milestones.find(w=>w.id===b);return!j||!j.isPostcardMilestone&&x.milestones.filter(D=>D.isPostcardMilestone).length>=u?x:{...x,milestones:x.milestones.map(w=>w.id===b?{...w,isPostcardMilestone:!w.isPostcardMilestone}:w)}})},[]),h=n.useCallback(b=>{s(x=>x&&{...x,rituals:x.rituals.map(j=>j.id===b.id?b:j)})},[]),f=n.useCallback(b=>{s(x=>x&&{...x,rituals:[...x.rituals,b]})},[]),d=n.useCallback(b=>{s(x=>x&&{...x,rituals:x.rituals.filter(j=>j.id!==b)})},[]),g=n.useCallback(b=>{s(x=>x&&{...x,rituals:b})},[]),y=n.useCallback((b,x)=>{s(j=>j&&{...j,milestones:j.milestones.map(w=>w.id===b?{...w,targetDate:x}:w)})},[]),v=n.useCallback(()=>{s(null),o(null),r(!1)},[]);return{schedule:t,isLoading:a,error:i,generateSchedule:c,adjustSchedule:l,toggleMilestone:p,updateRitual:h,addRitual:f,removeRitual:d,setRituals:g,updateMilestoneDate:y,reset:v,postcardCount:m,maxPostcards:u}}function ly(t,s,a,r,i){const{milestones:o,completedCount:c,totalCount:l,getPhaseStats:u,getCurrentPhase:m,getJourneyHealth:p}=br(t);return n.useMemo(()=>{const h=new Date,f=m(),d=u(),g=p(r,i),y=[],v=[];o.filter(I=>I.completed_at);const b=l,x=[...o].sort((I,te)=>new Date(I.target_date||0).getTime()-new Date(te.target_date||0).getTime()),j=r?new Date(r):x[0]?.target_date?new Date(x[0].target_date):h,w=i?new Date(i):x[x.length-1]?.target_date?new Date(x[x.length-1].target_date):h,D=Math.max(1,Je(h,j));Math.max(1,Je(w,j)),Math.max(0,Je(w,h));const S=c/D,M=b-c,C=S>0?M/S:1/0,R=S>0?new Date(h.getTime()+C*24*60*60*1e3):null,T=R?Je(w,R):-999,q=[];if(s&&s.length>0){const I=new Map;s.forEach(te=>{const V=I.get(te.habit_id)||{completions:[],title:te.habit?.title||"Unknown"};V.completions.push(new Date(te.completed_at)),I.set(te.habit_id,V)}),I.forEach((te,V)=>{const W=te.completions.filter(je=>Je(h,je)<=30),Q={},U={0:0,1:0,2:0,3:0,4:0,5:0,6:0},$={0:0,1:0,2:0,3:0,4:0,5:0,6:0};W.forEach(je=>{U[je.getDay()]++});for(let je=0;je<30;je++){const ke=gn(h,je);$[ke.getDay()]++}for(let je=0;je<7;je++)Q[je.toString()]=$[je]>0?U[je]/$[je]:0;const J=Math.floor(W.length/2),O=W.slice(0,J).length,le=W.slice(J).length;let G="stable";le>O*1.2?G="improving":le<O*.8&&(G="declining");const Z=W.length/30,ve=Object.entries(Q).sort((je,ke)=>je[1]-ke[1]).slice(0,2).filter(([,je])=>je<.3).map(([je])=>["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][parseInt(je)]);let we;ve.length>0?we=`You often skip this on ${ve.join(" and ")}. Consider a lighter version for those days.`:G==="declining"&&(we="Your completion rate is declining. Maybe simplify or reschedule?"),q.push({habitId:V,habitTitle:te.title,completionRate:Z,weekdayRates:Q,trend:G,suggestion:we})})}let k=null,P=!1;const A=a?Je(h,a):0;if(T<-7&&(P=!0,k="behind_schedule",y.push({type:"warning",priority:"high",title:"You're falling behind",description:`At your current pace, you'll finish ${Math.abs(T)} days late. Let's adjust your plan.`,action:{label:"Get back on track",adjustmentText:"I'm behind schedule. Please help me get back on track by redistributing milestones or simplifying the plan."}}),v.push({label:"Get Back on Track",description:"AI will redistribute milestones to match your pace",adjustmentText:"I'm behind schedule. Redistribute milestones realistically based on my current pace, prioritizing the most important ones.",icon:"target",priority:"primary"})),T>7&&(y.push({type:"celebration",priority:"low",title:"You're ahead of schedule!",description:`You're on track to finish ${T} days early. Consider accelerating or adding depth.`,action:{label:"Accelerate journey",adjustmentText:"I'm ahead of schedule! Please compress my timeline or add more challenging milestones."}}),v.push({label:"Accelerate Journey",description:"Compress timeline since you're ahead",adjustmentText:"I'm ahead of schedule. Compress my timeline or add more challenging milestones to maximize growth.",icon:"rocket",priority:"secondary"})),g&&(g.score==="D"||g.score==="F")){P=!0,k=k||"poor_health";const I=g.progressDelta<-20?"You're significantly behind expected progress":"Your journey needs attention to stay on track";y.push({type:"warning",priority:"high",title:"Journey needs attention",description:I,action:{label:"Review & adjust",adjustmentText:`My journey health is poor. ${I}. Please suggest adjustments to get back on track.`}})}A>5&&(P=!0,k=k||"inactive",y.push({type:"suggestion",priority:"medium",title:"Welcome back!",description:`It's been ${A} days since your last activity. Let's reassess your timeline.`,action:{label:"Adjust for break",adjustmentText:`I took a ${A}-day break. Please adjust my milestones to account for this time away.`}}),v.push({label:"Adjust for Break",description:`Account for your ${A}-day break`,adjustmentText:`I took a ${A}-day break. Shift my remaining milestones forward while keeping the overall pace realistic.`,icon:"clock",priority:"primary"}));const L=q.filter(I=>I.completionRate<.3);L.length>0&&(y.push({type:"suggestion",priority:"medium",title:"Some habits need attention",description:`${L.map(I=>I.habitTitle).join(", ")} have low completion rates.`,action:{label:"Simplify routine",adjustmentText:`I'm struggling with these habits: ${L.map(I=>I.habitTitle).join(", ")}. Please suggest easier alternatives or reduced frequency.`}}),v.push({label:"Simplify Routine",description:"Make struggling habits more achievable",adjustmentText:`These habits are hard to maintain: ${L.map(I=>I.habitTitle).join(", ")}. Suggest simpler versions or reduced frequency.`,icon:"shield",priority:"secondary"}));const H=d.find(I=>I.phaseName===f);if(H&&!H.isOnTrack&&H.daysUntilEnd!==null&&H.daysUntilEnd<7){const I=H.total-H.completed;y.push({type:"warning",priority:"high",title:"Phase deadline approaching",description:`Only ${H.daysUntilEnd} days left in "${H.phaseName}" with ${I} milestones to go.`,action:{label:"Redistribute phase",adjustmentText:`I'm running out of time in the "${H.phaseName}" phase. Please redistribute remaining milestones.`}})}return v.length===0&&v.push({label:"Optimize Timeline",description:"Let AI analyze and improve your schedule",adjustmentText:"Analyze my current progress and optimize the remaining timeline for best results.",icon:"sparkles",priority:"primary"},{label:"Add Buffer Time",description:"Extend deadline by 2 weeks",adjustmentText:"Add 2 weeks of buffer time to my journey and redistribute milestones accordingly.",icon:"clock",priority:"secondary"}),v.find(I=>I.label==="Simplify Routine")||v.push({label:"Focus on Essentials",description:"Keep only the most impactful milestones",adjustmentText:"Simplify my journey to focus on the most essential milestones. Remove or combine less critical ones.",icon:"target",priority:"secondary"}),{shouldShowAdvisor:P,advisorTrigger:k,insights:y,habitPatterns:q,velocityPerDay:S,estimatedCompletionDate:R,daysAheadOrBehind:T,smartQuickActions:v.slice(0,4)}},[o,c,l,s,a,r,i,u,m,p])}const Vi={rocket:Ga,clock:lt,target:Ze,sparkles:se,shield:Bt};function cy({epicId:t,onSelectAdjustment:s,onDismiss:a,variant:r="card",className:i}){const[o,c]=n.useState(!1),[l,u]=n.useState(!1),{user:m}=ce(),{data:p}=ye({queryKey:["epic-details",t],queryFn:async()=>{const{data:b,error:x}=await N.from("epics").select("start_date, end_date, epic_habits(habit_id)").eq("id",t).maybeSingle();if(x)throw x;return b||null},enabled:!!t}),{data:h}=ye({queryKey:["epic-habit-completions",t,m?.id],queryFn:async()=>{if(!m?.id||!p?.epic_habits?.length)return[];const b=p.epic_habits.map(D=>D.habit_id),x=Y(gn(new Date,30),"yyyy-MM-dd"),{data:j,error:w}=await N.from("habit_completions").select("habit_id, date, habits(title)").eq("user_id",m.id).in("habit_id",b).gte("date",x);if(w)throw w;return(j||[]).map(D=>({habit_id:D.habit_id,completed_at:D.date,habit:D.habits}))},enabled:!!m?.id&&!!p?.epic_habits?.length}),{data:f}=ye({queryKey:["last-epic-activity",t,m?.id],queryFn:async()=>{if(!m?.id)return null;const{data:b,error:x}=await N.from("epic_progress_log").select("date").eq("epic_id",t).eq("user_id",m.id).order("date",{ascending:!1}).limit(1).maybeSingle();if(x&&x.code!=="PGRST116")throw x;return b?.date?new Date(b.date):void 0},enabled:!!m?.id&&!!t}),d=ly(t,h,f,p?.start_date,p?.end_date),g=()=>{c(!0),a?.()};if(o||!d.shouldShowAdvisor&&r!=="inline")return null;const y=d.insights[0],v=d.smartQuickActions.find(b=>b.priority==="primary");return r==="banner"?e.jsx(be,{children:e.jsx(_.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:E("bg-gradient-to-r from-primary/10 via-primary/5 to-transparent","border border-primary/20 rounded-lg p-3",i),children:e.jsxs("div",{className:"flex items-center justify-between gap-3",children:[e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0",children:e.jsx(se,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-sm font-medium truncate",children:y?.title||"Journey Check-in"}),e.jsx("p",{className:"text-xs text-muted-foreground truncate",children:y?.description||"Get suggestions to optimize your plan"})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[v&&e.jsxs(B,{size:"sm",variant:"default",className:"text-xs h-7 gap-1",onClick:()=>s(v.adjustmentText),children:[v.label,e.jsx(tt,{className:"w-3 h-3"})]}),e.jsx(B,{size:"icon",variant:"ghost",className:"h-6 w-6",onClick:g,children:e.jsx(Qe,{className:"w-3 h-3"})})]})]})})}):r==="inline"?e.jsxs("div",{className:E("space-y-3",i),children:[e.jsx("div",{className:"grid grid-cols-2 gap-2",children:d.smartQuickActions.map((b,x)=>{const j=Vi[b.icon];return e.jsx(_.button,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{delay:x*.05},onClick:()=>s(b.adjustmentText),className:E("p-3 rounded-lg text-left transition-all","hover:scale-[1.02] active:scale-[0.98]",b.priority==="primary"?"bg-primary/10 border border-primary/30 hover:bg-primary/20":"bg-secondary/50 border border-border/50 hover:bg-secondary"),children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:E("w-7 h-7 rounded-full flex items-center justify-center flex-shrink-0",b.priority==="primary"?"bg-primary/20":"bg-muted"),children:e.jsx(j,{className:E("w-3.5 h-3.5",b.priority==="primary"?"text-primary":"text-muted-foreground")})}),e.jsxs("div",{className:"min-w-0",children:[e.jsx("p",{className:"text-xs font-medium",children:b.label}),e.jsx("p",{className:"text-[10px] text-muted-foreground line-clamp-2",children:b.description})]})]})},x)})}),d.insights.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("button",{onClick:()=>u(!l),className:"flex items-center gap-1.5 text-xs text-muted-foreground hover:text-foreground transition-colors",children:[e.jsx(mn,{className:"w-3 h-3"}),e.jsxs("span",{children:[d.insights.length," insight",d.insights.length>1?"s":""," available"]}),e.jsx(tt,{className:E("w-3 h-3 transition-transform",l&&"rotate-90")})]}),e.jsx(be,{children:l&&e.jsx(_.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:"space-y-2 overflow-hidden",children:d.insights.map((b,x)=>e.jsx(Xi,{insight:b,onAction:s},x))})})]}),d.estimatedCompletionDate&&e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground bg-secondary/30 rounded-lg px-3 py-2",children:[d.daysAheadOrBehind>=0?e.jsx(zt,{className:"w-3.5 h-3.5 text-green-500"}):e.jsx(ia,{className:"w-3.5 h-3.5 text-amber-500"}),e.jsxs("span",{children:["Est. completion: ",Y(d.estimatedCompletionDate,"MMM d, yyyy"),d.daysAheadOrBehind!==0&&e.jsxs("span",{className:E("ml-1",d.daysAheadOrBehind>=0?"text-green-500":"text-amber-500"),children:["(",d.daysAheadOrBehind>0?"+":"",d.daysAheadOrBehind," days)"]})]})]})]}):e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:E("bg-card border border-border rounded-xl overflow-hidden",i),children:[e.jsx("div",{className:"px-4 py-3 bg-gradient-to-r from-primary/10 to-transparent border-b border-border/50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-primary/20 flex items-center justify-center",children:e.jsx(se,{className:"w-4 h-4 text-primary"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-semibold",children:"Smart Reschedule"}),e.jsx("p",{className:"text-[10px] text-muted-foreground",children:"Personalized suggestions"})]})]}),e.jsx(B,{size:"icon",variant:"ghost",className:"h-6 w-6",onClick:g,children:e.jsx(Qe,{className:"w-3 h-3"})})]})}),e.jsxs("div",{className:"p-4 space-y-4",children:[y&&e.jsx(Xi,{insight:y,onAction:s,featured:!0}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:d.smartQuickActions.slice(0,2).map((b,x)=>{const j=Vi[b.icon];return e.jsxs(B,{variant:b.priority==="primary"?"default":"outline",size:"sm",className:"h-auto py-2 px-3 justify-start gap-2",onClick:()=>s(b.adjustmentText),children:[e.jsx(j,{className:"w-3.5 h-3.5 flex-shrink-0"}),e.jsx("span",{className:"text-xs truncate",children:b.label})]},x)})}),d.estimatedCompletionDate&&e.jsxs("div",{className:"flex items-center justify-between text-xs bg-secondary/30 rounded-lg px-3 py-2",children:[e.jsx("span",{className:"text-muted-foreground",children:"Projected finish"}),e.jsxs("span",{className:"font-medium flex items-center gap-1",children:[Y(d.estimatedCompletionDate,"MMM d"),d.daysAheadOrBehind>=0?e.jsxs(Ne,{variant:"outline",className:"text-[10px] px-1 py-0 text-green-500 border-green-500/30",children:["+",d.daysAheadOrBehind,"d"]}):e.jsxs(Ne,{variant:"outline",className:"text-[10px] px-1 py-0 text-amber-500 border-amber-500/30",children:[d.daysAheadOrBehind,"d"]})]})]})]})]})}function Xi({insight:t,onAction:s,featured:a=!1}){const r=()=>{switch(t.type){case"warning":return e.jsx(ps,{className:"w-3.5 h-3.5 text-amber-500"});case"celebration":return e.jsx(zt,{className:"w-3.5 h-3.5 text-green-500"});default:return e.jsx(mn,{className:"w-3.5 h-3.5 text-blue-500"})}},i=()=>{switch(t.type){case"warning":return"bg-amber-500/10 border-amber-500/20";case"celebration":return"bg-green-500/10 border-green-500/20";default:return"bg-blue-500/10 border-blue-500/20"}};return e.jsx("div",{className:E("rounded-lg border p-3",i(),a&&"ring-1 ring-primary/20"),children:e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("div",{className:"mt-0.5",children:r()}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium",children:t.title}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:t.description}),t.action&&e.jsxs(B,{size:"sm",variant:"ghost",className:"h-6 px-2 text-[10px] mt-2 gap-1",onClick:()=>s(t.action.adjustmentText),children:[t.action.label,e.jsx(tt,{className:"w-3 h-3"})]})]})]})})}const dy=[{label:"I'm falling behind",value:"I'm falling behind schedule and need more time for each milestone"},{label:"Ahead of schedule",value:"I'm ahead of schedule, please compress the timeline"},{label:"Extend deadline",value:"I need to extend my deadline, please redistribute milestones"},{label:"More milestones",value:"Add more intermediate milestones to track progress better"},{label:"Simplify plan",value:"Simplify the plan with fewer, more focused milestones"}],uy=({epicId:t,epicTitle:s,epicGoal:a,currentDeadline:r,children:i})=>{const[o,c]=n.useState(!1),[l,u]=n.useState(""),[m,p]=n.useState(r?new Date(r):void 0),[h,f]=n.useState("input"),[d,g]=n.useState(!0),{user:y}=ce(),v=Se(),{milestones:b,milestonesByPhase:x,getJourneyHealth:j}=br(t),w=j(),{schedule:D,adjustSchedule:S,isLoading:M,error:C,reset:R}=yd(),T={phases:x.map((I,te)=>({id:`phase-${te}`,name:I.phaseName,description:"",startDate:I.milestones[0]?.target_date||"",endDate:I.milestones[I.milestones.length-1]?.target_date||"",phaseOrder:I.phaseOrder})),milestones:b.map(I=>({id:I.id,title:I.title,description:I.description||"",targetDate:I.target_date||"",phaseOrder:I.phase_order||0,phaseName:I.phase_name||"General",isPostcardMilestone:I.is_postcard_milestone||!1,milestonePercent:I.milestone_percent})),rituals:[]},q=I=>{u(I),g(!1)},k=I=>{u(I),g(!1)},P=async()=>{if(!l.trim()&&m?.toISOString()===r){X.error("Please describe your adjustment or change the deadline");return}await S({goal:a||s,deadline:m?.toISOString()||r,adjustmentRequest:l,previousSchedule:T})&&f("preview")},A=async()=>{if(!(!D||!y)){f("saving");try{const{error:I}=await N.from("epic_milestones").delete().eq("epic_id",t).eq("user_id",y.id);if(I)throw I;const te=D.milestones.map(z=>({epic_id:t,user_id:y.id,title:z.title,description:z.description,milestone_percent:z.milestonePercent,target_date:z.targetDate,phase_name:z.phaseName,phase_order:z.phaseOrder,is_postcard_milestone:z.isPostcardMilestone})),{error:V}=await N.from("epic_milestones").insert(te);if(V)throw V;if(m&&m.toISOString()!==r){const{error:z}=await N.from("epics").update({end_date:m.toISOString()}).eq("id",t).eq("user_id",y.id);if(z)throw z}v.invalidateQueries({queryKey:["milestones",t]}),v.invalidateQueries({queryKey:["epics"]}),X.success("Journey rescheduled!",{description:`${D.milestones.length} milestones updated`}),c(!1),L()}catch(I){console.error("Failed to apply schedule changes:",I),X.error("Failed to update schedule"),f("preview")}}},L=()=>{f("input"),u(""),g(!0),R()},H=I=>{c(I),I||L()};return e.jsxs(Ns,{open:o,onOpenChange:H,handleOnly:!0,shouldScaleBackground:!1,modal:!1,children:[e.jsx(_n,{asChild:!0,children:i||e.jsxs(B,{variant:"outline",size:"sm",className:"gap-1.5 text-xs",children:[e.jsx(us,{className:"w-3.5 h-3.5"}),"Reschedule"]})}),e.jsxs(ks,{className:"max-h-[90vh]",children:[e.jsxs(Cs,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(Ss,{className:"flex items-center gap-2",children:[e.jsx(us,{className:"w-5 h-5 text-primary"}),"Smart Reschedule"]}),w&&e.jsxs(Ne,{variant:"outline",className:E("text-xs",w.score==="A"&&"border-green-500/50 text-green-500",w.score==="B"&&"border-blue-500/50 text-blue-500",w.score==="C"&&"border-amber-500/50 text-amber-500",(w.score==="D"||w.score==="F")&&"border-red-500/50 text-red-500"),children:[e.jsx(Rt,{className:"w-3 h-3 mr-1"}),"Health: ",w.score]})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[h==="input"&&"Personalized suggestions to optimize your journey",h==="preview"&&"Review and apply the new schedule",h==="saving"&&"Applying changes..."]})]}),e.jsx(hr,{className:"flex-1 px-4 max-h-[60vh]",children:e.jsxs(be,{mode:"wait",children:[h==="input"&&e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"space-y-4 pb-4",children:[d&&e.jsx(cy,{epicId:t,onSelectAdjustment:k,onDismiss:()=>g(!1),variant:"inline"}),!d&&e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Quick adjustments"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:dy.map(I=>e.jsx(Ne,{variant:"outline",className:"cursor-pointer hover:bg-primary/10 hover:border-primary/50 transition-colors",onClick:()=>q(I.value),children:I.label},I.label))})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Describe your changes"}),e.jsx(xt,{value:l,onChange:I=>u(I.target.value),placeholder:"e.g., I need to take a 2-week break next month, please adjust milestones around that...",className:"min-h-[100px] resize-none"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Adjust deadline (optional)"}),e.jsxs(Wt,{children:[e.jsx(Qt,{asChild:!0,children:e.jsxs(B,{variant:"outline",className:E("w-full justify-start text-left font-normal",!m&&"text-muted-foreground"),children:[e.jsx(mt,{className:"mr-2 h-4 w-4"}),m?Y(m,"PPP"):"Pick a new deadline"]})}),e.jsx(qt,{className:"w-auto p-0",align:"start",children:e.jsx(Xs,{mode:"single",selected:m,onSelect:p,disabled:I=>I<new Date,initialFocus:!0})})]})]}),e.jsxs("div",{className:"bg-secondary/30 rounded-lg p-3 space-y-1",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Current journey"}),e.jsx("div",{className:"text-sm font-medium",children:s}),e.jsxs("div",{className:"flex gap-3 text-xs text-muted-foreground",children:[e.jsxs("span",{children:[b.length," milestones"]}),e.jsx("span",{children:"â€¢"}),e.jsxs("span",{children:[b.filter(I=>I.completed_at).length," completed"]})]})]}),C&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-destructive bg-destructive/10 rounded-lg p-3",children:[e.jsx(js,{className:"w-4 h-4"}),C]})]},"input"),h==="preview"&&D&&e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"space-y-4 pb-4",children:[e.jsxs("div",{className:E("rounded-lg p-3 border",D.feasibilityAssessment.feasibility==="comfortable"&&"bg-green-500/10 border-green-500/20",D.feasibilityAssessment.feasibility==="achievable"&&"bg-blue-500/10 border-blue-500/20",D.feasibilityAssessment.feasibility==="aggressive"&&"bg-amber-500/10 border-amber-500/20",D.feasibilityAssessment.feasibility==="very_aggressive"&&"bg-red-500/10 border-red-500/20"),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx(se,{className:"w-4 h-4"}),e.jsxs("span",{className:"font-medium text-sm capitalize",children:[D.feasibilityAssessment.feasibility.replace("_"," ")," timeline"]})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:D.feasibilityAssessment.message})]}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground mb-2",children:["New milestones (",D.milestones.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-[200px] overflow-y-auto",children:D.milestones.map((I,te)=>e.jsxs("div",{className:"flex items-center gap-3 p-2 bg-secondary/30 rounded-lg",children:[e.jsx("div",{className:"w-6 h-6 rounded-full bg-primary/20 flex items-center justify-center text-xs font-medium",children:te+1}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx("span",{className:"text-sm font-medium truncate",children:I.title}),I.isPostcardMilestone&&e.jsx(se,{className:"w-3 h-3 text-amber-500 flex-shrink-0"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-[10px] text-muted-foreground",children:[e.jsx("span",{children:I.phaseName}),e.jsx("span",{children:"â€¢"}),e.jsx("span",{children:Y(new Date(I.targetDate),"MMM d")})]})]})]},I.id))})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-secondary/30 rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-lg font-bold",children:b.length}),e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Current milestones"})]}),e.jsxs("div",{className:"bg-primary/10 rounded-lg p-3 text-center border border-primary/20",children:[e.jsx("div",{className:"text-lg font-bold text-primary",children:D.milestones.length}),e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"New milestones"})]})]})]},"preview"),h==="saving"&&e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center py-12",children:[e.jsx(ze,{className:"w-8 h-8 animate-spin text-primary mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Updating your journey..."})]},"saving")]})}),e.jsxs(Nc,{className:"border-t pt-4",children:[h==="input"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(B,{variant:"outline",className:"flex-1",onClick:()=>c(!1),children:"Cancel"}),e.jsx(B,{className:"flex-1 gap-2",onClick:P,disabled:M,children:M?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"w-4 h-4 animate-spin"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-4 h-4"}),"Generate New Schedule"]})})]}),h==="preview"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(B,{variant:"outline",className:"flex-1",onClick:()=>f("input"),children:"Back"}),e.jsxs(B,{className:"flex-1 gap-2",onClick:A,children:[e.jsx(ms,{className:"w-4 h-4"}),"Apply Changes"]})]})]})]})]})},my=({show:t,milestoneTitle:s,chapterNumber:a,onDismiss:r})=>{const[i,o]=n.useState("entering");n.useEffect(()=>{if(t){o("entering"),vn(),Ct.impact({style:it.Heavy}).catch(()=>{});const l=["#F59E0B","#F97316","#FBBF24","#FCD34D","#D97706"];ut({particleCount:80,spread:70,origin:{y:.6},colors:l}),setTimeout(()=>{ut({particleCount:50,angle:60,spread:55,origin:{x:0,y:.6},colors:l}),ut({particleCount:50,angle:120,spread:55,origin:{x:1,y:.6},colors:l})},200),setTimeout(()=>o("main"),300)}},[t]);const c=()=>{o("exiting"),setTimeout(()=>{r()},300)};return t?e.jsx(be,{children:e.jsx(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-50 flex items-center justify-center bg-background/80 backdrop-blur-sm",onClick:c,children:e.jsxs(_.div,{initial:{scale:.8,rotateY:180,opacity:0},animate:i==="exiting"?{scale:.8,opacity:0,y:20}:{scale:1,rotateY:0,opacity:1},transition:{type:"spring",damping:20,stiffness:300,duration:.6},className:"relative w-[85vw] max-w-sm p-6 rounded-2xl bg-gradient-to-br from-amber-500/20 via-orange-500/10 to-yellow-500/20 border border-amber-500/30 shadow-2xl",onClick:l=>l.stopPropagation(),style:{perspective:1e3},children:[e.jsx("div",{className:"absolute inset-0 rounded-2xl bg-amber-500/10 blur-xl"}),e.jsxs("div",{className:"relative z-10 flex flex-col items-center text-center space-y-4",children:[e.jsxs(_.div,{initial:{scale:0},animate:{scale:1},transition:{delay:.3,type:"spring",stiffness:500},className:"relative",children:[e.jsx("div",{className:"w-20 h-20 rounded-2xl bg-gradient-to-br from-amber-400 to-orange-500 flex items-center justify-center shadow-lg",children:e.jsx(pl,{className:"w-10 h-10 text-white"})}),e.jsx(_.div,{animate:{rotate:360},transition:{duration:3,repeat:1/0,ease:"linear"},className:"absolute -top-2 -right-2",children:e.jsx(se,{className:"w-6 h-6 text-amber-400"})}),e.jsx(_.div,{animate:{scale:[1,1.2,1]},transition:{duration:2,repeat:1/0},className:"absolute -bottom-1 -left-2",children:e.jsx(se,{className:"w-5 h-5 text-yellow-400"})})]}),e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.4},children:[e.jsx("h2",{className:"text-xl font-bold bg-gradient-to-r from-amber-400 via-orange-400 to-yellow-500 bg-clip-text text-transparent",children:"Postcard Unlocked!"}),a&&e.jsxs("p",{className:"text-sm text-muted-foreground mt-1",children:["Chapter ",a]})]}),s&&e.jsx(_.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.5},className:"text-sm text-foreground/80 font-medium",children:s}),e.jsx(_.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.6},className:"text-xs text-muted-foreground italic",children:"Your companion is sending you a cosmic memory..."}),e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.7},className:"pt-2",children:e.jsx(B,{onClick:c,className:"bg-gradient-to-r from-amber-500 to-orange-500 hover:from-amber-600 hover:to-orange-600 text-white px-8",children:"Continue"})})]}),e.jsx("button",{onClick:c,className:"absolute top-3 right-3 p-1 rounded-full hover:bg-white/10 transition-colors",children:e.jsx(Qe,{className:"w-4 h-4 text-muted-foreground"})}),e.jsx(se,{className:"absolute top-4 left-4 w-4 h-4 text-amber-400/50"}),e.jsx(se,{className:"absolute bottom-4 right-4 w-4 h-4 text-orange-400/50"})]})})}):null},py=({milestone:t,isOpen:s,onClose:a,onComplete:r,onUncomplete:i,isCompleting:o,status:c,postcard:l,streakMultiplier:u=1})=>{if(!t)return null;const m=c==="completed",p=c==="overdue",h=t.is_postcard_milestone,f=h?xs.POSTCARD:xs.REGULAR,d=Math.round(f*u),y=(()=>{if(!t.target_date)return null;const v=new Date(t.target_date),b=new Date;return b.setHours(0,0,0,0),v.setHours(0,0,0,0),Je(v,b)})();return e.jsx(Ns,{open:s,onOpenChange:v=>!v&&a(),handleOnly:!0,shouldScaleBackground:!1,modal:!1,children:e.jsxs(ks,{className:"max-h-[90vh]",children:[e.jsxs(Cs,{className:"pb-2 border-b border-border/50",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[t.phase_name&&e.jsx(Ne,{variant:"outline",className:"text-xs",children:t.phase_name}),h&&e.jsxs(Ne,{variant:"outline",className:"text-xs text-royal-purple border-royal-purple/30 bg-royal-purple/10",children:[e.jsx(se,{className:"w-3 h-3 mr-1"}),"Celebration"]})]}),e.jsx(B,{variant:"ghost",size:"icon",className:"h-8 w-8",onClick:a,children:e.jsx(Qe,{className:"w-4 h-4"})})]}),e.jsxs(Ss,{className:"text-left flex items-center gap-2 mt-2",children:[e.jsx("span",{children:t.title}),h&&e.jsx(se,{className:"w-4 h-4 text-amber-500"})]})]}),e.jsx("div",{className:"flex-1 max-h-[60vh] overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},"data-vaul-no-drag":!0,children:e.jsxs("div",{className:"px-4 py-4 space-y-5",children:[e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"flex flex-wrap items-center gap-2",children:[m&&e.jsxs(Ne,{className:"bg-green-500/10 text-green-600 border-green-200",children:[e.jsx(ms,{className:"w-3 h-3 mr-1"}),"Completed"]}),p&&e.jsxs(Ne,{variant:"destructive",className:"bg-destructive/10",children:[e.jsx(js,{className:"w-3 h-3 mr-1"}),"Overdue"]}),!m&&!p&&e.jsx(Ne,{variant:"secondary",children:"Pending"}),t.target_date&&e.jsxs("div",{className:E("flex items-center gap-1.5 text-sm",p&&"text-destructive"),children:[e.jsx(mt,{className:"w-3.5 h-3.5"}),e.jsx("span",{children:Y(new Date(t.target_date),"MMM d, yyyy")}),y!==null&&!m&&e.jsxs("span",{className:"text-muted-foreground text-xs",children:["(",y>0?`in ${y} day${y!==1?"s":""}`:y===0?"today":`${Math.abs(y)} day${Math.abs(y)!==1?"s":""} ago`,")"]})]})]}),t.description&&e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.05},className:"space-y-2",children:[e.jsx("h4",{className:"text-sm font-medium text-muted-foreground",children:"Description"}),e.jsx("p",{className:"text-sm leading-relaxed",children:t.description})]}),h&&e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.1},className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(pa,{className:"w-4 h-4 text-primary"}),e.jsx("h4",{className:"text-sm font-semibold",children:"Cosmiq Story"})]}),l?e.jsxs("div",{className:"rounded-xl border border-border/50 bg-card/50 overflow-hidden",children:[l.chapter_title&&e.jsx("div",{className:"px-4 py-3 border-b border-border/30 bg-primary/5",children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(et,{className:"w-4 h-4 text-amber-500"}),e.jsxs("span",{className:"text-sm font-medium",children:[l.chapter_number?`Chapter ${l.chapter_number}: `:"",l.chapter_title]})]})}),l.image_url&&e.jsxs("div",{className:"relative aspect-video w-full",children:[e.jsx("img",{src:l.image_url,alt:l.location_name,className:"w-full h-full object-cover"}),e.jsx("div",{className:"absolute bottom-0 left-0 right-0 bg-gradient-to-t from-black/60 to-transparent p-3",children:e.jsxs("div",{className:"flex items-center gap-1.5 text-white/90",children:[e.jsx(zs,{className:"w-3.5 h-3.5"}),e.jsx("span",{className:"text-sm font-medium",children:l.location_name})]})})]}),e.jsxs("div",{className:"p-4 space-y-4",children:[l.location_description&&e.jsx("p",{className:"text-sm text-muted-foreground italic",children:l.location_description}),l.story_content&&e.jsx("div",{className:"space-y-2",children:e.jsx("p",{className:"text-sm leading-relaxed",children:l.story_content})}),l.clue_text&&e.jsxs("div",{className:"flex items-start gap-2 p-3 rounded-lg bg-purple-500/10 border border-purple-200/30",children:[e.jsx(na,{className:"w-4 h-4 text-purple-500 mt-0.5 shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-purple-600 block mb-1",children:"Mystery Clue"}),e.jsxs("p",{className:"text-sm italic text-purple-700/80",children:['"',l.clue_text,'"']})]})]}),l.prophecy_line&&e.jsxs("div",{className:"flex items-start gap-2 p-3 rounded-lg bg-amber-500/10 border border-amber-200/30",children:[e.jsx(Sm,{className:"w-4 h-4 text-amber-500 mt-0.5 shrink-0"}),e.jsxs("div",{children:[e.jsx("span",{className:"text-xs font-medium text-amber-600 block mb-1",children:"Prophecy Fragment"}),e.jsxs("p",{className:"text-sm italic text-amber-700/80",children:['"',l.prophecy_line,'"']})]})]}),l.characters_featured&&l.characters_featured.length>0&&e.jsxs("div",{className:"flex items-center gap-2 pt-2 border-t border-border/30",children:[e.jsx(sl,{className:"w-3.5 h-3.5 text-muted-foreground"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["Featuring:"," ",l.characters_featured.join(", ")]})]})]})]}):m?e.jsxs("div",{className:"rounded-xl border border-border/50 bg-muted/30 p-4 text-center",children:[e.jsx(ze,{className:"w-6 h-6 text-muted-foreground mx-auto mb-2 animate-spin"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Your story chapter is being written..."})]}):e.jsxs("div",{className:"relative rounded-xl border border-dashed border-stardust-gold/40 bg-gradient-to-br from-stardust-gold/10 via-amber-500/5 to-royal-purple/10 p-5 text-center overflow-hidden",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-stardust-gold/10 to-transparent animate-shimmer"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-stardust-gold/20 flex items-center justify-center mx-auto mb-3",children:e.jsx(se,{className:"w-6 h-6 text-stardust-gold"})}),e.jsxs("p",{className:"text-sm text-foreground/90 font-medium",children:["Complete this milestone to unlock"," ",e.jsx("span",{className:"text-stardust-gold",children:t.chapter_number?`Chapter ${t.chapter_number}`:"a new chapter"})," ","of your cosmic journey!"]})]})]})]})]})}),e.jsx("div",{className:"p-4 border-t border-border/50",children:e.jsx(be,{mode:"wait",children:m?e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:e.jsxs(B,{variant:"outline",className:"w-full",onClick:()=>i(t),disabled:o,children:[o?e.jsx(ze,{className:"w-4 h-4 mr-2 animate-spin"}):e.jsx(Qe,{className:"w-4 h-4 mr-2"}),"Mark Incomplete"]})},"uncomplete"):e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},children:e.jsxs(B,{className:"w-full gap-2",onClick:()=>r(t),disabled:o,children:[o?e.jsx(ze,{className:"w-4 h-4 animate-spin"}):e.jsx(ms,{className:"w-4 h-4"}),"Complete Milestone",e.jsxs(Ne,{variant:"secondary",className:"ml-1 bg-primary-foreground/20 text-primary-foreground text-xs",children:["+",d," XP"]})]})},"complete")})})]})})},hy=({epicId:t,epicTitle:s,epicGoal:a,currentDeadline:r,children:i})=>{const[o,c]=n.useState(!1),[l,u]=n.useState(null),{milestones:m,milestonesByPhase:p,isLoading:h,completedCount:f,totalCount:d,completeMilestone:g,uncompleteMilestone:y,getCurrentPhase:v,getPhaseStats:b,isMilestoneOverdue:x,isCompleting:j}=br(t),{postcards:w,checkMilestoneForPostcard:D,postcardJustUnlocked:S,clearPostcardUnlocked:M}=oy(),{companion:C}=st(),{awardMilestoneComplete:R,awardPhaseComplete:T,awardEpicComplete:q}=bt(),{multiplier:k}=fr(),{regeneratePathForMilestone:P}=An(t),A=v();b();const L=n.useMemo(()=>w?.filter(U=>U.epic_id===t)||[],[w,t]),H=U=>L.find($=>$.milestone_percent===U.milestone_percent),I=U=>{const $=p.find(O=>O.phaseName===U.phase_name);if(!$)return;$.milestones.every(O=>O.id===U.id||O.completed_at)&&T($.phaseName)},te=()=>{m.every($=>$.id===l?.id||$.completed_at)&&d>0&&q(s)},V=async U=>{const $=m.findIndex(J=>J.id===U.id);g.mutate({milestoneId:U.id,epicId:t,onPostcardTrigger:J=>{D(J.id,t,C?.id||"",{spirit_animal:C?.spirit_animal,favorite_color:C?.favorite_color,core_element:C?.core_element,eye_color:C?.eye_color,fur_color:C?.fur_color})}}),$>=0&&P($+1),R(U.is_postcard_milestone||!1),I(U),te(),u(null)},z=U=>{y.mutate(U.id),u(null)},W=U=>{u(U)},Q=U=>U.completed_at?"completed":x(U)?"overdue":"pending";return e.jsxs(e.Fragment,{children:[e.jsx(my,{show:!!S,milestoneTitle:S?.milestoneTitle,chapterNumber:S?.chapterNumber,onDismiss:M}),e.jsxs(Ns,{open:o,onOpenChange:c,shouldScaleBackground:!1,handleOnly:!0,children:[e.jsx(_n,{asChild:!0,children:i||e.jsxs(B,{variant:"ghost",size:"sm",className:"gap-1.5 text-xs",children:[e.jsx(oa,{className:"w-3.5 h-3.5"}),"View Timeline"]})}),e.jsxs(ks,{className:"max-h-[85vh]",children:[e.jsxs(Cs,{className:"pb-2",children:[e.jsxs(Ss,{className:"flex items-center gap-2",children:[e.jsx(oa,{className:"w-5 h-5 text-primary"}),s]}),e.jsxs("div",{className:"flex items-center justify-between mt-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs(Ne,{variant:"secondary",className:"text-xs",children:[f," / ",d," milestones"]}),A&&e.jsxs(Ne,{variant:"outline",className:"text-xs",children:["Current: ",A]})]}),r&&e.jsx(uy,{epicId:t,epicTitle:s,epicGoal:a,currentDeadline:r,children:e.jsxs(B,{variant:"ghost",size:"sm",className:"gap-1.5 text-xs h-7",children:[e.jsx(us,{className:"w-3.5 h-3.5"}),"Reschedule"]})})]})]}),e.jsx("div",{className:"flex-1 px-4 pb-6 max-h-[60vh] overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},"data-vaul-no-drag":!0,children:h?e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-6 w-6 border-b-2 border-primary"})}):m.length===0?e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(oa,{className:"w-10 h-10 mx-auto mb-2 opacity-50"}),e.jsx("p",{className:"text-sm",children:"No milestones yet"})]}):e.jsx("div",{className:"space-y-2",children:m.sort((U,$)=>!U.target_date&&!$.target_date?0:U.target_date?$.target_date?new Date(U.target_date).getTime()-new Date($.target_date).getTime():-1:1).map(U=>{const $=Q(U);return e.jsxs("div",{onClick:()=>W(U),className:E("flex items-center gap-3 p-3 rounded-lg cursor-pointer transition-colors",$==="completed"&&"bg-green-500/5",$==="overdue"&&"bg-destructive/5",$==="pending"&&"bg-secondary/30 hover:bg-secondary/50"),children:[e.jsx(Bs,{checked:!!U.completed_at,disabled:!0,className:"pointer-events-none"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("span",{className:E("text-sm",$==="completed"&&"line-through text-muted-foreground"),children:U.title})}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[U.target_date&&e.jsx("span",{className:E("text-xs text-muted-foreground",$==="overdue"&&"text-destructive"),children:Y(new Date(U.target_date),"MMM d")}),$==="completed"&&e.jsx(ms,{className:"w-4 h-4 text-green-600"}),$==="overdue"&&e.jsx(js,{className:"w-4 h-4 text-destructive"}),U.is_postcard_milestone&&!U.completed_at&&e.jsx(et,{className:"w-4 h-4 text-amber-500"}),e.jsx(tt,{className:"w-4 h-4 text-muted-foreground/50"})]})]},U.id)})})})]})]}),e.jsx(py,{milestone:l,isOpen:!!l,onClose:()=>u(null),onComplete:V,onUncomplete:z,isCompleting:j,status:l?Q(l):"pending",postcard:l?H(l):void 0,streakMultiplier:k??1})]})},Ji=n.memo(function({epic:s,children:a}){const[r,i]=n.useState(!1),{pathImageUrl:o,isLoading:c}=An(s.id),{milestones:l,totalCount:u}=br(s.id),{companion:m}=st(),p=n.useMemo(()=>Math.max(0,Je(new Date(s.end_date),new Date)),[s.end_date]),h=n.useMemo(()=>l.map(f=>({id:f.id,title:f.title,milestone_percent:f.milestone_percent,is_postcard_milestone:f.is_postcard_milestone,completed_at:f.completed_at,description:f.description,phase_name:f.phase_name,target_date:f.target_date,chapter_number:f.chapter_number})),[l]);return e.jsxs(Ns,{open:r,onOpenChange:i,shouldScaleBackground:!1,handleOnly:!0,children:[e.jsx(_n,{asChild:!0,children:a}),e.jsxs(ks,{className:"max-h-[85vh]",children:[e.jsxs(Cs,{className:"pb-2",children:[e.jsxs(Ss,{className:"flex items-center gap-2",children:[e.jsx(Ze,{className:"w-5 h-5 text-primary"}),s.title]}),e.jsxs("div",{className:"mt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("span",{className:"font-bold text-primary",children:[Math.round(s.progress_percentage),"% Complete"]}),e.jsxs("span",{className:"text-muted-foreground flex items-center gap-1",children:[e.jsx(pt,{className:"w-3.5 h-3.5 text-orange-500"}),p,"d left"]})]}),e.jsx(ts,{value:s.progress_percentage,className:"h-2"})]})]}),e.jsxs("div",{className:"flex-1 px-4 pb-6 max-h-[60vh] overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},"data-vaul-no-drag":!0,children:[e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mb-4",children:e.jsxs("div",{className:"rounded-xl overflow-hidden border border-border/30 bg-card/30 backdrop-blur-sm",children:[e.jsxs("div",{className:"relative h-56 w-full overflow-hidden",children:[o&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:o,alt:"Your journey path",className:"absolute inset-0 w-full h-full object-cover"}),e.jsx("div",{className:"absolute inset-0 bg-gradient-to-t from-background/80 via-background/30 to-transparent"})]}),e.jsx(iy,{progress:s.progress_percentage,targetDays:s.target_days,companionImageUrl:m?.current_image_url,companionMood:m?.current_mood,showCompanion:!0,milestones:h,transparentBackground:!!o,className:"absolute inset-0"})]}),c&&!o&&e.jsx("div",{className:"h-56 flex items-center justify-center",children:e.jsxs("div",{className:"text-center space-y-2",children:[e.jsx(se,{className:"w-8 h-8 text-primary/50 mx-auto animate-pulse"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Loading journey path..."})]})})]})}),e.jsxs("div",{className:"flex items-center justify-center gap-6 mb-6 text-sm text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(et,{className:"w-4 h-4 text-purple-400"}),e.jsxs("span",{children:[u," milestones"]})]}),e.jsxs("span",{className:"flex items-center gap-1.5",children:[e.jsx(mt,{className:"w-4 h-4 text-sky-400"}),e.jsxs("span",{children:[s.target_days,"d journey"]})]})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx(hy,{epicId:s.id,epicTitle:s.title,epicGoal:s.description,currentDeadline:s.end_date,children:e.jsxs(B,{variant:"outline",className:"gap-2",children:[e.jsx(oa,{className:"w-4 h-4"}),"View Milestones"]})})})]})]})]})}),fy=t=>{const[s,a]=t.split(":"),r=parseInt(s),i=r>=12?"p":"a";return`${r%12||12}:${a}${i}`};function Zi({time:t,overrideTime:s,showLine:a=!0,isLast:r=!1,isDragTarget:i=!1,children:o}){const c=s??t,l=s!=null;return e.jsxs("div",{className:E("relative flex gap-2",i&&"rounded-lg"),children:[e.jsx("div",{className:"w-9 flex-shrink-0 pt-[22px] text-left",children:c&&e.jsx("span",{className:E("text-[10px] font-medium leading-none transition-colors",l?"text-primary font-bold":"text-muted-foreground"),children:fy(c)})}),e.jsxs("div",{className:"relative flex flex-col items-center flex-shrink-0 w-3",children:[a&&e.jsx("div",{className:"w-px flex-1 border-l border-dashed border-border/50 min-h-[8px]"}),!a&&e.jsx("div",{className:"flex-1 min-h-[8px]"}),e.jsx("div",{className:E("w-2 h-2 rounded-full flex-shrink-0 z-10",t?"bg-primary/70 ring-2 ring-primary/20":"bg-muted-foreground/40 ring-2 ring-muted/30")}),r?e.jsx("div",{className:"flex-1 min-h-[8px]"}):e.jsx("div",{className:"w-px flex-1 border-l border-dashed border-border/50 min-h-[8px]"})]}),e.jsx("div",{className:"flex-1 min-w-0 py-1",children:o})]})}const gy=({percent:t,size:s=32,strokeWidth:a=3,className:r,showLabel:i=!1})=>{const o=(s-a)/2,c=o*2*Math.PI,l=c-t/100*c,u=()=>t===100?"hsl(var(--chart-2))":t>=50?"hsl(var(--chart-4))":"hsl(var(--primary))";return e.jsxs("div",{className:E("relative inline-flex items-center justify-center",r),children:[e.jsxs("svg",{width:s,height:s,className:"transform -rotate-90",children:[e.jsx("circle",{cx:s/2,cy:s/2,r:o,fill:"none",stroke:"hsl(var(--muted))",strokeWidth:a}),e.jsx("circle",{cx:s/2,cy:s/2,r:o,fill:"none",stroke:u(),strokeWidth:a,strokeDasharray:c,strokeDashoffset:l,strokeLinecap:"round",className:"transition-all duration-300 ease-out"})]}),i&&e.jsxs("span",{className:"absolute text-xs font-medium",children:[t,"%"]})]})},eo=t=>{if(!t)return null;try{const s=new Date(t);return Number.isNaN(s.getTime())?null:Math.max(0,Je(s,new Date))}catch{return null}},xy=(t,s,a="")=>{try{return Number.isNaN(t.getTime())?a:Y(t,s)}catch{return a}},yy=t=>{const[s,a]=t.split(":"),r=parseInt(s),i=r>=12?"PM":"AM";return`${r%12||12}:${a} ${i}`},by=n.memo(function({tasks:s,selectedDate:a,onToggle:r,onAddQuest:i,completedCount:o,totalCount:c,currentStreak:l=0,onUndoToggle:u,onEditQuest:m,calendarTasks:p=[],calendarMilestones:h=[],onDateSelect:f,activeEpics:d=[],onDeleteQuest:g,onMoveQuestToNextDay:y,onUpdateScheduledTime:v,onTimeSlotLongPress:b}){const x=ss(),w=n.useMemo(()=>{if(typeof window>"u")return!1;const F=window.Capacitor;return!!(F?.isNativePlatform?.()&&F?.getPlatform?.()==="ios")},[])||!!x,{profile:D}=yt(),S=D?.completed_tasks_stay_in_place??!0,M=n.useRef(null),C=q0({containerRef:M,onDrop:(F,de)=>{v?.(F,de)}}),[R,T]=n.useState(new Set),[q,k]=n.useState(!1),[P,A]=n.useState("custom"),[L,H]=n.useState(new Set),[I,te]=n.useState(new Set),[V,z]=n.useState(new Set),W=n.useRef(null);n.useEffect(()=>{te(F=>{const de=s.filter(K=>K.completed).map(K=>K.id),ae=new Set(F);return de.forEach(K=>ae.delete(K)),ae.size!==F.size?ae:F})},[s]);const Q=n.useMemo(()=>s.filter(F=>Es(F.task_text)),[s]),U=Q.length>0,$=Q.filter(F=>F.completed).length,J=Q.length;n.useEffect(()=>{const F=s.find(de=>Es(de.task_text)&&!de.completed);F&&T(de=>{if(de.has(F.id))return de;const ae=new Set(de);return ae.add(F.id),ae})},[s]);const O=F=>{switch(F){case"high":return 0;case"medium":return 1;case"low":return 2;default:return 3}},{ritualTasks:le,questTasks:G}=n.useMemo(()=>{const F=s.filter(K=>!!K.habit_source_id),de=s.filter(K=>!K.habit_source_id),ae=K=>{let fe=[...K].sort((Ce,De)=>{switch(P){case"time":return Ce.scheduled_time&&De.scheduled_time?Ce.scheduled_time.localeCompare(De.scheduled_time):Ce.scheduled_time?-1:De.scheduled_time?1:0;case"priority":return O(Ce.priority)-O(De.priority);case"xp":return De.xp_reward-Ce.xp_reward;default:{const re=Ce.sort_order??9999,_e=De.sort_order??9999;return re!==_e?re-_e:Ce.scheduled_time&&De.scheduled_time?Ce.scheduled_time.localeCompare(De.scheduled_time):Ce.scheduled_time?-1:De.scheduled_time?1:Ce.id.localeCompare(De.id)}}});if(!S){const Ce=fe.filter(re=>!re.completed),De=fe.filter(re=>re.completed);fe=[...Ce,...De]}return fe};return{ritualTasks:ae(F),questTasks:ae(de)}},[s,P,S]),{scheduledItems:Z,anytimeItems:he}=n.useMemo(()=>{const F=G.filter(ae=>!!ae.scheduled_time).sort((ae,K)=>(ae.scheduled_time||"").localeCompare(K.scheduled_time||"")),de=G.filter(ae=>!ae.scheduled_time);return{scheduledItems:F,anytimeItems:de}},[G]),ve=n.useMemo(()=>{const F=[],de=new Map;for(const ae of le){const K=ae.epic_id;K&&(de.has(K)||de.set(K,[]),de.get(K).push(ae))}for(const ae of d){const K=de.get(ae.id);!K||K.length===0||F.push({epicId:ae.id,title:ae.title,progress:Math.round(ae.progress_percentage??0),daysLeft:eo(ae.end_date),rituals:K,completedCount:K.filter(fe=>!!fe.completed).length,epic:ae})}return F},[le,d]);n.useEffect(()=>{z(F=>{const de=new Set(F);let ae=!1;for(const K of d)de.has(K.id)||(de.add(K.id),ae=!0);return ae?de:F})},[d]);const we=n.useCallback(F=>{z(de=>{const ae=new Set(de);return ae.has(F)?ae.delete(F):ae.add(F),ae})},[]),je=s.reduce((F,de)=>de.completed?F+de.xp_reward:F,0),ke=c>0?o/c*100:0,Ae=c>0&&o===c,Re=async F=>{try{await Ct.impact({style:F})}catch{}},Ge=n.useCallback(F=>!!(F.notes||F.priority||F.energy_level||F.estimated_duration||F.is_recurring&&F.recurrence_pattern||F.difficulty||F.category),[]),ge=n.useCallback((F,de)=>{de.stopPropagation();const ae=s.some(K=>K.id===F&&Es(K.task_text));T(K=>{const fe=new Set(K);return fe.has(F)?fe.delete(F):(ae&&s.forEach(Ce=>{Es(Ce.task_text)&&Ce.id!==F&&fe.delete(Ce.id)}),fe.add(F)),fe})},[s]),Te=F=>{switch(F){case"mind":return Rt;case"body":return on;case"soul":return Xt;default:return null}},Le=n.useCallback((F,de)=>{const ae=!!F.completed||I.has(F.id),K=Es(F.task_text),fe=K,Ce=!!F.habit_source_id,De=de?.isDragging??!1,re=de?.isPressed??!1,_e=de?.isActivated??!1,oe=R.has(F.id),Ee=Ge(F),Ue=We=>{if(We.stopPropagation(),!fe){if(De||_e||re){We.preventDefault();return}ae&&u?(te(at=>{const rt=new Set(at);return rt.delete(F.id),rt}),Re(it.Light),u(F.id,F.xp_reward)):(te(at=>new Set(at).add(F.id)),Re(it.Medium),qp(),H(at=>new Set(at).add(F.id)),setTimeout(()=>{H(at=>{const rt=new Set(at);return rt.delete(F.id),rt})},600),K&&T(at=>{const rt=new Set(at);rt.delete(F.id);const Kt=s.find(wt=>Es(wt.task_text)&&!wt.completed&&wt.id!==F.id);return Kt&&rt.add(Kt.id),rt}),r(F.id,!ae,F.xp_reward))}},ft=Te(F.category),vt=e.jsxs(Dn,{open:oe,onOpenChange:()=>{},children:[e.jsxs("div",{className:E("flex items-center gap-3 transition-all relative group","select-none min-h-[52px]",Ce?"py-4":"py-3",ae&&"opacity-60",De&&"cursor-grabbing",_e&&!De&&"bg-muted/30 rounded-lg",K&&!ae&&"bg-primary/5 rounded-lg"),children:[e.jsxs("div",{className:E("relative ml-1 flex flex-col items-center self-start pt-0.5",K&&!ae?"gap-1.5":"gap-0"),children:[e.jsx("button",{"data-interactive":"true",onClick:Ue,onTouchStart:We=>{W.current={x:We.touches[0].clientX,y:We.touches[0].clientY}},onTouchEnd:We=>{if(We.preventDefault(),We.stopPropagation(),W.current){const at=Math.abs(We.changedTouches[0].clientX-W.current.x),rt=Math.abs(We.changedTouches[0].clientY-W.current.y);at<5&&rt<5&&Ue(We)}W.current=null},className:E("relative flex items-center justify-center w-11 h-11 touch-manipulation transition-transform select-none disabled:opacity-100",!fe&&"active:scale-95",fe&&"cursor-default"),style:{WebkitTapHighlightColor:"transparent",touchAction:"manipulation"},"aria-label":fe?"Tutorial step auto-completes when finished":ae?"Mark task as incomplete":"Mark task as complete",role:"checkbox","aria-checked":ae,tabIndex:fe?-1:0,disabled:fe,children:w?e.jsx("div",{className:E("flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all",ae?"bg-primary border-primary":K?"border-primary ring-2 ring-primary/40 ring-offset-1 ring-offset-background":"border-muted-foreground/40 hover:border-primary"),children:ae&&e.jsx(Xe,{className:"w-4 h-4 text-primary-foreground"})}):e.jsx(_.div,{className:E("flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all",ae?"bg-primary border-primary":K?"border-primary ring-2 ring-primary/40 ring-offset-1 ring-offset-background":"border-muted-foreground/40 hover:border-primary"),whileTap:!De&&!re?{scale:.85}:{},children:ae&&e.jsx(_.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:25},children:e.jsx(Xe,{className:"w-4 h-4 text-primary-foreground"})})})}),K&&!ae&&(w?e.jsx("span",{className:"rounded-full border border-primary/25 bg-primary/10 px-2 py-0.5 text-[9px] font-medium leading-tight text-primary/95 text-center",children:"Auto-completes"}):e.jsx(_.span,{className:"rounded-full border border-primary/25 bg-primary/10 px-2 py-0.5 text-[9px] font-medium leading-tight text-primary/95 text-center",animate:{opacity:[.6,1,.6]},transition:{duration:2,repeat:1/0},children:"Auto-completes"}))]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[Ce&&e.jsx(vs,{className:"w-4 h-4 text-accent flex-shrink-0"}),e.jsx(Z0,{text:F.task_text,className:E("text-sm flex-1",ae&&"text-muted-foreground",ae&&(L.has(F.id)?"animate-strikethrough":"line-through"))})]}),F.scheduled_time&&e.jsxs("span",{className:"text-xs text-muted-foreground flex items-center gap-1 mt-0.5",children:[e.jsx(lt,{className:"w-3 h-3"}),yy(F.scheduled_time)]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[m&&!ae&&!De&&!_e&&!fe&&e.jsx(B,{variant:"ghost",size:"icon",className:"h-9 w-9 -m-1.5 opacity-0 group-hover:opacity-100 transition-opacity touch-manipulation",onClick:We=>{We.stopPropagation(),m(F)},children:e.jsx(al,{className:"w-4 h-4"})}),F.is_main_quest&&e.jsx(Ne,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 bg-primary/10 border-primary/30",children:"Main"}),e.jsxs("span",{className:"text-sm font-bold text-stardust-gold/80",children:["+",F.xp_reward]}),Ee&&e.jsx(B,{variant:"ghost",size:"icon",className:"h-7 w-7 -m-1 flex-shrink-0",onClick:We=>ge(F.id,We),children:e.jsx(Jt,{className:E("w-4 h-4 text-muted-foreground transition-transform duration-200",oe&&"rotate-180")})})]})]}),e.jsx(xr,{children:e.jsxs("div",{className:"pl-8 pr-2 pb-2 space-y-2",children:[F.notes&&(w?e.jsxs("div",{className:E("flex items-start gap-2 text-sm",K&&!ae?"p-2 rounded-lg bg-primary/10 border border-primary/20 text-foreground":"text-muted-foreground"),children:[e.jsx(Xr,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-xs leading-relaxed whitespace-pre-line",children:tn(F.notes)})]}):e.jsxs(_.div,{className:E("flex items-start gap-2 text-sm",K&&!ae?"p-2 rounded-lg bg-primary/10 border border-primary/20 text-foreground":"text-muted-foreground"),animate:K&&!ae?{boxShadow:["0 0 0 0 rgba(129, 140, 248, 0)","0 0 12px 2px rgba(129, 140, 248, 0.3)","0 0 0 0 rgba(129, 140, 248, 0)"]}:{},transition:{duration:2.5,repeat:1/0,ease:"easeInOut"},children:[e.jsx(Xr,{className:"w-4 h-4 flex-shrink-0 mt-0.5"}),e.jsx("p",{className:"text-xs leading-relaxed whitespace-pre-line",children:tn(F.notes)})]})),e.jsxs("div",{className:"flex flex-wrap gap-1.5",children:[ft&&F.category&&e.jsxs(Ne,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 gap-1 border-muted-foreground/30",children:[e.jsx(ft,{className:"w-3 h-3"}),F.category]}),F.difficulty&&e.jsx(Ne,{variant:"outline",className:E("text-xs px-1.5 py-0.5 h-5",F.difficulty==="easy"&&"bg-green-500/10 text-green-500 border-green-500/30",F.difficulty==="medium"&&"bg-yellow-500/10 text-yellow-500 border-yellow-500/30",F.difficulty==="hard"&&"bg-red-500/10 text-red-500 border-red-500/30"),children:F.difficulty}),F.priority&&e.jsxs(Ne,{variant:"outline",className:E("text-xs px-1.5 py-0.5 h-5",F.priority==="high"&&"bg-red-500/10 text-red-500 border-red-500/30",F.priority==="medium"&&"bg-yellow-500/10 text-yellow-500 border-yellow-500/30",F.priority==="low"&&"bg-blue-500/10 text-blue-500 border-blue-500/30"),children:[F.priority," priority"]}),F.energy_level&&e.jsxs(Ne,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 gap-1 border-muted-foreground/30",children:[e.jsx(Be,{className:"w-3 h-3"}),F.energy_level]}),F.estimated_duration&&e.jsxs(Ne,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 gap-1 border-muted-foreground/30",children:[e.jsx(ir,{className:"w-3 h-3"}),F.estimated_duration,"m"]}),F.is_recurring&&F.recurrence_pattern&&e.jsxs(Ne,{variant:"outline",className:"text-xs px-1.5 py-0.5 h-5 gap-1 bg-accent/10 text-accent border-accent/30",children:[e.jsx(vs,{className:"w-3 h-3"}),F.recurrence_pattern]})]})]})})]});if((g||y)&&!ae&&!De&&!_e&&!fe){const We=!!F.habit_source_id;return e.jsx(J0,{onSwipeDelete:()=>g?.(F.id),onSwipeMoveToNextDay:!We&&y?()=>y(F.id):void 0,disabled:De||_e,children:vt})}return vt},[r,u,m,g,y,R,Ge,ge,L,I,s,w]);return e.jsxs("div",{className:"relative",children:[e.jsxs("div",{className:"relative px-2 py-2 overflow-visible",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>k(!0),className:"flex items-center gap-1.5 hover:opacity-80 transition-opacity",children:e.jsx("span",{className:"text-lg font-bold",children:xy(a,"MMM d, yyyy","Invalid date")})}),l>0&&e.jsxs("div",{className:E("flex items-center gap-1 px-2 py-0.5 rounded-full text-xs font-medium",l>=30?"bg-stardust-gold/20 text-stardust-gold":l>=14?"bg-celestial-blue/20 text-celestial-blue":"bg-orange-500/10 text-orange-400"),children:[e.jsx(pt,{className:"h-3.5 w-3.5"}),l]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[c>0&&e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(gy,{percent:ke,size:24,strokeWidth:2.5}),e.jsxs("span",{className:"text-xs font-medium text-muted-foreground",children:[o,"/",c]})]}),e.jsxs("div",{className:"flex items-center gap-1 text-sm",children:[e.jsx(nn,{className:E("h-4 w-4",Ae?"text-stardust-gold":"text-stardust-gold/70")}),e.jsx("span",{className:"font-semibold text-stardust-gold",children:je})]})]})]}),s.length===0?e.jsxs("div",{className:"text-center py-6",children:[e.jsx(nr,{className:"w-10 h-10 mx-auto text-muted-foreground/30 mb-2"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"No tasks for this day"}),e.jsxs("p",{className:"text-xs text-muted-foreground/70",children:["Tap ",e.jsx(ha,{className:"w-3 h-3 inline"})," to add your first quest"]}),e.jsxs(B,{variant:"outline",size:"sm",className:"mt-3",onClick:i,children:[e.jsx(ha,{className:"w-3 h-3 mr-1.5"}),"Add Quest"]})]}):e.jsxs("div",{children:[e.jsx("div",{className:"flex items-center gap-2 mb-1",children:s.length>0&&e.jsxs(L0,{children:[e.jsx(F0,{asChild:!0,children:e.jsx("button",{className:"p-1 rounded opacity-40 hover:opacity-70 transition-opacity flex-shrink-0",children:e.jsx(Tm,{className:"w-3 h-3"})})}),e.jsxs(xd,{align:"start",className:"w-28",children:[e.jsx(ra,{onClick:()=>A("custom"),className:E("text-xs",P==="custom"&&"bg-accent/10"),children:"Custom"}),e.jsx(ra,{onClick:()=>A("time"),className:E("text-xs",P==="time"&&"bg-accent/10"),children:"Time"}),e.jsx(ra,{onClick:()=>A("priority"),className:E("text-xs",P==="priority"&&"bg-accent/10"),children:"Priority"}),e.jsx(ra,{onClick:()=>A("xp"),className:E("text-xs",P==="xp"&&"bg-accent/10"),children:"XP"})]})]})}),Z.length>0&&e.jsx("div",{ref:M,children:Z.map((F,de)=>{const ae=C.draggingTaskId===F.id,K=C.isDragging,fe=C.justDroppedId===F.id,Ce=F.scheduled_time?C.getRowHandlers(F.id,F.scheduled_time):{},De={WebkitUserSelect:"none",userSelect:"none",WebkitTouchCallout:"none",touchAction:ae?"none":"pan-y",pointerEvents:K&&!ae?"none":"auto",transform:ae?`translateY(${C.dragOffsetY}px) scale(1.03)`:void 0,opacity:K&&!ae?.7:1,boxShadow:ae?"0 15px 30px -5px rgba(0, 0, 0, 0.3), 0 8px 10px -4px rgba(0, 0, 0, 0.15)":"none",backgroundColor:ae?"hsl(var(--background))":"transparent",borderRadius:ae?12:0,transition:"none"},re=e.jsx(Zi,{time:F.scheduled_time,overrideTime:ae?C.previewTime:void 0,showLine:de>0,isLast:de===Z.length-1&&he.length===0,isDragTarget:ae,children:Le(F)});return w||!fe?e.jsx("div",{className:E("relative",ae&&"z-50"),style:De,...Ce,children:re},F.id):e.jsx(_.div,{className:E("relative",ae&&"z-50"),animate:{scale:[1,1.02,.98,1],y:[0,-2,1,0]},transition:{duration:.25,ease:[.25,.1,.25,1]},style:De,...Ce,children:re},F.id)})}),he.length>0&&e.jsxs("div",{children:[e.jsxs("div",{className:"flex items-center gap-2 py-2 mt-1",children:[e.jsx("div",{className:"w-9 flex-shrink-0"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs font-medium text-muted-foreground uppercase tracking-wide",children:[e.jsx(lt,{className:"h-3 w-3"}),"Anytime"]}),e.jsx("div",{className:"flex-1 border-t border-dashed border-border/40"})]}),he.map((F,de)=>e.jsx(Zi,{showLine:!0,isLast:de===he.length-1,children:Le(F)},F.id))]})]}),ve.length>0&&e.jsxs("div",{className:"mt-6 pt-4 border-t border-border/30",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx("div",{className:"w-9 flex-shrink-0"}),e.jsxs("div",{className:"flex items-center gap-2 text-xs font-medium text-muted-foreground uppercase tracking-wide",children:[e.jsx(Ze,{className:"h-3 w-3"}),"Campaigns"]}),e.jsx("div",{className:"flex-1 border-t border-dashed border-border/40"})]}),e.jsx("div",{className:"space-y-2",children:ve.map(F=>{const de=V.has(F.epicId);return e.jsxs("div",{className:"rounded-xl border border-border/30 bg-card/30 overflow-hidden",children:[e.jsxs("div",{className:"flex items-center gap-2 px-3 py-2.5",children:[e.jsx(Ji,{epic:{id:F.epic.id,title:F.epic.title,description:F.epic.description??void 0,progress_percentage:F.epic.progress_percentage??0,target_days:F.epic.target_days,start_date:F.epic.start_date,end_date:F.epic.end_date,epic_habits:F.epic.epic_habits},children:e.jsxs("button",{className:"flex items-center gap-2 min-w-0 flex-1 text-left focus:outline-none",children:[e.jsx(Ze,{className:"w-4 h-4 text-primary shrink-0"}),e.jsx("span",{className:"text-sm font-medium truncate",children:F.title})]})}),e.jsxs("div",{className:"flex items-center gap-2 shrink-0",children:[e.jsxs("span",{className:"text-primary font-bold text-xs",children:[F.progress,"%"]}),F.daysLeft!==null&&e.jsxs("span",{className:"text-muted-foreground text-xs",children:[F.daysLeft,"d"]}),e.jsxs(Ne,{variant:"secondary",className:"text-xs h-5 px-1.5",children:[F.completedCount,"/",F.rituals.length]}),e.jsx("button",{onClick:ae=>{ae.stopPropagation(),we(F.epicId)},className:"p-1 -m-1 focus:outline-none",children:de?e.jsx(un,{className:"w-4 h-4 text-muted-foreground"}):e.jsx(Jt,{className:"w-4 h-4 text-muted-foreground"})})]})]}),de&&e.jsx("div",{className:"border-t border-border/20 px-2 pb-1",children:F.rituals.map(ae=>e.jsx("div",{children:Le(ae)},ae.id))})]},F.epicId)})})]}),d&&d.length>0&&le.length===0&&e.jsx("div",{className:"mt-4 pt-3 border-t border-border/20 space-y-2",children:d.map(F=>{const de=Math.round(F.progress_percentage??0),ae=eo(F.end_date);return e.jsx(Ji,{epic:{id:F.id,title:F.title,description:F.description??void 0,progress_percentage:F.progress_percentage??0,target_days:F.target_days,start_date:F.start_date,end_date:F.end_date,epic_habits:F.epic_habits},children:e.jsx("button",{className:"w-full text-left focus:outline-none",children:e.jsx("div",{className:"flex items-center justify-between py-2 px-3 rounded-xl hover:bg-muted/30 border border-border/30 bg-card/30",children:e.jsxs("div",{className:"flex items-center gap-2 min-w-0",children:[e.jsx(Ze,{className:"w-4 h-4 text-primary shrink-0"}),e.jsx("span",{className:"text-sm font-medium truncate max-w-[140px]",children:F.title}),e.jsxs("span",{className:"text-primary font-bold text-xs shrink-0",children:[de,"%"]}),ae!==null&&e.jsxs("span",{className:"text-muted-foreground text-xs shrink-0",children:["Â· ",ae,"d"]})]})})})},F.id)})})]}),U&&$<J&&(w?e.jsxs("div",{className:"mt-4 p-3 rounded-xl bg-gradient-to-r from-primary/10 via-accent/10 to-primary/10 border border-primary/20",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ga,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"Getting Started"}),e.jsxs(Ne,{variant:"secondary",className:"ml-auto text-xs",children:[$,"/",J]})]}),e.jsx("div",{className:"h-1.5 bg-muted/50 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full bg-gradient-to-r from-primary to-accent rounded-full",style:{width:`${$/J*100}%`}})}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Complete all tasks to evolve your companion! âœ¨"})]}):e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"mt-4 p-3 rounded-xl bg-gradient-to-r from-primary/10 via-accent/10 to-primary/10 border border-primary/20",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[e.jsx(Ga,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"Getting Started"}),e.jsxs(Ne,{variant:"secondary",className:"ml-auto text-xs",children:[$,"/",J]})]}),e.jsx("div",{className:"h-1.5 bg-muted/50 rounded-full overflow-hidden",children:e.jsx(_.div,{className:"h-full bg-gradient-to-r from-primary to-accent rounded-full",initial:{width:0},animate:{width:`${$/J*100}%`},transition:{duration:.5}})}),e.jsx("p",{className:"text-xs text-muted-foreground mt-2",children:"Complete all tasks to evolve your companion! âœ¨"})]})),e.jsx(V0,{open:q,onOpenChange:k,selectedDate:a,onDateSelect:F=>{f&&f(F)},tasks:p,milestones:h,onTaskDrop:()=>{},onTimeSlotLongPress:b})]})}),vy=async t=>{try{await Ct.impact({style:t})}catch{}},wy=n.memo(function({selectedDate:s,onDateSelect:a,tasksPerDay:r={},daysToShow:i=14}){const o=n.useRef(null),c=n.useRef(null),l=gn(s,3),u=Array.from({length:i},(p,h)=>os(l,h)),m=p=>{const h=Y(p,"yyyy-MM-dd");return r[h]||0};return n.useEffect(()=>{if(c.current&&o.current){const p=o.current,h=c.current,f=p.offsetWidth,d=h.offsetLeft,g=h.offsetWidth;p.scrollTo({left:d-f/2+g/2,behavior:"smooth"})}},[s]),e.jsx("div",{ref:o,className:E("flex gap-2 overflow-x-auto pb-2 scrollbar-hide -mx-1 px-1 transition-all duration-200"),style:{scrollbarWidth:"none",msOverflowStyle:"none"},children:u.map((p,h)=>{const f=Zr(p,s),d=fn(p),g=m(p);return e.jsxs(_.button,{ref:f?c:void 0,onClick:async()=>{await vy(it.Light),a(p)},className:E("flex-shrink-0 flex flex-col items-center justify-center","min-w-[52px] h-16 rounded-xl transition-all duration-200","border border-border/50",f?"bg-gradient-to-br from-primary to-purple-500 text-white border-primary shadow-lg shadow-primary/25":"bg-card/50 hover:bg-card hover:border-primary/30",d&&!f&&"border-celestial-blue/50 ring-1 ring-celestial-blue/30 bg-celestial-blue/5"),animate:{scale:1,y:0},transition:{type:"spring",stiffness:400,damping:25},children:[e.jsx("span",{className:E("text-[10px] font-medium uppercase tracking-wide",f?"text-white/90":d?"text-celestial-blue":"text-muted-foreground"),children:Y(p,"EEE")}),e.jsx("span",{className:E("text-lg font-bold leading-tight",f?"text-white":d?"text-celestial-blue":"text-foreground"),children:Y(p,"d")}),e.jsx("div",{className:"flex gap-0.5 mt-0.5 h-1.5",children:g>0&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:E("h-1.5 w-1.5 rounded-full",f?"bg-white/70":d?"bg-celestial-blue/60":"bg-stardust-gold/60")}),g>1&&e.jsx("div",{className:E("h-1.5 w-1.5 rounded-full",f?"bg-white/50":d?"bg-celestial-blue/40":"bg-stardust-gold/40")}),g>2&&e.jsx("div",{className:E("h-1.5 w-1.5 rounded-full",f?"bg-white/30":d?"bg-celestial-blue/20":"bg-stardust-gold/20")})]})})]},h)})})}),jy=({onClick:t,className:s})=>e.jsx(B,{variant:"ghost",size:"icon",onClick:t,className:E("h-8 w-8 rounded-full bg-muted/50 hover:bg-muted text-muted-foreground hover:text-foreground transition-colors",s),"aria-label":"Page information",children:e.jsx(ln,{className:"h-4 w-4"})}),_y=({open:t,onClose:s,title:a,icon:r,description:i,features:o,tip:c})=>e.jsx(ct,{open:t,onOpenChange:s,children:e.jsxs(ot,{className:"max-w-md",children:[e.jsxs(as,{children:[e.jsxs("div",{className:"flex items-center gap-3 mb-2",children:[e.jsx("div",{className:"h-12 w-12 rounded-full bg-primary/10 flex items-center justify-center",children:e.jsx(r,{className:"h-6 w-6 text-primary"})}),e.jsx(St,{className:"text-2xl",children:a})]}),e.jsx(_s,{className:"text-base",children:i})]}),e.jsx("div",{className:"space-y-3 py-4",children:o.map((l,u)=>e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"h-5 w-5 rounded-full bg-primary/20 flex items-center justify-center flex-shrink-0 mt-0.5",children:e.jsx(Xe,{className:"h-3 w-3 text-primary"})}),e.jsx("p",{className:"text-sm text-muted-foreground flex-1",children:l})]},u))}),c&&e.jsx("div",{className:"bg-accent/10 border border-accent/20 rounded-lg p-4",children:e.jsx("p",{className:"text-sm italic text-muted-foreground",children:c})}),e.jsx(B,{onClick:s,className:"w-full",children:"Got it!"})]})}),Kr=[{id:"first-quest",icon:_o,title:"Create Your First Quest",subtitle:"Start with one small daily action.",features:[{icon:Be,text:"Tap + in the lower-right corner"},{icon:Rt,text:"Set a time, then enter your title and tap Create Quest"},{icon:ms,text:"No time = Inbox item, with time = Quest timeline"}]},{id:"first-campaign",icon:Ze,title:"Create Your First Campaign",subtitle:"Turn a big goal into a guided plan.",features:[{icon:Be,text:'Tap + again and pick "Or create a Campaign"'},{icon:zs,text:"Set your goal, timing, and direction"},{icon:vs,text:"Add linked rituals for auto-progress"}]},{id:"complete-track",icon:se,title:"Complete And Track Progress",subtitle:"Close the loop every day.",features:[{icon:ms,text:"Tap the circle on a quest to complete it"},{icon:nn,text:"Watch XP and completion count update at the top"},{icon:pt,text:"Keep your streak alive for faster growth"}]}],Ny=n.memo(function({open:s,onClose:a,userName:r}){const[i,o]=n.useState(0),[c,l]=n.useState(!1),u=n.useMemo(()=>Array.from({length:12},(g,y)=>({id:y,x:Math.random()*100,y:Math.random()*100,size:Math.random()*2+1,duration:Math.random()*3+2,delay:Math.random()*2})),[]);n.useEffect(()=>{s&&(o(0),l(!1))},[s]);const m=Kr[i],p=i===Kr.length-1,h=m.icon,f=()=>{c||(p?a():(l(!0),setTimeout(()=>{o(g=>g+1),l(!1)},250)))},d=()=>{c||i===0||(l(!0),setTimeout(()=>{o(g=>g-1),l(!1)},250))};return e.jsx(ct,{open:s,onOpenChange:g=>!g&&a(),children:e.jsx(ot,{className:"max-w-sm rounded-3xl bg-background/80 backdrop-blur-2xl border-white/10 shadow-2xl shadow-black/20 p-0 overflow-hidden",hideCloseButton:!0,onPointerDownOutside:g=>g.preventDefault(),onEscapeKeyDown:g=>g.preventDefault(),children:e.jsxs(_.div,{initial:{opacity:0,y:40,scale:.95},animate:{opacity:1,y:0,scale:1},transition:{type:"spring",damping:25,stiffness:300},className:"relative",children:[e.jsx("div",{className:"absolute inset-0 overflow-hidden pointer-events-none",children:u.map(g=>e.jsx(_.div,{className:"absolute rounded-full bg-primary/20",style:{left:`${g.x}%`,top:`${g.y}%`,width:g.size,height:g.size},animate:{y:[0,-15,0],opacity:[.2,.5,.2]},transition:{duration:g.duration,delay:g.delay,repeat:1/0,ease:"easeInOut"}},g.id))}),e.jsx("div",{className:"flex justify-center gap-2 pt-6 pb-2",children:Kr.map((g,y)=>e.jsx(_.div,{className:`h-1 rounded-full transition-all duration-300 ${y===i?"w-6 bg-primary":y<i?"w-3 bg-primary/40":"w-3 bg-muted-foreground/20"}`,layoutId:`progress-${y}`},y))}),e.jsx(be,{mode:"wait",children:e.jsxs(_.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},transition:{duration:.25},children:[e.jsxs("div",{className:"pt-4 pb-4 flex flex-col items-center",children:[e.jsxs(_.div,{initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1},transition:{delay:.1,type:"spring",damping:15},className:"relative",children:[e.jsx("div",{className:"absolute inset-0 bg-primary/30 rounded-full blur-2xl scale-150"}),e.jsx("div",{className:"relative w-16 h-16 rounded-2xl bg-gradient-to-br from-primary/20 to-primary/5 flex items-center justify-center border border-white/10 shadow-lg",children:e.jsx(h,{className:"w-8 h-8 text-primary"})})]}),e.jsx(_.h2,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.15},className:"mt-5 text-xl font-semibold tracking-tight text-foreground",children:m.title}),e.jsx(_.p,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.2},className:"mt-1 text-sm text-muted-foreground italic",children:m.subtitle})]}),e.jsx("div",{className:"px-5 pb-4",children:e.jsx("div",{className:"rounded-2xl bg-card/50 backdrop-blur-sm divide-y divide-border/30 overflow-hidden",children:m.features.map((g,y)=>{const v=g.icon;return e.jsxs(_.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:.25+y*.05},className:"flex items-center gap-3 px-4 py-3.5",children:[e.jsx("div",{className:"w-8 h-8 rounded-xl bg-primary/10 flex items-center justify-center flex-shrink-0",children:e.jsx(v,{className:"w-4 h-4 text-primary"})}),e.jsx("span",{className:"text-sm text-foreground/90",children:g.text})]},y)})})}),p&&r&&e.jsxs(_.p,{initial:{opacity:0},animate:{opacity:1},transition:{delay:.4},className:"text-center text-sm text-muted-foreground pb-2",children:["Ready to begin, ",e.jsx("span",{className:"text-primary font-medium",children:r}),"?"]})]},i)}),e.jsxs("div",{className:"px-5 pb-6 pt-2 flex gap-3",children:[i>0&&e.jsx(_.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},children:e.jsx(B,{variant:"ghost",size:"icon",onClick:d,disabled:c,className:"h-12 w-12 rounded-full",children:e.jsx(ys,{className:"w-5 h-5"})})}),e.jsx(_.div,{className:"flex-1",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.45},children:e.jsx(B,{onClick:f,disabled:c,className:"w-full h-12 rounded-full bg-primary hover:bg-primary/90 font-medium text-base shadow-lg shadow-primary/25 transition-all duration-200 active:scale-[0.98]",children:p?e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"Begin Adventure"]}):"Continue"})})]})]})})})}),ky=n.memo(function({open:s,currentStreak:a,freezesAvailable:r,onUseFreeze:i,onResetStreak:o,isResolving:c}){const[l,u]=n.useState(null),m=async()=>{u("freeze"),await i()},p=async()=>{u("reset"),await o()};return e.jsx(ct,{open:s,onOpenChange:()=>{},children:e.jsxs(ot,{className:"sm:max-w-md bg-background/95 backdrop-blur-xl border-amber-500/30",hideCloseButton:!0,children:[e.jsxs(as,{className:"text-center",children:[e.jsx(_.div,{initial:{scale:.8,opacity:0},animate:{scale:1,opacity:1},className:"mx-auto mb-4 p-4 rounded-full bg-amber-500/20 border border-amber-500/30",children:e.jsx(ps,{className:"w-10 h-10 text-amber-400"})}),e.jsx(St,{className:"text-2xl font-bold text-center",children:"Your Streak is at Risk!"}),e.jsx(_s,{className:"text-center text-muted-foreground",children:"You missed a day. What would you like to do?"})]}),e.jsxs("div",{className:"py-4 space-y-4",children:[e.jsxs(_.div,{initial:{y:10,opacity:0},animate:{y:0,opacity:1},transition:{delay:.1},className:"flex items-center justify-center gap-3 p-4 rounded-xl bg-gradient-to-r from-orange-500/20 to-red-500/20 border border-orange-500/30",children:[e.jsx(pt,{className:"w-8 h-8 text-orange-400"}),e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"text-3xl font-bold text-foreground",children:a}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"day streak"})]})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(_.div,{initial:{x:-20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.2},children:[e.jsx(B,{onClick:m,disabled:c||r<=0,className:"w-full h-auto py-4 px-4 bg-gradient-to-r from-cyan-500/20 to-blue-500/20 hover:from-cyan-500/30 hover:to-blue-500/30 border border-cyan-500/40 text-foreground",variant:"outline",children:e.jsxs("div",{className:"flex items-center gap-4 w-full",children:[e.jsx("div",{className:"p-2 rounded-full bg-cyan-500/20",children:e.jsx(Em,{className:"w-6 h-6 text-cyan-400"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-semibold text-base",children:"Use Streak Freeze"}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Keep your ",a,"-day streak alive"]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("p",{className:"text-sm font-medium text-cyan-400",children:[r," available"]})})]})}),r<=0&&e.jsx("p",{className:"text-xs text-muted-foreground text-center mt-1",children:"No freezes available. Freezes reset weekly."})]}),e.jsx(_.div,{initial:{x:20,opacity:0},animate:{x:0,opacity:1},transition:{delay:.3},children:e.jsx(B,{onClick:p,disabled:c,className:"w-full h-auto py-4 px-4 bg-muted/30 hover:bg-muted/50 border border-border/50 text-foreground",variant:"outline",children:e.jsxs("div",{className:"flex items-center gap-4 w-full",children:[e.jsx("div",{className:"p-2 rounded-full bg-muted/30",children:e.jsx(se,{className:"w-6 h-6 text-muted-foreground"})}),e.jsxs("div",{className:"flex-1 text-left",children:[e.jsx("p",{className:"font-semibold text-base",children:"Start Fresh"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Let the streak reset and begin anew"})]})]})})})]}),c&&e.jsx(_.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center text-sm text-muted-foreground",children:l==="freeze"?"Preserving your streak...":"Resetting streak..."})]})]})})}),bd=n.forwardRef(({className:t,...s},a)=>e.jsx(hl,{className:E("grid gap-2",t),...s,ref:a}));bd.displayName=hl.displayName;const Qa=n.forwardRef(({className:t,...s},a)=>e.jsx(fl,{ref:a,className:E("aspect-square h-4 w-4 rounded-full border border-primary text-primary ring-offset-background focus:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",t),...s,children:e.jsx(Mm,{className:"flex items-center justify-center",children:e.jsx(nr,{className:"h-2.5 w-2.5 fill-current text-current"})})}));Qa.displayName=fl.displayName;const Cy=({value:t,onChange:s})=>e.jsxs("div",{className:"space-y-3",children:[e.jsx(Fe,{className:"text-sm font-bold",children:"Difficulty (affects XP reward)"}),e.jsxs(bd,{value:t,onValueChange:s,className:"grid grid-cols-3 gap-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(Qa,{value:"easy",id:"easy",className:"peer sr-only"}),e.jsxs(Fe,{htmlFor:"easy",className:"flex flex-col items-center gap-2 rounded-lg border-2 border-muted bg-background p-4 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary cursor-pointer transition-all",children:[e.jsx(Be,{className:"h-5 w-5 text-green-500"}),e.jsx("span",{className:"font-semibold",children:"Easy"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",Ir.EASY," XP"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Qa,{value:"medium",id:"medium",className:"peer sr-only"}),e.jsxs(Fe,{htmlFor:"medium",className:"flex flex-col items-center gap-2 rounded-lg border-2 border-muted bg-background p-4 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary cursor-pointer transition-all",children:[e.jsx(pt,{className:"h-5 w-5 text-orange-500"}),e.jsx("span",{className:"font-semibold",children:"Medium"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",Ir.MEDIUM," XP"]})]})]}),e.jsxs("div",{className:"relative",children:[e.jsx(Qa,{value:"hard",id:"hard",className:"peer sr-only"}),e.jsxs(Fe,{htmlFor:"hard",className:"flex flex-col items-center gap-2 rounded-lg border-2 border-muted bg-background p-4 hover:bg-accent hover:text-accent-foreground peer-data-[state=checked]:border-primary cursor-pointer transition-all",children:[e.jsx(wa,{className:"h-6 w-6 text-red-500"}),e.jsx("span",{className:"font-semibold",children:"Hard"}),e.jsxs("span",{className:"text-xs text-muted-foreground",children:["+",Ir.HARD," XP"]})]})]})]})]}),vd={jan:0,january:0,feb:1,february:1,mar:2,march:2,apr:3,april:3,may:4,jun:5,june:5,jul:6,july:6,aug:7,august:7,sep:8,sept:8,september:8,oct:9,october:9,nov:10,november:10,dec:11,december:11};function Sy(t){return t>=1&&t<=6?"pm":t>=7&&t<=11?"am":t===12?"pm":"am"}function to(t){let s=parseInt(t[1]);const a=t[2]?parseInt(t[2]):0;let r=t[3]?.toLowerCase();return!r&&s>=1&&s<=12&&(r=Sy(s)),r==="pm"&&s<12&&(s+=12),r==="am"&&s===12&&(s=0),`${s.toString().padStart(2,"0")}:${a.toString().padStart(2,"0")}`}function Ty(t){const s=t[1].toLowerCase(),a=parseInt(t[2]),r=vd[s];if(r===void 0||a<1||a>31)return Y(new Date,"yyyy-MM-dd");let i=Zt(new Date,r);return i=Is(i,a),i<new Date&&(i=Zt(new Date(xn(new Date)+1,0,1),r),i=Is(i,a)),Y(i,"yyyy-MM-dd")}function Ey(t){const s=parseInt(t[1]),a=t[2].toLowerCase(),r=vd[a];if(r===void 0||s<1||s>31)return Y(new Date,"yyyy-MM-dd");let i=Zt(new Date,r);return i=Is(i,s),i<new Date&&(i=Zt(new Date(xn(new Date)+1,0,1),r),i=Is(i,s)),Y(i,"yyyy-MM-dd")}function My(t){const s=parseInt(t[1]),a=parseInt(t[2]),r=s-1,i=a;if(r<0||r>11||i<1||i>31)return Y(new Date,"yyyy-MM-dd");let o=Zt(new Date,r);return o=Is(o,i),o<new Date&&(o=Zt(new Date(xn(new Date)+1,0,1),r),o=Is(o,i)),Y(o,"yyyy-MM-dd")}const wd=[{regex:/\bat\s+(\d{1,2})(?::(\d{2}))?\s*(am|pm)?/i,handler:to},{regex:/\b(\d{1,2})(?::(\d{2}))?\s*(am|pm)/i,handler:to},{regex:/\b(?:first\s*thing|wake\s*up|early\s*morning|dawn|sunrise)\b/i,handler:()=>"06:00"},{regex:/\bmorning\b/i,handler:()=>"09:00"},{regex:/\bmid[- ]?morning\b/i,handler:()=>"10:00"},{regex:/\b(?:noon|midday|lunch(?:time)?)\b/i,handler:()=>"12:00"},{regex:/\bearly\s*afternoon\b/i,handler:()=>"13:00"},{regex:/\bafternoon\b/i,handler:()=>"14:00"},{regex:/\blate\s*afternoon\b/i,handler:()=>"16:00"},{regex:/\b(?:before\s*dinner|pre[- ]?dinner)\b/i,handler:()=>"17:00"},{regex:/\bevening\b/i,handler:()=>"18:00"},{regex:/\b(?:after\s*dinner|post[- ]?dinner)\b/i,handler:()=>"19:00"},{regex:/\bnight\b/i,handler:()=>"21:00"},{regex:/\b(?:before\s*bed|bedtime|end\s*of\s*day)\b/i,handler:()=>"22:00"},{regex:/\blate\s*night\b/i,handler:()=>"23:00"},{regex:/\bmidnight\b/i,handler:()=>"00:00"}],jd=[{regex:/\bin\s+(\d+)\s*days?\b/i,handler:t=>Y(os(new Date,parseInt(t[1])),"yyyy-MM-dd")},{regex:/\bin\s+(\d+)\s*weeks?\b/i,handler:t=>Y(en(new Date,parseInt(t[1])),"yyyy-MM-dd")},{regex:/\bin\s+(\d+)\s*months?\b/i,handler:t=>Y(Ps(new Date,parseInt(t[1])),"yyyy-MM-dd")},{regex:/\bnext\s+week\b/i,handler:()=>Y(en(new Date,1),"yyyy-MM-dd")},{regex:/\btoday\b/i,handler:()=>Y(new Date,"yyyy-MM-dd")},{regex:/\btomorrow\b/i,handler:()=>Y(os(new Date,1),"yyyy-MM-dd")},{regex:/\bday\s*after\s*tomorrow\b/i,handler:()=>Y(os(new Date,2),"yyyy-MM-dd")},{regex:/\bthis\s*weekend\b/i,handler:()=>Y(Sr(new Date),"yyyy-MM-dd")},{regex:/\b(?:end\s*of\s*week|eow)\b/i,handler:()=>Y(Tr(new Date),"yyyy-MM-dd")},{regex:/\b(?:start\s*of\s*(?:next\s*)?week|beginning\s*of\s*week)\b/i,handler:()=>Y(Er(new Date),"yyyy-MM-dd")},{regex:/\b(?:end\s*of\s*month|eom)\b/i,handler:()=>Y(ga(new Date),"yyyy-MM-dd")},{regex:/\bnext\s*month\b/i,handler:()=>Y(fa(Ps(new Date,1)),"yyyy-MM-dd")},{regex:/\b(?:in\s*a\s*)?fortnight\b/i,handler:()=>Y(os(new Date,14),"yyyy-MM-dd")},{regex:/\b(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|june?|july?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\s+(\d{1,2})(?:st|nd|rd|th)?\b/i,handler:Ty},{regex:/\b(\d{1,2})(?:st|nd|rd|th)?\s+(jan(?:uary)?|feb(?:ruary)?|mar(?:ch)?|apr(?:il)?|may|june?|july?|aug(?:ust)?|sep(?:t(?:ember)?)?|oct(?:ober)?|nov(?:ember)?|dec(?:ember)?)\b/i,handler:Ey},{regex:/\b(\d{1,2})[/-](\d{1,2})\b/,handler:My},{regex:/\bnext\s+monday\b/i,handler:()=>Y(Er(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+tuesday\b/i,handler:()=>Y(Bn(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+wednesday\b/i,handler:()=>Y(Hn(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+thursday\b/i,handler:()=>Y(zn(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+friday\b/i,handler:()=>Y(Tr(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+saturday\b/i,handler:()=>Y(Sr(new Date),"yyyy-MM-dd")},{regex:/\bnext\s+sunday\b/i,handler:()=>Y(Un(new Date),"yyyy-MM-dd")},{regex:/\bmonday\b/i,handler:()=>Y(Er(new Date),"yyyy-MM-dd")},{regex:/\btuesday\b/i,handler:()=>Y(Bn(new Date),"yyyy-MM-dd")},{regex:/\bwednesday\b/i,handler:()=>Y(Hn(new Date),"yyyy-MM-dd")},{regex:/\bthursday\b/i,handler:()=>Y(zn(new Date),"yyyy-MM-dd")},{regex:/\bfriday\b/i,handler:()=>Y(Tr(new Date),"yyyy-MM-dd")},{regex:/\bsaturday\b/i,handler:()=>Y(Sr(new Date),"yyyy-MM-dd")},{regex:/\bsunday\b/i,handler:()=>Y(Un(new Date),"yyyy-MM-dd")}],_d=[{regex:/\bfor\s+(\d+)\s*h(?:ours?)?\b/i,handler:t=>parseInt(t[1])*60},{regex:/\bfor\s+(\d+)\s*m(?:in(?:utes?)?)?\b/i,handler:t=>parseInt(t[1])},{regex:/\b(\d+)\s*h(?:ours?)?\s*(?:(\d+)\s*m(?:in)?s?)?\b/i,handler:t=>parseInt(t[1])*60+(t[2]?parseInt(t[2]):0)},{regex:/\b(\d+)\s*m(?:in(?:utes?)?)?\b/i,handler:t=>parseInt(t[1])},{regex:/\bhalf\s*(?:an?\s*)?hour\b/i,handler:()=>30},{regex:/\bquarter\s*(?:of\s*an?\s*)?hour\b/i,handler:()=>15},{regex:/\b(?:a\s*)?couple\s*(?:of\s*)?hours?\b/i,handler:()=>120},{regex:/\b(?:a\s*)?few\s*(?:of\s*)?hours?\b/i,handler:()=>180},{regex:/\b(?:a\s*)?few\s*(?:of\s*)?min(?:ute)?s?\b/i,handler:()=>10},{regex:/\b(?:all|full)\s*day\b/i,handler:()=>480},{regex:/\bhalf\s*day\b/i,handler:()=>240},{regex:/\bquick\b/i,handler:()=>15},{regex:/\bbrief\b/i,handler:()=>5},{regex:/\bpomodoro\b/i,handler:()=>25},{regex:/\bdeep\s*work\b/i,handler:()=>90},{regex:/\bsprint\b/i,handler:()=>45}],Nd=[{regex:/\b(super\s+)?easy\b/i,result:"easy"},{regex:/\bsimple\b/i,result:"easy"},{regex:/\blight\b/i,result:"easy"},{regex:/\bbasic\b/i,result:"easy"},{regex:/\btrivial\b/i,result:"easy"},{regex:/\bhard\b/i,result:"hard"},{regex:/\bdifficult\b/i,result:"hard"},{regex:/\bchallenging\b/i,result:"hard"},{regex:/\bcomplex\b/i,result:"hard"},{regex:/\btough\b/i,result:"hard"},{regex:/\bintense\b/i,result:"hard"}],kd=[{regex:/!{4,}/,priority:"urgent"},{regex:/!{3}/,priority:"high"},{regex:/!{2}/,priority:"medium"},{regex:/!1\b/i,priority:"urgent"},{regex:/!2\b/i,priority:"high"},{regex:/!3\b/i,priority:"medium"},{regex:/!4\b/i,priority:"low"},{regex:/\bp1\b/i,priority:"urgent"},{regex:/\bp2\b/i,priority:"high"},{regex:/\bp3\b/i,priority:"medium"},{regex:/\bp4\b/i,priority:"low"},{regex:/\bURGENT\b/i,priority:"urgent"},{regex:/\bASAP\b/i,priority:"urgent"},{regex:/\bcritical\b/i,priority:"urgent"},{regex:/\bemergency\b/i,priority:"urgent"},{regex:/\bhigh\s*priority\b/i,priority:"high"},{regex:/\bimportant\b/i,priority:"high"},{regex:/\bmust\s+do\b/i,priority:"high"},{regex:/\bmedium\s*priority\b/i,priority:"medium"},{regex:/\blow\s*priority\b/i,priority:"low"},{regex:/\bsomeday\b/i,priority:"low"},{regex:/\bbacklog\b/i,priority:"low"},{regex:/\bwhenever\b/i,priority:"low"},{regex:/\btop\s*3\b/i,isTopThree:!0},{regex:/\b#1\b/,isTopThree:!0},{regex:/\bpriority\s*(?:one|1)\b/i,isTopThree:!0},{regex:/\bmost\s*important\b/i,isTopThree:!0},{regex:/\bmain\s*focus\b/i,isTopThree:!0}],Cd=[{regex:/\bevery\s*day\b/i,result:"daily"},{regex:/\bdaily\b/i,result:"daily"},{regex:/\bevery\s*week\b/i,result:"weekly"},{regex:/\bweekly\b/i,result:"weekly"},{regex:/\bevery\s*month\b/i,result:"monthly"},{regex:/\bmonthly\b/i,result:"monthly"},{regex:/\bevery\s*(monday|tuesday|wednesday|thursday|friday|saturday|sunday)\b/i,result:"weekly"},{regex:/\b(?:twice\s*(?:a\s*)?(?:day|daily)|2x\s*daily)\b/i,result:"twice_daily"},{regex:/\b(?:alternate\s*days?|every\s*other\s*day)\b/i,result:"alternate"},{regex:/\b(?:biweekly|every\s*(?:two|2)\s*weeks?)\b/i,result:"biweekly"}],Sd=[{regex:/\bweekdays?\s*(?:only)?\b/i,days:[1,2,3,4,5]},{regex:/\bweekends?\s*(?:only)?\b/i,days:[0,6]},{regex:/\bMWF\b|mon(?:day)?\s*wed(?:nesday)?\s*fri(?:day)?/i,days:[1,3,5]},{regex:/\bTTh?\b|tue(?:sday)?\s*thu(?:rsday)?/i,days:[2,4]},{regex:/\b(\d)x\s*(?:a\s*)?week\b/i,frequency:"custom"},{regex:/\b(?:three|3)\s*times?\s*(?:a\s*)?week\b/i,frequency:"3x_week"},{regex:/\b(?:five|5)\s*times?\s*(?:a\s*)?week\b/i,frequency:"5x_week"},{regex:/\b(?:twice|2x?)\s*(?:a\s*)?week\b/i,frequency:"2x_week"}],Td=[{regex:/@home\b/i,result:"home"},{regex:/@work\b/i,result:"work"},{regex:/@office\b/i,result:"work"},{regex:/@errands?\b/i,result:"errands"},{regex:/@phone\b/i,result:"phone"},{regex:/@computer\b/i,result:"computer"},{regex:/@anywhere\b/i,result:"anywhere"},{regex:/@gym\b/i,result:"gym"},{regex:/@outside\b/i,result:"outside"},{regex:/@online\b/i,result:"online"}],Ed=[{regex:/\blow\s*energy\b/i,result:"low"},{regex:/\btired\b/i,result:"low"},{regex:/\bexhausted\b/i,result:"low"},{regex:/\blazy\b/i,result:"low"},{regex:/\bhigh\s*energy\b/i,result:"high"},{regex:/\bfocused\b/i,result:"high"},{regex:/\benergetic\b/i,result:"high"},{regex:/\bpumped\b/i,result:"high"},{regex:/\bpeak\b/i,result:"high"}],Md=[{regex:/remind\s*(?:me\s+)?(\d+)\s*(?:min(?:ute)?s?)\s*(?:before|early|prior)/i,handler:t=>parseInt(t[1])},{regex:/remind\s*(?:me\s+)?(?:at\s+least\s+)?(\d+)\s*(?:h(?:ou)?rs?)\s*(?:before|early|prior)/i,handler:t=>parseInt(t[1])*60},{regex:/remind\s*(?:me\s+)?(?:a\s+)?half\s*(?:an?\s+)?(?:h(?:ou)?r)\s*(?:before|early|prior)/i,handler:()=>30},{regex:/remind\s*(?:me\s+)?(?:an?\s+|one\s+)(?:h(?:ou)?r)\s*(?:before|early|prior)/i,handler:()=>60},{regex:/remind\s*me\b/i,handler:()=>15},{regex:/(?:set|with)\s*(?:a\s+)?reminder/i,handler:()=>15}],Dd=[{regex:/\bnotes?:\s*(.+?)(?=\s*(?:!{1,4}|p[1-4]|\bat\s+\d|@|\bremind|\btomorrow|\btoday|$))/i,handler:t=>t[1].trim()},{regex:/\/\/\s*(.+?)$/i,handler:t=>t[1].trim()},{regex:/\(([^)]+)\)\s*$/i,handler:t=>t[1].trim()}],Pd=[{regex:/\b(?:remove|clear|delete|no|unset)\s*(?:the\s*)?(?:scheduled?\s*)?time\b/i,clears:"time"},{regex:/\b(?:remove|clear|delete|no|unset)\s*(?:the\s*)?(?:scheduled?\s*)?date\b/i,clears:"date"},{regex:/\b(?:remove|clear|delete|no|unset)\s*(?:the\s*)?(?:estimated?\s*)?duration\b/i,clears:"duration"},{regex:/\b(?:remove|clear|delete|no|unset|stop)\s*(?:the\s*)?(?:recurrence|repeat(?:ing)?)\b/i,clears:"recurrence"},{regex:/\bunschedule\b/i,clears:"both"},{regex:/\bclear\s*(?:all\s*)?schedule\b/i,clears:"both"},{regex:/\b(?:reset|clear\s*all|start\s*fresh|defaults?)\b/i,clears:"all"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?category\b/i,clears:"category"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?(?:attribute|type)\b/i,clears:"category"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?priority\b/i,clears:"priority"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?notes?\b/i,clears:"notes"},{regex:/\b(?:remove|clear|delete|no)\s*(?:the\s*)?remind(?:er)?\b/i,clears:"reminder"}],Ad=[{regex:/\b(?:for\s+)?(?:mind|mental|brain|cognitive|intellectual|thinking|#mind)\b/i,category:"mind"},{regex:/\b(?:for\s+)?(?:body|physical|fitness|workout|exercise|health|#body)\b/i,category:"body"},{regex:/\b(?:for\s+)?(?:soul|spirit(?:ual)?|emotional|heart|inner|#soul)\b/i,category:"soul"}],Rd=[{regex:/\b(?:pause|skip|disable|deactivate|turn\s*off|stop)\s*(?:this)?\b/i,paused:!0},{regex:/\b(?:resume|activate|enable|turn\s*on|unpause|start)\s*(?:this)?\b/i,paused:!1},{regex:/\b(?:archive|hide)\s*(?:this)?\b/i,archived:!0},{regex:/\b(?:unarchive|unhide|restore)\s*(?:this)?\b/i,archived:!1}],Id=[{regex:/\b(?:bonus|extra\s*credit|stretch\s*goal|optional|nice\s*to\s*have)\b/i,isBonus:!0},{regex:/\b(?:required|mandatory|essential|core)\b/i,isBonus:!1}],qd=[{regex:/\b(?:milestone|checkpoint|key\s*moment|major|significant|big\s*step)\b/i,isMilestone:!0}],Ld=[{regex:/\b(?:worth\s*)?(\d+)\s*(?:xp|points?|pts?)\b/i,handler:t=>parseInt(t[1])},{regex:/\b(?:double|2x)\s*xp\b/i,multiplier:2},{regex:/\b(?:triple|3x)\s*xp\b/i,multiplier:3},{regex:/\bhigh\s*value\b/i,xp:100},{regex:/\bquick\s*win\b/i,xp:25}],Fd=[{regex:/\b(?:rename|call\s*it|change\s*(?:name|title)\s*to)\s*[:\s]*["']?(.+?)["']?$/i,handler:t=>t[1].trim()}],Od=[{regex:/\b(?:break\s*(?:this\s*)?down|decompose|split\s*(?:into\s*)?(?:sub)?tasks?|suggest\s*(?:sub)?steps?|expand)\b/i,trigger:!0}],$d=[{regex:/\b(?:plan|schedule|organize|optimise|optimize)\s*(?:my|the|today'?s?)?\s*(?:day|schedule|tasks?|quests?)\b/i,trigger:!0},{regex:/\b(?:help\s*me\s*)?plan\s*(?:out\s*)?today\b/i,trigger:!0},{regex:/\bwhat\s*should\s*I\s*do\s*(?:today|first|next)\b/i,trigger:!0},{regex:/\b(?:build|create|make)\s*(?:my|a)?\s*schedule\b/i,trigger:!0},{regex:/\bauto[- ]?schedule\b/i,trigger:!0}],Bd=[{regex:/\b(?:plan|schedule|organize|optimise|optimize)\s*(?:my|the|this)?\s*week\b/i,trigger:!0},{regex:/\bweekly\s*(?:plan|planning|schedule)\b/i,trigger:!0},{regex:/\bwhat\s*should\s*I\s*do\s*this\s*week\b/i,trigger:!0},{regex:/\b(?:build|create|make)\s*(?:my|a)?\s*weekly\s*(?:plan|schedule)\b/i,trigger:!0},{regex:/\bplan\s*(?:out\s*)?(?:the\s*)?(?:next\s*)?(?:7|seven)\s*days?\b/i,trigger:!0},{regex:/\bweek\s*ahead\b/i,trigger:!0}];function Dy(t){let s=t;return[...wd.map(r=>r.regex),...jd.map(r=>r.regex),..._d.map(r=>r.regex),...Nd.map(r=>r.regex),...kd.map(r=>r.regex),...Cd.map(r=>r.regex),...Sd.map(r=>r.regex),...Td.map(r=>r.regex),...Ed.map(r=>r.regex),...Md.map(r=>r.regex),...Dd.map(r=>r.regex),...Pd.map(r=>r.regex),...Ad.map(r=>r.regex),...Rd.map(r=>r.regex),...Id.map(r=>r.regex),...qd.map(r=>r.regex),...Ld.map(r=>r.regex),...Fd.map(r=>r.regex),...Od.map(r=>r.regex),...$d.map(r=>r.regex),...Bd.map(r=>r.regex)].forEach(r=>{s=s.replace(r,"")}),s=s.replace(/\s+/g," ").replace(/^\s*[-,;:]\s*/,"").replace(/\s*[-,;:]\s*$/,"").trim(),s}function Py(t){const s={text:t,difficulty:"medium",scheduledTime:null,scheduledDate:null,estimatedDuration:null,recurrencePattern:null,recurrenceEndDate:null,priority:null,energyLevel:"medium",context:null,isTopThree:!1,reminderEnabled:!1,reminderMinutesBefore:null,notes:null,contactId:null,autoLogInteraction:!0,mentionedContactName:null,clearTime:!1,clearDate:!1,clearDuration:!1,clearRecurrence:!1,clearAll:!1,clearCategory:!1,clearPriority:!1,clearNotes:!1,clearReminder:!1,category:null,frequency:null,customDays:null,paused:null,archived:null,isBonus:null,isMilestone:null,xpReward:null,xpMultiplier:null,newTitle:null,triggerDecomposition:!1,triggerPlanMyDay:!1,triggerPlanMyWeek:!1,imageUrl:null};for(const a of Pd)a.regex.test(t)&&((a.clears==="time"||a.clears==="both")&&(s.clearTime=!0),(a.clears==="date"||a.clears==="both")&&(s.clearDate=!0),a.clears==="duration"&&(s.clearDuration=!0),a.clears==="recurrence"&&(s.clearRecurrence=!0),a.clears==="all"&&(s.clearAll=!0),a.clears==="category"&&(s.clearCategory=!0),a.clears==="priority"&&(s.clearPriority=!0),a.clears==="notes"&&(s.clearNotes=!0),a.clears==="reminder"&&(s.clearReminder=!0));for(const a of wd){const r=t.match(a.regex);if(r){s.scheduledTime=a.handler(r);break}}for(const a of jd){const r=t.match(a.regex);if(r){s.scheduledDate=a.handler(r);break}}for(const a of _d){const r=t.match(a.regex);if(r){s.estimatedDuration=a.handler(r);break}}for(const a of Nd)if(a.regex.test(t)){s.difficulty=a.result;break}for(const a of kd)a.regex.test(t)&&(a.isTopThree?s.isTopThree=!0:a.priority&&!s.priority&&(s.priority=a.priority));for(const a of Cd)if(a.regex.test(t)){s.recurrencePattern=a.result;break}for(const a of Sd)if(t.match(a.regex)){a.days&&(s.customDays=a.days),a.frequency&&(s.frequency=a.frequency);break}for(const a of Td)if(a.regex.test(t)){s.context=a.result;break}for(const a of Ed)if(a.regex.test(t)){s.energyLevel=a.result;break}for(const a of Md){const r=t.match(a.regex);if(r){s.reminderEnabled=!0,s.reminderMinutesBefore=a.handler(r);break}}for(const a of Ad)if(a.regex.test(t)){s.category=a.category;break}for(const a of Rd)if(a.regex.test(t)){a.paused!==void 0&&(s.paused=a.paused),a.archived!==void 0&&(s.archived=a.archived);break}for(const a of Id)if(a.regex.test(t)){s.isBonus=a.isBonus;break}for(const a of qd)if(a.regex.test(t)){s.isMilestone=a.isMilestone;break}for(const a of Ld){const r=t.match(a.regex);if(r){a.handler?s.xpReward=a.handler(r):a.xp?s.xpReward=a.xp:a.multiplier&&(s.xpMultiplier=a.multiplier);break}}for(const a of Fd){const r=t.match(a.regex);if(r){s.newTitle=a.handler(r);break}}for(const a of Od)if(a.regex.test(t)){s.triggerDecomposition=a.trigger;break}for(const a of Bd)if(a.regex.test(t)){s.triggerPlanMyWeek=a.trigger;break}if(!s.triggerPlanMyWeek){for(const a of $d)if(a.regex.test(t)){s.triggerPlanMyDay=a.trigger;break}}for(const a of Dd){const r=t.match(a.regex);if(r){s.notes=a.handler(r);break}}return s.text=Dy(t),s}function Ay(){const[t,s]=n.useState(""),[a,r]=n.useState(null);n.useEffect(()=>{t.trim()?r(Py(t)):r(null)},[t]);const i=n.useCallback(()=>{s(""),r(null)},[]);return{input:t,setInput:s,parsed:a,reset:i}}function Ry(){const[t,s]=n.useState("prompt"),[a,r]=n.useState(!0),i=n.useCallback(async()=>{if(!navigator.permissions)return navigator.mediaDevices?.getUserMedia?(s("prompt"),"prompt"):(s("unsupported"),"unsupported");try{const c=await navigator.permissions.query({name:"microphone"}),l=c.state==="granted"?"granted":c.state==="denied"?"denied":"prompt";return s(l),c.onchange=()=>{const u=c.state==="granted"?"granted":c.state==="denied"?"denied":"prompt";s(u)},l}catch{return s("prompt"),"prompt"}},[]),o=n.useCallback(async()=>{if(!navigator.mediaDevices?.getUserMedia)return s("unsupported"),"unsupported";try{return(await navigator.mediaDevices.getUserMedia({audio:!0})).getTracks().forEach(l=>l.stop()),s("granted"),"granted"}catch(c){if(c instanceof Error){if(c.name==="NotAllowedError"||c.name==="PermissionDeniedError")return s("denied"),"denied";if(c.name==="NotFoundError")return s("unsupported"),"unsupported"}return s("denied"),"denied"}},[]);return n.useEffect(()=>{i().finally(()=>r(!1))},[i]),{status:t,isLoading:a,checkPermission:i,requestPermission:o}}function Hd({onInterimResult:t,onFinalResult:s,onError:a,onPermissionNeeded:r,onAutoStopping:i,language:o="en-US",autoStopOnSilence:c=!0,silenceTimeoutMs:l=1500}={}){const[u,m]=n.useState(!1),[p,h]=n.useState(!1),f=n.useRef(null),d=n.useRef(null),{status:g,requestPermission:y,checkPermission:v}=Ry(),b=typeof window<"u"&&("SpeechRecognition"in window||"webkitSpeechRecognition"in window),x=n.useCallback(()=>{d.current&&(clearTimeout(d.current),d.current=null),h(!1)},[]),j=n.useCallback(()=>{x(),h(!1),f.current&&(f.current.stop(),f.current=null,m(!1))},[x]),w=n.useCallback(()=>{if(!b)return null;const M=window.SpeechRecognition||window.webkitSpeechRecognition;if(!M)return null;const C=new M;return C.continuous=!0,C.interimResults=!0,C.lang=o,C.onresult=R=>{let T="",q="";for(let k=R.resultIndex;k<R.results.length;k++){const P=R.results[k][0].transcript;R.results[k].isFinal?q+=P:T+=P}q&&s&&s(q),T&&t&&t(T),c&&(T||q)&&(x(),d.current=setTimeout(()=>{h(!0),i?.(),setTimeout(()=>{j()},300)},l))},C.onerror=R=>{console.error("Speech recognition error:",R.error),x(),m(!1),a&&a({"not-allowed":"Microphone access denied. Please enable microphone permissions.","no-speech":"No speech detected. Please try again.","audio-capture":"No microphone found. Please check your device.",network:"Network error. Please check your connection."}[R.error]||`Speech recognition error: ${R.error}`)},C.onend=()=>{x(),m(!1)},C},[b,o,t,s,a,c,l,x,j]),D=n.useCallback(async()=>{if(!b){a?.("Speech recognition is not supported in this browser.");return}const M=await v();if(M==="denied"||M==="unsupported"){r?.();return}if(M==="prompt"&&await y()!=="granted"){r?.();return}if(f.current=w(),f.current)try{f.current.start(),m(!0)}catch(C){console.error("Failed to start recording:",C),a?.("Failed to start recording. Please try again.")}},[b,w,a,v,y,r]),S=n.useCallback(()=>{u?j():D()},[u,D,j]);return n.useEffect(()=>()=>{x(),f.current&&f.current.stop()},[x]),{isRecording:u,isAutoStopping:p,isSupported:b,permissionStatus:g,startRecording:D,stopRecording:j,toggleRecording:S,requestPermission:y}}function Iy({onApply:t}){const[s,a]=n.useState(!1),{input:r,setInput:i,parsed:o,reset:c}=Ay(),{isRecording:l,toggleRecording:u,isSupported:m}=Hd({onInterimResult:f=>{i(d=>d+" "+f)},onFinalResult:f=>{i(d=>(d+" "+f).trim())},language:"en-US",autoStopOnSilence:!0}),p=o&&(o.scheduledTime||o.scheduledDate||o.estimatedDuration||o.difficulty!=="medium"||o.recurrencePattern||o.priority||o.context||o.isTopThree||o.reminderEnabled||o.notes||o.category||o.frequency||o.customDays||o.paused!==null||o.archived!==null||o.isBonus!==null||o.isMilestone!==null||o.xpReward||o.xpMultiplier||o.newTitle||o.triggerDecomposition||o.energyLevel!=="medium"||o.clearTime||o.clearDate||o.clearDuration||o.clearRecurrence||o.clearAll||o.clearCategory||o.clearPriority||o.clearNotes||o.clearReminder),h=()=>{o&&t(o),c(),a(!1)};return s?e.jsxs("div",{className:"space-y-3 p-3 rounded-lg bg-muted/50 border border-border",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(se,{className:"h-4 w-4 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"Quick Edit"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(He,{value:r,onChange:f=>i(f.target.value),placeholder:"e.g., 'at 3pm for 1 hour daily for body'",className:"flex-1 text-sm"}),m&&e.jsx(B,{variant:l?"destructive":"outline",size:"icon",onClick:u,className:"shrink-0",children:l?e.jsx(Dm,{className:"h-4 w-4"}):e.jsx(pn,{className:"h-4 w-4"})})]}),p&&e.jsxs("div",{className:"flex flex-wrap gap-2",children:[o.scheduledTime&&e.jsxs(Ie,{color:"primary",children:["â° ",o.scheduledTime]}),o.scheduledDate&&e.jsxs(Ie,{color:"accent",children:["ðŸ“… ",o.scheduledDate]}),o.estimatedDuration&&e.jsxs(Ie,{color:"secondary",children:["â±ï¸ ",o.estimatedDuration,"min"]}),o.difficulty!=="medium"&&e.jsxs(Ie,{color:o.difficulty==="easy"?"green":"red",children:[o.difficulty==="easy"?"ðŸŒ±":"ðŸ”¥"," ",o.difficulty]}),o.recurrencePattern&&e.jsxs(Ie,{color:"purple",children:["ðŸ”„ ",o.recurrencePattern]}),o.priority&&e.jsxs(Ie,{color:o.priority==="urgent"?"red":o.priority==="high"?"orange":"blue",children:["âš¡ ",o.priority]}),o.category&&e.jsxs(Ie,{color:o.category==="mind"?"blue":o.category==="body"?"green":"purple",children:[o.category==="mind"?"ðŸ§ ":o.category==="body"?"ðŸ’ª":"âœ¨"," ",o.category]}),o.context&&e.jsxs(Ie,{color:"secondary",children:["ðŸ“ @",o.context]}),o.energyLevel!=="medium"&&e.jsxs(Ie,{color:o.energyLevel==="low"?"gray":"yellow",children:[o.energyLevel==="low"?"ðŸ˜´":"âš¡"," ",o.energyLevel," energy"]}),o.frequency&&e.jsxs(Ie,{color:"purple",children:["ðŸ“Š ",o.frequency]}),o.customDays&&e.jsxs(Ie,{color:"purple",children:["ðŸ“… ",qy(o.customDays)]}),o.isTopThree&&e.jsx(Ie,{color:"yellow",children:"â­ Top 3"}),o.reminderEnabled&&e.jsxs(Ie,{color:"blue",children:["ðŸ”” ",o.reminderMinutesBefore?`${o.reminderMinutesBefore}min before`:"reminder"]}),o.isBonus===!0&&e.jsx(Ie,{color:"yellow",children:"ðŸŽ Bonus"}),o.isBonus===!1&&e.jsx(Ie,{color:"primary",children:"âœ“ Required"}),o.isMilestone&&e.jsx(Ie,{color:"gold",children:"ðŸ† Milestone"}),o.xpReward&&e.jsxs(Ie,{color:"yellow",children:["âœ¨ ",o.xpReward," XP"]}),o.xpMultiplier&&e.jsxs(Ie,{color:"yellow",children:["âœ¨ ",o.xpMultiplier,"x XP"]}),o.paused===!0&&e.jsx(Ie,{color:"orange",children:"â¸ï¸ Pause"}),o.paused===!1&&e.jsx(Ie,{color:"green",children:"â–¶ï¸ Resume"}),o.archived===!0&&e.jsx(Ie,{color:"gray",children:"ðŸ“¦ Archive"}),o.newTitle&&e.jsxs(Ie,{color:"primary",children:['âœï¸ "',o.newTitle,'"']}),o.triggerDecomposition&&e.jsx(Ie,{color:"blue",children:"ðŸ”€ Break down"}),o.notes&&e.jsx(Ie,{color:"secondary",children:"ðŸ“ Note added"}),o.clearAll&&e.jsx(Ie,{color:"destructive",children:"ðŸš« Reset all"}),o.clearTime&&!o.clearAll&&e.jsx(Ie,{color:"destructive",children:"ðŸš« Remove time"}),o.clearDate&&!o.clearAll&&e.jsx(Ie,{color:"destructive",children:"ðŸš« Remove date"}),o.clearDuration&&!o.clearAll&&e.jsx(Ie,{color:"destructive",children:"ðŸš« Remove duration"}),o.clearRecurrence&&!o.clearAll&&e.jsx(Ie,{color:"destructive",children:"ðŸš« Remove repeat"}),o.clearCategory&&!o.clearAll&&e.jsx(Ie,{color:"destructive",children:"ðŸš« Remove category"}),o.clearPriority&&!o.clearAll&&e.jsx(Ie,{color:"destructive",children:"ðŸš« Remove priority"}),o.clearNotes&&!o.clearAll&&e.jsx(Ie,{color:"destructive",children:"ðŸš« Remove notes"}),o.clearReminder&&!o.clearAll&&e.jsx(Ie,{color:"destructive",children:"ðŸš« Remove reminder"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(B,{variant:"ghost",size:"sm",onClick:()=>{c(),a(!1)},className:"flex-1",children:"Cancel"}),e.jsxs(B,{size:"sm",onClick:h,disabled:!p,className:"flex-1 gap-1",children:[e.jsx(Xe,{className:"h-3 w-3"}),"Apply"]})]})]}):e.jsxs(B,{variant:"ghost",size:"sm",onClick:()=>a(!0),className:"w-full justify-start text-muted-foreground hover:text-foreground gap-2",children:[e.jsx(se,{className:"h-4 w-4"}),"Quick edit with natural language..."]})}function Ie({children:t,color:s}){const a={primary:"bg-primary/10 text-primary",accent:"bg-accent/50 text-accent-foreground",secondary:"bg-secondary text-secondary-foreground",green:"bg-green-500/20 text-green-600 dark:text-green-400",red:"bg-red-500/20 text-red-600 dark:text-red-400",purple:"bg-purple-500/20 text-purple-600 dark:text-purple-400",blue:"bg-blue-500/20 text-blue-600 dark:text-blue-400",orange:"bg-orange-500/20 text-orange-600 dark:text-orange-400",yellow:"bg-yellow-500/20 text-yellow-600 dark:text-yellow-400",gold:"bg-amber-500/20 text-amber-600 dark:text-amber-400",gray:"bg-muted text-muted-foreground",destructive:"bg-destructive/20 text-destructive"};return e.jsx("span",{className:E("inline-flex items-center gap-1 px-2 py-1 rounded-full text-xs",a[s]||a.secondary),children:t})}function qy(t){const s=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];return t.map(a=>s[a]).join(", ")}const zd=["M","T","W","T","F","S","S"],Ly=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],Fy=[{value:"daily",label:"Daily",days:[0,1,2,3,4,5,6]},{value:"5x_week",label:"Weekdays",days:[0,1,2,3,4]},{value:"weekly",label:"Weekly",days:[0]},{value:"custom",label:"Custom",days:[]}];function Ud({frequency:t,customDays:s,onFrequencyChange:a}){const r=t==="weekly"||t==="custom",i=c=>{a(c.value,c.days)},o=c=>{const l=s.includes(c)?s.filter(u=>u!==c):[...s,c].sort((u,m)=>u-m);a(t,l)};return e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-[10px] text-muted-foreground block",children:"Frequency"}),e.jsx("div",{className:"flex flex-wrap gap-1",children:Fy.map(c=>e.jsx("button",{type:"button",onClick:()=>i(c),className:E("px-2 py-1 text-xs rounded-full border transition-all",t===c.value?"bg-primary text-primary-foreground border-primary":"bg-background border-border text-muted-foreground hover:border-primary/50"),children:c.label},c.value))}),r&&e.jsx("div",{className:"flex gap-1 pt-1",children:zd.map((c,l)=>e.jsx("button",{type:"button",onClick:()=>o(l),title:Ly[l],className:E("w-7 h-7 rounded-full text-[10px] font-bold transition-all border",s.includes(l)?"bg-primary border-primary text-primary-foreground":"border-border bg-background text-muted-foreground hover:border-primary/50"),children:c},l))})]})}function Wd(t){switch(t){case"daily":return[0,1,2,3,4,5,6];case"weekdays":case"5x_week":return[0,1,2,3,4];case"weekly":return[0];default:return[]}}function Oy(t){return!t||t.length===0||t.length===7?"":t.map(s=>zd[s]).join("")}const so={mind:{icon:Rt,label:"Mind",color:"text-blue-500 border-blue-500/50 bg-blue-500/10"},body:{icon:on,label:"Body",color:"text-green-500 border-green-500/50 bg-green-500/10"},soul:{icon:pt,label:"Soul",color:"text-orange-500 border-orange-500/50 bg-orange-500/10"}},$y=n.memo(function({ritual:s,open:a,onOpenChange:r,onSaveComplete:i,onDelete:o,isDeleting:c}){const{user:l}=ce(),u=Se(),[m,p]=n.useState(""),[h,f]=n.useState(""),[d,g]=n.useState("daily"),[y,v]=n.useState(null),[b,x]=n.useState(""),[j,w]=n.useState("medium"),[D,S]=n.useState("soul"),[M,C]=n.useState(null),[R,T]=n.useState([]),[q,k]=n.useState(!1),[P,A]=n.useState(15),[L,H]=n.useState(!1),[I,te]=n.useState(!1),[V,z]=n.useState(!1);n.useEffect(()=>{s&&(p(s.title),f(s.description||""),g(s.frequency||"daily"),v(s.estimated_minutes||null),x(s.preferred_time||""),w(s.difficulty||"medium"),S(s.category||"soul"),C(s.recurrence_pattern||null),T(s.recurrence_days||s.custom_days||[]),k(s.reminder_enabled||!1),A(s.reminder_minutes_before||15),H(!!s.recurrence_pattern||!!s.reminder_enabled||!!s.category))},[s]);const W=$=>{if($.clearAll){x(""),v(null),C(null),T([]),k(!1);return}$.newTitle?p($.newTitle):$.text&&$.text!==m&&p($.text),$.scheduledTime&&x($.scheduledTime),$.estimatedDuration&&v($.estimatedDuration),$.difficulty&&w($.difficulty),$.recurrencePattern&&C($.recurrencePattern),$.category&&S($.category),$.customDays&&T($.customDays),$.reminderEnabled&&(k(!0),$.reminderMinutesBefore&&A($.reminderMinutesBefore)),$.clearTime&&x(""),$.clearDuration&&v(null),$.clearRecurrence&&(C(null),T([])),$.clearCategory&&S("soul"),$.clearReminder&&k(!1)},Q=async()=>{if(!(!s||!l?.id||!m.trim())){te(!0);try{const $={title:m.trim(),description:h.trim()||null,frequency:d,estimated_minutes:y,difficulty:j,preferred_time:b||null,category:D,custom_days:R.length>0?R:null},J={task_text:m.trim(),difficulty:j,scheduled_time:b||null,estimated_duration:y,category:D,recurrence_pattern:M,recurrence_days:R,reminder_enabled:q,reminder_minutes_before:P},{error:O}=await N.from("habits").update($).eq("id",s.habitId).eq("user_id",l.id);if(O){console.error("Error updating habit:",O),X.error("Failed to update ritual template");return}const{error:le}=await N.from("daily_tasks").update(J).eq("habit_source_id",s.habitId).eq("user_id",l.id).eq("completed",!1);le?(console.error("Error updating linked tasks:",le),X.warning("Ritual updated, but some task instances may not have synced")):X.success("Ritual updated everywhere!"),u.invalidateQueries({queryKey:["habits"]}),u.invalidateQueries({queryKey:["daily-tasks"]}),u.invalidateQueries({queryKey:["epics"]}),u.invalidateQueries({queryKey:["habit-surfacing"]}),u.invalidateQueries({queryKey:["epic-progress"]}),i?.(),r(!1)}catch($){console.error("Error saving ritual:",$),X.error("Failed to save changes")}finally{te(!1)}}},U=async()=>{!s||!o||(await o(s.habitId),z(!1),r(!1))};return e.jsxs(Pn,{open:a,onOpenChange:r,children:[e.jsxs(yr,{side:"bottom",className:"h-[85vh] rounded-t-xl",children:[e.jsxs(od,{className:"pb-2",children:[e.jsxs(cd,{className:"flex items-center gap-2",children:[e.jsx(vs,{className:"h-5 w-5 text-accent"}),"Edit Ritual"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Changes sync to all instances of this ritual"})]}),e.jsx(hr,{className:"h-[calc(85vh-140px)] pr-4",children:e.jsxs("div",{className:"space-y-6 py-4","data-vaul-no-drag":!0,children:[e.jsx(Iy,{onApply:W}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{htmlFor:"title",children:"Ritual Name"}),e.jsx(He,{id:"title",value:m,onChange:$=>p($.target.value),placeholder:"What's your ritual?"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{htmlFor:"description",children:"Description"}),e.jsx(xt,{id:"description",value:h,onChange:$=>f($.target.value),placeholder:"What does this ritual involve? Add details about how to perform it, timing, or any tips...",rows:3}),!h&&e.jsx("p",{className:"text-xs text-muted-foreground",children:"Add details about what this ritual involves - this was generated when you created your campaign"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{children:"Difficulty"}),e.jsx(Cy,{value:j,onChange:w})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{htmlFor:"time",children:"Scheduled Time"}),e.jsx(He,{id:"time",type:"time",value:b,onChange:$=>x($.target.value)})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{htmlFor:"duration",children:"Duration (min)"}),e.jsx(He,{id:"duration",type:"number",value:y||"",onChange:$=>v($.target.value?parseInt($.target.value):null),placeholder:"30",min:"1"})]})]}),e.jsx(Ud,{frequency:d==="3x_week"?"custom":d,customDays:R,onFrequencyChange:($,J)=>{g($),T(J)}}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{children:"Attribute Boost"}),e.jsx("div",{className:"flex gap-2",children:Object.keys(so).map($=>{const J=so[$],O=J.icon;return e.jsxs(B,{type:"button",variant:"outline",size:"sm",onClick:()=>S($),className:E("flex-1 gap-2",D===$&&J.color),children:[e.jsx(O,{className:"h-4 w-4"}),J.label]},$)})}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Which companion attribute grows when you complete this ritual"})]}),e.jsxs("div",{className:"pt-2",children:[e.jsxs(B,{variant:"ghost",size:"sm",onClick:()=>H(!L),className:"w-full justify-between text-muted-foreground",children:["Advanced Options",e.jsx("span",{className:"text-xs",children:L?"â–²":"â–¼"})]}),L&&e.jsx("div",{className:"mt-4",children:e.jsx(Mn,{scheduledTime:b||null,estimatedDuration:y,recurrencePattern:M,recurrenceDays:R,reminderEnabled:q,reminderMinutesBefore:P,moreInformation:null,onScheduledTimeChange:x,onEstimatedDurationChange:v,onRecurrencePatternChange:C,onRecurrenceDaysChange:T,onReminderEnabledChange:k,onReminderMinutesBeforeChange:A,onMoreInformationChange:()=>{},location:null,onLocationChange:()=>{},hideRecurrence:!0})})]}),o&&e.jsx("div",{className:"pt-6 mt-4 border-t border-border/50",children:e.jsxs(B,{variant:"ghost",onClick:()=>z(!0),disabled:c||I,className:"w-full text-destructive hover:text-destructive hover:bg-destructive/10",children:[e.jsx(es,{className:"w-4 h-4 mr-2"}),"Delete Ritual"]})})]})}),e.jsxs(ld,{className:"pt-4 flex gap-2",children:[e.jsx(B,{variant:"outline",className:"flex-1",onClick:()=>r(!1),disabled:I,children:"Cancel"}),e.jsx(B,{className:"flex-1",onClick:Q,disabled:I||!m.trim(),children:I?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"w-4 h-4 mr-2 animate-spin"}),"Saving..."]}):"Save Changes"})]})]}),e.jsx(_a,{open:V,onOpenChange:z,children:e.jsxs(Ws,{children:[e.jsxs(Qs,{children:[e.jsx(Gs,{children:"Delete this ritual?"}),e.jsxs(Ys,{children:['This will permanently delete "',s?.title,'" and remove all future instances. Completed tasks will remain in your history.']})]}),e.jsxs(Ks,{children:[e.jsx(Vs,{children:"Cancel"}),e.jsx(ws,{onClick:U,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:c?"Deleting...":"Delete"})]})]})})]})}),By=t=>{const{user:s}=ce(),a=t?Y(t,"yyyy-MM-dd"):Y(new Date,"yyyy-MM-dd"),{data:r=[],isLoading:i,error:o}=ye({queryKey:["daily-tasks",s?.id,a],queryFn:async()=>{if(!s?.id)throw new Error("User not authenticated");const{data:u,error:m}=await N.from("daily_tasks").select(`
          *,
          epics(title),
          contact:contacts!contact_id(id, name, avatar_url)
        `).eq("user_id",s.id).eq("task_date",a).order("sort_order",{ascending:!0}).order("created_at",{ascending:!1});if(m)throw console.error("Failed to fetch daily tasks:",m),m;return(u||[]).map(p=>({...p,epic_title:p.epics?.title||null,contact:p.contact}))},enabled:!!s?.id,staleTime:120*1e3,gcTime:1800*1e3,placeholderData:u=>u,refetchOnWindowFocus:!1}),c=r.filter(u=>u.completed).length,l=r.length;return{tasks:r,isLoading:i,error:o,taskDate:a,completedCount:c,totalCount:l}},Hy=Pm("WidgetData",{web:()=>me(()=>import("./WidgetDataWeb-BsckqRvB.js"),__vite__mapDeps([14,1,2,3])).then(t=>new t.WidgetDataWeb)}),zy=(t,s)=>{const a=n.useRef(""),r=Ke.isNativePlatform()&&Ke.getPlatform()==="ios",i=n.useCallback(async(o=!1)=>{if(!r)return;const c=t.filter(p=>!p.habit_source_id),l=t.filter(p=>!!p.habit_source_id),u=JSON.stringify({questCount:c.length,questCompleted:c.filter(p=>p.completed).length,ritualCount:l.length,ritualCompleted:l.filter(p=>p.completed).length,ids:c.slice(0,10).map(p=>p.id+":"+p.completed),date:s});if(!o&&u===a.current)return;a.current=u;const m=c.slice(0,10).map(p=>({id:p.id,text:p.task_text,completed:p.completed??!1,xpReward:p.xp_reward,isMainQuest:p.is_main_quest??!1,category:p.category,section:Uy(p.scheduled_time),scheduledTime:p.scheduled_time}));try{console.log("[WidgetSync] Syncing",m.length,"quests +",l.length,"rituals for",s),await Hy.updateWidgetData({tasks:m,completedCount:c.filter(p=>p.completed).length,totalCount:c.length,ritualCount:l.length,ritualCompleted:l.filter(p=>p.completed).length,date:s}),console.log("[WidgetSync] Sync complete")}catch(p){console.error("[WidgetSync] Failed to sync:",p)}},[t,s,r]);return n.useEffect(()=>{t.length>0&&i()},[i,t.length]),n.useEffect(()=>{if(r&&t.length>0){const o=setTimeout(()=>{i(!0)},500);return()=>clearTimeout(o)}},[r,t.length>0]),n.useEffect(()=>{if(!r)return;const o=()=>{console.log("[WidgetSync] App resumed, forcing sync"),i(!0)},c=Ka.addListener("appStateChange",({isActive:l})=>{l&&o()});return()=>{c.then(l=>l.remove())}},[r,i]),{syncToWidget:i}};function Uy(t){if(!t)return"unscheduled";const s=parseInt(t.split(":")[0],10);return s<12?"morning":s<17?"afternoon":"evening"}const Wy=t=>{const{tasks:s,isLoading:a,taskDate:r,completedCount:i,totalCount:o}=By(t);zy(s,r);const{addTask:c,toggleTask:l,deleteTask:u,setMainQuest:m,updateTask:p,reorderTasks:h,moveTaskToSection:f,moveTaskToDate:d,restoreTask:g,isAdding:y,isToggling:v,isDeleting:b,isUpdating:x,isReordering:j,isMoving:w,isMovingDate:D,isRestoring:S}=fd(r);return{tasks:s,isLoading:a,addTask:c,toggleTask:l,deleteTask:u,setMainQuest:m,updateTask:p,reorderTasks:h,moveTaskToSection:f,moveTaskToDate:d,restoreTask:g,isAdding:y,isToggling:v,isDeleting:b,isUpdating:x,isReordering:j,isMoving:w,isMovingDate:D,isRestoring:S,completedCount:i,totalCount:o}},Qy=(t,s)=>{const{user:a}=ce(),r=()=>{{const p=fa(t),h=ga(t),f=bl(p,{weekStartsOn:0}),d=vl(h,{weekStartsOn:0});return{start:f,end:d}}},{start:i,end:o}=r(),c=Y(i,"yyyy-MM-dd"),l=Y(o,"yyyy-MM-dd"),{data:u=[],isLoading:m}=ye({queryKey:["calendar-tasks",a?.id,c,l,s],queryFn:async()=>{if(!a?.id)throw new Error("User not authenticated");const{data:p,error:h}=await N.from("daily_tasks").select("*").eq("user_id",a.id).gte("task_date",c).lte("task_date",l).order("scheduled_time",{ascending:!0,nullsFirst:!1}).order("created_at",{ascending:!1});if(h)throw h;return p||[]},enabled:!!a,staleTime:120*1e3,refetchOnWindowFocus:!1});return{tasks:u,isLoading:m}},Gr=t=>{const s=t.toLowerCase(),a=["read","study","learn","course","book","lesson","tutorial","class","lecture","podcast","audiobook","article","research","education","work","meeting","email","project","deadline","task","report","present","schedule","agenda","calendar","productivity","efficient","prioritize","plan","organize","budget","finance","goal","track","review","prepare","declutter","sort","file","list","todo","checklist","write","journal","blog","code","program","develop","design","build","debug","test","deploy","website","app","software","think","analyze","solve","problem","puzzle","brain","mental","focus","concentrate","memory","memorize","practice","skill","improve","strategy","calculate","math","logic","critical","decision","language","spanish","french","german","japanese","chinese","korean","english","duolingo","vocabulary","grammar","fluent"],r=["exercise","workout","run","running","walk","walking","jog","jogging","gym","lift","weight","strength","cardio","hiit","crossfit","fitness","train","training","marathon","sprint","rep","set","warmup","cooldown","yoga","pilates","stretch","stretching","swim","swimming","bike","cycling","hike","hiking","climb","climbing","dance","dancing","sport","tennis","basketball","soccer","football","golf","martial","boxing","kickbox","push-up","pushup","sit-up","situp","squat","plank","burpee","lunge","deadlift","bench","curl","crunch","jumping","step","abs","core","eat","meal","breakfast","lunch","dinner","snack","cook","cooking","diet","nutrition","protein","vegetable","fruit","healthy","calorie","fast","fasting","keto","vegan","portion","prep","recipe","sleep","rest","nap","hydrate","water","vitamin","supplement","health","doctor","dentist","medicine","checkup","therapy","physical","shower","hygiene","skincare","teeth","floss","brush","groom","posture","ergonomic","stand","move","active","steps","outdoor","recover","recovery","foam","massage","ice","heat","sauna"],i=["meditate","meditation","mindful","mindfulness","breathe","breathing","calm","peace","peaceful","quiet","stillness","present","aware","center","ground","zen","mantra","affirmation","pray","prayer","spiritual","soul","spirit","faith","worship","church","temple","mosque","scripture","bible","devotion","sacred","gratitude","grateful","thankful","appreciate","appreciation","bless","reflect","reflection","introspect","self-care","selfcare","healing","emotion","emotional","feel","feeling","mood","happy","joy","positive","anxiety","stress","cope","release","let go","forgive","accept","therapy","therapist","counseling","mental health","friend","family","partner","spouse","parent","child","loved","call","text","connect","connection","relationship","social","community","talk","listen","conversation","catch up","visit","hang out","date","help","volunteer","donate","give","giving","charity","serve","service","kindness","kind","compassion","empathy","care","support","encourage","art","artist","creative","create","paint","painting","draw","drawing","sketch","craft","diy","pottery","knit","sew","photography","photo","music","sing","singing","song","instrument","piano","guitar","drum","practice music","play music","compose","melody","perform","nature","garden","gardening","plant","flower","outdoor","park","beach","sunset","sunrise","stargazing","wildlife","bird","pet","dog","cat","relax","relaxation","unwind","hobby","fun","enjoy","pleasure","treat","spa","bath","candle","tea","cozy","comfort","movie","show","inspire","inspiration","dream","vision","purpose","meaning","value","intention","manifest","visualize","believe","hope","aspire","transform"],o=p=>p.filter(h=>h.includes(" ")?s.includes(h):new RegExp(`\\b${h}\\b|${h}s?\\b`,"i").test(s)).length,c=o(a),l=o(r),u=o(i),m=Math.max(c,l,u);return m===0?null:c===m?"mind":l===m?"body":u===m?"soul":null};function ao(t,s){switch(t.frequency?.toLowerCase()){case"daily":return!0;case"weekly":return t.custom_days&&t.custom_days.length>0?t.custom_days.includes(s):s===0;case"weekdays":case"5x_week":return s>=0&&s<=4;case"weekends":return s===5||s===6;case"3x_week":return t.custom_days&&t.custom_days.length>0?t.custom_days.includes(s):[0,2,4].includes(s);case"custom":return t.custom_days&&t.custom_days.length>0?t.custom_days.includes(s):!1;default:return!0}}function Ky(t){const{user:s}=ce(),a=Se(),r=Ll(),i=Hp(),o=i===0?6:i-1,{data:c,isLoading:l,error:u}=ye({queryKey:["habit-surfacing",s?.id,r],queryFn:async()=>{if(!s?.id)return[];const{data:f,error:d}=await N.from("habits").select(`
          id,
          title,
          description,
          difficulty,
          category,
          frequency,
          estimated_minutes,
          preferred_time,
          custom_days,
          epic_habits(epic_id, epics(id, title, status))
        `).eq("user_id",s.id).eq("is_active",!0);if(d)throw d;const{data:g,error:y}=await N.from("daily_tasks").select("id, habit_source_id, completed").eq("user_id",s.id).eq("task_date",r).not("habit_source_id","is",null);if(y)throw y;const v=new Map(g?.map(x=>[x.habit_source_id,x])||[]);return(f||[]).filter(x=>{const j=x.epic_habits?.[0],w=j?.epics;return!(j&&w&&w.status!=="active")}).map(x=>{const w=x.epic_habits?.[0]?.epics,D=v.get(x.id);return{id:x.id,habit_id:x.id,habit_name:x.title,habit_description:x.description||null,frequency:x.frequency||"daily",estimated_minutes:x.estimated_minutes||null,preferred_time:x.preferred_time||null,epic_id:w?.id||null,epic_title:w?.title||null,task_id:D?.id||null,is_completed:D?.completed||!1,category:Gr(x.title),custom_days:x.custom_days||null}})},enabled:!!s?.id}),m=ie({mutationFn:async f=>{if(!s?.id)throw new Error("Not authenticated");const d=c?.find(v=>v.habit_id===f);if(!d)throw new Error("Habit not found");if(d.task_id)return{id:d.task_id};const{data:g,error:y}=await N.from("daily_tasks").insert({user_id:s.id,task_text:d.habit_name,task_date:r,habit_source_id:f,epic_id:d.epic_id,category:Gr(d.habit_name),source:"recurring",scheduled_time:d.preferred_time,estimated_duration:d.estimated_minutes}).select("id").single();if(y)throw y;return g},onSuccess:()=>{a.invalidateQueries({queryKey:["habit-surfacing"]}),a.invalidateQueries({queryKey:["tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]}),a.invalidateQueries({queryKey:["daily-tasks"]})}}),p=ie({mutationFn:async()=>{if(!s?.id)throw new Error("Not authenticated");const f=c?.filter(j=>!j.task_id&&ao(j,o))||[];if(console.log("[Habit Surfacing] Habits to surface:",f.length,f),f.length===0)return console.log("[Habit Surfacing] No habits need surfacing"),[];const d=f.map(j=>({user_id:s.id,task_text:j.habit_name,task_date:r,habit_source_id:j.habit_id,epic_id:j.epic_id,category:Gr(j.habit_name),source:"recurring",scheduled_time:j.preferred_time,estimated_duration:j.estimated_minutes})),{data:g}=await N.from("daily_tasks").select("habit_source_id").eq("user_id",s.id).eq("task_date",r).not("habit_source_id","is",null),y=new Set(g?.map(j=>j.habit_source_id)||[]),v=d.filter(j=>!y.has(j.habit_source_id));if(console.log("[Habit Surfacing] Inserting new tasks:",v.length,"of",d.length),v.length===0)return console.log("[Habit Surfacing] All habits already have tasks for today"),[];const{data:b,error:x}=await N.from("daily_tasks").insert(v).select("id");if(x)throw console.error("[Habit Surfacing] Insert error:",x),x;return console.log("[Habit Surfacing] Successfully surfaced",b?.length,"habits"),b},onSuccess:f=>{a.invalidateQueries({queryKey:["habit-surfacing"]}),a.invalidateQueries({queryKey:["tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]}),a.invalidateQueries({queryKey:["daily-tasks"]}),f&&f.length>0&&X.success(`${f.length} ritual${f.length>1?"s":""} added to today's quests`)},onError:f=>{console.error("[Habit Surfacing] Mutation error:",f),X.error("Failed to surface habits as quests")}}),h=c?.filter(f=>!f.task_id&&ao(f,o)).length||0;return{surfacedHabits:c||[],isLoading:l,error:u,surfaceHabit:m.mutate,surfaceAllEpicHabits:p.mutate,surfaceAllHabits:p.mutate,unsurfacedEpicHabitsCount:h,unsurfacedHabitsCount:h}}function Gy(t){const{user:s}=ce(),a=Se(),r=Y(t||new Date,"yyyy-MM-dd"),i=Km(t||new Date),{data:o,isLoading:c}=ye({queryKey:["recurring-templates",s?.id,r],queryFn:async()=>{if(!s?.id)return[];const{data:u,error:m}=await N.from("daily_tasks").select(`
          id,
          task_text,
          difficulty,
          scheduled_time,
          estimated_duration,
          category,
          recurrence_pattern,
          recurrence_days,
          recurrence_end_date,
          xp_reward,
          epic_id,
          reminder_enabled,
          reminder_minutes_before
        `).eq("user_id",s.id).eq("is_recurring",!0).not("recurrence_pattern","is",null);if(m)throw m;const{data:p,error:h}=await N.from("daily_tasks").select("parent_template_id, task_text").eq("user_id",s.id).eq("task_date",r);if(h)throw h;const f=new Set(p?.filter(y=>y.parent_template_id).map(y=>y.parent_template_id)),d=new Set(p?.map(y=>y.task_text.toLowerCase()));return(u||[]).filter(y=>{if(f.has(y.id)||d.has(y.task_text.toLowerCase()))return!1;if(y.recurrence_end_date){const v=At(y.recurrence_end_date);if((t||new Date)>v)return!1}return Yy(y,i)})},enabled:!!s?.id}),l=ie({mutationFn:async()=>{if(!s?.id||!o?.length)return[];const u=o.map(h=>({user_id:s.id,task_text:h.task_text,task_date:r,difficulty:h.difficulty,scheduled_time:h.scheduled_time,estimated_duration:h.estimated_duration,category:h.category,xp_reward:h.xp_reward,epic_id:h.epic_id,reminder_enabled:h.reminder_enabled,reminder_minutes_before:h.reminder_minutes_before,parent_template_id:h.id,source:"recurring",is_recurring:!1})),{data:m,error:p}=await N.from("daily_tasks").upsert(u,{onConflict:"user_id,task_date,parent_template_id",ignoreDuplicates:!0}).select("id");if(p)throw p;return m},onSuccess:u=>{a.invalidateQueries({queryKey:["recurring-templates"]}),a.invalidateQueries({queryKey:["tasks"]}),a.invalidateQueries({queryKey:["daily-tasks"]}),a.invalidateQueries({queryKey:["calendar-tasks"]}),u&&u.length>0&&console.log(`[RecurringSpawner] Spawned ${u.length} recurring tasks for ${r}`)},onError:u=>{console.error("[RecurringSpawner] Failed to spawn recurring tasks:",u),X.error("Failed to create recurring quests")}});return{pendingRecurringCount:o?.length||0,isLoading:c,spawnRecurringTasks:l.mutate,isSpawning:l.isPending}}function Yy(t,s){const a=t.recurrence_pattern?.toLowerCase();if(!a)return!1;switch(a){case"daily":return!0;case"weekly":return t.recurrence_days&&t.recurrence_days.length>0?t.recurrence_days.includes(s):!0;case"weekdays":return s>=1&&s<=5;case"weekends":return s===0||s===6;case"custom":return t.recurrence_days&&t.recurrence_days.length>0?t.recurrence_days.includes(s):!1;default:return!!(a.includes("daily")||a.includes("day"))}}function Vy(){const{user:t}=ce(),{toast:s}=Ut(),a=Se(),{data:r,isLoading:i}=ye({queryKey:["streak-at-risk",t?.id],queryFn:async()=>{if(!t?.id)return null;const{data:c,error:l}=await N.from("profiles").select("streak_at_risk, streak_at_risk_since, current_habit_streak, streak_freezes_available").eq("id",t.id).maybeSingle();return l?(console.error("Error fetching streak at risk:",l),null):{streak_at_risk:c.streak_at_risk??!1,streak_at_risk_since:c.streak_at_risk_since,current_habit_streak:c.current_habit_streak??0,streak_freezes_available:c.streak_freezes_available??0}},enabled:!!t?.id,staleTime:3e4}),o=ie({mutationFn:async c=>{const{data:l,error:u}=await N.functions.invoke("resolve-streak-freeze",{body:{action:c}});if(u)throw u;return l},onSuccess:(c,l)=>{a.invalidateQueries({queryKey:["streak-at-risk"]}),a.invalidateQueries({queryKey:["profile"]}),s(l==="use_freeze"?{title:"Streak Preserved! â„ï¸",description:`Your ${c.newStreak}-day streak is safe. ${c.freezesRemaining} freeze${c.freezesRemaining===1?"":"s"} remaining.`}:{title:"Fresh Start",description:"Your streak has been reset. Time to build a new one!"})},onError:c=>{console.error("Error resolving streak:",c),s({title:"Error",description:"Failed to process your choice. Please try again.",variant:"destructive"})}});return{needsStreakDecision:r?.streak_at_risk??!1,currentStreak:r?.current_habit_streak??0,freezesAvailable:r?.streak_freezes_available??0,streakAtRiskSince:r?.streak_at_risk_since,isLoading:i,useFreeze:()=>o.mutateAsync("use_freeze"),resetStreak:()=>o.mutateAsync("reset_streak"),isResolving:o.isPending}}function Rn(){const{user:t}=ce(),s=n.useCallback(async c=>{if(!t)return;const{interactionType:l,inputText:u,detectedIntent:m,aiResponse:p,userAction:h,modifications:f}=c;try{const{data:{session:d}}=await N.auth.getSession();if(!d||d.user.id!==t.id)return;const{error:g}=await N.from("ai_interactions").insert({user_id:t.id,interaction_type:l,input_text:u,detected_intent:m,ai_response:p,user_action:h,modifications:f});if(g){console.warn("Failed to track interaction (non-blocking):",g.message);return}await a(t.id,h)}catch(d){console.warn("Error tracking interaction (non-blocking):",d)}},[t]),a=async(c,l)=>{try{const{data:u}=await N.from("user_ai_learning").select("interaction_count, acceptance_rate, modification_rate").eq("user_id",c).maybeSingle();if(!u){await N.from("user_ai_learning").insert({user_id:c,interaction_count:1,acceptance_rate:l==="accepted"?100:0,modification_rate:l==="modified"?100:0,last_interaction_at:new Date().toISOString()});return}const m=(u.interaction_count||0)+1,p=u.acceptance_rate||0,h=u.modification_rate||0,f=l==="accepted"?(p*(m-1)+100)/m:p*(m-1)/m,d=l==="modified"?(h*(m-1)+100)/m:h*(m-1)/m;await N.from("user_ai_learning").update({interaction_count:m,acceptance_rate:Math.round(f*100)/100,modification_rate:Math.round(d*100)/100,last_interaction_at:new Date().toISOString()}).eq("user_id",c)}catch(u){console.error("Error updating learning from action:",u)}},r=n.useCallback(async c=>{if(!t)return;const{storyType:l,themeColor:u,category:m,epicDuration:p,habitDifficulty:h,habitFrequency:f,wasSuccessful:d}=c;try{const{data:g}=await N.from("user_ai_learning").select("preference_weights, successful_patterns, failed_patterns, common_contexts").eq("user_id",t.id).maybeSingle(),y=g?.preference_weights||{story_type:{},theme_color:{},categories:{}},v=g?.successful_patterns||{},b=g?.failed_patterns||{},x=g?.common_contexts||[],j=d?1:-.5;l&&(y.story_type=y.story_type||{},y.story_type[l]=(y.story_type[l]||0)+j),u&&(y.theme_color=y.theme_color||{},y.theme_color[u]=(y.theme_color[u]||0)+j),m&&!x.includes(m)&&x.push(m);const w=`${l||"none"}_${p||30}_${h||"medium"}`;d?v[w]=(v[w]||0)+1:b[w]=(b[w]||0)+1;const D={preference_weights:y,successful_patterns:v,failed_patterns:b,common_contexts:x.slice(-20),updated_at:new Date().toISOString()};d&&(p&&(D.preferred_epic_duration=p),h&&(D.preferred_habit_difficulty=h),f&&(D.preferred_habit_frequency=f)),await N.from("user_ai_learning").upsert({user_id:t.id,...D},{onConflict:"user_id"})}catch(g){console.error("Error updating preference weights:",g)}},[t]),i=n.useCallback(async(c,l)=>{if(t)try{const{data:u}=await N.from("epics").select("story_type_slug, theme_color, target_days").eq("id",c).maybeSingle();if(!u)return;const{data:m}=await N.from("epic_habits").select("habits(difficulty, frequency, category, custom_days)").eq("epic_id",c),p=m?.length?m.reduce((f,d)=>{const g=d.habits?.difficulty||"medium";return f+(g==="easy"?1:g==="medium"?2:3)},0)/m.length:2,h=p<1.5?"easy":p<2.5?"medium":"hard";await r({storyType:u.story_type_slug||void 0,themeColor:u.theme_color||void 0,epicDuration:u.target_days,habitDifficulty:h,wasSuccessful:l==="completed"})}catch(u){console.error("Error tracking epic outcome:",u)}},[t,r]),o=n.useCallback(async(c,l,u)=>{if(t)try{const{data:m}=await N.from("user_ai_learning").select("successful_patterns, failed_patterns, energy_by_hour, day_of_week_patterns").eq("user_id",t.id).maybeSingle(),p=m?.successful_patterns||{},h=m?.failed_patterns||{},f=m?.energy_by_hour||{},d=m?.day_of_week_patterns||{},g=l==="completed",y=new Date().toLocaleDateString("en-US",{weekday:"long"}).toLowerCase();if(u?.actualCompletionTime&&g){const x=u.actualCompletionTime.split(":")[0];f[x]=(f[x]||50)+5}else if(u?.scheduledTime&&!g){const x=u.scheduledTime.split(":")[0];f[x]=Math.max(0,(f[x]||50)-5)}const v=(d[`${y}_total`]||0)+1,b=(d[`${y}_success`]||0)+(g?1:0);if(d[`${y}_total`]=v,d[`${y}_success`]=b,d[y]=Math.round(b/v*100),u?.category){const x=`category_${u.category}`;g?p[x]=(p[x]||0)+1:h[x]=(h[x]||0)+1}if(u?.difficulty){const x=`difficulty_${u.difficulty}`;g?p[x]=(p[x]||0)+1:h[x]=(h[x]||0)+1}await N.from("user_ai_learning").upsert({user_id:t.id,successful_patterns:p,failed_patterns:h,energy_by_hour:f,day_of_week_patterns:d,updated_at:new Date().toISOString()},{onConflict:"user_id"})}catch(m){console.warn("Error tracking daily plan outcome (non-blocking):",m)}},[t]);return{trackInteraction:s,updatePreferenceWeights:r,trackEpicOutcome:i,trackDailyPlanOutcome:o}}const Xy=t=>{const s=t?.toLowerCase()?.trim()||"medium";return["easy","simple","beginner","low"].includes(s)?"easy":["hard","difficult","advanced","high","challenging"].includes(s)?"hard":"medium"},Jy=t=>{const s=t?.toLowerCase()?.trim()?.replace(/\s+/g,"_")||"daily";return["daily","everyday","every_day","7x_week","7x"].includes(s)?"daily":["5x_week","5x","weekdays","five_times","5_times"].includes(s)?"5x_week":["3x_week","3x","three_times","3_times","thrice"].includes(s)?"3x_week":["weekly","biweekly","twice","2x","2x_week","once","1x","custom","twice_daily"].includes(s)?"custom":"daily"},Zy=t=>{if(!t)return"heroic";const s=t.toLowerCase().trim();return["heroic","warrior","mystic","nature","solar"].includes(s)?s:{"#f59e0b":"heroic","#ef4444":"warrior","#10b981":"nature","#ec4899":"mystic","#f97316":"solar","#8b5cf6":"mystic","#3b82f6":"heroic","#475569":"warrior"}[s]||"heroic"},eb=()=>{const{user:t}=ce(),s=Se(),{awardCustomXP:a}=bt(),{trackEpicOutcome:r}=Rn(),{data:i,isLoading:o,error:c}=ye({queryKey:["epics",t?.id],queryFn:async()=>{if(!t?.id)return[];const{data:d,error:g}=await N.from("epics").select(`
          *,
          epic_habits(
            habit_id,
            habits(id, title, difficulty, description, frequency, estimated_minutes, custom_days, preferred_time, category)
          )
        `).eq("user_id",t.id).order("created_at",{ascending:!1});if(g)throw console.error("Failed to fetch epics:",g),g;return d||[]},enabled:!!t?.id,staleTime:180*1e3,refetchOnWindowFocus:!1,retry:2}),l=ie({mutationFn:async d=>{const{data:{session:g},error:y}=await N.auth.getSession();if(y||!g?.user?.id)throw new Error("Not authenticated. Please refresh and try again.");const v=g.user.id;if(!d.habits||d.habits.length===0)throw new Error("Epic must have at least one habit");if(d.target_days<1||d.target_days>365)throw new Error("Target days must be between 1 and 365");let b=[],x=null;try{const{data:j,error:w}=await N.from("habits").insert(d.habits.map(T=>{const q=Jy(T.frequency);let k=T.custom_days?.length>0?T.custom_days:null;return!k&&q!=="daily"&&(q==="5x_week"?k=[0,1,2,3,4]:q==="3x_week"?k=[0,2,4]:q==="custom"&&(k=[0])),{user_id:v,title:T.title,description:T.description||null,difficulty:Xy(T.difficulty),frequency:q,custom_days:k,preferred_time:T.preferred_time||null,reminder_enabled:T.reminder_enabled||!1,reminder_minutes_before:T.reminder_minutes_before||15,estimated_minutes:T.estimated_minutes||null}})).select();if(w)throw console.error("Failed to create habits:",w),new Error(`Failed to create habits: ${w.message}`);if(!j||j.length===0)throw new Error("No habits were created");b=j;const D=`EPIC-${Math.random().toString(36).substring(2,10).toUpperCase()}`,{data:S,error:M}=await N.from("epics").insert({user_id:v,title:d.title,description:d.description,target_days:d.target_days,is_public:!0,xp_reward:Math.floor(d.target_days*10),invite_code:D,theme_color:Zy(d.theme_color),story_type_slug:d.story_type_slug||null}).select().single();if(M)throw console.error("Failed to create epic:",M),await N.from("habits").delete().in("id",b.map(T=>T.id)),new Error(`Failed to create epic: ${M.message}`);if(!S)throw new Error("Epic creation returned no data");x=S;const{error:C}=await N.from("epic_habits").insert(b.map(T=>({epic_id:S.id,habit_id:T.id})));if(C)throw console.error("Failed to link habits:",C),await N.from("epics").delete().eq("id",S.id),await N.from("habits").delete().in("id",b.map(T=>T.id)),new Error(`Failed to link habits: ${C.message}`);if(d.phases&&d.phases.length>0){const{error:T}=await N.from("journey_phases").insert(d.phases.map(q=>({epic_id:S.id,user_id:v,name:q.name,description:q.description,start_date:q.start_date,end_date:q.end_date,phase_order:q.phase_order})));T&&console.error("Failed to create journey phases:",T)}let R=d.milestones;if((!R||R.length===0)&&d.story_type_slug){console.log("[Epic Creation] No milestones provided, generating defaults for story type:",d.story_type_slug);let T=5;d.target_days<=14?T=3:d.target_days<=30?T=4:d.target_days<=60?T=5:T=6;const q=new Date;R=Array.from({length:T},(k,P)=>{const A=Math.round((P+1)/T*100),L=Math.floor(d.target_days*A/100),H=new Date(q);return H.setDate(H.getDate()+L),{title:P===T-1?"The Finale":`Chapter ${P+1}`,description:P===T-1?"Complete your epic journey!":`Reach ${A}% of your goal`,target_date:H.toISOString().split("T")[0],milestone_percent:A,is_postcard_milestone:!0}})}if(R&&R.length>0){console.log("[Epic Creation] Inserting milestones:",R.length,R);const{data:T,error:q}=await N.from("epic_milestones").insert(R.map((k,P)=>({epic_id:S.id,user_id:v,title:k.title,description:k.description||null,target_date:k.target_date,milestone_percent:k.milestone_percent,is_postcard_milestone:k.is_postcard_milestone??!1,phase_order:P+1,phase_name:k.phase_name||k.phaseName||null}))).select();q?(console.error("Failed to create milestones:",q),X.error("Milestones couldn't be created",{description:"You can add them manually from the campaign settings"})):console.log("[Epic Creation] Successfully created milestones:",T?.length)}else console.log("[Epic Creation] No milestones to insert and no story type for fallback");if(d.story_type_slug){const[T,q]=await Promise.all([N.from("user_companion").select("spirit_animal, core_element, favorite_color, fur_color").eq("user_id",v).maybeSingle(),N.from("profiles").select("selected_mentor_id").eq("id",v).maybeSingle()]);let k;if(q.data?.selected_mentor_id){const{data:H}=await N.from("mentors").select("id, name, slug").eq("id",q.data.selected_mentor_id).maybeSingle();H&&(k={id:H.id,name:H.name,slug:H.slug||void 0})}const P=d.milestones?.filter(H=>H.is_postcard_milestone)||[],A=P.length||5,L=P.map((H,I)=>({chapterNumber:I+1,title:H.title,targetDate:H.target_date,milestonePercent:H.milestone_percent}));N.functions.invoke("generate-epic-narrative-seed",{body:{userId:v,epicId:S.id,epicTitle:d.title,epicDescription:d.description,targetDays:d.target_days,storyTypeSlug:d.story_type_slug,companionData:T.data||void 0,mentorData:k,userGoal:d.description,totalChapters:A,milestoneData:L}}).catch(H=>{console.error("Narrative seed generation failed:",H)}),N.functions.invoke("generate-journey-path",{body:{epicId:S.id,milestoneIndex:0,userId:v}}).catch(H=>{console.error("Initial journey path generation failed:",H)})}return S}catch(j){throw x&&N.from("epics").delete().eq("id",x.id).then(({error:w})=>{w&&console.error("Failed to cleanup epic:",w)}),b.length>0&&N.from("habits").delete().in("id",b.map(w=>w.id)).then(({error:w})=>{w&&console.error("Failed to cleanup habits:",w)}),j}},onSuccess:()=>{s.invalidateQueries({queryKey:["epics"]}),s.invalidateQueries({queryKey:["habits"]}),window.dispatchEvent(new CustomEvent("campaign-created")),X.success("Epic quest created! ðŸŽ¯",{description:"Your companion is excited for this legendary journey!"})},onError:d=>{console.error("Failed to create epic:",d),X.error("Failed to create epic")}}),u=ie({mutationFn:async({epicId:d,status:g})=>{if(!t?.id)throw new Error("User not authenticated");const{data:y,error:v}=await N.from("epics").select("xp_reward, title, progress_percentage, status, user_id").eq("id",d).eq("user_id",t.id).maybeSingle();if(v)throw console.error("Failed to fetch epic:",v),new Error(`Failed to fetch epic: ${v.message}`);if(!y)throw new Error("Epic not found or you don't have permission");if(y.status==="completed"&&g==="completed")throw new Error("Epic is already completed");const{error:b}=await N.from("epics").update({status:g,completed_at:g==="completed"?new Date().toISOString():null}).eq("id",d).eq("user_id",t.id);if(b)throw b;if(g==="abandoned"){console.log("[Epic Abandon] Cleaning up rituals and milestones for epic:",d);const{data:x}=await N.from("epic_habits").select("habit_id").eq("epic_id",d);if(x&&x.length>0){const w=x.map(R=>R.habit_id);console.log("[Epic Abandon] Deactivating habits:",w);const{error:D}=await N.from("habits").update({is_active:!1}).in("id",w).eq("user_id",t.id);D&&console.error("Failed to deactivate habits:",D);const S=Y(new Date,"yyyy-MM-dd"),{error:M}=await N.from("daily_tasks").delete().in("habit_source_id",w).gte("task_date",S).eq("completed",!1);M&&console.error("Failed to delete future habit tasks:",M);const{error:C}=await N.from("epic_habits").delete().eq("epic_id",d);C&&console.error("Failed to delete epic_habits links:",C)}const{error:j}=await N.from("epic_milestones").delete().eq("epic_id",d).eq("user_id",t.id);j&&console.error("Failed to delete milestones:",j),console.log("[Epic Abandon] Cleanup complete")}return{epic:y,status:g,wasAlreadyCompleted:y.status==="completed"}},onSuccess:async({epic:d,status:g,wasAlreadyCompleted:y},v)=>{if(s.invalidateQueries({queryKey:["epics"]}),s.invalidateQueries({queryKey:["habits"]}),s.invalidateQueries({queryKey:["habit-surfacing"]}),s.invalidateQueries({queryKey:["daily-tasks"]}),(g==="completed"||g==="abandoned")&&r(v.epicId,g).catch(b=>{console.error("Failed to track epic outcome:",b)}),g==="completed"&&!y){try{await a(d.xp_reward,"epic_complete",`Epic "${d.title}" Completed!`,{epic_id:v?.epicId})}catch(b){console.error("Failed to award epic completion XP:",b)}X.success("Epic Completed! ðŸ†",{description:`You've conquered the ${d.title} epic! Your companion grows stronger!`})}else g==="abandoned"&&X("Epic abandoned",{description:"You can always start a new epic when ready."})},onError:d=>{console.error("Failed to update epic:",d),X.error("Failed to update epic status")}}),m=ie({mutationFn:async({epicId:d,habitId:g})=>{if(!d||!g)throw new Error("Invalid epic or habit ID");const{data:y}=await N.from("epic_habits").select("id").eq("epic_id",d).eq("habit_id",g).maybeSingle();if(y)throw new Error("Habit is already linked to this epic");const{error:v}=await N.from("epic_habits").insert({epic_id:d,habit_id:g});if(v)throw console.error("Failed to link habit to epic:",v),v},onSuccess:()=>{s.invalidateQueries({queryKey:["epics"]}),X.success("Habit linked to epic! âš”ï¸")},onError:d=>{console.error("Failed to link habit:",d),X.error("Failed to link habit to epic")}}),p=ie({mutationFn:async({epicId:d,habitId:g})=>{if(!d||!g)throw new Error("Invalid epic or habit ID");const{error:y}=await N.from("epic_habits").delete().eq("epic_id",d).eq("habit_id",g);if(y)throw console.error("Failed to remove habit from epic:",y),y},onSuccess:()=>{s.invalidateQueries({queryKey:["epics"]}),X("Habit removed from epic")},onError:d=>{console.error("Failed to remove habit:",d),X.error("Failed to remove habit from epic")}}),h=i?.filter(d=>d.status==="active")||[],f=i?.filter(d=>d.status==="completed")||[];return{epics:i||[],activeEpics:h,completedEpics:f,isLoading:o,error:c,createEpic:l.mutateAsync,isCreating:l.isPending,isCreateSuccess:l.isSuccess,updateEpicStatus:u.mutate,addHabitToEpic:m.mutate,removeHabitFromEpic:p.mutate}};function tb({open:t,onOpenChange:s,tasks:a,selectedDate:r,onComplete:i}){const[o,c]=n.useState(""),[l,u]=n.useState(!1),m=Se(),p=n.useMemo(()=>a.filter(d=>!d.completed),[a]),h=n.useMemo(()=>{const g=new Date().getHours(),y=[];return p.length>3&&g>14&&y.push({icon:e.jsx(Ze,{className:"h-4 w-4"}),label:"Focus on top 3",prompt:"Keep only the 3 most important remaining tasks for today and move the rest to tomorrow"}),p.length>0&&y.push({icon:e.jsx(lt,{className:"h-4 w-4"}),label:"Push all by 1 hour",prompt:"Push all remaining tasks back by 1 hour"}),p.length>2&&y.push({icon:e.jsx(mt,{className:"h-4 w-4"}),label:"Move rest to tomorrow",prompt:"Move all remaining incomplete tasks to tomorrow"}),y.push({icon:e.jsx(se,{className:"h-4 w-4"}),label:"Reschedule smarter",prompt:"Reorganize the remaining tasks based on current time and energy optimization"}),y.slice(0,4)},[p]),f=async d=>{if(d.trim()){u(!0);try{const g=Y(r,"yyyy-MM-dd"),{data:y,error:v}=await N.functions.invoke("adjust-saved-daily-plan",{body:{planDate:g,adjustmentRequest:d,currentTasks:p.map(b=>({id:b.id,title:b.task_text,scheduledTime:b.scheduled_time}))}});if(v)throw v;if(y?.adjustments&&Array.isArray(y.adjustments)){for(const b of y.adjustments)if(b.action==="update"&&b.taskId&&b.updates)await N.from("daily_tasks").update(b.updates).eq("id",b.taskId);else if(b.action==="delete"&&b.taskId)await N.from("daily_tasks").delete().eq("id",b.taskId);else if(b.action==="move_to_tomorrow"&&b.taskId){const x=new Date(r);x.setDate(x.getDate()+1),await N.from("daily_tasks").update({task_date:Y(x,"yyyy-MM-dd")}).eq("id",b.taskId)}}m.invalidateQueries({queryKey:["daily-tasks"]}),X.success(y?.message||"Plan adjusted!"),c(""),i()}catch(g){console.error("Adjust error:",g),X.error("Failed to adjust plan")}finally{u(!1)}}};return e.jsx(Ns,{open:t,onOpenChange:s,children:e.jsxs(ks,{className:"max-h-[70vh]",children:[e.jsxs(Cs,{className:"text-center pb-2",children:[e.jsx("div",{className:"flex justify-center mb-2",children:e.jsx("div",{className:"p-2 rounded-full bg-primary/10",children:e.jsx(us,{className:"h-5 w-5 text-primary"})})}),e.jsx(Ss,{children:"Quick Adjust"}),e.jsxs(Nn,{children:[p.length," task",p.length!==1?"s":""," remaining"]})]}),e.jsxs("div",{className:"px-4 pb-6 space-y-4",children:[e.jsx("div",{className:"grid grid-cols-2 gap-2",children:h.map((d,g)=>e.jsxs(_.button,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:g*.05},onClick:()=>f(d.prompt),disabled:l,className:E("flex items-center gap-2 p-3 rounded-lg","bg-muted/50 border border-border/50","hover:bg-muted hover:border-primary/30 transition-all","text-left text-sm","disabled:opacity-50 disabled:cursor-not-allowed"),children:[e.jsx("div",{className:"text-primary",children:d.icon}),e.jsx("span",{className:"font-medium",children:d.label})]},g))}),e.jsxs("div",{className:"relative",children:[e.jsx(He,{value:o,onChange:d=>c(d.target.value),placeholder:"Or describe what to change...",className:"pr-12",onKeyDown:d=>d.key==="Enter"&&f(o),disabled:l}),e.jsx(B,{size:"icon",variant:"ghost",className:"absolute right-1 top-1/2 -translate-y-1/2 h-8 w-8",onClick:()=>f(o),disabled:!o.trim()||l,children:l?e.jsx(ze,{className:"h-4 w-4 animate-spin"}):e.jsx(qo,{className:"h-4 w-4"})})]}),e.jsx("div",{className:"flex flex-wrap gap-1.5",children:["Move workout to 6pm","Cancel meeting prep","Add 30min break"].map(d=>e.jsx("button",{onClick:()=>c(d),disabled:l,className:"text-xs px-2 py-1 rounded-full bg-muted/50 text-muted-foreground hover:text-foreground transition-colors",children:d},d))})]})]})})}function sb(){const[t,s]=n.useState([]),[a,r]=n.useState(!1),[i,o]=n.useState(null),c=n.useCallback(async(f,d)=>{if(!f.trim()){o("Please enter a goal");return}r(!0),o(null);try{const{data:g,error:y}=await N.functions.invoke("generate-epic-suggestions",{body:{goal:f.trim(),deadline:d?.deadline,targetDays:d?.targetDays,clarificationAnswers:d?.clarificationAnswers,epicContext:d?.epicContext,timelineAnalysis:d?.timelineAnalysis}});if(y)throw y;if(g.error)throw new Error(g.error);const v=(g.suggestions||[]).map(b=>({...b,selected:!1}));s(v)}catch(g){const y=g instanceof Error?g.message:"Failed to generate suggestions";o(y),X.error(y)}finally{r(!1)}},[]),l=n.useCallback(f=>{s(d=>d.map(g=>g.id===f?{...g,selected:!g.selected}:g))},[]),u=n.useCallback(()=>{s(f=>f.map(d=>({...d,selected:!0})))},[]),m=n.useCallback(()=>{s(f=>f.map(d=>({...d,selected:!1})))},[]),p=n.useCallback(()=>t.filter(f=>f.selected),[t]),h=n.useCallback(()=>{s([]),o(null),r(!1)},[]);return{suggestions:t,isLoading:a,error:i,generateSuggestions:c,toggleSuggestion:l,selectAll:u,deselectAll:m,getSelectedSuggestions:p,reset:h}}const ab=()=>{const t=Se(),{data:s,isLoading:a}=ye({queryKey:["epic-templates"],queryFn:async()=>{const{data:c,error:l}=await N.from("epic_templates").select("*").order("is_featured",{ascending:!1}).order("popularity_count",{ascending:!1});if(l)throw l;return(c||[]).map(u=>({...u,habits:Array.isArray(u.habits)?u.habits:JSON.parse(u.habits||"[]")}))}}),r=ie({mutationFn:async c=>{const{data:l,error:u}=await N.from("epic_templates").select("popularity_count").eq("id",c).maybeSingle();l?await N.from("epic_templates").update({popularity_count:(l.popularity_count||0)+1}).eq("id",c):u&&console.error("Error incrementing popularity:",u)},onSuccess:()=>{t.invalidateQueries({queryKey:["epic-templates"]})}}),i=s?.filter(c=>c.is_featured)||[];return{templates:s||[],featuredTemplates:i,isLoading:a,incrementPopularity:r}};function rb(){const{user:t}=ce(),{data:s,isLoading:a,refetch:r}=ye({queryKey:["user-ai-context",t?.id],queryFn:async()=>{if(!t)return null;const{data:f,error:d}=await N.functions.invoke("enrich-user-context");return d?(console.error("Error fetching AI context:",d),null):f},enabled:!!t,staleTime:300*1e3,gcTime:600*1e3}),{data:i,isLoading:o,refetch:c}=ye({queryKey:["user-ai-learning",t?.id],queryFn:async()=>{if(!t)return null;const{data:f,error:d}=await N.from("user_ai_learning").select("*").eq("user_id",t.id).maybeSingle();return d?(console.error("Error fetching AI learning profile:",d),null):f},enabled:!!t,staleTime:300*1e3,gcTime:600*1e3}),l=s?.atEpicLimit??!1,u=s?.overloaded??!1,m=s?.suggestedWorkload??"normal",p={epicDuration:i?.preferred_epic_duration??s?.preferredEpicDuration??30,habitDifficulty:i?.preferred_habit_difficulty??s?.preferredDifficulty??"medium",habitFrequency:i?.preferred_habit_frequency??s?.preferredHabitFrequency??"daily",commonContexts:i?.common_contexts??s?.commonContexts??[],preferenceWeights:i?.preference_weights??s?.preferenceWeights??{}};return{enrichedContext:s,learningProfile:i,isLoading:a||o,isContextLoading:a,isLearningLoading:o,isAtEpicLimit:l,isOverloaded:u,suggestedWorkload:m,capacityWarning:l?"You have 2 active epics. Consider completing one before starting another.":u?"You seem overloaded. Consider simplifying your current habits before adding more.":null,preferences:p,activeEpicCount:s?.activeEpics.length??0,activeHabitCount:s?.activeHabits.length??0,completionRate:s?.completionRates.thisWeek??0,refetch:()=>{r(),c()},refetchContext:r,refetchLearning:c}}function nb(t={}){const{debounceMs:s=500,minInputLength:a=10,useOrchestrator:r=!1}=t,[i,o]=n.useState(null),[c,l]=n.useState(!1),[u,m]=n.useState(null),[p,h]=n.useState(null),f=n.useRef(null),d=n.useRef(""),g=n.useCallback(async M=>{if(!M||M.length<a)return o(null),null;if(M===d.current)return i;d.current=M,l(!0),m(null);try{const C=r?"ai-orchestrator":"classify-task-intent",R=r?{input:M,interactionType:"classify"}:{input:M},{data:T,error:q}=await N.functions.invoke(C,{body:R});if(q)throw new Error(q.message);if(T?.error)throw new Error(T.error);let k;return r?(k={type:T.type||"quest",confidence:T.confidence||0,reasoning:T.reasoning||"",suggestedDeadline:T.suggestedDeadline,suggestedDuration:T.suggestedDuration,needsClarification:T.needsClarification,clarifyingQuestion:T.clarifyingQuestion,clarificationContext:T.clarificationContext,extractedTasks:T.extractedTasks,suggestedTasks:T.suggestedTasks,detectedContext:T.detectedContext,epicClarifyingQuestions:T.epicClarifyingQuestions,epicContext:T.epicContext,epicDetails:T.epicDetails,timelineAnalysis:T.timelineAnalysis,capacityWarnings:T.capacityWarnings,warning:T.warning},T.capacityWarnings?h(T.capacityWarnings):T.enrichedContext&&h({atEpicLimit:T.enrichedContext.atEpicLimit??!1,overloaded:T.enrichedContext.overloaded??!1,suggestedWorkload:T.enrichedContext.suggestedWorkload??"normal"})):k=T,o(k),k}catch(C){return console.error("Intent classification error:",C),m(C instanceof Error?C.message:"Classification failed"),o(null),null}finally{l(!1)}},[i,a,r]),y=n.useCallback(async(M,C)=>{if(!M||!C)return null;l(!0),m(null);try{const{data:R,error:T}=await N.functions.invoke("classify-task-intent",{body:{input:M,clarification:C,previousContext:i?.clarificationContext}});if(T)throw new Error(T.message);if(R?.error)throw new Error(R.error);const q=R;return o(q),q}catch(R){return console.error("Intent clarification error:",R),m(R instanceof Error?R.message:"Clarification failed"),null}finally{l(!1)}},[i?.clarificationContext]),v=n.useCallback(async(M,C)=>{if(!M||!C||Object.keys(C).length===0)return null;l(!0),m(null);try{const{data:R,error:T}=await N.functions.invoke("classify-task-intent",{body:{input:M,epicAnswers:C}});if(T)throw new Error(T.message);if(R?.error)throw new Error(R.error);const q=R;return o(q),q}catch(R){return console.error("Epic clarification error:",R),m(R instanceof Error?R.message:"Epic clarification failed"),null}finally{l(!1)}},[]),b=n.useCallback(M=>{if(f.current&&clearTimeout(f.current),!M||M.length<a){o(null);return}f.current=setTimeout(()=>{g(M)},s)},[g,s,a]),x=n.useCallback(()=>{f.current&&clearTimeout(f.current),o(null),m(null),l(!1),d.current=""},[]);n.useEffect(()=>()=>{f.current&&clearTimeout(f.current)},[]);const j=i?.type==="epic"&&i.confidence>=.6,w=i?.type==="habit"&&i.confidence>=.6,D=i?.type==="brain-dump"&&i.confidence>=.7&&(i.extractedTasks?.length??0)>=2,S=j&&i?.needsClarification===!0&&(i?.epicClarifyingQuestions?.length??0)>0;return{classification:i,isClassifying:c,error:u,classify:g,clarify:y,clarifyEpic:v,classifyDebounced:b,reset:x,isEpicDetected:j,isHabitDetected:w,isBrainDumpDetected:D,needsClarification:i?.needsClarification??!1,clarifyingQuestion:i?.clarifyingQuestion,extractedTasks:i?.extractedTasks??[],suggestedTasks:i?.suggestedTasks??[],detectedContext:i?.detectedContext,needsEpicClarification:S,epicClarifyingQuestions:i?.epicClarifyingQuestions??[],epicContext:i?.epicContext,epicDetails:i?.epicDetails,timelineAnalysis:i?.timelineAnalysis??null,capacityWarnings:p,capacityWarning:i?.warning??null,isAtEpicLimit:p?.atEpicLimit??!1,isOverloaded:p?.overloaded??!1}}const ib={easy:"bg-green-500/10 text-green-500 border-green-500/30",medium:"bg-amber-500/10 text-amber-500 border-amber-500/30",hard:"bg-red-500/10 text-red-500 border-red-500/30"},ob={daily:"Daily",weekdays:"Weekdays","5x_week":"5x/week","3x_week":"3x/week",weekly:"Weekly",custom:"Custom"},lb=n.memo(function({ritual:s,onUpdate:a,onDelete:r,isEditing:i=!1}){const[o,c]=n.useState(i),[l,u]=n.useState(s),m=()=>{a(l),c(!1)},p=()=>{u(s),c(!1)},h=(d,g)=>{u({...l,frequency:d,customDays:g})};if(o)return e.jsxs(_.div,{layout:!0,className:"p-3 rounded-lg border bg-muted/30 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(He,{value:l.title,onChange:d=>u({...l,title:d.target.value}),placeholder:"Ritual name",className:"font-medium"}),e.jsx(He,{value:l.description,onChange:d=>u({...l,description:d.target.value}),placeholder:"Description (optional)",className:"text-sm"})]}),e.jsx(Ud,{frequency:l.frequency==="3x_week"?"custom":l.frequency,customDays:l.customDays||Wd(l.frequency),onFrequencyChange:h}),e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] text-muted-foreground mb-1 block",children:"Difficulty"}),e.jsxs(ya,{value:l.difficulty,onValueChange:d=>u({...l,difficulty:d}),children:[e.jsx(Os,{className:"h-8 text-xs",children:e.jsx(ba,{})}),e.jsxs($s,{children:[e.jsx(ds,{value:"easy",children:"Easy"}),e.jsx(ds,{value:"medium",children:"Medium"}),e.jsx(ds,{value:"hard",children:"Hard"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"text-[10px] text-muted-foreground mb-1 block",children:"Minutes"}),e.jsx(He,{type:"number",value:l.estimatedMinutes||"",onChange:d=>u({...l,estimatedMinutes:parseInt(d.target.value)||void 0}),placeholder:"15",className:"h-8 text-xs"})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsxs(B,{size:"sm",variant:"outline",className:"flex-1",onClick:p,children:[e.jsx(Qe,{className:"w-3 h-3 mr-1"}),"Cancel"]}),e.jsxs(B,{size:"sm",className:"flex-1",onClick:m,children:[e.jsx(Xe,{className:"w-3 h-3 mr-1"}),"Save"]})]})]});const f=Oy(s.customDays||[]);return e.jsxs(_.div,{layout:!0,className:"group flex items-center gap-2 p-3 rounded-lg border bg-background hover:bg-muted/30 transition-colors",children:[e.jsx(Am,{className:"w-4 h-4 text-muted-foreground/50 cursor-grab"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-medium text-sm truncate",children:s.title}),e.jsx(Ne,{variant:"outline",className:E("text-[10px] px-1.5 py-0",ib[s.difficulty]),children:s.difficulty})]}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground",children:[e.jsx("span",{children:ob[s.frequency]}),f&&s.frequency!=="daily"&&e.jsx(e.Fragment,{children:e.jsxs("span",{className:"text-[10px] opacity-70",children:["(",f,")"]})}),s.estimatedMinutes&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"â€¢"}),e.jsx(lt,{className:"w-3 h-3"}),e.jsxs("span",{children:[s.estimatedMinutes,"min"]})]})]})]}),e.jsxs("div",{className:"flex items-center gap-1 opacity-0 group-hover:opacity-100 transition-opacity",children:[e.jsx(B,{size:"icon",variant:"ghost",className:"h-7 w-7",onClick:()=>c(!0),children:e.jsx(Rm,{className:"w-3.5 h-3.5"})}),e.jsx(B,{size:"icon",variant:"ghost",className:"h-7 w-7 text-destructive hover:text-destructive",onClick:()=>r(s.id),children:e.jsx(es,{className:"w-3.5 h-3.5"})})]})]})});function cb({rituals:t,originalRituals:s,onRitualsChange:a,className:r}){const[i,o]=n.useState(!1),[c,l]=n.useState(""),u=n.useMemo(()=>t.reduce((y,v)=>{const b=v.estimatedMinutes||15,j={daily:7,"5x_week":5,"3x_week":3,weekly:1,custom:3}[v.frequency]||3;return y+b*j},0),[t]),m=Math.round(u/60*10)/10,p=y=>{a(t.map(v=>v.id===y.id?y:v))},h=y=>{a(t.filter(v=>v.id!==y))},f=()=>{if(!c.trim())return;const y={id:`custom-${Date.now()}`,title:c.trim(),description:"",frequency:"daily",difficulty:"medium",estimatedMinutes:15};a([...t,y]),l(""),o(!1)},d=()=>{a([...s])},g=JSON.stringify(t)!==JSON.stringify(s);return e.jsxs("div",{className:E("space-y-4",r),children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsxs(Ne,{variant:"secondary",className:"gap-1",children:[e.jsx(se,{className:"w-3 h-3"}),t.length," Rituals"]}),e.jsxs(Ne,{variant:"outline",className:"gap-1",children:[e.jsx(lt,{className:"w-3 h-3"}),"~",m," hrs/week"]})]}),g&&e.jsxs(B,{variant:"ghost",size:"sm",onClick:d,className:"text-xs gap-1",children:[e.jsx(Im,{className:"w-3 h-3"}),"Reset"]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(be,{mode:"popLayout",children:t.map(y=>e.jsx(_.div,{layout:!0,initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,x:-20},children:e.jsx(lb,{ritual:y,onUpdate:p,onDelete:h})},y.id))}),e.jsx(be,{children:i?e.jsxs(_.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"flex gap-2",children:[e.jsx(He,{value:c,onChange:y=>l(y.target.value),placeholder:"New ritual name...",className:"flex-1",autoFocus:!0,onKeyDown:y=>{y.key==="Enter"&&f(),y.key==="Escape"&&o(!1)}}),e.jsx(B,{size:"sm",onClick:f,disabled:!c.trim(),children:"Add"}),e.jsx(B,{size:"sm",variant:"outline",onClick:()=>o(!1),children:"Cancel"})]}):e.jsx(_.div,{layout:!0,children:e.jsxs(B,{variant:"outline",size:"sm",className:"w-full border-dashed gap-2",onClick:()=>o(!0),children:[e.jsx(ha,{className:"w-4 h-4"}),"Add Custom Ritual"]})})})]}),e.jsxs("div",{className:"flex gap-2 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-green-500"}),t.filter(y=>y.difficulty==="easy").length," easy"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-amber-500"}),t.filter(y=>y.difficulty==="medium").length," medium"]}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"w-2 h-2 rounded-full bg-red-500"}),t.filter(y=>y.difficulty==="hard").length," hard"]})]})]})}const db=n.memo(function({milestones:s,storyType:a,className:r}){const i=n.useMemo(()=>s.filter(o=>o.isPostcardMilestone),[s]);return i.length===0?null:e.jsxs("div",{className:E("space-y-3",r),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(qm,{className:"w-4 h-4 text-primary"}),e.jsx("span",{className:"font-medium text-sm",children:"Your Story Chapters"}),e.jsxs(Ne,{variant:"secondary",className:"text-xs ml-auto",children:[i.length," chapters"]})]}),e.jsx("div",{className:"grid gap-2",children:i.map((o,c)=>e.jsxs(_.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:c*.1},className:"relative overflow-hidden rounded-lg border bg-gradient-to-r from-amber-500/5 to-orange-500/5 p-3",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-transparent via-white/5 to-transparent -translate-x-full animate-[shimmer_2s_infinite]"}),e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-10 h-10 rounded-lg bg-gradient-to-br from-amber-500/20 to-orange-500/20 border border-amber-500/30 flex items-center justify-center flex-shrink-0",children:e.jsx(se,{className:"w-5 h-5 text-amber-500"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-0.5",children:[e.jsxs("span",{className:"text-xs font-medium text-amber-600",children:["Chapter ",c+1]}),e.jsx(et,{className:"w-3 h-3 text-amber-500"})]}),e.jsx("p",{className:"font-medium text-sm truncate",children:o.title}),e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground mt-1",children:[e.jsx(zs,{className:"w-3 h-3"}),e.jsx("span",{className:"italic",children:"Location revealed on completion"})]})]}),e.jsxs(Ne,{variant:"outline",className:"text-[10px] flex-shrink-0",children:[o.milestonePercent,"%"]})]})]},o.id))}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"Complete milestones to unlock cosmic postcards from your companion's journey"})]})}),ub=n.memo(function({isAtEpicLimit:s=!1,isOverloaded:a=!1,suggestedWorkload:r="normal",isLoading:i=!1,className:o}){const c=s||a;return i?null:e.jsx(be,{children:c&&e.jsxs(_.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},className:E("px-3 py-2 rounded-lg text-xs flex items-center gap-2",a?"bg-destructive/10 border border-destructive/30 text-destructive":"bg-amber-500/10 border border-amber-500/30 text-amber-600 dark:text-amber-400",o),children:[e.jsx(ps,{className:"h-3.5 w-3.5 flex-shrink-0"}),e.jsx("span",{children:a?"You seem overloaded. Consider simplifying current habits first.":s?"You have 2 active epics. Complete one before starting another.":r==="light"?"Consider a lighter workload today.":null})]})})}),Yr=[{id:"heroic",label:"Heroic Gold",color:"from-amber-500 to-yellow-600",value:"#f59e0b"},{id:"warrior",label:"Warrior Red",color:"from-red-500 to-rose-600",value:"#ef4444"},{id:"nature",label:"Nature Green",color:"from-emerald-500 to-green-600",value:"#10b981"},{id:"mystic",label:"Mystic Pink",color:"from-pink-500 to-rose-600",value:"#ec4899"},{id:"solar",label:"Solar Orange",color:"from-orange-500 to-yellow-500",value:"#f97316"}];function mb({goal:t,questions:s,onSubmit:a,onSkip:r,isLoading:i=!1}){const[o,c]=n.useState({}),l=(d,g)=>{c(y=>({...y,[d]:g}))},u=(d,g)=>{c(y=>{const v=y[d]||[],b=v.includes(g)?v.filter(x=>x!==g):[...v,g];return{...y,[d]:b}})},m=()=>{const d={};Object.entries(o).forEach(([g,y])=>{Array.isArray(y)?d[g]=y.join(", "):d[g]=y}),a(d)},h=s.filter(d=>d.required).every(d=>{const g=o[d.id];return d.multiSelect?Array.isArray(g)&&g.length>0:g!==void 0&&g!==""}),f=d=>d.includes("date")||d.includes("exam")||d.includes("target")?mt:d.includes("hours")||d.includes("time")||d.includes("days")?lt:d.includes("subject")||d.includes("level")||d.includes("status")?pa:Ze;return e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"bg-gradient-to-br from-primary/5 via-background to-primary/5 rounded-xl border border-primary/20 p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"p-2 rounded-lg bg-primary/10",children:e.jsx(se,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-semibold text-sm",children:"Let's personalize your epic"}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5 line-clamp-1",children:t})]})]}),e.jsx("div",{className:"space-y-4",children:s.map((d,g)=>{const y=f(d.id);return e.jsxs(_.div,{initial:{opacity:0,x:-10},animate:{opacity:1,x:0},transition:{delay:g*.1},className:"space-y-2",children:[e.jsxs(Fe,{className:"text-sm flex items-center gap-2",children:[e.jsx(y,{className:"w-4 h-4 text-muted-foreground"}),d.question,d.required&&e.jsx("span",{className:"text-destructive",children:"*"})]}),d.type==="select"&&d.options&&d.multiSelect?e.jsx("div",{className:"flex flex-wrap gap-2",children:d.options.map(v=>{const b=(o[d.id]||[]).includes(v);return e.jsxs("button",{type:"button",onClick:()=>u(d.id,v),className:E("px-3 py-1.5 rounded-full text-sm border transition-all flex items-center gap-1",b?"bg-primary text-primary-foreground border-primary":"bg-background border-border hover:border-primary/50"),children:[b&&e.jsx(Xe,{className:"w-3 h-3"}),v]},v)})}):d.type==="select"&&d.options&&e.jsxs(ya,{value:o[d.id]?.toString()||"",onValueChange:v=>l(d.id,v),children:[e.jsx(Os,{className:"h-9",children:e.jsx(ba,{placeholder:"Select an option..."})}),e.jsx($s,{children:d.options.map(v=>e.jsx(ds,{value:v,children:v},v))})]}),d.type==="date"&&e.jsx(He,{type:"date",value:o[d.id]?.toString()||"",onChange:v=>l(d.id,v.target.value),className:"h-9",min:new Date().toISOString().split("T")[0]}),d.type==="number"&&e.jsx(He,{type:"number",value:o[d.id]?.toString()||"",onChange:v=>l(d.id,parseInt(v.target.value)||""),placeholder:d.placeholder||"Enter a number...",className:"h-9",min:1,max:24}),d.type==="text"&&e.jsx(He,{type:"text",value:o[d.id]?.toString()||"",onChange:v=>l(d.id,v.target.value),placeholder:d.placeholder||"Type your answer...",className:"h-9"})]},d.id)})}),e.jsxs("div",{className:"flex items-center gap-2 pt-2",children:[e.jsx(B,{onClick:m,disabled:!h||i,className:"flex-1 h-10",children:i?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"w-4 h-4 mr-2 animate-spin"}),"Generating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(se,{className:"w-4 h-4 mr-2"}),"Generate My Epic",e.jsx(tt,{className:"w-4 h-4 ml-1"})]})}),e.jsx(B,{variant:"ghost",size:"sm",onClick:r,disabled:i,className:"text-muted-foreground hover:text-foreground",children:"Skip"})]}),e.jsx("p",{className:"text-xs text-muted-foreground text-center",children:"This helps create a personalized study plan just for you"})]})}const pb=[{label:"2 weeks",getValue:()=>en(new Date,2)},{label:"1 month",getValue:()=>Ps(new Date,1)},{label:"3 months",getValue:()=>Ps(new Date,3)},{label:"6 months",getValue:()=>Ps(new Date,6)},{label:"1 year",getValue:()=>Gm(new Date,1)}];function hb({value:t,onChange:s,minDate:a}){const[r,i]=n.useState(!1),o=a||os(new Date,7),c=t?Je(t,new Date):null;return e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"flex flex-wrap gap-2",children:pb.map(l=>{const u=l.getValue(),m=t&&Y(t,"yyyy-MM-dd")===Y(u,"yyyy-MM-dd");return e.jsx(B,{type:"button",variant:m?"default":"outline",size:"sm",onClick:()=>s(u),className:"flex-1 min-w-[80px]",children:l.label},l.label)})}),e.jsxs(Wt,{open:r,onOpenChange:i,modal:!0,children:[e.jsx(Qt,{asChild:!0,children:e.jsxs(B,{variant:"outline",className:E("w-full justify-start text-left font-normal h-12",!t&&"text-muted-foreground"),children:[e.jsx(mt,{className:"mr-2 h-4 w-4"}),t?e.jsxs("span",{className:"flex items-center gap-2",children:[Y(t,"EEEE, MMMM d, yyyy"),c&&e.jsxs("span",{className:"text-xs text-muted-foreground",children:["(",c," days)"]})]}):e.jsx("span",{children:"Pick a specific date"})]})}),e.jsx(qt,{className:"w-auto p-0 z-[100] pointer-events-auto",align:"start",onOpenAutoFocus:l=>l.preventDefault(),children:e.jsx(Xs,{mode:"single",selected:t,onSelect:l=>{s(l),i(!1)},disabled:l=>l<o,initialFocus:!0,className:"pointer-events-auto",captionLayout:"dropdown",fromYear:new Date().getFullYear(),toYear:new Date().getFullYear()+10})})]}),t&&c&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground",children:[e.jsx(lt,{className:"w-4 h-4"}),e.jsxs("span",{children:[c," days until deadline",c<=14&&e.jsxs("span",{className:"ml-2 text-amber-500 font-medium",children:[e.jsx(Be,{className:"w-3 h-3 inline mr-1"}),"Intensive"]})]})]})]})}function fb({phase:t,milestones:s,isFirst:a,isLast:r,onMilestoneToggle:i,onMilestoneDateChange:o,postcardCount:c=0,maxPostcards:l=7}){const[u,m]=n.useState(null),[p,h]=n.useState(new Set),f=At(t.startDate),d=x=>{h(j=>{const w=new Set(j);return w.has(x)?w.delete(x):w.add(x),w})},g=At(t.endDate),y=Je(g,f)+1,v=["from-blue-500/20 to-cyan-500/20 border-blue-500/30","from-purple-500/20 to-pink-500/20 border-purple-500/30","from-amber-500/20 to-orange-500/20 border-amber-500/30","from-green-500/20 to-emerald-500/20 border-green-500/30","from-rose-500/20 to-red-500/20 border-rose-500/30"],b=v[(t.phaseOrder-1)%v.length];return e.jsxs("div",{className:"relative",children:[!a&&e.jsx("div",{className:"absolute left-6 -top-4 w-0.5 h-4 bg-border"}),e.jsxs("div",{className:E("p-4 rounded-xl border bg-gradient-to-br",b),children:[e.jsxs("div",{className:"flex items-start justify-between mb-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-8 h-8 rounded-full bg-background/50 flex items-center justify-center font-bold text-sm",children:t.phaseOrder}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-semibold",children:t.name}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[Y(f,"MMM d")," - ",Y(g,"MMM d")," (",y," days)"]})]})]}),e.jsxs(Ne,{variant:"outline",className:"text-xs",children:[y,"d"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:t.description}),s.length>0&&e.jsxs("div",{className:"space-y-2",children:[e.jsxs("p",{className:"text-xs font-medium text-muted-foreground flex items-center gap-1",children:[e.jsx(or,{className:"w-3 h-3"}),"Milestones"]}),s.map(x=>e.jsx("div",{className:E("w-full p-2.5 rounded-lg text-left transition-all","bg-background/50 hover:bg-background/80","border border-transparent hover:border-primary/30",x.isPostcardMilestone&&"ring-1 ring-amber-500/50"),children:e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:j=>{j.stopPropagation(),i?.(x.id)},disabled:!x.isPostcardMilestone&&c>=l,className:E("flex-shrink-0 transition-all",x.isPostcardMilestone?"text-amber-500 hover:text-amber-600":c>=l?"text-muted-foreground/30 cursor-not-allowed":"text-muted-foreground hover:text-amber-500"),title:x.isPostcardMilestone?"Remove celebration milestone":c>=l?`Max ${l} postcards reached`:"Mark as celebration milestone",children:e.jsx(et,{className:"w-4 h-4",fill:x.isPostcardMilestone?"currentColor":"none"})}),e.jsxs("button",{onClick:()=>d(x.id),className:"flex-1 min-w-0 text-left flex items-center gap-1",children:[e.jsx(tt,{className:E("w-3 h-3 flex-shrink-0 transition-transform",p.has(x.id)&&"rotate-90")}),e.jsx("p",{className:E("text-sm font-medium",p.has(x.id)?"whitespace-normal break-words":"truncate"),children:x.title})]}),e.jsxs(Wt,{open:u===x.id,onOpenChange:j=>m(j?x.id:null),children:[e.jsx(Qt,{asChild:!0,children:e.jsxs(B,{variant:"ghost",size:"sm",className:"h-6 px-2 text-xs text-muted-foreground hover:text-foreground",onClick:j=>j.stopPropagation(),children:[e.jsx(mt,{className:"w-3 h-3 mr-1"}),Y(At(x.targetDate),"MMM d")]})}),e.jsx(qt,{className:"w-auto p-0",align:"end",children:e.jsx(Xs,{mode:"single",selected:At(x.targetDate),onSelect:j=>{j&&(o?.(x.id,Y(j,"yyyy-MM-dd")),m(null))},className:"pointer-events-auto"})})]}),x.isPostcardMilestone&&e.jsx(Ne,{variant:"secondary",className:"text-[10px] px-1 py-0 h-4 flex-shrink-0",children:"Postcard"})]})},x.id))]})]}),!r&&e.jsx("div",{className:"absolute left-6 -bottom-4 w-0.5 h-4 bg-border"})]})}function gb({feasibilityAssessment:t,phases:s,milestones:a,rituals:r,weeklyHoursEstimate:i,deadline:o,onMilestoneToggle:c,onMilestoneDateChange:l,postcardCount:u=0,maxPostcards:m=7}){const p=n.useMemo(()=>[...s].sort((g,y)=>g.phaseOrder-y.phaseOrder),[s]),h=n.useMemo(()=>{const g=new Map;return a.forEach(y=>{const v=g.get(y.phaseOrder)||[];g.set(y.phaseOrder,[...v,y])}),g},[a]),f={comfortable:{bg:"bg-green-500/10",text:"text-green-500",border:"border-green-500/30"},achievable:{bg:"bg-blue-500/10",text:"text-blue-500",border:"border-blue-500/30"},aggressive:{bg:"bg-amber-500/10",text:"text-amber-500",border:"border-amber-500/30"},very_aggressive:{bg:"bg-red-500/10",text:"text-red-500",border:"border-red-500/30"}},d=f[t.feasibility]||f.achievable;return a.filter(g=>g.isPostcardMilestone),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:E("p-4 rounded-xl border",d.bg,d.border),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:E("p-2 rounded-lg",d.bg),children:e.jsx(mt,{className:E("w-5 h-5",d.text)})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsxs("span",{className:"font-semibold text-sm",children:[t.daysAvailable," days available"]}),e.jsx(Ne,{variant:"outline",className:E("text-xs",d.text,d.border),children:t.feasibility.replace("_"," ")})]}),e.jsx("p",{className:"text-sm text-muted-foreground",children:t.message})]})]})}),e.jsxs("div",{className:"flex items-center gap-4 text-sm text-muted-foreground",children:[e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(lt,{className:"w-4 h-4"}),e.jsxs("span",{children:["~",i," hrs/week"]})]}),e.jsxs("div",{className:"flex items-center gap-1.5",children:[e.jsx(et,{className:"w-4 h-4 text-amber-500"}),e.jsxs("span",{children:[u,"/",m," celebration milestones"]})]})]}),e.jsxs("div",{className:"space-y-4",children:[p.map((g,y)=>e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:y*.1},children:e.jsx(fb,{phase:g,milestones:h.get(g.phaseOrder)||[],isFirst:y===0,isLast:y===p.length-1,onMilestoneToggle:c,onMilestoneDateChange:l,postcardCount:u,maxPostcards:m})},g.id)),e.jsx(_.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{delay:p.length*.1},className:"p-4 bg-gradient-to-r from-primary/10 to-purple-500/10 rounded-xl border border-primary/30",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 rounded-full bg-primary/20",children:e.jsx(or,{className:"w-5 h-5 text-primary"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-semibold",children:"Goal Complete!"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:Y(At(o),"EEEE, MMMM d, yyyy")})]}),e.jsx(se,{className:"w-5 h-5 text-primary ml-auto animate-pulse"})]})})]}),e.jsxs("div",{className:"p-4 rounded-lg bg-muted/30 border",children:[e.jsxs("p",{className:"text-xs font-medium text-muted-foreground mb-2",children:["Daily & Weekly Rituals (",r.length,")"]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[r.slice(0,4).map(g=>e.jsx(Ne,{variant:"secondary",className:"text-xs",children:g.title},g.id)),r.length>4&&e.jsxs(Ne,{variant:"outline",className:"text-xs",children:["+",r.length-4," more"]})]})]})]})}const xb=[{label:"Less aggressive",value:"Make the schedule less aggressive, I need more breathing room"},{label:"More intensive",value:"I can dedicate more time, make it more intensive"},{label:"Fewer milestones",value:"Reduce the number of milestones, keep only the essential ones"},{label:"More rest days",value:"Include more rest days and recovery time"}];function yb({onSubmit:t,isLoading:s}){const[a,r]=n.useState(""),[i,o]=n.useState(!1),c=u=>{t(u)},l=()=>{a.trim()&&(t(a.trim()),r(""),o(!1))};return s?e.jsxs("div",{className:"p-4 bg-muted/50 rounded-xl border border-dashed flex items-center justify-center gap-2",children:[e.jsx(ze,{className:"w-4 h-4 animate-spin text-primary"}),e.jsx("span",{className:"text-sm text-muted-foreground",children:"Adjusting your plan..."})]}):e.jsxs("div",{className:"space-y-3",children:[e.jsxs("p",{className:"text-sm font-medium flex items-center gap-2",children:[e.jsx(gl,{className:"w-4 h-4"}),"Want to adjust the plan?"]}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[xb.map(u=>e.jsx(B,{variant:"outline",size:"sm",onClick:()=>c(u.value),className:"text-xs",children:u.label},u.label)),e.jsxs(B,{variant:"ghost",size:"sm",onClick:()=>o(!i),className:"text-xs",children:[e.jsx(se,{className:"w-3 h-3 mr-1"}),"Custom request"]})]}),i&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(He,{placeholder:"e.g., 'I have prior experience, skip the basics'",value:a,onChange:u=>r(u.target.value),onKeyDown:u=>u.key==="Enter"&&l(),className:"flex-1"}),e.jsx(B,{onClick:l,disabled:!a.trim(),size:"sm",children:"Adjust"})]})]})}const bb=[{id:"experience_level",question:"What is your current experience level?",type:"select",options:["Complete beginner","Some experience","Intermediate","Advanced"],required:!0},{id:"daily_time",question:"How much time can you dedicate daily?",type:"text",placeholder:"e.g., 1-2 hours, 30 minutes",required:!0},{id:"priority_focus",question:"What aspect is most important to you?",type:"text",placeholder:"e.g., speed, thoroughness, consistency",required:!1}];function vb({open:t,onOpenChange:s,onCreateEpic:a,isCreating:r,initialGoal:i="",initialTargetDays:o,template:c,showTemplatesFirst:l=!1,clarificationAnswers:u,epicContext:m}){const p=n.useRef(!1),h=n.useRef(null),[f,d]=n.useState("goal"),[g,y]=n.useState(i),[v,b]=n.useState(void 0),[x,j]=n.useState(""),{preferences:w,isAtEpicLimit:D}=rb(),{trackInteraction:S}=Rn(),{schedule:M,isLoading:C,generateSchedule:R,adjustSchedule:T,toggleMilestone:q,updateMilestoneDate:k,reset:P,setRituals:A,postcardCount:L,maxPostcards:H}=yd(),[I,te]=n.useState([]),{classify:V,isClassifying:z,clarifyEpic:W,reset:Q}=nb({useOrchestrator:!1}),[U,$]=n.useState(!1),[J,O]=n.useState([]),[le,G]=n.useState({}),[Z,he]=n.useState(void 0),ve=n.useMemo(()=>v?Math.max(7,Je(v,new Date)):o||w.epicDuration||30,[v,o,w.epicDuration]),[we,je]=n.useState(""),[ke,Ae]=n.useState(""),[Re,Ge]=n.useState([]),[ge,Te]=n.useState(null),[Le,F]=n.useState(Yr[0].id),[de,ae]=n.useState(c||null),{medium:K,success:fe,light:Ce,tap:De}=Tn();ab();const{suggestions:re,error:_e,getSelectedSuggestions:oe,reset:Ee}=sb(),[Ue,ft]=n.useState(""),{isRecording:vt,isAutoStopping:We,startRecording:at,stopRecording:rt}=Hd({onInterimResult:pe=>ft(pe),onFinalResult:pe=>{y(Ye=>(Ye?Ye+" "+pe:pe).trim()),ft(""),fe()},autoStopOnSilence:!0,silenceTimeoutMs:2e3});n.useEffect(()=>{if(de&&t){je(de.name),Ae(de.description),b(os(new Date,de.target_days)),F(de.theme_color||Yr[0].id);const pe=nt=>nt==="daily"?"daily":nt==="5x_week"?"5x_week":nt==="3x_week"||nt==="weekly"?"3x_week":"custom",Ye=de.habits.map((nt,Oe)=>({id:`template-${Oe}`,type:"habit",title:nt.title,description:"",difficulty:nt.difficulty||"medium",frequency:pe(nt.frequency||"daily"),selected:!0}));Ge(Ye),d("goal")}},[de,t]),n.useEffect(()=>{c&&t&&ae(c)},[c,t]),n.useEffect(()=>{t||(p.current=!1)},[t]),n.useEffect(()=>{h.current&&h.current.scrollTo({top:0,behavior:"instant"})},[f]);const Kt=n.useMemo(()=>oe(),[oe]),wt=n.useMemo(()=>M?.rituals?(console.log("[Pathfinder] Mapping schedule rituals:",M.rituals.length,M.rituals.map(pe=>({title:pe.title,estimatedMinutes:pe.estimatedMinutes}))),M.rituals.map(pe=>({id:pe.id,title:pe.title,description:pe.description,type:"habit",difficulty:pe.difficulty,frequency:pe.frequency,estimatedMinutes:pe.estimatedMinutes,isSelected:!0}))):[...Kt.filter(pe=>pe.type==="habit"),...Re],[M,Kt,Re]),Js=n.useMemo(()=>M?.milestones||Kt.filter(pe=>pe.type==="milestone"),[M,Kt]),vr=n.useMemo(()=>ve*hf.XP_PER_DAY,[ve]),rs=n.useCallback(async(pe,Ye)=>{if(!g.trim()||!v)return;De();const nt=Y(v,"yyyy-MM-dd"),Oe=pe??(Object.keys(le).length>0?le:u),hs=await R({goal:g,deadline:nt,clarificationAnswers:Oe,epicContext:Ye??Z??m,timelineContext:x.trim()||void 0});if(!hs){X.error("Failed to generate timeline",{description:"Please try again or adjust your goal"});return}hs.rituals&&te([...hs.rituals]),hs.suggestedStoryType&&Te(hs.suggestedStoryType),hs.suggestedThemeColor&&F(hs.suggestedThemeColor),we||je(g),d("timeline"),fe()},[g,v,u,m,le,Z,x,we,R,De,fe]),wr=n.useCallback(async pe=>{if(!M||!v)return;await T({goal:g,deadline:Y(v,"yyyy-MM-dd"),adjustmentRequest:pe,previousSchedule:{phases:M.phases,milestones:M.milestones,rituals:M.rituals}})?(fe(),X.success("Schedule updated!",{description:pe.toLowerCase().includes("intensive")?"Made your plan more intensive":pe.toLowerCase().includes("less")||pe.toLowerCase().includes("breathing")?"Made your plan more relaxed":"Adjusted based on your feedback"})):(Ce(),X.error("Failed to adjust schedule",{description:"Please try again"}))},[M,v,g,T,fe,Ce]),jr=n.useCallback(()=>{M&&(d("suggestions"),K())},[M,K]),_r=n.useCallback(async()=>{if(!g.trim()||!v)return;De();const pe=await V(g);if(console.log("[Pathfinder] Classification result:",{input:g,type:pe?.type,confidence:pe?.confidence,needsClarification:pe?.needsClarification,questionsCount:pe?.epicClarifyingQuestions?.length,epicContext:pe?.epicContext}),pe?.type==="epic"){const Ye=pe.epicClarifyingQuestions?.length?pe.epicClarifyingQuestions:bb;O(Ye),$(!0)}else we||je(g),await rs()},[g,v,we,V,De,rs]),Nr=n.useCallback(async pe=>{G(pe),$(!1);const nt=(await W(g,pe))?.epicContext;nt&&he(nt),we||je(g),await rs(pe,nt)},[g,W,we,rs]),ne=n.useCallback(async()=>{$(!1),we||je(g),await rs()},[g,we,rs]),xe=n.useCallback(()=>{d("review"),K()},[K]),Tt=n.useCallback(()=>{if(wt.length===0){console.warn("Cannot create epic: no habits selected");return}const pe=wt.map(Oe=>({title:Oe.title,description:Oe.description,difficulty:Oe.difficulty,frequency:Oe.frequency||"daily",custom_days:Oe.customDays||Wd(Oe.frequency||"daily"),estimated_minutes:Oe.estimatedMinutes}));console.log("[Pathfinder] Creating epic with habits:",pe.length,pe.map(Oe=>Oe.title)),pe.length<2&&M?.rituals&&M.rituals.length>pe.length&&console.warn("[Pathfinder] Habit count mismatch! Schedule has",M.rituals.length,"but habits array has",pe.length);const Ye=M?.milestones.map(Oe=>({title:Oe.title,description:Oe.description,target_date:Oe.targetDate,milestone_percent:Oe.milestonePercent,is_postcard_milestone:Oe.isPostcardMilestone}));console.log("[Pathfinder] Creating epic with milestones:",Ye?.length||0,Ye);const nt=M?.phases.map(Oe=>({name:Oe.name,description:Oe.description,start_date:Oe.startDate,end_date:Oe.endDate,phase_order:Oe.phaseOrder}));S({interactionType:"epic-creation",inputText:g,aiResponse:{totalSuggestions:re?.length||0,selectedHabits:wt.length,targetDays:ve,storyType:ge,hasSchedule:!!M},userAction:"accepted",detectedIntent:"epic"}),a({title:we||g,description:ke||void 0,target_days:ve,habits:pe,milestones:Ye,phases:nt,is_public:!0,story_type_slug:ge||void 0,theme_color:Le}),fe()},[wt,we,g,ke,ve,ge,Le,M,a,fe,S,re]),dt=n.useCallback(()=>{Ce(),f==="timeline"?d("goal"):f==="suggestions"?d("timeline"):f==="review"&&d("suggestions")},[f,Ce]),Et=n.useCallback(()=>{d("goal"),y(i),b(void 0),j(""),je(""),Ae(""),Ge([]),Te(null),F(Yr[0].id),ae(null),$(!1),O([]),G({}),he(void 0),Ee(),P(),Q(),s(!1)},[s,Ee,P,Q,i]),Ea=n.useCallback(()=>{vt?rt():at(),De()},[vt,at,rt,De]),kr=["goal","timeline","suggestions","review"],Cr=kr.indexOf(f);return e.jsx(ct,{open:t,onOpenChange:Et,children:e.jsxs(ot,{className:"sm:max-w-lg max-h-[90vh] flex flex-col p-0",children:[e.jsxs(as,{className:"p-6 pb-4",children:[e.jsxs(St,{className:"flex items-center gap-2",children:[e.jsx(se,{className:"w-5 h-5 text-primary"}),"Pathfinder"]}),e.jsxs(_s,{children:[f==="goal"&&"Set your goal and deadline",f==="timeline"&&"Review your personalized timeline",f==="suggestions"&&"Confirm your rituals and milestones",f==="review"&&"Review and create your campaign"]})]}),D&&e.jsx("div",{className:"px-6 pb-2",children:e.jsx(ub,{isAtEpicLimit:D,isLoading:!1})}),e.jsx("div",{className:"px-6 pb-4",children:e.jsx("div",{className:"flex items-center justify-center gap-2",children:kr.map((pe,Ye)=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:E("w-8 h-8 rounded-full flex items-center justify-center text-sm font-medium transition-all",f===pe?"bg-primary text-primary-foreground":Cr>Ye?"bg-primary/20 text-primary":"bg-muted text-muted-foreground"),children:Cr>Ye?e.jsx(Xe,{className:"w-4 h-4"}):Ye+1}),Ye<kr.length-1&&e.jsx("div",{className:E("w-4 h-0.5 mx-1",Cr>Ye?"bg-primary":"bg-muted")})]},pe))})}),e.jsx("div",{ref:h,className:"flex-1 min-h-0 overflow-y-auto overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:e.jsxs(be,{mode:"wait",children:[f==="goal"&&e.jsxs(_.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"px-6 pb-6 space-y-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{htmlFor:"goal-input",className:"text-base font-semibold",children:"What's your goal?"}),e.jsxs("div",{className:"relative",children:[e.jsx(xt,{id:"goal-input",placeholder:"e.g., Pass the bar exam, Run a marathon, Learn Spanish",value:vt?g+(Ue?" "+Ue:""):g,onChange:pe=>y(pe.target.value),rows:3,className:"pr-12 text-base"}),e.jsx(B,{size:"icon",variant:vt?"default":"ghost",className:E("absolute right-2 top-2 h-8 w-8",vt&&"animate-pulse bg-red-500 hover:bg-red-600"),onClick:Ea,disabled:We,children:e.jsx(pn,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Fe,{htmlFor:"context-input",className:"text-base font-semibold flex items-center gap-2",children:["List current experience",e.jsx("span",{className:"text-sm font-normal text-muted-foreground",children:"(optional)"})]}),e.jsx(xt,{id:"context-input",placeholder:"e.g., Already know basics, studying for 2 weeks, starting from scratch",value:x,onChange:pe=>j(pe.target.value),rows:2,className:"text-base"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs(Fe,{className:"text-base font-semibold flex items-center gap-2",children:[e.jsx(mt,{className:"w-4 h-4"}),"When do you need to achieve this?"]}),e.jsx(hb,{value:v,onChange:b})]}),e.jsx(be,{children:U&&J.length>0&&e.jsx(mb,{goal:g,questions:J,onSubmit:Nr,onSkip:ne,isLoading:z})}),!U&&e.jsx(B,{onClick:_r,disabled:!g.trim()||!v||z||C,className:"w-full h-12 text-base",size:"lg",children:z?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"w-4 h-4 mr-2 animate-spin"}),"Analyzing your goal..."]}):C?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"w-4 h-4 mr-2 animate-spin"}),"Generating your plan..."]}):e.jsxs(e.Fragment,{children:[e.jsx(us,{className:"w-5 h-5 mr-2"}),"Generate My Plan"]})}),_e&&e.jsx("p",{className:"text-sm text-destructive text-center",children:_e})]},"goal"),f==="timeline"&&M&&v&&e.jsx(_.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"flex flex-col h-full min-h-0",children:e.jsx("div",{className:"flex-1 overflow-y-auto px-4 overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:e.jsxs("div",{className:"space-y-4 pb-4",children:[e.jsx(gb,{feasibilityAssessment:M.feasibilityAssessment,phases:M.phases,milestones:M.milestones,rituals:M.rituals,weeklyHoursEstimate:M.weeklyHoursEstimate,deadline:Y(v,"yyyy-MM-dd"),onMilestoneToggle:q,onMilestoneDateChange:k,postcardCount:L,maxPostcards:H}),e.jsx("div",{className:"pt-4 border-t",children:e.jsx(yb,{onSubmit:wr,isLoading:C})}),e.jsxs("div",{className:"space-y-3 pt-2",children:[e.jsxs(B,{onClick:jr,className:"w-full",children:["Continue with this plan",e.jsx(tt,{className:"w-4 h-4 ml-1"})]}),e.jsxs(B,{variant:"ghost",onClick:dt,className:"w-full",children:[e.jsx(ys,{className:"w-4 h-4 mr-1"}),"Back"]})]})]})})},"timeline"),f==="suggestions"&&e.jsxs(_.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"flex flex-col h-full min-h-0",children:[e.jsx("div",{className:"flex-1 overflow-y-auto px-6 overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:e.jsxs("div",{className:"space-y-4 pb-4",children:[M?.rituals&&e.jsx(cb,{rituals:M.rituals,originalRituals:I,onRitualsChange:A}),e.jsxs("div",{className:"space-y-2",children:[e.jsxs("div",{className:"flex items-center gap-2 text-sm font-medium",children:[e.jsx(or,{className:"w-4 h-4"}),"Milestones (",Js.length,")"]}),Js.map(pe=>e.jsx("div",{className:"p-3 bg-amber-500/10 rounded-lg",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"font-medium",children:pe.title}),e.jsx(Ne,{variant:"outline",children:pe.targetDate?Y(At(pe.targetDate),"MMM d"):`Week ${pe.suggestedWeek}`})]})},pe.id))]}),M?.milestones&&e.jsx(db,{milestones:M.milestones,storyType:ge})]})}),e.jsxs("div",{className:"p-6 pt-4 border-t bg-background space-y-3",children:[e.jsxs(B,{onClick:xe,className:"w-full",children:["Continue to Review",e.jsx(tt,{className:"w-4 h-4 ml-1"})]}),e.jsxs(B,{variant:"ghost",onClick:dt,className:"w-full",children:[e.jsx(ys,{className:"w-4 h-4 mr-1"}),"Back to Timeline"]})]})]},"suggestions"),f==="review"&&e.jsxs(_.div,{initial:{opacity:0,x:20},animate:{opacity:1,x:0},exit:{opacity:0,x:-20},className:"flex flex-col h-full min-h-0",children:[e.jsx("div",{className:"flex-1 overflow-y-auto px-6 overscroll-contain",style:{WebkitOverflowScrolling:"touch",touchAction:"pan-y"},children:e.jsxs("div",{className:"space-y-4 pb-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(Fe,{htmlFor:"epic-why",children:"Your Why"}),e.jsx(xt,{id:"epic-why",value:ke,onChange:pe=>Ae(pe.target.value),placeholder:"Why are you embarking on this campaign? What's your purpose?",rows:3}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Define your purpose - this will fuel your motivation"})]}),ke.trim().length>0&&e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:"space-y-2",children:[e.jsx(Fe,{htmlFor:"epic-title",children:"Campaign Name"}),e.jsx(He,{id:"epic-title",value:we,onChange:pe=>je(pe.target.value),placeholder:"Name your campaign"})]}),e.jsxs("div",{className:"p-4 bg-gradient-to-r from-primary/10 to-purple-500/10 rounded-xl border border-primary/20",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"w-5 h-5 text-primary"}),e.jsx("span",{className:"font-medium",children:"Completion Reward"})]}),e.jsxs("span",{className:"text-xl font-bold text-primary",children:["+",vr," XP"]})]}),e.jsxs("p",{className:"text-xs text-muted-foreground mt-1",children:[ve," days â€¢ ",wt.length," rituals â€¢ ",Js.length," milestones"]})]})]})}),e.jsxs("div",{className:"p-6 pt-4 border-t bg-background space-y-3",children:[e.jsx(B,{onClick:Tt,disabled:r||wt.length===0||ke.trim().length===0||we.trim().length===0,className:"w-full bg-gradient-to-r from-primary to-purple-600",children:r?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"w-4 h-4 mr-2 animate-spin"}),"Creating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ze,{className:"w-4 h-4 mr-2"}),"Create Campaign"]})}),e.jsxs(B,{variant:"ghost",onClick:dt,className:"w-full",children:[e.jsx(ys,{className:"w-4 h-4 mr-1"}),"Back"]})]})]},"review")]})})]})})}const wb={easy:{label:"Easy",color:"text-green-500 bg-green-500/10 border-green-500/20"},medium:{label:"Medium",color:"text-amber-500 bg-amber-500/10 border-amber-500/20"},hard:{label:"Hard",color:"text-red-500 bg-red-500/10 border-red-500/20"}},jb={daily:"Daily",weekly:"Weekly",custom:"Custom Days"};n.memo(function({suggestion:s,onToggle:a,index:r}){const i=s.type==="habit",o=wb[s.difficulty];return e.jsx(_.button,{initial:{opacity:0,y:20,scale:.95},animate:{opacity:1,y:0,scale:1},transition:{delay:r*.08,duration:.3},onClick:()=>a(s.id),className:E("w-full p-4 rounded-xl border-2 text-left transition-all duration-200","hover:shadow-lg hover:scale-[1.02] active:scale-[0.98]",s.selected?"border-primary bg-primary/5 shadow-md":"border-border/50 bg-card hover:border-primary/30"),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:E("w-6 h-6 rounded-full border-2 flex items-center justify-center shrink-0 mt-0.5 transition-all",s.selected?"border-primary bg-primary text-primary-foreground":"border-muted-foreground/30"),children:s.selected&&e.jsx(Xe,{className:"w-4 h-4"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[i?e.jsx(vs,{className:"w-4 h-4 text-primary shrink-0"}):e.jsx(or,{className:"w-4 h-4 text-amber-500 shrink-0"}),e.jsx("span",{className:"font-semibold text-foreground truncate",children:s.title})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2 mb-2",children:tn(s.description)}),e.jsxs("div",{className:"flex flex-wrap gap-2",children:[e.jsx("span",{className:E("text-xs px-2 py-0.5 rounded-full border",i?"text-primary bg-primary/10 border-primary/20":"text-amber-500 bg-amber-500/10 border-amber-500/20"),children:i?"Habit":"Milestone"}),i&&s.frequency&&e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-secondary text-secondary-foreground",children:jb[s.frequency]||s.frequency}),!i&&s.suggestedWeek&&e.jsxs("span",{className:"text-xs px-2 py-0.5 rounded-full bg-secondary text-secondary-foreground",children:["Week ",s.suggestedWeek]}),e.jsx("span",{className:E("text-xs px-2 py-0.5 rounded-full border",o.color),children:o.label}),s.category&&e.jsx("span",{className:"text-xs px-2 py-0.5 rounded-full bg-muted text-muted-foreground",children:s.category})]})]})]})})});function _b({isVisible:t,campaignTitle:s,habits:a,onComplete:r}){const[i,o]=n.useState(!1),[c,l]=n.useState("title");return n.useEffect(()=>{if(!t){l("title"),o(!1);return}const u=setTimeout(()=>l("habits"),800),m=setTimeout(()=>o(!0),1200),p=setTimeout(()=>l("flyout"),2500+a.length*200),h=setTimeout(r,3500+a.length*200);return()=>{clearTimeout(u),clearTimeout(m),clearTimeout(p),clearTimeout(h)}},[t,a.length,r]),t?e.jsx(be,{children:e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"fixed inset-0 z-[100] flex items-center justify-center bg-background/95 backdrop-blur-sm",onClick:r,children:[i&&e.jsx(Lm,{width:window.innerWidth,height:window.innerHeight,recycle:!1,numberOfPieces:150,gravity:.3,colors:["#a855f7","#ec4899","#f59e0b","#10b981","#3b82f6"]}),e.jsx("div",{className:"absolute inset-0 pointer-events-none",children:e.jsx(_.div,{className:"absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-96 h-96 rounded-full bg-primary/20 blur-3xl",animate:{scale:[1,1.2,1],opacity:[.3,.5,.3]},transition:{duration:2,repeat:1/0,ease:"easeInOut"}})}),e.jsxs("div",{className:"relative z-10 flex flex-col items-center gap-6 px-6 max-w-md mx-auto",children:[e.jsxs(_.div,{initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1},transition:{type:"spring",damping:12,stiffness:200},className:"text-center",children:[e.jsxs(_.div,{className:"flex items-center justify-center gap-2 mb-2",animate:{scale:[1,1.05,1]},transition:{duration:1.5,repeat:1/0},children:[e.jsx(se,{className:"w-6 h-6 text-stardust-gold"}),e.jsx("span",{className:"text-sm font-medium text-stardust-gold uppercase tracking-wider",children:"Campaign Created!"}),e.jsx(se,{className:"w-6 h-6 text-stardust-gold"})]}),e.jsx("h2",{className:"text-2xl font-bold bg-gradient-to-r from-primary via-purple-500 to-accent bg-clip-text text-transparent",children:s})]}),e.jsx(be,{children:c!=="title"&&e.jsxs(_.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"w-full space-y-2",children:[e.jsx(_.p,{initial:{opacity:0},animate:{opacity:1},className:"text-center text-sm text-muted-foreground mb-3",children:"Cosmiq Rituals added to Today's Agenda"}),a.map((u,m)=>e.jsxs(_.div,{initial:{opacity:0,x:-30,scale:.9},animate:c==="flyout"?{opacity:0,x:-100,y:200,scale:.5,transition:{delay:m*.1,duration:.4}}:{opacity:1,x:0,scale:1,transition:{delay:m*.15,type:"spring",damping:15}},className:"flex items-center gap-3 p-3 rounded-xl bg-card/80 border border-accent/30 backdrop-blur-sm",children:[e.jsx("div",{className:"flex-shrink-0 w-8 h-8 rounded-full bg-accent/20 flex items-center justify-center",children:e.jsx(vs,{className:"w-4 h-4 text-accent"})}),e.jsx("span",{className:"flex-1 text-sm font-medium truncate",children:u.title}),e.jsx(_.div,{initial:{scale:0},animate:{scale:1},transition:{delay:m*.15+.3,type:"spring"},children:e.jsx(ms,{className:"w-5 h-5 text-primary"})})]},m))]})}),c==="habits"&&e.jsxs(_.div,{initial:{opacity:0,scale:.8},animate:{opacity:1,scale:1},transition:{delay:a.length*.15+.3},className:"flex items-center gap-2 px-4 py-2 rounded-full bg-accent/20 border border-accent/40",children:[e.jsx(se,{className:"w-4 h-4 text-accent"}),e.jsxs("span",{className:"text-sm font-semibold text-accent",children:[a.length," Cosmiq Ritual",a.length!==1?"s":""," Ready"]})]}),e.jsx(_.p,{initial:{opacity:0},animate:{opacity:.5},transition:{delay:2},className:"text-xs text-muted-foreground",children:"Tap anywhere to continue"})]})]})}):null}class Nb extends n.Component{constructor(s){super(s),this.state={hasError:!1,error:null,errorCount:0}}static getDerivedStateFromError(s){return{hasError:!0,error:s}}componentDidCatch(s,a){const{section:r}=this.props;ee.error(`SectionErrorBoundary [${r}] caught error`,{section:r,error:s.message,stack:s.stack,componentStack:a.componentStack}),this.setState(i=>({errorCount:i.errorCount+1}))}handleRetry=()=>{const{onRetry:s,section:a}=this.props;ee.info(`Retrying section: ${a}`),this.setState({hasError:!1,error:null}),s&&s()};render(){const{hasError:s,error:a,errorCount:r}=this.state,{children:i,section:o,title:c="Something went wrong",description:l="This section couldn't load properly",icon:u=ps,fallback:m,showRetry:p=!0,compact:h=!1,className:f=""}=this.props;if(!s)return i;if(m)return m;const d=3,g=p&&r<d;return h?e.jsxs("div",{className:`flex items-center gap-3 p-3 rounded-lg bg-destructive/10 border border-destructive/20 ${f}`,children:[e.jsx(u,{className:"h-5 w-5 text-destructive flex-shrink-0"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("p",{className:"text-sm font-medium text-destructive truncate",children:c})}),g&&e.jsx(B,{variant:"ghost",size:"sm",onClick:this.handleRetry,className:"flex-shrink-0",children:e.jsx(bs,{className:"h-4 w-4"})})]}):e.jsxs(Me,{className:`p-6 text-center ${f}`,children:[e.jsx(u,{className:"h-12 w-12 text-destructive mx-auto mb-4"}),e.jsx("h3",{className:"text-lg font-semibold text-foreground mb-2",children:c}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:l}),!1,g?e.jsxs(B,{variant:"outline",size:"sm",onClick:this.handleRetry,className:"gap-2",children:[e.jsx(bs,{className:"h-4 w-4"}),"Try Again"]}):r>=d?e.jsx("p",{className:"text-xs text-muted-foreground",children:"Please refresh the page or try again later"}):null]})}}const kb=({children:t})=>e.jsx(Nb,{section:"quests",title:"Quests unavailable",description:"Unable to load your quests right now",children:t});function Cb(t){const{user:s}=ce(),a=Se(),r=ye({queryKey:gt.contactInteractions.byContact(t??""),queryFn:async()=>{if(!t)return[];const{data:c,error:l}=await N.from("contact_interactions").select("*").eq("contact_id",t).order("occurred_at",{ascending:!1});if(l)throw l;return c},enabled:!!s&&!!t}),i=ie({mutationFn:async c=>{if(!s)throw new Error("Not authenticated");const{data:l,error:u}=await N.from("contact_interactions").insert({...c,user_id:s.id,occurred_at:c.occurred_at??new Date().toISOString()}).select().single();if(u)throw u;return l},onSuccess:(c,l)=>{a.invalidateQueries({queryKey:gt.contactInteractions.byContact(l.contact_id)}),a.invalidateQueries({queryKey:gt.contacts.all}),X.success("Interaction logged")},onError:c=>{X.error("Failed to log interaction"),console.error("Create interaction error:",c)}}),o=ie({mutationFn:async({id:c,contactId:l})=>{const{error:u}=await N.from("contact_interactions").delete().eq("id",c);if(u)throw u;return l},onSuccess:c=>{a.invalidateQueries({queryKey:gt.contactInteractions.byContact(c)}),X.success("Interaction deleted")},onError:c=>{X.error("Failed to delete interaction"),console.error("Delete interaction error:",c)}});return{interactions:r.data??[],isLoading:r.isLoading,createInteraction:i,deleteInteraction:o}}function Sb(){const[t,s]=n.useState(null),{createInteraction:a}=Cb(t?.contact?.id),r=n.useCallback((l,u,m,p)=>{m&&p&&s({taskId:l,taskText:u,contact:m,autoLogInteraction:p})},[]),i=n.useCallback(async(l,u)=>{t&&(await a.mutateAsync({contact_id:t.contact.id,interaction_type:l,summary:u}),s(null))},[t,a]),o=n.useCallback(()=>{s(null)},[]),c=n.useCallback(()=>{s(null)},[]);return{pendingInteraction:t,isModalOpen:!!t,handleTaskCompleted:r,logInteraction:i,skipInteraction:o,closeModal:c,isLogging:a.isPending}}const Tb=[{value:"call",label:"Call",icon:Om},{value:"email",label:"Email",icon:pl},{value:"meeting",label:"Meeting",icon:mt},{value:"message",label:"Message",icon:gl},{value:"note",label:"Note",icon:Xr}];function Eb({open:t,onOpenChange:s,contactName:a,contactAvatarUrl:r,taskTitle:i,onLog:o,onSkip:c}){const[l,u]=n.useState(""),[m,p]=n.useState(i),[h,f]=n.useState(!1),d=n.useMemo(()=>{const b=i.toLowerCase();return b.includes("call")||b.includes("phone")?"call":b.includes("email")||b.includes("send")||b.includes("write")?"email":b.includes("meet")||b.includes("lunch")||b.includes("coffee")?"meeting":b.includes("text")||b.includes("message")?"message":"note"},[i]);Fm.useEffect(()=>{l||u(d)},[d,l]);const g=async()=>{if(!(!l||!m.trim())){f(!0);try{await o(l,m.trim()),s(!1)}finally{f(!1)}}},y=()=>{c(),s(!1)},v=a.split(" ").map(b=>b[0]).join("").toUpperCase().slice(0,2);return e.jsx(ct,{open:t,onOpenChange:s,children:e.jsxs(ot,{className:"sm:max-w-md",children:[e.jsxs(as,{children:[e.jsx(St,{children:"Log Interaction"}),e.jsxs(_s,{children:["Record this as an interaction with ",a,"?"]})]}),e.jsxs("div",{className:"space-y-4 py-2",children:[e.jsxs("div",{className:"flex items-center gap-3 p-3 rounded-lg bg-muted/50",children:[e.jsxs(qs,{className:"h-10 w-10",children:[e.jsx(Ls,{src:r||void 0}),e.jsx(Fs,{className:"bg-primary/10 text-primary text-sm",children:v})]}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:a}),e.jsx("p",{className:"text-xs text-muted-foreground",children:i})]})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Type"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Tb.map(b=>{const x=b.icon,j=l===b.value;return e.jsxs("button",{type:"button",onClick:()=>u(b.value),className:E("flex items-center gap-1.5 px-3 py-1.5 rounded-full text-sm transition-all",j?"bg-primary text-primary-foreground":"bg-muted hover:bg-muted/80 text-foreground"),children:[e.jsx(x,{className:"h-3.5 w-3.5"}),b.label]},b.value)})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("label",{className:"text-sm font-medium",children:"Summary"}),e.jsx(xt,{value:m,onChange:b=>p(b.target.value),placeholder:"What happened?",rows:2})]})]}),e.jsxs("div",{className:"flex gap-2 pt-2",children:[e.jsx(B,{variant:"outline",onClick:y,className:"flex-1",disabled:h,children:"Just Complete"}),e.jsx(B,{onClick:g,className:"flex-1",disabled:!l||!m.trim()||h,children:h?e.jsxs(e.Fragment,{children:[e.jsx(ze,{className:"h-4 w-4 mr-2 animate-spin"}),"Logging..."]}):"Log & Complete"})]})]})})}const Mb=()=>{const t=ss(),[s,a]=n.useState(new Date),[r,i]=n.useState(!1),[o,c]=n.useState(!1),[l,u]=n.useState(null),[m,p]=n.useState(!1),[h,f]=n.useState(!1),[d,g]=n.useState(!1),[y,v]=n.useState(null),{showModal:b,dismissModal:x}=kn("journeys"),{user:j}=ce(),w=Se(),{profile:D,loading:S}=yt(),{needsStreakDecision:M,currentStreak:C,freezesAvailable:R,useFreeze:T,resetStreak:q,isResolving:k}=Vy(),{trackDailyPlanOutcome:P}=Rn(),{epics:A,createEpic:L,isCreating:H}=eb(),I=n.useMemo(()=>A?.filter(ne=>ne.status==="active").slice(0,5)||[],[A]),{currentStreak:te}=fr(),{pendingInteraction:V,isModalOpen:z,handleTaskCompleted:W,logInteraction:Q,skipInteraction:U,closeModal:$}=Sb(),{tasks:J,isLoading:O,addTask:le,toggleTask:G,updateTask:Z,deleteTask:he,restoreTask:ve,moveTaskToDate:we,completedCount:je,totalCount:ke,isAdding:Ae,isUpdating:Re,isDeleting:Ge}=Wy(s),[ge,Te]=n.useState(null),[Le,F]=n.useState(null),{tasks:de}=Qy(s,"month"),{surfaceAllEpicHabits:ae,unsurfacedEpicHabitsCount:K}=Ky(),{pendingRecurringCount:fe,spawnRecurringTasks:Ce}=Gy(s),De=n.useRef(!1),re=n.useRef(!1),_e=n.useRef(Y(s,"yyyy-MM-dd"));n.useEffect(()=>{const ne=Y(s,"yyyy-MM-dd");_e.current!==ne&&(_e.current=ne,De.current=!1,re.current=!1),K>0&&!De.current&&(De.current=!0,ae()),fe>0&&!re.current&&(re.current=!0,Ce())},[K,fe,s,ae,Ce]);const oe=!S&&D?.onboarding_data?.walkthrough_completed===!0;X0(j?.id,oe,S);const Ee=n.useCallback(async ne=>{if(ne.habit_source_id){const{data:xe}=await N.from("habits").select("frequency, custom_days, description").eq("id",ne.habit_source_id).maybeSingle();F({habitId:ne.habit_source_id,taskId:ne.id,title:ne.task_text,description:xe?.description||null,difficulty:ne.difficulty||"medium",frequency:xe?.frequency||"daily",custom_days:xe?.custom_days||[],estimated_minutes:ne.estimated_duration,preferred_time:ne.scheduled_time,category:ne.category,recurrence_pattern:ne.recurrence_pattern,recurrence_days:ne.recurrence_days,reminder_enabled:ne.reminder_enabled,reminder_minutes_before:ne.reminder_minutes_before})}else Te(ne)},[]),{pendingTaskId:Ue,clearPendingTask:ft}=Yp(),vt=n.useRef(null);n.useEffect(()=>{if(!Ue||vt.current===Ue||O)return;const ne=J.find(xe=>xe.id===Ue);ne?(ee.log("[Journeys] Opening deep-linked task:",Ue),vt.current=Ue,Ee(ne),ft()):(ee.log("[Journeys] Deep link task not found in daily tasks:",Ue),vt.current=Ue,ft())},[Ue,J,O,ft,Ee]);const We=n.useMemo(()=>{const ne={};return de.forEach(xe=>{xe.task_date&&(ne[xe.task_date]=(ne[xe.task_date]||0)+1)}),ne},[de]),at=n.useCallback(async ne=>{const xe=ne.sendToInbox?null:ne.taskDate??Y(s,"yyyy-MM-dd");await le({taskText:ne.text,difficulty:ne.difficulty,taskDate:xe,isMainQuest:!1,scheduledTime:ne.scheduledTime,estimatedDuration:ne.estimatedDuration,recurrencePattern:ne.recurrencePattern,recurrenceDays:ne.recurrenceDays,reminderEnabled:ne.reminderEnabled,reminderMinutesBefore:ne.reminderMinutesBefore,notes:ne.moreInformation,location:ne.location,contactId:ne.contactId,autoLogInteraction:ne.autoLogInteraction,subtasks:ne.subtasks}),c(!1)},[s,le]),rt=n.useCallback((ne,xe,Tt,dt)=>{xe&&dt?.ai_generated&&P(ne,"completed",{scheduledTime:dt.scheduled_time??void 0,difficulty:dt.difficulty??void 0,category:dt.category??void 0,wasOnTime:!0}),G({taskId:ne,completed:xe,xpReward:Tt},{onSuccess:Et=>{Et.completed&&Et.contact&&Et.autoLogInteraction&&W(Et.taskId,Et.taskText,Et.contact,Et.autoLogInteraction)}})},[G,P,W]),Kt=n.useCallback((ne,xe)=>{G({taskId:ne,completed:!1,xpReward:xe,forceUndo:!0})},[G]),wt=n.useCallback(async(ne,xe)=>{await Z({taskId:ne,updates:xe}),Te(null)},[Z]),Js=n.useCallback(async(ne,xe)=>{xe&&P(ne,"deleted"),await he(ne),X.success("Quest deleted"),Te(null)},[he,P]),vr=n.useCallback(async ne=>{if(j?.id){try{const{error:xe}=await N.from("habits").delete().eq("id",ne).eq("user_id",j.id);if(xe)throw xe;const{error:Tt}=await N.from("daily_tasks").delete().eq("habit_source_id",ne).eq("user_id",j.id).eq("completed",!1);Tt&&console.error("Error deleting linked tasks:",Tt),w.invalidateQueries({queryKey:["habits"]}),w.invalidateQueries({queryKey:["daily-tasks"]}),w.invalidateQueries({queryKey:["epics"]}),X.success("Ritual deleted")}catch(xe){console.error("Error deleting ritual:",xe),X.error("Failed to delete ritual")}F(null)}},[j?.id,w]),rs=n.useCallback(ne=>{a(ne)},[]),wr=n.useCallback(async ne=>{const xe=J.find(dt=>dt.id===ne);if(!xe)return;const Tt={task_text:xe.task_text,task_date:xe.task_date,xp_reward:xe.xp_reward,difficulty:xe.difficulty,scheduled_time:xe.scheduled_time,estimated_duration:xe.estimated_duration,is_main_quest:xe.is_main_quest,epic_id:xe.epic_id,sort_order:xe.sort_order,priority:xe.priority,energy_level:xe.energy_level,category:xe.category,habit_source_id:xe.habit_source_id,is_recurring:xe.is_recurring,recurrence_pattern:xe.recurrence_pattern,recurrence_days:xe.recurrence_days,reminder_enabled:xe.reminder_enabled,reminder_minutes_before:xe.reminder_minutes_before};try{await Ct.impact({style:it.Medium})}catch{}await he(ne),X("Quest deleted",{duration:4e3,action:{label:"Undo",onClick:async()=>{try{await ve(Tt),X.success("Quest restored")}catch{X.error("Failed to restore quest")}}}})},[J,he,ve]),jr=n.useCallback(async ne=>{const Tt=J.find(Ea=>Ea.id===ne)?.task_date;try{await Ct.impact({style:it.Light})}catch{}const dt=os(s,1),Et=Y(dt,"yyyy-MM-dd");we({taskId:ne,targetDate:Et}),X(`Moved to ${Y(dt,"EEEE, MMM d")}`,{duration:4e3,action:{label:"Undo",onClick:()=>{Tt&&(we({taskId:ne,targetDate:Tt}),X.success("Move undone"))}}})},[J,s,we]),_r=n.useCallback(async ne=>{try{await L(ne),f(!1),v({title:ne.title,habits:ne.habits.map(xe=>({title:xe.title}))}),g(!0)}catch(xe){console.error("Failed to create campaign:",xe)}},[L]),Nr=n.useCallback(()=>{g(!1),v(null)},[]);return e.jsxs(Sa,{mode:"instant",children:[e.jsx(Ta,{}),e.jsxs("div",{className:"min-h-screen pb-nav-safe pt-safe px-4 relative z-10",children:[e.jsxs(_.div,{initial:t?!1:{opacity:0,y:-14},animate:{opacity:1,y:0},transition:{duration:t?0:.22},className:"mb-6 text-center relative",children:[e.jsx("div",{className:"absolute right-0 top-0",children:e.jsx(jy,{onClick:()=>i(!0)})}),e.jsx("h1",{className:"text-3xl font-semibold tracking-tight mb-2 bg-gradient-to-r from-primary to-accent bg-clip-text text-transparent",children:"Quests"}),e.jsx("p",{className:"text-sm text-muted-foreground/90",children:"Daily quests. Your path to progress."})]}),e.jsxs(kb,{children:[e.jsx(_.div,{initial:t?!1:{opacity:0,scale:.98},animate:{opacity:1,scale:1},transition:{delay:t?0:.04,duration:t?0:.2},className:"mb-4",children:e.jsx(wy,{selectedDate:s,onDateSelect:rs,tasksPerDay:We})}),e.jsx(_.div,{initial:t?!1:{opacity:0,y:8},animate:{opacity:1,y:0},transition:{delay:t?0:.1,duration:t?0:.2},children:e.jsx(by,{tasks:J,selectedDate:s,onToggle:rt,onAddQuest:()=>{u(null),c(!0)},completedCount:je,totalCount:ke,currentStreak:te,onUndoToggle:Kt,onEditQuest:Ee,calendarTasks:de,calendarMilestones:[],onDateSelect:a,activeEpics:I,onDeleteQuest:wr,onMoveQuestToNextDay:jr,onUpdateScheduledTime:(ne,xe)=>{Z({taskId:ne,updates:{scheduled_time:xe}})},onTimeSlotLongPress:(ne,xe)=>{a(ne),u(xe),c(!0)}})})]}),e.jsx(ud,{open:o,onOpenChange:c,selectedDate:s,onAdd:at,isAdding:Ae,prefilledTime:l,onCreateCampaign:()=>f(!0)}),e.jsx(pd,{task:ge,open:!!ge&&!ge.habit_source_id,onOpenChange:ne=>!ne&&Te(null),onSave:wt,isSaving:Re,onDelete:Js,isDeleting:Ge}),e.jsx($y,{ritual:Le,open:!!Le,onOpenChange:ne=>!ne&&F(null),onDelete:vr}),e.jsx(_y,{open:r,onClose:()=>i(!1),title:"About Quests",icon:Io,description:"Quests unite your daily tasks and recurring rituals into one powerful view.",features:["Complete daily quests to earn XP","Rituals repeat automatically to build habits","Track your streak and maintain momentum"],tip:"Add quests by tapping the + button in the corner!"}),e.jsx(Ny,{open:b,onClose:x}),e.jsx(ky,{open:M,currentStreak:C,freezesAvailable:R,onUseFreeze:T,onResetStreak:q,isResolving:k}),e.jsx(Eb,{open:z,onOpenChange:$,contactName:V?.contact?.name??"",contactAvatarUrl:V?.contact?.avatar_url,taskTitle:V?.taskText??"",onLog:async(ne,xe)=>{await Q(ne,xe)},onSkip:U}),J.some(ne=>ne.ai_generated)&&e.jsx(_.button,{initial:t?!1:{scale:.9,opacity:0},animate:{scale:1},transition:{duration:t?0:.2},className:"fixed bottom-24 right-4 z-40 p-3 rounded-full bg-card/92 backdrop-blur-xl border border-border/60 shadow-[0_10px_24px_rgba(0,0,0,0.28)] active:scale-95 transition-transform",onClick:()=>p(!0),"aria-label":"Open quick adjust",children:e.jsx(us,{className:"h-5 w-5 text-primary"})}),e.jsx(tb,{open:m,onOpenChange:p,tasks:J,selectedDate:s,onComplete:()=>{w.invalidateQueries({queryKey:["daily-tasks"]}),p(!1)}}),e.jsx(vb,{open:h,onOpenChange:f,onCreateEpic:_r,isCreating:H,showTemplatesFirst:!1}),e.jsx(_b,{isVisible:d,campaignTitle:y?.title||"",habits:y?.habits||[],onComplete:Nr}),e.jsx(Jc,{onTap:()=>{u(null),c(!0)}})]}),e.jsx(Ca,{})]})},Qd=["/mentor","/inbox","/journeys","/companion"],Db={"/mentor":ax,"/inbox":P0,"/journeys":Mb,"/companion":l0},Kd=t=>Qd.includes(t),Pb={"/mentor":0,"/inbox":0,"/journeys":0,"/companion":0},Gd=n.memo(({activePath:t})=>{const[s,a]=n.useState([t]),r=n.useRef(t),i=n.useRef(new Set([t])),o=n.useRef(Pb);return n.useEffect(()=>{a(c=>c.includes(t)?c:[...c,t])},[t]),n.useLayoutEffect(()=>{const c=r.current;c!==t&&(o.current[c]=window.scrollY);const u=i.current.has(t)?o.current[t]??0:0,m=window.requestAnimationFrame(()=>{window.scrollTo({top:u,left:0,behavior:"auto"})});return i.current.add(t),r.current=t,()=>window.cancelAnimationFrame(m)},[t]),e.jsx("div",{className:"relative",children:Qd.map(c=>{if(!s.includes(c))return null;const l=Db[c],u=c===t;return e.jsx("section",{style:{display:u?"block":"none"},"aria-hidden":!u,children:e.jsx(l,{})},c)})})});Gd.displayName="MainTabsKeepAlive";const Ab=n.lazy(()=>me(()=>import("./Home-BNlMfIQl.js"),__vite__mapDeps([15,1,2,3]))),Rb=n.lazy(()=>me(()=>import("./Auth-BkkEql_A.js"),__vite__mapDeps([16,1,2,3,17,18,19,20]))),Ib=n.lazy(()=>me(()=>import("./ResetPassword-1N_7ewFG.js"),__vite__mapDeps([21,1,2,3,17]))),qb=n.lazy(()=>me(()=>import("./Onboarding-CA5tMveF.js"),__vite__mapDeps([22,1,2,3,17,23,24]))),Lb=n.lazy(()=>me(()=>import("./Welcome-DVxYsJjb.js"),__vite__mapDeps([25,1,2,3,18,20]))),Fb=n.lazy(()=>me(()=>import("./Preview-Ct3qOW5S.js"),__vite__mapDeps([26,1,2,3,18]))),Ob=n.lazy(()=>me(()=>import("./Profile-B3PmfHVv.js"),__vite__mapDeps([27,1,2,3,28,23]))),$b=n.lazy(()=>me(()=>import("./Premium-CLpuReoF.js"),__vite__mapDeps([29,1,2,3,28]))),Bb=n.lazy(()=>me(()=>import("./PepTalkDetail-Vb98Qm1l.js"),__vite__mapDeps([30,1,2,3]))),Hb=n.lazy(()=>me(()=>import("./Admin-B3gKfO7-.js"),__vite__mapDeps([31,1,2,3]))),zb=n.lazy(()=>me(()=>import("./MentorSelection-A8n2nTYQ.js"),__vite__mapDeps([32,1,2,3,24]))),Ub=n.lazy(()=>me(()=>import("./NotFound-nKscVqfZ.js"),__vite__mapDeps([33,1,2,3]))),Wb=n.lazy(()=>me(()=>import("./Reflection-CYhyADiF.js"),__vite__mapDeps([34,1,2,3]))),Qb=n.lazy(()=>me(()=>import("./MentorChat-ClApHp8m.js"),__vite__mapDeps([35,1,2,3]))),Kb=n.lazy(()=>me(()=>import("./Library-84deM8vK.js"),__vite__mapDeps([36,1,2,3,37,19,38]))),Gb=n.lazy(()=>me(()=>import("./Challenges-BClUL62t.js"),__vite__mapDeps([39,1,2,3]))),Yb=n.lazy(()=>me(()=>import("./Search-vTBUcsaF.js"),__vite__mapDeps([40,1,2,3,38,37,19]))),Vb=n.lazy(()=>me(()=>import("./PepTalks-DMSNuMzT.js"),__vite__mapDeps([41,1,2,3,37,19]))),Xb=n.lazy(()=>me(()=>import("./TermsOfService-nErCBvbC.js"),__vite__mapDeps([42,1,2,3]))),Jb=n.lazy(()=>me(()=>import("./PrivacyPolicy-DkQ26ws9.js"),__vite__mapDeps([43,1,2,3]))),Zb=n.lazy(()=>me(()=>import("./PremiumSuccess-57mU5DHH.js"),__vite__mapDeps([44,1,2,3]))),ev=n.lazy(()=>me(()=>import("./Epics-D7My4cDq.js"),__vite__mapDeps([45,1,2,3,46]))),tv=n.lazy(()=>me(()=>import("./SharedEpics-DCIlo2I7.js"),__vite__mapDeps([47,1,2,3]))),sv=n.lazy(()=>me(()=>import("./Partners-DFP6CCCj.js"),__vite__mapDeps([48,1,2,3]))),av=n.lazy(()=>me(()=>import("./JoinEpic-NPe_L50w.js"),__vite__mapDeps([49,1,2,3,46]))),rv=n.lazy(()=>me(()=>import("./Creator-BmFDzVrk.js"),__vite__mapDeps([50,1,2,3]))),nv=n.lazy(()=>me(()=>import("./InfluencerDashboard-BBBGagV7.js"),__vite__mapDeps([51,1,2,3]))),iv=n.lazy(()=>me(()=>import("./AccountDeletionHelp-CDTD3WCN.js"),__vite__mapDeps([52,1,2,3,28]))),ov=n.lazy(()=>me(()=>import("./Recaps-CLjXd4XY.js"),__vite__mapDeps([53,1,2,3])));n.lazy(()=>me(()=>import("./Community-B_Atx4Bk.js"),__vite__mapDeps([54,1,2,3])));const lv=n.lazy(()=>me(()=>import("./HelpCenter-BAomb4_W.js"),__vite__mapDeps([55,1,2,3]))),cv=n.lazy(()=>me(()=>import("./TestDayPlanner-CGblyc6y.js"),__vite__mapDeps([56,1,2,3]))),dv=n.lazy(()=>me(()=>import("./TestScroll-DfE7XiQI.js"),__vite__mapDeps([57,1,2,3]))),uv=n.lazy(()=>me(()=>import("./Contacts-D6nBx4RQ.js"),__vite__mapDeps([58,1,2,3]))),mv=n.lazy(()=>me(()=>import("./IAPTest-i-cZNf5g.js"),__vite__mapDeps([59,1,2,3]))),pv=new $m({defaultOptions:{queries:{staleTime:300*1e3,gcTime:600*1e3,refetchOnWindowFocus:!1,refetchOnReconnect:!0,retry:2,retryDelay:t=>Math.min(1e3*2**t,3e4)},mutations:{retry:1,retryDelay:1e3}}}),ro=()=>{[()=>me(()=>import("./Profile-B3PmfHVv.js"),__vite__mapDeps([27,1,2,3,28,23])),()=>me(()=>import("./MentorChat-ClApHp8m.js"),__vite__mapDeps([35,1,2,3]))].forEach(s=>s())};typeof window<"u"&&("requestIdleCallback"in window?window.requestIdleCallback(ro,{timeout:3e3}):setTimeout(ro,1500));const rn=n.memo(()=>e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-background",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"h-12 w-12 mx-auto rounded-full border-4 border-primary border-t-transparent animate-spin"}),e.jsx("p",{className:"text-muted-foreground",children:"Loading..."})]})}));rn.displayName="LoadingFallback";const Yd=n.memo(()=>{const{pathname:t}=cn();return n.useEffect(()=>{Kd(t)||window.scrollTo(0,0)},[t]),null});Yd.displayName="ScrollToTop";const Vd=n.memo(()=>e.jsxs(e.Fragment,{children:[e.jsx(kh,{}),e.jsx(xg,{})]}));Vd.displayName="EvolutionAwareContent";const Xd=n.memo(()=>{const{profile:t,loading:s}=yt(),{session:a}=ce(),[r,i]=n.useState(!1),[o,c]=n.useState(!1),l=cn(),u=Ht();if(yg(),bg(),n.useEffect(()=>{const h=window.location.hash;h.includes("type=recovery")&&!l.pathname.includes("/auth/reset-password")&&u(`/auth/reset-password${h}`,{replace:!0}),c(!0)},[l.pathname,u]),n.useEffect(()=>{if(l.pathname!=="/"||typeof window>"u"||!a?.user||s||t?.onboarding_completed!==!0)return;Kn.getItem("initialRouteRedirected")||(Kn.setItem("initialRouteRedirected","true"),u("/journeys",{replace:!0}))},[l.pathname,u,t?.onboarding_completed,s,a?.user]),n.useEffect(()=>{const h=f=>{const d=f.detail;typeof d=="string"&&u(d)};return window.addEventListener("native-push-navigation",h),()=>window.removeEventListener("native-push-navigation",h)},[u]),n.useEffect(()=>{const h=f=>{const{path:d}=f.detail;d&&u(d)};return window.addEventListener("deep-link-navigation",h),()=>window.removeEventListener("deep-link-navigation",h)},[u]),n.useEffect(()=>{if(a?.user)try{ur()&&Ph(a.user.id).catch(h=>{ee.error("Failed to initialize native push:",h)})}catch(h){ee.log("Native push initialization skipped:",h)}},[a]),n.useEffect(()=>{if(!s&&!r){const h=setTimeout(()=>{Vm(),i(!0)},100);return()=>clearTimeout(h)}},[s,r]),!o&&window.location.hash.includes("type=recovery"))return e.jsx(rn,{});const m=Us(t),p=Kd(l.pathname)?l.pathname:null;return e.jsx(fp,{mentorId:m,children:e.jsx(xp,{children:e.jsx(Fp,{children:e.jsx(ug,{children:e.jsx($l,{children:e.jsx(nc,{children:e.jsx(Eh,{children:e.jsx(ng,{children:e.jsxs(n.Suspense,{fallback:e.jsx(rn,{}),children:[e.jsx(Vd,{}),p?e.jsx(Ve,{children:e.jsx(Gd,{activePath:p})}):e.jsx(be,{mode:"sync",initial:!1,children:e.jsxs(Bm,{location:l,children:[e.jsx(Pe,{path:"/welcome",element:e.jsx(Lb,{})}),e.jsx(Pe,{path:"/preview",element:e.jsx(Fb,{})}),e.jsx(Pe,{path:"/auth",element:e.jsx(Rb,{})}),e.jsx(Pe,{path:"/auth/reset-password",element:e.jsx(Ib,{})}),e.jsx(Pe,{path:"/creator",element:e.jsx(rv,{})}),e.jsx(Pe,{path:"/creator/dashboard",element:e.jsx(nv,{})}),e.jsx(Pe,{path:"/onboarding",element:e.jsx(qb,{})}),e.jsx(Pe,{path:"/",element:e.jsx(Ve,{children:e.jsx(Ab,{})})}),e.jsx(Pe,{path:"/profile",element:e.jsx(Ve,{children:e.jsx(Ob,{})})}),e.jsx(Pe,{path:"/premium",element:e.jsx(Ve,{children:e.jsx($b,{})})}),e.jsx(Pe,{path:"/premium/success",element:e.jsx(Ve,{children:e.jsx(Zb,{})})}),e.jsx(Pe,{path:"/pep-talk/:id",element:e.jsx(Ve,{children:e.jsx(Bb,{})})}),e.jsx(Pe,{path:"/mentor-selection",element:e.jsx(Ve,{children:e.jsx(zb,{})})}),e.jsx(Pe,{path:"/admin",element:e.jsx(Ve,{requireMentor:!1,children:e.jsx(Hb,{})})}),e.jsx(Pe,{path:"/tasks",element:e.jsx(Ts,{to:"/journeys",replace:!0})}),e.jsx(Pe,{path:"/epics",element:e.jsx(Ve,{children:e.jsx(ev,{})})}),e.jsx(Pe,{path:"/join/:code",element:e.jsx(av,{})}),e.jsx(Pe,{path:"/shared-epics",element:e.jsx(Ve,{children:e.jsx(tv,{})})}),e.jsx(Pe,{path:"/mentor-chat",element:e.jsx(Ve,{children:e.jsx(Qb,{})})}),e.jsx(Pe,{path:"/horoscope",element:e.jsx(Ts,{to:"/journeys",replace:!0})}),e.jsx(Pe,{path:"/cosmic/:placement/:sign",element:e.jsx(Ts,{to:"/journeys",replace:!0})}),e.jsx(Pe,{path:"/challenges",element:e.jsx(Ve,{children:e.jsx(Gb,{})})}),e.jsx(Pe,{path:"/reflection",element:e.jsx(Ve,{children:e.jsx(Wb,{})})}),e.jsx(Pe,{path:"/library",element:e.jsx(Ve,{children:e.jsx(Kb,{})})}),e.jsx(Pe,{path:"/pep-talks",element:e.jsx(Ve,{children:e.jsx(Vb,{})})}),e.jsx(Pe,{path:"/inspire",element:e.jsx(Ts,{to:"/pep-talks",replace:!0})}),e.jsx(Pe,{path:"/search",element:e.jsx(Ve,{children:e.jsx(Yb,{})})}),e.jsx(Pe,{path:"/partners",element:e.jsx(sv,{})}),e.jsx(Pe,{path:"/account-deletion",element:e.jsx(iv,{})}),e.jsx(Pe,{path:"/recaps",element:e.jsx(Ve,{children:e.jsx(ov,{})})}),e.jsx(Pe,{path:"/help",element:e.jsx(Ve,{children:e.jsx(lv,{})})}),e.jsx(Pe,{path:"/campaigns",element:e.jsx(Ts,{to:"/journeys",replace:!0})}),e.jsx(Pe,{path:"/contacts",element:e.jsx(Ve,{children:e.jsx(uv,{})})}),e.jsx(Pe,{path:"/iap-test",element:e.jsx(mv,{})}),e.jsx(Pe,{path:"/guilds",element:e.jsx(Ts,{to:"/campaigns",replace:!0})}),e.jsx(Pe,{path:"/terms",element:e.jsx(Xb,{})}),e.jsx(Pe,{path:"/privacy",element:e.jsx(Jb,{})}),e.jsx(Pe,{path:"/test-scroll",element:e.jsx(dv,{})}),e.jsx(Pe,{path:"/test-day-planner",element:e.jsx(cv,{})}),e.jsx(Pe,{path:"*",element:e.jsx(Ub,{})})]},l.pathname)}),e.jsx(wg,{})]})})})})})})})})})});Xd.displayName="AppContent";const hv=()=>(n.useEffect(()=>{Dh()},[]),e.jsx(jt,{children:e.jsx(Hm,{client:pv,children:e.jsx(jp,{children:e.jsx(Op,{children:e.jsx($p,{children:e.jsxs(Sl,{children:[e.jsx(cp,{}),e.jsx(dp,{}),e.jsx(Mh,{}),e.jsx(zm,{future:{v7_startTransition:!0,v7_relativeSplatPath:!0},children:e.jsxs(Vp,{children:[e.jsx(Yd,{}),e.jsx(Xd,{})]})})]})})})})})}));window.addEventListener("error",t=>{ee.error("Unhandled error:",t.error)});window.addEventListener("unhandledrejection",t=>{ee.error("Unhandled promise rejection:",t.reason)});"serviceWorker"in navigator&&!window.Capacitor?.isNativePlatform?.()&&window.addEventListener("load",()=>{navigator.serviceWorker.register("/sw.js",{scope:"/"}).catch(()=>{})});const fv=()=>(n.useEffect(()=>{Ym()},[]),e.jsx(hv,{}));document.getElementById("debug-indicator")?.remove();Um.createRoot(document.getElementById("root")).render(e.jsx(fv,{}));export{St as $,xr as A,B,Bs as C,Cv as D,rx as E,Ne as F,E as G,rh as H,sx as I,nh as J,ih as K,Fe as L,ca as M,_a as N,jv as O,ts as P,Ws as Q,Qs as R,Ta as S,Gs as T,Ys as U,Ks as V,Vs as W,ws as X,ct as Y,ot as Z,as as _,He as a,G0 as a$,sh as a0,mh as a1,ns as a2,oh as a3,sn as a4,qe as a5,yc as a6,kt as a7,Ca as a8,jy as a9,_n as aA,ks as aB,Cs as aC,Ss as aD,Cy as aE,f0 as aF,$y as aG,qp as aH,cx as aI,tn as aJ,Nc as aK,Tc as aL,oy as aM,br as aN,Ec as aO,iy as aP,Gr as aQ,hf as aR,_s as aS,Wt as aT,Qt as aU,qt as aV,ab as aW,eb as aX,vb as aY,dc as aZ,xg as a_,Sn as aa,gr as ab,Ot as ac,$t as ad,_y as ae,hr as af,vv as ag,gs as ah,ea as ai,ls as aj,Sp as ak,ue as al,xt as am,pg as an,Ux as ao,Ax as ap,Ig as aq,Tn as ar,kn as as,Vg as at,c0 as au,Sc as av,Ky as aw,fd as ax,Na as ay,Ns as az,ce as b,Lp as b0,Tv as b1,Qy as b2,Wy as b3,ud as b4,pd as b5,$e as b6,qs as b7,Ls as b8,Fs as b9,Ap as bA,wv as bB,mr as bC,Sl as ba,Tl as bb,El as bc,yn as bd,A0 as be,gt as bf,L0 as bg,F0 as bh,xd as bi,ra as bj,Xs as bk,Cb as bl,Pn as bm,yr as bn,od as bo,cd as bp,b0 as bq,lh as br,Sv as bs,og as bt,cg as bu,ig as bv,Xg as bw,Dh as bx,_v as by,vn as bz,st as c,Sa as d,Me as e,wn as f,Us as g,zl as h,Zp as i,Jp as j,yt as k,ee as l,ur as m,kv as n,En as o,ya as p,Os as q,ba as r,N as s,$s as t,Ut as u,ds as v,Ph as w,Nv as x,Dn as y,nd as z};
