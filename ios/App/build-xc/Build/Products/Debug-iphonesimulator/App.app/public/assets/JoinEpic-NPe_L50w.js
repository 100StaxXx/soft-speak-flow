import{dj as J,H as A,v as P,u as S,aB as Y,aA as y,j as e,am as u,aa as N,m as B,cp as w,aT as H,ad as Q,db as L}from"./vendor-CkzXtEGd.js";import{b as M,s as a,d as o,e as d,B as h,F as v}from"./index-B9iotTKE.js";import{g as R}from"./habitLimits-NNrGyrB4.js";import"./date-vendor-CuPqBTxb.js";import"./three-vendor-qI8GXUTd.js";const V=()=>{const{code:n}=J(),l=A(),{user:i}=M(),_=P(),{data:t,isLoading:E}=S({queryKey:["epic-preview",n],queryFn:async()=>{if(!n)throw new Error("No invite code provided");const{data:s,error:c}=await a.from("epics").select(`
          *,
          epic_habits(
            habit_id,
            habits(id, title, difficulty, frequency, custom_days)
          )
        `).eq("invite_code",n).eq("is_public",!0).maybeSingle();if(c)throw c;if(!s)throw new Error("Epic not found");const{count:b}=await a.from("epic_members").select("*",{count:"exact",head:!0}).eq("epic_id",s.id);return{...s,member_count:b||0}},enabled:!!n}),p=2,m=Y({mutationFn:async()=>{if(!i||!t)throw new Error("Not authenticated or epic not found");const{data:s}=await a.from("epics").select("id").eq("user_id",i.id).eq("status","active"),{data:c}=await a.from("epic_members").select("epic_id, epics!inner(user_id, status)").eq("user_id",i.id).neq("epics.user_id",i.id).eq("epics.status","active");if((s?.length||0)+(c?.length||0)>=p)throw new Error(`You can only have ${p} active epics at a time. Complete or abandon an epic to join a new one.`);const{data:k}=await a.from("epic_members").select("id").eq("epic_id",t.id).eq("user_id",i.id).maybeSingle();if(k)throw new Error("You're already part of this epic!");const{error:f}=await a.from("epic_members").insert({epic_id:t.id,user_id:i.id});if(f)throw f;if(t.epic_habits&&t.epic_habits.length>0){let x="beginner";t.target_days>=45?x="advanced":t.target_days>=21&&(x="intermediate");const C=R(x),F=t.epic_habits.slice(0,C),{data:T,error:j}=await a.from("habits").insert(F.map(r=>({user_id:i.id,title:r.habits.title,difficulty:r.habits.difficulty,frequency:r.habits.frequency||"daily",custom_days:r.habits.custom_days||null}))).select();if(j)throw j;const{error:g}=await a.from("epic_habits").insert(T.map(r=>({epic_id:t.id,habit_id:r.id})));if(g)throw g}return t},onSuccess:()=>{_.invalidateQueries({queryKey:["epics"]}),y.success("Epic Joined! ⚔️",{description:"You're now part of this legendary quest!"}),l("/epics")},onError:s=>{y.error(s.message||"Failed to join epic")}});if(!i)return e.jsx(o,{children:e.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:e.jsxs(d,{className:"max-w-md w-full p-8 text-center",children:[e.jsx(u,{className:"w-16 h-16 text-primary mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Join This Epic Quest"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"Sign in to join this shared epic and embark on the journey with the community!"}),e.jsx(h,{onClick:()=>l("/auth"),className:"w-full",children:"Sign In to Join"})]})})});if(E)return e.jsx(o,{children:e.jsx("div",{className:"min-h-screen flex items-center justify-center",children:e.jsx(N,{className:"w-8 h-8 animate-spin text-primary"})})});if(!t)return e.jsx(o,{children:e.jsx("div",{className:"min-h-screen flex items-center justify-center px-4",children:e.jsxs(d,{className:"max-w-md w-full p-8 text-center",children:[e.jsx(u,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4 opacity-50"}),e.jsx("h2",{className:"text-2xl font-bold mb-2",children:"Epic Not Found"}),e.jsx("p",{className:"text-muted-foreground mb-6",children:"This invite code is invalid or the epic is no longer available."}),e.jsx(h,{onClick:()=>l("/epics"),variant:"outline",children:"View Your Epics"})]})})});const q=t?.member_count||0;return e.jsx(o,{children:e.jsx("div",{className:"min-h-screen pb-nav-safe pt-safe-lg px-4",children:e.jsxs(B.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},className:"max-w-2xl mx-auto",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsxs(v,{className:"mb-4 px-4 py-2 text-sm",children:[e.jsx(w,{className:"w-4 h-4 mr-2"}),"Community Epic"]}),e.jsx("h1",{className:"text-4xl font-bold mb-2 bg-gradient-to-r from-primary to-purple-500 bg-clip-text text-transparent",children:"Join the Quest"}),e.jsx("p",{className:"text-muted-foreground",children:"You've been invited to join a shared epic challenge"})]}),e.jsxs(d,{className:"p-8 bg-gradient-to-br from-background to-secondary/20 border-2 border-primary/20 mb-6",children:[e.jsxs("div",{className:"flex items-start justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("h2",{className:"text-3xl font-bold mb-2",children:t.title}),t.description&&e.jsx("p",{className:"text-muted-foreground",children:t.description})]}),e.jsx(u,{className:"w-8 h-8 text-primary flex-shrink-0"})]}),e.jsxs("div",{className:"grid grid-cols-3 gap-4 mb-6",children:[e.jsxs("div",{className:"bg-background/50 rounded-lg p-4 text-center",children:[e.jsx(H,{className:"w-5 h-5 text-primary mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold mb-1",children:t.target_days}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Days"})]}),e.jsxs("div",{className:"bg-background/50 rounded-lg p-4 text-center",children:[e.jsx(w,{className:"w-5 h-5 text-purple-500 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold mb-1",children:q}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"Members"})]}),e.jsxs("div",{className:"bg-background/50 rounded-lg p-4 text-center",children:[e.jsx(Q,{className:"w-5 h-5 text-yellow-500 mx-auto mb-2"}),e.jsx("div",{className:"text-2xl font-bold mb-1",children:t.xp_reward}),e.jsx("div",{className:"text-xs text-muted-foreground",children:"XP Reward"})]})]}),t.epic_habits&&t.epic_habits.length>0&&e.jsxs("div",{className:"mb-6",children:[e.jsxs("h3",{className:"text-sm font-semibold mb-3 text-muted-foreground",children:["Habits You'll Track (",t.epic_habits.length,")"]}),e.jsx("div",{className:"space-y-2",children:t.epic_habits.map(s=>e.jsxs("div",{className:"flex items-center justify-between bg-background/50 rounded-lg p-3",children:[e.jsx("span",{className:"font-medium",children:s.habits.title}),e.jsx(v,{variant:"outline",className:"text-xs",children:s.habits.difficulty})]},s.habit_id))})]}),e.jsx(h,{onClick:()=>m.mutate(),disabled:m.isPending,className:"w-full h-14 text-lg bg-gradient-to-r from-primary to-purple-600 hover:from-primary/90 hover:to-purple-600/90",children:m.isPending?e.jsxs(e.Fragment,{children:[e.jsx(N,{className:"w-5 h-5 mr-2 animate-spin"}),"Joining..."]}):e.jsxs(e.Fragment,{children:["Join This Epic",e.jsx(L,{className:"w-5 h-5 ml-2"})]})})]}),e.jsx(d,{className:"p-4 bg-primary/5 border-primary/20",children:e.jsx("p",{className:"text-sm text-muted-foreground text-center",children:"By joining, you'll track the same habits as other members and compete on the leaderboard!"})})]})})})};export{V as default};
