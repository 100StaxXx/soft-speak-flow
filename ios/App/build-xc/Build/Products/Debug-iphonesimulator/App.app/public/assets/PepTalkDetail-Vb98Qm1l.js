import{r as o,j as e,bc as q,aM as G,av as O,ac as D,cL as A,dj as W,H as K,cn as $,m as b,K as Q,cK as C,aA as P}from"./vendor-CkzXtEGd.js";import{a4 as N,ag as V,ah as R,ai as _,aj as j,B as S,a6 as J,ak as z,G as E,d as B,S as I,al as h,a8 as F,s as L}from"./index-B9iotTKE.js";import"./date-vendor-CuPqBTxb.js";import"./three-vendor-qI8GXUTd.js";function U(t){if(typeof navigator>"u"||!("mediaSession"in navigator))return;const{mediaSession:r}=navigator;if(t.title&&(r.metadata=new MediaMetadata({title:t.title})),t.onPlay&&r.setActionHandler("play",()=>{t.onPlay?.()}),t.onPause&&r.setActionHandler("pause",()=>{t.onPause?.()}),t.onSeekBackward&&r.setActionHandler("seekbackward",s=>{t.onSeekBackward?.()}),t.onSeekForward&&r.setActionHandler("seekforward",s=>{t.onSeekForward?.()}),t.onPreviousTrack&&r.setActionHandler("previoustrack",()=>{t.onPreviousTrack?.()}),t.onNextTrack&&r.setActionHandler("nexttrack",()=>{t.onNextTrack?.()}),"setPositionState"in r)try{r.setPositionState({duration:0,playbackRate:1,position:0})}catch(s){console.log("[Media Session] Position state not supported:",s)}}function k(t){if(typeof navigator>"u"||!("mediaSession"in navigator))return;const{mediaSession:r}=navigator;if(t.title||t.artist||t.album||t.artwork){const s={};t.title&&(s.title=t.title),t.artist&&(s.artist=t.artist),t.album&&(s.album=t.album),t.artwork&&(s.artwork=t.artwork),r.metadata=new MediaMetadata(s)}if(t.playbackState&&(r.playbackState=t.playbackState),"setPositionState"in r&&(t.position!==void 0||t.duration!==void 0))try{r.setPositionState&&r.setPositionState({duration:t.duration??0,playbackRate:1,position:t.position??0})}catch(s){console.log("[Media Session] Position state update failed:",s)}}function X(){if(typeof navigator>"u"||!("mediaSession"in navigator))return;const{mediaSession:t}=navigator;t.setActionHandler("play",null),t.setActionHandler("pause",null),t.setActionHandler("seekbackward",null),t.setActionHandler("seekforward",null),t.setActionHandler("previoustrack",null),t.setActionHandler("nexttrack",null),t.metadata=null,t.playbackState="none"}const Y=({audioUrl:t,title:r,onTimeUpdate:s})=>{const i=o.useRef(null),[m,u]=o.useState(!1),[g,c]=o.useState(0),[l,f]=o.useState(0),[v,w]=o.useState(N.getMuted());o.useEffect(()=>{const a=V(t);return i.current=a,R&&_.registerAudio(a),U({title:r,onPlay:()=>{a&&!N.getMuted()&&z(a).then(n=>{n&&u(!0)})},onPause:()=>{a&&(a.pause(),u(!1))},onSeekBackward:()=>x(-10),onSeekForward:()=>x(10)}),()=>{i.current&&(i.current.pause(),i.current.src="",R&&_.unregisterAudio(i.current)),X()}},[t,r]),o.useEffect(()=>N.subscribe(n=>{w(n);const y=i.current;y&&(y.muted=n,n&&m&&(y.pause(),u(!1)))}),[m]),o.useEffect(()=>{const a=i.current;if(!a)return;const n=()=>{const M=a.currentTime;c(M),s?.(M),k({position:M,duration:a.duration,playbackState:a.paused?"paused":"playing"})},y=()=>{f(a.duration),k({duration:a.duration})},H=()=>{u(!1),k({playbackState:"none"})};return a.addEventListener("timeupdate",n),a.addEventListener("loadedmetadata",y),a.addEventListener("ended",H),()=>{a.removeEventListener("timeupdate",n),a.removeEventListener("loadedmetadata",y),a.removeEventListener("ended",H)}},[t,s]);const p=async()=>{const a=i.current;a&&(m?(a.pause(),u(!1),k({playbackState:"paused"})):(N.getMuted()&&N.setMuted(!1),a.muted=!1,await z(a)&&(u(!0),k({playbackState:"playing"}))))},d=a=>{const n=i.current;n&&(n.currentTime=a[0],c(a[0]))},x=a=>{const n=i.current;n&&(n.currentTime=Math.max(0,Math.min(n.duration,n.currentTime+a)))},T=a=>{if(isNaN(a))return"0:00";const n=Math.floor(a/60),y=Math.floor(a%60);return`${n}:${y.toString().padStart(2,"0")}`};return e.jsx(j,{variant:"elevated",glow:"soft",className:"w-full p-6",children:e.jsxs("div",{className:"space-y-5",children:[e.jsxs("div",{className:"flex items-center justify-center gap-4",children:[e.jsx(S,{variant:"ghost",size:"icon",onClick:()=>x(-10),className:"rounded-full h-11 w-11 hover:bg-muted/50 transition-colors","aria-label":"Skip back 10 seconds",children:e.jsx(q,{className:"h-5 w-5"})}),e.jsx(S,{variant:"default",size:"icon",onClick:p,className:"h-16 w-16 rounded-full bg-gradient-to-br from-primary via-primary to-stardust-gold/70 hover:shadow-glow transition-all duration-300 hover:scale-105","aria-label":m?"Pause":"Play",children:m?e.jsx(G,{className:"h-7 w-7",fill:"currentColor"}):e.jsx(O,{className:"h-7 w-7 ml-1",fill:"currentColor"})}),e.jsx(S,{variant:"ghost",size:"icon",onClick:()=>x(10),className:"rounded-full h-11 w-11 hover:bg-muted/50 transition-colors","aria-label":"Skip forward 10 seconds",children:e.jsx(D,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx("div",{className:"relative",children:e.jsx(J,{value:[g],max:l||100,step:.1,onValueChange:d,className:"w-full [&_[role=slider]]:bg-gradient-to-r [&_[role=slider]]:from-primary [&_[role=slider]]:to-stardust-gold [&_[role=slider]]:border-0 [&_[role=slider]]:shadow-glow"})}),e.jsxs("div",{className:"flex justify-between text-xs text-muted-foreground font-medium",children:[e.jsx("span",{children:T(g)}),e.jsx("span",{children:T(l)})]})]})]})})},Z=({transcript:t,currentTime:r,className:s})=>{const[i,m]=o.useState(-1),u=o.useRef(null),g=o.useRef(null);return o.useEffect(()=>{const c=t.findIndex(l=>r>=l.start&&r<l.end);c!==i&&m(c)},[r,t,i]),o.useEffect(()=>{if(g.current&&u.current){const c=u.current,l=g.current,f=c.getBoundingClientRect(),v=l.getBoundingClientRect(),w=v.top-f.top,d=f.height*.3;if(w>d||v.bottom>f.bottom||v.top<f.top){const x=l.offsetTop-c.offsetTop-d;c.scrollTo({top:Math.max(0,x),behavior:"smooth"})}}},[i]),!t||t.length===0?e.jsxs(j,{variant:"default",glow:"soft",className:E("p-6",s),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-3",children:[e.jsx(A,{className:"h-4 w-4 text-muted-foreground"}),e.jsx("h3",{className:"font-heading text-sm font-semibold text-muted-foreground uppercase tracking-wide",children:"Transcript"})]}),e.jsx("p",{className:"text-muted-foreground text-center italic py-4",children:"No transcript available for this pep talk."})]}):e.jsxs(j,{variant:"default",glow:"soft",className:E("p-6",s),children:[e.jsxs("div",{className:"flex items-center gap-2 mb-4",children:[e.jsx(A,{className:"h-4 w-4 text-stardust-gold"}),e.jsx("h3",{className:"font-heading text-sm font-semibold text-muted-foreground uppercase tracking-wide",children:"Transcript"})]}),e.jsx("div",{ref:u,className:"max-h-[300px] overflow-y-auto scroll-smooth pr-2 scrollbar-thin scrollbar-thumb-muted scrollbar-track-transparent",children:e.jsx("div",{className:"text-base leading-relaxed",children:t.map((c,l)=>e.jsxs("span",{ref:l===i?g:null,className:E("transition-all duration-200 px-0.5 py-0.5 rounded",l===i?"bg-stardust-gold/30 text-foreground font-semibold shadow-[0_0_8px_rgba(255,215,0,0.3)]":l<i?"text-muted-foreground/70":"text-muted-foreground"),children:[c.word," "]},l))})})]})},re=()=>{const{id:t}=W(),r=K(),[s,i]=o.useState(null),[m,u]=o.useState(!0),[g,c]=o.useState(0),[l,f]=o.useState(!1),v=async p=>{try{const{data:d,error:x}=await L.from("pep_talks").select("*").eq("id",p).maybeSingle();if(x)throw x;const T=Array.isArray(d.transcript)?d.transcript:[],a={...d,transcript:T};i(a)}catch(d){console.error("Error fetching pep talk:",d),P.error("Failed to load pep talk"),r("/pep-talks")}finally{u(!1)}};o.useEffect(()=>{t&&v(t)},[t]);const w=async()=>{if(!(!s||!t)){f(!0),P.info("Transcribing audio... This may take a minute.");try{const{data:p,error:d}=await L.functions.invoke("transcribe-audio",{body:{audioUrl:s.audio_url,pepTalkId:t}});if(d)throw d;if(p?.transcript&&Array.isArray(p.transcript))P.success("Transcript generated successfully!"),await v(t);else throw new Error("No transcript data returned")}catch(p){console.error("Transcription error:",p),P.error("Failed to generate transcript")}finally{f(!1)}}};return m?e.jsxs(B,{children:[e.jsx(I,{}),e.jsxs("div",{className:"min-h-screen pb-nav-safe relative z-10",children:[e.jsx("div",{className:"sticky top-0 z-50 cosmiq-glass-header border-b border-cosmiq-glow/10",children:e.jsx("div",{className:"max-w-lg mx-auto px-4 py-3 pt-safe",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(h,{className:"h-9 w-9 rounded-full"}),e.jsx(h,{className:"h-5 w-24"})]})})}),e.jsxs("div",{className:"max-w-lg mx-auto px-4 py-6 space-y-6",children:[e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx(h,{className:"h-6 w-24 mx-auto rounded-full"}),e.jsx(h,{className:"h-10 w-3/4 mx-auto"})]}),e.jsx(j,{variant:"elevated",className:"p-6",children:e.jsx(h,{className:"h-24 w-full"})}),e.jsxs(j,{variant:"default",className:"p-6",children:[e.jsxs("div",{className:"flex justify-center gap-4 mb-4",children:[e.jsx(h,{className:"h-10 w-10 rounded-full"}),e.jsx(h,{className:"h-16 w-16 rounded-full"}),e.jsx(h,{className:"h-10 w-10 rounded-full"})]}),e.jsx(h,{className:"h-2 w-full rounded-full"})]})]}),e.jsx(F,{})]})]}):s?e.jsxs(B,{children:[e.jsx(I,{}),e.jsxs("div",{className:"min-h-screen pb-nav-safe relative z-10",children:[e.jsx("div",{className:"sticky top-0 z-50 cosmiq-glass-header border-b border-cosmiq-glow/10",children:e.jsx("div",{className:"max-w-lg mx-auto px-4 py-3 pt-safe",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(S,{variant:"ghost",size:"icon",onClick:()=>r("/pep-talks"),className:"rounded-full h-9 w-9 bg-muted/30 hover:bg-muted/50",children:e.jsx($,{className:"h-4 w-4"})}),e.jsx("span",{className:"text-sm font-medium text-muted-foreground truncate",children:s.category})]})})}),e.jsx("div",{className:"max-w-lg mx-auto px-4 py-6",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(b.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3},className:"text-center",children:e.jsxs("span",{className:"inline-flex items-center gap-1.5 px-4 py-1.5 rounded-full bg-gradient-to-r from-primary/20 to-stardust-gold/20 border border-cosmiq-glow/20 text-sm font-medium",children:[e.jsx(Q,{className:"h-3.5 w-3.5 text-stardust-gold"}),s.category]})}),e.jsx(b.h1,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{duration:.3,delay:.1},className:"font-heading text-3xl md:text-4xl font-bold text-center leading-tight",children:s.title}),e.jsx(b.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4,delay:.2},children:e.jsxs(j,{variant:"hero",glow:"accent",className:"p-6 relative overflow-hidden",children:[e.jsx("div",{className:"absolute -top-4 -left-4 w-24 h-24 bg-stardust-gold/20 rounded-full blur-2xl"}),e.jsx("div",{className:"absolute -bottom-4 -right-4 w-20 h-20 bg-primary/20 rounded-full blur-xl"}),e.jsxs("div",{className:"relative z-10",children:[e.jsx(C,{className:"h-8 w-8 text-stardust-gold mb-3 opacity-60"}),e.jsx("p",{className:"font-heading text-xl md:text-2xl italic leading-relaxed text-foreground/90",children:s.quote}),e.jsx("div",{className:"flex justify-end mt-3",children:e.jsx(C,{className:"h-8 w-8 text-stardust-gold opacity-60 rotate-180"})})]})]})}),e.jsx(b.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4,delay:.3},children:e.jsx(Y,{audioUrl:s.audio_url,title:s.title,onTimeUpdate:c})}),(!s.transcript||s.transcript.length===0)&&e.jsx(b.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4,delay:.4},children:e.jsx(j,{variant:"elevated",glow:"soft",className:"p-6",children:e.jsxs("div",{className:"text-center space-y-4",children:[e.jsx("div",{className:"h-14 w-14 mx-auto rounded-full bg-gradient-to-br from-primary/20 to-stardust-gold/20 flex items-center justify-center",children:e.jsx(A,{className:"h-7 w-7 text-muted-foreground"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold mb-2",children:"No Transcript Available"}),e.jsx("p",{className:"text-sm text-muted-foreground mb-4",children:"Generate a word-by-word transcript with timestamps"}),e.jsx(S,{onClick:w,disabled:l,className:"w-full bg-gradient-to-r from-primary to-primary/80 hover:shadow-glow transition-all",children:l?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin mr-2 h-4 w-4 border-2 border-current border-t-transparent rounded-full"}),"Transcribing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(A,{className:"mr-2 h-4 w-4"}),"Generate Transcript"]})})]})]})})}),s.transcript&&s.transcript.length>0&&e.jsx(b.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.4,delay:.4},children:e.jsx(Z,{transcript:s.transcript,currentTime:g})})]})}),e.jsx(F,{})]})]}):null};export{re as default};
