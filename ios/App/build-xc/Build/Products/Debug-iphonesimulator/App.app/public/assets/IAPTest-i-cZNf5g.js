import{H as te,r as i,o as B,j as e,cn as re,aq as ne,Q as ie,aa as k,e2 as ce,e3 as le,bk as X,X as _,de as oe,W as de,cV as me,c5 as xe}from"./vendor-CkzXtEGd.js";import{u as ue,a1 as he,B as c,e as o,H as m,J as x,f as d,a2 as H,L as M,a as pe,af as J,br as ge,s as U}from"./index-B9iotTKE.js";import"./date-vendor-CuPqBTxb.js";import"./three-vendor-qI8GXUTd.js";const N=i.memo(({value:u,label:S})=>{const p=typeof u=="boolean";return e.jsxs("div",{className:"flex items-center justify-between py-2 border-b border-border/30 last:border-0",children:[e.jsx("span",{className:"text-sm text-muted-foreground",children:S}),p?e.jsxs("span",{className:`flex items-center gap-1 text-sm font-medium ${u?"text-green-500":"text-red-500"}`,children:[u?e.jsx(X,{className:"h-4 w-4"}):e.jsx(_,{className:"h-4 w-4"}),u?"Yes":"No"]}):e.jsx("span",{className:"text-sm font-medium text-foreground",children:u})]})});N.displayName="StatusBadge";const ve=()=>{const u=te(),{toast:S}=ue(),[p,L]=i.useState([]),[w,K]=i.useState(""),[D,P]=i.useState(null),[A,O]=i.useState(!1),[g,C]=i.useState(null),[h,b]=i.useState(null),z=i.useRef(null),{products:f,productsLoading:v,productError:T,handlePurchase:Q,handleRestore:q,handleManageSubscriptions:W,loading:F,hasLoadedProducts:E,reloadProducts:I}=he(),Y=i.useCallback(async()=>{t("[FETCH] Fetching products from App Store...","info");try{const s=await I();t(`[FETCH] Returned ${s.length} products`,s.length?"success":"info"),s.forEach((a,r)=>{t(`[FETCH] Product ${r}: id="${a.identifier}" title="${a.title}" price="${a.priceString}"`,"info")})}catch(s){t(`[FETCH] Failed: ${s instanceof Error?s.message:String(s)}`,"error")}},[I]),G=async s=>{C(s);const a=new Date().toLocaleTimeString("en-US",{hour12:!1});t(`[DIRECT] Attempting direct purchase (bypassing hook): ${s}`,"info");try{const r=await ge(s);t(`[DIRECT] Result: ${JSON.stringify(r)}`,"success"),b({productId:s,success:!0,message:`Direct purchase result: ${JSON.stringify(r)}`,timestamp:a})}catch(r){const n=r instanceof Error?r.message:String(r);t(`[DIRECT] Error: ${n}`,"error"),b({productId:s,success:!1,message:n,timestamp:a})}finally{C(null)}},$=B.getPlatform(),y=B.isNativePlatform(),R=$==="ios",t=(s,a="info")=>{const r=new Date().toLocaleTimeString("en-US",{hour12:!1,hour:"2-digit",minute:"2-digit",second:"2-digit"});L(n=>[...n.slice(-100),{timestamp:r,message:s,type:a}])};i.useEffect(()=>{const s=console.log,a=console.error,r=n=>["[IAP","[HOOK","[Apple","NativePurchases","product","purchase","subscription","receipt","transaction"].some(l=>n.toLowerCase().includes(l.toLowerCase()));return console.log=(...n)=>{s(...n);const j=n.map(l=>typeof l=="object"?JSON.stringify(l,null,2):String(l)).join(" ");r(j)&&t(j,"info")},console.error=(...n)=>{a(...n);const j=n.map(l=>typeof l=="object"?JSON.stringify(l,null,2):String(l)).join(" ");r(j)&&t(j,"error")},t("IAP Test Page initialized","info"),t(`Platform: ${$}, Native: ${y}, iOS: ${R}`,"info"),()=>{console.log=s,console.error=a}},[$,y,R]),i.useEffect(()=>{z.current?.scrollIntoView({behavior:"smooth"})},[p]);const V=async s=>{C(s);const a=new Date().toLocaleTimeString("en-US",{hour12:!1});t(`[TEST] Starting purchase for: ${s}`,"info"),t(`[TEST] Current products count: ${f.length}`,"info"),t(`[TEST] hasLoadedProducts: ${E}`,"info");try{t("[TEST] Calling handlePurchase...","info");const r=await Q(s);t(`[TEST] handlePurchase returned: ${r}`,r?"success":"error"),r?(t(`âœ… Purchase SUCCESS for: ${s}`,"success"),b({productId:s,success:!0,message:"Purchase completed successfully",timestamp:a})):(t(`âŒ Purchase BLOCKED for: ${s} - check toast messages`,"error"),b({productId:s,success:!1,message:"Purchase blocked or failed",timestamp:a}))}catch(r){const n=r instanceof Error?r.message:String(r);t(`âŒ Purchase EXCEPTION: ${n}`,"error"),b({productId:s,success:!1,message:n,timestamp:a})}finally{C(null)}},Z=async()=>{t("Starting restore purchases...","info");try{await q(),t("Restore completed","success")}catch(s){t(`Restore failed: ${s instanceof Error?s.message:String(s)}`,"error")}},ee=async()=>{if(!w.trim()){S({title:"Error",description:"Please enter a transaction ID",variant:"destructive"});return}O(!0),P(null),t(`Verifying transaction: ${w}`,"info");try{const{data:{session:s}}=await U.auth.getSession(),{data:a,error:r}=await U.functions.invoke("verify-apple-receipt",{body:{transactionId:w},headers:s?.access_token?{Authorization:`Bearer ${s.access_token}`}:void 0});r?(t(`Verification error: ${r.message}`,"error"),P({error:r.message})):(t("Verification successful","success"),P(a))}catch(s){const a=s instanceof Error?s.message:String(s);t(`Verification exception: ${a}`,"error"),P({error:a})}finally{O(!1)}},se=()=>{const s=p.map(a=>`[${a.timestamp}] ${a.message}`).join(`
`);navigator.clipboard.writeText(s),S({title:"Copied",description:"Logs copied to clipboard"})},ae=()=>{L([]),t("Logs cleared","info")};return e.jsxs("div",{className:"min-h-screen bg-background pb-8",children:[e.jsx("div",{className:"sticky top-0 z-40 bg-background/95 backdrop-blur border-b border-border",children:e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-3 flex items-center gap-3",children:[e.jsx(c,{variant:"ghost",size:"icon",onClick:()=>u(-1),children:e.jsx(re,{className:"h-5 w-5"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-bold",children:"ðŸ§ª IAP Test Page"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Development & Debug Tools"})]})]})}),e.jsxs("div",{className:"max-w-2xl mx-auto px-4 py-4 space-y-4",children:[e.jsxs(o,{children:[e.jsx(m,{className:"pb-2",children:e.jsxs(x,{className:"text-sm flex items-center gap-2",children:[e.jsx(ne,{className:"h-4 w-4"}),"Environment"]})}),e.jsxs(d,{className:"pt-0",children:[e.jsx(N,{label:"Platform",value:$}),e.jsx(N,{label:"Native",value:y}),e.jsx(N,{label:"iOS",value:R}),e.jsx(N,{label:"Products Loaded",value:E}),e.jsx(N,{label:"IAP Available",value:y&&R&&E})]})]}),e.jsxs(o,{children:[e.jsx(m,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(x,{className:"text-sm",children:"App Store Products"}),e.jsx("div",{className:"flex gap-1",children:e.jsx(c,{variant:"ghost",size:"sm",onClick:Y,disabled:v,title:"Fetch Products",children:e.jsx(ie,{className:`h-4 w-4 ${v?"animate-spin":""}`})})})]})}),e.jsxs(d,{className:"pt-0 space-y-2",children:[v&&e.jsx("div",{className:"text-sm text-muted-foreground py-4 text-center",children:"Loading products..."}),T&&e.jsx("div",{className:"text-sm text-red-500 py-2 px-3 bg-red-500/10 rounded-lg",children:T}),!v&&!T&&f.length===0&&e.jsxs("div",{className:"text-sm text-muted-foreground py-4 text-center",children:["No products available. ",!y&&"(Run on device to load)"]}),f.map(s=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/30 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s.title||s.identifier}),e.jsxs("p",{className:"text-xs text-muted-foreground",children:[s.priceString," â€¢ ",s.identifier]})]}),e.jsx(c,{size:"sm",onClick:()=>V(s.identifier),disabled:g===s.identifier,children:g===s.identifier?e.jsx(k,{className:"h-4 w-4 animate-spin"}):"Buy"})]},s.identifier))]})]}),e.jsxs(o,{children:[e.jsxs(m,{className:"pb-2",children:[e.jsxs(x,{className:"text-sm flex items-center gap-2",children:[e.jsx(ce,{className:"h-4 w-4"}),"Hardcoded Test Products"]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Use these when App Store products don't load"})]}),e.jsx(d,{className:"pt-0 space-y-2",children:Object.entries(H).map(([s,a])=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-muted/30 rounded-lg",children:[e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-sm",children:s}),e.jsx("p",{className:"text-xs text-muted-foreground font-mono",children:a})]}),e.jsx(c,{size:"sm",variant:"outline",onClick:()=>V(a),disabled:g===a,children:g===a?e.jsx(k,{className:"h-4 w-4 animate-spin"}):"Test Buy"})]},s))})]}),e.jsxs(o,{children:[e.jsx(m,{className:"pb-2",children:e.jsxs(x,{className:"text-sm flex items-center gap-2",children:[e.jsx(le,{className:"h-4 w-4"}),"Product State (Full Debug)"]})}),e.jsxs(d,{className:"pt-0 space-y-3",children:[e.jsx("pre",{className:"text-xs bg-muted/50 p-3 rounded-lg overflow-x-auto font-mono max-h-48 overflow-y-auto",children:JSON.stringify({hasLoadedProducts:E,productsLoading:v,productError:T,productCount:f.length,productIds:f.map(s=>s.identifier),fullProducts:f},null,2)}),e.jsxs("div",{className:"pt-2 border-t border-border/50",children:[e.jsx("p",{className:"text-xs text-muted-foreground mb-2",children:"Direct Purchase (bypasses validation):"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:Object.entries(H).map(([s,a])=>e.jsxs(c,{size:"sm",variant:"destructive",onClick:()=>G(a),disabled:g===a,className:"text-xs",children:[g===a?e.jsx(k,{className:"h-3 w-3 animate-spin mr-1"}):null,"Direct: ",s]},s))})]})]})]}),h&&e.jsxs(o,{className:h.success?"border-green-500/50 bg-green-500/5":"border-red-500/50 bg-red-500/5",children:[e.jsx(m,{className:"pb-2",children:e.jsxs(x,{className:"text-sm flex items-center gap-2",children:[h.success?e.jsx(X,{className:"h-4 w-4 text-green-500"}):e.jsx(_,{className:"h-4 w-4 text-red-500"}),"Last Purchase Result"]})}),e.jsx(d,{className:"pt-0",children:e.jsxs("div",{className:"text-sm space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Product:"})," ",e.jsx("span",{className:"font-mono text-xs",children:h.productId})]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Result:"})," ",h.success?"âœ… Success":"âŒ Failed"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Message:"})," ",h.message]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:h.timestamp})]})})]}),e.jsxs(o,{children:[e.jsx(m,{className:"pb-2",children:e.jsx(x,{className:"text-sm",children:"Manual Verification"})}),e.jsxs(d,{className:"pt-0 space-y-3",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(M,{htmlFor:"transactionId",className:"text-xs",children:"Transaction ID"}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(pe,{id:"transactionId",placeholder:"Enter transaction ID...",value:w,onChange:s=>K(s.target.value),className:"font-mono text-sm"}),e.jsx(c,{onClick:ee,disabled:A,size:"sm",children:A?e.jsx(k,{className:"h-4 w-4 animate-spin"}):"Verify"})]})]}),D&&e.jsxs("div",{className:"mt-3",children:[e.jsx(M,{className:"text-xs",children:"Result"}),e.jsx(J,{className:"h-32 mt-1",children:e.jsx("pre",{className:"text-xs bg-muted/50 p-3 rounded-lg overflow-x-auto font-mono",children:JSON.stringify(D,null,2)})})]})]})]}),e.jsxs(o,{children:[e.jsx(m,{className:"pb-2",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(x,{className:"text-sm",children:"Debug Console"}),e.jsxs("div",{className:"flex gap-1",children:[e.jsx(c,{variant:"ghost",size:"sm",onClick:se,children:e.jsx(oe,{className:"h-4 w-4"})}),e.jsx(c,{variant:"ghost",size:"sm",onClick:ae,children:e.jsx(de,{className:"h-4 w-4"})})]})]})}),e.jsx(d,{className:"pt-0",children:e.jsx(J,{className:"h-48 bg-muted/30 rounded-lg",children:e.jsxs("div",{className:"p-3 space-y-1 font-mono text-xs",children:[p.length===0?e.jsx("div",{className:"text-muted-foreground",children:"No logs yet..."}):p.map((s,a)=>e.jsxs("div",{className:`
                        ${s.type==="error"?"text-red-400":""}
                        ${s.type==="success"?"text-green-400":""}
                        ${s.type==="info"?"text-muted-foreground":""}
                      `,children:[e.jsxs("span",{className:"opacity-50",children:["[",s.timestamp,"]"]})," ",s.message]},a)),e.jsx("div",{ref:z})]})})})]}),e.jsxs(o,{children:[e.jsx(m,{className:"pb-2",children:e.jsx(x,{className:"text-sm",children:"Quick Actions"})}),e.jsx(d,{className:"pt-0",children:e.jsxs("div",{className:"grid grid-cols-2 gap-2",children:[e.jsxs(c,{variant:"outline",size:"sm",onClick:Z,disabled:F,className:"text-xs",children:[e.jsx(me,{className:`h-3 w-3 mr-1.5 ${F?"animate-spin":""}`}),"Restore Purchases"]}),e.jsxs(c,{variant:"outline",size:"sm",onClick:W,className:"text-xs",children:[e.jsx(xe,{className:"h-3 w-3 mr-1.5"}),"Manage Subs"]})]})})]}),e.jsx(o,{className:"border-dashed",children:e.jsx(d,{className:"py-4",children:e.jsxs("p",{className:"text-xs text-muted-foreground leading-relaxed",children:[e.jsx("strong",{children:"How to test:"}),' Build in Xcode â†’ Run on device/simulator â†’ Use Sandbox Apple ID for purchases â†’ Transactions appear in console above. Access this page by long-pressing "Command Center" on Profile.']})})})]})]})};export{ve as default};
