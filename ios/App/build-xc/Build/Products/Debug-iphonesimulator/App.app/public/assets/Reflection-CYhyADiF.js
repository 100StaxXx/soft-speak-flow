import{H as L,r as n,j as e,cn as y,af as v}from"./vendor-CkzXtEGd.js";import{b as R,u as A,ap as G,d as N,S as b,B as l,e as x,aq as w,a8 as S,am as T,s as u}from"./index-B9iotTKE.js";import"./date-vendor-CuPqBTxb.js";import"./three-vendor-qI8GXUTd.js";function q(){const{user:i}=R(),c=L(),{toast:h}=A(),{logActivity:k}=G(),[a,m]=n.useState(null),[d,f]=n.useState(""),[j,g]=n.useState(!1),[r,p]=n.useState(null),[_,C]=n.useState(!0),z=async()=>{if(i?.id)try{const t=new Date().toLocaleDateString("en-CA"),{data:s,error:o}=await u.from("user_reflections").select("*").eq("user_id",i.id).eq("reflection_date",t).maybeSingle();if(o&&o.code!=="PGRST116")throw o;s&&(p(s),m(s.mood),f(s.note||""))}catch(t){console.error("Error loading reflection:",t)}finally{C(!1)}};n.useEffect(()=>{i&&z()},[i?.id]);const E=async()=>{if(!(!a||!i)){g(!0);try{const t=new Date().toLocaleDateString("en-CA"),{data:s,error:o}=await u.from("user_reflections").upsert({user_id:i.id,reflection_date:t,mood:a,note:d||null},{onConflict:"user_id,reflection_date"}).select().maybeSingle();if(o)throw o;if(!s)throw new Error("Failed to save reflection");u.functions.invoke("generate-reflection-reply",{body:{reflectionId:s.id,mood:a,note:d}}),k({type:"reflection_completed",data:{mood:a,has_note:!!d}}),h({title:"Nice work",description:"You checked in for today."}),p(s)}catch(t){console.error("Error saving reflection:",t),h({title:"Error",description:t instanceof Error?t.message:"Unable to save reflection.",variant:"destructive"})}finally{g(!1)}}};return _?e.jsx("div",{className:"min-h-screen bg-background flex items-center justify-center",children:e.jsx("div",{className:"animate-pulse",children:"Loading..."})}):r&&r.mood?e.jsxs(N,{children:[e.jsx(b,{}),e.jsx("div",{className:"min-h-screen pb-nav-safe pt-safe relative z-10",children:e.jsxs("div",{className:"container max-w-2xl mx-auto p-4 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx(l,{variant:"ghost",size:"icon",onClick:()=>c("/"),children:e.jsx(y,{className:"h-5 w-5"})}),e.jsx("h1",{className:"text-2xl font-semibold tracking-tight flex-1 text-center",children:"Gratitude Journal"}),e.jsx(l,{variant:"outline",size:"sm",onClick:()=>c("/mood-history"),children:"View History"})]}),e.jsxs(x,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(v,{className:"w-8 h-8 text-primary"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold tracking-tight",children:"Gratitude Complete"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"You logged gratitude today"})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"What brought you joy?"}),e.jsx("div",{className:"p-4 rounded-xl bg-muted/50",children:e.jsx("p",{className:"text-lg font-medium capitalize",children:r.mood.replace("_"," ")})})]}),r.note&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Your note:"}),e.jsx("p",{className:"text-foreground p-4 bg-muted rounded-xl",children:r.note})]}),r.ai_reply&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Reflection:"}),e.jsx("p",{className:"text-foreground p-4 bg-primary/5 rounded-xl border border-primary/20",children:r.ai_reply})]})]})]}),e.jsx(x,{className:"p-6",children:e.jsx(w,{selected:a,onSelect:m})})]})}),e.jsx(S,{})]}):e.jsxs(N,{children:[e.jsx(b,{}),e.jsx("div",{className:"min-h-screen pb-nav-safe pt-safe relative z-10",children:e.jsxs("div",{className:"container max-w-2xl mx-auto p-4 space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between gap-4",children:[e.jsx(l,{variant:"ghost",size:"icon",onClick:()=>c("/"),children:e.jsx(y,{className:"h-5 w-5"})}),e.jsx("h1",{className:"text-2xl font-semibold tracking-tight flex-1 text-center",children:"Gratitude Journal"}),e.jsx(l,{variant:"outline",size:"sm",onClick:()=>c("/mood-history"),children:"View History"})]}),e.jsxs(x,{className:"p-6 space-y-6",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(v,{className:"w-8 h-8 text-primary"}),e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-semibold tracking-tight",children:"Daily Gratitude"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"What are you grateful for?"})]})]}),e.jsxs("div",{className:"space-y-6",children:[e.jsx(w,{selected:a,onSelect:m}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm text-muted-foreground mb-2",children:"Share your gratitude (Optional)"}),e.jsx(T,{value:d,onChange:t=>f(t.target.value),placeholder:"What are you grateful for today? What brought you joy?",className:"min-h-[120px] resize-none"})]}),e.jsx(l,{onClick:E,disabled:!a||j,className:"w-full",size:"lg",children:j?"Saving...":"Log Gratitude"})]})]})]})}),e.jsx(S,{})]})}export{q as default};
