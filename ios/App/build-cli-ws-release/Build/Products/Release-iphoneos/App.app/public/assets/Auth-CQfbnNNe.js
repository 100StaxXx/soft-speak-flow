import{r as l,H as ge,bZ as me,o as A,j as t,d9 as fe,da as R,db as we,dc as Ae}from"./vendor-FfY6MM0Z.js";import{s as ye}from"./nativeNavigation-DLS7qEr9.js";import{u as be,l as o,s as d,L as j,a as D,B as N}from"./index-sX_cJ3I4.js";import{e as ve,g as Se}from"./authRedirect-CIQu5qTp.js";import{g as q,a as xe}from"./redirectUrl-BW4uFyq_.js";import{S as ke,s as Ne}from"./StaticBackgroundImage-CU98gu1x.js";import"./date-vendor-Bk4KiHsJ.js";import"./three-vendor-qI8GXUTd.js";const te=5e3,ae="/onboarding",Ie=we({email:R().trim().toLowerCase().email("Invalid email address").min(3,"Email too short").max(255,"Email too long").regex(/^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/,"Invalid email format"),password:R().min(8,"Password must be at least 8 characters").max(100,"Password too long").regex(/^(?=.*[a-zA-Z])(?=.*[0-9]|.*[!@#$%^&*])/,"Password must contain letters and at least one number or special character"),confirmPassword:R().optional()}).refine(r=>r.confirmPassword!==void 0?r.password===r.confirmPassword:!0,{message:"Passwords do not match",path:["confirmPassword"]}),se=r=>r instanceof Error?r.message:typeof r=="string"?r:"Unknown error",Pe=r=>{const v=se(r),h=v.toLowerCase();return h.includes("apple_email_missing")?"Apple did not share an email for this account. Remove Cosmiq from Sign in with Apple settings, then try again.":h.includes("nonce")||h.includes("security check")?"Apple Sign-In security verification failed. Please try again.":h.includes("session")?"Apple Sign-In completed, but we couldn't start your session. Please try again.":h.includes("network")||h.includes("failed to fetch")||h.includes("timeout")?"Network issue while signing in with Apple. Check your connection and try again.":v||"Apple Sign-In failed. Please try again."},_e=()=>{const[r,v]=l.useState(!0),[h,I]=l.useState(!1),[P,E]=l.useState(""),[T,ie]=l.useState(""),[H,B]=l.useState(""),[S,O]=l.useState(!1),[G,Z]=l.useState(null),$=ge(),V=me(),{toast:c}=be(),ne=Ne,g=l.useCallback(async(a,e)=>{const s=Date.now();if(o.info(`[Auth ${e}] handlePostAuthNavigation START`,{hasSession:!!a,hasRedirected:f.current,userId:a?.user?.id?.substring(0,8)}),!a||f.current){o.info(`[Auth ${e}] Skipping - session: ${!!a}, hasRedirected: ${f.current}`);return}f.current=!0;let i=!1;const n=(u,y)=>i?(o.debug(`[Auth ${e}] Navigation already finalized, skipping ${y}`),!1):(i=!0,o.info(`[Auth ${e}] Finalizing navigation to ${u} via ${y} (total time: ${Date.now()-s}ms)`),ye($,u),setTimeout(()=>{window.location.pathname==="/auth"&&(o.warn(`[Auth ${e}] Navigation did not leave /auth, resetting redirect guard`),f.current=!1)},1500),!0),m=()=>{Promise.resolve((async()=>{const u=Date.now(),{data:y,error:w}=await d.from("profiles").select("onboarding_completed").eq("id",a.user.id).maybeSingle();if(w){o.warn(`[Auth ${e}] Timeout telemetry profile check failed`,{error:w.message});return}o.info(`[Auth ${e}] Timeout telemetry profile check completed`,{onboardingCompleted:y?.onboarding_completed,durationMs:Date.now()-u})})()).catch(u=>{o.warn(`[Auth ${e}] Timeout telemetry failed`,{error:u})})};let b=null;const x=new Promise(u=>{b=setTimeout(()=>{o.warn(`[Auth ${e}] TIMEOUT after ${te}ms - hard fallback`),c({title:"Taking longer than expected",description:"Redirecting you now..."}),n(ae,"deadline"),m(),u("deadline")},te)}),Y=(async()=>{try{o.info(`[Auth ${e}] Calling ensureProfile...`);const u=Date.now();await ve(a.user.id,a.user.email),o.info(`[Auth ${e}] ensureProfile completed in ${Date.now()-u}ms`),o.info(`[Auth ${e}] Calling getAuthRedirectPath...`);const y=Date.now(),w=await Se(a.user.id);o.info(`[Auth ${e}] getAuthRedirectPath returned "${w}" in ${Date.now()-y}ms`),n(w,"resolved-path")}catch(u){o.error(`[Auth ${e}] Navigation error after ${Date.now()-s}ms`,{error:u}),n(ae,"error")}return"core"})(),z=await Promise.race([Y,x]);b&&clearTimeout(b),z==="deadline"&&o.warn(`[Auth ${e}] Navigation deadline won race; continuing in background if needed`)},[$,c]),K=l.useRef(null),_=l.useRef(null),f=l.useRef(!1),J=l.useRef(!1),[Q,F]=l.useState(!1),[X,L]=l.useState(!1);l.useEffect(()=>{V.pathname==="/auth"&&f.current&&(f.current=!1)},[V.pathname]),l.useEffect(()=>{if(J.current)return;(async()=>{if(A.isNativePlatform()&&A.isPluginAvailable("SocialLogin"))try{const e="371878262982-tjcop6qvno6nsl68vurt44211g1835cp.apps.googleusercontent.com",s="371878262982-msdt2oq5rl858ft64d33onhrg5l67ofu.apps.googleusercontent.com";o.debug("[OAuth Init] Initializing with",{hasWebClientId:!!e,hasIOSClientId:!!s}),await fe.initialize({google:{webClientId:e,iOSClientId:s,mode:"online"}}),o.info("[OAuth Init] SocialLogin initialized successfully"),F(!0)}catch(e){o.error("[OAuth Init] Failed to initialize SocialLogin",{error:e}),F(!1)}else o.warn("[OAuth Init] SocialLogin plugin unavailable - using web OAuth fallback"),F(!1);J.current=!0})()},[]),l.useEffect(()=>{if(!A.isNativePlatform()){L(!1);return}if((A.getPlatform?.()??"web")!=="ios"){L(!1);return}const e=A.isPluginAvailable?.("SignInWithApple")??!1;e||o.warn("[OAuth Init] SignInWithApple plugin unavailable - falling back to web OAuth for Apple"),L(e)},[]),l.useEffect(()=>{(async()=>{if(typeof window>"u"||f.current)return;const e=new URL(window.location.href),s=e.hash.includes("access_token"),i=e.searchParams.get("code");if(!(!i&&!s))try{if(i){const{data:n,error:m}=await d.auth.exchangeCodeForSession(i);if(m)throw m;await g(n.session,"oauthCodeExchange")}else{const{data:{session:n}}=await d.auth.getSession();n&&await g(n,"oauthHashSession")}}catch(n){o.error("[OAuth Callback] Failed to complete OAuth login",{error:n}),c({title:"Error",description:"Something went wrong signing you in. Please try again.",variant:"destructive"})}finally{if(i){e.searchParams.delete("code");const n=`${e.pathname}${e.search}${e.hash}`;window.history.replaceState(window.history.state,"",n)}else s&&(window.location.hash="")}})()},[g,c]),l.useEffect(()=>{(async()=>{const{data:{session:s}}=await d.auth.getSession();s&&await g(s,"checkSession")})();const{data:{subscription:e}}=d.auth.onAuthStateChange(async(s,i)=>{if(["SIGNED_IN","TOKEN_REFRESHED","INITIAL_SESSION"].includes(s)&&i){if(f.current){o.debug(`[Auth onAuthStateChange] Skipping ${s} - already redirected`);return}const n=Date.now();o.info(`[Auth onAuthStateChange] Event: ${s} at ${n}, redirecting...`),await new Promise(m=>setTimeout(m,100)),await g(i,`onAuthStateChange:${s}`)}});return()=>{e.unsubscribe(),K.current&&clearTimeout(K.current),_.current&&clearTimeout(_.current)}},[g]);const oe=async a=>{a.preventDefault();const e=P.trim().toLowerCase(),s=Ie.safeParse({email:e,password:T,confirmPassword:r?void 0:H});if(!s.success){c({title:"Validation Error",description:s.error.errors[0].message,variant:"destructive"});return}O(!0);try{if(r){const{error:i}=await d.auth.signInWithPassword({email:e,password:T});if(i)throw i;const{data:{session:n}}=await d.auth.getSession();await g(n,"passwordSignIn")}else{const{data:i,error:n}=await d.auth.signUp({email:e,password:T,options:{emailRedirectTo:q("/"),data:{timezone:Intl.DateTimeFormat().resolvedOptions().timeZone||"UTC"}}});if(n)throw n.message.includes("already registered")?new Error("This email is already registered. Please sign in instead."):n;i?.session?await g(i.session,"signUpImmediate"):c({title:"Check your email",description:"We've sent you a confirmation link to complete your registration."})}}catch(i){c({title:"Error",description:i.message,variant:"destructive"})}finally{O(!1)}},re=async a=>{a.preventDefault();const e=P.trim().toLowerCase();if(!e){c({variant:"destructive",title:"Email Required",description:"Please enter your email address"});return}if(!R().email().safeParse(e).success){c({variant:"destructive",title:"Invalid Email",description:"Please enter a valid email address"});return}O(!0);try{const{error:i}=await d.auth.resetPasswordForEmail(e,{redirectTo:q("/auth/reset-password")});i?c({variant:"destructive",title:"Error",description:i.message}):(c({title:"Check your email",description:"We've sent you a password reset link"}),I(!1),E(""))}catch(i){c({variant:"destructive",title:"Error",description:i.message||"An unexpected error occurred"})}finally{O(!1)}},le=async a=>{Z(a),console.log(`[OAuth Debug] Starting ${a} sign-in flow`),console.log(`[OAuth Debug] Platform: ${A.isNativePlatform()?"Native":"Web"}`);try{const e=A.isNativePlatform(),s=A.getPlatform?.()??"web",i=a==="google"?e:e&&s==="ios";if(a==="apple"&&i&&X){const b=Date.now();console.log("[Apple OAuth] Initiating native Apple sign-in");const x=crypto.randomUUID();console.log("[Apple OAuth] Raw nonce generated:",x.substring(0,8)+"...");const z=new TextEncoder().encode(x),u=await crypto.subtle.digest("SHA-256",z),w=Array.from(new Uint8Array(u)).map(W=>W.toString(16).padStart(2,"0")).join("");console.log("[Apple OAuth] Hashed nonce:",w.substring(0,16)+"..."),console.log("[Apple OAuth] Calling SignInWithApple.authorize with clientId: com.darrylgraham.revolution");const ce=Date.now(),k=await Ae.authorize({clientId:"com.darrylgraham.revolution",redirectURI:"com.darrylgraham.revolution://",scopes:"email name",state:crypto.randomUUID(),nonce:w});if(console.log(`[Apple OAuth] authorize() completed in ${Date.now()-ce}ms`),console.log("[Apple OAuth] SignInWithApple result:",{hasIdentityToken:!!k.response.identityToken,hasEmail:!!k.response.email,hasUser:!!k.response.user}),!k.response.identityToken)throw console.error("[Apple OAuth] No identity token in response"),new Error("Apple Sign-In failed - no identity token returned");console.log("[Apple OAuth] Calling apple-native-auth edge function");const ue=Date.now(),{data:p,error:U}=await d.functions.invoke("apple-native-auth",{body:{identityToken:k.response.identityToken,rawNonce:x}});if(console.log(`[Apple OAuth] apple-native-auth completed in ${Date.now()-ue}ms`),console.log("[Apple OAuth] Edge function response:",{hasAccessToken:!!p?.access_token,hasRefreshToken:!!p?.refresh_token,error:U?.message,errorCode:p?.code}),U){if(p?.code==="APPLE_EMAIL_MISSING"){console.warn("[Apple OAuth] Missing email for Apple ID, prompting user to re-register"),c({title:"Finish setting up Apple Sign-In",description:"We couldn’t create an account with your Apple ID. Open Settings → Apple ID → Password & Security → Sign in with Apple, remove Revolution, then try again to share your email."}),v(!0),I(!1);return}throw p?.code==="APPLE_NONCE_MISSING"||p?.code==="APPLE_NONCE_MISMATCH"?new Error("Apple Sign-In security check failed. Please try again."):new Error(p?.error||U.message||"Apple Sign-In failed")}if(!p?.access_token||!p?.refresh_token)throw new Error("Failed to get session tokens from edge function");const de=Date.now(),{error:ee,data:{session:he}}=await d.auth.setSession({access_token:p.access_token,refresh_token:p.refresh_token});if(console.log(`[Apple OAuth] setSession completed in ${Date.now()-de}ms`),ee)throw ee;const{data:{session:pe}}=await d.auth.getSession(),C=he??pe;if(!C)throw new Error("Failed to establish Supabase session after Apple sign-in");const M=Date.now();console.log(`[Apple OAuth] Session set successfully at ${M}, proceeding to navigation`),console.log("[Apple OAuth] Triggering post-auth navigation"),g(C,"appleNative"),console.log(`[Apple OAuth] Total native flow completed in ${Date.now()-b}ms`),C.user&&(_.current=setTimeout(async()=>{try{if(window.location.pathname!=="/auth"){console.log(`[Apple OAuth Fallback] Already redirected, skipping (${Date.now()-M}ms since session set)`);return}console.log(`[Apple OAuth Fallback] Executing manual redirect at ${Date.now()} (${Date.now()-M}ms since session set)`),await g(C,"appleNativeFallback")}catch(W){console.error("[Apple OAuth Fallback] Error during redirect:",W),$("/onboarding")}},800));return}i&&((a==="google"?Q:X)||console.warn(`[${a} OAuth] Native plugin unavailable - falling back to web flow`)),console.log(`[${a} OAuth] Using web OAuth flow`),console.log(`[${a} OAuth] Redirect URL:`,xe());const{data:n,error:m}=await d.auth.signInWithOAuth({provider:a,options:{redirectTo:q("/")}});if(console.log(`[${a} OAuth] OAuth response:`,{hasUrl:!!n?.url,provider:n?.provider,error:m?.message}),m)throw m}catch(e){const s=se(e);if(console.error(`[${a} OAuth] Error caught:`,{message:s,code:e?.code,status:e?.status,fullError:e}),s.includes("1001")||s.toLowerCase().includes("cancel")){console.log(`[${a} OAuth] User cancelled sign-in`);return}{c({title:"Apple Sign-In Error",description:Pe(e),variant:"destructive"});return}}finally{Z(null)}};return t.jsxs("div",{className:"min-h-screen relative",children:[t.jsx(ke,{background:ne}),t.jsxs("section",{id:"auth-form",className:"min-h-screen relative flex items-center justify-center pt-safe-top pb-safe-bottom",children:[t.jsx("div",{className:"absolute inset-0 bg-gradient-to-b from-background/40 via-background/20 to-background/50"}),t.jsx("div",{className:"relative z-10 w-full px-6 md:max-w-md space-y-8",children:t.jsxs("div",{className:"space-y-6",children:[h?t.jsxs("form",{onSubmit:re,className:"space-y-5",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(j,{htmlFor:"email",className:"text-steel text-sm uppercase tracking-wide",children:"Email"}),t.jsx(D,{id:"email",type:"email",placeholder:"your@email.com",value:P,onChange:a=>E(a.target.value),required:!0,className:"bg-obsidian/50 border-royal-purple/30 text-pure-white h-12 focus:border-royal-purple"})]}),t.jsx(N,{type:"submit",className:"w-full bg-royal-purple hover:bg-accent-purple text-pure-white font-bold h-12 text-lg",disabled:S,children:S?"Sending...":"Send Reset Link"})]}):t.jsxs("form",{onSubmit:oe,className:"space-y-5",children:[t.jsxs("div",{className:"space-y-2",children:[t.jsx(j,{htmlFor:"email",className:"text-steel text-sm uppercase tracking-wide",children:"Email"}),t.jsx(D,{id:"email",type:"email",placeholder:"your@email.com",value:P,onChange:a=>E(a.target.value),required:!0,className:"bg-obsidian/50 border-royal-purple/30 text-pure-white h-12 focus:border-royal-purple"})]}),t.jsxs("div",{className:"space-y-2",children:[t.jsx(j,{htmlFor:"password",className:"text-steel text-sm uppercase tracking-wide",children:"Password"}),t.jsx(D,{id:"password",type:"password",placeholder:"••••••••",value:T,onChange:a=>ie(a.target.value),required:!0,className:"bg-obsidian/50 border-royal-purple/30 text-pure-white h-12 focus:border-royal-purple"}),r&&t.jsx("button",{type:"button",onClick:()=>I(!0),className:"text-xs text-pure-white/70 hover:text-pure-white transition-colors",children:"Forgot password?"})]}),!r&&t.jsxs("div",{className:"space-y-2",children:[t.jsx(j,{htmlFor:"confirmPassword",className:"text-steel text-sm uppercase tracking-wide",children:"Confirm Password"}),t.jsx(D,{id:"confirmPassword",type:"password",placeholder:"••••••••",value:H,onChange:a=>B(a.target.value),required:!0,className:"bg-obsidian/50 border-royal-purple/30 text-pure-white h-12 focus:border-royal-purple"})]}),t.jsx(N,{type:"submit",className:"w-full bg-royal-purple hover:bg-accent-purple text-pure-white font-bold h-12 text-lg",disabled:S,children:S?"Loading...":r?"Sign In":"Get Started"})]}),!h&&t.jsxs(t.Fragment,{children:[t.jsxs("div",{className:"relative my-6",children:[t.jsx("div",{className:"absolute inset-0 flex items-center",children:t.jsx("div",{className:"w-full border-t border-white/20"})}),t.jsx("div",{className:"relative flex justify-center text-sm",children:t.jsx("span",{className:"bg-card px-4 text-white/60",children:"or"})})]}),t.jsx(N,{type:"button",onClick:()=>le("apple"),disabled:S||G!==null,className:"w-full bg-white hover:bg-white/90 text-black font-semibold h-12 text-base flex items-center justify-center gap-3 rounded-xl",children:G==="apple"?t.jsx("div",{className:"animate-spin h-5 w-5 border-2 border-black/20 border-t-black rounded-full"}):t.jsxs(t.Fragment,{children:[t.jsx("svg",{className:"h-5 w-5",viewBox:"0 0 24 24",fill:"currentColor",children:t.jsx("path",{d:"M17.05 20.28c-.98.95-2.05.8-3.08.35-1.09-.46-2.09-.48-3.24 0-1.44.62-2.2.44-3.06-.35C2.79 15.25 3.51 7.59 9.05 7.31c1.35.07 2.29.74 3.08.8 1.18-.24 2.31-.93 3.57-.84 1.51.12 2.65.72 3.4 1.8-3.12 1.87-2.38 5.98.48 7.13-.57 1.5-1.31 2.99-2.54 4.09l.01-.01zM12.03 7.25c-.15-2.23 1.66-4.07 3.74-4.25.29 2.58-2.34 4.5-3.74 4.25z"})}),r?"Sign in with Apple":"Sign up with Apple"]})})]}),t.jsxs("div",{className:"text-center space-y-3",children:[t.jsx(N,{variant:"link",onClick:()=>{h?(I(!1),E("")):(v(!r),B(""))},className:"text-pure-white/90 hover:text-stardust-gold underline underline-offset-4",children:h?"Back to Sign In":r?"Need an account? Sign up":"Already have an account? Sign in"}),t.jsx("div",{className:"pt-2",children:t.jsx(N,{variant:"ghost",onClick:()=>$("/preview"),className:"text-muted-foreground hover:text-foreground text-sm",children:"Continue as Guest"})})]})]})})]})]})};export{_e as default};
