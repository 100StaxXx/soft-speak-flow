import{r as a,u as tt,j as e,aP as jt,n as be,m as _,ba as xe,b0 as ue,c5 as oe,b4 as je,aQ as De,aj as ae,cq as He,aa as Me,bY as ce,dL as st,K as U,ag as bt,ax as B,af as vt,k as ze,l as ve,bF as Nt,ab as pe,X as at,Q as wt,aT as Ie,aS as rt,bc as Oe,aw as he,dM as Ct,U as _t,b1 as it,aU as Xe,W as St,da as kt,aR as Tt,br as Et,c6 as At,bI as Rt,cn as Pt,c9 as Dt,cZ as Ht,av as It,ac as Ft,bp as Mt,cg as qt,bt as Lt,bm as Bt,az as zt,bl as Ot,cl as nt}from"./vendor-DK8VKJIv.js";import{c as Xt,aA as Yt,aB as Wt,aC as $t,aD as lt,aE as Qt,B as T,K as k,aF as ot,aG as ct,aH as dt,D as Ae,E as Re,F as Pe,a as de,aI as mt,aJ as ut,aK as Ut,aL as Kt,s as Q,$ as Ne,a0 as we,av as Fe,aM as Ye,J as G,aj as Jt,ar as qe,f as ge,aN as xt,aO as Gt,d as Vt,aP as Zt,aQ as es,aR as ts,aS as ss,aT as as,aU as rs,R as is,U as ns,V as ls,W as os,X as cs,Y as ds,Z as ms,_ as us,L as ee,q as xs,r as ps,v as hs,w as gs,x as fs,y as me,aV as ys,aW as js,a1 as Le,a2 as Be,aX as pt,aY as bs,aZ as vs,a_ as Ns,a$ as ws,ae as ht,af as gt,ag as le,g as Cs,aq as $,b0 as _s,e as We,S as $e,ad as Ss,ah as Qe,b1 as ks,ai as Ts}from"./index-BJ43zXLh.js";import{o as Es}from"./date-vendor-BRrA_NVo.js";import"./three-vendor-qI8GXUTd.js";const Ue=["M","T","W","T","F","S","S"],Ke=(t,l)=>t==="daily"||!l||l.length===0||l.length===7?{type:"text",value:"Daily"}:l.length===5&&[0,1,2,3,4].every(s=>l.includes(s))?{type:"text",value:"Weekdays"}:{type:"chips",value:l},As=t=>{const s=new Date().getDay(),u=s===0?6:s-1;return t.frequency==="daily"||!t.custom_days||t.custom_days.length===0?!0:t.custom_days.includes(u)},Rs=t=>{const l=["Mon","Tue","Wed","Thu","Fri","Sat","Sun"],s=new Date,u=s.getDay()===0?6:s.getDay()-1,n=t.find(i=>i>u)??t[0];return l[n]},Ps=a.memo(function({epicId:l,habits:s,isActive:u,onAdjustPlan:n,showAdjustPlan:i,renderTrigger:h}){const{user:o}=Xt(),g=tt(),[c,y]=a.useState(!1),[p,b]=a.useState(null),[f,m]=a.useState(null),[d,j]=a.useState(!1),[N,I]=a.useState(!1),[P,w]=a.useState(!1),[C,v]=a.useState(""),[W,M]=a.useState("medium"),[F,L]=a.useState([0,1,2,3,4,5,6]),[z,K]=a.useState(!1),[A,V]=a.useState(null),x=a.useRef(null),Z=Es(new Date,"yyyy-MM-dd"),{surfacedHabits:re,surfaceHabit:ie}=Yt(),{toggleTask:Ce}=Wt(Z),{triggerRitualComplete:_e}=$t(),Se=()=>X.filter(H=>te.get(H.id)?.is_completed).length===0,ke=()=>X.length===0?!1:X.filter(H=>te.get(H.id)?.is_completed).length===X.length-1,te=a.useMemo(()=>{const r=new Map;return re.forEach(H=>{r.set(H.habit_id,{task_id:H.task_id,is_completed:H.is_completed})}),r},[re]),fe=async r=>{try{await vt.impact({style:r})}catch{}},ne=async(r,H,Y)=>{if(Y||A)return;V(r),fe(bt.Medium),Kt();const E=Se(),D=ke();try{H?Ce({taskId:H,completed:!0,xpReward:25}):ie(r),_e(E,D).catch(O=>console.log("[LivingCompanion] Ritual reaction failed:",O))}finally{setTimeout(()=>V(null),300)}},ye=r=>{m({habitId:r.id,title:r.title,description:r.description,difficulty:r.difficulty,frequency:r.frequency,estimated_minutes:r.estimated_minutes,preferred_time:r.preferred_time,category:r.category,custom_days:r.custom_days})},S=async r=>{if(o?.id){I(!0);try{const{error:H}=await Q.from("habits").delete().eq("id",r).eq("user_id",o.id);if(H)throw H;const{error:Y}=await Q.from("daily_tasks").delete().eq("habit_source_id",r).eq("user_id",o.id).eq("completed",!1);Y&&console.error("Error deleting linked tasks:",Y),g.invalidateQueries({queryKey:["habits"]}),g.invalidateQueries({queryKey:["daily-tasks"]}),g.invalidateQueries({queryKey:["epics"]}),B.success("Ritual deleted")}catch(H){console.error("Error deleting ritual:",H),B.error("Failed to delete ritual")}finally{I(!1)}m(null)}},R=async()=>{if(!(!o?.id||!C.trim())){K(!0);try{const r=F.length===7?"daily":"custom",{data:H,error:Y}=await Q.from("habits").insert({user_id:o.id,title:C.trim(),difficulty:W,frequency:r,custom_days:F,is_active:!0}).select("id").single();if(Y)throw Y;H?.id&&await Q.from("epic_habits").insert({epic_id:l,habit_id:H.id}),g.invalidateQueries({queryKey:["habits"]}),g.invalidateQueries({queryKey:["epics"]}),g.invalidateQueries({queryKey:["daily-tasks"]}),B.success("Ritual added to campaign!"),v(""),M("medium"),L([0,1,2,3,4,5,6]),w(!1)}catch(r){console.error("Error adding ritual:",r),B.error("Failed to add ritual")}finally{K(!1)}}},{todayHabits:X,upcomingHabits:se}=a.useMemo(()=>{const r=[],H=[];return s.forEach(Y=>{As(Y)?r.push(Y):H.push(Y)}),{todayHabits:r,upcomingHabits:H}},[s]);return!u||s.length===0?null:e.jsxs(lt,{open:c,onOpenChange:y,shouldScaleBackground:!1,handleOnly:!0,children:[e.jsx(Qt,{asChild:!0,children:h?h(X.length):e.jsxs(T,{variant:"outline",className:k("w-full relative overflow-hidden group","bg-gradient-to-r from-primary/10 to-accent/10","border-primary/30 hover:border-primary/60","transition-all duration-300"),children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-to-r from-primary/20 via-accent/20 to-primary/20 opacity-0 group-hover:opacity-100 animate-pulse transition-opacity"}),e.jsx(jt,{className:"w-4 h-4 mr-2 text-primary"}),e.jsx("span",{className:"relative z-10 font-medium",children:"Rituals"}),e.jsxs("span",{className:"ml-2 px-2 py-0.5 text-xs bg-primary/20 text-primary rounded-full",children:[X.length," today"]}),e.jsx(be,{className:"w-4 h-4 ml-2 text-accent"})]})}),e.jsxs(ot,{className:"bg-background border-t border-primary/20",children:[e.jsxs("div",{className:"mx-auto w-full max-w-lg p-6",children:[e.jsx(ct,{className:"px-0 pb-4",children:e.jsxs(dt,{className:"flex items-center gap-2 text-xl",children:[e.jsx(be,{className:"w-5 h-5 text-stardust-gold fill-stardust-gold/30"}),"Today's Cosmiq Habits"]})}),e.jsxs("div",{className:"space-y-3 overflow-y-auto overscroll-contain max-h-[60vh] -mx-2 px-2","data-vaul-no-drag":!0,children:[X.map(r=>{const H=p===r.id,Y=r.description||r.frequency||r.estimated_minutes||r.preferred_time;return e.jsx(Ae,{open:H,onOpenChange:E=>b(E?r.id:null),children:e.jsxs("div",{className:k("rounded-xl transition-colors overflow-hidden","bg-secondary/30 border border-border/50"),children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 min-h-[60px]",style:{touchAction:"manipulation",WebkitTapHighlightColor:"transparent"},children:[(()=>{const E=te.get(r.id),D=E?.is_completed||!1,O=A===r.id;return e.jsx("button",{"data-interactive":"true",onClick:q=>{q.stopPropagation(),!D&&!O&&ne(r.id,E?.task_id||null,D)},onTouchStart:q=>{x.current={x:q.touches[0].clientX,y:q.touches[0].clientY}},onTouchEnd:q=>{if(q.preventDefault(),q.stopPropagation(),x.current&&!D&&!O){const Te=Math.abs(q.changedTouches[0].clientX-x.current.x),Ee=Math.abs(q.changedTouches[0].clientY-x.current.y);Te<5&&Ee<5&&ne(r.id,E?.task_id||null,D)}x.current=null},disabled:D,className:k("relative flex items-center justify-center w-11 h-11 -ml-2.5 touch-manipulation transition-transform select-none",!D&&"active:scale-95"),style:{WebkitTapHighlightColor:"transparent",touchAction:"manipulation"},"aria-label":D?"Ritual completed":"Mark ritual as complete",role:"checkbox","aria-checked":D,tabIndex:0,children:e.jsx(_.div,{className:k("flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all",D?"bg-green-500 border-green-500":"border-primary/30 hover:border-primary/60",O&&"animate-pulse border-primary"),whileTap:D?{}:{scale:.85},children:D?e.jsx(_.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:25},children:e.jsx(xe,{className:"w-4 h-4 text-white"})}):O?e.jsx(ue,{className:"w-3 h-3 animate-spin text-primary"}):e.jsx("div",{className:"w-2 h-2 rounded-full bg-primary/50"})})})})(),e.jsx("span",{className:k("flex-1 text-sm font-medium transition-all",te.get(r.id)?.is_completed&&"line-through text-muted-foreground"),children:r.title}),r.preferred_time&&e.jsxs("span",{className:"text-xs text-celestial-blue/80 flex items-center gap-1",children:[e.jsx(oe,{className:"w-3 h-3"}),r.preferred_time.slice(0,5)]}),Y&&e.jsx(Re,{asChild:!0,children:e.jsx("button",{type:"button",className:k("h-10 w-10 -mr-2 flex items-center justify-center rounded-lg","active:bg-primary/20 transition-colors","touch-manipulation","relative z-10"),onClick:E=>{E.stopPropagation()},onTouchEnd:E=>{E.stopPropagation()},children:e.jsx(je,{className:k("h-5 w-5 text-muted-foreground transition-transform duration-200",H&&"rotate-180")})})})]}),e.jsx(Pe,{children:e.jsxs("div",{className:"px-4 pb-4 pt-0 space-y-2 border-t border-border/30","data-vaul-no-drag":!0,children:[r.description&&e.jsx("p",{className:"text-sm text-celestial-blue/80 pt-3",children:r.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 pt-2",children:[(()=>{const E=Ke(r.frequency,r.custom_days);return e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(De,{className:"w-3.5 h-3.5 text-celestial-blue"}),E.type==="text"?e.jsx("span",{children:E.value}):e.jsx("div",{className:"flex gap-0.5",children:Ue.map((D,O)=>e.jsx("span",{className:k("w-4 h-4 rounded-full text-[9px] font-bold flex items-center justify-center",E.value.includes(O)?"bg-celestial-blue/80 text-white":"bg-muted/30 text-muted-foreground/40"),children:D},O))})]})})(),r.estimated_minutes&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(oe,{className:"w-3.5 h-3.5 text-celestial-blue"}),e.jsxs("span",{children:["~",r.estimated_minutes," min"]})]}),r.difficulty&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(ae,{className:"w-3.5 h-3.5 text-celestial-blue"}),e.jsx("span",{className:"capitalize",children:r.difficulty})]}),e.jsxs(T,{variant:"ghost",size:"sm",className:"h-7 px-2 ml-auto text-xs text-muted-foreground hover:text-foreground",onClick:E=>{E.stopPropagation(),ye(r)},children:[e.jsx(He,{className:"w-3 h-3 mr-1"}),"Edit"]})]})]})})]})},r.id)}),se.length>0&&e.jsxs(Ae,{open:d,onOpenChange:j,className:"mt-4",children:[e.jsx(Re,{asChild:!0,children:e.jsxs("button",{className:"w-full flex items-center justify-between p-3 rounded-xl bg-gradient-to-r from-amber-500/10 to-orange-500/10 border border-amber-500/20 hover:border-amber-500/40 transition-all",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"w-4 h-4 text-amber-500"}),e.jsx("span",{className:"text-sm font-medium text-amber-200",children:"Early Bird Mode"}),e.jsx("span",{className:"text-xs text-amber-500/70",children:"Preview upcoming"})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"text-xs text-muted-foreground",children:[se.length," upcoming"]}),e.jsx(je,{className:k("w-4 h-4 text-amber-500 transition-transform",d&&"rotate-180")})]})]})}),e.jsx(Pe,{children:e.jsxs("div",{className:"mt-3 space-y-2 pl-2 border-l-2 border-amber-500/20",children:[e.jsx("p",{className:"text-xs text-amber-500/80 italic px-2 pb-2",children:"These habits are scheduled for later this week"}),se.map(r=>{const H=p===r.id,Y=r.description||r.frequency||r.estimated_minutes;return e.jsx(Ae,{open:H,onOpenChange:E=>b(E?r.id:null),children:e.jsxs("div",{className:k("rounded-xl transition-colors overflow-hidden","bg-amber-500/5 border border-amber-500/20"),children:[e.jsxs("div",{className:"flex items-center gap-3 p-4 min-h-[60px]",style:{touchAction:"manipulation",WebkitTapHighlightColor:"transparent"},children:[(()=>{const E=te.get(r.id),D=E?.is_completed||!1,O=A===r.id;return e.jsx("button",{"data-interactive":"true",onClick:q=>{q.stopPropagation(),!D&&!O&&ne(r.id,E?.task_id||null,D)},onTouchStart:q=>{x.current={x:q.touches[0].clientX,y:q.touches[0].clientY}},onTouchEnd:q=>{if(q.preventDefault(),q.stopPropagation(),x.current&&!D&&!O){const Te=Math.abs(q.changedTouches[0].clientX-x.current.x),Ee=Math.abs(q.changedTouches[0].clientY-x.current.y);Te<5&&Ee<5&&ne(r.id,E?.task_id||null,D)}x.current=null},disabled:D,className:k("relative flex items-center justify-center w-11 h-11 -ml-2.5 touch-manipulation transition-transform select-none",!D&&"active:scale-95"),style:{WebkitTapHighlightColor:"transparent",touchAction:"manipulation"},"aria-label":D?"Ritual completed":"Mark ritual as complete",role:"checkbox","aria-checked":D,tabIndex:0,children:e.jsx(_.div,{className:k("flex-shrink-0 w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all",D?"bg-green-500 border-green-500":"border-amber-500/30 hover:border-amber-500/60",O&&"animate-pulse border-amber-500"),whileTap:D?{}:{scale:.85},children:D?e.jsx(_.div,{initial:{scale:0},animate:{scale:1},transition:{type:"spring",stiffness:500,damping:25},children:e.jsx(xe,{className:"w-4 h-4 text-white"})}):O?e.jsx(ue,{className:"w-3 h-3 animate-spin text-amber-500"}):e.jsx("div",{className:"w-2 h-2 rounded-full bg-amber-500/40"})})})})(),e.jsx("span",{className:k("flex-1 text-sm font-medium transition-all",te.get(r.id)?.is_completed&&"line-through text-muted-foreground"),children:r.title}),r.custom_days&&r.custom_days.length>0&&e.jsx("span",{className:"text-[10px] px-1.5 py-0.5 rounded bg-amber-500/20 text-amber-400 border border-amber-500/30",children:Rs(r.custom_days)}),Y&&e.jsx(Re,{asChild:!0,children:e.jsx("button",{type:"button",className:k("h-10 w-10 -mr-2 flex items-center justify-center rounded-lg","active:bg-amber-500/20 transition-colors","touch-manipulation","relative z-10"),onClick:E=>{E.stopPropagation()},onTouchEnd:E=>{E.stopPropagation()},children:e.jsx(je,{className:k("h-5 w-5 text-amber-500/70 transition-transform duration-200",H&&"rotate-180")})})})]}),e.jsx(Pe,{children:e.jsxs("div",{className:"px-4 pb-4 pt-0 space-y-2 border-t border-amber-500/20","data-vaul-no-drag":!0,children:[r.description&&e.jsx("p",{className:"text-sm text-amber-500/70 pt-3",children:r.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-3 pt-2",children:[(()=>{const E=Ke(r.frequency,r.custom_days);return e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(De,{className:"w-3.5 h-3.5 text-amber-500"}),E.type==="text"?e.jsx("span",{children:E.value}):e.jsx("div",{className:"flex gap-0.5",children:Ue.map((D,O)=>e.jsx("span",{className:k("w-4 h-4 rounded-full text-[9px] font-bold flex items-center justify-center",E.value.includes(O)?"bg-amber-500/80 text-white":"bg-muted/30 text-muted-foreground/40"),children:D},O))})]})})(),r.estimated_minutes&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(oe,{className:"w-3.5 h-3.5 text-amber-500"}),e.jsxs("span",{children:["~",r.estimated_minutes," min"]})]}),r.difficulty&&e.jsxs("div",{className:"flex items-center gap-1.5 text-xs text-muted-foreground",children:[e.jsx(ae,{className:"w-3.5 h-3.5 text-amber-500"}),e.jsx("span",{className:"capitalize",children:r.difficulty})]}),e.jsxs(T,{variant:"ghost",size:"sm",className:"h-7 px-2 ml-auto text-xs text-amber-500/70 hover:text-amber-500",onClick:E=>{E.stopPropagation(),ye(r)},children:[e.jsx(He,{className:"w-3 h-3 mr-1"}),"Edit"]})]})]})})]})},r.id)})]})})]}),e.jsx("div",{className:"mt-4 pt-4 border-t border-border/30",children:P?e.jsxs("div",{className:"space-y-3 p-3 rounded-xl bg-secondary/30 border border-primary/20","data-vaul-no-drag":!0,children:[e.jsx(de,{value:C,onChange:r=>v(r.target.value),placeholder:"New ritual name...",autoFocus:!0,className:"bg-background/50"}),e.jsx(mt,{value:W,onChange:M}),e.jsx(ut,{selectedDays:F,onDaysChange:L}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{size:"sm",onClick:R,disabled:!C.trim()||z,className:"flex-1",children:z?e.jsx(ue,{className:"w-4 h-4 animate-spin"}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"w-4 h-4 mr-1"})," Add Ritual"]})}),e.jsx(T,{size:"sm",variant:"outline",onClick:()=>{w(!1),v("")},children:"Cancel"})]})]}):e.jsxs(T,{variant:"outline",size:"sm",className:"w-full border-dashed gap-2 text-muted-foreground hover:text-foreground",onClick:()=>w(!0),children:[e.jsx(ce,{className:"w-4 h-4"}),"Add New Ritual"]})})]}),i&&n&&e.jsxs(T,{variant:"outline",size:"sm",onClick:()=>{y(!1),n()},className:"w-full mt-4",children:[e.jsx(st,{className:"h-4 w-4 mr-2"}),"Adjust My Plan"]}),e.jsxs("p",{className:"text-center text-xs text-muted-foreground pt-4 flex items-center justify-center gap-1.5",children:[e.jsx(U,{className:"w-3 h-3"}),"Tap circles to complete rituals"]}),X.length===0&&se.length>0&&e.jsx("p",{className:"text-center text-sm text-muted-foreground py-4",children:"No habits scheduled for today. Check the Early Bird section to preview upcoming habits!"})]}),e.jsx(Ut,{ritual:f,open:!!f,onOpenChange:r=>!r&&m(null),onDelete:S,isDeleting:N})]})]})}),J=t=>Ye[t]||Ye.common,Ds=({open:t,onOpenChange:l,rewardData:s,onClaim:u})=>{const[n,i]=a.useState("chest");a.useEffect(()=>{t&&i("chest")},[t]),a.useEffect(()=>{if(!t||!s)return;const o=[];if(n==="chest")o.push(setTimeout(()=>i("badge"),2e3));else if(n==="badge")ze({particleCount:50,spread:60,origin:{y:.4},colors:["#FFD700","#FFA500","#FF6347"]}),o.push(setTimeout(()=>i("loot"),2500));else if(n==="loot"&&s.loot){const g=Hs(s.loot.rarity);ze({particleCount:80,spread:100,origin:{y:.5},colors:g}),o.push(setTimeout(()=>i("complete"),2500))}else n==="loot"&&!s.loot&&o.push(setTimeout(()=>i("complete"),1500));return()=>o.forEach(clearTimeout)},[n,t,s]);const h=a.useCallback(()=>{u?.(),l(!1)},[u,l]);return s?e.jsx(Ne,{open:t,onOpenChange:l,children:e.jsx(we,{className:"max-w-md border-0 bg-transparent shadow-none p-0 overflow-visible",children:e.jsxs("div",{className:"relative min-h-[500px] flex items-center justify-center",children:[e.jsx("div",{className:"absolute inset-0 bg-gradient-radial from-primary/20 via-transparent to-transparent blur-3xl"}),e.jsx("div",{className:"absolute inset-0 pointer-events-none overflow-hidden",children:[...Array(20)].map((o,g)=>e.jsx(_.div,{className:"absolute w-1 h-1 bg-primary/60 rounded-full",initial:{x:Math.random()*400-200,y:Math.random()*500-250,opacity:0,scale:0},animate:{opacity:[0,1,0],scale:[0,1,0]},transition:{duration:2,repeat:1/0,delay:Math.random()*2}},g))}),e.jsxs(ve,{mode:"wait",children:[n==="chest"&&e.jsxs(_.div,{initial:{scale:.5,opacity:0},animate:{scale:1,opacity:1},exit:{scale:1.5,opacity:0},className:"flex flex-col items-center",children:[e.jsxs(_.div,{animate:{rotateY:[0,10,-10,0],y:[0,-10,0]},transition:{duration:1.5,repeat:1/0,ease:"easeInOut"},className:"relative",children:[e.jsx("div",{className:"w-32 h-32 rounded-2xl bg-gradient-to-br from-yellow-500 to-orange-600 flex items-center justify-center shadow-2xl shadow-yellow-500/50",children:e.jsx(Nt,{className:"w-16 h-16 text-white"})}),e.jsx(_.div,{className:"absolute -inset-4 rounded-3xl border-2 border-yellow-400/50",animate:{opacity:[.3,.8,.3]},transition:{duration:1.5,repeat:1/0}})]}),e.jsx(_.p,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.5},className:"mt-6 text-lg font-medium text-foreground/80",children:"Opening rewards..."})]},"chest"),n==="badge"&&e.jsxs(_.div,{initial:{scale:0,opacity:0,rotateY:-180},animate:{scale:1,opacity:1,rotateY:0},exit:{scale:.8,opacity:0,y:-50},transition:{type:"spring",damping:15},className:"flex flex-col items-center",children:[e.jsxs(_.div,{animate:{y:[0,-5,0]},transition:{duration:2,repeat:1/0},className:"relative",children:[e.jsx("div",{className:k("w-28 h-28 rounded-full flex items-center justify-center text-5xl","bg-gradient-to-br shadow-2xl",s.badge.tier==="platinum"?"from-purple-400 to-purple-600 shadow-purple-500/50":"from-yellow-400 to-yellow-600 shadow-yellow-500/50"),children:s.badge.icon}),e.jsx(_.div,{className:"absolute -inset-2 rounded-full",animate:{boxShadow:["0 0 20px hsl(45, 90%, 50%)","0 0 40px hsl(45, 90%, 50%)","0 0 20px hsl(45, 90%, 50%)"]},transition:{duration:1.5,repeat:1/0}})]}),e.jsxs(_.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"mt-6 text-center",children:[e.jsx("p",{className:"text-sm text-muted-foreground uppercase tracking-wider",children:"Badge Earned"}),e.jsx("h3",{className:"text-2xl font-bold text-foreground mt-1",children:s.badge.title}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1",children:s.badge.description})]})]},"badge"),n==="loot"&&e.jsx(_.div,{initial:{scale:0,opacity:0},animate:{scale:1,opacity:1},exit:{scale:.8,opacity:0},transition:{type:"spring",damping:15},className:"flex flex-col items-center",children:s.loot?e.jsxs(e.Fragment,{children:[e.jsxs(_.div,{animate:{rotate:[0,5,-5,0],y:[0,-8,0]},transition:{duration:2,repeat:1/0},className:"relative",children:[e.jsx("div",{className:k("w-32 h-32 rounded-2xl flex items-center justify-center","bg-gradient-to-br shadow-2xl",J(s.loot.rarity).bgClass,J(s.loot.rarity).glowClass),children:s.loot.reward_type==="artifact"&&s.loot.css_effect?.icon?e.jsx("span",{className:"text-5xl",children:s.loot.css_effect.icon}):e.jsx(be,{className:"w-14 h-14",style:{color:J(s.loot.rarity).color}})}),e.jsx(_.div,{className:"absolute -inset-3 rounded-3xl",animate:{boxShadow:[`0 0 20px ${J(s.loot.rarity).color}`,`0 0 40px ${J(s.loot.rarity).color}`,`0 0 20px ${J(s.loot.rarity).color}`]},transition:{duration:1.5,repeat:1/0}})]}),e.jsxs(_.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{delay:.3},className:"mt-6 text-center",children:[e.jsxs("p",{className:"text-sm font-medium uppercase tracking-wider",style:{color:J(s.loot.rarity).color},children:[J(s.loot.rarity).label," ",Fe(s.loot.reward_type)]}),e.jsx("h3",{className:"text-2xl font-bold text-foreground mt-1",children:s.loot.name}),e.jsx("p",{className:"text-sm text-muted-foreground mt-1 max-w-xs",children:s.loot.description}),s.isDuplicate&&s.bonusXP&&e.jsxs("p",{className:"text-sm text-yellow-500 mt-2",children:["Already owned! +",s.bonusXP," XP instead"]})]})]}):e.jsx(_.p,{initial:{opacity:0},animate:{opacity:1},className:"text-muted-foreground",children:"No additional loot this time"})},"loot"),n==="complete"&&e.jsx(_.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center w-full max-w-sm",children:e.jsxs("div",{className:"w-full cosmiq-glass rounded-2xl p-6 space-y-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(pe,{className:"w-6 h-6 text-yellow-500"}),e.jsx("h3",{className:"text-xl font-bold",children:"Rewards Earned!"})]}),e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-background/50 rounded-xl",children:[e.jsx("span",{className:"text-3xl",children:s.badge.icon}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.badge.title}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Badge"})]})]}),s.loot&&e.jsxs("div",{className:"flex items-center gap-3 p-3 bg-background/50 rounded-xl",children:[s.loot.reward_type==="artifact"&&s.loot.css_effect?.icon?e.jsx("span",{className:"text-3xl",children:s.loot.css_effect.icon}):e.jsx("div",{className:"w-10 h-10 rounded-lg flex items-center justify-center",style:{background:J(s.loot.rarity).color+"30"},children:e.jsx(U,{className:"w-5 h-5",style:{color:J(s.loot.rarity).color}})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium",children:s.loot.name}),e.jsxs("p",{className:"text-xs",style:{color:J(s.loot.rarity).color},children:[J(s.loot.rarity).label," ",Fe(s.loot.reward_type)]})]})]}),s.isDuplicate&&s.bonusXP&&e.jsxs("p",{className:"text-center text-sm text-yellow-500",children:["+",s.bonusXP," XP (duplicate reward)"]}),e.jsxs(T,{onClick:h,className:"w-full bg-gradient-to-r from-primary to-accent hover:opacity-90",children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"Claim Rewards"]})]})},"complete")]})]})})}):null};function Hs(t){switch(t){case"common":return["#9CA3AF","#6B7280","#4B5563"];case"rare":return["#3B82F6","#2563EB","#1D4ED8"];case"epic":return["#A855F7","#9333EA","#7C3AED"];case"legendary":return["#F59E0B","#FBBF24","#FCD34D","#EF4444"];default:return["#9CA3AF"]}}function Is(){const[t,l]=a.useState([]),[s,u]=a.useState(null),[n,i]=a.useState(null),[h,o]=a.useState(null),[g,c]=a.useState(!1),[y,p]=a.useState(null),b=a.useCallback(async(N,I,P)=>{c(!0),p(null);try{const{data:w,error:C}=await Q.functions.invoke("adjust-epic-plan",{body:{epicId:N,adjustmentType:I,reason:P?.reason,newDeadline:P?.newDeadline,daysToAdd:P?.daysToAdd,habitsToRemove:P?.habitsToRemove,customRequest:P?.customRequest}});if(C)throw C;if(w.error)throw new Error(w.error);const v=w,W=v.suggestions.map(M=>({...M,selected:!1}));l(W),u(v.analysis),i(v.encouragement),o(v.epicStatus)}catch(w){const C=w instanceof Error?w.message:"Failed to build adjustment suggestions";p(C),B.error(C)}finally{c(!1)}},[]),f=a.useCallback(N=>{l(I=>I.map(P=>P.id===N?{...P,selected:!P.selected}:P))},[]),m=a.useCallback(()=>t.filter(N=>N.selected),[t]),d=a.useCallback(async(N,I,P)=>{const w=m();if(w.length===0)return B.error("Please select at least one adjustment to apply"),!1;c(!0);try{const{data:C,error:v}=await Q.functions.invoke("apply-epic-adjustments",{body:{epicId:N,adjustments:w,adjustmentType:I,reason:P}});if(v)throw v;if(C.error)throw new Error(C.error);return B.success(C.message||`Applied ${w.length} adjustment${w.length>1?"s":""} to your plan`),!0}catch(C){const v=C instanceof Error?C.message:"Failed to apply adjustments";return B.error(v),!1}finally{c(!1)}},[m]),j=a.useCallback(()=>{l([]),u(null),i(null),o(null),p(null),c(!1)},[]);return{suggestions:t,analysis:s,encouragement:n,epicStatus:h,isLoading:g,error:y,generateAdjustments:b,toggleSuggestion:f,getSelectedSuggestions:m,applyAdjustments:d,reset:j}}function Fs({habits:t,completionData:l=[],daysToAnalyze:s=14}){return a.useMemo(()=>{if(!t||t.length===0)return{shouldShowAdvisor:!1,insights:[],habitPatterns:[],overallCompletionRate:0,bestPerformingHabits:[],strugglingHabits:[],smartQuickActions:[],totalHabits:0};const u=new Date,n=new Date(u.getTime()-s*24*60*60*1e3),i=l.filter(m=>new Date(m.completed_at)>=n),h=t.map(m=>{const d=i.filter(C=>C.habit_id===m.id),j=Math.min(100,d.length/s*100),N=new Date(u.getTime()-s/2*24*60*60*1e3),I=d.filter(C=>new Date(C.completed_at)<N).length,P=d.filter(C=>new Date(C.completed_at)>=N).length;let w="stable";return P>I+1&&(w="improving"),P<I-1&&(w="declining"),{habitId:m.id,habitTitle:m.title,completionRate:j,trend:w}}),o=h.length>0?h.reduce((m,d)=>m+d.completionRate,0)/h.length:0,g=h.filter(m=>m.completionRate>=70).map(m=>m.habitTitle),c=h.filter(m=>m.completionRate<40).map(m=>m.habitTitle),y=h.filter(m=>m.trend==="declining"),p=[];o>=80&&p.push({id:"high-performer",type:"celebration",title:"Amazing consistency!",description:`You're completing ${Math.round(o)}% of your rituals. Keep up the stellar work!`}),c.length>0&&c.length<=2&&p.push({id:"struggling-habits",type:"warning",title:`${c.length} ritual${c.length>1?"s":""} needs attention`,description:`"${c[0]}" has low completion. Consider simplifying or removing it.`,action:{label:"Simplify",adjustmentText:`I'm struggling with "${c[0]}". Please suggest an easier alternative or remove it.`}}),y.length>=2&&p.push({id:"declining-trend",type:"warning",title:"Declining completion trend",description:"Multiple rituals are showing decreased completion. Time to adjust your plan.",action:{label:"Adjust",adjustmentText:"My ritual completion is declining. Please simplify my routine."}}),t.length>=5&&o<50&&p.push({id:"too-many-habits",type:"suggestion",title:"Consider fewer rituals",description:"With many rituals, it can be hard to stay consistent. Try focusing on 2-3 key ones.",action:{label:"Simplify",adjustmentText:"I have too many habits and struggle to complete them. Please help me reduce to 2-3 key rituals."}});const b=[];return c.length>0&&b.push({id:"simplify-routine",label:"Simplify Routine",description:"Make struggling habits easier",adjustmentText:"I'm having trouble with some habits. Please make them easier or suggest simpler alternatives.",icon:"Minus",priority:"primary"}),o>=70&&t.length<5&&b.push({id:"add-habit",label:"Level Up",description:"Add a new challenge",adjustmentText:"I'm doing well with my current habits. Please suggest one new habit to add.",icon:"Plus",priority:"secondary"}),t.some(m=>m.difficulty==="hard")&&o<60&&b.push({id:"reduce-difficulty",label:"Ease Up",description:"Lower difficulty levels",adjustmentText:"My habits are too difficult. Please suggest easier versions of my current rituals.",icon:"TrendingDown",priority:"primary"}),y.length>0&&b.push({id:"swap-habits",label:"Fresh Start",description:"Replace declining habits",adjustmentText:"Some of my habits are declining in completion. Please suggest replacements that better fit my lifestyle.",icon:"RefreshCw",priority:"primary"}),b.length===0&&b.push({id:"optimize",label:"Optimize",description:"Fine-tune your routine",adjustmentText:"Please review my habits and suggest any optimizations to improve my consistency.",icon:"Sparkles",priority:"secondary"}),{shouldShowAdvisor:p.length>0||c.length>0||o<50||y.length>0,insights:p,habitPatterns:h,overallCompletionRate:o,bestPerformingHabits:g,strugglingHabits:c,smartQuickActions:b,totalHabits:t.length}},[t,l,s])}const Ms={Minus:rt,Plus:ce,TrendingDown:Ie,RefreshCw:wt,Sparkles:U};function qs({habits:t,completionData:l,onSelectAdjustment:s,onDismiss:u,variant:n="inline",className:i}){const[h,o]=a.useState(!1),[g,c]=a.useState(!1),y=Fs({habits:t,completionData:l}),p=()=>{o(!0),u?.()};if(h||!y.shouldShowAdvisor)return null;const b=y.smartQuickActions.filter(d=>d.priority==="primary").slice(0,2),f=y.smartQuickActions.slice(0,4),m=d=>{switch(d){case"warning":return e.jsx(_t,{className:"w-4 h-4 text-amber-500"});case"celebration":return e.jsx(Ct,{className:"w-4 h-4 text-green-500"});default:return e.jsx(Oe,{className:"w-4 h-4 text-blue-500"})}};if(n==="banner"){const d=y.insights[0],j=b[0];return e.jsxs(_.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:k("flex items-center gap-3 p-3 rounded-xl","bg-gradient-to-r from-purple-500/10 to-violet-500/10","border border-purple-500/20",i),children:[e.jsx(U,{className:"w-5 h-5 text-purple-400 flex-shrink-0"}),e.jsx("div",{className:"flex-1 min-w-0",children:e.jsx("p",{className:"text-sm font-medium truncate",children:d?.title||"Optimize your rituals"})}),j&&e.jsx(T,{size:"sm",variant:"secondary",className:"flex-shrink-0 bg-purple-500/20 hover:bg-purple-500/30 text-purple-200",onClick:()=>s(j.adjustmentText),children:j.label}),u&&e.jsx("button",{onClick:p,className:"p-1 rounded-full hover:bg-white/10 text-muted-foreground",children:e.jsx(at,{className:"w-4 h-4"})})]})}return e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},className:k("space-y-4",i),children:[e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Smart suggestions"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:f.map(d=>{const j=Ms[d.icon]||U;return e.jsxs("button",{onClick:()=>s(d.adjustmentText),className:k("flex flex-col items-start gap-1.5 p-3 rounded-xl text-left transition-all","bg-gradient-to-br from-purple-500/10 to-violet-500/10","border border-purple-500/20 hover:border-purple-500/40","hover:from-purple-500/15 hover:to-violet-500/15",d.priority==="primary"&&"ring-1 ring-purple-500/30"),children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"p-1.5 rounded-lg bg-purple-500/20",children:e.jsx(j,{className:"w-4 h-4 text-purple-400"})}),e.jsx("span",{className:"text-sm font-medium",children:d.label})]}),e.jsx("span",{className:"text-xs text-muted-foreground line-clamp-1",children:d.description})]},d.id)})})]}),y.insights.length>0&&e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>c(!g),className:"flex items-center gap-2 text-sm text-muted-foreground hover:text-foreground transition-colors w-full",children:[e.jsx(Oe,{className:"w-4 h-4 text-purple-400"}),e.jsxs("span",{children:[y.insights.length," insight",y.insights.length!==1?"s":""," available"]}),e.jsx(he,{className:k("w-4 h-4 ml-auto transition-transform",g&&"rotate-90")})]}),e.jsx(ve,{children:g&&e.jsx(_.div,{initial:{height:0,opacity:0},animate:{height:"auto",opacity:1},exit:{height:0,opacity:0},className:"overflow-hidden",children:e.jsx("div",{className:"space-y-2 pt-3",children:y.insights.map(d=>e.jsx("div",{className:k("p-3 rounded-xl border",d.type==="warning"&&"bg-amber-500/10 border-amber-500/20",d.type==="celebration"&&"bg-green-500/10 border-green-500/20",d.type==="suggestion"&&"bg-blue-500/10 border-blue-500/20"),children:e.jsxs("div",{className:"flex items-start gap-2",children:[m(d.type),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"text-sm font-medium",children:d.title}),e.jsx("p",{className:"text-xs text-muted-foreground mt-0.5",children:d.description}),d.action&&e.jsxs(T,{size:"sm",variant:"ghost",className:"mt-2 h-7 text-xs",onClick:()=>s(d.action.adjustmentText),children:[d.action.label,e.jsx(he,{className:"w-3 h-3 ml-1"})]})]})]})},d.id))})})})]}),e.jsxs("div",{className:"flex items-center gap-3 text-xs text-muted-foreground",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx("span",{className:"font-medium text-foreground",children:y.totalHabits})," rituals"]}),e.jsx("span",{className:"text-muted-foreground/30",children:"•"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsxs("span",{className:k("font-medium",y.overallCompletionRate>=70&&"text-green-500",y.overallCompletionRate>=40&&y.overallCompletionRate<70&&"text-amber-500",y.overallCompletionRate<40&&"text-red-500"),children:[Math.round(y.overallCompletionRate),"%"]})," avg completion"]})]})]})}const Ls=a.memo(function({open:l,onOpenChange:s,epicId:u,epicTitle:n,habits:i=[],completionData:h=[]}){const[o,g]=a.useState("input"),[c,y]=a.useState(""),[p,b]=a.useState(!0),{suggestions:f,analysis:m,encouragement:d,epicStatus:j,isLoading:N,generateAdjustments:I,toggleSuggestion:P,getSelectedSuggestions:w,applyAdjustments:C,reset:v}=Is(),W=A=>{y(A),b(!1)},M=async()=>{c.trim()&&(await I(u,"custom",{customRequest:c}),g("preview"))},F=async()=>{g("saving"),await C(u,"custom",c)?L():g("preview")},L=()=>{g("input"),y(""),b(!0),v(),s(!1)},z=()=>{o==="preview"&&g("input")},K=A=>{switch(A.action){case"add":return e.jsx(ce,{className:"h-4 w-4 text-green-500"});case"remove":return e.jsx(rt,{className:"h-4 w-4 text-red-500"});default:return e.jsx(st,{className:"h-4 w-4 text-purple-500"})}};return e.jsx(lt,{open:l,onOpenChange:L,handleOnly:!0,shouldScaleBackground:!1,children:e.jsxs(ot,{className:"max-h-[90vh]",children:[e.jsxs(ct,{className:"pb-2",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs(dt,{className:"flex items-center gap-2",children:[e.jsx(it,{className:"w-5 h-5 text-purple-400"}),"Smart Adjust Plan"]}),j&&e.jsxs(G,{variant:"outline",className:k("text-xs",j.progressDelta>=0?"border-green-500/50 text-green-500":"border-amber-500/50 text-amber-500"),children:[j.progressDelta>=0?e.jsx(Xe,{className:"w-3 h-3 mr-1"}):e.jsx(Ie,{className:"w-3 h-3 mr-1"}),j.progressDelta>=0?"On track":"Behind"]})]}),e.jsxs("p",{className:"text-sm text-muted-foreground",children:[o==="input"&&"Personalized suggestions to optimize your rituals",o==="preview"&&"Review and apply the suggested changes",o==="saving"&&"Applying changes..."]})]}),e.jsx(Jt,{className:"flex-1 px-4 max-h-[60vh]",children:e.jsxs(ve,{mode:"wait",children:[o==="input"&&e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"space-y-4 pb-4",children:[p&&i.length>0&&e.jsx(qs,{habits:i,completionData:h,onSelectAdjustment:W,onDismiss:()=>b(!1),variant:"inline"}),e.jsxs("div",{children:[e.jsx("label",{className:"text-xs font-medium text-muted-foreground mb-2 block",children:"Describe your changes"}),e.jsx(qe,{value:c,onChange:A=>y(A.target.value),placeholder:"e.g., I want to add a morning meditation habit, or make my current habits easier...",className:"min-h-[100px] resize-none"})]}),e.jsxs("div",{className:"bg-secondary/30 rounded-lg p-3 space-y-1",children:[e.jsx("div",{className:"text-xs text-muted-foreground",children:"Current journey"}),e.jsx("div",{className:"text-sm font-medium",children:n}),e.jsx("div",{className:"flex gap-3 text-xs text-muted-foreground",children:e.jsxs("span",{children:[i.length," rituals"]})})]})]},"input"),o==="preview"&&e.jsxs(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},className:"space-y-4 pb-4",children:[j&&e.jsxs(ge,{className:"p-3 bg-secondary/30",children:[e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsx("span",{className:"text-muted-foreground",children:"Progress"}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{className:"font-medium",children:[Math.round(j.actualProgress),"%"]}),j.progressDelta>=0?e.jsxs(G,{variant:"secondary",className:"text-green-600 bg-green-500/10",children:[e.jsx(Xe,{className:"h-3 w-3 mr-1"}),"On track"]}):e.jsxs(G,{variant:"secondary",className:"text-amber-600 bg-amber-500/10",children:[e.jsx(Ie,{className:"h-3 w-3 mr-1"}),"Behind"]})]})]}),e.jsxs("div",{className:"text-xs text-muted-foreground mt-1",children:[j.daysRemaining," days remaining"]})]}),m&&e.jsx("p",{className:"text-sm text-muted-foreground",children:m}),f.length>0?e.jsxs("div",{children:[e.jsxs("div",{className:"text-xs font-medium text-muted-foreground mb-2",children:["Suggested changes (",f.length,")"]}),e.jsx("div",{className:"space-y-2 max-h-[200px] overflow-y-auto",children:f.map(A=>e.jsx(ge,{className:k("p-3 cursor-pointer transition-all border-2",A.selected?"border-purple-500 bg-purple-500/5":"border-transparent hover:border-purple-500/30"),onClick:()=>P(A.id),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:k("flex-shrink-0 w-6 h-6 rounded-full flex items-center justify-center",A.selected?"bg-purple-500 text-white":"bg-secondary"),children:A.selected?e.jsx(xe,{className:"h-4 w-4"}):K(A)}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"font-medium text-sm",children:A.title}),e.jsx(G,{variant:"outline",className:"text-xs",children:Fe(A.type)})]}),e.jsx("p",{className:"text-xs text-muted-foreground",children:xt(A.description)})]})]})},A.id))})]}):e.jsxs("div",{className:"flex items-center gap-2 text-sm text-muted-foreground bg-secondary/30 rounded-lg p-3",children:[e.jsx(St,{className:"w-4 h-4"}),"No suggestions yet. Try a different request."]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3",children:[e.jsxs("div",{className:"bg-secondary/30 rounded-lg p-3 text-center",children:[e.jsx("div",{className:"text-lg font-bold",children:i.length}),e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"Current rituals"})]}),e.jsxs("div",{className:"bg-purple-500/10 rounded-lg p-3 text-center border border-purple-500/20",children:[e.jsx("div",{className:"text-lg font-bold text-purple-400",children:i.length+f.filter(A=>A.action==="add"&&A.selected).length-f.filter(A=>A.action==="remove"&&A.selected).length}),e.jsx("div",{className:"text-[10px] text-muted-foreground",children:"After changes"})]})]}),d&&e.jsxs("p",{className:"text-sm text-purple-400 italic text-center",children:['"',d,'"']})]},"preview"),o==="saving"&&e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},className:"flex flex-col items-center justify-center py-12",children:[e.jsx(ue,{className:"w-8 h-8 animate-spin text-purple-400 mb-3"}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"Updating your rituals..."})]},"saving")]})}),e.jsxs(Gt,{className:"border-t pt-4",children:[o==="input"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{variant:"outline",className:"flex-1",onClick:L,children:"Cancel"}),e.jsx(T,{className:"flex-1 gap-2 bg-purple-600 hover:bg-purple-700",onClick:M,disabled:N||!c.trim(),children:N?e.jsxs(e.Fragment,{children:[e.jsx(ue,{className:"w-4 h-4 animate-spin"}),"Analyzing..."]}):e.jsxs(e.Fragment,{children:[e.jsx(U,{className:"w-4 h-4"}),"Get Suggestions"]})})]}),o==="preview"&&e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{variant:"outline",className:"flex-1",onClick:z,children:"Back"}),e.jsxs(T,{className:"flex-1 gap-2 bg-purple-600 hover:bg-purple-700",onClick:F,disabled:w().length===0,children:["Apply ",w().length," Change",w().length!==1?"s":"",e.jsx(kt,{className:"w-4 h-4"})]})]})]})]})})}),Bs={heroic:"from-epic-heroic/20 to-purple-500/20",warrior:"from-epic-warrior/20 to-orange-500/20",mystic:"from-epic-mystic/20 to-blue-500/20",nature:"from-epic-nature/20 to-emerald-500/20",solar:"from-epic-solar/20 to-amber-500/20"},zs={heroic:"border-epic-heroic/20 hover:border-epic-heroic/40",warrior:"border-epic-warrior/20 hover:border-epic-warrior/40",mystic:"border-epic-mystic/20 hover:border-epic-mystic/40",nature:"border-epic-nature/20 hover:border-epic-nature/40",solar:"border-epic-solar/20 hover:border-epic-solar/40"},Je=({epic:t,onComplete:l,onAbandon:s})=>{const[u,n]=a.useState(!1),[i,h]=a.useState(!1),[o,g]=a.useState(!1),[c,y]=a.useState(!1),[p,b]=a.useState(null),{companion:f}=Vt(),{health:m}=Zt(),{checkAndGeneratePostcard:d}=es(),{milestones:j}=ts(t.id),{awardCustomXP:N}=ss(),{generateRewardReveal:I}=as(),P=a.useMemo(()=>{if(!(!j||j.length===0))return j.map(x=>({id:x.id,title:x.title,milestone_percent:x.milestone_percent,is_postcard_milestone:x.is_postcard_milestone,completed_at:x.completed_at}))},[j]),w=a.useRef(-1),C=a.useRef(!1),v=a.useRef(-1),W=Math.ceil((new Date(t.end_date).getTime()-new Date().getTime())/(1e3*60*60*24)),M=t.status==="completed",F=t.status==="active",L=t.theme_color||"heroic",z=Bs[L],K=zs[L];a.useEffect(()=>{if(!f?.id||!F)return;const x=t.progress_percentage,Z=w.current;if(!C.current){C.current=!0,x>0&&d(t.id,x,0,f.id,{spirit_animal:f.spirit_animal,favorite_color:f.favorite_color,core_element:f.core_element,eye_color:f.eye_color,fur_color:f.fur_color}),w.current=x;return}x>Z&&d(t.id,x,Z,f.id,{spirit_animal:f.spirit_animal,favorite_color:f.favorite_color,core_element:f.core_element,eye_color:f.eye_color,fur_color:f.fur_color}),w.current=x,v.current>=0&&x>v.current&&window.dispatchEvent(new CustomEvent("epic-progress-checkpoint",{detail:{epicId:t.id,previousProgress:v.current,currentProgress:x}})),v.current=x},[t.progress_percentage,t.id,f,F,d]);const A=async()=>{if(t.invite_code)try{await navigator.clipboard.writeText(t.invite_code),n(!0),B.success("Invite code copied!",{description:"Share this code with others to invite them to your guild"}),setTimeout(()=>n(!1),2e3)}catch{B.error("Failed to copy code")}},V=async()=>{try{const x=await I(t.story_type_slug||null,t.id);b(x),y(!0)}catch(x){console.error("Failed to generate rewards:",x),l?.()}};return e.jsxs(_.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.3},children:[e.jsxs(ge,{className:k("p-6 bg-gradient-to-br border-2 transition-all",`from-background to-secondary/20 ${K}`,`bg-gradient-to-br ${z}`),children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-2",children:[M?e.jsx(pe,{className:"w-6 h-6 text-stardust-gold drop-shadow-[0_0_8px_hsl(45,100%,65%)]"}):e.jsx(ae,{className:"w-6 h-6 text-celestial-blue"}),e.jsx("h3",{className:"text-xl font-bold",children:t.title}),t.invite_code&&e.jsx(T,{variant:"ghost",size:"sm",className:"h-7 px-2 text-primary hover:text-primary hover:bg-primary/10",onClick:A,children:u?e.jsx(xe,{className:"w-4 h-4"}):e.jsx(Tt,{className:"w-4 h-4"})})]}),t.description&&e.jsx("p",{className:"text-sm text-muted-foreground mb-3",children:xt(t.description)})]}),e.jsxs("div",{className:"flex items-center gap-2 ml-2",children:[e.jsx(G,{variant:M?"gold":F?"celestial":"secondary",children:M?"Legendary":F?"Active":"Abandoned"}),F&&e.jsx("button",{onClick:()=>h(!0),className:"h-11 w-11 -m-3 rounded-full hover:bg-destructive/10 flex items-center justify-center text-muted-foreground/40 hover:text-destructive transition-colors touch-manipulation",title:"Abandon epic",children:e.jsx(at,{className:"h-4 w-4"})})]})]}),e.jsx(rs,{progress:t.progress_percentage,targetDays:t.target_days,className:"mb-3",companionImageUrl:m?.imageUrl||f?.current_image_url,companionMood:m?.moodState,showCompanion:!0,milestones:P,epicId:t.id}),e.jsxs("div",{className:"flex items-center justify-center gap-4 text-xs text-muted-foreground mb-3 py-2 px-3 bg-background/30 rounded-lg",children:[e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(De,{className:"w-3 h-3"}),t.target_days,"d"]}),e.jsx("span",{className:"text-muted-foreground/30",children:"•"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Et,{className:"w-3 h-3 text-orange-500"}),M?"Done":`${W}d left`]}),e.jsx("span",{className:"text-muted-foreground/30",children:"•"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(Me,{className:"w-3 h-3 text-yellow-500"}),t.xp_reward," XP"]})]}),t.epic_habits&&t.epic_habits.length>0&&e.jsx(Ps,{epicId:t.id,habits:t.epic_habits.filter(x=>x.habits).map(x=>({id:x.habit_id,title:x.habits?.title||"Untitled",difficulty:x.habits?.difficulty||"medium",description:x.habits?.description,frequency:x.habits?.frequency,estimated_minutes:x.habits?.estimated_minutes,custom_days:x.habits?.custom_days})),isActive:F,onAdjustPlan:()=>g(!0),showAdjustPlan:F&&t.progress_percentage<100}),F&&t.progress_percentage>=100&&e.jsx("div",{className:"mt-4 space-y-2",children:e.jsxs(T,{onClick:V,className:"w-full bg-gradient-to-r from-yellow-500 to-orange-500 hover:from-yellow-600 hover:to-orange-600",children:[e.jsx(pe,{className:"w-4 h-4 mr-2"}),"Complete Epic"]})})]}),e.jsx(is,{open:i,onOpenChange:h,children:e.jsxs(ns,{children:[e.jsxs(ls,{children:[e.jsx(os,{children:"Abandon this epic?"}),e.jsxs(cs,{children:['Are you sure you want to abandon "',t.title,`"? Your progress will be lost and you won't earn the XP reward.`]})]}),e.jsxs(ds,{children:[e.jsx(ms,{children:"Cancel"}),e.jsx(us,{onClick:s,className:"bg-destructive text-destructive-foreground hover:bg-destructive/90",children:"Abandon Epic"})]})]})}),e.jsx(Ds,{open:c,onOpenChange:y,rewardData:p,onClaim:()=>{p?.isDuplicate&&p.bonusXP&&N(p.bonusXP,"reward_duplicate","Duplicate reward bonus",{epic_id:t.id,reward_id:p.loot?.id}),l?.(),B.success("Campaign Complete!",{description:"Your rewards have been added to your collection."})}}),e.jsx(Ls,{open:o,onOpenChange:g,epicId:t.id,epicTitle:t.title,habits:t.epic_habits?.filter(x=>x.habits).map(x=>({id:x.habit_id,title:x.habits?.title||"Untitled",difficulty:x.habits?.difficulty,frequency:x.habits?.frequency,estimated_minutes:x.habits?.estimated_minutes}))||[]})]})},ft=a.memo(({habitTitle:t,habitDescription:l="",difficulty:s,selectedDays:u,preferredTime:n,reminderEnabled:i,reminderMinutesBefore:h,onTitleChange:o,onDescriptionChange:g,onDifficultyChange:c,onDaysChange:y,onPreferredTimeChange:p,onReminderEnabledChange:b,onReminderMinutesChange:f,onAddHabit:m,isEditing:d=!1,onCancelEdit:j})=>e.jsxs("div",{className:"border rounded-lg p-3 space-y-3",children:[e.jsx(de,{placeholder:"Habit name (e.g., Morning run)",value:t,onChange:N=>o(N.target.value),maxLength:60}),g&&e.jsx(qe,{placeholder:"Brief description or ritual details (optional)",value:l,onChange:N=>g(N.target.value),maxLength:200,rows:2,className:"text-sm resize-none"}),e.jsx(mt,{value:s,onChange:c}),e.jsx(ut,{selectedDays:u,onDaysChange:y}),e.jsxs("div",{className:"space-y-3 pt-2 border-t border-border/50",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(oe,{className:"h-4 w-4 text-muted-foreground"}),e.jsx(ee,{className:"text-sm text-muted-foreground",children:"Schedule (optional)"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(de,{type:"time",value:n,onChange:N=>p(N.target.value),className:"flex-1",placeholder:"Set time"}),n&&e.jsx(T,{type:"button",variant:"ghost",size:"sm",onClick:()=>p(""),className:"text-muted-foreground",children:"Clear"})]}),n&&e.jsxs("div",{className:"space-y-2 pl-1",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(ee,{htmlFor:"reminder-toggle",className:"text-sm",children:"Push notification reminder"}),e.jsx(xs,{id:"reminder-toggle",checked:i,onCheckedChange:b})]}),i&&e.jsxs(ps,{value:h.toString(),onValueChange:N=>f(parseInt(N)),children:[e.jsx(hs,{className:"w-full",children:e.jsx(gs,{placeholder:"Remind me..."})}),e.jsxs(fs,{children:[e.jsx(me,{value:"5",children:"5 minutes before"}),e.jsx(me,{value:"10",children:"10 minutes before"}),e.jsx(me,{value:"15",children:"15 minutes before"}),e.jsx(me,{value:"30",children:"30 minutes before"}),e.jsx(me,{value:"60",children:"1 hour before"})]})]})]})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(T,{type:"button",variant:d?"default":"outline",size:"sm",onClick:m,disabled:!t.trim(),className:"flex-1",children:d?e.jsxs(e.Fragment,{children:[e.jsx(xe,{className:"h-4 w-4 mr-2"}),"Update Habit"]}):e.jsxs(e.Fragment,{children:[e.jsx(ce,{className:"h-4 w-4 mr-2"}),"Add Habit"]})}),d&&j&&e.jsx(T,{type:"button",variant:"ghost",size:"sm",onClick:j,children:"Cancel"})]})]}));ft.displayName="EpicHabitForm";const Os=["M","T","W","T","F","S","S"],Xs=t=>{if(!t)return"";const[l,s]=t.split(":"),u=parseInt(l),n=u>=12?"PM":"AM";return`${u%12||12}:${s} ${n}`},Ys=(t,l)=>t==="daily"||!l||l.length===0||l.length===7?{type:"text",value:"Daily"}:l.length===5&&[0,1,2,3,4].every(s=>l.includes(s))?{type:"text",value:"Weekdays"}:{type:"chips",value:l},yt=a.memo(({habits:t,onRemove:l,onEdit:s})=>t.length===0?null:e.jsx("div",{className:"space-y-2",children:t.map((u,n)=>{const i=Ys(u.frequency,u.custom_days);return e.jsxs("div",{className:"flex items-center justify-between p-3 bg-accent/20 rounded-lg",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("div",{className:"font-medium truncate",children:u.title}),e.jsxs("div",{className:"flex items-center gap-2 text-xs text-muted-foreground mt-1",children:[i.type==="text"?e.jsx("span",{children:i.value}):e.jsx("div",{className:"flex gap-0.5",children:Os.map((h,o)=>e.jsx("span",{className:k("w-4 h-4 rounded-full text-[9px] font-bold flex items-center justify-center",i.value.includes(o)?"bg-primary/80 text-primary-foreground":"bg-muted/50 text-muted-foreground/50"),children:h},o))}),u.preferred_time&&e.jsxs(e.Fragment,{children:[e.jsx("span",{children:"•"}),e.jsxs("span",{className:"flex items-center gap-1",children:[e.jsx(oe,{className:"h-3 w-3"}),Xs(u.preferred_time)]})]}),u.reminder_enabled&&e.jsx(At,{className:"h-3 w-3 text-primary"})]})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[s&&e.jsx(T,{type:"button",variant:"ghost",size:"sm",onClick:()=>s(n),children:e.jsx(He,{className:"h-4 w-4"})}),e.jsx(T,{type:"button",variant:"ghost",size:"sm",onClick:()=>l(n),children:e.jsx(Rt,{className:"h-4 w-4"})})]})]},n)})}));yt.displayName="EpicHabitList";const Ge=[{slug:"treasure_hunt",name:"Treasure Hunt",description:"Follow clues to a legendary artifact hidden among the stars",icon:Pt,baseChapters:5,bossHint:"The Guardian of Lost Treasures",color:"from-amber-500 to-yellow-600"},{slug:"mystery",name:"Cosmiq Mystery",description:"Unravel secrets that threaten the fabric of reality",icon:Dt,baseChapters:6,bossHint:"The Keeper of Forgotten Truths",color:"from-purple-500 to-indigo-600"},{slug:"pilgrimage",name:"Sacred Pilgrimage",description:"Journey to sacred sites seeking enlightenment and peace",icon:Ht,baseChapters:4,bossHint:"The Trial of Inner Shadows",color:"from-cyan-500 to-teal-600"},{slug:"heroes_journey",name:"Hero's Journey",description:"Answer the call to adventure and become a legend",icon:It,baseChapters:6,bossHint:"The Dark Mirror of Destiny",color:"from-red-500 to-orange-600"},{slug:"rescue_mission",name:"Rescue Mission",description:"Race against time to save someone precious from darkness",icon:Ft,baseChapters:5,bossHint:"The Void That Consumes",color:"from-pink-500 to-rose-600"},{slug:"exploration",name:"Uncharted Realms",description:"Discover new worlds and map the unknown cosmos",icon:Mt,baseChapters:5,bossHint:"The Primordial Chaos",color:"from-emerald-500 to-green-600"}],Ws=({selectedType:t,onSelect:l})=>{const[s,u]=a.useState(null),n=i=>{s===i||u(i),l(i)};return e.jsxs("div",{className:"space-y-3",children:[e.jsx("div",{className:"text-sm font-medium text-muted-foreground mb-2",children:"Choose Your Adventure Type"}),e.jsx("div",{className:"grid grid-cols-2 gap-3",children:Ge.map((i,h)=>{const o=i.icon,g=t===i.slug,c=s===i.slug;return e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:h*.05},layout:!0,children:e.jsx(ge,{className:k("p-3 cursor-pointer transition-all border-2","hover:scale-[1.02] hover:shadow-lg",g?"border-primary bg-primary/10 shadow-glow":"border-transparent hover:border-primary/30"),onClick:()=>n(i.slug),children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:k("w-10 h-10 rounded-lg flex items-center justify-center flex-shrink-0","bg-gradient-to-br",i.color),children:e.jsx(o,{className:"w-5 h-5 text-white"})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("h4",{className:"font-semibold text-sm truncate",children:i.name}),g&&e.jsx(G,{variant:"default",className:"text-[10px] px-1.5 py-0",children:"Selected"})]}),e.jsx(ve,{mode:"wait",children:c?e.jsx(_.p,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},exit:{opacity:0,height:0},transition:{duration:.2},className:"text-[11px] text-muted-foreground mt-0.5",children:i.description},"full"):e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},className:"flex items-center gap-1 mt-0.5",children:[e.jsx("p",{className:"text-[11px] text-muted-foreground line-clamp-1 flex-1",children:i.description}),e.jsx(je,{className:"w-3 h-3 text-muted-foreground flex-shrink-0"})]},"truncated")})]})]})})},i.slug)})}),t&&e.jsx(_.div,{initial:{opacity:0,height:0},animate:{opacity:1,height:"auto"},className:"mt-3 p-3 bg-primary/5 border border-primary/20 rounded-lg",children:e.jsxs("p",{className:"text-xs text-muted-foreground",children:[e.jsx("span",{className:"text-primary font-medium",children:"Final Boss Hint:"})," ",Ge.find(i=>i.slug===t)?.bossHint]})})]})},Ve={heroic:{icon:ae,label:"Heroic",colors:"from-epic-heroic to-purple-500",gradient:"bg-gradient-to-r from-epic-heroic/20 to-purple-500/20 border-epic-heroic/40"},warrior:{icon:zt,label:"Warrior",colors:"from-epic-warrior to-orange-500",gradient:"bg-gradient-to-r from-epic-warrior/20 to-orange-500/20 border-epic-warrior/40"},mystic:{icon:U,label:"Mystic",colors:"from-epic-mystic to-blue-500",gradient:"bg-gradient-to-r from-epic-mystic/20 to-blue-500/20 border-epic-mystic/40"},nature:{icon:Bt,label:"Nature",colors:"from-epic-nature to-emerald-500",gradient:"bg-gradient-to-r from-epic-nature/20 to-emerald-500/20 border-epic-nature/40"},solar:{icon:Lt,label:"Solar",colors:"from-epic-solar to-amber-500",gradient:"bg-gradient-to-r from-epic-solar/20 to-amber-500/20 border-epic-solar/40"}},$s=({open:t,onOpenChange:l,onCreateEpic:s,isCreating:u,template:n})=>{const[i,h]=a.useState("story"),[o,g]=a.useState(null),[c,y]=a.useState(""),[p,b]=a.useState(""),[f,m]=a.useState(30),[d,j]=a.useState("heroic"),[N,I]=a.useState([]),[P,w]=a.useState(""),[C,v]=a.useState(""),[W,M]=a.useState("medium"),[F,L]=a.useState([0,1,2,3,4,5,6]),[z,K]=a.useState(""),[A,V]=a.useState(!1),[x,Z]=a.useState(15),[re,ie]=a.useState(null);a.useEffect(()=>{if(n&&t){y(n.name),b(n.description),m(n.target_days),j(n.theme_color||"heroic");const S=n.habits.map(R=>({title:R.title,description:R.description||void 0,difficulty:R.difficulty,frequency:R.frequency||"daily",custom_days:R.frequency==="daily"?[]:[0,1,2,3,4,5,6]}));I(S)}},[n,t]);const Ce=a.useCallback(()=>{if(!P.trim())return;const S=ys(P),R={title:P.trim(),description:C.trim()||void 0,difficulty:W,frequency:F.length===7?"daily":"custom",custom_days:F.length===7?[]:F,preferred_time:z||void 0,reminder_enabled:A,reminder_minutes_before:x,category:S||"soul"};re!==null?(I(X=>X.map((se,r)=>r===re?R:se)),ie(null)):I(X=>[...X,R]),w(""),v(""),M("medium"),L([0,1,2,3,4,5,6]),K(""),V(!1),Z(15)},[P,C,W,F,z,A,x,re]),_e=a.useCallback(S=>{const R=N[S];w(R.title),v(R.description||""),M(R.difficulty),L(R.frequency==="daily"?[0,1,2,3,4,5,6]:R.custom_days),K(R.preferred_time||""),V(R.reminder_enabled||!1),Z(R.reminder_minutes_before||15),ie(S)},[N]),Se=a.useCallback(()=>{ie(null),w(""),v(""),M("medium"),L([0,1,2,3,4,5,6]),K(""),V(!1),Z(15)},[]),ke=a.useCallback(S=>{I(R=>R.filter((X,se)=>se!==S))},[]),te=a.useCallback(()=>{!c.trim()||N.length===0||(s({title:c.trim(),description:p.trim()||void 0,target_days:f,habits:N,is_public:!0,theme_color:d,story_type_slug:o||void 0}),fe())},[c,p,f,N,d,o,s]),fe=()=>{h("story"),g(null),y(""),b(""),m(30),j("heroic"),I([]),w(""),v(""),M("medium"),L([0,1,2,3,4,5,6]),K(""),V(!1),Z(15),ie(null)},ne=S=>{S||fe(),l(S)},ye=a.useCallback(()=>f*js.XP_PER_DAY,[f]);return e.jsx(Ne,{open:t,onOpenChange:ne,children:e.jsxs(we,{className:"sm:max-w-md max-h-[90vh] overflow-y-auto",style:{WebkitOverflowScrolling:"touch",overscrollBehavior:"contain"},children:[e.jsxs(Le,{children:[e.jsxs(Be,{className:"flex items-center gap-2",children:[n?.badge_icon&&e.jsx("span",{className:"text-xl",children:n.badge_icon}),e.jsx(ae,{className:"w-5 h-5 text-primary"}),n?`Start: ${n.name}`:i==="story"?"Choose Your Adventure":"Create Legendary Epic"]}),e.jsx(pt,{children:n?e.jsxs("span",{className:"flex items-center gap-2",children:["Starting from template",e.jsx(G,{variant:"secondary",className:"text-xs",children:n.difficulty_tier})]}):i==="story"?"Select the type of story you want to experience":"Create an epic and add habits to track your progress."})]}),i==="story"&&!n&&e.jsxs("div",{className:"space-y-4",children:[e.jsx(Ws,{selectedType:o,onSelect:g}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{children:"Epic Duration"}),e.jsx("div",{className:"flex gap-2",children:[14,30,45,60].map(S=>e.jsxs(T,{type:"button",variant:f===S?"default":"outline",size:"sm",onClick:()=>m(S),className:"flex-1",children:[S,"d"]},S))})]}),e.jsxs(T,{onClick:()=>h("details"),disabled:!o,className:"w-full",children:["Continue",e.jsx(he,{className:"w-4 h-4 ml-1"})]}),e.jsx(T,{variant:"ghost",onClick:()=>{g(null),h("details")},className:"w-full text-muted-foreground",children:"Skip story selection"})]}),(i==="details"||n)&&e.jsxs("div",{className:"space-y-4",children:[!n&&e.jsxs(T,{variant:"ghost",size:"sm",onClick:()=>h("story"),className:"mb-2",children:[e.jsx(qt,{className:"w-4 h-4 mr-1"}),"Change story type"]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"epic-title",children:"Epic Name *"}),e.jsx(de,{id:"epic-title",placeholder:"e.g., Become a Morning Warrior",value:c,onChange:S=>y(S.target.value),maxLength:60,style:{touchAction:"manipulation",WebkitTapHighlightColor:"transparent"}})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"epic-description",children:"Epic Quest Description"}),e.jsx(qe,{id:"epic-description",placeholder:"What legendary feat will you accomplish?",value:p,onChange:S=>b(S.target.value),rows:3,maxLength:200,style:{touchAction:"pan-y",WebkitTapHighlightColor:"transparent"}})]}),n&&e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"target-days",children:"Epic Duration (Days)"}),e.jsx("div",{className:"flex gap-2",children:[7,14,21,30,60].map(S=>e.jsxs(T,{type:"button",variant:f===S?"default":"outline",size:"sm",onClick:()=>m(S),className:"flex-1",children:[S,"d"]},S))}),e.jsx(de,{id:"target-days",type:"number",min:1,max:365,value:f,onChange:S=>{const R=parseInt(S.target.value);!isNaN(R)&&R>=1&&R<=365?m(R):S.target.value===""&&m(1)},className:"mt-2"})]}),e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{children:"Epic Theme"}),e.jsx("div",{className:"grid grid-cols-5 gap-2",children:Object.keys(Ve).map(S=>{const R=Ve[S],X=R.icon;return e.jsxs(T,{type:"button",variant:"outline",size:"sm",onClick:()=>j(S),className:k("flex flex-col items-center gap-1 h-auto py-3 transition-all",d===S?`${R.gradient} border-2 shadow-lg`:"hover:bg-muted"),children:[e.jsx(X,{className:k("h-5 w-5",d===S&&`bg-gradient-to-r ${R.colors} bg-clip-text text-transparent`)}),e.jsx("span",{className:"text-xs",children:R.label})]},S)})})]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs(ee,{children:["Epic Habits ",n?"(from template)":"(Required)"]}),e.jsx(yt,{habits:N,onRemove:ke,onEdit:_e}),e.jsx(ft,{habitTitle:P,habitDescription:C,difficulty:W,selectedDays:F,preferredTime:z,reminderEnabled:A,reminderMinutesBefore:x,onTitleChange:w,onDescriptionChange:v,onDifficultyChange:M,onDaysChange:L,onPreferredTimeChange:K,onReminderEnabledChange:V,onReminderMinutesChange:Z,onAddHabit:Ce,isEditing:re!==null,onCancelEdit:Se}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Add as many habits as you need for this epic."})]}),e.jsxs("div",{className:"bg-primary/10 border border-primary/20 rounded-lg p-3 flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Me,{className:"w-5 h-5 text-yellow-500"}),e.jsx("span",{className:"text-sm font-medium",children:"Epic Completion Reward"})]}),e.jsxs("span",{className:"text-lg font-bold text-primary",children:["+",ye()," XP"]})]}),e.jsx(T,{onClick:te,disabled:!c.trim()||N.length===0||u,className:"w-full bg-gradient-to-r from-primary to-purple-600 hover:from-primary/90 hover:to-purple-600/90",children:u?"Creating Epic...":n?`Start ${n.name}! 🎯`:"Begin Epic Quest! 🎯"})]})]})})},Qs=a.memo(function({open:l,onOpenChange:s}){const[u,n]=a.useState(""),[i,h]=a.useState(!1),[o,g]=a.useState(!1),c=tt(),y=2;a.useEffect(()=>{l&&(g(!1),n(""))},[l]);const p=async()=>{if(!u.trim()){B.error("Please enter an invite code");return}h(!0);try{const f=`EPIC-${u.trim().toUpperCase().replace("EPIC-","")}`,{data:m,error:d}=await Q.from("epics").select("*, epic_story_types(slug), epic_habits(habit_id, habits(id, title, difficulty, frequency, custom_days))").eq("invite_code",f).eq("is_public",!0).maybeSingle();if(d)throw d;if(!m){B.error("Epic not found. Check the code and try again."),h(!1);return}const{data:j}=await Q.auth.getUser();if(!j.user){B.error("Please sign in to join guilds"),h(!1);return}const{data:N}=await Q.from("epics").select("id").eq("user_id",j.user.id).eq("status","active"),{data:I}=await Q.from("epic_members").select("epic_id, epics!inner(user_id, status)").eq("user_id",j.user.id).neq("epics.user_id",j.user.id).eq("epics.status","active");if((N?.length||0)+(I?.length||0)>=y){g(!0),B.error(`You can only have ${y} active epics at a time`),h(!1);return}const{data:w}=await Q.from("epic_members").select("id").eq("epic_id",m.id).eq("user_id",j.user.id).maybeSingle();if(w){B.error("You're already in this guild!"),h(!1);return}const{error:C}=await Q.from("epic_members").insert({epic_id:m.id,user_id:j.user.id});if(C)throw C;if(m.epic_habits&&m.epic_habits.length>0){const v=m.epic_habits.map(z=>({user_id:j.user.id,title:z.habits.title,difficulty:z.habits.difficulty,frequency:z.habits.frequency||"daily",custom_days:z.habits.custom_days||null})),{data:W,error:M}=await Q.from("habits").insert(v).select();if(M)throw M;const F=W?.map(z=>({epic_id:m.id,habit_id:z.id}))||[],{error:L}=await Q.from("epic_habits").insert(F);if(L)throw L}B.success(`Joined "${m.title}" guild! 🎯`),s(!1),n(""),c.invalidateQueries({queryKey:["epics"]}),c.invalidateQueries({queryKey:["habits"]})}catch(b){console.error("Error joining epic:",b),B.error("Failed to join guild. Please try again.")}finally{h(!1)}};return e.jsx(Ne,{open:l,onOpenChange:s,children:e.jsxs(we,{className:"sm:max-w-md",children:[e.jsxs(Le,{children:[e.jsx(Be,{children:"Join an Epic"}),e.jsx(pt,{children:"Enter an invite code to join a shared epic with others"})]}),e.jsxs("div",{className:"space-y-4 py-4",children:[e.jsxs("div",{className:"space-y-2",children:[e.jsx(ee,{htmlFor:"invite-code",children:"Invite Code"}),e.jsx(de,{id:"invite-code",placeholder:"EPIC-WELLNESS-5K2X",value:u,onChange:b=>n(b.target.value),onKeyDown:b=>{b.key==="Enter"&&!i&&p()}}),e.jsx("p",{className:"text-sm text-muted-foreground",children:"You can paste the full link or just the code"})]}),o?e.jsxs("p",{className:"text-sm text-amber-500 text-center py-2",children:["You can only have ",y," active epics at a time. Complete or abandon an epic to join a new one."]}):e.jsx(T,{onClick:p,disabled:i||!u.trim(),className:"w-full",children:i?"Loading...":"Join Epic"})]})]})})}),Us=()=>e.jsxs(bs,{children:[e.jsx(vs,{asChild:!0,children:e.jsx("button",{type:"button",className:"inline-flex items-center justify-center ml-2 opacity-60 hover:opacity-100 transition-opacity touch-manipulation active:scale-95","aria-label":"Learn about Star Paths",children:e.jsx(Ot,{className:"h-5 w-5 text-primary"})})}),e.jsx(Ns,{className:"w-80 cosmiq-glass border-primary/30 shadow-xl",side:"bottom",sideOffset:8,children:e.jsxs("div",{className:"space-y-3",children:[e.jsx("h4",{className:"font-heading font-bold text-base text-primary",children:"⭐ Star Paths"}),e.jsx("p",{className:"text-sm leading-relaxed text-foreground/90",children:"Pre-built epic journeys with curated habits to help you start your wellness adventure instantly!"}),e.jsxs("div",{className:"space-y-2 pt-2 border-t border-primary/20",children:[e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-xs font-semibold text-green-400 mt-0.5",children:"🌱"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold text-green-400",children:"Beginner"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Perfect for starting out"})]})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-xs font-semibold text-yellow-400 mt-0.5",children:"⚡"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold text-yellow-400",children:"Intermediate"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"Ready to level up"})]})]}),e.jsxs("div",{className:"flex items-start gap-2",children:[e.jsx("span",{className:"text-xs font-semibold text-red-400 mt-0.5",children:"🔥"}),e.jsxs("div",{children:[e.jsx("p",{className:"text-xs font-semibold text-red-400",children:"Advanced"}),e.jsx("p",{className:"text-xs text-muted-foreground",children:"For seasoned warriors"})]})]})]})]})})]}),Ks={beginner:{label:"Beginner",color:"bg-green-500/20 text-green-400 border-green-500/30"},intermediate:{label:"Intermediate",color:"bg-yellow-500/20 text-yellow-400 border-yellow-500/30"},advanced:{label:"Advanced",color:"bg-red-500/20 text-red-400 border-red-500/30"}},Ze={heroic:"from-purple-500/20 to-purple-600/10 border-purple-500/30",warrior:"from-orange-500/20 to-red-600/10 border-orange-500/30",mystic:"from-blue-500/20 to-indigo-600/10 border-blue-500/30",nature:"from-green-500/20 to-emerald-600/10 border-green-500/30",solar:"from-yellow-500/20 to-amber-600/10 border-yellow-500/30"},Js=({onSelectTemplate:t})=>{const{templates:l,featuredTemplates:s,isLoading:u,incrementPopularity:n}=ws(),[i,h]=a.useState("all"),o=i==="all"?l:l.filter(c=>c.difficulty_tier===i),g=c=>{n.mutate(c.id),t(c)};return u?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary"})}):e.jsxs("div",{className:"space-y-6",children:[s.length>0&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(be,{className:"h-5 w-5 text-yellow-500"}),e.jsx("h3",{className:"font-semibold",children:"Featured Star Paths"}),e.jsx(Us,{})]}),e.jsx("div",{className:"grid gap-3",children:s.slice(0,3).map(c=>e.jsx(et,{template:c,onSelect:g,featured:!0},c.id))})]}),e.jsx(ht,{value:i,onValueChange:c=>h(c),children:e.jsxs(gt,{className:"grid w-full grid-cols-4",children:[e.jsx(le,{value:"all",children:"All"}),e.jsx(le,{value:"beginner",children:"Beginner"}),e.jsx(le,{value:"intermediate",children:"Medium"}),e.jsx(le,{value:"advanced",children:"Advanced"})]})}),e.jsx("div",{className:"grid gap-3",children:o.map((c,y)=>e.jsx(_.div,{initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:y*.05},children:e.jsx(et,{template:c,onSelect:g})},c.id))}),o.length===0&&e.jsxs("div",{className:"text-center py-8 text-muted-foreground",children:[e.jsx(ae,{className:"h-12 w-12 mx-auto mb-3 opacity-50"}),e.jsx("p",{children:"No star paths found for this difficulty"})]})]})},et=({template:t,onSelect:l,featured:s})=>{const u=Ks[t.difficulty_tier],n=Ze[t.theme_color]||Ze.heroic,i=t.habits,h=a.useRef(null),o=10,g=a.useCallback(()=>{l(t)},[l,t]),c=a.useCallback(p=>{h.current={x:p.touches[0].clientX,y:p.touches[0].clientY}},[]),y=a.useCallback(p=>{if(!h.current)return;const b=p.changedTouches[0].clientX,f=p.changedTouches[0].clientY,m=Math.abs(b-h.current.x),d=Math.abs(f-h.current.y);m<o&&d<o&&(p.preventDefault(),g()),h.current=null},[g]);return e.jsx(ge,{className:k("cursor-pointer transition-all sm:hover:scale-[1.02] hover:shadow-lg border select-none active:scale-[0.98]",`bg-gradient-to-r ${n}`,s&&"ring-2 ring-primary/50"),onClick:g,onTouchStart:c,onTouchEnd:y,role:"button",tabIndex:0,style:{WebkitTapHighlightColor:"transparent",touchAction:"manipulation"},children:e.jsx(Cs,{className:"p-4",children:e.jsxs("div",{className:"flex items-start justify-between gap-3",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2 mb-1",children:[e.jsx("span",{className:"text-2xl",children:t.badge_icon}),e.jsx("h4",{className:"font-semibold truncate",children:t.name}),s&&e.jsxs(G,{variant:"secondary",className:"text-xs bg-primary/20 text-primary",children:[e.jsx(U,{className:"h-3 w-3 mr-1"}),"Featured"]})]}),e.jsx("p",{className:"text-sm text-muted-foreground line-clamp-2 mb-3",children:t.description}),e.jsxs("div",{className:"flex flex-wrap items-center gap-2",children:[e.jsx(G,{variant:"outline",className:u.color,children:u.label}),e.jsxs(G,{variant:"outline",className:"text-xs",children:[e.jsx(oe,{className:"h-3 w-3 mr-1"}),t.target_days," days"]}),t.popularity_count>0&&e.jsxs(G,{variant:"outline",className:"text-xs text-muted-foreground",children:[e.jsx(nt,{className:"h-3 w-3 mr-1"}),t.popularity_count]})]}),i.length>0&&e.jsxs("div",{className:"mt-3 pt-3 border-t border-border/30",children:[e.jsxs("p",{className:"text-xs text-muted-foreground mb-2",children:["Habits included (",i.length,"):"]}),e.jsx("div",{className:"space-y-1.5",children:i.map((p,b)=>e.jsxs("div",{className:"flex items-center gap-2 text-xs",children:[e.jsx("span",{className:k("w-1.5 h-1.5 rounded-full flex-shrink-0",p.difficulty==="easy"&&"bg-green-500",p.difficulty==="medium"&&"bg-yellow-500",p.difficulty==="hard"&&"bg-red-500",!p.difficulty&&"bg-muted-foreground")}),e.jsx("span",{className:"truncate",children:p.title}),e.jsxs("span",{className:"text-muted-foreground/70 flex-shrink-0",children:["(",p.frequency,")"]})]},b))})]})]}),e.jsx(he,{className:"h-5 w-5 text-muted-foreground flex-shrink-0"})]})})})},Gs=()=>e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},exit:{opacity:0},transition:{duration:.2},className:"min-h-screen pb-nav-safe pt-safe px-4",children:[e.jsxs("div",{className:"mb-8 text-center space-y-3",children:[e.jsx($,{className:"h-8 w-40 mx-auto rounded-full"}),e.jsx($,{className:"h-10 w-48 mx-auto"}),e.jsx($,{className:"h-5 w-64 mx-auto"})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-3 mb-4",children:[e.jsx($,{className:"h-12 rounded-lg"}),e.jsx($,{className:"h-12 rounded-lg"})]}),e.jsxs("div",{className:"mb-6 space-y-3",children:[e.jsx($,{className:"h-14 w-full rounded-lg"}),e.jsx($,{className:"h-12 w-full rounded-lg"})]}),e.jsx($,{className:"h-10 w-full rounded-lg mb-6"}),e.jsx("div",{className:"space-y-4",children:[1,2].map(t=>e.jsxs("div",{className:"rounded-2xl border border-border/50 p-4 space-y-4",children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"space-y-2 flex-1",children:[e.jsx($,{className:"h-6 w-3/4"}),e.jsx($,{className:"h-4 w-1/2"})]}),e.jsx($,{className:"h-10 w-10 rounded-full"})]}),e.jsx($,{className:"h-2 w-full rounded-full"}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx($,{className:"h-4 w-24"}),e.jsx($,{className:"h-4 w-24"})]})]},t))})]}),sa=()=>{const[t,l]=a.useState(!1),[s,u]=a.useState(!1),[n,i]=a.useState(!1),[h,o]=a.useState(!1),[g,c]=a.useState(!1),[y,p]=a.useState(null),{activeEpics:b,completedEpics:f,isLoading:m,createEpic:d,isCreating:j,updateEpicStatus:N}=_s(),I=2,P=b.length>=I,w=v=>{d(v),l(!1),p(null)},C=v=>{p(v),o(!1),l(!0)};return m?e.jsxs(We,{children:[e.jsx($e,{}),e.jsx(Gs,{})]}):e.jsxs(We,{children:[e.jsx($e,{}),e.jsxs("div",{className:"min-h-screen pb-nav-safe pt-safe px-4 relative z-10",children:[e.jsxs(_.div,{initial:{opacity:0,y:-20},animate:{opacity:1,y:0},className:"mb-8 text-center relative",children:[e.jsx(Ss,{onClick:()=>c(!0),className:"absolute right-0 top-0"}),e.jsxs("div",{className:"inline-flex items-center gap-2 mb-3 bg-gradient-to-r from-primary/20 to-purple-500/20 px-4 py-2 rounded-full",children:[e.jsx(U,{className:"w-5 h-5 text-primary"}),e.jsx("span",{className:"text-sm font-medium",children:"Legendary Quests"})]}),e.jsx("h1",{className:"text-4xl font-bold mb-2 bg-gradient-to-r from-primary to-purple-500 bg-clip-text text-transparent",children:"Your Epics"}),e.jsx("p",{className:"text-muted-foreground max-w-md mx-auto",children:"Embark on legendary journeys. Link your daily habits to conquer epic goals!"})]}),e.jsxs(_.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{delay:.1},className:"grid grid-cols-2 gap-3 mb-4",children:[e.jsxs(T,{onClick:()=>i(!0),variant:"outline",className:"h-12",children:[e.jsx(nt,{className:"w-4 h-4 mr-2"}),"Join Guild"]}),e.jsxs(T,{onClick:()=>o(!0),variant:"outline",className:"h-12",children:[e.jsx(U,{className:"w-4 h-4 mr-2"}),"Star Paths"]})]}),e.jsx(_.div,{initial:{opacity:0,scale:.95},animate:{opacity:1,scale:1},transition:{delay:.15},className:"mb-6 space-y-3",children:P?e.jsxs("div",{className:"w-full h-14 flex items-center justify-center bg-secondary/30 rounded-lg border border-border/50 text-muted-foreground text-sm",children:["You can only have ",I," active epics at a time"]}):e.jsxs(e.Fragment,{children:[e.jsxs(T,{onClick:()=>u(!0),className:"w-full bg-gradient-to-r from-primary to-purple-600 hover:from-primary/90 hover:to-purple-600/90 h-14 text-lg",size:"lg",children:[e.jsx(it,{className:"w-5 h-5 mr-2"}),"Create Smart Epic"]}),e.jsxs(T,{onClick:()=>{p(null),l(!0)},variant:"outline",className:"w-full h-12",children:[e.jsx(ce,{className:"w-4 h-4 mr-2"}),"Create Custom Epic"]})]})}),e.jsxs(ht,{defaultValue:"active",className:"w-full",children:[e.jsxs(gt,{className:"grid w-full grid-cols-2 mb-6",children:[e.jsxs(le,{value:"active",className:"flex items-center gap-2",children:[e.jsx(ae,{className:"w-4 h-4"}),"Active (",b.length,")"]}),e.jsxs(le,{value:"completed",className:"flex items-center gap-2",children:[e.jsx(pe,{className:"w-4 h-4"}),"Legendary (",f.length,")"]})]}),e.jsx(Qe,{value:"active",className:"space-y-4",children:b.length===0?e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center py-12 bg-secondary/20 rounded-lg border-2 border-dashed border-primary/20",children:[e.jsx(U,{className:"w-16 h-16 text-primary mx-auto mb-4 animate-pulse"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Active Epics"}),e.jsx("p",{className:"text-muted-foreground mb-6 max-w-sm mx-auto",children:"Begin your first legendary quest! Discover guided paths designed to help you build powerful habits and achieve your goals."}),e.jsxs(T,{onClick:()=>o(!0),className:"bg-gradient-to-r from-amber-500 via-purple-500 to-pink-500 hover:from-amber-600 hover:via-purple-600 hover:to-pink-600 text-white shadow-lg hover:shadow-xl transition-all duration-300 h-12 px-8 text-base font-semibold",size:"lg",children:[e.jsx(U,{className:"w-5 h-5 mr-2"}),"Explore Star Paths",e.jsx(he,{className:"w-5 h-5 ml-2"})]})]}):b.map(v=>e.jsx(Je,{epic:v,onComplete:()=>N({epicId:v.id,status:"completed"}),onAbandon:()=>N({epicId:v.id,status:"abandoned"})},v.id))}),e.jsx(Qe,{value:"completed",className:"space-y-4",children:f.length===0?e.jsxs(_.div,{initial:{opacity:0},animate:{opacity:1},className:"text-center py-12 bg-secondary/20 rounded-lg border-2 border-dashed border-primary/20",children:[e.jsx(pe,{className:"w-16 h-16 text-muted-foreground mx-auto mb-4 opacity-50"}),e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"No Legendary Epics Yet"}),e.jsx("p",{className:"text-muted-foreground max-w-sm mx-auto",children:"Complete your first epic to earn this legendary status and massive XP rewards!"})]}):f.map(v=>e.jsx(Je,{epic:v},v.id))})]}),e.jsx(ks,{open:s,onOpenChange:u,onCreateEpic:v=>{d(v),u(!1)},isCreating:j}),e.jsx($s,{open:t,onOpenChange:l,onCreateEpic:w,isCreating:j,template:y}),e.jsx(Qs,{open:n,onOpenChange:i}),e.jsx(Ne,{open:h,onOpenChange:o,children:e.jsxs(we,{className:"sm:max-w-lg max-h-[85vh] overflow-y-auto",children:[e.jsx(Le,{children:e.jsxs(Be,{className:"flex items-center gap-2",children:[e.jsx(U,{className:"w-5 h-5 text-primary"}),"Star Paths"]})}),e.jsx(Js,{onSelectTemplate:C})]})}),e.jsx(Ts,{open:g,onClose:()=>c(!1),title:"About Epics",icon:ae,description:"Epics are long-term goals that link your daily habits together for massive growth.",features:["Create epics with target completion days","Link habits to track progress automatically","Join guilds to work toward goals with others","Compete with rivals and send shouts to motivate","Earn bonus XP for completing epic-linked habits"],tip:"Try a template like 'Detox Warrior' for a dopamine detox challenge with pre-built habits!"})]})]})};export{sa as default};
